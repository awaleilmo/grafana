"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[4979],{80537:(nt,b,o)=>{o.r(b),o.d(b,{plugin:()=>J});var a=o(74848),D=o(16207),r=o(92745),N=o(10928),g=o(22803),I=o(96540),P=o(64423),w=o(92138),F=o(32899),B=o(57852),V=o(25229),k=o(43173),j=o(36490),S=o(68143),O=o(92807),E=o(45861),U=o(37658),$=o(65240),H=o(46559),K=o(45229),p=o(22429),y=o(63142),f=o(8073),M=o(70663),Z=o(45967);const z=({options:l,annotation:e,formatDate:t,onClick:n,onAvatarClick:s,onTagClick:d})=>{const i=(0,y.of)(v),{showUser:c,showTags:u,showTime:m}=l,{text:X="",login:L,email:Y,avatarUrl:q,tags:R,time:T,timeEnd:x}=e,_=()=>{n(e)},tt=()=>{s(e)},at=L&&c,et=T&&m,st=x&&x!==T&&m;return(0,a.jsxs)(f.Z,{className:i.card,onClick:_,children:[(0,a.jsx)(f.Z.Heading,{children:(0,a.jsx)(M.I,{className:i.heading,onClick:C=>{C.stopPropagation()},content:X})}),et&&(0,a.jsxs)(f.Z.Description,{className:i.timestamp,children:[(0,a.jsx)(A,{formatDate:t,time:T}),st&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("span",{className:i.time,children:"-"}),(0,a.jsx)(A,{formatDate:t,time:x})," "]})]}),at&&(0,a.jsx)(f.Z.Meta,{className:i.meta,children:(0,a.jsx)(Q,{email:Y,login:L,avatarUrl:q,onClick:tt})}),u&&R&&(0,a.jsx)(f.Z.Tags,{children:(0,a.jsx)(U.L,{tags:R,onClick:C=>d(C,!1)})})]})},Q=({onClick:l,avatarUrl:e,login:t,email:n})=>{const s=(0,y.of)(v),d=c=>{c.stopPropagation(),l()},i=(0,a.jsx)("span",{children:(0,a.jsxs)(r.x6,{i18nKey:"annolist.annotation-list-item.tooltip-created-by",children:["Created by:",(0,a.jsx)("br",{})," ",{email:n}]})});return(0,a.jsx)(Z.m,{content:i,theme:"info",placement:"top",children:(0,a.jsx)("button",{onClick:d,className:s.avatar,children:(0,a.jsx)("img",{src:e,alt:"avatar icon"})})})},A=({time:l,formatDate:e})=>{const t=(0,y.of)(v);return(0,a.jsx)("span",{className:t.time,children:(0,a.jsx)("span",{children:e(l)})})};function v(l){return{card:(0,g.css)({gridTemplateAreas:'"Heading Description Meta Tags"',gridTemplateColumns:"auto 1fr auto auto",padding:l.spacing(1),margin:l.spacing(.5),width:"inherit"}),heading:(0,g.css)({a:{zIndex:1,position:"relative",color:l.colors.text.link,"&:hover":{textDecoration:"underline"}}}),meta:(0,g.css)({margin:0,position:"relative",justifyContent:"end"}),timestamp:(0,g.css)({margin:0,alignSelf:"center"}),time:(0,g.css)({marginLeft:l.spacing(1),marginRight:l.spacing(1),fontSize:l.typography.bodySmall.fontSize,color:l.colors.text.secondary}),avatar:(0,g.css)({border:"none",background:"inherit",margin:0,padding:l.spacing(.5),img:{borderRadius:l.shape.radius.circle,width:l.spacing(2),height:l.spacing(2)}})}}class W extends I.PureComponent{constructor(e){super(e),this.style=G(k.$.theme2),this.subs=new P.yU,this.tagListRef=(0,I.createRef)(),this.onAnnoClick=async t=>{if(!t.time)return;const{options:n}=this.props,d=(0,p.UA)().getCurrent(),i={from:this._timeOffset(t.time,n.navigateBefore,!0),to:this._timeOffset(t.timeEnd??t.time,n.navigateAfter,!1),viewPanel:n.navigateToPanel&&t.panelId?t.panelId:void 0};if(!t.dashboardUID||d?.uid===t.dashboardUID){j.Ny.partial(i);return}const c=await(0,S.AI)().get("/api/search",{dashboardUIDs:t.dashboardUID});if(c&&c.length&&c[0].uid===t.dashboardUID){const u=c[0],m=new URL(u.url,window.location.origin);m.searchParams.set("from",String(i.from)),m.searchParams.set("to",String(i.to)),j.Ny.push(w.I.stripBaseFromUrl(m.toString()));return}K.A.emit(F.r1.alertWarning,["Unknown Dashboard: "+t.dashboardUID])},this.onTagClick=(t,n)=>{if(!n&&this.state.queryTags.includes(t))return;const s=n?this.state.queryTags.filter(i=>i!==t):[...this.state.queryTags,t];let d;if(n){const i=document.activeElement,c=i?.getAttribute("data-tag-id");if(this.tagListRef.current?.contains(i)&&c){const u=Number.parseInt(c,10),m=this.tagListRef.current.querySelector(`[data-tag-id="${u+1}"]`)??this.tagListRef.current.querySelector(`[data-tag-id="${u-1}"]`);m instanceof HTMLElement&&(d=m)}}this.setState({queryTags:s},()=>d?.focus())},this.onUserClick=t=>{this.setState({queryUser:{id:t.userId,login:t.login,email:t.email}})},this.onClearUser=()=>{this.setState({queryUser:void 0})},this.renderItem=(t,n)=>{const{options:s}=this.props,d=(0,p.UA)().getCurrent();return d?(0,a.jsx)(z,{annotation:t,formatDate:d.formatDate,onClick:this.onAnnoClick,onAvatarClick:this.onUserClick,onTagClick:this.onTagClick,options:s}):(0,a.jsx)(a.Fragment,{})},this.state={annotations:[],timeInfo:"",loaded:!1,queryTags:[]}}componentDidMount(){this.doSearch(),this.subs.add(this.props.eventBus.getStream(B.We).subscribe({next:()=>{this.doSearch()}}))}componentWillUnmount(){this.subs.unsubscribe()}componentDidUpdate(e,t){const{options:n,timeRange:s}=this.props;(n!==e.options||this.state.queryTags!==t.queryTags||this.state.queryUser!==t.queryUser||e.renderCounter!==this.props.renderCounter||n.onlyInTimeRange&&s!==e.timeRange)&&this.doSearch()}async doSearch(){const{options:e}=this.props,{queryUser:t,queryTags:n}=this.state,s={tags:e.tags,limit:e.limit,type:"annotation"};e.onlyFromThisDashboard&&(s.dashboardUID=(0,p.UA)().getCurrent()?.uid);let d="";if(e.onlyInTimeRange){const{timeRange:c}=this.props;s.from=c.from.valueOf(),s.to=c.to.valueOf()}else d="All Time";t&&(s.userId=t.id),e.tags&&e.tags.length&&(s.tags=e.tags.map(c=>this.props.replaceVariables(c))),n.length&&(s.tags=s.tags?[...s.tags,...n]:n);const i=await(0,S.AI)().get("/api/annotations",s,`anno-list-panel-${this.props.id}`);this.setState({annotations:i,timeInfo:d,loaded:!0})}_timeOffset(e,t,n=!1){let s=5,d="m";const i=/^(\d+)(\w)/.exec(t);i&&i.length===3&&(s=parseInt(i[1],10),d=i[2]);const c=(0,V.KQ)(e);return n&&(s*=-1),c.add(s,d).valueOf()}render(){const{loaded:e,annotations:t,queryUser:n,queryTags:s}=this.state;if(!e)return(0,a.jsx)("div",{children:(0,a.jsx)(r.x6,{i18nKey:"annolist.anno-list-panel.loading",children:"Loading..."})});const d=n||s.length>0;return(0,a.jsxs)(O.P,{minHeight:"100%",children:[d&&(0,a.jsxs)("div",{className:this.style.filter,children:[(0,a.jsx)("b",{children:(0,a.jsx)(r.x6,{i18nKey:"annolist.anno-list-panel.filter",children:"Filter:"})}),n&&(0,a.jsx)(E.$n,{size:"sm",variant:"secondary",fill:"text",onClick:this.onClearUser,"aria-label":(0,r.t)("annolist.anno-list-panel.aria-label-remove-filter","Remove filter: {{filterToRemove}}",{filterToRemove:n.email}),children:n.email}),s.length>0&&(0,a.jsx)(U.L,{icon:"times",tags:s,onClick:i=>this.onTagClick(i,!0),getAriaLabel:i=>`Remove ${i} tag`,className:this.style.tagList,ref:this.tagListRef})]}),t.length<1&&(0,a.jsx)("div",{className:this.style.noneFound,children:(0,a.jsx)(r.x6,{i18nKey:"annolist.anno-list-panel.no-annotations-found",children:"No annotations found"})}),(0,a.jsx)(H.p,{items:t,renderItem:this.renderItem,getItemKey:i=>`${i.id}`})]})}}const G=(0,$.N)(l=>({noneFound:(0,g.css)({display:"flex",alignItems:"center",justifyContent:"center",width:"100%",height:"calc(100% - 30px)"}),filter:(0,g.css)({alignItems:"center",display:"flex",flexWrap:"wrap",gap:l.spacing(.5),padding:l.spacing(.5)}),tagList:(0,g.css)({justifyContent:"flex-start","li > button":{paddingLeft:"3px"}})})),h={limit:10,navigateAfter:"10m",navigateBefore:"10m",navigateToPanel:!0,onlyFromThisDashboard:!1,onlyInTimeRange:!1,showTags:!0,showTime:!0,showUser:!0,tags:[]},J=new D.m(W).setPanelOptions(l=>{const e=[(0,r.t)("annolist.category-annotation-query","Annotation query")],t=[(0,r.t)("annolist.category-display","Display")],n=[(0,r.t)("annolist.category-link-behaviour","Link behavior")];l.addRadio({category:e,path:"onlyFromThisDashboard",name:(0,r.t)("annolist.name-query-filter","Query filter"),defaultValue:h.onlyFromThisDashboard,settings:{options:[{value:!1,label:(0,r.t)("annolist.query-filter-options.label-all-dashboards","All dashboards")},{value:!0,label:(0,r.t)("annolist.query-filter-options.label-this-dashboard","This dashboard")}]}}).addRadio({category:e,path:"onlyInTimeRange",name:(0,r.t)("annolist.name-time-range","Time range"),defaultValue:h.onlyInTimeRange,settings:{options:[{value:!1,label:(0,r.t)("annolist.time-range-options.label-none","None")},{value:!0,label:(0,r.t)("annolist.time-range-options.label-this-dashboard","This dashboard")}]}}).addCustomEditor({category:e,id:"tags",path:"tags",name:(0,r.t)("annolist.name-tags","Tags"),description:(0,r.t)("annolist.description-tags","Match annotation tags"),editor(s){return(0,a.jsx)(N.u,{tags:s.value,onChange:s.onChange})}}).addNumberInput({category:e,path:"limit",name:(0,r.t)("annolist.name-limit","Limit"),defaultValue:h.limit}).addBooleanSwitch({category:t,path:"showUser",name:(0,r.t)("annolist.name-show-user","Show user"),defaultValue:h.showUser}).addBooleanSwitch({category:t,path:"showTime",name:(0,r.t)("annolist.name-show-time","Show time"),defaultValue:h.showTime}).addBooleanSwitch({category:t,path:"showTags",name:(0,r.t)("annolist.name-show-tags","Show tags"),defaultValue:h.showTags}).addRadio({category:n,path:"navigateToPanel",name:(0,r.t)("annolist.name-link-target","Link target"),defaultValue:h.navigateToPanel,settings:{options:[{value:!0,label:(0,r.t)("annolist.link-target-options.label-panel","Panel")},{value:!1,label:(0,r.t)("annolist.link-target-options.label-dashboard","Dashboard")}]}}).addTextInput({category:n,path:"navigateBefore",name:(0,r.t)("annolist.name-time-before","Time before"),defaultValue:h.navigateBefore,description:""}).addTextInput({category:n,path:"navigateAfter",name:(0,r.t)("annolist.name-time-after","Time after"),defaultValue:h.navigateAfter,description:""})}).setPanelChangeHandler((l,e,t)=>e==="ryantxu-annolist-panel"?t:l.options)}}]);

//# sourceMappingURL=annoListPanel.ad0de4c1bfa714133b6e.js.map