"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[252],{15983:(ue,K,s)=>{s.d(K,{A:()=>me});var e=s(74848),f=s(92745),r=s(41654),T=s(68079),E=s(66404),d=s(83793),u=s(96540),y=s(89599),P=s(45861);function Y({urls:b,jobType:C}){const z=b?.newPullRequestURL,x=b?.compareURL,h=b?.sourceURL;return C==="sync"?null:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(P.z9,{href:h,icon:"external-link-alt",variant:"secondary",target:"_blank",children:(0,e.jsx)(f.x6,{i18nKey:"provisioning.repository-link.delete-or-move-job.view-branch",children:"View branch"})}),(0,e.jsx)(P.z9,{href:x,icon:"external-link-alt",variant:"secondary",target:"_blank",children:(0,e.jsx)(f.x6,{i18nKey:"provisioning.repository-link.delete-or-move-job.compare-branch",children:"Compare branch"})}),(0,e.jsx)(P.z9,{href:z,icon:"external-link-alt",variant:"secondary",target:"_blank",children:(0,e.jsx)(f.x6,{i18nKey:"provisioning.repository-link.delete-or-move-job.open-pull-request",children:"Open pull request"})})]})}var V=s(29189),Q=s(89640),B=s(92784);function oe({name:b,jobType:C}){const z=(0,d.Sw)(b?{name:b}:V.hT),x=z.data;if(!x||z.isLoading)return null;const h=(0,B.ar)(x.spec?.github);return C==="sync"?(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(E.E,{children:(0,e.jsx)(f.x6,{i18nKey:"provisioning.repository-link.grafana-repository-synced",children:"Your resources are now in your external storage and provisioned into your instance. From now on, your instance and the external storage will be synchronized."})}),h&&(0,e.jsx)(r.B,{direction:"row",gap:2,children:(0,e.jsx)(Q.Y,{href:h,external:!0,children:(0,e.jsx)(f.x6,{i18nKey:"provisioning.repository-link.sync-job.view-repository",children:"View repository"})})})]}):(0,e.jsx)(e.Fragment,{children:h&&(0,e.jsx)(r.B,{direction:"row",gap:2,children:(0,e.jsx)(P.z9,{href:h,icon:"external-link-alt",variant:"secondary",target:"_blank",children:(0,e.jsx)(f.x6,{i18nKey:"provisioning.repository-link.delete-or-move-job.view-repository",children:"View repository"})})})})}var U=s(22803),ae=s(63142);const he=({progress:b,topBottomSpacing:C})=>{const z=(0,ae.of)(_,C);return b===void 0?null:(0,e.jsx)("div",{className:z.container,children:(0,e.jsx)("div",{className:z.filler,style:{width:`${b}%`}})})},_=(b,C=2)=>({container:(0,U.css)({height:"10px",width:"400px",backgroundColor:b.colors.background.secondary,borderRadius:b.shape.radius.pill,overflow:"hidden",margin:b.spacing(C,0)}),filler:(0,U.css)({height:"100%",background:b.colors.success.text,[b.transitions.handleMotion("no-preference","reduce")]:{transition:"width 0.5s ease-in-out"}})}),fe=he;var ye=s(34888);function re({jobType:b,job:C,isFinishedJob:z=!1,onStatusChange:x}){const h=(0,u.useRef)(!1),{state:j,message:O,progress:A,summary:H,errors:N}=C?.status||{},te=C?.metadata?.labels?.["provisioning.grafana.app/repository"],ne=C?.status?.url?.newPullRequestURL;return(0,u.useEffect)(()=>{if(j)switch(j){case"success":x?.({status:"success"});break;case"warning":h.current||(x?.({status:"warning",warning:{title:(0,f.t)("provisioning.job-status.status.title-warning-running-job","Job completed with warnings"),message:N?.length?N:O}}),h.current=!0);break;case"error":h.current||(x?.({status:"error",error:{title:(0,f.t)("provisioning.job-status.status.title-error-running-job","Error running job"),message:N?.length?N:O}}),h.current=!0);break;case"working":case"pending":x?.({status:"running"});break;default:break}},[j,O,N,x]),C?.status?(0,e.jsx)(r.B,{direction:"column",gap:2,children:(0,e.jsxs)(r.B,{direction:"column",gap:2,children:[["working","pending"].includes(j??"")&&(0,e.jsxs)(r.B,{direction:"column",alignItems:"center",children:[(0,e.jsxs)(r.B,{direction:"row",alignItems:"center",justifyContent:"center",gap:2,children:[(0,e.jsx)(T.y,{size:24}),(0,e.jsx)(E.E,{element:"h5",color:"secondary",children:O??j??(0,f.t)("provisioning.job-status.starting","Starting...")})]}),(0,e.jsx)(fe,{progress:A??0})]}),z&&H&&(0,e.jsxs)(r.B,{direction:"column",gap:2,children:[(0,e.jsx)(E.E,{variant:"h3",children:(0,e.jsx)(f.x6,{i18nKey:"provisioning.job-status.summary",children:"Summary"})}),(0,e.jsx)(ye.c,{summary:H})]}),j==="success"?(0,e.jsx)(r.B,{direction:"row",gap:1,children:ne?(0,e.jsx)(Y,{urls:C.status?.url,jobType:b}):(0,e.jsx)(oe,{name:te,jobType:b})}):(0,e.jsx)(y.a,{label:(0,f.t)("provisioning.job-status.label-view-details","View details"),isOpen:!1,children:(0,e.jsx)("pre",{children:JSON.stringify(C,null,2)})})]})}):null}function ee({jobUid:b,repositoryName:C,jobType:z,onStatusChange:x}){const h=(0,u.useRef)(!1),j=(0,d.$9)({name:C,uid:b}),O=h.current&&j.isError,A=j.data;return(0,u.useEffect)(()=>{const H=!A&&!h.current&&!j.isFetching;let N;if(H&&(h.current=!0,N=setTimeout(()=>{j.refetch()},1e3)),O){x?.({status:"error",error:{title:(0,f.t)("provisioning.job-status.no-job-found","No job found"),message:(0,f.t)("provisioning.job-status.no-job-found-message","The job may have been deleted or could not be retrieved. Cancel the current process and start again.")}});return}if(j.isSuccess&&A?.status){const{state:te,message:ne,errors:se}=A.status;te==="error"?x?.({status:"error",error:{title:(0,f.t)("provisioning.job-status.status.title-error-running-job","Error running job"),message:se?.length?se:ne}}):te==="success"?x?.({status:"success",success:{title:(0,f.t)("provisioning.job-status.status.title-success-running-job","Job completed successfully")}}):te==="warning"&&x?.({status:"warning",warning:{title:(0,f.t)("provisioning.job-status.status.title-warning-running-job","Job completed with warnings"),message:se?.length?se:ne}})}return()=>{N&&clearTimeout(N)}},[j,A,x,O]),!A||j.isLoading||j.isFetching?(0,e.jsxs)(r.B,{direction:"row",alignItems:"center",justifyContent:"center",gap:2,children:[(0,e.jsx)(T.y,{size:24}),(0,e.jsx)(E.E,{element:"h4",color:"secondary",children:(0,e.jsx)(f.x6,{i18nKey:"provisioning.job-status.loading-finished-job",children:"Loading finished job..."})})]}):(0,e.jsx)(re,{job:A,isFinishedJob:!0,onStatusChange:x,jobType:z})}function me({jobType:b,watch:C,onStatusChange:z}){const x=(0,d.L3)({fieldSelector:`metadata.name=${C.metadata?.name}`,watch:!0}),h=x?.data?.items?.[0],j=C.metadata?.labels?.["provisioning.grafana.app/repository"],A=!x.isUninitialized&&!x.isLoading&&!h&&!!j;return x.isLoading?(0,e.jsxs)(r.B,{direction:"row",alignItems:"center",justifyContent:"center",gap:2,children:[(0,e.jsx)(T.y,{size:24}),(0,e.jsx)(E.E,{element:"h4",color:"secondary",children:(0,e.jsx)(f.x6,{i18nKey:"provisioning.job-status.starting",children:"Starting..."})})]}):x.isError?(z?.({status:"error",error:{title:(0,f.t)("provisioning.job-status.title.error-fetching-active-job","Error fetching active job")}}),null):h?(0,e.jsx)(re,{job:h,isFinishedJob:!1,onStatusChange:z,jobType:b}):A?(0,e.jsx)(ee,{jobUid:C.metadata?.uid,repositoryName:j,onStatusChange:z,jobType:b}):(0,e.jsxs)(r.B,{direction:"row",alignItems:"center",justifyContent:"center",gap:2,children:[(0,e.jsx)(T.y,{size:24}),(0,e.jsx)(E.E,{element:"h4",weight:"bold",children:(0,e.jsx)(f.x6,{i18nKey:"provisioning.job-status.starting",children:"Starting..."})})]})}},34888:(ue,K,s)=>{s.d(K,{c:()=>E});var e=s(74848),f=s(27594),r=s(41654);const T=()=>[{id:"resource",header:"Resource",cell:({row:{original:d}})=>d.resource},{id:"created",header:"Created",cell:({row:{original:d}})=>d.create?.toString()||"-"},{id:"deleted",header:"Deleted",cell:({row:{original:d}})=>d.delete?.toString()||"-"},{id:"updated",header:"Updated",cell:({row:{original:d}})=>d.update?.toString()||"-"},{id:"unchanged",header:"Unchanged",cell:({row:{original:d}})=>d.noop?.toString()||"-"},{id:"errors",header:"Errors",cell:({row:{original:d}})=>d.error?.toString()||"-"},{id:"total",header:"Total",cell:({row:{original:d}})=>((d.create||0)+(d.delete||0)+(d.update||0)+(d.noop||0)+(d.error||0)).toString()}];function E({summary:d}){return(0,e.jsx)(r.B,{direction:"column",gap:2,children:(0,e.jsx)(f.j,{data:d,columns:T(),getRowId:u=>u.resource||"",pageSize:10})})}},80465:(ue,K,s)=>{s.d(K,{Y:()=>u});var e=s(74848),f=s(92745),r=s(34999),T=s(88227);const E=(y,P="error")=>typeof y=="string"?y:P==="warning"?y.title||(0,f.t)("provisioning.warning-title-default","Warning"):P==="success"?y.title||(0,f.t)("provisioning.success-title-default","Success"):y.title||(0,f.t)("provisioning.error-title-default","Error"),d=y=>typeof y=="string"||!y.message?null:Array.isArray(y.message)?(0,e.jsx)(T.M,{messages:y.message}):y.message;function u({error:y,warning:P,success:Y}){const V=y||P||Y,Q=y?"error":P?"warning":"success",B=Q==="success"?"success":Q;return V?(0,e.jsx)(r.F,{severity:B,title:E(V,Q),children:d(V)}):null}},84128:(ue,K,s)=>{s.r(K),s.d(K,{default:()=>lt});var e=s(74848),f=s(54148),r=s(92745),T=s(13791),E=s(82781),d=s(22803),u=s(96540),y=s(49785),P=s(32899),Y=s(75234),V=s(68143),Q=s(63142),B=s(41654),oe=s(31286),U=s(66404),ae=s(45861),he=s(71599),_=s(83793),fe=s(83813),ye=s(70368),re=s(80465),ee=s(91555),me=s(67170),b=s(79162);const C=t=>{const n=["local.path","github.branch","github.url","secure.token","gitlab.branch","gitlab.url","bitbucket.branch","bitbucket.url","git.branch","git.url"],o={path:"repository.path",branch:"repository.branch",url:"repository.url",token:"repository.token"};for(const i of t)if(i.field){const a=i.field.replace("spec.","");if(n.includes(a)){const l=a.split("."),g=l[l.length-1];if(g in o)return[o[g],{message:i.detail||`Invalid ${g}`}]}}return[null,null]};var z=s(6975),x=s(8073),h=s(37386),j=s(63527);const O=(0,u.createContext)(void 0),A=({children:t})=>{const[n,o]=(0,u.useState)({status:"idle"}),i=(0,u.useCallback)(l=>{o(l)},[]),a={stepStatusInfo:n,setStepStatusInfo:i,hasStepError:n.status==="error",hasStepWarning:n.status==="warning",isStepRunning:n.status==="running",isStepSuccess:n.status==="success",isStepIdle:n.status==="idle"};return(0,e.jsx)(O.Provider,{value:a,children:t})},H=()=>{const t=(0,u.useContext)(O);if(t===void 0)throw new Error("useStepStatus must be used within a StepStatusProvider");return t};function N(t,n,o){const i=o?.items?.some(a=>a.target==="folder"&&a.name!==n);return t.filter(a=>o?.legacyStorage?a.target==="instance":a.target==="folder"?!0:a.target==="instance"?!i:!1)}function te(t,n){return(0,u.useMemo)(()=>{const o=[{target:"instance",label:(0,r.t)("provisioning.mode-options.instance.label","Sync all resources with external storage"),description:(0,r.t)("provisioning.mode-options.instance.description","Resources will be synced with external storage and provisioned into this instance. Existing Grafana resources will be migrated and merged if needed. After setup, all new resources and changes will be saved to external storage and automatically provisioned back into the instance."),subtitle:(0,r.t)("provisioning.mode-options.instance.subtitle","Use this option if you want to sync and manage your entire Grafana instance through external storage.")},{target:"folder",label:(0,r.t)("provisioning.mode-options.folder.label","Sync external storage to a new Grafana folder"),description:(0,r.t)("provisioning.mode-options.folder.description","After setup, a new Grafana folder will be created and synced with external storage. If any resources are present in external storage, they will be provisioned to this new folder. All new resources created in this folder will be stored and versioned in external storage."),subtitle:(0,r.t)("provisioning.mode-options.folder.subtitle","Use this option to sync external resources into a new folder without affecting the rest of your instance. You can repeat this process for up to 10 folders.")}];return N(o,t,n)},[t,n])}var ne=s(29189);function se(t,n){const o=c=>c.endsWith(".json")||c.endsWith(".yaml"),a=(t?.items??[]).filter(c=>{const m=c.path??"";return o(m)}).length;let l=[],g=0;return n?.instance?.forEach(c=>{switch(c.group){case"folders":case"folder.grafana.app":g+=c.count,l.push((0,r.t)("provisioning.bootstrap-step.folders-count","{{count}} folder",{count:c.count}));break;case"dashboard.grafana.app":g+=c.count,l.push((0,r.t)("provisioning.bootstrap-step.dashboards-count","{{count}} dashboard",{count:c.count}));break}}),{fileCount:a,resourceCount:g,resourceCountString:l.join(`,
`)}}function xe(t,n){const o=(0,_.v$)(t?void 0:ne.hT),i=(0,_.Bm)(t?{name:t}:ne.hT),a=o.isLoading||i.isLoading,{resourceCount:l,resourceCountString:g,fileCount:c}=(0,u.useMemo)(()=>se(i.data,o.data),[i.data,o.data]),m=n||l>0,S=!m&&l===0&&c===0,v=l>0?g:(0,r.t)("provisioning.bootstrap-step.empty","Empty"),w=c>0?(0,r.t)("provisioning.bootstrap-step.files-count","{{count}} files",{count:c}):(0,r.t)("provisioning.bootstrap-step.empty","Empty");return{resourceCount:l,resourceCountString:v,fileCount:c,fileCountString:w,isLoading:a,requiresMigration:m,shouldSkipSync:S}}function ke({settingsData:t,repoName:n}){const{setStepStatusInfo:o}=H(),{register:i,control:a,setValue:l,watch:g,getValues:c,formState:{errors:m}}=(0,y.xW)(),S=g("repository.sync.target"),v=te(n,t),{target:w}=v[0],{resourceCountString:I,fileCountString:M,isLoading:F}=xe(n,t?.legacyStorage);return(0,u.useEffect)(()=>{const G=c("repository"),p=(0,b.WQ)(G);l("repository.title",p)},[c,l]),(0,u.useEffect)(()=>{o({status:F?"running":"idle"})},[F,o]),(0,u.useEffect)(()=>{l("repository.sync.target",w)},[w,l]),F?(0,e.jsx)(oe.a,{padding:4,children:(0,e.jsx)(z._,{text:(0,r.t)("provisioning.bootstrap-step.text-loading-resource-information","Loading resource information...")})}):(0,e.jsx)(B.B,{direction:"column",gap:2,children:(0,e.jsxs)(B.B,{direction:"column",gap:2,children:[(0,e.jsx)(oe.a,{alignItems:"center",padding:4,children:(0,e.jsxs)(B.B,{direction:"row",gap:4,alignItems:"flex-start",justifyContent:"center",children:[(0,e.jsxs)(B.B,{direction:"column",gap:1,alignItems:"center",children:[(0,e.jsx)(U.E,{color:"secondary",children:(0,e.jsx)(r.x6,{i18nKey:"provisioning.bootstrap-step.grafana",children:"Grafana instance"})}),(0,e.jsx)(B.B,{direction:"row",gap:2,children:(0,e.jsx)(U.E,{variant:"h4",children:I})})]}),(0,e.jsxs)(B.B,{direction:"column",gap:1,alignItems:"center",children:[(0,e.jsx)(U.E,{color:"secondary",children:(0,e.jsx)(r.x6,{i18nKey:"provisioning.bootstrap-step.ext-storage",children:"External storage"})}),(0,e.jsx)(U.E,{variant:"h4",children:M})]})]})}),(0,e.jsx)(y.xI,{name:"repository.sync.target",control:a,render:({field:{ref:G,onChange:p,...$}})=>(0,e.jsx)(e.Fragment,{children:v.map(J=>(0,e.jsxs)(x.Z,{isSelected:J.target===S,onClick:()=>{p(J.target)},noMargin:!0,...$,children:[(0,e.jsx)(x.Z.Heading,{children:J.label}),(0,e.jsx)(x.Z.Description,{children:(0,e.jsxs)(B.B,{direction:"column",gap:3,children:[J.description,(0,e.jsx)(U.E,{color:"primary",children:J.subtitle})]})})]},J.target))})}),S==="folder"&&(0,e.jsx)(h.D,{label:(0,r.t)("provisioning.bootstrap-step.label-display-name","Display name"),description:(0,r.t)("provisioning.bootstrap-step.description-clear-repository-connection","Add a clear name for this repository connection"),error:m.repository?.title?.message,invalid:!!m.repository?.title,required:!0,noMargin:!0,children:(0,e.jsx)(j.p,{id:"repository-title",...i("repository.title",{required:(0,r.t)("provisioning.bootstrap-step.error-field-required","This field is required.")}),placeholder:(0,r.t)("provisioning.bootstrap-step.placeholder-my-repository-connection","My repository connection"),autoFocus:v.length===1&&v[0].target==="folder"})})]})})}var Pe=s(48767),De=s(43243),Te=s(48485),Ue=s(16817);function Ae(t){return["github","gitlab","bitbucket"].includes(t)}function Oe(t){return t instanceof Error&&"status"in t}const Ne=/^https:\/\/github\.com\/([^\/]+)\/([^\/]+)\/?$/,Fe=/^https:\/\/gitlab\.com\/([^\/]+)\/([^\/]+)\/?$/,We=/^https:\/\/bitbucket\.org\/([^\/]+)\/([^\/]+)\/?$/;function Se(t,n){let o=null;switch(n){case"github":o=t.match(Ne);break;case"gitlab":o=t.match(Fe);break;case"bitbucket":o=t.match(We);break;default:return null}return o&&o[1]&&o[2]?{owner:o[1],repo:o[2].replace(/\.git$/,"")}:null}function Ke(t,n){switch(t){case"github":return{Authorization:`Bearer ${n}`};case"gitlab":return{"Private-Token":n};case"bitbucket":return{Authorization:`Basic ${btoa(n)}`};default:throw new Error((0,r.t)("provisioning.http-utils.unsupported-repository-type","Unsupported repository type: {{repositoryType}}",{repositoryType:t}))}}async function $e(t){const n=await window.fetch(t.url,{method:"GET",headers:t.headers});if(!n.ok){const o=await n.text();console.error("API Error Response:",o);const i=new Error((0,r.t)("provisioning.http-utils.http-error","HTTP {{status}}: {{statusText}}",{status:n.status,statusText:n.statusText}));throw i.status=n.status,i}return n.json()}async function ve(t,n){const o=[];let i=1,a=!0;for(;a&&i<=10;){const l=t(i),g=await $e({url:l,headers:n}),c=Array.isArray(g)?g:g?.values;Array.isArray(c)&&c.length>0?(o.push(...c),a=c.length===100,i++):a=!1}return o}async function Je(t,n,o){return ve(i=>`https://api.github.com/repos/${t}/${n}/branches?per_page=100&page=${i}`,o)}async function Ve(t,n,o){const i=encodeURIComponent(`${t}/${n}`);return ve(a=>`https://gitlab.com/api/v4/projects/${i}/repository/branches?per_page=100&page=${a}`,o)}async function Ge(t,n,o){return ve(i=>`https://api.bitbucket.org/2.0/repositories/${t}/${n}/refs/branches?pagelen=100&page=${i}`,o)}async function Ye(t,n,o,i){const a=Ke(t,i);switch(t){case"github":return Je(n,o,a);case"gitlab":return Ve(n,o,a);case"bitbucket":return Ge(n,o,a);default:throw new Error((0,r.t)("provisioning.http-utils.unsupported-repository-type","Unsupported repository type: {{repositoryType}}",{repositoryType:t}))}}function Qe(t){let n=(0,r.t)("provisioning.http-utils.request-failed","Request failed");return Oe(t)&&(t.status===401?n=(0,r.t)("provisioning.http-utils.authentication-failed","Authentication failed. Please check your access token."):t.status===404?n=(0,r.t)("provisioning.http-utils.resource-not-found","Resource not found. Please check the URL or repository."):t.status===403?n=(0,r.t)("provisioning.http-utils.access-denied","Access denied. Please check your token permissions."):t.message&&(n=t.message)),n}function He({repositoryType:t,repositoryUrl:n="",repositoryToken:o="",repositoryTokenUser:i=""}){const a=n.trim(),l=o.trim(),g=i.trim(),c=(0,u.useMemo)(()=>{if(!Ae(t))return!1;const v=a.length>0,w=l.length>0,I=t==="bitbucket"?g.length>0:!0,M=v?Se(a,t):null;return v&&w&&I&&M!==null},[a,l,g,t]),m=(0,u.useMemo)(()=>async()=>{if(!c)return[];const v=Se(a,t);if(!v)throw new Error("Invalid repository URL format");const w=t==="bitbucket"?`${g}:${l}`:l;return(await Ye(t,v.owner,v.repo,w)).map(M=>({label:M.name,value:M.name}))},[c,a,l,g,t]),S=(0,Ue.A)(m,[m]);return{options:S.value||[],loading:S.loading,error:S.error?Qe(S.error):null}}var Ze=s(92784),be=s(6279);function Xe(){const{register:t,control:n,setValue:o,formState:{errors:i},getValues:a,watch:l}=(0,y.xW)(),[g,c]=(0,u.useState)(!1),m=a("repository.type"),[S="",v="",w=""]=l(["repository.url","repository.token","repository.tokenUser"]),I=(0,E.QM)(m),{options:M,loading:F,error:G}=He({repositoryType:m,repositoryUrl:S,repositoryToken:v,repositoryTokenUser:w}),p=I?(0,be.L)(m):null,$=I?null:(0,be.Y)(m),J=(0,Ze.Nv)(m);return(0,e.jsxs)(B.B,{direction:"column",gap:2,children:[J&&(0,e.jsx)(Te.c,{type:m}),p&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(h.D,{noMargin:!0,label:p.tokenConfig.label,required:p.tokenConfig.required,description:p.tokenConfig.description,error:i?.repository?.token?.message,invalid:!!i?.repository?.token?.message,children:(0,e.jsx)(y.xI,{name:"repository.token",control:n,rules:p.tokenConfig.validation,render:({field:{ref:ce,...Z}})=>(0,e.jsx)(Pe.L4,{...Z,id:"token",placeholder:p.tokenConfig.placeholder,isConfigured:g,onReset:()=>{o("repository.token",""),c(!1)}})})}),p.tokenUserConfig&&(0,e.jsx)(h.D,{noMargin:!0,label:p.tokenUserConfig.label,required:p.tokenUserConfig.required,description:p.tokenUserConfig.description,error:i?.repository?.tokenUser?.message,invalid:!!i?.repository?.tokenUser?.message,children:(0,e.jsx)(j.p,{...t("repository.tokenUser",p.tokenUserConfig.validation),id:"tokenUser",placeholder:p.tokenUserConfig.placeholder})}),(0,e.jsx)(h.D,{noMargin:!0,label:p.urlConfig.label,description:p.urlConfig.description,error:i?.repository?.url?.message,invalid:!!i?.repository?.url?.message,required:p.urlConfig.required,children:(0,e.jsx)(j.p,{...t("repository.url",p.urlConfig.validation),id:"repository-url",placeholder:p.urlConfig.placeholder})}),(0,e.jsx)(h.D,{noMargin:!0,label:p.branchConfig.label,description:p.branchConfig.description,error:i?.repository?.branch?.message,required:p.branchConfig.required,invalid:!!(i?.repository?.branch?.message||G),children:(0,e.jsx)(y.xI,{name:"repository.branch",control:n,rules:p.branchConfig.validation,render:({field:{ref:ce,onChange:Z,...le}})=>(0,e.jsx)(De.G,{invalid:!!(i?.repository?.branch?.message||G),onChange:X=>Z(X?.value||""),placeholder:p.branchConfig.placeholder,options:M,loading:F,createCustomValue:!0,isClearable:!0,...le})})}),(0,e.jsx)(h.D,{noMargin:!0,label:p.pathConfig.label,description:p.pathConfig.description,error:i?.repository?.path?.message,invalid:!!i?.repository?.path?.message,required:p.pathConfig.required,children:(0,e.jsx)(j.p,{...t("repository.path",p.pathConfig.validation),id:"git-path",placeholder:p.pathConfig.placeholder})})]}),$&&(0,e.jsx)(h.D,{noMargin:!0,label:$.pathConfig.label,description:$.pathConfig.description,error:i?.repository?.path?.message,invalid:!!i?.repository?.path?.message,required:$.pathConfig.required,children:(0,e.jsx)(j.p,{...t("repository.path",$.pathConfig.validation),id:"local-path",placeholder:$.pathConfig.placeholder})})]})}var pe=s(32635),Ce=s(89640),we=s(53247);function qe(){const{register:t,watch:n,setValue:o}=(0,y.xW)(),[i,a]=n(["repository.type","repository.readOnly"]),l=i==="github",g=(0,E.QM)(i),c=(0,we.ED)(),m=(0,we.hF)();(0,u.useEffect)(()=>{o("repository.sync.enabled",!0)},[o]);const S=g?(0,be.L)(i):null;return(0,e.jsxs)(B.B,{direction:"column",gap:2,children:[g&&(0,e.jsx)(h.D,{noMargin:!0,label:(0,r.t)("provisioning.finish-step.label-sync-interval","Sync Interval (seconds)"),description:(0,r.t)("provisioning.finish-step.description-sync-interval","How often to sync changes from the repository"),required:!0,children:(0,e.jsx)(j.p,{...t("repository.sync.intervalSeconds",{valueAsNumber:!0,required:(0,r.t)("provisioning.finish-step.error-sync-interval-required","Sync interval is required")}),type:"number",placeholder:"60"})}),(0,e.jsx)(h.D,{noMargin:!0,children:(0,e.jsx)(pe.S,{...t("repository.readOnly",{onChange:v=>{v.target.checked&&o("repository.prWorkflow",!1)}}),label:(0,r.t)("provisioning.finish-step.label-read-only","Read only"),description:(0,r.t)("provisioning.finish-step.description-read-only","Resources can't be modified through Grafana.")})}),S&&(0,e.jsx)(h.D,{noMargin:!0,children:(0,e.jsx)(pe.S,{...t("repository.prWorkflow"),disabled:a,label:S.prWorkflowConfig.label,description:S.prWorkflowConfig.description})}),l&&(0,e.jsx)(h.D,{noMargin:!0,children:(0,e.jsx)(pe.S,{...t("repository.generateDashboardPreviews"),label:(0,r.t)("provisioning.finish-step.label-generate-dashboard-previews","Generate Dashboard Previews"),description:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(r.x6,{i18nKey:"provisioning.finish-step.description-generate-dashboard-previews",children:"Create preview links for pull requests"}),(!c||!m)&&(0,e.jsxs)(e.Fragment,{children:[" ",(0,e.jsx)(U.E,{color:"secondary",children:(0,e.jsxs)(r.x6,{i18nKey:"provisioning.finish-step.description-preview-requirements",children:["(requires"," ",(0,e.jsx)(Ce.Y,{href:"https://grafana.com/docs/grafana/latest/setup-grafana/image-rendering/",children:"image rendering"})," ","and public access enabled)"]})})]})]}),disabled:!c||!m})})]})}var _e=s(30703);function et({visitedSteps:t=[],steps:n,activeStep:o=n[0]?.id}){const i=(0,Q.of)(tt);return(0,e.jsx)("ol",{className:i.container,children:n.map((a,l)=>{const g=a.id===o,c=t.includes(a.id)&&!g,m=l===n.length-1,S=(0,d.cx)(i.stepText,{[i.activeStepText]:g});return(0,e.jsxs)("li",{className:i.stepContainer,children:[(0,e.jsxs)("div",{className:i.stepContent,children:[c?(0,e.jsx)("div",{className:(0,d.cx)(i.stepNumber,i.completedStepNumber),children:(0,e.jsx)(_e.I,{name:"check",size:"sm"})}):(0,e.jsx)("div",{className:i.stepNumber,children:l+1}),(0,e.jsx)("div",{className:S,children:a.name})]}),!m&&(0,e.jsx)("div",{className:i.connector})]},a.id)})})}const tt=t=>({container:(0,d.css)({display:"flex",flexDirection:"column",margin:t.spacing(2,0),padding:0,listStyle:"none",width:200}),stepContainer:(0,d.css)({display:"flex",flexDirection:"column",alignItems:"flex-start",position:"relative"}),stepContent:(0,d.css)({display:"flex",alignItems:"center",padding:t.spacing(.5,0)}),stepNumber:(0,d.css)({display:"flex",justifyContent:"center",alignItems:"center",height:t.spacing(3),width:t.spacing(3),color:t.colors.text.secondary,fontSize:t.typography.size.sm,fontWeight:t.typography.fontWeightMedium,marginRight:t.spacing(1)}),completedStepNumber:(0,d.css)({color:t.colors.success.main}),stepText:(0,d.css)({color:t.colors.text.secondary,fontSize:t.typography.size.md}),activeStepText:(0,d.css)({color:t.colors.text.primary,fontWeight:t.typography.fontWeightMedium}),connector:(0,d.css)({width:"1px",backgroundColor:t.colors.border.medium,height:t.spacing(2),marginLeft:t.spacing(1.5),marginTop:t.spacing(.5)})});var nt=s(34999),rt=s(15983);function Ee({repoName:t,requiresMigration:n,repoType:o,isLegacyStorage:i,setStepStatusInfo:a}){const[l,{isLoading:g}]=(0,_.bS)(),c=(0,E.QM)(o)&&i;return{createSyncJob:async S=>{if(!t)return a?.({status:"error",error:(0,r.t)("provisioning.sync-job.error-no-repository-name","No repository name provided")}),null;try{a?.({status:"running"});const v=n?{migrate:{history:(S?.history||!1)&&c}}:{pull:{incremental:!1}},w=await l({name:t,jobSpec:v}).unwrap();return w?.metadata?.name?(a?.({status:"success"}),w):(a?.({status:"error",error:(0,r.t)("provisioning.sync-job.error-no-job-id","Failed to start job")}),null)}catch{return a?.({status:"error",error:(0,r.t)("provisioning.sync-job.error-starting-job","Error starting job")}),null}},isLoading:g,supportsHistory:c}}function st({isLegacyStorage:t}){const{getValues:n,register:o,watch:i}=(0,y.xW)(),{setStepStatusInfo:a}=H(),[l="",g]=i(["repositoryName","repository.type"]),{requiresMigration:c}=xe(l,t),{createSyncJob:m,supportsHistory:S}=Ee({repoName:l,requiresMigration:c,repoType:g,isLegacyStorage:t,setStepStatusInfo:a}),[v,w]=(0,u.useState)(),I=async()=>{const[M]=n(["migrate.history"]),F=await m({history:M});F&&w(F)};return v?(0,e.jsx)(rt.A,{watch:v,onStatusChange:a,jobType:"sync"}):(0,e.jsxs)(B.B,{direction:"column",gap:3,alignItems:"flex-start",children:[(0,e.jsx)(U.E,{color:"secondary",children:(0,e.jsx)(r.x6,{i18nKey:"provisioning.wizard.sync-description",children:"Sync resources with external storage. After this one-time step, all future updates will be automatically saved to the repository and provisioned back into the instance."})}),(0,e.jsx)(nt.F,{title:(0,r.t)("provisioning.wizard.alert-title","Important: No data or configuration will be lost, but dashboards will be temporarily unavailable for a few minutes."),severity:"info",children:(0,e.jsxs)("ul",{style:{marginLeft:"16px"},children:[(0,e.jsx)("li",{children:(0,e.jsx)(r.x6,{i18nKey:"provisioning.wizard.alert-point-1",children:"Resources won't be able to be created, edited, or deleted during this process. In the last step, they will disappear."})}),(0,e.jsx)("li",{children:(0,e.jsx)(r.x6,{i18nKey:"provisioning.wizard.alert-point-2",children:"Once provisioning is complete, resources will reappear and be managed through external storage."})}),(0,e.jsx)("li",{children:(0,e.jsx)(r.x6,{i18nKey:"provisioning.wizard.alert-point-3",children:"The duration of this process depends on the number of resources involved."})}),(0,e.jsx)("li",{children:(0,e.jsxs)(r.x6,{i18nKey:"provisioning.wizard.alert-point-4",children:["Enterprise instance administrators can display an announcement banner to users. See"," ",(0,e.jsx)(Ce.Y,{external:!0,href:"https://grafana.com/docs/grafana/latest/administration/announcement-banner/",children:"this guide"})," ","for step-by-step instructions."]})})]})}),S&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(U.E,{element:"h3",children:(0,e.jsx)(r.x6,{i18nKey:"provisioning.synchronize-step.synchronization-options",children:"Synchronization options"})}),(0,e.jsx)(h.D,{noMargin:!0,children:(0,e.jsx)(pe.S,{...o("migrate.history"),id:"migrate-history",label:(0,r.t)("provisioning.wizard.sync-option-history","History"),description:(0,e.jsx)(r.x6,{i18nKey:"provisioning.synchronize-step.synchronization-description",children:"Include commits for each historical value"})})})]}),(0,e.jsx)(ae.$n,{variant:"primary",onClick:I,children:(0,e.jsx)(r.x6,{i18nKey:"provisioning.wizard.button-start",children:"Begin synchronization"})})]})}const it=(0,Y.J7)(),ot=()=>[{id:"connection",name:(0,r.t)("provisioning.wizard.step-connect","Connect"),title:(0,r.t)("provisioning.wizard.title-connect","Connect to external storage"),submitOnNext:!0},{id:"bootstrap",name:(0,r.t)("provisioning.wizard.step-bootstrap","Choose what to synchronize"),title:(0,r.t)("provisioning.wizard.title-bootstrap","Choose what to synchronize"),submitOnNext:!0},{id:"synchronize",name:(0,r.t)("provisioning.wizard.step-synchronize","Synchronize with external storage"),title:(0,r.t)("provisioning.wizard.title-synchronize","Synchronize with external storage"),submitOnNext:!1},{id:"finish",name:(0,r.t)("provisioning.wizard.step-finish","Choose additional settings"),title:(0,r.t)("provisioning.wizard.title-finish","Choose additional settings"),submitOnNext:!0}];function at({type:t}){const[n,o]=(0,u.useState)("connection"),[i,a]=(0,u.useState)([]),[l,g]=(0,u.useState)(!1),[c,m]=(0,u.useState)(!1),[S,v]=(0,u.useState)(!1),{stepStatusInfo:w,setStepStatusInfo:I,isStepSuccess:M,isStepRunning:F,hasStepError:G,hasStepWarning:p}=H(),$=n==="synchronize"&&(M||p||G),J=n==="finish"&&(M||i.includes("synchronize")),ce=n==="connection"||$||J,{data:Z}=(0,_.F9)(),le=!!Z?.legacyStorage,X=(0,f.Zp)(),D=ot(),je=(0,Q.of)(ct),dt=(0,ye.w)(),Be=(0,y.mN)({defaultValues:{repository:{...dt,type:t},migrate:{history:!0}}}),{watch:ut,setValue:pt,getValues:gt,trigger:ht,setError:ft,formState:{isDirty:yt},handleSubmit:mt}=Be,[W="",xt]=ut(["repositoryName","repository.type"]),[vt]=(0,me.A)(W),[bt]=(0,_.So)(),{shouldSkipSync:jt,requiresMigration:St,isLoading:Ct}=xe(W,le),{createSyncJob:wt,isLoading:Et}=Ee({repoName:W,requiresMigration:St,repoType:xt,isLegacyStorage:le,setStepStatusInfo:I}),de=D.findIndex(L=>L.id===n),ze=D[de],ge=W&&!Ct&&jt;(0,u.useEffect)(()=>{Z?.items.some(L=>L.target==="instance"&&L.name!==W)&&(it.publish({type:P.r1.alertError.name,payload:[(0,r.t)("provisioning.wizard-content.error-instance-repository-exists","Instance repository already exists")]}),X(ee.mL))},[X,W,Z?.items]);const Ie=async L=>{m(!0);try{await bt({name:L}),setTimeout(()=>{X(ee.mL)},1e3)}catch{m(!1)}},Bt=()=>{const L=D.findIndex(R=>R.id===n);if(L>0){let R=L-1;if(n==="finish"&&ge&&(R=L-2),R>=0){const k=D[R];o(k.id),a(ie=>ie.filter(q=>q!==n)),I({status:"idle"})}}},zt=async()=>{W&&await Ie(W),await Me()},Me=async()=>{if(ce){if(!W){X(ee.mL);return}v(!0);return}Bt()},It=()=>{v(!1),Ie(W)},Mt=(0,u.useCallback)(L=>{const R=D.findIndex(k=>k.id===L);if(R===-1||R>=D.length-1)return(0,r.t)("provisioning.wizard.button-next","Finish");if(L==="bootstrap"&&ge){const k=R+2;return k<D.length?D[k].name:(0,r.t)("provisioning.wizard.button-next","Finish")}return D[R+1].name},[D,ge]),Rt=(0,u.useCallback)(()=>c?(0,r.t)("provisioning.wizard-content.button-cancelling","Cancelling..."):ce?(0,r.t)("provisioning.wizard-content.button-cancel","Cancel"):(0,r.t)("provisioning.wizard-content.button-previous","Previous"),[c,ce]),Re=async()=>{if(de===D.length-1)X(ee.mL);else{let R=de+1;if(n==="bootstrap"&&ge&&(R=de+2,!await wt()))return;if(R>=D.length){X(ee.mL);return}o(D[R].id),a(k=>[...new Set([...k,n])]),I({status:"idle"})}},Lt=async()=>{if(ze?.submitOnNext){if(!await ht(n==="connection"?["repository"]:["repository","repository.title"]))return;g(!0);try{const k=gt(),ie=(0,b.tB)(k.repository),q=await vt(ie,k.repository.token);if(q.error){I({status:"error",error:"Repository request failed"});return}const Le=q.data?.metadata?.name;Le?(pt("repositoryName",Le),I({status:"success"}),Re()):console.error("Saved repository without a name:",q)}catch(k){if((0,V.NF)(k)){const[ie,q]=C(k.data.errors);ie&&q&&ft(ie,q)}else I({status:"error",error:"Repository connection failed"})}finally{g(!1)}}else(M||p)&&Re()},kt=()=>n!=="connection"&&G?!0:n==="synchronize"?!(M||p):l||c||F||Et;return(0,e.jsxs)(y.Op,{...Be,children:[(0,e.jsxs)(B.B,{gap:6,direction:"row",alignItems:"flex-start",children:[(0,e.jsx)(et,{steps:D,activeStep:n,visitedSteps:i}),(0,e.jsx)("div",{className:je.divider}),(0,e.jsxs)("form",{onSubmit:mt(Lt),className:je.form,children:[(0,e.jsx)(fe.F,{onDiscard:zt,confirmRedirect:yt&&!["connection","finish"].includes(n)&&!c}),(0,e.jsxs)(B.B,{direction:"column",children:[(0,e.jsx)(oe.a,{marginBottom:2,children:(0,e.jsxs)(U.E,{element:"h2",children:[de+1,". ",ze?.title]})}),G&&"error"in w&&(0,e.jsx)(re.Y,{error:w.error}),p&&"warning"in w&&(0,e.jsx)(re.Y,{warning:w.warning}),M&&"success"in w&&(0,e.jsx)(re.Y,{success:w.success}),(0,e.jsxs)("div",{className:je.content,children:[n==="connection"&&(0,e.jsx)(Xe,{}),n==="bootstrap"&&(0,e.jsx)(ke,{settingsData:Z,repoName:W}),n==="synchronize"&&(0,e.jsx)(st,{isLegacyStorage:le}),n==="finish"&&(0,e.jsx)(qe,{})]}),(0,e.jsxs)(B.B,{gap:2,justifyContent:"flex-end",children:[(0,e.jsx)(ae.$n,{variant:"secondary",onClick:Me,disabled:l||c||F||S,children:Rt()}),(0,e.jsx)(ae.$n,{type:"submit",disabled:kt(),children:l?(0,r.t)("provisioning.wizard-content.button-submitting","Submitting..."):Mt(n)})]})]})]})]}),(0,e.jsx)(he.u,{isOpen:S,title:(0,r.t)("provisioning.wizard.discard-modal.title","Discard repository setup?"),body:(0,r.t)("provisioning.wizard.discard-modal.body","This will delete the repository configuration and you will lose all progress. Are you sure you want to discard your changes?"),confirmText:(0,r.t)("provisioning.wizard.discard-modal.confirm","Yes, discard"),dismissText:(0,r.t)("provisioning.wizard.discard-modal.dismiss","Keep working"),onConfirm:It,onDismiss:()=>v(!1)})]})}const ct=t=>({form:(0,d.css)({maxWidth:"900px",flexGrow:1}),divider:(0,d.css)({width:1,alignSelf:"stretch",backgroundColor:t.colors.border.weak,marginBottom:t.spacing(13)}),content:(0,d.css)({borderBottom:`1px solid ${t.colors.border.weak}`,paddingBottom:t.spacing(4),marginBottom:t.spacing(4)})});function lt(){const{type:t}=(0,f.g)();return t?(0,e.jsx)(T.Y,{navId:"provisioning",pageNav:{text:(0,E.QM)(t)?"Configure Git Sync":"Configure local file path",subTitle:(0,r.t)("provisioning.connect-page.subTitle.connect-external-storage-manage-resources","Connect to an external storage to manage your resources")},children:(0,e.jsx)(T.Y.Contents,{children:(0,e.jsx)(A,{children:(0,e.jsx)(at,{type:t})})})}):null}},88227:(ue,K,s)=>{s.d(K,{M:()=>E});var e=s(74848),f=s(22803),r=s(66404),T=s(63142);function E({messages:u,variant:y}){const P=(0,T.of)(d);return(0,e.jsx)("ul",{className:P.messageList,children:u.map((Y,V)=>(0,e.jsx)("li",{children:y?(0,e.jsx)(r.E,{variant:y,children:Y}):Y},V))})}const d=u=>({messageList:(0,f.css)({margin:0,paddingLeft:u.spacing(3)})})}}]);

//# sourceMappingURL=ProvisioningWizardPage.46c00cc11646e6ef1755.js.map