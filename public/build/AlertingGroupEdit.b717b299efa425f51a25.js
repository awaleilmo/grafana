"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[4312,6102],{12266:(X,A,a)=>{a.d(A,{e:()=>C});var e=a(74848),f=a(45861);const C=({isCollapsed:v,onToggle:T,idControlled:S,className:o,text:P,size:I="xl",...F})=>(0,e.jsx)(f.$n,{type:"button",fill:"text",variant:"secondary","aria-expanded":!v,"aria-controls":S,className:o,icon:v?"angle-right":"angle-down",onClick:()=>T(!v),...F,children:P})},25521:(X,A,a)=>{a.d(A,{G:()=>I});var e=a(74848),f=a(22803),C=a(92745),v=a(30703),T=a(59243),S=a(66404),o=a(41654),P=a(63142);function I({contentText:D,externalLink:x,linkText:G,title:j="Need help?"}){const L=(0,P.of)(F);return(0,e.jsx)(T.G,{content:(0,e.jsx)("div",{className:L.mutedText,children:D}),title:(0,e.jsxs)(o.B,{gap:.5,direction:"row",alignItems:"center",children:[(0,e.jsx)(v.I,{name:"question-circle"}),j]}),footer:x?(0,e.jsx)("a",{href:x,target:"_blank",rel:"noreferrer",children:(0,e.jsx)(o.B,{direction:"row",gap:.5,alignItems:"center",children:(0,e.jsxs)(S.E,{color:"link",children:[G," ",(0,e.jsx)(v.I,{size:"sm",name:"external-link-alt"})]})})}):void 0,closeButton:!0,placement:"bottom-start",children:(0,e.jsx)("div",{className:L.helpInfo,children:(0,e.jsxs)(o.B,{direction:"row",alignItems:"center",gap:.5,children:[(0,e.jsx)(v.I,{name:"question-circle",size:"sm"}),(0,e.jsx)(S.E,{variant:"bodySmall",color:"primary",children:(0,e.jsx)(C.x6,{i18nKey:"alerting.need-help-info.need-help",children:"Need help?"})})]})})})}const F=D=>({mutedText:(0,f.css)({color:D.colors.text.secondary,fontSize:D.typography.size.sm}),helpInfo:(0,f.css)({cursor:"pointer",textDecoration:"underline"})})},56638:(X,A,a)=>{a.r(A),a.d(A,{default:()=>Ae});var e=a(74848),f=a(22803),C=a(1932),v=a(96540),T=a(49785),S=a(54148),o=a(92745),P=a(36490),I=a(34999),F=a(36303),D=a(63142),x=a(37386),G=a(63527),j=a(41654),L=a(45861),V=a(71599),W=a(1506),w=a(64762),H=a(52763),k=a(86791),te=a(74268),U=a(70327),ne=a(55143),se=a(36826),de=a(44351),pe=a(8535),ge=a(11018),Q=a(80218),oe=a(71639);const{useDeleteRuleGroupFromNamespaceMutation:me}=U.hK,{useLazyDiscoverDsFeaturesQuery:fe}=ne.L;function ve(){const[n]=me(),[r]=fe();return(0,Q.Yb)(async s=>{const{dataSourceName:i,namespaceName:l,groupName:u}=s,{rulerConfig:p}=await r({rulesSourceName:i}).unwrap();if(!p)throw(0,oe._)(i);const c=await n({rulerConfig:p,namespace:l,group:u}).unwrap();return await(0,pe.JD)((0,ge.Lc)({rulesSourceName:i})),c})}var he=a(62939),$=a(96137),xe=a(52161);const ie=()=>t("alerting.rule-groups.update.success","Successfully updated rule group");function Re(){const[n]=(0,oe.D)(),[r]=U.hK.endpoints.getRuleGroupForNamespace.useLazyQuery(),[s]=U.hK.endpoints.upsertRuleGroupForNamespace.useMutation(),[i]=U.hK.endpoints.deleteRuleGroupFromNamespace.useMutation();return(0,Q.Yb)(async(l,u)=>{const p=[],c=(0,xe.z2)(l.dataSourceName);if(u.namespaceName){if(c)throw new Error("Moving a Grafana-managed rule group to another folder is currently not supported.");p.push((0,$.fO)({newNamespaceName:u.namespaceName}))}u.groupName&&p.push((0,$.KL)({groupName:u.groupName})),u.interval&&p.push((0,$.lF)({interval:u.interval})),u.ruleSwaps&&p.push((0,$.bw)({swaps:u.ruleSwaps}));const{newRuleGroupDefinition:g,rulerConfig:d}=await n(l,p),h=l.namespaceName,m=u.namespaceName??h,N=l.groupName,R=g.name,E=h!==m,y=N!==R;if(R&&y&&(await r({rulerConfig:d,namespace:m,group:R,notificationOptions:{showErrorAlert:!1}}).unwrap().catch(he.R))?.rules?.length)throw new Error("Target group already has rules, merging rule groups is currently not supported.");await s({rulerConfig:d,namespace:m,payload:g,notificationOptions:{showSuccessAlert:!1}}).unwrap();const K=d.dataSourceName==="grafana"?{groupName:R,namespace:{uid:m},groupOrigin:"grafana"}:{groupName:R,namespace:{name:m},groupOrigin:"datasource",rulesSource:{uid:d.dataSourceUid,name:d.dataSourceName,ruleSourceType:"datasource"}};return(E||y)&&!c&&await i({rulerConfig:d,namespace:h,group:N,notificationOptions:{showSuccessAlert:!1}}).unwrap().catch(O=>{(0,te.vV)(O)}),K})}function We(){const[n]=useProduceNewRuleGroup(),[r]=alertRuleApi.endpoints.upsertRuleGroupForNamespace.useMutation();return useAsync(async(s,i)=>{const{namespaceName:l}=s,u=updateRuleGroupAction({interval:i}),{newRuleGroupDefinition:p,rulerConfig:c}=await n(s,[u]);return r({rulerConfig:c,namespace:l,payload:p,notificationOptions:{successMessage:ie()}}).unwrap()})}function Ue(){const[n]=useProduceNewRuleGroup(),[r]=alertRuleApi.endpoints.getRuleGroupForNamespace.useLazyQuery(),[s]=alertRuleApi.endpoints.upsertRuleGroupForNamespace.useMutation(),[i]=alertRuleApi.endpoints.deleteRuleGroupFromNamespace.useMutation(),l=t("alerting.rule-groups.move.success","Successfully moved rule group");return useAsync(async(u,p,c,g)=>{if(isGrafanaRulesSource(u.dataSourceName))throw new Error("Moving a Grafana-managed rule group to another folder is currently not supported.");const d=moveRuleGroupAction({newNamespaceName:p,groupName:c,interval:g}),{newRuleGroupDefinition:h,rulerConfig:m}=await n(u,[d]),N=u.namespaceName,R=d.payload.newNamespaceName,E=u.groupName,y=d.payload.groupName;if(y&&(!!y&&E!==y)&&(await r({rulerConfig:m,namespace:R,group:y,notificationOptions:{showErrorAlert:!1}}).unwrap().catch(notFoundToNullOrThrow))?.rules?.length)throw new Error("Target group already has rules, merging rule groups is currently not supported.");return await s({rulerConfig:m,namespace:R,payload:h,notificationOptions:{successMessage:l}}).unwrap(),await i({rulerConfig:m,namespace:N,group:E,notificationOptions:{showSuccessAlert:!1}}).unwrap()})}function $e(){const[n]=useProduceNewRuleGroup(),[r]=alertRuleApi.endpoints.getRuleGroupForNamespace.useLazyQuery(),[s]=alertRuleApi.endpoints.upsertRuleGroupForNamespace.useMutation(),[i]=alertRuleApi.endpoints.deleteRuleGroupFromNamespace.useMutation();return useAsync(async(l,u,p)=>{const c=renameRuleGroupAction({groupName:u,interval:p}),{newRuleGroupDefinition:g,rulerConfig:d}=await n(l,[c]),h=l.groupName,m=c.payload.groupName,N=l.namespaceName,R=t("alerting.rule-groups.rename.success","Successfully renamed rule group");if((await r({rulerConfig:d,namespace:N,group:m,notificationOptions:{showErrorAlert:!1}}).unwrap().catch(notFoundToNullOrThrow))?.rules?.length)throw new Error("Target group has existing rules, merging rule groups is currently not supported.");const y=await s({rulerConfig:d,namespace:N,payload:g,notificationOptions:{successMessage:R}}).unwrap();return await i({rulerConfig:d,namespace:N,group:h,notificationOptions:{showSuccessAlert:!1}}).unwrap(),y})}function ze(){const[n]=useProduceNewRuleGroup(),[r]=alertRuleApi.endpoints.upsertRuleGroupForNamespace.useMutation();return useAsync(async(s,i)=>{const{namespaceName:l}=s,u=reorderRulesInRuleGroupAction({swaps:i}),{newRuleGroupDefinition:p,rulerConfig:c}=await n(s,[u]);return r({rulerConfig:c,namespace:l,payload:p,notificationOptions:{successMessage:ie()}}).unwrap()})}var ue=a(18404),Ne=a(80276),ye=a(39187),Ee=a(84523),le=a(67598),q=a(77256),z=a(29442),_=a(21835),De=a(30703),je=a(99887),Ge=a(94646),J=a(29609);function Oe({rules:n,groupInterval:r,onSwap:s}){const i=(0,D.of)(ae),[l,u]=(0,v.useState)(n),p=(0,v.useCallback)(g=>{if(!g.destination)return;const d=[g.source.index,g.destination.index];s(d);const h=(0,C.jM)(l,m=>{(0,$.Ct)(m,d)});u(h)},[l,s]),c=(0,v.useMemo)(()=>l.map(g=>({...g,uid:(0,Ge.Ns)(g)})),[l]);return(0,e.jsxs)("div",{children:[(0,e.jsx)(ee,{ruleName:(0,o.t)("alerting.draggable-rules-table.rule-name","Rule name"),pendingPeriod:(0,o.t)("alerting.draggable-rules-table.pending-period","Pending period"),evalsToStartAlerting:(0,o.t)("alerting.draggable-rules-table.evals-to-start-alerting","Evaluations to start alerting"),className:i.listHeader}),(0,e.jsx)(_.JY,{onDragEnd:p,children:(0,e.jsx)(_.gL,{droppableId:"alert-list",mode:"standard",renderClone:(g,d,h)=>(0,e.jsx)(ce,{provided:g,rule:c[h.source.index],isClone:!0,groupInterval:r}),children:g=>(0,e.jsxs)(j.B,{direction:"column",gap:0,ref:g.innerRef,...g.droppableProps,children:[c.map((d,h)=>(0,e.jsx)(_.sx,{draggableId:d.uid,index:h,isDragDisabled:!1,children:m=>(0,e.jsx)(ce,{provided:m,rule:d,groupInterval:r},d.uid)},d.uid)),g.placeholder]})})})]})}const ce=({provided:n,rule:r,groupInterval:s,isClone:i=!1})=>{const l=(0,D.of)(ae),u=(0,J.qz)(r),p=J.p.any.alertingRule(r)?r.for:null,c=(0,J.O9)(p??"0s",s),g=J.p.any.recordingRule(r);return(0,e.jsx)(ee,{dragHandle:(0,e.jsx)(De.I,{name:"draggabledots"}),ruleName:u,pendingPeriod:p,evalsToStartAlerting:g?(0,e.jsx)(je.E,{text:(0,o.t)("alerting.draggable-rules-table.recording","Recording"),color:"purple"}):c,"data-testid":"reorder-alert-rule",className:(0,f.cx)(l.listItem,{[l.listItemClone]:i}),ref:n.innerRef,...n.draggableProps,...n.dragHandleProps})},ee=(0,v.forwardRef)(({dragHandle:n,ruleName:r,pendingPeriod:s,evalsToStartAlerting:i,className:l,...u},p)=>{const c=(0,D.of)(ae);return(0,e.jsxs)("div",{className:(0,f.cx)(c.listItem,l),ref:p,...u,children:[(0,e.jsx)(j.B,{flex:"0 0 24px",children:n}),(0,e.jsx)(j.B,{flex:1,children:r}),(0,e.jsx)(j.B,{basis:"30%",children:s}),(0,e.jsx)(j.B,{basis:"30%",children:i})]})});ee.displayName="ListItem";const ae=n=>({listItem:(0,f.css)({display:"flex",flexDirection:"row",alignItems:"center",gap:n.spacing(1),padding:`${n.spacing(1)} ${n.spacing(2)}`,"&:nth-child(even)":{background:n.colors.background.secondary}}),listItemClone:(0,f.css)({border:`solid 1px ${n.colors.primary.shade}`}),listHeader:(0,f.css)({fontWeight:n.typography.fontWeightBold,borderBottom:`1px solid ${n.colors.border.weak}`})});var Se=a(76944);const{useDiscoverDsFeaturesQuery:Pe}=ne.L;function Me(){const n=(0,H.wA)(),{dataSourceUid:r="",namespaceId:s="",groupName:i=""}=(0,S.g)(),{folder:l,loading:u}=(0,ue.a)(r==="grafana"?s:""),p=r==="grafana"?k.l$:r,{data:c,isLoading:g,error:d}=Pe({uid:p}),[h,m]=(0,Q.Yb)(async b=>n(U.hK.endpoints.getRuleGroupForNamespace.initiate({rulerConfig:b,namespace:s,group:i})).unwrap());(0,v.useEffect)(()=>{s&&i&&c?.rulerConfig&&h.execute(c.rulerConfig)},[s,i,c?.rulerConfig,h]);const N=u||g||(0,Q.VP)(m),{result:R,error:E}=m,y={text:(0,o.t)("alerting.group-edit.page-title","Edit rule group"),parentItem:{text:l?.title??s,url:(0,z.tx)([["namespace",l?.title??s],["group",i]])}};if(c&&!c.rulerConfig)return(0,e.jsx)(se.d,{pageNav:y,navId:"alert-list",isLoading:N,children:(0,e.jsx)(I.F,{title:(0,o.t)("alerting.group-edit.group-not-editable","Selected group cannot be edited"),children:(0,e.jsx)(o.x6,{i18nKey:"alerting.group-edit.group-not-editable-description",children:"This group belongs to a data source that does not support editing."})})});const K=r==="grafana"?{namespace:{uid:s},groupName:i,groupOrigin:"grafana"}:{rulesSource:{uid:r,name:c?.name??"",ruleSourceType:"datasource"},namespace:{name:s},groupName:i,groupOrigin:"datasource"};return(0,e.jsxs)(se.d,{pageNav:y,navId:"alert-list",isLoading:N,children:[(0,e.jsxs)(e.Fragment,{children:[!!d&&(0,e.jsx)(I.F,{title:(0,o.t)("alerting.group-edit.ds-error","Error loading data source details"),bottomSpacing:0,topSpacing:2,children:(0,e.jsx)("div",{children:(0,q.JZ)(d)})}),!!E&&(0,e.jsx)(I.F,{title:(0,o.t)("alerting.group-edit.rule-group-error","Error loading rule group"),bottomSpacing:0,topSpacing:2,children:(0,q.JZ)(E)})]}),R&&(0,e.jsx)(Ce,{rulerGroup:R,groupIdentifier:K}),!R&&(0,e.jsx)(W.L,{entity:`${s}/${i}`})]})}const Ae=(0,F.Xc)(Me,{style:"page"});function Ce({rulerGroup:n,groupIdentifier:r}){const s=(0,D.of)(Te),i=(0,w._2)(),{returnTo:l}=(0,ye.h)(z.TN.detailsPageLinkFromGroupIdentifier(r)),{folder:u}=(0,ue.a)(r.groupOrigin==="grafana"?r.namespace.uid:""),{waitForGroupConsistency:p}=(0,Ne.zx)(),[c]=Re(),[g]=ve(),[d,h]=(0,v.useState)([]),[m,N]=(0,v.useState)(!1),R=n?.interval??Ee.T6,{register:E,handleSubmit:y,getValues:K,setValue:b,formState:{errors:O,dirtyFields:re,isSubmitting:Y}}=(0,T.mN)({mode:"onBlur",shouldFocusError:!0,defaultValues:{name:n.name,interval:n.interval,namespace:r.groupOrigin==="datasource"?r.namespace.name:void 0}}),Fe=(0,v.useCallback)(B=>{h(M=>(0,C.jM)(M,Z=>{Z.push(B)}))},[]),Be=async B=>{try{const M={namespaceName:re.namespace?B.namespace:void 0,groupName:re.name?B.name:void 0,interval:re.interval?B.interval:void 0,ruleSwaps:d.length?d:void 0},Z=await c.execute((0,le.Rc)(r),M);(!!M.namespaceName||!!M.groupName)&&await p(Z);const Ke=(0,o.t)("alerting.group-edit.form.update-success","Successfully updated the rule group");i.success(Ke),Ie(Z)}catch(M){(0,te.vV)(M instanceof Error?M:new Error("Failed to update rule group")),i.error((0,o.t)("alerting.group-edit.form.update-error","Failed to update rule group"),(0,q.JZ)(M))}},we=async()=>{await g.execute((0,le.Rc)(r)),await p(r),Le()};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)("form",{onSubmit:y(Be),children:[r.groupOrigin==="datasource"&&(0,e.jsx)(x.D,{label:(0,o.t)("alerting.group-edit.form.namespace-label","Namespace"),required:!0,invalid:!!O.namespace,error:O.namespace?.message,className:s.input,children:(0,e.jsx)(G.p,{id:"namespace",...E("namespace",{required:(0,o.t)("alerting.group-edit.form.namespace-required","Namespace is required")})})}),r.groupOrigin==="grafana"&&(0,e.jsx)(x.D,{label:(0,o.t)("alerting.group-edit.form.folder-label","Folder"),required:!0,children:(0,e.jsx)(G.p,{id:"folder",value:u?.title??"",readOnly:!0})}),(0,e.jsx)(x.D,{label:(0,o.t)("alerting.group-edit.form.group-name-label","Evaluation group name"),required:!0,invalid:!!O.name,error:O.name?.message,className:s.input,children:(0,e.jsx)(G.p,{id:"group-name",...E("name",{required:(0,o.t)("alerting.group-edit.form.group-name-required","Group name is required")})})}),(0,e.jsx)(x.D,{label:(0,o.t)("alerting.group-edit.form.interval-label","Evaluation interval"),description:(0,o.t)("alerting.group-edit.form.interval-description","How often is the group evaluated"),invalid:!!O.interval,error:O.interval?.message,className:s.input,htmlFor:"interval",children:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(G.p,{id:"interval",...E("interval",(0,Se.i)(n.rules)),className:s.intervalInput}),(0,e.jsx)(de.gv,{currentInterval:K("interval"),onSelect:B=>b("interval",B,{shouldValidate:!0,shouldDirty:!0})})]})}),(0,e.jsx)(x.D,{label:(0,o.t)("alerting.group-edit.form.rules-label","Alerting and recording rules"),description:(0,o.t)("alerting.group-edit.form.rules-description","Drag rules to reorder"),children:(0,e.jsx)(Oe,{rules:n.rules,groupInterval:R,onSwap:Fe})}),(0,e.jsxs)(j.B,{children:[(0,e.jsx)(L.$n,{type:"submit",disabled:Y,icon:Y?"spinner":void 0,children:(0,e.jsx)(o.x6,{i18nKey:"alerting.group-edit.form.save",children:"Save"})}),(0,e.jsx)(L.z9,{variant:"secondary",disabled:Y,href:l,children:(0,e.jsx)(o.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})})]})]}),r.groupOrigin==="datasource"&&(0,e.jsxs)(j.B,{direction:"row",justifyContent:"flex-end",children:[(0,e.jsx)(L.$n,{type:"button",variant:"destructive",onClick:()=>N(!0),disabled:Y,children:(0,e.jsx)(o.x6,{i18nKey:"alerting.group-edit.form.delete",children:"Delete"})}),(0,e.jsx)(V.u,{isOpen:m,title:(0,o.t)("alerting.group-edit.form.delete-title","Delete rule group"),body:(0,o.t)("alerting.group-edit.form.delete-body","Are you sure you want to delete this rule group?"),confirmText:(0,o.t)("alerting.group-edit.form.delete-confirm","Delete"),onConfirm:we,onDismiss:()=>N(!1)})]})]})}const Te=n=>({intervalInput:(0,f.css)({marginBottom:n.spacing(.5)}),input:(0,f.css)({maxWidth:"600px"})});function Ie(n){if(n.groupOrigin==="datasource"){const{rulesSource:r,namespace:s,groupName:i}=n;P.Ny.replace(z.TN.editPageLink(r.uid,s.name,i,{skipSubPath:!0}))}else{const{namespace:r,groupName:s}=n;P.Ny.replace(z.TN.editPageLink("grafana",r.uid,s,{skipSubPath:!0}))}}function Le(){P.Ny.replace((0,z.Mo)(void 0,{skipSubPath:!0}))}},58872:(X,A,a)=>{a.d(A,{P:()=>F});var e=a(74848),f=a(22803),C=a(51898),v=a(92745),T=a(66404),S=a(41654),o=a(16780),P=a(21285),I=a(63142);const F=({title:x,stepNo:G,children:j,fullWidth:L=!1,description:V,switchMode:W})=>{const w=(0,I.of)(D),H=C.Tp.components.AlertRules;return(0,e.jsx)("div",{className:w.parent,"data-testid":H.step(G.toString()),children:(0,e.jsx)(o.n,{className:(0,f.cx)(L&&w.fullWidth),label:(0,e.jsxs)(S.B,{direction:"row",alignItems:"center",justifyContent:"space-between",children:[(0,e.jsxs)(T.E,{variant:"h3",children:[G,". ",x]}),W&&(0,e.jsx)(T.E,{variant:"bodySmall",children:(0,e.jsx)(P.K,{"data-testid":H.stepAdvancedModeSwitch(G.toString()),value:W.isAdvancedMode,onChange:k=>{W.setAdvancedMode(k.currentTarget.checked)},label:(0,v.t)("alerting.rule-editor-section.label-advanced-options","Advanced options"),showLabel:!0,transparent:!0,className:w.reverse})})]}),children:(0,e.jsxs)(S.B,{direction:"column",children:[V&&(0,e.jsx)("div",{className:w.description,children:V}),j]})})})},D=x=>({parent:(0,f.css)({display:"flex",flexDirection:"row",border:`solid 1px ${x.colors.border.weak}`,borderRadius:x.shape.radius.default,padding:`${x.spacing(2)} ${x.spacing(3)}`}),description:(0,f.css)({marginTop:`-${x.spacing(2)}`}),fullWidth:(0,f.css)({width:"100%"}),reverse:(0,f.css)({flexDirection:"row-reverse",gap:x.spacing(1)})})}}]);

//# sourceMappingURL=AlertingGroupEdit.b717b299efa425f51a25.js.map