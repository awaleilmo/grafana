{"version":3,"file":"2311.73e1a2b949d289f5d6c9.js","mappings":"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","sources":["webpack://grafana/./public/app/features/expressions/components/GenAI/sqlPromptConfig.ts","webpack://grafana/./public/app/features/expressions/components/GenAI/GenAISQLSuggestionsButton.tsx"],"sourcesContent":["/**\n * Configuration file for SQL AI prompts used across expression components\n * NOTE: Schema and error context information integration is planned for future implementation\n */\n\nimport { DataQuery } from '@grafana/schema';\n\n// Common SQL context information shared across all prompts\nconst COMMON_SQL_CONTEXT = {\n  engineInfo: 'MySQL dialectic based on dolthub go-mysql-server. The tables are all in memory',\n  refIdExplanation: 'RefIDs (A, B, C, etc.) represent data from other queries',\n  columnInfo: 'value should always be represented as __value__',\n} as const;\n\n// Template placeholders used in prompts\nconst TEMPLATE_PLACEHOLDERS = {\n  refIds: '{refIds}',\n  currentQuery: '{currentQuery}',\n  queryInstruction: '{queryInstruction}',\n  schemaInfo: '{schemaInfo}', // Note: Schema information will be implemented in future updates\n  errorContext: '{errorContext}', // Note: Error context will be implemented in future updates\n  queryContext: '{queryContext}',\n} as const;\n\nexport interface QueryUsageContext {\n  panelId?: string;\n  alerting?: boolean;\n  queries?: DataQuery[];\n  dashboardContext?: {\n    dashboardTitle?: string;\n    panelName?: string;\n  };\n  datasources?: string[];\n  totalRows?: number;\n  requestTime?: number;\n  numberOfQueries?: number;\n  seriesData?: unknown;\n}\n\n/**\n * System prompt for SQL suggestion generation with enhanced context\n */\nconst SQL_SUGGESTION_SYSTEM_PROMPT = `You are a SQL expert for Grafana expressions specializing in time series data analysis.\nIMPORTANT - Current SQL Errors (if any): ${TEMPLATE_PLACEHOLDERS.errorContext}\n\nSQL dialect required by Grafana expressions: ${COMMON_SQL_CONTEXT.engineInfo}\n\nRefIDs context: ${COMMON_SQL_CONTEXT.refIdExplanation}\nGrafana specific context: ${COMMON_SQL_CONTEXT.columnInfo}\n\nAvailable RefIDs to use in composable queries: ${TEMPLATE_PLACEHOLDERS.refIds}\n\nCurrent query to be improved: ${TEMPLATE_PLACEHOLDERS.currentQuery}\n\nSchema information to use in composable queries: ${TEMPLATE_PLACEHOLDERS.schemaInfo}\n\n${TEMPLATE_PLACEHOLDERS.queryContext}\n\nQuery instruction: ${TEMPLATE_PLACEHOLDERS.queryInstruction}\n\nYou may be able to derive schema information from the series data in queryContext.\n\nGiven the above data, help users with their SQL query by:\n- **PRIORITY: If there are errors listed above, focus on fixing them first**\n- Fixing syntax errors using available field and data type information\n- Suggesting optimal queries based on actual data schema and patterns.\n- Look at query context stats: totalRows, requestTime, numberOfQueries, and if it looks like performance should be part of the conversation, suggest optimizing for performance. Note indexing is not supported in Grafana expressions.\n- Leveraging time series patterns and Grafana-specific use cases\n\nGuidelines:\n- Use proper field names and types based on schema information\n- Include LIMIT clauses for performance unless aggregating\n- Consider time-based filtering and grouping for time series data\n- Suggest meaningful aggregations for metric data\n- Use appropriate JOIN conditions when correlating multiple RefIDs\n`;\n\n/**\n * System prompt for SQL explanation generation with enhanced context\n */\nconst SQL_EXPLANATION_SYSTEM_PROMPT = `You are an expert in SQL and Grafana SQL expressions with deep knowledge of time series data.\n\nSQL dialect: ${COMMON_SQL_CONTEXT.engineInfo}\n\nRefIDs: ${COMMON_SQL_CONTEXT.refIdExplanation}\n\nGrafana specific context: ${COMMON_SQL_CONTEXT.columnInfo}\n\nAvailable RefIDs: ${TEMPLATE_PLACEHOLDERS.refIds}\n\nSchema: ${TEMPLATE_PLACEHOLDERS.schemaInfo}\n\n${TEMPLATE_PLACEHOLDERS.queryContext}\n\nExplain SQL queries clearly and concisely, focusing on:\n- What data is being selected and from which RefIDs\n- How the data is being transformed or aggregated\n- The purpose and business meaning of the query using dashboard and panel name from query context if relevant\n- Performance implications and optimization opportunities. Database columns can not be indexed in context of Grafana sql expressions. Don't focus on \n  performance unless the query context has a requestTime or totalRows that looks like it could benefit from it.\n- Time series specific patterns and their significance\n\nProvide a clear explanation of what this SQL query does:`;\n\n/**\n * Generate query context text for prompts\n */\nconst generateQueryContext = (queryContext?: QueryUsageContext): string => {\n  if (!queryContext) {\n    return '';\n  }\n\n  const contextParts = [];\n  if (queryContext.panelId) {\n    contextParts.push(\n      `Panel Type: ${queryContext.panelId}. Please use this to generate suggestions that are relevant to the panel type.`\n    );\n  }\n  if (queryContext.alerting) {\n    contextParts.push(\n      'Context: Alerting rule (focus on boolean/threshold results). Please use this to generate suggestions that are relevant to the alerting rule.'\n    );\n  }\n  if (queryContext.queries) {\n    const queriesText = Array.isArray(queryContext.queries)\n      ? JSON.stringify(queryContext.queries, null, 2)\n      : String(queryContext.queries);\n    contextParts.push(`Queries available to use in the SQL Expression: ${queriesText}`);\n  }\n  if (queryContext.dashboardContext) {\n    const dashboardText =\n      typeof queryContext.dashboardContext === 'object'\n        ? JSON.stringify(queryContext.dashboardContext, null, 2)\n        : String(queryContext.dashboardContext);\n    contextParts.push(`Dashboard context (dashboard title and panel name): ${dashboardText}`);\n  }\n  if (queryContext.datasources) {\n    const datasourcesText = Array.isArray(queryContext.datasources)\n      ? JSON.stringify(queryContext.datasources, null, 2)\n      : String(queryContext.datasources);\n    contextParts.push(`Datasources available to use in the SQL Expression: ${datasourcesText}`);\n  }\n  if (queryContext.totalRows) {\n    contextParts.push(`Total rows in the query: ${queryContext.totalRows}`);\n  }\n  if (queryContext.requestTime) {\n    contextParts.push(`Request time: ${queryContext.requestTime}`);\n  }\n  if (queryContext.numberOfQueries) {\n    contextParts.push(`Number of queries: ${queryContext.numberOfQueries}`);\n  }\n  if (queryContext.seriesData) {\n    const seriesDataText =\n      typeof queryContext.seriesData === 'object'\n        ? JSON.stringify(queryContext.seriesData, null, 2)\n        : String(queryContext.seriesData);\n    contextParts.push(`Series data: ${seriesDataText}`);\n  }\n\n  return contextParts.length\n    ? `Query Context:\n${contextParts.join('\\n')}`\n    : '';\n};\n\n/**\n * Enhanced interface for prompt generation variables\n */\nexport interface SQLPromptVariables {\n  refIds: string;\n  currentQuery: string;\n  queryInstruction: string;\n  schemas?: unknown; // Reserved for future schema implementation\n  errorContext?: string[];\n  queryContext?: QueryUsageContext;\n}\n\n/**\n * Generate the complete system prompt for SQL suggestions with enhanced context\n *\n * Note: Schema information integration is planned for future implementation\n */\nexport const getSQLSuggestionSystemPrompt = (variables: SQLPromptVariables): string => {\n  const queryContext = generateQueryContext(variables.queryContext);\n  const schemaInfo = ''; // Placeholder for future schema information\n  const errorContext = variables.errorContext?.length\n    ? variables.errorContext.join('\\n')\n    : 'No current errors detected.';\n\n  return SQL_SUGGESTION_SYSTEM_PROMPT.replaceAll(TEMPLATE_PLACEHOLDERS.refIds, variables.refIds)\n    .replaceAll(TEMPLATE_PLACEHOLDERS.currentQuery, variables.currentQuery)\n    .replaceAll(TEMPLATE_PLACEHOLDERS.queryInstruction, variables.queryInstruction)\n    .replaceAll(TEMPLATE_PLACEHOLDERS.schemaInfo, schemaInfo)\n    .replaceAll(TEMPLATE_PLACEHOLDERS.errorContext, errorContext)\n    .replaceAll(TEMPLATE_PLACEHOLDERS.queryContext, queryContext);\n};\n\n/**\n * Generate the complete system prompt for SQL explanations with enhanced context\n */\nexport const getSQLExplanationSystemPrompt = (variables: Omit<SQLPromptVariables, 'queryInstruction'>): string => {\n  const queryContext = generateQueryContext(variables.queryContext);\n\n  const schemaInfo = ''; // Placeholder for future schema information\n\n  return SQL_EXPLANATION_SYSTEM_PROMPT.replaceAll(TEMPLATE_PLACEHOLDERS.refIds, variables.refIds)\n    .replaceAll(TEMPLATE_PLACEHOLDERS.schemaInfo, schemaInfo)\n    .replaceAll(TEMPLATE_PLACEHOLDERS.queryContext, queryContext);\n};\n","import { useCallback } from 'react';\n\nimport { t } from '@grafana/i18n';\n\nimport { GenAIButton } from '../../../dashboard/components/GenAI/GenAIButton';\nimport { EventTrackingSrc } from '../../../dashboard/components/GenAI/tracking';\nimport { Message, Role } from '../../../dashboard/components/GenAI/utils';\n\nimport { getSQLSuggestionSystemPrompt, QueryUsageContext } from './sqlPromptConfig';\n\ninterface GenAISQLSuggestionsButtonProps {\n  currentQuery: string;\n  onGenerate: (suggestion: string) => void;\n  onHistoryUpdate?: (history: string[]) => void;\n  refIds: string[];\n  initialQuery: string;\n  schemas?: unknown; // Reserved for future schema implementation\n  errorContext?: string[];\n  queryContext?: QueryUsageContext;\n}\n\n// AI prompts for different SQL use cases\n\nconst getContextualPrompts = (refIds: string[], currentQuery: string): string[] => {\n  const trimmedQuery = currentQuery.trim();\n\n  // If there's a current query, focus more on fixing/improving it\n  if (trimmedQuery) {\n    return [`Improve, fix syntax errors, or optimize this SQL query: ${trimmedQuery}`];\n  }\n\n  // If no current query, focus on suggestions\n  return [\n    `Join, aggregate, filter, calculate percentiles, create time-based \n    window functions, or generally just make common SQL pattern queries for data from ${refIds.join(', ')}`,\n  ];\n};\n\n/**\n * Creates messages for the LLM to generate SQL suggestions\n *\n * @param refIds - The list of RefIDs available in the current context\n * @param currentQuery - The current SQL query being edited\n * @param schemas - Optional schema information (planned for future implementation)\n * @param errorContext - Optional error context for targeted fixes (planned for future implementation)\n * @param queryContext - Optional query usage context\n * @returns A list of messages to be sent to the LLM for generating SQL suggestions\n */\nconst getSQLSuggestionMessages = (\n  refIds: string[],\n  currentQuery: string,\n  schemas?: unknown,\n  errorContext?: string[],\n  queryContext?: QueryUsageContext\n): Message[] => {\n  const trimmedQuery = currentQuery.trim();\n  const queryInstruction = trimmedQuery\n    ? 'Focus on fixing, improving, or enhancing the current query provided above.'\n    : 'Generate a new SQL query based on the available RefIDs and common use cases.';\n\n  const systemPrompt = getSQLSuggestionSystemPrompt({\n    refIds: refIds.length > 0 ? refIds.join(', ') : 'A',\n    currentQuery: trimmedQuery || 'No current query provided',\n    queryInstruction: queryInstruction,\n    schemas, // Will be utilized once schema extraction is implemented\n    errorContext,\n    queryContext,\n  });\n\n  const contextualPrompts = getContextualPrompts(refIds, currentQuery);\n  const selectedPrompt = contextualPrompts[Math.floor(Math.random() * contextualPrompts.length)];\n\n  return [\n    {\n      role: Role.system,\n      content: systemPrompt,\n    },\n    {\n      role: Role.user,\n      content: selectedPrompt,\n    },\n  ];\n};\n\nexport const GenAISQLSuggestionsButton = ({\n  currentQuery,\n  onGenerate,\n  onHistoryUpdate,\n  refIds,\n  initialQuery,\n  schemas, // Future implementation will use this for enhanced context\n  errorContext,\n  queryContext,\n}: GenAISQLSuggestionsButtonProps) => {\n  const messages = useCallback(() => {\n    return getSQLSuggestionMessages(refIds, currentQuery, schemas, errorContext, queryContext);\n  }, [refIds, currentQuery, schemas, errorContext, queryContext]);\n\n  const text = !currentQuery || currentQuery === initialQuery ? 'Generate suggestion' : 'Improve query';\n\n  return (\n    <GenAIButton\n      disabled={refIds.length === 0}\n      eventTrackingSrc={EventTrackingSrc.sqlExpressions}\n      messages={messages}\n      onGenerate={onGenerate}\n      onHistoryChange={onHistoryUpdate}\n      temperature={0.3}\n      text={t('sql-expressions.sql-ai-interaction', `{{text}}`, { text })}\n      timeout={60000} // 60 seconds\n      toggleTipTitle={t('sql-expressions.ai-suggestions-title', 'AI-powered SQL expression suggestions')}\n      tooltip={\n        refIds.length === 0\n          ? t('sql-expressions.add-query-tooltip', 'Add at least one data query to generate SQL suggestions')\n          : t(\n              'expressions.sql-expr.tooltip-experimental',\n              'SQL Expressions LLM integration is experimental. Please report any issues to the Grafana team.'\n            )\n      }\n    />\n  );\n};\n"],"names":["COMMON_SQL_CONTEXT","TEMPLATE_PLACEHOLDERS","SQL_SUGGESTION_SYSTEM_PROMPT","SQL_EXPLANATION_SYSTEM_PROMPT","generateQueryContext","queryContext","contextParts","queriesText","dashboardText","datasourcesText","seriesDataText","getSQLSuggestionSystemPrompt","variables","schemaInfo","errorContext","getSQLExplanationSystemPrompt","getContextualPrompts","refIds","currentQuery","trimmedQuery","getSQLSuggestionMessages","schemas","queryInstruction","systemPrompt","contextualPrompts","selectedPrompt","GenAISQLSuggestionsButton","onGenerate","onHistoryUpdate","initialQuery","messages","text"],"sourceRoot":""}