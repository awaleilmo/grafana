"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9404],{20301:(we,te,h)=>{h.d(te,{Z:()=>b});var ce=h(22803),z=h(96540),n=h(45861),m=h(63142);const b=({className:_,...F})=>{const K=(0,m.of)(I);return z.createElement(n.$n,{...F,className:(0,ce.cx)(_,K.button)})},I=_=>({button:(0,ce.css)({paddingLeft:_.spacing(3/2),paddingRight:_.spacing(3/2)})})},21965:(we,te,h)=>{h.r(te),h.d(te,{plugin:()=>Os});var ce=h(94644),z=h(43173),n=h(74848),m=h(2543),b=h(96540),I=h(48480),_=h(16780),F=h(37386),K=h(18857),ee=h(34999),fe=h(89640),g=h(96004),x=h(18027),C=h(63527);const H="Direct browser access in the InfluxDB datasource is no longer available. Switch to server access mode.",U="default";var d=(t=>(t.InfluxQL="InfluxQL",t.Flux="Flux",t.SQL="SQL",t))(d||{}),N=h(97095),M=h(48767);const k=20;var A=h(27489);const jt=t=>{(0,A.rR)("influxdb-configv1-query-language-dropdown",t)},At=()=>{(0,A.rR)("influxdb-configv1-flux-dbdetails-organization-input-field")},wt=()=>{(0,A.rR)("influxdb-configv1-flux-dbdetails-token-input-field")},Lt=()=>{(0,A.rR)("influxdb-configv1-flux-dbdetails-default-bucket-input-field")},Rt=()=>{(0,A.rR)("influxdb-configv1-influxql-dbdetails-database-input-field")},Ot=()=>{(0,A.rR)("influxdb-configv1-influxql-dbdetails-user-input-field")},Ft=()=>{(0,A.rR)("influxdb-configv1-influxql-dbdetails-password-input-field")},Nt=()=>{(0,A.rR)("influxdb-configv1-sql-dbdetails-database-input-field")},Bt=()=>{(0,A.rR)("influxdb-configv1-sql-dbdetails-token-input-field")},Pt=t=>{const{options:{jsonData:e,secureJsonData:a,secureJsonFields:s}}=t,r=(0,m.uniqueId)("influxdb-flux-config");return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(N.C,{children:(0,n.jsx)(x.I,{labelWidth:k,label:"Organization",htmlFor:`${r}-org`,children:(0,n.jsx)(C.p,{id:`${r}-org`,className:"width-20",value:e.organization||"",onChange:(0,I.PG)(t,"organization"),onBlur:At})})}),(0,n.jsx)(N.C,{children:(0,n.jsx)(x.I,{labelWidth:k,label:"Token",children:(0,n.jsx)(M.L4,{isConfigured:!!(s&&s.token),value:a?.token||"",label:"Token","aria-label":"Token",className:"width-20",onReset:()=>(0,I.QP)(t,"token"),onChange:(0,I.mn)(t,"token"),onBlur:wt})})}),(0,n.jsx)(N.C,{children:(0,n.jsx)(x.I,{labelWidth:k,label:"Default Bucket",children:(0,n.jsx)(C.p,{className:"width-20",placeholder:"default bucket",value:e.defaultBucket||"",onChange:(0,I.PG)(t,"defaultBucket"),onBlur:Lt})})}),(0,n.jsx)(N.C,{children:(0,n.jsx)(x.I,{labelWidth:k,label:"Min time interval",tooltip:`A lower limit for the auto group by time interval. Recommended to be set to write frequency,
				for example 1m if your data is written every minute.`,children:(0,n.jsx)(C.p,{className:"width-20",placeholder:"10s",value:e.timeInterval||"",onChange:(0,I.PG)(t,"timeInterval")})})})]})};var j=h(22803),Y=h(63142),W=h(79233);const ze=[{label:"GET",value:"GET"},{label:"POST",value:"POST"}],Ke=t=>{const{options:e,onOptionsChange:a}=t,{database:s,jsonData:r,secureJsonData:i,secureJsonFields:o}=e,l=(0,Y.of)(Mt),u=(0,m.uniqueId)("influxdb-influxql-config");return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(ee.F,{severity:"info",title:"Database Access",children:(0,n.jsxs)("p",{children:["Setting the database for this datasource does not deny access to other databases. The InfluxDB query syntax allows switching the database in the query. For example:",(0,n.jsx)("code",{children:"SHOW MEASUREMENTS ON _internal"})," or",(0,n.jsx)("code",{children:'SELECT * FROM "_internal".."database" LIMIT 10'}),(0,n.jsx)("br",{}),(0,n.jsx)("br",{}),"To support data isolation and security, make sure appropriate permissions are configured in InfluxDB."]})}),(0,n.jsx)(F.D,{horizontal:!0,label:(0,n.jsx)(W.c,{width:k,children:"Database"}),className:l.horizontalField,htmlFor:`${u}-db`,noMargin:!0,children:(0,n.jsx)(C.p,{id:`${u}-db`,className:"width-20",value:r.dbName??s,onChange:c=>{a({...e,database:"",jsonData:{...r,dbName:c.currentTarget.value}})},onBlur:Rt})}),(0,n.jsx)(F.D,{horizontal:!0,label:(0,n.jsx)(W.c,{width:k,children:"User"}),className:l.horizontalField,htmlFor:`${u}-user`,noMargin:!0,children:(0,n.jsx)(C.p,{id:`${u}-user`,className:"width-20",value:e.user||"",onChange:(0,I.zX)(t,"user"),onBlur:Ot})}),(0,n.jsx)(F.D,{horizontal:!0,label:(0,n.jsx)(W.c,{width:k,children:"Password"}),className:l.horizontalField,noMargin:!0,children:(0,n.jsx)(M.L4,{isConfigured:!!(o&&o.password),value:i?.password||"",label:"Password","aria-label":"Password",className:"width-20",onReset:()=>(0,I.QP)(t,"password"),onChange:(0,I.mn)(t,"password"),onBlur:Ft})}),(0,n.jsx)(F.D,{horizontal:!0,label:(0,n.jsx)(W.c,{width:k,tooltip:`You can use either GET or POST HTTP method to query your InfluxDB database. The POST
          method allows you to perform heavy requests (with a lots of WHERE clause) while the GET method
          will restrict you and return an error if the query is too large.`,children:"HTTP Method"}),htmlFor:`${u}-http-method`,className:l.horizontalField,noMargin:!0,children:(0,n.jsx)(K.l6,{inputId:`${u}-http-method`,className:"width-20",value:ze.find(c=>c.value===e.jsonData.httpMode),options:ze,defaultValue:e.jsonData.httpMode,onChange:(0,I.BD)(t,"httpMode")})}),(0,n.jsx)(F.D,{horizontal:!0,label:(0,n.jsx)(W.c,{width:k,tooltip:"A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example 1m if your data is written every minute.",children:"Min time interval"}),className:l.horizontalField,noMargin:!0,children:(0,n.jsx)(C.p,{className:"width-20",placeholder:"10s",value:e.jsonData.timeInterval||"",onChange:(0,I.PG)(t,"timeInterval")})}),(0,n.jsx)(F.D,{horizontal:!0,label:(0,n.jsx)(W.c,{width:k,tooltip:"This time range is used in the query editor's autocomplete to reduce the execution time of tag filter queries.",children:"Autocomplete range"}),className:l.horizontalField,noMargin:!0,children:(0,n.jsx)(C.p,{className:"width-20",placeholder:"12h",value:e.jsonData.showTagTime||"",onChange:(0,I.PG)(t,"showTagTime")})})]})},Mt=t=>({horizontalField:(0,j.css)({justifyContent:"initial",margin:`0 ${t.spacing(.5)} ${t.spacing(.5)} 0`})});var oe=h(21285);const kt=t=>{const{options:e,onOptionsChange:a}=t,{jsonData:s,secureJsonData:r,secureJsonFields:i}=e,o=(0,Y.of)(Qt),l=(0,m.uniqueId)("influxdb-sql-config");return(0,n.jsxs)("div",{children:[(0,n.jsx)(F.D,{horizontal:!0,label:(0,n.jsx)(W.c,{width:k,children:"Database"}),className:o.horizontalField,htmlFor:`${l}-dbName`,children:(0,n.jsx)(C.p,{id:`${l}-dbName`,className:"width-20","aria-label":"Database or bucket name",value:s.dbName,onChange:u=>{a({...e,jsonData:{...s,dbName:u.currentTarget.value}})},onBlur:Nt})}),(0,n.jsx)(F.D,{horizontal:!0,label:(0,n.jsx)(W.c,{width:k,children:"Token"}),className:o.horizontalField,children:(0,n.jsx)(M.L4,{label:"Token","aria-label":"Token",className:"width-20",value:r?.token||"",onReset:()=>(0,I.QP)(t,"token"),onChange:(0,I.mn)(t,"token"),isConfigured:!!(i&&i.token),onBlur:Bt})}),(0,n.jsx)(F.D,{horizontal:!0,label:(0,n.jsx)(W.c,{width:k,children:"Insecure Connection"}),className:o.horizontalField,children:(0,n.jsx)(oe.K,{id:`${l}-insecure-grpc`,value:s.insecureGrpc??!1,onChange:u=>{a({...e,jsonData:{...s,insecureGrpc:u.currentTarget.checked}})}})})]})},Qt=t=>({horizontalField:(0,j.css)({justifyContent:"initial",margin:`0 ${t.spacing(.5)} ${t.spacing(.5)} 0`})}),ge={[d.InfluxQL]:{label:"InfluxQL",value:d.InfluxQL,description:"The InfluxDB SQL-like query language."},[d.SQL]:{label:"SQL",value:d.SQL,description:"Native SQL language. Supported in InfluxDB 3.0"},[d.Flux]:{label:"Flux",value:d.Flux,description:"Supported in InfluxDB 2.x and 1.8+"}},Ut=[ge[d.InfluxQL],ge[d.SQL],ge[d.Flux]];class Wt extends b.PureComponent{constructor(e){super(e),this.state={maxSeries:""},this.versionNotice={Flux:"Support for Flux in Grafana is currently in beta",SQL:"Support for SQL in Grafana is currently in alpha"},this.onVersionChanged=a=>{const{options:s,onOptionsChange:r}=this.props;a.value&&jt({version:a.value});const i={...s,jsonData:{...s.jsonData,version:a.value}};if(a.value===d.Flux){i.access="proxy",i.basicAuth=!0,i.jsonData.httpMode="POST";const{user:o,database:l,...u}=i;r(u)}else r(i)},this.state.maxSeries=e.options.jsonData.maxSeries?.toString()||"",this.htmlPrefix=(0,m.uniqueId)("influxdb-config")}renderJsonDataOptions(){switch(this.props.options.jsonData.version){case d.InfluxQL:return(0,n.jsx)(Ke,{...this.props});case d.Flux:return(0,n.jsx)(Pt,{...this.props});case d.SQL:return(0,n.jsx)(kt,{...this.props});default:return(0,n.jsx)(Ke,{...this.props})}}render(){const{options:e,onOptionsChange:a}=this.props,s=e.access==="direct";return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(_.n,{children:[(0,n.jsx)("h3",{className:"page-heading",children:"Query language"}),(0,n.jsx)(F.D,{children:(0,n.jsx)(K.l6,{"aria-label":"Query language",className:"width-30",value:ge[e.jsonData.version??d.InfluxQL],options:Ut,defaultValue:ge[d.InfluxQL],onChange:this.onVersionChanged})})]}),e.jsonData.version!==d.InfluxQL&&(0,n.jsx)(ee.F,{severity:"info",title:this.versionNotice[e.jsonData.version],children:(0,n.jsxs)("p",{children:["Please report any issues to: ",(0,n.jsx)("br",{}),(0,n.jsx)(fe.Y,{href:"https://github.com/grafana/grafana/issues/new/choose",external:!0,children:"https://github.com/grafana/grafana/issues"})]})}),s&&(0,n.jsx)(ee.F,{title:"Error",severity:"error",children:H}),(0,n.jsx)(g.t,{showAccessOptions:s,dataSourceConfig:e,defaultUrl:"http://localhost:8086",onChange:a,secureSocksDSProxyEnabled:z.$.secureSocksDSProxyEnabled}),(0,n.jsxs)(_.n,{children:[(0,n.jsx)("h3",{className:"page-heading",children:"InfluxDB Details"}),this.renderJsonDataOptions(),(0,n.jsx)(x.I,{labelWidth:20,label:"Max series",tooltip:"Limit the number of series/tables that Grafana will process. Lower this number to prevent abuse, and increase it if you have lots of small time series and not all are shown. Defaults to 1000.",children:(0,n.jsx)(C.p,{placeholder:"1000",type:"number",className:"width-20",value:this.state.maxSeries,onChange:r=>{this.setState({maxSeries:r.currentTarget.value});const i=parseInt(r.currentTarget.value,10);(0,I.lO)(this.props,"maxSeries",Number.isFinite(i)?i:void 0)}})})]})]})}}const Fs=null;var G=h(41654),L=h(31286),ae=h(66404),Ye=h(74475),Ce=h(35137),Le=h(43243),Je=h(51898),Q=h(70985);const Xe=[{label:"Enabled",value:!0},{label:"Disabled",value:!1}],Vt=[{label:"No Authentication",value:Q.q.NoAuth},{label:"Basic Authentication",value:Q.q.BasicAuth},{label:"Forward OAuth Identity",value:Q.q.OAuthForward}],le=[{label:"URL and authentication",id:"url",isOpen:!0},{label:"Database settings",id:"tls",isOpen:!0},{label:"Save & test",id:`${Je.Tp.pages.DataSource.saveAndTest}`,isOpen:!0}],$t=[{label:"URL and authentication",id:"url",isOpen:!0},{label:"Database settings",id:"tls",isOpen:!0},{label:"Private data source connect",id:"pdc",isOpen:!0},{label:"Save & test",id:`${Je.Tp.pages.DataSource.saveAndTest}`,isOpen:!0}],Ze=[{label:"POST",value:"POST"},{label:"GET",value:"GET"}],Re=(t,e=!1,a)=>({label:(0,j.css)({display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0,padding:t.spacing(0,1),fontWeight:t.typography.fontWeightMedium,fontSize:t.typography.size.md,backgroundColor:e?"transparent":t.colors.background.secondary,height:t.spacing(t.components.height.md),lineHeight:t.spacing(t.components.height.md),marginRight:t.spacing(.5),borderRadius:t.shape.radius.default,border:"none",width:"220px",color:t.colors.text.primary})}),V=18,Oe="450px",Gt=()=>{(0,A.rR)("influxdb-config-v2-feedback-button-clicked")},Ht=()=>{(0,A.rR)("influxdb-config-v2-url-input-field")},qt=t=>{(0,A.rR)("influxdb-config-v2-query-language-dropdown",t)},zt=t=>{(0,A.rR)("influxdb-config-v2-product-selection-dropdown",t)},Kt=()=>{(0,A.rR)("influxdb-config-v2-flux-dbdetails-org-input-field")},Yt=()=>{(0,A.rR)("influxdb-config-v2-flux-dbdetails-default-bucket-input-field")},Jt=()=>{(0,A.rR)("influxdb-config-v2-flux-dbdetails-token-input-field")},Xt=()=>{(0,A.rR)("influxdb-config-v2-influxql-dbdetails-database-input-field")},Zt=()=>{(0,A.rR)("influxdb-config-v2-influxql-dbdetails-user-input-field")},_t=()=>{(0,A.rR)("influxdb-config-v2-influxql-dbdetails-password-input-field")},ea=()=>{(0,A.rR)("influxdb-config-v2-sql-dbdetails-database-input-field")},ta=()=>{(0,A.rR)("influxdb-config-v2-sql-dbdetails-token-input-field")},aa=()=>{(0,A.rR)("influxdb-config-v2-advanceddb-settings-toggle-clicked")},na=()=>{(0,A.rR)("influxdb-config-v2-advanceddb-settings-http-method-clicked")},sa=()=>{(0,A.rR)("influxdb-config-v2-advanceddb-settings-insecure-connection-clicked")},ra=()=>{(0,A.rR)("influxdb-config-v2-advanceddb-settings-min-time-clicked")},ia=()=>{(0,A.rR)("influxdb-config-v2-advanceddb-settings-autocomplete-range-clicked")},oa=()=>{(0,A.rR)("influxdb-config-v2-advanceddb-settings-max-series-clicked")},la=()=>{(0,A.rR)("influxdb-config-v2-advanced-http-settings-toggle-clicked")},ua=()=>{(0,A.rR)("influxdb-config-v2-advanced-http-settings-timeout-field")},ca=()=>{(0,A.rR)("influxdb-config-v2-auth-settings-toggle-clicked")},da=t=>{(0,A.rR)("influxdb-config-v2-advanced-http-settings-timeout-field",t)},ha=t=>{const{options:e}=t,a=(0,Y.of)(Re),[s,r]=(0,b.useState)(e.jsonData.maxSeries?.toString()||""),[i,o]=(0,b.useState)(()=>!!e.jsonData.timeInterval||!!e.jsonData.insecureGrpc||!!e.jsonData.maxSeries),l=u=>{r(u.currentTarget.value);const c=parseInt(u.currentTarget.value,10);(0,I.lO)(t,"maxSeries",Number.isFinite(c)?c:void 0)};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(Ce.$,{v:2}),(0,n.jsx)(x.I,{label:(0,n.jsx)("div",{className:(0,j.cx)(a.label),children:"Advanced Database Settings"}),labelWidth:40,children:(0,n.jsx)(oe.K,{"data-testid":"influxdb-v2-config-toggle-switch",value:i,onChange:()=>o(!i),onBlur:aa})}),i&&(0,n.jsxs)(n.Fragment,{children:[e.jsonData.version===d.InfluxQL&&(0,n.jsx)(N.C,{children:(0,n.jsx)(x.I,{label:"HTTP Method",labelWidth:V,tooltip:`You can use either GET or POST HTTP method to query your InfluxDB database. The POST
                        method allows you to perform heavy requests (with a lots of WHERE clause) while the GET method
                        will restrict you and return an error if the query is too large.`,grow:!0,children:(0,n.jsx)(Le.G,{value:Ze.find(u=>u.value===e.jsonData.httpMode),options:Ze,onChange:(0,I.BD)(t,"httpMode"),onBlur:na,"data-testid":"influxdb-v2-config-http-method-select"})})}),(e.jsonData.version===d.InfluxQL||e.jsonData.version===d.Flux)&&(0,n.jsx)(N.C,{children:(0,n.jsx)(x.I,{label:"Min time interval",labelWidth:V,tooltip:"A lower limit for the auto group by time interval. Recommended to be set to write frequency, for example 1m if your data is written every minute.",grow:!0,children:(0,n.jsx)(C.p,{"data-testid":"influxdb-v2-config-time-interval",onBlur:ra,onChange:(0,I.PG)(t,"timeInterval"),placeholder:"10s",value:e.jsonData.timeInterval||""})})}),e.jsonData.version===d.InfluxQL&&(0,n.jsx)(N.C,{children:(0,n.jsx)(x.I,{label:"Autocomplete Range",labelWidth:V,tooltip:"This time range is used in the query editor's autocomplete to reduce the execution time of tag filter queries.",grow:!0,children:(0,n.jsx)(C.p,{"data-testid":"influxdb-v2-config-autocomplete-range",onBlur:ia,onChange:(0,I.PG)(t,"showTagTime"),placeholder:"12h",value:e.jsonData.showTagTime||""})})}),(0,n.jsx)(N.C,{children:(0,n.jsx)(x.I,{label:"Max series",labelWidth:V,tooltip:"Limit the number of series/tables that Grafana will process. Lower this number to prevent abuse, and increase it if you have lots of small time series and not all are shown. Defaults to 1000.",grow:!0,children:(0,n.jsx)(C.p,{"data-testid":"influxdb-v2-config-max-series",onBlur:oa,onChange:l,placeholder:"1000",value:s,type:"number"})})}),e.jsonData.version===d.SQL&&(0,n.jsx)(N.C,{children:(0,n.jsx)(x.I,{label:"Insecure Connection",labelWidth:V,grow:!0,children:(0,n.jsx)(oe.K,{"data-testid":"influxdb-v2-config-insecure-switch",value:e.jsonData.insecureGrpc??!1,onChange:(0,I.EX)(t,"insecureGrpc"),onBlur:sa})})})]})]})},fa=t=>{const{options:{jsonData:e,secureJsonData:a,secureJsonFields:s}}=t;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(N.C,{children:(0,n.jsx)(x.I,{label:"Organization",labelWidth:V,grow:!0,required:!0,children:(0,n.jsx)(C.p,{id:"organization",placeholder:"myorg",onBlur:Kt,onChange:(0,I.PG)(t,"organization"),value:e.organization||""})})}),(0,n.jsx)(N.C,{children:(0,n.jsx)(x.I,{labelWidth:V,label:"Default Bucket",grow:!0,required:!0,children:(0,n.jsx)(C.p,{id:"default-bucket",onBlur:Yt,onChange:(0,I.PG)(t,"defaultBucket"),placeholder:"mybucket",value:e.defaultBucket||""})})}),(0,n.jsx)(N.C,{children:(0,n.jsx)(x.I,{labelWidth:V,label:"Token",grow:!0,required:!0,children:(0,n.jsx)(M.L4,{id:"token",isConfigured:!!(s&&s.token),onBlur:Jt,onChange:(0,I.mn)(t,"token"),onReset:()=>(0,I.QP)(t,"token"),value:a?.token||""})})})]})},ga=t=>{const{options:e}=t;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(N.C,{children:(0,n.jsx)(x.I,{label:"Database",labelWidth:V,grow:!0,required:!0,children:(0,n.jsx)(C.p,{id:"database",placeholder:"mydb",value:e.jsonData.dbName,onChange:(0,I.PG)(t,"dbName"),onBlur:Xt})})}),(0,n.jsx)(N.C,{children:(0,n.jsx)(x.I,{label:"User",labelWidth:V,grow:!0,required:!0,children:(0,n.jsx)(C.p,{id:"user",placeholder:"myuser",value:e.user||"",onChange:(0,I.zX)(t,"user"),onBlur:Zt})})}),(0,n.jsx)(N.C,{children:(0,n.jsx)(x.I,{label:"Password",labelWidth:V,tooltip:"Enter the token used to query the database. You can find this on the Tokens page in the InfluxDB UI.",grow:!0,required:!0,children:(0,n.jsx)(M.L4,{id:"password",isConfigured:!!(e.secureJsonFields&&e.secureJsonFields.password),value:e.secureJsonData?.password||"",onReset:()=>(0,I.QP)(t,"password"),onChange:(0,I.mn)(t,"password"),onBlur:_t})})})]})},ma=t=>{const{options:e}=t,{secureJsonData:a,secureJsonFields:s}=e;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(N.C,{children:(0,n.jsx)(x.I,{label:"Database",labelWidth:V,grow:!0,required:!0,children:(0,n.jsx)(C.p,{id:"database",placeholder:"mydb",value:e.jsonData.dbName,onChange:(0,I.PG)(t,"dbName"),onBlur:ea})})}),(0,n.jsx)(N.C,{children:(0,n.jsx)(x.I,{labelWidth:V,label:"Token",grow:!0,required:!0,children:(0,n.jsx)(M.L4,{id:"token",isConfigured:!!(s&&s.token),onBlur:ta,onChange:(0,I.mn)(t,"token"),onReset:()=>(0,I.QP)(t,"token"),value:a?.token||""})})})]})},pa=({options:t,onOptionsChange:e})=>(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(L.a,{borderStyle:"solid",borderColor:"weak",padding:2,marginBottom:4,id:`${le[1].id}`,minWidth:Oe,children:(0,n.jsxs)(Ye.M,{label:(0,n.jsxs)(ae.E,{element:"h3",children:["2. ",le[1].label]}),isOpen:le[1].isOpen,children:[!t.jsonData.version&&(0,n.jsx)(ee.F,{severity:"info",title:"Query language required",children:(0,n.jsx)("p",{children:"To view connection settings, first choose a query language in the URL and Connection section."})}),t.jsonData.version===d.InfluxQL&&(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(ee.F,{severity:"info",title:"Database Access",children:(0,n.jsx)("p",{children:"Setting the database for this datasource does not deny access to other databases. The InfluxDB query syntax allows switching the database in the query. To support data isolation and security, make sure appropriate permissions are configured in InfluxDB."})})}),t.jsonData.version&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(ae.E,{color:"secondary",children:"Provide the necessary database connection details based on your selected InfluxDB product and query language."}),(0,n.jsx)(Ce.$,{v:2})]}),(0,n.jsxs)(n.Fragment,{children:[t.jsonData.version===d.InfluxQL&&(0,n.jsx)(ga,{options:t,onOptionsChange:e}),t.jsonData.version===d.Flux&&(0,n.jsx)(fa,{options:t,onOptionsChange:e}),t.jsonData.version===d.SQL&&(0,n.jsx)(ma,{options:t,onOptionsChange:e}),t.jsonData.version&&(0,n.jsx)(ha,{options:t,onOptionsChange:e})]})]})})});var me=h(45861);const xa=({pdcInjected:t})=>{const e=t?$t:le;return(0,n.jsx)(G.B,{children:(0,n.jsxs)(L.a,{flex:1,marginY:10,children:[(0,n.jsx)(L.a,{height:"75px"}),(0,n.jsx)(ae.E,{element:"h4",children:"InfluxDB"}),(0,n.jsx)(L.a,{paddingTop:2,children:e.map((a,s)=>(0,n.jsxs)("div",{"data-testid":`${a.label}-sidebar`,children:[(0,n.jsx)(x.I,{label:`${s+1}`,style:{display:"flex",alignItems:"center"},grow:!0,children:(0,n.jsx)(me.z9,{variant:"secondary",fill:"text",onClick:r=>{r.preventDefault();const i=document.getElementById(a.id);i&&i.scrollIntoView({behavior:"smooth",block:"start"})},children:a.label})}),(0,n.jsx)(Ce.$,{v:1})]},s))})]})})};var ya=h(10928),va=h(55803);const Sa=({options:t,onOptionsChange:e})=>{const a=(0,Y.of)(Re),[s,r]=(0,b.useState)(()=>{const i=Object.keys(t.jsonData);return"keepCookies"in t.jsonData||"timeout"in t.jsonData||i.some(o=>o.includes("httpHeaderName"))});return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(L.a,{display:"flex",alignItems:"center",children:(0,n.jsx)(x.I,{label:(0,n.jsx)("div",{className:(0,j.cx)(a.label),children:"Advanced HTTP Settings"}),labelWidth:40,children:(0,n.jsx)(oe.K,{"data-testid":"influxdb-v2-config-advanced-http-settings-toggle",value:s,onChange:()=>r(!s),onBlur:la})})}),s&&t.access==="proxy"&&(0,n.jsx)(n.Fragment,{children:(0,n.jsxs)(L.a,{paddingLeft:1,marginY:1,children:[(0,n.jsx)(L.a,{width:"50%",marginBottom:2,children:(0,n.jsx)(F.D,{label:"Allowed cookies",description:`Grafana proxy deletes forwarded cookies by default. Specify cookies by name that should
                be forwarded to the data source.`,disabled:t.readOnly,noMargin:!0,children:(0,n.jsx)(ya.u,{id:"advanced-http-cookies",placeholder:"New cookie (hit enter to add)",tags:"keepCookies"in t.jsonData&&Array.isArray(t.jsonData.keepCookies)?t.jsonData.keepCookies:[],onChange:i=>{e({...t,jsonData:{...t.jsonData,keepCookies:i}})}})})}),(0,n.jsx)(L.a,{width:"50%",marginBottom:2,children:(0,n.jsx)(F.D,{htmlFor:"advanced-http-timeout",label:"Timeout",description:"HTTP request timeout in seconds.",disabled:t.readOnly,noMargin:!0,children:(0,n.jsx)(C.p,{id:"advanced-http-timeout",type:"number",min:0,placeholder:"Timeout in seconds","aria-label":"Timeout in seconds",value:"timeout"in t.jsonData&&typeof t.jsonData.timeout=="number"?t.jsonData.timeout.toString():"",onChange:i=>{const o=parseInt(i.currentTarget.value,10);e({...t,jsonData:{...t.jsonData,timeout:o}})},onBlur:ua})})}),s&&(0,n.jsx)(va.P,{dataSourceConfig:t,onChange:e})]})})]})};var Ta=h(52908),Ca=h(76229),Fe=h(77824),_e=h(72636),Ne=h(45558);const ba=t=>{const{options:e,onOptionsChange:a}=t,s=(0,Y.of)(Re),{width:r}=(0,Ta.A)(),i=(0,b.useMemo)(()=>(0,Ca.pe)({config:e,onChange:a}),[e,a]),o=T=>T===Q.q.NoAuth||T===Q.q.BasicAuth||T===Q.q.OAuthForward,[l,u]=(0,b.useState)({noAuth:(!e.basicAuth&&!e.jsonData.oauthPassThru)??!1,basicAuth:e.basicAuth??!1,tlsClientAuth:i.TLS?.TLSClientAuth.enabled??!1,caCert:i.TLS?.selfSignedCertificate.enabled??!1,skipTLS:i.TLS?.skipTLSVerification.enabled??!1,oAuthForward:e.jsonData.oauthPassThru??!1,withCredentials:e.withCredentials??!1}),c=(0,b.useMemo)(()=>{if(o(i.selectedMethod)&&i.selectedMethod!==Q.q.CrossSiteCredentials)return i.selectedMethod;switch(!!l){case l.basicAuth:return Q.q.BasicAuth;case l.oAuthForward:return Q.q.OAuthForward;case l.noAuth:return Q.q.NoAuth;default:return}},[i.selectedMethod,l]),[p,f]=(0,b.useState)(()=>Object.entries(l).some(([T,S])=>T!=="noAuth"&&!!S)),y=(0,b.useCallback)(()=>{f(T=>(ca(),!T))},[]),v=(0,b.useCallback)(T=>{i.onAuthMethodSelect(T),u(S=>({...S,noAuth:T===Q.q.NoAuth,basicAuth:T===Q.q.BasicAuth,oAuthForward:T===Q.q.OAuthForward,withCredentials:S.withCredentials})),da({authMethod:T})},[i]),D=(0,b.useCallback)((T,S)=>{u(O=>{const P=!O[T],Te={...O,[T]:P};return S(P),Te})},[]);return(0,n.jsxs)(G.B,{direction:"column",children:[(0,n.jsx)(L.a,{alignItems:"center",children:(0,n.jsx)(x.I,{label:(0,n.jsx)("div",{className:(0,j.cx)(s.label),children:"Auth and TLS/SSL Settings"}),labelWidth:35,children:(0,n.jsx)(oe.K,{"data-testid":"influxdb-v2-config-auth-settings-toggle",value:p,onChange:y})})}),p&&(0,n.jsxs)(L.a,{paddingLeft:1,children:[(0,n.jsx)(L.a,{marginBottom:1,children:(0,n.jsx)(F.D,{label:(0,n.jsx)(ae.E,{element:"h5",children:"Authentication Method"}),noMargin:!0,children:(0,n.jsx)(L.a,{width:"50%",marginY:2,children:(0,n.jsx)(Fe.z,{options:Vt,value:c,onChange:v,size:r<1100?"sm":"md"})})})}),l.basicAuth&&(0,n.jsx)(L.a,{marginBottom:2,children:(0,n.jsx)(n.Fragment,{children:(0,n.jsxs)(L.a,{display:"flex",direction:"column",marginBottom:2,children:[(0,n.jsx)(x.I,{label:"User",labelWidth:V,grow:!0,children:(0,n.jsx)(C.p,{placeholder:"User",onChange:(0,I.zX)(t,"basicAuthUser"),value:e.basicAuthUser||""})}),(0,n.jsx)(x.I,{label:"Password",labelWidth:V,grow:!0,children:(0,n.jsx)(M.L4,{placeholder:"Password",isConfigured:e.secureJsonFields.basicAuthPassword||!1,onChange:(0,I.mn)(t,"basicAuthPassword"),onReset:()=>(0,I.QP)(t,"basicAuthPassword"),value:e.secureJsonData?.basicAuthPassword||""})})]})})}),(0,n.jsxs)(L.a,{display:"flex",direction:"row",alignItems:"center",marginBottom:2,children:[(0,n.jsx)(W.c,{style:{width:"150px"},tooltip:"Whether credentials such as cookies or auth headers should be sent with cross-site requests.",children:"With Credentials"}),(0,n.jsx)(oe.K,{"data-testid":"influxdb-v2-config-auth-settings-with-credentials",value:l.withCredentials,onChange:T=>{i.onAuthMethodSelect(c),a({...e,withCredentials:T.currentTarget.checked,jsonData:{...e.jsonData,oauthPassThru:c===Q.q.OAuthForward}}),u({...l,noAuth:c===Q.q.NoAuth,basicAuth:c===Q.q.BasicAuth,oAuthForward:c===Q.q.OAuthForward,withCredentials:T.currentTarget.checked})}})]}),(0,n.jsx)(L.a,{marginBottom:2,children:(0,n.jsx)(F.D,{noMargin:!0,children:(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(ae.E,{element:"h5",children:"TLS Settings"}),(0,n.jsxs)(L.a,{display:"flex",alignItems:"center","data-testid":"influxdb-v2-config-auth-settings-tls-client-auth-toggle",marginTop:2,children:[(0,n.jsx)(_e.J,{style:{width:"125px"},children:"TLS Client Auth"}),(0,n.jsx)(Fe.z,{options:Xe,value:l.tlsClientAuth,onChange:()=>D("tlsClientAuth",i.TLS.TLSClientAuth.onToggle),size:"sm"})]}),l.tlsClientAuth&&(0,n.jsxs)(L.a,{marginTop:2,children:[(0,n.jsx)(x.I,{label:"Server Name",labelWidth:14,grow:!0,children:(0,n.jsx)(C.p,{placeholder:"domain.example.com",onChange:T=>i.TLS?.TLSClientAuth.onServerNameChange(T.currentTarget.value),value:i.TLS?.TLSClientAuth.serverName||""})}),(0,n.jsx)(Ne.K,{label:"Client Cert",placeholder:"Begins with -----BEGIN CERTIFICATE-----",onChange:T=>i.TLS?.TLSClientAuth.onClientCertificateChange(T.currentTarget.value),hasCert:!!i.TLS?.TLSClientAuth.clientCertificateConfigured,onClick:()=>i.TLS?.TLSClientAuth.onClientCertificateReset(),useGrow:z.$.featureToggles.newInfluxDSConfigPageDesign}),(0,n.jsx)(Ne.K,{label:"Client Key",placeholder:"Begins with -----BEGIN RSA PRIVATE KEY-----",onChange:T=>i.TLS?.TLSClientAuth.onClientKeyChange(T.currentTarget.value),hasCert:!!i.TLS?.TLSClientAuth.clientKeyConfigured,onClick:()=>i.TLS?.TLSClientAuth.onClientKeyReset(),useGrow:z.$.featureToggles.newInfluxDSConfigPageDesign})]})]})})}),(0,n.jsx)(L.a,{marginBottom:2,children:(0,n.jsx)(F.D,{noMargin:!0,children:(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(L.a,{display:"flex",alignItems:"center","data-testid":"influxdb-v2-config-auth-settings-ca-cert-toggle",children:[(0,n.jsx)(_e.J,{style:{width:"125px"},children:"CA Cert"}),(0,n.jsx)(Fe.z,{options:Xe,value:l.caCert,onChange:()=>D("caCert",i.TLS.selfSignedCertificate.onToggle),size:"sm"})]}),l.caCert&&(0,n.jsx)(L.a,{marginTop:3,children:(0,n.jsx)(Ne.K,{label:"CA Cert",placeholder:"Begins with -----BEGIN CERTIFICATE-----",onChange:T=>i.TLS?.selfSignedCertificate.onCertificateChange(T.currentTarget.value),hasCert:!!i.TLS?.selfSignedCertificate.certificateConfigured,onClick:()=>i.TLS?.selfSignedCertificate.onCertificateReset(),useGrow:z.$.featureToggles.newInfluxDSConfigPageDesign})})]})})}),(0,n.jsxs)(L.a,{display:"flex",direction:"row",alignItems:"center",children:[(0,n.jsx)(W.c,{style:{width:"150px"},children:"Skip TLS Verify"}),(0,n.jsx)(oe.K,{"data-testid":"influxdb-v2-config-auth-settings-skip-tls-verify",value:l.skipTLS,onChange:()=>D("skipTLS",i.TLS.skipTLSVerification.onToggle)})]})]})]})},be=[{name:"InfluxDB Cloud Dedicated",queryLanguages:[{name:d.SQL,fields:["Host","Database","Token"]},{name:d.InfluxQL,fields:["Host","Database","Token"]}],detectionMethod:{urlContains:["influxdb.io"]}},{name:"InfluxDB Cloud Serverless",queryLanguages:[{name:d.SQL,fields:["Host","Bucket","Token"]},{name:d.InfluxQL,fields:["Host","Bucket","Token"]},{name:d.Flux,fields:["Host","Organization","Token","Default bucket"]}],detectionMethod:{urlContains:["us-east-1-1.aws.cloud2.influxdata.com","eu-central-1-1.aws.cloud2.influxdata.com"]}},{name:"InfluxDB Clustered",queryLanguages:[{name:d.SQL,fields:["Host","Database","Token"]},{name:d.InfluxQL,fields:["URL","Database","Token"]}],detectionMethod:{pingHeaderResponse:{"x-influxdb-version":"\\s*influxqlbridged-development"}}},{name:"InfluxDB Enterprise 1.x",queryLanguages:[{name:d.InfluxQL,fields:["URL","Database","User","Password"]},{name:d.Flux,fields:["URL","User","Password","Default database"]}],detectionMethod:{pingHeaderResponse:{"x-influxdb-build":"Enterprise (needs confirmation)"}}},{name:"InfluxDB Enterprise 3.x",queryLanguages:[{name:d.SQL,fields:["URL","Token"]},{name:d.InfluxQL,fields:["URL","Token"]}],detectionMethod:{pingHeaderResponse:{"x-influxdb-build":"TBD"}}},{name:"InfluxDB Cloud (TSM)",queryLanguages:[{name:d.InfluxQL,fields:["URL","Database","Token"]},{name:d.Flux,fields:["URL","Organization","Token","Default bucket"]}],detectionMethod:{urlContains:["us-west-2-1.aws.cloud2.influxdata.com","us-west-2-2.aws.cloud2.influxdata.com","us-east-1-1.aws.cloud2.influxdata.com","eu-central-1-1.aws.cloud2.influxdata.com","us-central1-1.gcp.cloud2.influxdata.com","westeurope-1.azure.cloud2.influxdata.com","eastus-1.azure.cloud2.influxdata.com"]}},{name:"InfluxDB Cloud 1",queryLanguages:[{name:d.InfluxQL,fields:["URL","Database","Username","Password"]}],detectionMethod:{urlContains:["influxcloud.net"]}},{name:"InfluxDB OSS 1.x",queryLanguages:[{name:d.InfluxQL,fields:["URL","Database","Username","Password"]},{name:d.Flux,fields:["URL","Username","Password","Default database"]}],detectionMethod:{pingHeaderResponse:{"x-influxdb-build":"OSS","x-influxdb-version":"^1\\."}}},{name:"InfluxDB OSS 2.x",queryLanguages:[{name:d.InfluxQL,fields:["URL","Database",{type:"Basic",fields:["Username","Password"]},{type:"Token",fields:["Token"]}]},{name:d.Flux,fields:["URL","Token","Default bucket"]}],detectionMethod:{pingHeaderResponse:{"x-influxdb-build":"OSS","x-influxdb-version":"^2\\."}}}],Ia=t=>be.find(({name:a})=>a===t)?.queryLanguages?.map(({name:a})=>({value:a}))??[],Ea=t=>{const{options:e,onOptionsChange:a}=t,s=f=>typeof f=="string"&&(f===d.Flux||f===d.InfluxQL||f===d.SQL),r=e.jsonData.product&&e.jsonData.version===d.InfluxQL&&["InfluxDB OSS 1.x","InfluxDB OSS 2.x","InfluxDB Enterprise 1.x","InfluxDB Cloud (TSM)","InfluxDB Cloud Serverless"].includes(e.jsonData.product),i=({value:f})=>{zt({product:f}),a({...e,jsonData:{...e.jsonData,product:f,version:void 0}})},o=f=>{const{value:y}=f;qt({version:y}),s(y)&&(0,I.BD)(t,"version")(f)},l=f=>{(0,I.zX)(t,"url")(f)},u=async f=>{const y=f.replace(/\/$/,"");try{const v=await fetch(`${y}/ping`);if(v.ok){const D=v.headers.get("x-influxdb-build")??void 0,T=v.headers.get("x-influxdb-version")??void 0;if(D||T)return{product:D,version:T}}}catch(v){console.error("Failed to get InfluxDB version:",v)}return{product:void 0,version:void 0}},c=async f=>{let y;if(y=be.find(v=>v.detectionMethod?.urlContains?v.detectionMethod.urlContains.some(D=>f.includes(D)):!1),!y){const v=await u(f);v&&(y=be.find(D=>{if(D.detectionMethod?.pingHeaderResponse){const T=D.detectionMethod.pingHeaderResponse["x-influxdb-build"],S=D.detectionMethod.pingHeaderResponse["x-influxdb-version"],O=v.version??"",P=v.product??"",Te=new RegExp(S).test(O),qe=P.includes(T);return Te&&qe}return!1}))}a({...e,jsonData:{...e.jsonData,product:y?y.name:void 0,version:void 0}})},p=f=>{c(f.target.value)};return(0,n.jsx)(L.a,{borderStyle:"solid",borderColor:"weak",padding:2,marginBottom:4,id:`${le[0].id}`,minWidth:Oe,children:(0,n.jsxs)(Ye.M,{label:(0,n.jsxs)(ae.E,{element:"h3",children:["1. ",le[0].label]}),isOpen:le[0].isOpen,children:[(0,n.jsx)(ae.E,{color:"secondary",children:"Enter the URL of your InfluxDB instance, then select your product and query language. This will determine the available settings and authentication methods in the next steps."}),(0,n.jsxs)(L.a,{direction:"column",gap:2,marginTop:3,children:[(0,n.jsx)(F.D,{label:(0,n.jsx)("div",{style:{marginBottom:"5px"},children:"URL *"}),noMargin:!0,required:!0,children:(0,n.jsx)(C.p,{"data-testid":"influxdb-v2-config-url-input",placeholder:"example: http://localhost:8086/",onChange:l,value:e.url||"",onBlur:f=>{p(f),Ht()}})}),(0,n.jsx)(L.a,{marginTop:2,children:(0,n.jsxs)(G.B,{direction:"row",gap:2,children:[(0,n.jsx)(L.a,{flex:1,children:(0,n.jsx)(F.D,{label:(0,n.jsx)("div",{style:{marginBottom:"5px"},children:"Product *"}),noMargin:!0,required:!0,children:(0,n.jsx)(Le.G,{"data-testid":"influxdb-v2-config-product-select",value:e.jsonData.product,options:be.map(({name:f})=>({value:f})),onChange:i})})}),(0,n.jsx)(L.a,{flex:1,children:(0,n.jsx)(F.D,{label:(0,n.jsx)("div",{style:{marginBottom:"5px"},children:"Query language *"}),noMargin:!0,children:(0,n.jsx)(Le.G,{"data-testid":"influxdb-v2-config-query-language-select",value:e.jsonData.product!==""?e.jsonData.version:"",options:Ia(e.jsonData.product||""),onChange:o})})})]})}),(0,n.jsx)(Ce.$,{v:2}),r&&(0,n.jsxs)(ee.F,{severity:"warning",title:"InfluxQL requires DBRP mapping",children:[`${e.jsonData.product} requires a Database + Retention Policy (DBRP) mapping via the CLI or
              API before data can be queried.`," ",(0,n.jsx)(fe.Y,{href:"https://docs.influxdata.com/influxdb/cloud/query-data/influxql/dbrp/",external:!0,children:"Learn how to set this up"})]}),(0,n.jsx)(Sa,{options:e,onOptionsChange:a}),(0,n.jsx)(ba,{options:e,onOptionsChange:a})]})]})})},Da=({onOptionsChange:t,options:e})=>{const a=(0,Y.of)(ja);return(0,n.jsxs)(G.B,{justifyContent:"space-between",children:[(0,n.jsx)("div",{className:a.hideOnSmallScreen,children:(0,n.jsx)(L.a,{width:"100%",flex:"1 1 auto",children:(0,n.jsx)(xa,{pdcInjected:e?.jsonData?.pdcInjected})})}),(0,n.jsx)(L.a,{width:"60%",flex:"1 1 auto",minWidth:Oe,children:(0,n.jsxs)(G.B,{direction:"column",children:[(0,n.jsx)(ee.F,{severity:"info",title:"You are viewing a new design for the InfluxDB configuration settings.",className:a.alertHeight,children:(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(fe.Y,{href:"https://docs.google.com/forms/d/e/1FAIpQLSdi-zyX3c51vh937UKhNYYxhljUnFi6dQSlZv50mES9NrK-ig/viewform",external:!0,onClick:Gt,children:"Share your thoughts"})," ","to help us make it even better."]})}),(0,n.jsx)(ae.E,{color:"secondary",element:"p",italic:!0,children:"Fields marked with * are required"}),(0,n.jsx)(Ea,{options:e,onOptionsChange:t}),(0,n.jsx)(pa,{options:e,onOptionsChange:t})]})}),(0,n.jsx)(L.a,{width:"20%",flex:"0 0 20%"})]})},ja=t=>({hideOnSmallScreen:(0,j.css)({width:"250px",flex:"0 0 250px",[t.breakpoints.down("sm")]:{display:"none"}}),alertHeight:(0,j.css)({height:"100px"})});var ue=h(8934),R=h(56355);const Be=[],E={Aggregations:[],GroupByTimeFunctions:[],Selectors:[],Transformations:[],Predictors:[],Math:[],Aliasing:[],Fields:[]};function et(t){const e=Be[t.type];if(!e)throw{message:"Could not find query part "+t.type};return new R.kW(t,e)}function w(t){Be[t.type]=new R.tI(t),t.category.push(Be[t.type])}function Aa(t,e){return e+' AS "'+t.params[0]+'"'}function tt(t){const e=t.params[0];if(e==="*")return"*";let a=`"${e}"`;return e.endsWith("::tag")&&(a=`"${e.slice(0,-5)}"::tag`),e.endsWith("::field")&&(a=`"${e.slice(0,-7)}"::field`),a}function $(t,e){for(let a=0;a<t.length;a++){const s=t[a];if(s.def.category===E.Aggregations){if(s.def.type===e.def.type)return;if(s.def.type==="count"&&e.def.type==="distinct")break;if(s.def.type==="distinct"){const r=t.length>=a+2;if(e.def.type!=="count"&&r)t[a+1].def.category===E.Aggregations&&t.splice(a+1,1);else if(e.def.type==="count"){(!r||t[a+1].def.type!=="count")&&t.splice(a+1,0,e);return}}t[a]=e;return}if(s.def.category===E.Selectors){t[a]=e;return}}t.splice(1,0,e)}function J(t,e){let a;for(a=0;a<t.length;a++){const s=t[a];if(s.def.category===E.Math||s.def.category===E.Aliasing)break}t.splice(a,0,e)}function wa(t,e){const a=t.length;if(a>0){if(t[a-1].def.type==="math"){t[a-1]=e;return}if(a>1&&t[a-2].def.type==="math"){t[a-2]=e;return}else if(t[a-1].def.type==="alias"){t.splice(a-1,0,e);return}}t.push(e)}function La(t,e){const a=t.length;if(a>0&&t[a-1].def.type==="alias"){t[a-1]=e;return}t.push(e)}function Ra(t,e,a){const s=(0,m.map)(t,r=>et({type:r.def.type,params:(0,m.clone)(r.params)}));a.selectModels.push(s)}w({type:"field",addStrategy:Ra,category:E.Fields,params:[{type:"field",dynamicLookup:!0}],defaultParams:["value"],renderer:tt}),w({type:"count",addStrategy:$,category:E.Aggregations,params:[],defaultParams:[],renderer:R.Wn}),w({type:"distinct",addStrategy:$,category:E.Aggregations,params:[],defaultParams:[],renderer:R.Wn}),w({type:"integral",addStrategy:$,category:E.Aggregations,params:[],defaultParams:[],renderer:R.Wn}),w({type:"mean",addStrategy:$,category:E.Aggregations,params:[],defaultParams:[],renderer:R.Wn}),w({type:"median",addStrategy:$,category:E.Aggregations,params:[],defaultParams:[],renderer:R.Wn}),w({type:"mode",addStrategy:$,category:E.Aggregations,params:[],defaultParams:[],renderer:R.Wn}),w({type:"sum",addStrategy:$,category:E.Aggregations,params:[],defaultParams:[],renderer:R.Wn}),w({type:"derivative",addStrategy:J,category:E.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:R.Wn}),w({type:"spread",addStrategy:J,category:E.Transformations,params:[],defaultParams:[],renderer:R.Wn}),w({type:"non_negative_derivative",addStrategy:J,category:E.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:R.Wn}),w({type:"difference",addStrategy:J,category:E.Transformations,params:[],defaultParams:[],renderer:R.Wn}),w({type:"non_negative_difference",addStrategy:J,category:E.Transformations,params:[],defaultParams:[],renderer:R.Wn}),w({type:"moving_average",addStrategy:J,category:E.Transformations,params:[{name:"window",type:"int",options:[5,10,20,30,40]}],defaultParams:[10],renderer:R.Wn}),w({type:"cumulative_sum",addStrategy:J,category:E.Transformations,params:[],defaultParams:[],renderer:R.Wn}),w({type:"stddev",addStrategy:J,category:E.Transformations,params:[],defaultParams:[],renderer:R.Wn}),w({type:"time",category:E.GroupByTimeFunctions,params:[{name:"interval",type:"time",options:["$__interval","1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["$__interval"],renderer:R.Wn}),w({type:"fill",category:E.GroupByTimeFunctions,params:[{name:"fill",type:"string",options:["none","null","0","previous","linear"]}],defaultParams:["null"],renderer:R.Wn}),w({type:"elapsed",addStrategy:J,category:E.Transformations,params:[{name:"duration",type:"interval",options:["1s","10s","1m","5m","10m","15m","1h"]}],defaultParams:["10s"],renderer:R.Wn}),w({type:"holt_winters",addStrategy:J,category:E.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:R.Wn}),w({type:"holt_winters_with_fit",addStrategy:J,category:E.Predictors,params:[{name:"number",type:"int",options:[5,10,20,30,40]},{name:"season",type:"int",options:[0,1,2,5,10]}],defaultParams:[10,2],renderer:R.Wn}),w({type:"bottom",addStrategy:$,category:E.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:R.Wn}),w({type:"first",addStrategy:$,category:E.Selectors,params:[],defaultParams:[],renderer:R.Wn}),w({type:"last",addStrategy:$,category:E.Selectors,params:[],defaultParams:[],renderer:R.Wn}),w({type:"max",addStrategy:$,category:E.Selectors,params:[],defaultParams:[],renderer:R.Wn}),w({type:"min",addStrategy:$,category:E.Selectors,params:[],defaultParams:[],renderer:R.Wn}),w({type:"percentile",addStrategy:$,category:E.Selectors,params:[{name:"nth",type:"int"}],defaultParams:[95],renderer:R.Wn}),w({type:"top",addStrategy:$,category:E.Selectors,params:[{name:"count",type:"int"}],defaultParams:[3],renderer:R.Wn}),w({type:"tag",category:E.GroupByTimeFunctions,params:[{name:"tag",type:"string",dynamicLookup:!0}],defaultParams:["tag"],renderer:tt}),w({type:"math",addStrategy:wa,category:E.Math,params:[{name:"expr",type:"string"}],defaultParams:[" / 100"],renderer:R.Dw}),w({type:"alias",addStrategy:La,category:E.Aliasing,params:[{name:"name",type:"string",quote:"double"}],defaultParams:["alias"],renderMode:"suffix",renderer:Aa});const ne={create:et,getCategories:()=>E,replaceAggregationAdd:$};class Z{constructor(e,a,s){this.selectModels=[],this.groupByParts=[],this.target=e,this.templateSrv=a,this.scopedVars=s,e.policy=e.policy||U,e.resultFormat=e.resultFormat||"time_series",e.orderByTime=e.orderByTime||"ASC",e.tags=e.tags||[],e.groupBy=e.groupBy||[{type:"time",params:["$__interval"]},{type:"fill",params:["null"]}],e.select=e.select||[[{type:"field",params:["value"]},{type:"mean",params:[]}]],this.updateProjection()}updateProjection(){this.selectModels=(0,m.map)(this.target.select,e=>(0,m.map)(e,ne.create)),this.groupByParts=(0,m.map)(this.target.groupBy,ne.create)}updatePersistedParts(){this.target.select=(0,m.map)(this.selectModels,e=>(0,m.map)(e,a=>({type:a.def.type,params:a.params})))}hasGroupByTime(){return(0,m.find)(this.target.groupBy,e=>e.type==="time")}hasFill(){return(0,m.find)(this.target.groupBy,e=>e.type==="fill")}addGroupBy(e){let a=e.match(/^(\w+)\((.*)\)$/);if(!a||!this.target.groupBy)return;const s=a[1],r=a[2],i=ne.create({type:s,params:[r]}),o=this.target.groupBy.length;o===0?this.target.groupBy.push(i.part):s==="time"?this.target.groupBy.splice(0,0,i.part):s==="tag"?this.target.groupBy[o-1].type==="fill"?this.target.groupBy.splice(o-1,0,i.part):this.target.groupBy.push(i.part):this.target.groupBy.push(i.part),this.updateProjection()}removeGroupByPart(e,a){const s=ne.getCategories();e.def.type==="time"&&(this.target.groupBy=(0,m.filter)(this.target.groupBy,r=>r.type!=="fill"),this.target.select=(0,m.map)(this.target.select,r=>(0,m.filter)(r,i=>{const o=ne.create(i);return!(o.def.category===s.Aggregations||o.def.category===s.Selectors)}))),this.target.groupBy.splice(a,1),this.updateProjection()}removeSelect(e){this.target.select.splice(e,1),this.updateProjection()}removeSelectPart(e,a){if(a.def.type==="field"){if(this.selectModels.length>1){const s=(0,m.indexOf)(this.selectModels,e);this.selectModels.splice(s,1)}}else{const s=(0,m.indexOf)(e,a);e.splice(s,1)}this.updatePersistedParts()}addSelectPart(e,a){const s=ne.create({type:a});s.def.addStrategy(e,s,this),this.updatePersistedParts()}isOperatorTypeHandler(e,a,s){let r;if(e==="Is Not"?e="!=":e="=",s.endsWith("::tag"))return r="'"+Ie(a.replace(/\\/g,"\\\\").replace(/\'/g,"\\'"))+"'",{operator:e,value:r};let i=a.toLowerCase();return isNaN(parseFloat(a))?["true","false"].includes(i)?r=i:r="'"+Ie(a.replace(/\\/g,"\\\\").replace(/\'/g,"\\'"))+"'":r=a,{operator:e,value:r}}renderTagCondition(e,a,s){let r="",i=e.operator,o=e.value;if(a>0&&(r=(e.condition||"AND")+" "),i||(/^\/.*\/$/.test(o)?i="=~":i="="),i!=="=~"&&i!=="!~")if(s&&(o=this.templateSrv.replace(o,this.scopedVars)),o=Ie(o),i.startsWith("Is")){let u=this.isOperatorTypeHandler(i,o,e.key);i=u.operator,o=u.value}else(!i.startsWith(">")&&!i.startsWith("<")||i==="<>")&&(o="'"+o.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'");else s&&(o=this.templateSrv.replace(o,this.scopedVars,"regex"));let l=`"${e.key}"`;return e.key.endsWith("::tag")&&(l=`"${e.key.slice(0,-5)}"::tag`),e.key.endsWith("::field")&&(l=`"${e.key.slice(0,-7)}"::field`),r+l+" "+i+" "+o}getMeasurementAndPolicy(e){let a=this.target.policy,s=this.target.measurement||"measurement";return s.match("^/.*/$")?e&&(s=this.templateSrv.replace(s,this.scopedVars,"regex")):s='"'+s+'"',a!==U?a='"'+this.target.policy+'".':a="",a+s}interpolateQueryStr(e,a){return!a.multi&&!a.includeAll?e:typeof e=="string"?(0,ue.$f)(e):"("+(0,m.map)(e,ue.$f).join("|")+")"}render(e){const a=this.target;if(a.rawQuery)return e?this.templateSrv.replace(a.query,this.scopedVars,this.interpolateQueryStr):a.query;let s="SELECT ",r,i;for(r=0;r<this.selectModels.length;r++){const u=this.selectModels[r];let c="";for(i=0;i<u.length;i++)c=u[i].render(c);r>0&&(s+=", "),s+=c}s+=" FROM "+this.getMeasurementAndPolicy(e)+" WHERE ";const o=(0,m.map)(a.tags,(u,c)=>this.renderTagCondition(u,c,e));o.length>0&&(s+="("+o.join(" ")+") AND "),s+="$timeFilter";let l="";for(r=0;r<this.groupByParts.length;r++){const u=this.groupByParts[r];r>0&&(l+=u.def.type==="fill"?" ":", "),l+=u.render("")}return l.length&&(s+=" GROUP BY "+l),a.fill&&(s+=" fill("+a.fill+")"),a.orderByTime==="DESC"&&(s+=" ORDER BY time DESC"),a.limit&&(s+=" LIMIT "+a.limit),a.slimit&&(s+=" SLIMIT "+a.slimit),a.tz&&(s+=" tz('"+a.tz+"')"),s}renderAdhocFilters(e){return(0,m.map)(e,(s,r)=>this.renderTagCondition(s,r,!0)).join(" ")}}function at(t){const e=(0,m.cloneDeep)(t);return new Z(e).render(!1)}function Oa(t){if(t.policy!==void 0&&t.resultFormat!==void 0&&t.orderByTime!==void 0&&t.tags!==void 0&&t.groupBy!==void 0&&t.select!==void 0)return t;const e=(0,m.cloneDeep)(t);return new Z(e).target}function Fa(t,e,a){const s=(0,m.cloneDeep)(t),r=new Z(s);return r.addSelectPart(r.selectModels[a],e),r.target}function Na(t,e,a){const s=(0,m.cloneDeep)(t),r=new Z(s),i=r.selectModels[a];return r.removeSelectPart(i,i[e]),r.target}function Ba(t,e,a,s){const r=[...t.select??[]];return r[e]=[...r[e]],r[e][a]={...r[e][a],params:s},{...t,select:r}}function Pa(t,e){const a=(0,m.cloneDeep)(t),s=new Z(a);return s.addGroupBy(e),s.target}function Ma(t,e){const a=(0,m.cloneDeep)(t),s=new Z(a);return s.removeGroupByPart(s.groupByParts[e],e),s.target}function ka(t,e,a){const s=[...t.groupBy??[]];return s[e]={...s[e],params:a},{...t,groupBy:s}}function Ie(t){const e=/\/\^(.*?)\$\//,a=t.match(e);return a&&a.length>1?a[1]:t}var pe=h(2863),de=h(78193),Qa=h(50992),Ua=h(61875),se=h(51115);const Wa=[{label:"Show buckets",description:"List the available buckets (table)",value:"buckets()"},{label:"Simple query",description:"filter by measurement and field",value:`from(bucket: "db/rp")
  |> range(start: v.timeRangeStart, stop:v.timeRangeStop)
  |> filter(fn: (r) =>
    r._measurement == "example-measurement" and
    r._field == "example-field"
  )`},{label:"Grouped Query",description:"Group by (min/max/sum/median)",value:`// v.windowPeriod is a variable referring to the current optimized window period (currently: $interval)
from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r["_measurement"] == "measurement1" or r["_measurement"] =~ /^.*?regex.*$/)
  |> filter(fn: (r) => r["_field"] == "field2" or r["_field"] =~ /^.*?regex.*$/)
  |> aggregateWindow(every: v.windowPeriod, fn: mean|median|max|count|derivative|sum)
  |> yield(name: "some-name")`},{label:"Filter by value",description:"Results between a min/max",value:`// v.bucket, v.timeRangeStart, and v.timeRange stop are all variables supported by the flux plugin and influxdb
from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r["_value"] >= 10 and r["_value"] <= 20)`},{label:"Schema Exploration: (measurements)",description:"Get a list of measurement using flux",value:`import "influxdata/influxdb/v1"
v1.measurements(bucket: v.bucket)`},{label:"Schema Exploration: (fields)",description:"Return every possible key in a single table",value:`from(bucket: v.bucket)
  |> range(start: v.timeRangeStart, stop:v.timeRangeStop)
  |> keys()
  |> keep(columns: ["_value"])
  |> group()
  |> distinct()`},{label:"Schema Exploration: (tag keys)",description:"Get a list of tag keys using flux",value:`import "influxdata/influxdb/v1"
v1.tagKeys(bucket: v.bucket)`},{label:"Schema Exploration: (tag values)",description:"Get a list of tag values using flux",value:`import "influxdata/influxdb/v1"
v1.tagValues(
    bucket: v.bucket,
    tag: "host",
    predicate: (r) => true,
    start: -1d
)`}];class Va extends b.PureComponent{constructor(){super(...arguments),this.onFluxQueryChange=e=>{this.props.onChange({...this.props.query,query:e})},this.onSampleChange=e=>{this.props.onChange({...this.props.query,query:e.value}),this.forceUpdate()},this.getSuggestions=()=>{const e=[{label:"v.timeRangeStart",kind:de.q.Property,detail:"The start time"},{label:"v.timeRangeStop",kind:de.q.Property,detail:"The stop time"},{label:"v.windowPeriod",kind:de.q.Property,detail:"based on max data points"},{label:"v.defaultBucket",kind:de.q.Property,detail:"bucket configured in the datsource"},{label:"v.organization",kind:de.q.Property,detail:"org configured for the datsource"}],a=(0,pe.w)();return a.getVariables().forEach(s=>{const r="${"+s.name+"}";let i=a.replace(r);i===r&&(i=""),e.push({label:r,kind:de.q.Text,detail:`(Template Variable) ${i}`})}),e},this.editorDidMountCallbackHack=e=>{setTimeout(()=>e.layout(),100)}}render(){const{query:e,theme:a}=this.props,s=$a(a),r=(0,n.jsxs)("div",{children:["Type: ",(0,n.jsx)("i",{children:"ctrl+space"})," to show template variable suggestions ",(0,n.jsx)("br",{}),"Many queries can be copied from Chronograf"]});return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(Qa.B,{height:"100%",containerStyles:s.editorContainerStyles,language:"sql",value:e.query||"",onBlur:this.onFluxQueryChange,onSave:this.onFluxQueryChange,showMiniMap:!1,showLineNumbers:!0,getSuggestions:this.getSuggestions,onEditorDidMount:this.editorDidMountCallbackHack}),(0,n.jsxs)("div",{className:(0,j.cx)("gf-form-inline",s.editorActions),children:[(0,n.jsx)(me.z9,{icon:"external-link-alt",variant:"secondary",target:"blank",href:"https://docs.influxdata.com/influxdb/latest/query-data/get-started/",children:"Flux language syntax"}),(0,n.jsx)(Ua.Y,{options:Wa,value:"Sample query",onChange:this.onSampleChange,className:(0,j.css)({marginTop:a.spacing(-.5),marginLeft:a.spacing(.5)})}),(0,n.jsx)("div",{className:"gf-form gf-form--grow",children:(0,n.jsx)("div",{className:"gf-form-label gf-form-label--grow"})}),(0,n.jsx)(se.I,{width:5,tooltip:r,children:"Help"})]})]})}}const $a=t=>({editorContainerStyles:(0,j.css)({height:"200px",maxWidth:"100%",resize:"vertical",overflow:"auto",backgroundColor:t.isDark?t.colors.background.canvas:t.colors.background.primary,paddingBottom:t.spacing(1)}),editorActions:(0,j.css)({marginTop:"6px"})}),Pe=(0,Y.cV)(Va);var re=h(52315),Ga=h(24726),B=h(1578);function Ha(t){const e=[];for(const a of t){let s="text";switch(a.type?.toUpperCase()){case"BOOLEAN":case"BOOL":{s="boolean";break}case"BYTES":case"VARCHAR":{s="text";break}case"FLOAT":case"FLOAT64":case"INT":case"INTEGER":case"INT64":case"NUMERIC":case"BIGNUMERIC":{s="number";break}case"DATE":{s="date";break}case"TIMESTAMP(NANOSECOND, NONE)":case"DATETIME":{s="datetime";break}case"TIME":{s="time";break}case"TIMESTAMP":{s="datetime";break}case"GEOGRAPHY":{s="text";break}default:break}e.push({...a,raqbFieldType:s,icon:qa(a.type.toUpperCase())})}return e}function qa(t){switch(t){case"TIME":case"DATETIME":case"TIMESTAMP":return"clock-nine";case"BOOLEAN":return"toggle-off";case"INTEGER":case"FLOAT":case"FLOAT64":case"INT":case"SMALLINT":case"BIGINT":case"TINYINT":case"BYTEINT":case"INT64":case"NUMERIC":case"DECIMAL":return"calculator-alt";case"CHAR":case"VARCHAR":case"STRING":case"BYTES":case"TEXT":case"TINYTEXT":case"MEDIUMTEXT":case"LONGTEXT":return"text";case"GEOGRAPHY":return"map";default:return}}function za(t){return t[0]==='"'&&t[t.length-1]==='"'?t.substring(1,t.length-1).replace(/""/g,'"'):t[0]==="`"&&t[t.length-1]==="`"?t.substring(1,t.length-1):t}function nt(t){return"'"+t.replace(/'/g,"''")+"'"}function st({sql:t,table:e}){let a="";if(!t||!(0,re.YW)(t.columns))return a;const s=t.columns.map(r=>({...r,parameters:r.parameters?.map(i=>({...i,name:Ka(i.name)}))}));if(a+=(0,re.oF)(s),e&&(a+=`FROM "${e}" `),a+='WHERE "time" >= $__timeFrom AND "time" <= $__timeTo ',t.whereString){const r=new RegExp("(\\s?)([^\\(]\\S+)(\\s?=)","g"),o=t.whereString.replace(r,'$1"$2"$3');a+=`AND ${o} `}if(t.groupBy?.[0]?.property.name){const r=t.groupBy.map(i=>`"${i.property.name}"`).filter(i=>!(0,m.isEmpty)(i));a+=`GROUP BY ${r.join(", ")} `}return t.orderBy?.property.name&&(a+=`ORDER BY "${t.orderBy.property.name}" `),t.orderBy?.property.name&&t.orderByDirection&&(a+=`${t.orderByDirection} `),Ya(t.limit)&&(a+=`LIMIT ${t.limit}`),a}function Ka(t){return t==="*"?t:`"${t}"`}const Ya=t=>t!==void 0&&t>=0;function Me(t){return Ja(t)?t:`"${t}"`}function Ja(t){const e=/^[a-zA-Z_][a-zA-Z0-9_$]*$/g.test(t);return!Xa.includes(t.toUpperCase())&&e}const Xa=["ACCESSIBLE","ADD","ALL","ALTER","ANALYZE","AND","AS","ASC","ASENSITIVE","BEFORE","BETWEEN","BIGINT","BINARY","BLOB","BOTH","BY","CALL","CASCADE","CASE","CHANGE","CHAR","CHARACTER","CHECK","COLLATE","COLUMN","CONDITION","CONSTRAINT","CONTINUE","CONVERT","CREATE","CROSS","CUBE","CUME_DIST","CURRENT_DATE","CURRENT_TIME","CURRENT_TIMESTAMP","CURRENT_USER","CURSOR","DATABASE","DATABASES","DAY_HOUR","DAY_MICROSECOND","DAY_MINUTE","DAY_SECOND","DEC","DECIMAL","DECLARE","DEFAULT","DELAYED","DELETE","DENSE_RANK","DESC","DESCRIBE","DETERMINISTIC","DISTINCT","DISTINCTROW","DIV","DOUBLE","DROP","DUAL","EACH","ELSE","ELSEIF","EMPTY","ENCLOSED","ESCAPED","EXCEPT","EXISTS","EXIT","EXPLAIN","FALSE","FETCH","FIRST_VALUE","FLOAT","FLOAT4","FLOAT8","FOR","FORCE","FOREIGN","FROM","FULLTEXT","FUNCTION","GENERATED","GET","GRANT","GROUP","GROUPING","GROUPS","HAVING","HIGH_PRIORITY","HOUR_MICROSECOND","HOUR_MINUTE","HOUR_SECOND","IF","IGNORE","IN","INDEX","INFILE","INNER","INOUT","INSENSITIVE","INSERT","INT","INT1","INT2","INT3","INT4","INT8","INTEGER","INTERSECT","INTERVAL","INTO","IO_AFTER_GTIDS","IO_BEFORE_GTIDS","IS","ITERATE","JOIN","JSON_TABLE","KEY","KEYS","KILL","LAG","LAST_VALUE","LATERAL","LEAD","LEADING","LEAVE","LEFT","LIKE","LIMIT","LINEAR","LINES","LOAD","LOCALTIME","LOCALTIMESTAMP","LOCK","LONG","LONGBLOB","LONGTEXT","LOOP","LOW_PRIORITY","MASTER_BIND","MASTER_SSL_VERIFY_SERVER_CERT","MATCH","MAXVALUE","MEDIUMBLOB","MEDIUMINT","MEDIUMTEXT","MIDDLEINT","MINUTE_MICROSECOND","MINUTE_SECOND","MOD","MODIFIES","NATURAL","NOT","NO_WRITE_TO_BINLOG","NTH_VALUE","NTILE","NULL","NUMERIC","OF","ON","OPTIMIZE","OPTIMIZER_COSTS","OPTION","OPTIONALLY","OR","ORDER","OUT","OUTER","OUTFILE","OVER","PARTITION","PERCENT_RANK","PRECISION","PRIMARY","PROCEDURE","PURGE","RANGE","RANK","READ","READS","READ_WRITE","REAL","RECURSIVE","REFERENCES","REGEXP","RELEASE","RENAME","REPEAT","REPLACE","REQUIRE","RESIGNAL","RESTRICT","RETURN","REVOKE","RIGHT","RLIKE","ROW","ROWS","ROW_NUMBER","SCHEMA","SCHEMAS","SECOND_MICROSECOND","SELECT","SENSITIVE","SEPARATOR","SET","SHOW","SIGNAL","SMALLINT","SPATIAL","SPECIFIC","SQL","SQLEXCEPTION","SQLSTATE","SQLWARNING","SQL_BIG_RESULT","SQL_CALC_FOUND_ROWS","SQL_SMALL_RESULT","SSL","STARTING","STORED","STRAIGHT_JOIN","SYSTEM","TABLE","TERMINATED","THEN","TINYBLOB","TINYINT","TINYTEXT","TO","TRAILING","TRIGGER","TRUE","UNDO","UNION","UNIQUE","UNLOCK","UNSIGNED","UPDATE","USAGE","USE","USING","UTC_DATE","UTC_TIME","UTC_TIMESTAMP","VALUES","VARBINARY","VARCHAR","VARCHARACTER","VARYING","VIRTUAL","WHEN","WHERE","WHILE","WINDOW","WITH","WRITE","XOR","YEAR_MONTH","ZEROFILL"];function Za(t){return`SELECT table_name FROM information_schema.tables WHERE table_schema = ${t!==void 0?xe(t):"database()"} ORDER BY table_name`}function Ns(){return"SELECT DISTINCT TABLE_SCHEMA from information_schema.TABLES where TABLE_TYPE != 'SYSTEM VIEW' ORDER BY TABLE_SCHEMA"}function _a(t,e){let a="SELECT column_name, data_type FROM information_schema.columns WHERE ";return a+=en(t,e),a+=" ORDER BY column_name",a}function en(t,e){let a="";if(t.includes(".")){const s=t.split(".");return a="table_schema = "+xe(s[0]),a+=" AND table_name = "+xe(s[1]),a}else return a=`table_schema = ${e!==void 0?xe(e):"database()"} AND table_name = `+xe(t),a}function xe(t){return nt(za(t))}var tn=h(64237);const an=({getMeta:t})=>(e,a)=>({...a&&(0,tn.N)(e,a),customStatementPlacement:sn,customSuggestionKinds:rn(t)}),rt={afterDatabase:"afterDatabase"},nn={tablesWithinDatabase:"tablesWithinDatabase"},ke="FROM",sn=()=>[{id:rt.afterDatabase,resolve:(t,e,a)=>!!(t?.is(B.ks.Delimiter,".")&&e?.value===ke&&(a?.is(B.ks.IdentifierQuote)||a?.isIdentifier())&&t?.getPreviousUntil(B.ks.Keyword,[B.ks.IdentifierQuote],ke)?.filter(s=>s.isIdentifier()).length===1)}],rn=t=>()=>[{id:B.ng.Tables,overrideDefault:!0,suggestionsResolver:async e=>{const a=Ue(e.currentToken);return(await t({schema:a})).map(Qe(e))}},{id:B.ng.Columns,overrideDefault:!0,suggestionsResolver:async e=>{const a=un(e.currentToken),s=Ue(a),r=on(a);return!s||!r?[]:(await t({schema:s,table:r})).map(Qe(e))}},{id:nn.tablesWithinDatabase,applyTo:[rt.afterDatabase],suggestionsResolver:async e=>{const a=Ue(e.currentToken);return(await t({schema:a})).map(Qe(e))}}];function Qe(t){return function(e){return{label:e.name,insertText:e.completion??e.name,command:{id:"editor.action.triggerSuggest",title:""},kind:B.Io.Field,sortText:B.mY.High,range:{...t.range,startColumn:t.range.endColumn,endColumn:t.range.endColumn}}}}function Ue(t){if(t?.isIdentifier()&&t.value[t.value.length-1]!==".")return t.value;if(t?.is(B.ks.Delimiter,"."))return t.getPreviousOfType(B.ks.Identifier)?.value;if(t?.is(B.ks.IdentifierQuote))return t.getPreviousOfType(B.ks.Identifier)?.value||t.getNextOfType(B.ks.Identifier)?.value}function on(t){return t?.getNextOfType(B.ks.Identifier)?.value}const ln=t=>(t?.getPreviousOfType(B.ks.Keyword,"SELECT")??null)?.getNextOfType(B.ks.Keyword,ke),un=t=>{const a=ln(t)?.getNextOfType(B.ks.Identifier);return a?.isKeyword()&&a.next?.is(B.ks.Parenthesis,"(")?null:a};class cn extends re.oK{constructor(e,a=(0,pe.w)()){super(e),this.instanceSettings=e,this.templateSrv=a,this.getFunctions=()=>{const s=[...re.Uw,{name:"VARIANCE"},{name:"STDDEV"}],r={name:"Column",required:!0,options:o=>this.fetchFields(o)},i={name:"Interval",required:!0,options:()=>Promise.resolve([{label:"$__interval",value:"$__interval"}])};return[...s.map(o=>({...o,parameters:[r]})),{name:"$__timeGroup",description:"Time grouping function",parameters:[r,i]},{name:"$__timeGroupAlias",description:"Time grouping function with time as alias",parameters:[r,i]}]}}getQueryModel(){return{quoteLiteral:nt}}getSqlLanguageDefinition(){if(this.sqlLanguageDefinition!==void 0)return this.sqlLanguageDefinition;const e={getMeta:a=>this.fetchMeta(a)};return this.sqlLanguageDefinition={id:"sql",completionProvider:an(e),formatter:re.se},this.sqlLanguageDefinition}async fetchDatasets(){return Promise.resolve(["iox"])}async fetchTables(e){const a=Za(e),r=(await this.runSql(a,{refId:"tables"})).map(i=>Me(i[0]));return r.unshift(...this.getTemplateVariables()),r}async fetchFields(e){if(!e.dataset||!e.table)return[];const a=this.templateSrv.replace(e.table),s=_a(a,e.dataset),i=(await this.runSql(s,{refId:`fields-${Ga.A}`})).map(o=>({name:o[0],text:o[0],value:Me(o[0]),type:o[1],label:o[0]}));return i.unshift(...this.getTemplateVariables().map(o=>({name:o,text:o,value:Me(o),type:"",label:o}))),Ha(i)}getTemplateVariables(){return this.templateSrv.getVariables().map(e=>`$${e.name}`)}async fetchMeta(e){const a=this.instanceSettings.jsonData.database;return!e?.schema&&a?(await this.fetchTables(a)).map(r=>({name:r,completion:`${a}.${r}`,kind:B.Io.Class})):!e?.schema&&!a?(await this.fetchDatasets()).map(r=>({name:r,completion:`${r}.`,kind:B.Io.Module})):!e?.table&&(!a||e?.schema)?(await this.fetchTables(e?.schema)).map(r=>({name:r,completion:r,kind:B.Io.Class})):e?.table&&e.schema?(await this.fetchFields({dataset:e.schema,table:e.table})).map(r=>({name:r.name,completion:r.value,kind:B.Io.Field})):[]}getDB(){return this.db!==void 0?this.db:{datasets:()=>this.fetchDatasets(),tables:e=>this.fetchTables(e),fields:e=>this.fetchFields(e),validateQuery:(e,a)=>Promise.resolve({query:e,error:"",isError:!1,isValid:!0}),dsID:()=>this.id,toRawSql:st,functions:()=>this.getFunctions(),getEditorLanguageDefinition:()=>this.getSqlLanguageDefinition()}}}class dn extends b.PureComponent{constructor(e){super(e);const{datasource:a}=e;this.datasource=new cn({url:a.urls[0],access:a.access,id:a.id,jsonData:{allowCleartextPasswords:!1,tlsAuth:!1,tlsAuthWithCACert:!1,tlsSkipVerify:!1,maxIdleConns:1,maxOpenConns:1,maxIdleConnsAuto:!0,connMaxLifetime:1,timezone:"",user:"",database:"",url:a.urls[0],timeInterval:""},meta:a.meta,name:a.name,readOnly:!1,type:a.type,uid:a.uid},a.templateSrv)}transformQuery(e){const a=(0,re.To)(e);return{...a,dataset:"iox",sql:{...a.sql,limit:void 0}}}render(){const{query:e,theme:a,onRunQuery:s,onChange:r}=this.props,i=hn(a),o=()=>s(),l=c=>{r({...c})},u=(0,n.jsxs)("div",{children:["Type: ",(0,n.jsx)("i",{children:"ctrl+space"})," to show template variable suggestions ",(0,n.jsx)("br",{}),"Many queries can be copied from Chronograf"]});return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(re.u$,{datasource:this.datasource,query:this.transformQuery(e),onRunQuery:o,onChange:l,queryHeaderProps:{dialect:"influx"}}),(0,n.jsxs)("div",{className:(0,j.cx)("gf-form-inline",i.editorActions),children:[(0,n.jsx)(me.z9,{icon:"external-link-alt",variant:"secondary",target:"blank",href:"https://docs.influxdata.com/influxdb/cloud-serverless/query-data/sql/",children:"SQL language syntax"}),(0,n.jsx)("div",{className:"gf-form gf-form--grow",children:(0,n.jsx)("div",{className:"gf-form-label gf-form-label--grow"})}),(0,n.jsx)(se.I,{width:5,tooltip:u,children:"Help"})]})]})}}const hn=t=>({editorContainerStyles:(0,j.css)({height:"200px",maxWidth:"100%",resize:"vertical",overflow:"auto",backgroundColor:t.isDark?t.colors.background.canvas:t.colors.background.primary,paddingBottom:t.spacing(1)}),editorActions:(0,j.css)({marginTop:"6px"})}),fn=(0,Y.cV)(dn);var gn=h(71599);const mn=({isRaw:t,onChange:e})=>{const[a,s]=(0,b.useState)(!1);return(0,b.useEffect)(()=>{s(!1)},[t]),t?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(me.$n,{"aria-label":"Switch to visual editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{s(!0)}}),(0,n.jsx)(gn.u,{isOpen:a,title:"Switch to visual editor mode",body:"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.",confirmText:"Yes, switch to editor mode",dismissText:"No, stay in raw query mode",onConfirm:()=>{e(!1)},onDismiss:()=>{s(!1)}})]}):(0,n.jsx)(me.$n,{"aria-label":"Switch to text editor",icon:"pen",variant:"secondary",type:"button",onClick:()=>{e(!0)}})};var it=h(87105);const ot=[{label:"Time series",value:"time_series"},{label:"Table",value:"table"},{label:"Logs",value:"logs"}],lt="time_series";var pn=h(84596);function Ee(t){const[e,a]=(0,b.useState)(t),s=(0,pn.A)(t);return(0,b.useEffect)(()=>{s!==t&&e!==t&&a(t)},[t,e,s]),[e,a]}const xn=({query:t,onChange:e,onRunQuery:a})=>{const[s,r]=Ee(t.query),[i,o]=Ee(t.alias),l=(0,b.useId)(),u=(0,b.useId)(),c=t.resultFormat??lt,p=()=>{e({...t,query:s,alias:i,resultFormat:c}),a()};return(0,n.jsxs)(G.B,{direction:"column",children:[(0,n.jsx)(it.f,{"aria-label":"query",rows:3,spellCheck:!1,placeholder:"InfluxDB Query",onBlur:p,onChange:f=>{r(f.currentTarget.value)},value:s??""}),(0,n.jsxs)(G.B,{children:[(0,n.jsx)(x.I,{htmlFor:u,label:"Format as",children:(0,n.jsx)(K.l6,{inputId:u,onChange:f=>{e({...t,resultFormat:f.value}),a()},value:c,options:ot})}),(0,n.jsx)(x.I,{htmlFor:l,label:"Alias by",children:(0,n.jsx)(C.p,{id:l,type:"text",spellCheck:!1,placeholder:"Naming pattern",onBlur:p,onChange:f=>{o(f.currentTarget.value)},value:i??""})})]})]})};var he=h(52042),ut=h(65642);const We=t=>{let e="",{type:a,templateService:s,scopedVars:r,database:i,measurement:o,retentionPolicy:l,tags:u,withKey:c,withMeasurementFilter:p,withTimeFilter:f}=t;switch(a){case"RETENTION_POLICIES":return'SHOW RETENTION POLICIES on "'+i+'"';case"FIELDS":return!o||o===""?"SHOW FIELD KEYS":(o&&!o.match(/^\/.*\/|^$/)&&(o='"'+o+'"',l&&l!==U&&(l='"'+l+'"',o=l+"."+o)),"SHOW FIELD KEYS FROM "+o);case"TAG_KEYS":e="SHOW TAG KEYS";break;case"TAG_VALUES":e="SHOW TAG VALUES";break;case"MEASUREMENTS":e="SHOW MEASUREMENTS",p&&(e+=" WITH MEASUREMENT =~ /(?i)"+(0,ue.$f)(p)+"/");break;default:return e}if(o&&(!o.match("^/.*/")&&!o.match(/^merge\(.*\)/)&&(o='"'+o+'"'),l&&l!==U&&(l='"'+l+'"',o=l+"."+o),o!==""&&(e+=" FROM "+o)),c){let D=c;D.endsWith("::tag")&&(D=D.slice(0,-5)),e+=' WITH KEY = "'+D+'"'}let y=[];u&&u.length>0&&(y=(0,m.reduce)(u,(D,T)=>(T.key&&T.key===c||T.operator===">"||T.operator==="<"||D.push(vn(T,D.length,s,r,!0)),D),[]));let v=yn(f)&&a!=="MEASUREMENTS";return y.length>0?e+=" WHERE "+y.join(" ")+(v?" AND time > now() - "+f:""):e+=v?" WHERE time > now() - "+f:"",a==="MEASUREMENTS"&&(e+=" LIMIT 100"),e};function yn(t){if(!t||typeof t!="string")return!1;const e=t.replace(//g,"u"),a=new Set(["ns","u","ms","s","m","h","d","w"]),s=/(\d+)(ns|u|ms|s|m|h|d|w)/g,r=new Set;let i,o=0;for(;(i=s.exec(e))!==null;){const[l,u,c]=i;if(o+=l.length,!a.has(c)||r.has(c)||u.startsWith("0"))return!1;r.add(c)}return o===e.length}function vn(t,e,a,s,r){let i="",o=t.operator,l=t.value;e>0&&(i=(t.condition||"AND")+" "),o||(/^\/.*\/$/.test(t.value)?o="=~":o="="),(l===""||o!=="=~"&&o!=="!~")&&(l="'"+l.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'"),o!=="=~"&&o!=="!~"?r?l=a.replace(l,s):o!==">"&&o!=="<"&&(l="'"+l.replace(/\\/g,"\\\\").replace(/\'/g,"\\'")+"'"):r&&(l=a.replace(l,s,"regex"));let u=`"${t.key}"`;return t.key.endsWith("::tag")&&(u=`"${t.key.slice(0,-5)}"::tag`),t.key.endsWith("::field")&&(u=`"${t.key.slice(0,-7)}"::field`),i+u+" "+o+" "+l}const ye=async t=>{const{type:e,datasource:a,scopedVars:s,measurement:r,retentionPolicy:i,tags:o,withKey:l,withMeasurementFilter:u}=t,c=We({type:e,scopedVars:s,measurement:r,retentionPolicy:i,tags:o,withKey:l,withMeasurementFilter:u,withTimeFilter:a.showTagTime,templateService:a.templateSrv,database:a.database}),p=i?a.templateSrv.replace(i,{},"regex"):"",f={query:c,policy:p,rawQuery:!0,refId:"metadataQuery"};if(ut.Ay.featureToggles.influxdbBackendMigration)return a.runMetadataQuery(f);{const y={policy:f.policy};return a.metricFindQuery({refId:"run-explore-query",query:c},y)}};async function Sn(t){return(await ye({type:"RETENTION_POLICIES",datasource:t})).map(a=>a.text)}async function Tn(t,e,a){return(await ye({type:"MEASUREMENTS",datasource:t,tags:e,withMeasurementFilter:a})).map(r=>r.text)}async function Cn(t,e,a){return(await ye({type:"TAG_KEYS",datasource:t,measurement:e,retentionPolicy:a})).map(r=>r.text)}async function bn(t,e,a,s,r){return a.endsWith("::field")?[]:(await ye({type:"TAG_VALUES",tags:e,withKey:a,datasource:t,measurement:s,retentionPolicy:r})).map(o=>o.text)}async function ct(t,e,a){return(await ye({type:"FIELDS",datasource:t,measurement:e,retentionPolicy:a})).map(r=>r.text)}function dt(t,e){return t.filter(a=>a.key.endsWith("::tag")||e.has(a.key+"::tag"))}function q(t){return{label:t,value:t}}function ve(t){if(t==null)throw new Error("value must not be nullish");return t}function In(){const t=ne.getCategories(),e=[];return Object.keys(t).forEach(s=>{const r=t[s].map(i=>q(i.type));e.push({label:s,options:r})}),e}async function En(t,e){const a=await e(),s={...t},r=new Z(s),i=[];return r.hasFill()||i.push(q("fill(null)")),r.hasGroupByTime()||i.push(q("time($interval)")),a.forEach(o=>{i.push(q(`tag(${o})`))}),i}function Dn(t,e){const a=ne.create(t).def,s=(t.params??[]).map(r=>r.toString());if(s.length!==a.params.length)throw new Error("Invalid query-segment");return s.map((r,i)=>{const o=a.params[i];return o.dynamicLookup?{value:r,options:ve(e.get(`${a.type}_${i}`))}:o.options!=null?{value:r,options:()=>Promise.resolve(o.options)}:{value:r,options:null}})}function ht(t,e){return t.map(a=>({name:a.type,params:Dn(a,e)}))}function jn(t){return(0,pe.w)().getVariables().map(t)}function Ve(t,e,a){let s=jn(e);return a&&(s=s.filter(r=>r.indexOf(a)>-1)),t.then(r=>[...s,...r])}function ft(t){return`/^$${t.name}$/`}function An(t){return`$${t.name}`}const $e=(0,j.css)({paddingRight:"4px"}),wn=(0,j.cx)("width-8",$e),Ln=({format:t,inputId:e,onChange:a})=>(0,n.jsx)(K.l6,{inputId:e,className:wn,onChange:s=>{a(ve(s.value))},value:t,options:ot});var Ge=h(20301),Rn=h(76459),On=h.n(Rn),Fn=h(41053);const gt=(0,j.css)({minWidth:"160px"}),mt=t=>t,Nn=({loadOptions:t,allowCustomValue:e,onChange:a,onClose:s})=>{const r=On()(t,1e3,{leading:!0});return(0,n.jsx)("div",{className:gt,children:(0,n.jsx)(K.DW,{formatCreateLabel:mt,defaultOptions:!0,autoFocus:!0,isOpen:!0,onCloseMenu:s,allowCustomValue:e,loadOptions:r,onChange:a,createOptionPosition:"first"})})},Bn=({loadOptions:t,allowCustomValue:e,onChange:a,onClose:s})=>{const[r,i]=(0,Fn.A)(t,[t]);return(0,b.useEffect)(()=>{i("")},[i,t]),(0,n.jsx)("div",{className:gt,children:(0,n.jsx)(K.l6,{isLoading:r.loading,formatCreateLabel:mt,autoFocus:!0,isOpen:!r.loading,onCloseMenu:s,allowCustomValue:e,options:r.value??[],onChange:a,createOptionPosition:"first"})})},Pn=({loadOptions:t,filterByLoadOptions:e,allowCustomValue:a,onChange:s,onClose:r})=>e?(0,n.jsx)(Nn,{loadOptions:t,allowCustomValue:a,onChange:s,onClose:r}):(0,n.jsx)(Bn,{loadOptions:t,allowCustomValue:a,onChange:s,onClose:r}),Mn=({initialValue:t,onChange:e,onClose:a})=>{const[s,r]=Ee(t);return(0,n.jsx)(C.p,{autoFocus:!0,type:"text",spellCheck:!1,onBlur:a,onKeyDown:i=>{i.key==="Enter"&&e(s)},onChange:i=>{r(i.currentTarget.value)},value:s})},kn=(0,j.css)({width:"auto",cursor:"pointer"}),ie=({value:t,buttonClassName:e,loadOptions:a,filterByLoadOptions:s,allowCustomValue:r,onChange:i})=>{const[o,l]=(0,b.useState)(!1);if(o)return a!==void 0?(0,n.jsx)(Pn,{loadOptions:a,filterByLoadOptions:s??!1,allowCustomValue:r,onChange:u=>{l(!1),i(u)},onClose:()=>{l(!1)}}):(0,n.jsx)(Mn,{initialValue:t,onClose:()=>{l(!1)},onChange:u=>{l(!1),i({value:u,label:u})}});{const u=(0,j.cx)(kn,e);return(0,n.jsx)(W.c,{as:"button",className:u,onClick:()=>{l(!0)},children:t})}},Qn=({policy:t,measurement:e,onChange:a,getPolicyOptions:s,getMeasurementOptions:r})=>{const i=async()=>{const l=await s();return(l.some(c=>c===U)?l:[U,...l]).map(q)},o=async l=>(await r(l)).map(q);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(ie,{allowCustomValue:!0,value:t??"using default policy",loadOptions:i,onChange:l=>{a(l.value,e)}}),(0,n.jsx)(ie,{allowCustomValue:!0,value:e??"select measurement",loadOptions:o,filterByLoadOptions:!0,onChange:l=>{a(t,l.value)}}),e&&(0,n.jsx)(Ge.Z,{style:{marginRight:"4px"},"aria-label":"remove",icon:"times",variant:"secondary",onClick:()=>{a(t,void 0)}})]})},De=({value:t,onChange:e,isWide:a,placeholder:s})=>{const[r,i]=Ee(t),o=()=>{e(r===""?void 0:r)};return(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(C.p,{placeholder:s,className:(0,j.cx)(a??!1?"width-14":"width-8",$e),type:"text",spellCheck:!1,onBlur:o,onChange:l=>{i(l.currentTarget.value)},value:r??""})})},Un=[{label:"ascending",value:"ASC"},{label:"descending",value:"DESC"}],Wn=(0,j.cx)("width-9",$e),Vn=({value:t,onChange:e,inputId:a})=>(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(K.l6,{inputId:a,className:Wn,onChange:s=>{e(ve(s.value))},value:t,options:Un})}),pt=({loadOptions:t,allowCustomValue:e,onAdd:a})=>(0,n.jsx)(ie,{value:"+",loadOptions:t,allowCustomValue:e,onChange:s=>{a(ve(s.value))}}),$n=(0,j.css)({paddingRight:"0",marginRight:"0"}),Gn=(0,j.css)({paddingLeft:"0",paddingRight:"0",marginLeft:"0",marginRight:"0"}),Hn=t=>(0,j.cx)("gf-form-label",(0,j.css)({paddingLeft:"0",lineHeight:t.typography.body.lineHeight,fontSize:t.typography.body.fontSize})),qn=({name:t,params:e,onChange:a})=>{const s=(0,Y.$j)(),r=(0,b.useMemo)(()=>Hn(s),[s]),i=(o,l)=>{const u=e.map(c=>c.value);u[l]=o,a(u)};return(0,n.jsxs)("div",{className:r,children:[(0,n.jsx)("button",{className:(0,j.cx)("gf-form-label",$n),children:t}),"(",e.map((o,l)=>{const{value:u,options:c}=o,p=l===e.length-1,f=c!==null?()=>c().then(y=>y.map(q)):void 0;return(0,n.jsxs)(b.Fragment,{children:[(0,n.jsx)(ie,{allowCustomValue:!0,value:u,buttonClassName:Gn,loadOptions:f,onChange:y=>{i(ve(y.value),l)}}),!p&&","]},l)}),")"]})},xt=({parts:t,getNewPartOptions:e,onAddNewPart:a,onRemovePart:s,onChange:r})=>(0,n.jsxs)(n.Fragment,{children:[t.map((i,o)=>(0,n.jsxs)(b.Fragment,{children:[(0,n.jsx)(qn,{name:i.name,params:i.params,onRemove:()=>{s(o)},onChange:l=>{r(o,l)}}),(0,n.jsx)(Ge.Z,{style:{marginRight:"4px"},"aria-label":"remove",icon:"times",variant:"secondary",onClick:()=>{s(o)}})]},o)),(0,n.jsx)(pt,{loadOptions:e,onAdd:a})]});function yt(t){return/^\/.*\/$/.test(t)}function vt(t){return t.operator??(yt(t.value)?"=~":"=")}function St(t,e){return e?void 0:t.condition??"AND"}function zn(t,e){const a=t==="=~"||t==="!~";return yt(e)?a?t:"=~":a?"=":t}const Kn=["=","!=","<>","<",">",">=","<=","=~","!~","Is","Is Not"],Yn=["AND","OR"],Jn=Kn.map(q),Xn=Yn.map(q),Zn=()=>Promise.resolve(Xn),_n=()=>Promise.resolve(Jn),es=({tag:t,isFirst:e,onRemove:a,onChange:s,getTagKeyOptions:r,getTagValueOptions:i})=>{const o=vt(t),l=St(t,e),u=()=>r().catch(p=>(console.error(p),[])).then(p=>p.map(q)),c=()=>i(t.key).then(p=>p.map(q));return(0,n.jsxs)("div",{className:"gf-form",children:[l!=null&&(0,n.jsx)(ie,{value:l,loadOptions:Zn,onChange:p=>{s({...t,condition:p.value})}}),(0,n.jsx)(ie,{allowCustomValue:!0,value:t.key,loadOptions:u,onChange:p=>{const{value:f}=p;f===void 0?a():s({...t,key:f??""})}}),(0,n.jsx)(ie,{value:o,loadOptions:_n,onChange:p=>{s({...t,operator:p.value})}}),(0,n.jsx)(ie,{allowCustomValue:!0,value:t.value,loadOptions:c,onChange:p=>{const f=p.value??"";s({...t,value:f,operator:zn(o,f)})}}),(0,n.jsx)(Ge.Z,{style:{marginRight:"4px"},"aria-label":"remove",icon:"times",variant:"secondary",onClick:()=>{a()}})]})},ts=({tags:t,onChange:e,getTagKeyOptions:a,getTagValueOptions:s})=>{const r=(u,c)=>{const p=t.map((f,y)=>c===y?u:f);e(p)},i=u=>{const c=t.filter((p,f)=>f!==u);e(c)},o=()=>a().then(u=>u.map(q)),l=(u,c)=>{const p={key:u,value:"select tag value"},f={key:p.key,value:p.value,operator:vt(p),condition:St(p,c)};e([...t,f])};return(0,n.jsxs)(n.Fragment,{children:[t.map((u,c)=>(0,n.jsx)(es,{tag:u,isFirst:c===0,onChange:p=>{r(p,c)},onRemove:()=>{i(c)},getTagKeyOptions:a,getTagValueOptions:s},c)),(0,n.jsx)(pt,{allowCustomValue:!0,loadOptions:o,onAdd:u=>{l(u,t.length===0)}})]})},as=t=>{const e=(0,b.useId)(),a=`influxdb-qe-format-as-${e}`,s=`influxdb-qe-order-by${e}`,r=(0,Y.of)(ns),i=Oa(t.query),{datasource:o}=t,{measurement:l,policy:u}=i,c=(0,b.useMemo)(async()=>{const S=(await Cn(o,l,u)).map(P=>`${P}::tag`),O=(await ct(o,l||"",u)).map(P=>`${P}::field`);return new Set([...S,...O])},[l,u,o]),p=(0,b.useMemo)(()=>{const S=new Map([["field_0",()=>l!==void 0?ct(o,l,u):Promise.resolve([])]]);return(i.select??[]).map(O=>ht(O,S))},[l,u,i.select,o]),f=(0,b.useMemo)(()=>async()=>[...await c],[c]),y=(0,b.useMemo)(()=>{const S=new Map([["tag_0",f]]);return ht(i.groupBy??[],S)},[f,i.groupBy]),v=S=>{t.onChange(S),t.onRunQuery()},D=(S,O)=>{v({...i,policy:S,measurement:O})},T=S=>{v({...i,tags:S.length===0?void 0:S})};return(0,n.jsxs)("div",{children:[(0,n.jsxs)(he.L,{label:"FROM",fill:!0,children:[(0,n.jsx)(Qn,{policy:u,measurement:l,getPolicyOptions:()=>Ve(Sn(o),An),getMeasurementOptions:S=>Ve(c.then(O=>Tn(o,dt(i.tags??[],O),S===""?void 0:S)),ft,S),onChange:D}),(0,n.jsx)(W.c,{width:"auto",className:r.inlineLabel,children:"WHERE"}),(0,n.jsx)(ts,{tags:i.tags??[],onChange:T,getTagKeyOptions:f,getTagValueOptions:S=>Ve(c.then(O=>bn(o,dt(i.tags??[],O),S,l)),ft)})]}),p.map((S,O)=>(0,n.jsx)(he.L,{label:O===0?"SELECT":"",fill:!0,children:(0,n.jsx)(xt,{parts:S,getNewPartOptions:()=>Promise.resolve(In()),onChange:(P,Te)=>{const qe=Ba(i,O,P,Te);v(qe)},onAddNewPart:P=>{v(Fa(i,P,O))},onRemovePart:P=>{v(Na(i,P,O))}})},O)),(0,n.jsx)(he.L,{label:"GROUP BY",fill:!0,children:(0,n.jsx)(xt,{parts:y,getNewPartOptions:()=>En(i,f),onChange:(S,O)=>{const P=ka(i,S,O);v(P)},onAddNewPart:S=>{v(Pa(i,S))},onRemovePart:S=>{v(Ma(i,S))}})}),(0,n.jsxs)(he.L,{label:"TIMEZONE",fill:!0,children:[(0,n.jsx)(De,{placeholder:"(optional)",value:i.tz,onChange:S=>{v({...i,tz:S})}}),(0,n.jsx)(W.c,{htmlFor:s,width:"auto",className:r.inlineLabel,children:"ORDER BY TIME"}),(0,n.jsx)(Vn,{inputId:s,value:i.orderByTime==="DESC"?"DESC":"ASC",onChange:S=>{v({...i,orderByTime:S})}})]}),(0,n.jsxs)(he.L,{label:"LIMIT",fill:!0,children:[(0,n.jsx)(De,{placeholder:"(optional)",value:i.limit?.toString(),onChange:S=>{v({...i,limit:S})}}),(0,n.jsx)(W.c,{width:"auto",className:r.inlineLabel,children:"SLIMIT"}),(0,n.jsx)(De,{placeholder:"(optional)",value:i.slimit?.toString(),onChange:S=>{v({...i,slimit:S})}})]}),(0,n.jsxs)(he.L,{htmlFor:a,label:"FORMAT AS",fill:!0,children:[(0,n.jsx)(Ln,{inputId:a,format:i.resultFormat??lt,onChange:S=>{v({...i,resultFormat:S})}}),i.resultFormat!=="table"&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(W.c,{width:"auto",className:r.inlineLabel,children:"ALIAS"}),(0,n.jsx)(De,{isWide:!0,placeholder:"Naming pattern",value:i.alias,onChange:S=>{v({...i,alias:S})}})]})]})]})};function ns(t){return{inlineLabel:(0,j.css)({color:t.colors.primary.text})}}const ss=({query:t,onChange:e,onRunQuery:a,datasource:s})=>{switch(s.version){case d.Flux:return(0,n.jsx)("div",{className:"gf-form-query-content",children:(0,n.jsx)(Pe,{query:t,onChange:e,datasource:s})});case d.SQL:return(0,n.jsx)(fn,{datasource:s,query:t,onChange:e,onRunQuery:a});case d.InfluxQL:default:return(0,n.jsxs)("div",{className:(0,j.css)({display:"flex"}),children:[(0,n.jsx)("div",{className:(0,j.css)({flexGrow:1}),children:t.rawQuery?(0,n.jsx)(xn,{query:t,onChange:e,onRunQuery:a}):(0,n.jsx)(as,{query:t,onChange:e,onRunQuery:a,datasource:s})}),(0,n.jsx)(mn,{isRaw:t.rawQuery??!1,onChange:r=>{e({...t,query:at(t),rawQuery:r}),a()}})]})}},rs=[{title:"Getting started",label:"Start by selecting a measurement and field from the dropdown above. You can then use the tag selector to further narrow your search."}],is=()=>{const t=(0,Y.of)(os);return(0,n.jsxs)("div",{children:[(0,n.jsx)("h2",{children:"InfluxDB Cheat Sheet"}),rs.map(e=>(0,n.jsxs)("div",{className:t.cheatSheetItem,children:[(0,n.jsx)("div",{className:t.cheatSheetItemTitle,children:e.title}),e.label]},e.title))]})},os=t=>({cheatSheetItem:(0,j.css)({margin:t.spacing(3,0)}),cheatSheetItemTitle:(0,j.css)({fontSize:t.typography.h3.fontSize})});function ls(){return(0,n.jsx)(is,{})}var Tt=h(13288),us=h(88483),cs=h(44240),Se=h(75505),je=h(62467),Ae=h(81160),ds=h(66847),hs=h(41119),X=h(95004),fs=h(33239),gs=h(36580),Ct=h(68143);const ms=t=>{const{query:e,onChange:a}=t,[s,r]=(0,b.useState)(e.query??""),[i,o]=(0,b.useState)(e.textColumn??""),[l,u]=(0,b.useState)(e.tagsColumn??""),[c,p]=(0,b.useState)(e?.timeEndColumn??""),[f]=(0,b.useState)(e?.titleColumn??""),y=(v,D)=>{a({...e,[v]:D,rawQuery:!0,fromAnnotations:!0,textEditor:!0})};return(0,n.jsxs)(G.B,{gap:5,direction:"column",children:[(0,n.jsxs)(G.B,{gap:.5,direction:"column",children:[(0,n.jsxs)(G.B,{gap:0,children:[(0,n.jsx)(se.I,{width:12,children:"InfluxQL Query"}),(0,n.jsx)(C.p,{value:s,onChange:v=>r(v.currentTarget.value??""),onBlur:()=>y("query",s),placeholder:"select text from events where $timeFilter limit 1000"})]}),(0,n.jsx)(se.I,{width:12,tooltip:(0,n.jsx)("div",{children:"If your influxdb query returns more than one field you need to specify the column names below. An annotation event is composed of a title, tags, and an additional text field. Optionally you can map the timeEnd column for region annotation usage."}),children:"Field mappings"}),(0,n.jsxs)(G.B,{gap:.5,alignItems:"flex-start",wrap:"wrap",children:[(0,n.jsxs)(G.B,{gap:0,children:[(0,n.jsx)(se.I,{width:12,children:"Text"}),(0,n.jsx)(C.p,{value:i,onChange:v=>o(v.currentTarget.value??""),onBlur:()=>y("textColumn",i)})]}),(0,n.jsxs)(G.B,{gap:0,children:[(0,n.jsx)(se.I,{width:12,children:"Tags"}),(0,n.jsx)(C.p,{value:l,onChange:v=>u(v.currentTarget.value??""),onBlur:()=>y("tagsColumn",l)})]}),(0,n.jsxs)(G.B,{gap:0,children:[(0,n.jsx)(se.I,{width:12,children:"TimeEnd"}),(0,n.jsx)(C.p,{value:c,onChange:v=>p(v.currentTarget.value??""),onBlur:()=>y("timeEndColumn",c)})]}),(0,n.jsxs)("div",{className:"gf-form ng-hide",children:[(0,n.jsx)(se.I,{width:12,children:"Title"}),(0,n.jsx)(C.p,{defaultValue:f})]})]})]}),(0,n.jsx)("div",{})]})};var bt=h(873);class It{constructor(e){this.series=e.series,this.alias=e.alias,this.annotation=e.annotation,this.meta=e.meta,this.refId=e.refId}getTimeSeries(){const e=[];let a,s;return this.series.length===0||(0,m.each)(this.series,r=>{const i=r.columns.length,o=(0,m.map)(r.tags,(l,u)=>u+": "+l);for(s=1;s<i;s++){let l=r.name;const u=r.columns[s];u!=="value"&&(l=l+"."+u),this.alias?l=this._getSeriesName(r,s):r.tags&&(l=l+" {"+o.join(", ")+"}");const c=[];if(r.values)for(a=0;a<r.values.length;a++)c[a]=[r.values[a][s],r.values[a][0]];e.push({title:l,target:l,datapoints:c,tags:r.tags,meta:this.meta,refId:this.refId})}}),e}_getSeriesName(e,a){const s=/\$(\w+)|\[\[([\s\S]+?)\]\]/g,r=e.name.split(".");return this.alias?.replace(s,(i,o,l)=>{const u=o||l,c=parseInt(u,10);if(u==="m"||u==="measurement")return e.name;if(u==="col")return e.columns[a];if(!isNaN(c))return r[c]??i;if(u.indexOf("tag_")!==0)return i;const p=u.replace("tag_","");return e.tags?e.tags[p]:i})}getAnnotations(){const e=[];return(0,m.each)(this.series,a=>{let s=null,r=null,i=null;const o=[];let l=null;(0,m.each)(a.columns,(u,c)=>{if(u==="time"){r=c;return}if(u!=="sequence_number"){if(u===this.annotation?.titleColumn){s=c;return}if((0,m.includes)((this.annotation?.tagsColumn||"").replace(" ","").split(","),u)){o.push(c);return}if(u===this.annotation?.textColumn){l=c;return}if(u===this.annotation?.timeEndColumn){i=c;return}!s&&l!==c&&(s=c)}}),(0,m.each)(a.values,u=>{const c={annotation:this.annotation,time:+new Date(u[r]),title:u[s],timeEnd:u[i],tags:(0,m.flatten)(o.filter(p=>u[p]).map(p=>u[p].split(","))),text:u[l]};e.push(c)})}),e}getTable(){const e=new bt.A;let a,s;return e.refId=this.refId,e.meta=this.meta,this.series.length===0||(0,m.each)(this.series,(r,i)=>{if(i===0){const o=r.columns[0],l=o==="time"?{text:"Time",type:X.PU.time}:{text:o};for(e.columns.push(l),(0,m.each)((0,m.keys)(r.tags),u=>{e.columns.push({text:u})}),s=1;s<r.columns.length;s++)e.columns.push({text:r.columns[s]})}if(r.values)for(a=0;a<r.values.length;a++){const o=r.values[a],l=[o[0]];if(r.tags)for(const u in r.tags)r.tags.hasOwnProperty(u)&&l.push(r.tags[u]);for(s=1;s<o.length;s++)l.push(o[s]);e.rows.push(l)}}),e}}const ps=t=>{const e={refId:"",query:t.query??"",queryType:"tags",fromAnnotations:!0,tagsColumn:t.tagsColumn??"",textColumn:t.textColumn??"",timeEndColumn:t.timeEndColumn??"",titleColumn:t.titleColumn??"",name:t.name??""};return t.target&&t.target.limit&&(e.limit=t.target.limit),t.target&&t.target.matchAny&&(e.matchAny=t.target.matchAny),t.target&&t.target.tags&&(e.tags=t.target.tags),t.target&&t.target.type&&(e.type=t.target.type),e},xs=t=>(t.target=t.target&&!t.target?.query?ps(t):t.target,t);var ys=h(38866);class vs{parse(e,a){if(!a?.results||a.results.length===0)return[];const s=a.results[0];if(!s.series)return[];const r=e.toLowerCase(),i=r.indexOf("show retention policies")>=0,o=r.indexOf("show field keys")>=0||i,l=new Set;return(0,m.each)(s.series,u=>{(0,m.each)(u.values,c=>{(0,m.isArray)(c)?o?l.add(c[0].toString()):c[1]!==void 0?l.add(c[1].toString()):l.add(c[0].toString()):l.add(c.toString())})}),Array.from(l).map(u=>({text:u}))}getTable(e,a,s){let r=new bt.A;if(e.length>0)if(r.meta={...s,executedQueryString:e[0].meta?.executedQueryString},r.refId=a.refId,r=Ts(e,r,a),e[0].fields[1]&&e[0].fields[1].labels){let i=(0,m.groupBy)(e,u=>u.fields[1].labels?Object.values(u.fields[1].labels):null);const o=Object.keys(i),l=Object.values(i);for(let u=0;u<l.length;u++)r=Et(l[u],r,[...o[u].split(",")])}else r=Et(e,r,[]);return r}async transformAnnotationResponse(e,a,s){const r=(0,ys.bE)(a,[s]);if(!r)return[];const i=this.getTable(r.data,s,{}),o=[];let l=0,u=0,c=0,p=0;const f=[];return(0,m.each)(i.columns,(y,v)=>{if(y.text.toLowerCase()==="time"){u=v;return}if(y.text===e.titleColumn){l=v;return}if(Ss(y.text,e.tagsColumn)){f.push(v);return}if(e.textColumn&&y.text.includes(e.textColumn)){p=v;return}if(y.text===e.timeEndColumn){c=v;return}!l&&p!==v&&(l=v)}),(0,m.each)(i.rows,y=>{const v={annotation:e,time:+new Date(y[u]),title:y[l],timeEnd:y[c],tags:(0,m.flatten)(f.filter(D=>y[D]).map(D=>y[D].split(","))),text:y[p]};o.push(v)}),o}}function Ss(t,e){const a=(e||"").replace(" ","").split(",");for(const s of a)if(s!==""&&t.includes(s))return!0;return!1}function Ts(t,e,a){const s=Cs(a);t[0].fields.forEach(r=>{r.name.toLowerCase()==="time"?e.columns.push({text:"Time",type:X.PU.time}):r.name.toLowerCase()==="value"&&r.labels&&Object.keys(r.labels).forEach(i=>{e.columns.push({text:i})})}),t[0].refId==="metricFindQuery"&&t.forEach(r=>{r.name&&e.columns.push({text:r.name})});for(let r=0;r<s.length;r++)e.columns.push({text:s[r]});return a.rawQuery&&s.length===0&&bs(a.query,t)&&t[0].refId!=="metricFindQuery"&&t.map(r=>{r.name&&e.columns.push({text:r.name})}),e}function Et(t,e,a){const s=t[0].fields[0].values;for(let r=0;r<s.length;r++){const i=s[r],o=t.map(l=>l.fields[1]?l.fields[1].values[r]:null);o.indexOf(null)<0&&e.rows.push([i,...a,...o])}return e}function Cs(t){let e=[];t.select?.forEach(s=>{const r=s.filter(i=>i.type!=="field");if(r.length>0){const i=r.find(o=>o.type==="alias");i?e.push(i.params?.[0].toString()??""):e.push(r[0].type)}else s[0]&&s[0].params&&s[0].params[0]&&e.push(s[0].params[0].toString())});let a=[];return e.forEach(s=>{a.push(Dt(s,s,a,0))}),a}function Dt(t,e,a,s){return a.indexOf(e)>-1?(s++,Dt(t,t+"_"+s,a,s)):e}function bs(t,e){const s=e.map(o=>o.name).every(o=>o&&t?o.split(".").every(u=>t.toLowerCase().includes(u.toLowerCase())):!1),i=["*","SHOW"].some(o=>t?t.toLowerCase().includes(o.toLowerCase()):!1);return s||i}var Is=h(65474),Es=h(48592);const He="InfluxVariableQueryEditor-VariableQuery",Ds=({onChange:t,datasource:e,query:a})=>{const s=r=>typeof r!="string"?r:{refId:He,query:r,...e.version===d.Flux?{maxDataPoints:1e3}:{}};switch(e.version){case d.Flux:return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(Pe,{datasource:e,query:s(a),onChange:r=>{t({...a,query:r.query??""})}}),(0,n.jsx)(N.C,{children:(0,n.jsx)(x.I,{label:"Max Data Points",labelWidth:20,required:!0,grow:!0,"aria-labelledby":"flux-maxdatapoints",tooltip:(0,n.jsx)("div",{children:"Upper boundary of data points will return for the variable query."}),children:(0,n.jsx)(C.p,{id:"influx-sql-variable-maxdatapoints","aria-label":"flux-maxdatapoints",type:"number",defaultValue:a.maxDataPoints??1e3,placeholder:"Default is 1000",onBlur:r=>{t({refId:He,query:a.query,maxDataPoints:Number.parseInt(r.currentTarget.value,10)})}})})})]});default:return(0,n.jsx)(N.C,{children:(0,n.jsx)(x.I,{label:"Query",labelWidth:20,required:!0,grow:!0,"aria-labelledby":"influx-variable-query",children:(0,n.jsx)(it.f,{"aria-label":"influx-variable-query",defaultValue:s(a).query,placeholder:"metric name or tags query",rows:1,onBlur:r=>{t({refId:He,query:r.currentTarget.value??""})}})})})}};class js extends Es.f5{constructor(e,a=(0,pe.w)()){super(),this.datasource=e,this.templateSrv=a,this.editor=Ds}query(e){let a;if(typeof e.targets[0]=="string"?a=e.targets[0]:a=e.targets[0].query,!a)return(0,je.of)({data:[]});const s=this.templateSrv.replace(a,e.scopedVars,this.datasource.interpolateQueryExpr),r=this.datasource.getTimeFilter({rangeRaw:e.range.raw,timezone:e.timezone}),i=s.replace("$timeFilter",r);return(0,Is.H)(this.datasource.metricFindQuery({refId:e.targets[0].refId,query:i,maxDataPoints:e.targets[0].maxDataPoints??1e3},{range:e.range})).pipe((0,Ae.T)(l=>({data:l})))}}class As extends gs.iy{constructor(e,a=(0,pe.w)()){super(e),this.templateSrv=a,this.type="influxdb",this.urls=(e.url??"").split(",").map(r=>r.trim()),this.username=e.username??"",this.password=e.password??"",this.name=e.name,this.basicAuth=e.basicAuth,this.withCredentials=e.withCredentials,this.access=e.access;const s=e.jsonData??{};this.database=s.dbName??e.database,this.interval=s.timeInterval,this.showTagTime=s.showTagTime||"",this.httpMode=s.httpMode||"GET",this.responseParser=new vs,this.version=s.version??d.InfluxQL,this.isProxyAccess=e.access==="proxy",this.variables=new js(this,this.templateSrv),this.version===d.Flux?this.annotations={QueryEditor:Pe}:this.annotations={QueryEditor:ms,prepareAnnotation:xs}}query(e){if(!this.isProxyAccess){const a=new Error(H);return(0,Tt.$)(()=>a)}return this._query(e)}_query(e){const a={...e,targets:e.targets.filter(s=>s.hide!==!0)};if(a.targets.some(s=>s.fromAnnotations)){const s=[];for(const r of a.targets)r.query&&s.push(new us.c(i=>{this.annotationEvents(a,r).then(o=>i.next({data:[(0,hs.Vc)(o)]})).catch(o=>i.error(new Error(o))).finally(()=>i.complete())}));return(0,cs.h)(...s)}return this.version===d.InfluxQL&&!this.isMigrationToggleOnAndIsAccessProxy()?this.classicQuery(e):super.query(a)}getQueryDisplayText(e){switch(this.version){case d.Flux:return e.query;case d.SQL:return st(e);case d.InfluxQL:return new Z(e).render(!1);default:return""}}filterQuery(e){return this.version===d.Flux?!!e.query:!0}applyTemplateVariables(e,a,s){const r=a||{};return r.__interval={value:"$__interval"},r.__interval_ms={value:"$__interval_ms"},this.version===d.Flux?{...e,query:this.templateSrv.replace(e.query??"",r)}:((this.version===d.SQL||this.isMigrationToggleOnAndIsAccessProxy())&&(e=this.applyVariables(e,r,s),e.adhocFilters?.length&&(e.adhocFilters=(e.adhocFilters??[]).map(i=>{const{condition:o,...l}=i;return l.value=this.templateSrv.replace(l.value??"",r),l}),e.tags=[...e.tags??[],...e.adhocFilters])),e)}targetContainsTemplate(e){const a=this.version===d.Flux?e.query:at(e);return this.templateSrv.containsTemplate(a)}interpolateVariablesInQueries(e,a,s){return!e||e.length===0?[]:e.map(r=>{if(this.version===d.Flux)return{...r,datasource:this.getRef(),query:this.templateSrv.replace(r.query??"",a,(o=[],l)=>this.interpolateQueryExpr(o,l,r.query))};const i=this.applyVariables(r,a,s);return i.adhocFilters?.length&&(i.adhocFilters=(i.adhocFilters??[]).map(o=>{const{condition:l,...u}=o;return u.value=this.templateSrv.replace(u.value??"",a),u}),i.tags=[...i.tags??[],...i.adhocFilters]),{...i,datasource:this.getRef()}})}applyVariables(e,a,s){const r={...e};return e.groupBy&&(r.groupBy=e.groupBy.map(i=>({...i,params:i.params?.map(o=>this.templateSrv.replace(o.toString(),void 0))}))),e.select&&(r.select=e.select.map(i=>i.map(o=>({...o,params:o.params?.map(l=>this.templateSrv.replace(l.toString(),a))})))),e.tags&&(r.tags=e.tags.map(i=>(i.operator!=="=~"&&i.operator!=="!~"&&(i.value=Ie(i.value)),{...i,key:this.templateSrv.replace(i.key,a),value:this.templateSrv.replace(i.value??"",a,(o=[],l)=>this.interpolateQueryExpr(o,l,i.value))}))),{...r,adhocFilters:s??[],query:this.templateSrv.replace(e.query??"",a,(i=[],o)=>this.interpolateQueryExpr(i,o,e.query)),rawSql:this.templateSrv.replace(e.rawSql??"",a,(i=[],o)=>this.interpolateQueryExpr(i,o,e.rawSql)),alias:this.templateSrv.replace(e.alias??"",a),limit:this.templateSrv.replace(e.limit?.toString()??"",a),measurement:this.templateSrv.replace(e.measurement??"",a,(i=[],o)=>this.interpolateQueryExpr(i,o,e.measurement)),policy:this.templateSrv.replace(e.policy??"",a),slimit:this.templateSrv.replace(e.slimit?.toString()??"",a),tz:this.templateSrv.replace(e.tz??"",a)}}interpolateQueryExpr(e=[],a,s){if(typeof e=="string"&&!isNaN(parseFloat(e)))return e;if(a.multi)return typeof e=="string"?isNaN(parseFloat(e))?(0,ue.$f)(e):e:`(${e.map(l=>(0,ue.$f)(l)).join("|")})`;const r=new RegExp(/(\s*(=|!)~\s*)\/((?![*+?])(?:[^\r\n\[/\\]|\\.|\[(?:[^\r\n\]\\]|\\.)*\])+)\/((?:g(?:im?|mi?)?|i(?:gm?|mg?)?|m(?:gi?|ig?)?)?)/,"gm"),i=new RegExp(`\\/(?:\\^)?(.*)(\\$${a.name})(.*)(?:\\$)?\\/`,"gm");if(!s||typeof s!="string")return e;const o=s.match(r);if(!o)return e;for(const l of o)if(l.match(i))return typeof e=="string"?(0,ue.$f)(e):`(${e.map(u=>(0,ue.$f)(u)).join("|")})`;return e}async runMetadataQuery(e){return(0,Se.s)(super.query({targets:[e]})).then(this.toMetricFindValue)}async metricFindQuery(e,a){if(this.version===d.Flux||this.version===d.SQL||this.isMigrationToggleOnAndIsAccessProxy()){const r={refId:"metricFindQuery",query:e.query,rawQuery:!0,...this.version===d.SQL?{rawSql:e.query,format:re.gv.Table}:{}};return(0,Se.s)(super.query({...a??{},maxDataPoints:e.maxDataPoints,targets:[r]})).then(this.toMetricFindValue)}const s=this.templateSrv.replace(e.query,a?.scopedVars,(r=[],i)=>this.interpolateQueryExpr(r,i,e.query));return(0,Se.s)(this._seriesQuery(s,a)).then(r=>this.responseParser.parse(e.query,r))}toMetricFindValue(e){const a=new Map;return e?.data?.forEach(s=>{if(s&&s.length>0){let r=s.fields.find(i=>i.type===X.PU.string);r||(r=s.fields.find(i=>i.type!==X.PU.time)),r&&r.values.forEach(i=>{a.set(i.toString(),{text:i.toString()})})}}),Array.from(a.values())}getTagKeys(e){const a=We({type:"TAG_KEYS",templateService:this.templateSrv,database:this.database,withTimeFilter:this.showTagTime});return this.metricFindQuery({refId:"get-tag-keys",query:a})}getTagValues(e){const a=We({type:"TAG_VALUES",templateService:this.templateSrv,database:this.database,withKey:e.key,withTimeFilter:this.showTagTime});return this.metricFindQuery({refId:"get-tag-values",query:a})}_seriesQuery(e,a){if(!e)return(0,je.of)({results:[]});if(a&&a.range){const s=this.getTimeFilter({rangeRaw:a.range,timezone:a.timezone});e=e.replace("$timeFilter",s)}return this._influxRequest(this.httpMode,"/query",{q:e,epoch:"ms"},a)}serializeParams(e){return e?(0,m.reduce)(e,(a,s,r)=>(s==null||a.push(encodeURIComponent(r)+"="+encodeURIComponent(s)),a),[]).join("&"):""}_influxRequest(e,a,s,r){const i=this.urls.shift();this.urls.push(i);const o={};this.username&&(o.u=this.username,o.p=this.password),r&&r.database?o.db=r.database:this.database&&(o.db=this.database),r?.policy&&r.policy!==U&&(o.rp=r.policy);const{q:l}=s;e==="POST"&&(0,m.has)(s,"q")?((0,m.extend)(o,(0,m.omit)(s,["q"])),s=this.serializeParams((0,m.pick)(s,["q"]))):(e==="GET"||e==="POST")&&((0,m.extend)(o,s),s=null);const u={method:e,url:i+a,params:o,data:s,precision:"ms",inspect:{type:"influxdb"},paramSerializer:this.serializeParams};return u.headers=u.headers||{},(this.basicAuth||this.withCredentials)&&(u.withCredentials=!0),this.basicAuth&&(u.headers.Authorization=this.basicAuth),e==="POST"&&(u.headers["Content-type"]="application/x-www-form-urlencoded"),(0,Ct.AI)().fetch(u).pipe((0,Ae.T)(c=>{const{data:p}=c;if(p&&(p.executedQueryString=l,p.results)){const f=c.data.results.filter(y=>y.error);if(f.length>0)throw{message:"InfluxDB Error: "+f[0].error,data:p}}return p}),(0,ds.W)(c=>c.cancelled?(0,je.of)(c):(0,Tt.$)(this.handleErrors(c))))}handleErrors(e){const a={message:e&&e.status||e&&e.message||"Unknown error during query transaction. Please check JS console logs."};return(Number.isInteger(e.status)&&e.status!==0||e.status>=300)&&(e.data&&e.data.error?(a.message="InfluxDB Error: "+e.data.error,a.data=e.data,a.config=e.config):(a.message="Network Error: "+e.statusText+"("+e.status+")",a.data=e.data,a.config=e.config)),a}getTimeFilter(e){const a=this.getInfluxTime(e.rangeRaw.from,!1,e.timezone),s=this.getInfluxTime(e.rangeRaw.to,!0,e.timezone);return"time >= "+a+" and time <= "+s}getInfluxTime(e,a,s){let r;if((0,m.isString)(e)){if(e==="now")return"now()";const i=/^now-(\d+)([dhms])$/.exec(e);if(i){const o=parseInt(i[1],10),l=i[2];return"now() - "+o+l}if(r=fs.parse(e,a,s),!r)throw new Error("unable to parse date");e=r}return e.valueOf()+"ms"}isMigrationToggleOnAndIsAccessProxy(){return ut.Ay.featureToggles.influxdbBackendMigration&&this.access==="proxy"}classicQuery(e){let a=this.getTimeFilter(e);const s=e.scopedVars,r=(0,m.cloneDeep)(e.targets),i=[];let o,l,u=(0,m.map)(r,f=>f.hide?"":(i.push(f),s.interval=s.__interval,new Z(f,this.templateSrv,s).render(!0))).reduce((f,y)=>(y!==""&&(f+=";"+y),f));if(u==="")return(0,je.of)({data:[]});const c=e.filters,p=e.targets.flatMap(f=>f.adhocFilters??[]);if(c?.length||p?.length){const f=c?.length?c:p,y=new Z({refId:"A"},this.templateSrv,s);a+=" AND "+y.renderAdhocFilters(f)}return s.timeFilter={value:a},u=this.templateSrv.replace(u,s),this._seriesQuery(u,e).pipe((0,Ae.T)(f=>{if(!f||!f.results)return{data:[]};const y=[];for(o=0;o<f.results.length;o++){const v=f.results[o];if(!v||!v.series)continue;const D=i[o];let T=D.alias;T&&(T=this.templateSrv.replace(D.alias,e.scopedVars));const S={executedQueryString:f.executedQueryString},O=new It({refId:D.refId,series:f.results[o].series,alias:T,meta:S});switch(D.resultFormat){case"logs":S.preferredVisualisationType="logs";case"table":{y.push(O.getTable());break}default:{const P=O.getTimeSeries();for(l=0;l<P.length;l++)y.push(Ls(P[l]));break}}}return{data:y}}))}async annotationEvents(e,a){if(this.version===d.Flux)return Promise.reject({message:"Flux requires the standard annotation query"});if(!a.query)return Promise.reject({message:"Query missing in annotation definition"});if(this.isMigrationToggleOnAndIsAccessProxy()){const i={refId:"metricFindQuery",datasource:this.getRef(),query:this.templateSrv.replace(a.query,void 0,(o=[],l)=>this.interpolateQueryExpr(o,l,a.query)),rawQuery:!0};return(0,Se.s)((0,Ct.AI)().fetch({url:"/api/ds/query",method:"POST",headers:this.getRequestHeaders(),data:{from:e.range.from.valueOf().toString(),to:e.range.to.valueOf().toString(),queries:[i]},requestId:a.name}).pipe((0,Ae.T)(async o=>await this.responseParser.transformAnnotationResponse(a,o,i))))}const s=this.getTimeFilter({rangeRaw:e.range.raw,timezone:e.timezone});let r=a.query.replace("$timeFilter",s);return r=this.templateSrv.replace(r,void 0,(i=[],o)=>this.interpolateQueryExpr(i,o,r)),(0,Se.s)(this._seriesQuery(r,e)).then(i=>{if(!i||!i.results||!i.results[0])throw{message:"No results in response from InfluxDB"};return new It({series:i.results[0].series,annotation:a}).getAnnotations()})}}function ws(t){const e=t.find(s=>s!==null);if(e===void 0)return X.PU.number;const a=typeof e;switch(a){case"string":return X.PU.string;case"boolean":return X.PU.boolean;case"number":return X.PU.number;default:throw new Error(`InfluxQL: invalid value type ${a}`)}}function Ls(t){const e=[],a=[],s=t.datapoints;for(const l of s)a.push(l[0]),e.push(l[1]);const r={name:X.LE,type:X.PU.time,config:{},values:e},i={name:X.Bc,type:ws(a),config:{displayNameFromDS:t.title},values:a,labels:t.tags},o=[r,i];return{name:t.target,refId:t.refId,meta:t.meta,fields:o,length:a.length}}const Rs=z.$.featureToggles.newInfluxDSConfigPageDesign?Da:Wt,Os=new ce.tD(As).setConfigEditor(Rs).setQueryEditor(ss).setQueryEditorHelp(ls)},70985:(we,te,h)=>{h.d(te,{q:()=>z});var ce=h(96540),z=(n=>(n.NoAuth="NoAuth",n.BasicAuth="BasicAuth",n.OAuthForward="OAuthForward",n.CrossSiteCredentials="CrossSiteCredentials",n))(z||{})},76229:(we,te,h)=>{h.d(te,{pe:()=>I});var ce=h(96540),z=h(22803),n=h(70985);const m="httpHeaderName",b="httpHeaderValue";function I({config:g,onChange:x}){return{selectedMethod:_(g),onAuthMethodSelect:F(g,x),basicAuth:K(g,x),TLS:ee(g,x),customHeaders:fe(g,x),readOnly:g.readOnly}}function _(g){return g.basicAuth?n.q.BasicAuth:g.withCredentials?n.q.CrossSiteCredentials:g.jsonData.oauthPassThru?n.q.OAuthForward:n.q.NoAuth}function F(g,x){return C=>{x({...g,basicAuth:C===n.q.BasicAuth,withCredentials:C===n.q.CrossSiteCredentials,jsonData:{...g.jsonData,oauthPassThru:C===n.q.OAuthForward}})}}function K(g,x){return{user:g.basicAuthUser,passwordConfigured:g.secureJsonFields.basicAuthPassword,onUserChange:C=>x({...g,basicAuthUser:C}),onPasswordChange:C=>x({...g,secureJsonData:{...g.secureJsonData,basicAuthPassword:C}}),onPasswordReset:()=>x({...g,secureJsonData:{...g.secureJsonData,basicAuthPassword:""},secureJsonFields:{...g.secureJsonFields,basicAuthPassword:!1}})}}function ee(g,x){var C,H,U;return{selfSignedCertificate:{enabled:!!g.jsonData.tlsAuthWithCACert,certificateConfigured:!!((C=g.secureJsonFields)!=null&&C.tlsCACert),onToggle:d=>x(d?{...g,jsonData:{...g.jsonData,tlsAuthWithCACert:d}}:{...g,jsonData:{...g.jsonData,tlsAuthWithCACert:d},secureJsonData:{...g.secureJsonData,tlsCACert:""},secureJsonFields:{...g.secureJsonFields,tlsCACert:!1}}),onCertificateChange:d=>x({...g,secureJsonData:{...g.secureJsonData,tlsCACert:d}}),onCertificateReset:()=>x({...g,secureJsonData:{...g.secureJsonData,tlsCACert:""},secureJsonFields:{...g.secureJsonFields,tlsCACert:!1}})},TLSClientAuth:{enabled:g.jsonData.tlsAuth,serverName:g.jsonData.serverName,clientCertificateConfigured:!!((H=g.secureJsonFields)!=null&&H.tlsClientCert),clientKeyConfigured:!!((U=g.secureJsonFields)!=null&&U.tlsClientKey),onToggle:d=>x(d?{...g,jsonData:{...g.jsonData,tlsAuth:d}}:{...g,jsonData:{...g.jsonData,tlsAuth:d,serverName:""},secureJsonData:{...g.secureJsonData,tlsClientCert:"",tlsClientKey:""},secureJsonFields:{...g.secureJsonFields,tlsClientCert:!1,tlsClientKey:!1}}),onServerNameChange:d=>x({...g,jsonData:{...g.jsonData,serverName:d}}),onClientCertificateChange:d=>x({...g,secureJsonData:{...g.secureJsonData,tlsClientCert:d}}),onClientCertificateReset:()=>x({...g,secureJsonData:{...g.secureJsonData,tlsClientCert:""},secureJsonFields:{...g.secureJsonFields,tlsClientCert:!1}}),onClientKeyChange:d=>x({...g,secureJsonData:{...g.secureJsonData,tlsClientKey:d}}),onClientKeyReset:()=>x({...g,secureJsonData:{...g.secureJsonData,tlsClientKey:""},secureJsonFields:{...g.secureJsonFields,tlsClientKey:!1}})},skipTLSVerification:{enabled:g.jsonData.tlsSkipVerify,onToggle:d=>x({...g,jsonData:{...g.jsonData,tlsSkipVerify:d}})}}}function fe(g,x){return{headers:Object.keys(g.jsonData).filter(H=>H.startsWith(m)).sort().map(H=>{var U;const d=H.slice(m.length);return{name:g.jsonData[H],configured:(U=g.secureJsonFields[`${b}${d}`])!=null?U:!1}}),onChange:H=>{const U=Object.fromEntries(Object.entries(g.jsonData).filter(([M])=>!M.startsWith(m))),d=Object.fromEntries(Object.entries(g.secureJsonData||{}).filter(([M])=>!M.startsWith(b))),N=Object.fromEntries(Object.entries(g.secureJsonFields).filter(([M])=>!M.startsWith(b)));H.forEach((M,k)=>{U[`${m}${k+1}`]=M.name,M.configured?N[`${b}${k+1}`]=!0:d[`${b}${k+1}`]=M.value}),x({...g,jsonData:U,secureJsonData:d,secureJsonFields:N})}}}}}]);

//# sourceMappingURL=influxdbPlugin.9ddd5f36f2fced5908b8.js.map