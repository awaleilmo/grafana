"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9604],{32776:(Xt,Pe,l)=>{l.d(Pe,{S5:()=>ct,fq:()=>oe,gy:()=>N,l1:()=>Tt});var e=l(2543),u=l.n(e),d=l(57866),a=l(4575),P=l(33553),k=l(95004);const oe=b=>(!b.pluginVersion&&"columns"in b&&console.log("Was angular table",b),Ve(b),ye(b),ue(b),b.options),Rt={timeseries_to_rows:"seriesToRows",timeseries_to_columns:"seriesToColumns",timeseries_aggregations:"reduce",table:"merge"},_t={avg:"mean",min:"min",max:"max",total:"sum",current:"lastNotNull",count:"count"},$e={cell:"color-background",row:"color-background",value:"color-text"},it=(b,$)=>[-1/0,...b].map((O,Z)=>({color:$[Z],value:(0,e.isNumber)(O)?O:parseInt(O,10)})),A=(b,$)=>{const O=b.transformations??[];if(Object.keys(Rt).includes($.transform)){const Z={reducers:[]};$.transform==="timeseries_aggregations"&&(Z.includeTimeField=!1,Z.reducers=$.columns.map(Ie=>_t[Ie.value])),O.push({id:Rt[$.transform],options:Z})}return O},Ge=b=>{const O={matcher:{id:/^\/.*\/$/.test(b.pattern)?d.Ct.byRegexp:d.Ct.byName,options:b.pattern},properties:[]};return b.alias&&O.properties.push({id:"displayName",value:b.alias}),b.unit&&O.properties.push({id:"unit",value:b.unit}),b.decimals!==void 0&&O.properties.push({id:"decimals",value:b.decimals}),b.type==="date"&&O.properties.push({id:"unit",value:`time: ${b.dateFormat}`}),b.type==="hidden"&&O.properties.push({id:"custom.hidden",value:!0}),b.link&&O.properties.push({id:"links",value:[{title:(0,e.defaultTo)(b.linkTooltip,""),url:(0,e.defaultTo)(b.linkUrl,""),targetBlank:(0,e.defaultTo)(b.linkTargetBlank,!1)}]}),b.colorMode&&O.properties.push({id:"custom.cellOptions",value:{type:$e[b.colorMode]}}),b.align&&O.properties.push({id:"custom.align",value:b.align==="auto"?null:b.align}),b.thresholds?.length&&b.colors?.length&&O.properties.push({id:"thresholds",value:{mode:P.O.Absolute,steps:it(b.thresholds,b.colors)}}),O},eo=b=>{let $={custom:{}};if(b){if($=(0,e.omitBy)({unit:b.unit,decimals:b.decimals,displayName:b.alias,custom:{align:b.align==="auto"?null:b.align}},e.isNil),b.thresholds&&b.thresholds.length){const O={mode:P.O.Absolute,steps:it(b.thresholds,b.colors)};$.thresholds=O}b.colorMode&&($.custom.cellOptions={type:$e[b.colorMode]})}return $},Tt=(b,$,O)=>{if($==="table-old"&&O.angular){const Z=O.angular,Ie=A(b,Z),_=Z.styles.find(me=>me.pattern==="/.*/"),dt=eo(_),Ze=Z.styles.filter(me=>me.pattern!=="/.*/").map(Ge);b.transformations=Ie,b.fieldConfig={defaults:dt,overrides:Ze}}return{}},lt=b=>b?.filter($=>$.meta?.custom?.parentRowIndex===void 0)||[b?.[0]],ct=b=>{const $=[];return lt(b).filter(Z=>!!Z&&Z.length!==0)?.forEach(Z=>{const Ie=b?.filter(me=>Z.refId===me.refId&&me.meta?.custom?.parentRowIndex!==void 0),_=(0,e.groupBy)(Ie,me=>me.meta?.custom?.parentRowIndex),dt=Object.keys(_).map(me=>_[me]),Ze={...Z};Ie&&Ie.length>0&&Ze.fields.push({name:"nested",type:k.PU.nestedFrames,config:{},values:dt}),$.push(Ze)}),$},N=b=>b?.some($=>$.meta?.custom?.parentRowIndex!==void 0),Ve=b=>{if(b.fieldConfig?.defaults.custom?.wrapText!==void 0)return;const $=b.fieldConfig?.defaults.custom?.cellOptions?.wrapText;return b.fieldConfig.overrides=b.fieldConfig.overrides.map(O=>(O.properties&&(O.properties=O.properties.flatMap(Z=>Z.id==="custom.cellOptions"&&Z.value&&Z.value.wrapText!==void 0?[{...Z,value:{...(0,e.omit)(Z.value,"wrapText")}},{id:"custom.wrapText",value:Z.value.wrapText}]:[Z])),O)),b.fieldConfig.defaults.custom=b.fieldConfig.defaults.custom??{},b.fieldConfig.defaults.custom.wrapText=$,delete b.fieldConfig.defaults.custom.cellOptions?.wrapText,b},ye=b=>(b.fieldConfig.overrides=b.fieldConfig.overrides.map($=>($.properties&&($.properties=$.properties.map(O=>O.id==="custom.hidden"?{...O,id:"custom.hideFrom.viz"}:O)),$)),b),ue=b=>{if(b.options&&"footer"in b.options){const $=b.options.footer;if($.show){const O=$.reducer;b.fieldConfig.defaults.custom={...b.fieldConfig.defaults.custom,footer:{reducers:O}},$.countRows&&O[0]==="count"?b.fieldConfig.defaults.custom.footer.reducers=["countAll"]:$.fields&&$.fields.length>1?(delete b.fieldConfig.defaults.custom.footer,b.fieldConfig.overrides.push({matcher:{id:d.Ct.byNames,options:{mode:a.PP.include,names:$.fields}},properties:[{id:"custom.footer.reducers",value:O}]})):$.fields&&$.fields.length===1&&(delete b.fieldConfig.defaults.custom.footer,b.fieldConfig.overrides.push({matcher:{id:d.Ct.byName,options:$.fields[0]},properties:[{id:"custom.footer.reducers",value:O}]}))}$.enablePagination!=null&&(b.options.enablePagination=$.enablePagination),delete b.options.footer}}},55712:(Xt,Pe,l)=>{l.r(Pe),l.d(Pe,{default:()=>Bi});var e=l(74848),u=l(22803),d=l(96540),a=l(92745),P=l(43173),k=l(63142),oe=l(36303),Rt=l(6975),_t=l(77808),$e=l(27963),it=l(45776),A=l(52763),Ge=l(2739),eo=function(t,o){t===void 0&&(t=!0);var s=(0,d.useCallback)(function(n){var r=typeof t=="function"?t():!0;if(r)return n.preventDefault(),o&&(n.returnValue=o),o},[t,o]);(0,d.useEffect)(function(){if(t)return(0,Ge.on)(window,"beforeunload",s),function(){return(0,Ge.AU)(window,"beforeunload",s)}},[t,s])};const Tt=eo;var lt=l(64305),ct=l(6773),N=l(27489),Ve=l(41654),ye=l(45967),ue=l(30703),b=l(45861),$=l(83560),O=l(72265),Z=l(22787);const Ie=({onSave:t,onDiscard:o,onCancel:s,message:n})=>(0,e.jsxs)(Z.a,{isOpen:!0,title:(0,a.t)("explore.correlation-unsaved-changes-modal.title-unsaved-changes-to-correlation","Unsaved changes to correlation"),onDismiss:s,icon:"exclamation-triangle",className:(0,u.css)({width:"600px"}),children:[(0,e.jsx)("h5",{children:n}),(0,e.jsxs)(Z.a.ButtonRow,{children:[(0,e.jsx)(b.$n,{variant:"secondary",onClick:s,fill:"outline",children:(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-unsaved-changes-modal.cancel",children:"Cancel"})}),(0,e.jsx)(b.$n,{variant:"destructive",onClick:o,children:(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-unsaved-changes-modal.continue-without-saving",children:"Continue without saving"})}),(0,e.jsx)(b.$n,{variant:"primary",onClick:t,children:(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-unsaved-changes-modal.save-correlation",children:"Save correlation"})})]})]});var _=l(2543),dt=(t=>(t.SOURCE_TARGET_CHANGE="cause the query in the right pane to be re-ran and links added to that data",t.FULL_QUERY_LOSS="lose the changed query",t.FULL_CORR_LOSS="cause the correlation in progress to be lost",t.INVALID_VAR="remove the variables, and your changed query may no longer be valid",t))(dt||{});const Ze=(t,o,s,n)=>{const r=(0,_.template)("<%= actionStr %> will <%= consequenceStr %>. Would you like to save before continuing?");let i="",c="";if(t===O.IW.CLOSE_PANE)if(i="Closing the pane",o)if(s)c="cause the correlation in progress to be lost";else if(n)c="cause the query in the right pane to be re-ran and links added to that data";else return;else if(s)c="cause the correlation in progress to be lost";else if(n)c="lose the changed query";else return;else if(t===O.IW.CHANGE_DATASOURCE)if(i="Changing the datasource",o)if(s)c="cause the correlation in progress to be lost";else return;else if(n)c="lose the changed query";else return;else if(t===O.IW.CLOSE_EDITOR)if(i="Closing the editor",s)c="cause the correlation in progress to be lost";else if(n)c="remove the variables, and your changed query may no longer be valid";else return;return r({actionStr:i,consequenceStr:c})};var me=l(80763),Ee=l(707),ve=l(51845),q=l(35231),z=l(19050),U=l(20718);const Ys=({panes:t})=>{const o=(0,A.wA)(),s=(0,k.of)(Js),n=(0,A.d4)(U.vC),r=(0,A.d4)(U.st),[i,c]=(0,d.useState)(void 0);Tt(n?.correlationDirty||!1,"Save correlation?"),Tt(!n?.correlationDirty&&n?.queryEditorDirty||!1,"The query editor was changed. Save correlation before continuing?"),(0,d.useEffect)(()=>{if(n?.isExiting){const{correlationDirty:g,queryEditorDirty:f}=n;let y,T;n.postConfirmAction?(y=n.postConfirmAction.isActionLeft,T=n.postConfirmAction.action):(T=O.IW.CLOSE_EDITOR,y=!1);const v=Ze(T,y,g,f);if(v!==void 0)c(v);else if(T===O.IW.CHANGE_DATASOURCE&&n.postConfirmAction){const{exploreId:j,changeDatasourceUid:R}=n?.postConfirmAction;j&&R&&(o((0,Ee.wh)({exploreId:j,datasource:R,options:{importQueries:!0}})),o((0,q.am)({isExiting:!1})))}else if(T===O.IW.CLOSE_PANE&&n.postConfirmAction){const{exploreId:j}=n?.postConfirmAction;j!==void 0&&(o((0,q.J8)(j)),o((0,q.am)({isExiting:!1})))}else T===O.IW.CLOSE_EDITOR&&o((0,q.am)({editorMode:!1}))}},[n,o,r]),(0,lt.A)(()=>{o((0,q.am)({editorMode:!1,isExiting:!1,correlationDirty:!1,label:void 0,description:void 0,canSave:!1})),t.forEach(g=>{o((0,ve.nE)({exploreId:g[0],correlationEditorHelperData:void 0})),o((0,z.Od)({exploreId:g[0]}))})});const h=()=>{o((0,q.am)({editorMode:!0,isExiting:!1,correlationDirty:!1,label:void 0,description:void 0,canSave:!1})),t.forEach(g=>{o((0,ve.nE)({exploreId:g[0],correlationEditorHelperData:void 0})),o((0,z.Od)({exploreId:g[0]}))})},m=g=>{c(void 0),o((0,q.J8)(g)),(0,N.rR)("grafana_explore_split_view_closed")},x=(g,f)=>{c(void 0),o((0,Ee.wh)({exploreId:g,datasource:f,options:{importQueries:!0}}))},p=g=>{if(o((0,me.v)(n?.label,n?.description,n?.transformations)),!g&&n?.postConfirmAction!==void 0){const{exploreId:f,action:y,changeDatasourceUid:T}=n?.postConfirmAction;y===O.IW.CLOSE_PANE?(m(f),h()):y===O.IW.CHANGE_DATASOURCE&&T!==void 0&&((0,Ee.wh)({exploreId:f,datasource:T}),h())}else o((0,q.am)({editorMode:!1,correlationDirty:!1,isExiting:!1}))};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)($.X,{message:g=>g.pathname!=="/explore"&&n?.editorMode&&n?.correlationDirty?"You have unsaved correlation data. Continue?":!0}),i!==void 0&&(0,e.jsx)(Ie,{onDiscard:()=>{if(n?.postConfirmAction!==void 0){const{exploreId:g,action:f,changeDatasourceUid:y}=n?.postConfirmAction;f===O.IW.CLOSE_PANE?m(g):f===O.IW.CHANGE_DATASOURCE&&y!==void 0&&x(g,y),o((0,q.am)({isExiting:!1}))}else o((0,q.am)({editorMode:!1,correlationDirty:!1,isExiting:!1}))},onCancel:()=>{o((0,q.am)({isExiting:!1})),c(void 0)},onSave:()=>{p(!1)},message:i}),(0,e.jsx)("div",{className:s.correlationEditorTop,children:(0,e.jsxs)(Ve.B,{gap:2,justifyContent:"flex-end",alignItems:"center",children:[(0,e.jsx)(ye.m,{content:(0,a.t)("explore.correlation-editor-mode-bar.content-correlations-editor-explore-experimental-feature","Correlations editor in Explore is an experimental feature."),children:(0,e.jsx)(ue.I,{className:s.iconColor,name:"info-circle",size:"xl"})}),(0,e.jsx)(b.$n,{variant:"secondary",disabled:!n?.canSave,fill:"outline",className:n?.canSave?s.buttonColor:s.disabledButtonColor,onClick:()=>{p(!0)},children:(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-editor-mode-bar.save",children:"Save"})}),(0,e.jsx)(b.$n,{variant:"secondary",fill:"outline",className:s.buttonColor,icon:"times",onClick:()=>{o((0,q.am)({isExiting:!0})),(0,N.rR)("grafana_explore_correlation_editor_exit_pressed")},children:(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-editor-mode-bar.exit-correlation-editor",children:"Exit correlation editor"})})]})})]})},Js=t=>{const o=t.colors.getContrastText(t.colors.primary.main),s=ct.MV.lighten(t.colors.primary.main,.1),n=ct.MV.darken(t.colors.primary.main,.2),r=ct.MV.darken(o,.2);return{correlationEditorTop:(0,u.css)({backgroundColor:t.colors.primary.main,marginTop:"3px",padding:t.spacing(1)}),iconColor:(0,u.css)({color:o}),buttonColor:(0,u.css)({color:o,borderColor:o,"&:hover":{color:o,borderColor:o,backgroundColor:s}}),disabledButtonColor:(0,u.css)({color:`${r} !important`,backgroundColor:`${n} !important`})}};var to=l(1503),ut=l(15130),Ye=l(18615),Je=l(11257);const Xs=()=>{const[t,o]=(0,d.useState)([]),{query:s}=(0,to.useKBar)(),n=(0,A.wA)(),r=(0,A.d4)(U.Qb),i=(0,A.d4)(U.pF),c=ut.TP.hasPermission(Je.w.DataSourcesWrite);return(0,d.useEffect)(()=>{const h=Object.keys(r),m={name:"Explore",priority:to.Priority.HIGH+1},x=[];if(i)x.push({id:"explore/run-query-left",name:"Run query (left)",keywords:"query left",perform:()=>{n((0,z.Od)({exploreId:h[0]}))},section:m}),r[1]&&(x.push({id:"explore/run-query-right",name:"Run query (right)",keywords:"query right",perform:()=>{n((0,z.Od)({exploreId:h[1]}))},section:m}),x.push({id:"explore/split-view-close-left",name:"Close split view left",keywords:"split",perform:()=>{n((0,q.J8)(h[0]))},section:m}),x.push({id:"explore/split-view-close-right",name:"Close split view right",keywords:"split",perform:()=>{n((0,q.J8)(h[1]))},section:m}));else{const p=Object.values(r).some(g=>g?.datasourceInstance?.uid===Ye.uv);P.$.featureToggles.correlations&&c&&!p&&x.push({id:"explore/correlations-editor",name:"Correlations editor",perform:()=>{n((0,q.am)({editorMode:!0})),n((0,z.Od)({exploreId:h[0]}))},section:m}),x.push({id:"explore/run-query",name:"Run query",keywords:"query",perform:()=>{n((0,z.Od)({exploreId:h[0]}))},section:m}),x.push({id:"explore/split-view-open",name:"Open split view",keywords:"split",perform:()=>{n((0,q.ve)())},section:m})}o(x)},[r,i,s,n,c]),(0,to.useRegisterActions)(s?t:[],[t,s]),null};var _s=l(33149),en=l(45897);function Ho(t){const{children:o,onResize:s,initialHeight:n}=t,r=(0,k.$j)(),i=(0,k.of)(on),c=(0,en.l)(r),h=n||`${r.components.horizontalDrawer.defaultHeight}px`;return(0,e.jsx)(_s.c,{className:(0,u.cx)(i.fixed,i.container,i.drawerActive),defaultSize:{width:"100%",height:h},handleClasses:{top:c.dragHandleHorizontal},enable:{top:!0,right:!1,bottom:!1,left:!1,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},maxHeight:"100vh",onResize:s,children:o})}const tn=t=>(0,u.keyframes)`
  0% {
    transform: translateY(${t.components.horizontalDrawer.defaultHeight}px);
  }

  100% {
    transform: translateY(0px);
  }
`,on=t=>({fixed:(0,u.css)({position:"absolute !important"}),container:(0,u.css)({bottom:0,background:t.colors.background.primary,borderTop:`1px solid ${t.colors.border.weak}`,boxShadow:t.shadows.z3,zIndex:t.zIndex.navbarFixed}),drawerActive:(0,u.css)({opacity:1,[t.transitions.handleMotion("no-preference")]:{animation:`0.5s ease-out ${tn(t)}`}})});var be=l(71468),sn=l(19379),Bo=l(60188),Qe=l(51898),pt=l(62635),nn=l(70713),Xe=l(78012),ee=l(67770),pe=l(28105),$o=l(39796),We=l(78282),oo=l(92807),so=l(3023),Vo=l(36100),gt=l(53222),wt=l(34984),Qo=l(42941),rn=l(23535),an=function(t){var o=(0,rn.A)({x:0,y:0}),s=o[0],n=o[1];return(0,d.useEffect)(function(){var r=function(){t.current&&n({x:t.current.scrollLeft,y:t.current.scrollTop})};return t.current&&(0,Ge.on)(t.current,"scroll",r,{capture:!1,passive:!0}),function(){t.current&&(0,Ge.AU)(t.current,"scroll",r)}},[t]),s};const ln=an,Wo=(0,d.createContext)(void 0);function cn({children:t,refreshDependencies:o}){const[s,n]=(0,d.useState)([]),r=(0,d.useRef)({}),i=(0,d.useCallback)(p=>{const g=p.id?p.id:(0,_.uniqueId)(`${p.panelId}-${p.title}-${p.icon}_`);return n(f=>{if(p.level==="root"){const y=r.current[p.panelId]||[];return y.length>0&&r.current[p.panelId].forEach(v=>{v.type==="filter"&&(v.ref=p.ref)}),r.current[p.panelId]=[],[...f,{...p,id:g,children:y}].sort(zo)}if(p.level==="child"){let y=!1;if(Object.keys(r.current).forEach(C=>{if(r.current[C].find(S=>S.title===p.title&&p.type==="filter"&&p.panelId===S.panelId)){y=!0;return}}),y)return[...f];const T=f.findIndex(C=>C.panelId===p.panelId&&C.level==="root");if(T===-1)return Object.keys(r.current).find(L=>L===p.panelId)?r.current[p.panelId].push({...p,id:g}):r.current[p.panelId]=[{...p,id:g}],[...f];const v=[...f],j={...v[T]},R=j.children?.find(C=>C.title===p.title&&p.type==="filter"&&p.panelId===C.panelId);if(R&&R.highlight!==p.highlight)return j.children?.map(C=>{C.title===R?.title&&(C.highlight=p.highlight)}),[...f];if(R)return[...f];let F=p.ref;p.type==="filter"&&(F=j.ref);let I=[{...p,id:g,ref:F},...j.children||[]];return p.childOnTop||(I=Ko(I)),v[T]={...j,children:I},v}return[...f]}),g},[]),c=(0,d.useCallback)(p=>{n(g=>g.filter(f=>f.id!==p).map(f=>(f.children&&(f.children=f.children.filter(y=>y.id!==p)),f)))},[]),h=(0,d.useCallback)(p=>{n(p)},[]),m=(0,d.useCallback)((p,g)=>{n(f=>f.map(y=>y.id===p?{...y,...g}:y))},[]),x=(0,d.useCallback)((p,g)=>{n(f=>{const y=p(f);return y?f.map(T=>(T.id===y&&(T.children=T.children?.filter(v=>v.type!==g)),T)):f})},[]);return(0,d.useEffect)(()=>{n(p=>{const g=[...p];for(const f of g){const y=Ko(f.children||[]);f.children=y}return g})},[o]),(0,e.jsx)(Wo.Provider,{value:{outlineItems:s,register:i,unregister:c,updateOutlineItems:h,unregisterAllChildren:x,updateItem:m},children:t})}function zo(t,o){if(t.ref&&o.ref){const s=t.ref.compareDocumentPosition(o.ref);if(s===Node.DOCUMENT_POSITION_PRECEDING)return 1;if(s===Node.DOCUMENT_POSITION_FOLLOWING)return-1}return 0}function Ko(t){const[o,s]=t.reduce((n,r)=>(r.childOnTop?n[0].push(r):n[1].push(r),n),[[],[]]);return s.sort(zo),[...o,...s]}function no(){return(0,d.useContext)(Wo)}var dn=l(30360);function ro({contentOutlineExpanded:t,title:o,icon:s,tooltip:n,tooltipPlacement:r="bottom",className:i,indentStyle:c,collapsible:h,collapsed:m,isActive:x,extraHighlight:p,sectionId:g,toggleCollapsed:f,color:y,onRemove:T,...v}){const j=(0,k.$j)(),R=un(j,y),F=(0,u.cx)(R.button,i),I=(0,d.useRef)(null),[C,L]=(0,d.useState)(!1);(0,d.useEffect)(()=>{I.current&&L(I.current?.scrollWidth>I.current?.clientWidth)},[o]);const S=(0,e.jsxs)("div",{className:(0,u.cx)(R.buttonContainer,c),children:[h&&(0,e.jsx)("button",{className:R.collapseButton,onClick:f,"aria-label":(0,a.t)("explore.content-outline-item-button.body.aria-label-content-outline-item-collapse-button","Content outline item collapse button"),"aria-expanded":!m,"aria-controls":g,children:(0,e.jsx)(Uo,{icon:m?"angle-right":"angle-down"})}),(0,e.jsxs)("button",{className:(0,u.cx)(F,{[R.active]:x,[R.extraHighlight]:p}),"aria-label":n,...v,children:[(0,e.jsx)(Uo,{icon:s}),o&&(0,e.jsx)("span",{className:R.textContainer,ref:I,children:o})]}),T&&(0,e.jsx)(b.$n,{"aria-label":(0,a.t)("explore.content-outline-item-button.body.aria-label-content-outline-item-delete-button","Delete item"),variant:"destructive",className:R.deleteButton,icon:"times",onClick:()=>T(),"data-testid":"content-outline-item-delete-button"})]});return n&&(!t||C)?(0,e.jsx)(ye.m,{content:n,placement:r,children:S}):S}function Uo({icon:t}){return t?(0,dn.n6)(t)?(0,e.jsx)(ue.I,{name:t,size:"lg",title:t}):t:null}const un=(t,o)=>({buttonContainer:(0,u.css)({position:"relative",display:"flex",alignItems:"center",flexGrow:1,gap:t.spacing(.25),width:"100%",overflow:"hidden"}),button:(0,u.css)({label:"content-outline-item-button",display:"flex",alignItems:"center",height:t.spacing(t.components.height.md),gap:t.spacing(.5),color:t.colors.text.secondary,width:"100%",background:"transparent",overflow:"hidden",border:"none"}),collapseButton:(0,u.css)({display:"flex",alignItems:"center",justifyContent:"center",width:t.spacing(3),height:t.spacing(4),borderRadius:t.shape.radius.default,color:t.colors.text.secondary,background:"transparent",border:"none",overflow:"hidden","&:hover":{color:t.colors.text.primary,background:t.colors.secondary.shade}}),textContainer:(0,u.css)({whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",fontSize:t.typography.bodySmall.fontSize,marginLeft:t.spacing(.5)}),active:(0,u.css)({backgroundColor:t.colors.background.secondary,borderTopRightRadius:t.shape.radius.default,borderBottomRightRadius:t.shape.radius.default,position:"relative",height:t.spacing(t.components.height.md),"&::before":{backgroundImage:o!==void 0?"none":t.colors.gradients.brandVertical,backgroundColor:o!==void 0?o:"none",borderRadius:t.shape.radius.default,content:'" "',display:"block",height:"100%",position:"absolute",transform:"translateX(-50%)",width:t.spacing(.5),left:"2px"}}),extraHighlight:(0,u.css)({backgroundColor:t.colors.background.secondary,borderTopRightRadius:t.shape.radius.default,borderBottomRightRadius:t.shape.radius.default,position:"relative","&::before":{backgroundImage:o!==void 0?"none":t.colors.gradients.brandVertical,backgroundColor:o!==void 0?o:"none",borderRadius:t.shape.radius.default,content:'" "',display:"block",height:"100%",position:"absolute",transform:"translateX(-50%)",width:t.spacing(.5),left:"2px"}}),deleteButton:(0,u.css)({width:t.spacing(1),height:t.spacing(1),padding:t.spacing(.75,.75),marginRight:t.spacing(.5)})});function qo(t){return t.children?.filter(o=>o.type!=="filter")||[]}function Go(t,o,s,n){const r=o===t.id,i=s===t.id,c=!n[t.id],h=qo(t).length>0,m=Et(t,s)&&!n[t.id];return h?c&&(r||m):r||i}const Lt={visible:"grafana.explore.contentOutline.visible",expanded:"grafana.explore.contentOutline.expanded"};function pn({scroller:t,panelId:o}){const[s,n]=(0,Qo.A)(Xe.M.getBool(Lt.expanded,!0)),r=(0,k.of)(gn,s),i=(0,d.useRef)(t||null),{y:c}=ln(i),{outlineItems:h}=no()??{outlineItems:[]},[m,x]=(0,d.useState)(h[0]?.id),[p,g]=(0,d.useState)(h[0]?.children?.[0]?.id),f=h.some(C=>C.children&&!(C.mergeSingleChild&&C.children?.length===1)&&C.children.length>0),y=h.some(C=>C.children?.some(L=>L.onRemove)),[T,v]=(0,d.useState)(()=>h.reduce((C,L)=>(C[L.id]=!!L.expanded,C),{})),j=(C,L=0)=>{let S=0,D=C;if(D){do S+=D?.offsetTop||0,D=D?.offsetParent instanceof HTMLElement?D.offsetParent:void 0;while(D&&D!==t);t?.scroll({top:S+L,behavior:"smooth"})}},R=C=>{if(C.level==="child"&&C.type==="filter"){const L=h.find(S=>S.children?.find(D=>D.id===C.id));L&&j(L.ref,L.customTopOffset)}else j(C.ref,C.customTopOffset),(0,N.rR)("explore_toolbar_contentoutline_clicked",{item:"select_section",type:C.panelId})},F=()=>{Xe.M.set(Lt.expanded,!s),n(),(0,N.rR)("explore_toolbar_contentoutline_clicked",{item:"outline",type:s?"minimize":"expand"})},I=C=>{v(L=>({...L,[C]:!L[C]})),(0,N.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:T[C]?"expand":"minimize"})};return(0,d.useEffect)(()=>{let C;for(const L of h){let S=L?.ref?.getBoundingClientRect().top;S&&S>=0&&(C=L);const D=qo(L).find(M=>{const H=M.customTopOffset||0;let Q=M?.ref?.getBoundingClientRect().top;return Q&&Q>=H});if(D&&It(L)){g(D.id),x(L.id);break}if(C){x(C.id),g(void 0);break}}},[h,c]),(0,e.jsx)(so._,{className:r.wrapper,id:o,children:(0,e.jsx)(oo.P,{children:(0,e.jsxs)("div",{className:r.content,children:[(0,e.jsx)(ro,{icon:"arrow-from-right",tooltip:s?(0,a.t)("explore.content-outline.tooltip-collapse-outline","Collapse outline"):(0,a.t)("explore.content-outline.tooltip-expand-outline","Expand outline"),tooltipPlacement:s?"right":"bottom",onClick:F,className:(0,u.cx)(r.toggleContentOutlineButton,{[r.justifyCenter]:!s&&!f}),"aria-expanded":s}),h.map(C=>(0,e.jsxs)(d.Fragment,{children:[(0,e.jsx)(ro,{title:s?C.title:void 0,contentOutlineExpanded:s,className:(0,u.cx)(r.buttonStyles,{[r.justifyCenter]:!s&&!y,[r.sectionHighlighter]:Et(C,p)&&!s}),indentStyle:(0,u.cx)({[r.indentRoot]:!It(C)&&f,[r.sectionHighlighter]:Et(C,p)&&!s&&T[C.id]}),icon:C.icon,onClick:()=>R(C),tooltip:C.title,collapsible:It(C),collapsed:!T[C.id],toggleCollapsed:()=>I(C.id),isActive:Go(C,m,p,T),sectionId:C.id,color:C.color},C.id),(0,e.jsx)("div",{id:C.id,"data-testid":`section-wrapper-${C.id}`,children:C.children&&It(C)&&T[C.id]&&C.children.map((L,S)=>(0,e.jsxs)("div",{className:r.itemWrapper,children:[s&&(0,e.jsx)("div",{className:(0,u.cx)(r.itemConnector,{[r.firstItemConnector]:S===0,[r.lastItemConnector]:S===(C.children?.length||0)-1})}),(0,e.jsx)(ro,{title:s?L.title:void 0,contentOutlineExpanded:s,icon:s?void 0:C.icon,className:(0,u.cx)(r.buttonStyles,{[r.justifyCenter]:!s&&!y,[r.sectionHighlighter]:Et(C,p)&&!s}),indentStyle:r.indentChild,onClick:D=>{R(L),L.onClick?.(D)},tooltip:L.title,isActive:Go(L,m,p,T),extraHighlight:L.highlight,color:L.color,onRemove:L.onRemove?()=>L.onRemove?.(L.id):void 0},L.id)]},L.id))})]},C.id))]})})})}const gn=(t,o)=>({wrapper:(0,u.css)({label:"wrapper",position:"relative",display:"flex",justifyContent:"center",marginRight:t.spacing(1),height:"100%",backgroundColor:t.colors.background.primary,width:o?"160px":void 0,minWidth:o?"160px":void 0}),content:(0,u.css)({label:"content",marginLeft:t.spacing(.5),top:0}),buttonStyles:(0,u.css)({display:"flex","&:hover":{color:t.colors.text.primary,textDecoration:"underline"}}),toggleContentOutlineButton:(0,u.css)({"&:hover":{color:t.colors.text.primary},transform:o?"rotate(180deg)":"",marginRight:o?t.spacing(.5):void 0}),indentRoot:(0,u.css)({paddingLeft:t.spacing(3)}),indentChild:(0,u.css)({paddingLeft:o?t.spacing(5):t.spacing(2.75)}),itemWrapper:(0,u.css)({display:"flex",height:t.spacing(4),alignItems:"center"}),itemConnector:(0,u.css)({position:"relative",height:"100%",width:t.spacing(1.5),"&::before":{borderRight:`1px solid ${t.colors.border.medium}`,content:'""',height:"100%",left:t.spacing(4.75),position:"absolute",transform:"translateX(50%)"}}),firstItemConnector:(0,u.css)({"&::before":{top:t.spacing(1),height:`calc(100% - ${t.spacing(1)})`}}),lastItemConnector:(0,u.css)({"&::before":{height:`calc(100% - ${t.spacing(1)})`}}),justifyCenter:(0,u.css)({justifyContent:"center"}),sectionHighlighter:(0,u.css)({backgroundColor:t.colors.background.secondary})});function It(t){return!!(t.children&&t.children.length>0&&(!t.mergeSingleChild||t.children.length!==1))}function Et(t,o){return t.children?.some(s=>s.id===o)}function Ce({panelId:t,title:o,icon:s,customTopOffset:n,children:r,className:i,level:c="root",mergeSingleChild:h,type:m="scrollIntoView",onClick:x}){const{register:p,unregister:g}=no()??{},f=(0,d.useRef)(null);return(0,d.useEffect)(()=>{if(!p||!g)return;const y=p({panelId:t,title:o,icon:s,ref:f.current,customTopOffset:n,level:c,mergeSingleChild:h,type:m});return()=>g(y)},[t,o,s,n,c,h,p,g,m,x]),(0,e.jsx)("div",{className:i,ref:f,children:r})}var Ft=l(49785),ao=l(16817),ht=l(34999),Dt=l(89599),Ne=l(37386),Ot=l(63527),At=l(8073),_e=l(76319),hn=l(44458),io=l(70191),mn=l(6219),fn=l(23257),xn=l.n(fn),yn=l(72636),ze=l(18857),lo=l(58843);const Zo=({label:t,tooltipText:o})=>(0,e.jsxs)(Ve.B,{gap:1,direction:"row",wrap:"wrap",alignItems:"flex-start",children:[(0,e.jsx)(yn.J,{children:t}),(0,e.jsx)(ye.m,{content:o,children:(0,e.jsx)(ue.I,{name:"info-circle",size:"sm"})})]}),vn=({onSave:t,onCancel:o,fieldList:s,transformationToEdit:n})=>{const[r,i]=(0,d.useState)(void 0),[c,h]=(0,d.useState)({}),[m,x]=(0,d.useState)({mapValueDetails:{show:!1},expressionDetails:{show:!1}}),[p,g]=(0,d.useState)(!1),[f,y]=(0,d.useState)(!1),{getValues:T,control:v,register:j,watch:R}=(0,Ft.mN)({defaultValues:(0,d.useMemo)(()=>{if(n){const I=s[n?.field];i(I),n?.expression&&g(!0);const C=(0,lo.hr)(n?.type);x({mapValueDetails:C.mapValueDetails,expressionDetails:C.expressionDetails});const L=(0,io.k)({type:n?.type,expression:n?.expression,mapValue:n?.mapValue},I||"",n?.field);return h({...L}),y(!0),{type:n?.type,field:n?.field,mapValue:n?.mapValue,expression:n?.expression}}else return},[s,n])}),F=(0,d.useId)();return(0,d.useEffect)(()=>{const I=R(C=>{const L=C.expression;let S=!1;if(L!==void 0){S=!0;try{new RegExp(L)}catch{S=!1}}else S=!m.expressionDetails.show;g(S);let D=[];if(C.type){const M=(0,io.k)({type:C.type,expression:S?L:"",mapValue:C.mapValue},s[C.field]||"",C.field);D=Object.keys(M),h(D.length>0?{...M}:{})}D.length===0||!S?y(!1):y(!0)});return()=>I.unsubscribe()},[s,m.expressionDetails.show,R]),(0,e.jsxs)(Z.a,{isOpen:!0,title:n?(0,a.t)("explore.correlation-transformation-add-modal.title-edit","Edit transformation"):(0,a.t)("explore.correlation-transformation-add-modal.title-add","Add transformation"),onDismiss:o,className:(0,u.css)({width:"700px"}),children:[(0,e.jsx)("p",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-transformation-add-modal.body",children:"A transformation extracts variables out of a single field. These variables will be available along with your field variables."})}),(0,e.jsx)(Ne.D,{label:(0,a.t)("explore.correlation-transformation-add-modal.label-field","Field"),children:(0,e.jsx)(Ft.xI,{control:v,render:({field:{onChange:I,ref:C,...L}})=>(0,e.jsx)(ze.l6,{...L,onChange:S=>{S.value&&(I(S.value),i(s[S.value]))},options:Object.entries(s).map(S=>({label:S[0],value:S[0]})),"aria-label":(0,a.t)("explore.correlation-transformation-add-modal.aria-label-field","Field")}),name:"field"})}),r&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("pre",{children:(0,e.jsx)(xn(),{textToHighlight:r,searchWords:[p?T("expression")??"":""],autoEscape:!1})}),(0,e.jsx)(Ne.D,{label:(0,a.t)("explore.correlation-transformation-add-modal.label-type","Type"),children:(0,e.jsx)(Ft.xI,{control:v,render:({field:{onChange:I,ref:C,...L}})=>(0,e.jsx)(ze.l6,{...L,onChange:S=>{I(S.value);const D=(0,lo.hr)(S.value);x({mapValueDetails:D.mapValueDetails,expressionDetails:D.expressionDetails})},options:(0,lo.jN)(),"aria-label":(0,a.t)("explore.correlation-transformation-add-modal.aria-label-type","Type")}),name:"type"})}),m.expressionDetails.show&&(0,e.jsx)(Ne.D,{label:m.expressionDetails.helpText?(0,e.jsx)(Zo,{label:(0,a.t)("explore.correlation-transformation-add-modal.label-expression","Expression"),tooltipText:m.expressionDetails.helpText}):(0,a.t)("explore.correlation-transformation-add-modal.label-expression-without-tooltip","Expression"),htmlFor:`${F}-expression`,required:m.expressionDetails.required,children:(0,e.jsx)(Ot.p,{...j("expression"),id:`${F}-expression`})}),m.mapValueDetails.show&&(0,e.jsx)(Ne.D,{label:m.mapValueDetails.helpText?(0,e.jsx)(Zo,{label:(0,a.t)("explore.correlation-transformation-add-modal.label-variable-name","Variable name"),tooltipText:m.mapValueDetails.helpText}):(0,a.t)("explore.correlation-transformation-add-modal.label-variable-name-without-tooltip","Variable name"),htmlFor:`${F}-mapValue`,children:(0,e.jsx)(Ot.p,{...j("mapValue"),id:`${F}-mapValue`})}),Object.entries(c).length>0&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-transformation-add-modal.added-variables",children:"This transformation will add the following variables:"}),(0,e.jsx)("pre",{children:Object.entries(c).map(I=>`\${${I[0]}} = ${I[1]?.value}
`)})]})]}),(0,e.jsxs)(Z.a.ButtonRow,{children:[(0,e.jsx)(b.$n,{variant:"secondary",onClick:o,fill:"outline",children:(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-transformation-add-modal.cancel",children:"Cancel"})}),(0,e.jsx)(b.$n,{variant:"primary",onClick:()=>t(T()),disabled:!f,children:n?(0,a.t)("explore.correlation-transformation-add-modal.edit-transformation","Edit transformation"):(0,a.t)("explore.correlation-transformation-add-modal.add-transformation","Add transformation to correlation")})]})]})},bn=({exploreId:t,correlations:o})=>{const s=(0,A.wA)(),n=(0,k.of)(Cn),r=(0,A.d4)(U.Qb),i=Object.values(r),{value:c,loading:h}=(0,ao.A)(async()=>await(0,mn.tZ)(i[0],i[1]),[i[0]?.datasourceInstance,i[0]?.queries[0].datasource,i[1]?.datasourceInstance,i[1]?.queries[0].datasource]),{register:m,watch:x,getValues:p,setValue:g}=(0,Ft.mN)(),[f,y]=(0,d.useState)(!1),[T,v]=(0,d.useState)(!1),[j,R]=(0,d.useState)(!1),[F,I]=(0,d.useState)([]),[C,L]=(0,d.useState)(void 0),S=(0,A.d4)(U.vC),D=(0,d.useId)();return(0,d.useEffect)(()=>(s((0,q.am)({canSave:!0})),()=>{s((0,q.am)({canSave:!1}))}),[s]),(0,d.useEffect)(()=>{!h&&c!==void 0&&!S?.correlationDirty&&p("label")!==""&&g("label",c)},[S?.correlationDirty,c,p,h,g]),(0,d.useEffect)(()=>{const M=x(H=>{let Q=S?.correlationDirty||!1,E=H.description||"";!Q&&(H.label!==c||E!=="")?Q=!0:Q&&H.label===c&&E.trim()===""&&(Q=!1),s((0,q.am)({label:H.label,description:H.description,correlationDirty:Q}))});return()=>M.unsubscribe()},[S?.correlationDirty,c,s,x]),(0,d.useEffect)(()=>{const M=!S?.correlationDirty&&F.length>0?!0:S?.correlationDirty;s((0,q.am)({transformations:F,correlationDirty:M}));let H={};F.forEach(Q=>{const E=(0,io.k)({type:Q.type,expression:Q.expression,mapValue:Q.mapValue},o.vars[Q.field],Q.field);Object.keys(E).forEach(J=>{H[J]=E[J]?.value})}),s((0,ve.nE)({exploreId:t,correlationEditorHelperData:{resultField:o.resultField,origVars:o.origVars,vars:{...o.origVars,...H}}}))},[s,F]),(0,e.jsxs)(e.Fragment,{children:[j&&(0,e.jsx)(vn,{onCancel:()=>{L(void 0),R(!1)},onSave:M=>{if(C!==void 0){const H=[...F];H[C]=M,I(H),L(void 0)}else I([...F,M]);R(!1)},fieldList:o.origVars,transformationToEdit:C!==void 0?F[C]:void 0}),(0,e.jsxs)(ht.F,{title:(0,a.t)("explore.correlation-helper.title-correlation-details","Correlation details"),severity:"info",children:[(0,e.jsxs)(a.x6,{i18nKey:"explore.correlation-helper.body-correlation-details",values:{resultField:o.resultField},children:["The correlation link will appear by the ",(0,e.jsx)("code",{children:"{{resultField}}"})," field. You can use the following variables to set up your correlations:"]}),(0,e.jsx)("pre",{children:Object.entries(o.vars).map(M=>`\${${M[0]}} = ${M[1]}
`)}),(0,e.jsxs)(Dt.S,{collapsible:!0,isOpen:f,onToggle:()=>{y(!f)},label:(0,e.jsxs)(Ve.B,{gap:1,direction:"row",wrap:"wrap",alignItems:"center",children:[(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-helper.label-description-header",children:"Label / Description"}),!f&&!h&&(0,e.jsx)("span",{className:n.labelCollapseDetails,children:`Label: ${p("label")||c}`})]}),children:[(0,e.jsx)(Ne.D,{label:(0,a.t)("explore.correlation-helper.label-label","Label"),htmlFor:`${D}-label`,children:(0,e.jsx)(Ot.p,{...m("label"),id:`${D}-label`,onBlur:()=>{p("label")===""&&c!==void 0&&g("label",c)}})}),(0,e.jsx)(Ne.D,{label:(0,a.t)("explore.correlation-helper.label-description","Description"),htmlFor:`${D}-description`,children:(0,e.jsx)(Ot.p,{...m("description"),id:`${D}-description`})})]}),(0,e.jsxs)(Dt.S,{collapsible:!0,isOpen:T,onToggle:()=>{v(!T)},label:(0,e.jsxs)(Ve.B,{gap:1,direction:"row",wrap:"wrap",alignItems:"center",children:[(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-helper.transformations",children:"Transformations"}),(0,e.jsx)(ye.m,{content:(0,a.t)("explore.correlation-helper.tooltip-transformations","A transformation extracts one or more variables out of a single field."),children:(0,e.jsx)(ue.I,{name:"info-circle",size:"sm"})})]}),children:[(0,e.jsx)(b.$n,{variant:"secondary",fill:"outline",onClick:()=>{R(!0)},className:n.transformationAction,children:(0,e.jsx)(a.x6,{i18nKey:"explore.correlation-helper.add-transformation",children:"Add transformation"})}),F.map((M,H)=>{const{type:Q,field:E,expression:J,mapValue:K}=M,V=[(K??"").length>0?`Variable name: ${K}`:void 0,(J??"").length>0?(0,e.jsxs)(a.x6,{i18nKey:"explore.correlation-helper.expression",values:{expression:J},children:["Expression: ",(0,e.jsx)("code",{children:"{{expression}}"})]}):void 0].filter(se=>se);return(0,e.jsxs)(At.Z,{children:[(0,e.jsxs)(At.Z.Heading,{children:[E,": ",Q]}),V.length>0&&(0,e.jsx)(At.Z.Meta,{className:n.transformationMeta,children:V}),(0,e.jsxs)(At.Z.SecondaryActions,{children:[(0,e.jsx)(_e.K,{name:"edit","aria-label":(0,a.t)("explore.correlation-helper.aria-label-edit-transformation","Edit transformation"),onClick:()=>{L(H),R(!0)}},"edit"),(0,e.jsx)(hn.e,{"aria-label":(0,a.t)("explore.correlation-helper.aria-label-delete-transformation","Delete transformation"),onConfirm:()=>I(F.filter((se,le)=>H!==le)),closeOnConfirm:!0})]})]},`trans-${H}`)})]})]})]})},Cn=t=>({labelCollapseDetails:(0,u.css)({marginLeft:t.spacing(2),...t.typography.bodySmall,fontStyle:"italic"}),transformationAction:(0,u.css)({marginBottom:t.spacing(2)}),transformationMeta:(0,u.css)({alignItems:"baseline"})});var Sn=l(60311),jn=l(64400),Fe=l(67522),Rn=l(92391),Tn=l(89381);function wn({width:t,height:o,timeZone:s,state:n,pluginId:r,frames:i,timeRange:c,splitOpenFn:h,eventBus:m}){const x=(0,Rn.d4)(r),g={dataLinkPostProcessor:(0,Tn.h)(h,c),eventBus:m,eventsScope:"explore"};return(0,e.jsx)(jn.XF,{value:g,children:(0,e.jsx)(Fe.NR,{title:x.name,width:t,height:o,loadingState:n,children:(f,y)=>(0,e.jsx)(Sn.m,{data:{series:i,state:n,timeRange:c},pluginId:r,title:"",width:f,height:y,timeZone:s})})})}var Ln=l(82143),In=l(84600),ie=l(7895),co=l(93256),Pt=l(90811),En=l(43707),Fn=l(76792),uo=l(73427),Yo=l(69289),et=l(25229),Jo=l(33239),Dn=l(51158),Xo=l(23237);function On(t){const{onClick:o,isSynced:s}=t,n=()=>{const{isSynced:r}=t,i=r?"Unsync all views":"Sync all views to this time range";return(0,e.jsx)(e.Fragment,{children:i})};return(0,e.jsx)(ye.m,{content:n,placement:"bottom",children:(0,e.jsx)(ie.I,{icon:"link",variant:s?"active":"canvas","aria-label":s?(0,a.t)("explore.time-sync-button.aria-label-synced","Synced times"):(0,a.t)("explore.time-sync-button.aria-label-unsynced","Unsynced times"),onClick:o})})}class An extends d.Component{constructor(){super(...arguments),this.onMoveTimePicker=o=>{const{range:s,onChangeTime:n,timeZone:r}=this.props,{from:i,to:c}=(0,Xo.Wb)(o,s),h={from:(0,et.oZ)(r,i),to:(0,et.oZ)(r,c)};n(h)},this.onMoveForward=()=>this.onMoveTimePicker(1),this.onMoveBack=()=>this.onMoveTimePicker(-1),this.onChangeTimePicker=o=>{const s=Jo.isMathString(o.raw.from)?o.raw.from:o.from,n=Jo.isMathString(o.raw.to)?o.raw.to:o.to;this.props.onChangeTime({from:s,to:n}),(0,N.rR)("grafana_explore_time_picker_time_range_changed",{timeRangeFrom:s,timeRangeTo:n})},this.onZoom=()=>{const{range:o,onChangeTime:s,timeZone:n}=this.props,{from:r,to:i}=(0,Xo.Zk)(o,2),c={from:(0,et.oZ)(n,r),to:(0,et.oZ)(n,i)};s(c)}}render(){const{range:o,timeZone:s,fiscalYearStartMonth:n,splitted:r,syncedTimes:i,onChangeTimeSync:c,hideText:h,onChangeTimeZone:m,onChangeFiscalYearStartMonth:x}=this.props,p=r?(0,e.jsx)(On,{onClick:c,isSynced:i}):void 0,g={value:o,timeZone:s,fiscalYearStartMonth:n,onMoveBackward:this.onMoveBack,onMoveForward:this.onMoveForward,onZoom:this.onZoom,hideText:h};return(0,e.jsx)(Dn.mR,{isOnCanvas:!0,...g,timeSyncButton:p,isSynced:i,widthOverride:r?window.innerWidth/2:void 0,onChange:this.onChangeTimePicker,onChangeTimeZone:m,onChangeFiscalYearStartMonth:x})}}var _o=l(86634);function Pn(t){const o=(0,d.useRef)(null),{start:s,pause:n,resume:r,isLive:i,isPaused:c,stop:h,splitted:m}=t,x=i&&!c?"active":"canvas",p=i?c?r:n:s;return(0,e.jsxs)(co.e,{children:[(0,e.jsx)(ye.m,{content:i&&!c?(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(a.x6,{i18nKey:"explore.live-tail-button.pause-the-live-stream",children:"Pause the live stream"})}):(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(a.x6,{i18nKey:"explore.live-tail-button.start-live-stream-your-logs",children:"Start live stream your logs"})}),placement:"bottom",children:(0,e.jsx)(ie.I,{iconOnly:m,variant:x,icon:!i||c?"play":"pause",onClick:p,children:i&&c?(0,a.t)("explore.live-tail-button.paused","Paused"):(0,a.t)("explore.live-tail-button.live","Live")})}),(0,e.jsx)(_o.A,{mountOnEnter:!0,unmountOnExit:!0,timeout:100,in:i,classNames:{enter:Nt.stopButtonEnter,enterActive:Nt.stopButtonEnterActive,exit:Nt.stopButtonExit,exitActive:Nt.stopButtonExitActive},nodeRef:o,children:(0,e.jsx)(ye.m,{content:(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(a.x6,{i18nKey:"explore.live-tail-button.stop-and-exit-the-live-stream",children:"Stop and exit the live stream"})}),placement:"bottom",children:(0,e.jsx)(ie.I,{ref:o,variant:x,onClick:h,icon:"square-shape"})})})]})}const Nt={stopButtonEnter:(0,u.css)({label:"stopButtonEnter",width:0,opacity:0,overflow:"hidden"}),stopButtonEnterActive:(0,u.css)({label:"stopButtonEnterActive",opacity:1,width:"32px"}),stopButtonExit:(0,u.css)({label:"stopButtonExit",width:"32px",opacity:1,overflow:"hidden"}),stopButtonExitActive:(0,u.css)({label:"stopButtonExitActive",opacity:0,width:0})};var tt=l(52830),ke=l(87063),Nn=l(30930),mt=l(88559),kt=l(71673),ot=l(78529);function kn(){const t={key:"copy-link",label:(0,a.t)("explore.toolbar.copy-shortened-link","Copy shortened URL"),icon:"share-alt",getUrl:()=>{},shorten:!0,absTime:!1},o=(0,A.d4)(U.Qb),[s,n]=(0,d.useState)(!1),[r,i]=(0,d.useState)(t),c=(x,p,g)=>{x?((0,kt.VP)(g||l.g.location.href),(0,N.rR)("grafana_explore_shortened_link_clicked",{isAbsoluteTime:p})):((0,pt.uJ)(g!==void 0?`${window.location.protocol}//${window.location.host}${P.$.appSubUrl}${g}`:l.g.location.href),(0,N.rR)("grafana_explore_copy_link_clicked",{isAbsoluteTime:p}))},h=[{key:"normal",label:(0,a.t)("explore.toolbar.copy-links-normal-category","Normal URL links"),items:[{key:"copy-shortened-link",icon:"link",label:(0,a.t)("explore.toolbar.copy-shortened-link","Copy shortened URL"),getUrl:()=>{},shorten:!0,absTime:!1},{key:"copy-link",icon:"link",label:(0,a.t)("explore.toolbar.copy-link","Copy URL"),getUrl:()=>{},shorten:!1,absTime:!1}]},{key:"timesync",label:(0,a.t)("explore.toolbar.copy-links-absolute-category","Time-sync URL links (share with time range intact)"),items:[{key:"copy-short-link-abs-time",icon:"clock-nine",label:(0,a.t)("explore.toolbar.copy-shortened-link-abs-time","Copy absolute shortened URL"),shorten:!0,getUrl:()=>(0,ot._O)(o),absTime:!0},{key:"copy-link-abs-time",icon:"clock-nine",label:(0,a.t)("explore.toolbar.copy-link-abs-time","Copy absolute URL"),shorten:!1,getUrl:()=>(0,ot._O)(o),absTime:!0}]}],m=(0,e.jsx)(ke.W,{children:h.map(x=>(0,e.jsx)(Nn.r,{label:x.label,children:x.items.map(p=>(0,e.jsx)(ke.W.Item,{label:p.label,icon:p.icon,onClick:()=>{const g=p.getUrl();c(p.shorten,p.absTime,g),i(p)}},p.key))},x.key))});return(0,e.jsxs)(co.e,{children:[(0,e.jsx)(b.$n,{tooltip:r.label,icon:r.icon,size:"sm",variant:"secondary",onClick:()=>{const x=r.getUrl();c(r.shorten,r.absTime,x)},"aria-label":(0,a.t)("explore.toolbar.copy-shortened-link","Copy shortened URL"),children:(0,e.jsx)(a.x6,{i18nKey:"explore.toolbar.copy-shortened-link-label",children:"Share"})}),(0,e.jsx)(mt.m,{overlay:m,placement:"bottom-end",onVisibleChange:n,children:(0,e.jsx)(b.$n,{variant:"secondary",size:"sm",icon:s?"angle-up":"angle-down","aria-label":(0,a.t)("explore.toolbar.copy-shortened-link-menu","Open copy link options")})})]})}var Mn=l(54092),Hn=l(46907),Bn=l(20806),es=l(9860);const $n=(0,d.lazy)(()=>l.e(8224).then(l.bind(l,38224)).then(({AddToDashboard:t})=>({default:t})));function Vn(t){const{exploreId:o,links:s,setSelectedExtension:n,setIsModalOpen:r,isModalOpen:i,noQueriesInPane:c}=t;if(s.length<=1)return ut.TP.hasPermission(Je.w.DashboardsCreate)||ut.TP.hasPermission(Je.w.DashboardsWrite)?(0,e.jsx)(d.Suspense,{fallback:null,children:(0,e.jsx)($n,{exploreId:o})}):null;const h=(0,e.jsx)(es.w,{extensions:s,onSelect:n});return(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(mt.m,{onVisibleChange:r,placement:"bottom-start",overlay:h,children:(0,e.jsx)(ie.I,{"aria-label":(0,a.t)("explore.basic-extensions.aria-label-add","Add"),disabled:!c,variant:"canvas",isOpen:i,children:(0,e.jsx)(a.x6,{i18nKey:"explore.toolbar.add-to-extensions",children:"Add"})})})})}function Qn(t){const{links:o,setSelectedExtension:s,setIsModalOpen:n,isModalOpen:r,noQueriesInPane:i}=t;if(o.length===0)return;const c=(0,e.jsx)(es.w,{extensions:o,onSelect:s});if(o.length===1){const h=(0,_.first)(o);return(0,e.jsx)(ie.I,{variant:"canvas",icon:h.icon,onClick:()=>s(h),children:(0,e.jsx)(a.x6,{i18nKey:"explore.toolbar.add-to-queryless-extensions",children:"Go queryless"})})}return(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(mt.m,{onVisibleChange:n,placement:"bottom-start",overlay:c,children:(0,e.jsx)(ie.I,{"aria-label":(0,a.t)("explore.queryless-apps-extensions.aria-label-go-queryless","Go queryless"),disabled:!i,variant:"canvas",isOpen:r,children:(0,e.jsx)(a.x6,{i18nKey:"explore.toolbar.add-to-queryless-extensions",children:"Go queryless"})})})})}const ts=["grafana-pyroscope-app","grafana-lokiexplore-app","grafana-exploretraces-app","grafana-metricsdrilldown-app"];function os(t){const{exploreId:o,extensionsToShow:s}=t,[n,r]=(0,d.useState)(),[i,c]=(0,d.useState)(!1),h=Wn(t),{links:m}=(0,Hn.U)({extensionPointId:Mn.SM.ExploreToolbarAction,context:h,limitPerPlugin:3}),x=(0,U.qq)(o),p=!!(0,A.d4)(x)?.queries?.length,g=m.filter(y=>ts.includes(y.pluginId)),f=m.filter(y=>!ts.includes(y.pluginId));return(0,e.jsxs)(e.Fragment,{children:[s==="queryless"&&(0,e.jsx)(Qn,{links:g,noQueriesInPane:p,exploreId:o,setSelectedExtension:y=>{r(y),(0,N.rR)("grafana_explore_queryless_app_link_clicked",{pluginId:y.pluginId})},setIsModalOpen:c,isModalOpen:i}),s==="basic"&&(0,e.jsx)(Vn,{links:f,noQueriesInPane:p,exploreId:o,setSelectedExtension:r,setIsModalOpen:c,isModalOpen:i}),!!n&&!!n.path&&(0,e.jsx)(Bn.s,{path:n.path,title:n.title,onDismiss:()=>r(void 0)})]})}function Wn(t){const{exploreId:o,timeZone:s}=t,r=(0,A.d4)(U.vC)?.editorMode||!1,{queries:i,queryResponse:c,range:h}=(0,A.d4)((0,U.qq)(o)),m=(0,A.d4)((0,U.Jr)(o)),x=i.map(f=>f?.datasource?.uid).filter(f=>f!==void 0),p=[...new Set(x)].length,g=ut.TP.hasPermission(Je.w.DataSourcesWrite);return(0,d.useMemo)(()=>({exploreId:o,targets:i,data:c,timeRange:h.raw,timeZone:(0,Bo.O)({timeZone:s}),shouldShowAddCorrelation:P.$.featureToggles.correlations===!0&&g&&!r&&m&&p===1}),[o,i,c,h.raw,s,g,r,m,p])}var fe=l(94543);function zn(t){const o=(0,A.wA)(),s=(0,d.useCallback)(()=>{o((0,z.qk)({exploreId:t,isPaused:!0}))},[t,o]),n=(0,d.useCallback)(()=>{o((0,z.qk)({exploreId:t,isPaused:!1}))},[t,o]),r=(0,d.useCallback)(()=>{s(),o((0,fe.hO)({exploreId:t,refreshInterval:Pt.cC.offOption.value})),o((0,z.Od)({exploreId:t}))},[t,o,s]),i=(0,d.useCallback)(()=>{o((0,fe.hO)({exploreId:t,refreshInterval:Pt.cC.liveOption.value}))},[t,o]),c=(0,d.useCallback)(()=>{o((0,z.rR)({exploreId:t}))},[t,o]);return{pause:s,resume:n,stop:r,start:i,clear:c}}function ss(t){const o=zn(t.exploreId);return t.children(o)}const Kn=(t,o)=>({rotateIcon:(0,u.css)({"> div > svg":{transform:"rotate(180deg)"}}),toolbarButton:(0,u.css)({display:"flex",justifyContent:"center",marginRight:t.spacing(.5),width:o&&t.spacing(6)})});function Un({exploreId:t,onChangeTime:o,onContentOutlineToogle:s,isContentOutlineOpen:n}){const r=(0,A.wA)(),i=(0,A.d4)(U.pF),c=(0,k.of)(Kn,i),h=(0,A.d4)(W=>(0,wt.O)(W.user)),m=(0,A.d4)(W=>(0,wt.q)(W.user)),{refreshInterval:x,datasourceInstance:p,range:g,isLive:f,isPaused:y,syncedTimes:T}=(0,A.d4)(W=>({...(0,_.pick)(W.explore.panes[t],"refreshInterval","datasourceInstance","range","isLive","isPaused"),syncedTimes:W.explore.syncedTimes}),be.shallowEqual),v=(0,A.d4)((0,z.h1)(t)),j=(0,A.d4)(W=>W.explore.largerExploreId===t),R=(0,A.d4)(W=>i||W.explore.panes[t].containerWidth<1210),F=(0,A.d4)(W=>W.explore.panes[t].containerWidth<(i?700:800)),I=(0,A.d4)(U.K6),C=(0,A.d4)(U.vC),L=C?.editorMode||!1,S=(0,A.d4)((0,U.Jr)(t)),{drawerOpened:D,setDrawerOpened:M}=(0,tt.sz)(),H=(0,d.useMemo)(()=>S&&j||!S&&!j,[S,j]),Q=v?(0,a.t)("explore.toolbar.refresh-picker-cancel","Cancel"):(0,a.t)("explore.toolbar.refresh-picker-run","Run query"),E=async W=>{L?C?.correlationDirty||C?.queryEditorDirty?r((0,q.am)({isExiting:!0,postConfirmAction:{exploreId:t,action:O.IW.CHANGE_DATASOURCE,changeDatasourceUid:W.uid,isActionLeft:S}})):(S&&I.forEach(Oe=>{r((0,ve.nE)({exploreId:Oe[0],correlationEditorHelperData:void 0}))}),r((0,Ee.wh)({exploreId:t,datasource:W.uid,options:{importQueries:!0}}))):r((0,Ee.wh)({exploreId:t,datasource:W.uid,options:{importQueries:!0}}))},J=(W=!1)=>r(W?(0,z.hS)(t):(0,z.Od)({exploreId:t})),K=W=>r((0,Yo.Cj)(W)),V=()=>{r((0,q.ve)()),(0,N.rR)("grafana_explore_split_view_opened",{origin:"menu"})},se=()=>{L?C?.correlationDirty||C?.queryEditorDirty?r((0,q.am)({isExiting:!0,postConfirmAction:{exploreId:t,action:O.IW.CLOSE_PANE,isActionLeft:S}})):(I.forEach(W=>{r((0,ve.nE)({exploreId:W[0],correlationEditorHelperData:void 0}))}),r((0,q.J8)(t)),(0,N.rR)("grafana_explore_split_view_closed")):(r((0,q.J8)(t)),(0,N.rR)("grafana_explore_split_view_closed"))},le=()=>{r(j?(0,q.JA)():(0,q.tP)({exploreId:t}))},Te=()=>{r((0,fe.iO)(t))},nt=W=>r((0,Yo.c1)(W)),Me=W=>{r((0,fe.hO)({exploreId:t,refreshInterval:W}))},Kt=[(0,e.jsx)(b.$n,{size:"sm",variant:"secondary","aria-label":(0,a.t)("explore.secondary-actions.query-history-button-aria-label","Query history"),onClick:()=>M(!D),"data-testid":Qe.XF.QueryTab.queryHistoryButton,icon:"history",children:(0,e.jsx)(a.x6,{i18nKey:"explore.secondary-actions.query-history-button",children:"Query history"})},"query-history"),(0,e.jsx)(kn,{},"share")];return(0,e.jsxs)("div",{children:[x&&(0,e.jsx)(Ln.u,{func:J,interval:x,loading:v}),(0,e.jsx)(En.H,{actions:Kt}),(0,e.jsx)(In.d,{"aria-label":(0,a.t)("explore.toolbar.aria-label","Explore toolbar"),leftItems:[(0,e.jsx)(ie.I,{variant:"canvas",tooltip:(0,a.t)("explore.explore-toolbar.tooltip-content-outline","Content outline"),icon:"list-ui-alt",iconOnly:i,onClick:s,"aria-expanded":n,"aria-controls":n?"content-outline-container":void 0,className:c.toolbarButton,children:(0,e.jsx)(a.x6,{i18nKey:"explore.explore-toolbar.outline",children:"Outline"})},"content-outline"),(0,e.jsx)(Fn.sk,{mixed:!L,onChange:E,current:p?.getRef(),hideTextValue:F,width:F?8:void 0},`${t}-ds-picker`),(0,e.jsx)(os,{exploreId:t,timeZone:h,extensionsToShow:"queryless"},"toolbar-extension-point")].filter(Boolean),forceShowLeftItems:!0,children:[i?(0,e.jsxs)(co.e,{children:[(0,e.jsx)(ie.I,{variant:"canvas",tooltip:j?(0,a.t)("explore.toolbar.split-narrow","Narrow pane"):(0,a.t)("explore.toolbar.split-widen","Widen pane"),onClick:le,icon:j?"gf-movepane-left":"gf-movepane-right",iconOnly:!0,className:(0,u.cx)(H&&c.rotateIcon)}),(0,e.jsx)(ie.I,{tooltip:(0,a.t)("explore.toolbar.split-close-tooltip","Close split pane"),onClick:se,icon:"times",variant:"canvas",children:(0,e.jsx)(a.x6,{i18nKey:"explore.toolbar.split-close",children:" Close "})})]},"split-controls"):(0,e.jsx)(ie.I,{variant:"canvas",tooltip:(0,a.t)("explore.toolbar.split-tooltip","Split the pane"),onClick:V,icon:"columns",disabled:f,children:(0,e.jsx)(a.x6,{i18nKey:"explore.toolbar.split-title",children:"Split"})},"split"),(0,e.jsx)(os,{exploreId:t,timeZone:h,extensionsToShow:"basic"},"toolbar-extension-point"),!f&&(0,e.jsx)(An,{exploreId:t,range:g,timeZone:h,fiscalYearStartMonth:m,onChangeTime:o,splitted:i,syncedTimes:T,onChangeTimeSync:Te,hideText:R,onChangeTimeZone:K,onChangeFiscalYearStartMonth:nt},"timeControls"),(0,e.jsx)(Pt.cC,{onIntervalChanged:Me,value:x,isLoading:v,text:R?void 0:Q,tooltip:R?Q:void 0,intervals:uo.TP.getValidIntervals(Pt.cb),isLive:f,onRefresh:()=>J(v),noIntervalPicker:f,primary:!0,width:(R?35:108)+"px"},"refreshPicker"),p?.meta.streaming&&(0,e.jsx)(ss,{exploreId:t,children:W=>{const Oe={...W,start:()=>{(0,N.rR)("grafana_explore_logs_live_tailing_clicked",{datasourceType:p?.type}),W.start()}};return(0,e.jsx)(Pn,{splitted:i,isLive:f,isPaused:y,start:Oe.start,pause:Oe.pause,resume:Oe.resume,stop:Oe.stop})}},"liveControls")].filter(Boolean)})]})}var je=l(1906),qn=l(94814);function Mt(t,o={}){(0,N.rR)(`grafana_flamegraph_${t}`,{app:je.Jk.Unknown,grafana_version:P.$.buildInfo.version,...o})}const Gn=t=>{const o=(0,k.of)(s=>Zn(s));return(0,e.jsx)("div",{className:o.container,children:(0,e.jsx)(qn.Ay,{data:t.dataFrames[0],stickyHeader:!0,getTheme:()=>P.$.theme2,onTableSymbolClick:()=>Mt("table_item_selected"),onViewSelected:s=>Mt("view_selected",{view:s}),onTextAlignSelected:s=>Mt("text_align_selected",{align:s}),onTableSort:s=>Mt("table_sort_selected",{sort:s})})})},Zn=t=>({container:(0,u.css)({background:t.colors.background.primary,display:"flow-root",padding:t.spacing(0,1,1,1),border:`1px solid ${t.components.panel.borderColor}`,borderRadius:t.shape.radius.default})});var Yn=l(5929),ns=l(84140),te=l(739),rs=l(80011),Jn=l(25461),Xn=l(21429),de=l(74746),_n=l(66178),er=l(55555);const as=150,tr=({resetKey:t,humanize:o,className:s})=>{const[n,r]=(0,d.useState)(0);return(0,_n.A)(()=>r(n+as),as),(0,d.useEffect)(()=>r(0),[t]),(0,e.jsx)(er.g,{timeInMs:n,className:s,humanize:o})};var or=l(83953);const sr=t=>{const o=(0,u.keyframes)({from:{backgroundColor:(0,ns.A)(t.colors.info.transparent).setAlpha(.25).toString()},to:{backgroundColor:"transparent"}});return{logsRowsLive:(0,u.css)({label:"logs-rows-live",fontFamily:t.typography.fontFamilyMonospace,fontSize:t.typography.bodySmall.fontSize,display:"flex",flexFlow:"column nowrap",height:"60vh",overflowY:"scroll",":first-child":{marginTop:"auto !important"}}),logsRowFade:(0,u.css)({label:"logs-row-fresh",color:t.colors.text.primary,backgroundColor:(0,ns.A)(t.colors.info.transparent).setAlpha(.25).toString(),[t.transitions.handleMotion("no-preference","reduce")]:{animation:`${o} 1s ease-out 1s 1 normal forwards`}}),logsRowsIndicator:(0,u.css)({fontSize:t.typography.h6.fontSize,paddingTop:t.spacing(1),display:"flex",alignItems:"center"}),button:(0,u.css)({marginRight:t.spacing(1)}),fullWidth:(0,u.css)({width:"100%"})}};class nr extends d.PureComponent{constructor(o){super(o),this.liveEndDiv=null,this.scrollContainerRef=d.createRef(),this.onScroll=s=>{const{isPaused:n,onPause:r}=this.props,{scrollTop:i,clientHeight:c,scrollHeight:h}=s.currentTarget;h-(i+c)>=5&&!n&&r()},this.rowsToRender=()=>{const{isPaused:s}=this.props;let{logRowsToRender:n=[]}=this.state;return s||(n=(0,de.oR)(n,te.uH.Ascending).slice(-100)),n},this.state={logRowsToRender:o.logRows}}static getDerivedStateFromProps(o,s){return o.isPaused&&o.clearedAtIndex?{logRowsToRender:(0,or.pg)(o.clearedAtIndex,s.logRowsToRender)}:o.isPaused?null:{logRowsToRender:o.logRows}}render(){const{theme:o,timeZone:s,onPause:n,onResume:r,onClear:i,isPaused:c}=this.props,h=sr(o),{logsRow:m,logsRowLocalTime:x,logsRowMessage:p}=(0,Xn.D)(o);return(0,e.jsxs)("div",{children:[(0,e.jsx)("table",{className:h.fullWidth,children:(0,e.jsxs)("tbody",{onScroll:c?void 0:this.onScroll,className:h.logsRowsLive,ref:this.scrollContainerRef,children:[this.rowsToRender().map(g=>(0,e.jsxs)("tr",{className:(0,u.cx)(m,h.logsRowFade),children:[(0,e.jsx)("td",{className:x,children:(0,rs.LE)(g.timeEpochMs,{timeZone:s})}),(0,e.jsx)("td",{className:p,children:g.hasAnsi?(0,e.jsx)(Jn.$,{value:g.raw}):g.entry})]},g.uid)),(0,e.jsx)("tr",{ref:g=>{this.liveEndDiv=g,this.liveEndDiv&&this.scrollContainerRef.current?.scrollTo&&!c&&this.scrollContainerRef.current?.scrollTo(0,this.scrollContainerRef.current.scrollHeight)}})]})}),(0,e.jsxs)("div",{className:h.logsRowsIndicator,children:[(0,e.jsx)(b.$n,{icon:c?"play":"pause",variant:"secondary",onClick:c?r:n,className:h.button,children:c?(0,a.t)("explore.live-logs.resume","Resume"):(0,a.t)("explore.live-logs.pause","Pause")}),(0,e.jsx)(b.$n,{icon:"trash-alt",variant:"secondary",onClick:i,className:h.button,children:(0,e.jsx)(a.x6,{i18nKey:"explore.live-logs.clear-logs",children:"Clear logs"})}),(0,e.jsx)(b.$n,{icon:"square-shape",variant:"secondary",onClick:this.props.stopLive,className:h.button,children:(0,e.jsx)(a.x6,{i18nKey:"explore.live-logs.exit-live-mode",children:"Exit live mode"})}),c||this.rowsToRender().length>0&&(0,e.jsx)("span",{children:(0,e.jsxs)(a.x6,{i18nKey:"explore.live-logs.last-line-received",components:{elapsedTime:(0,e.jsx)(tr,{resetKey:this.props.logRows,humanize:!0})},children:["Last line received: ","<elapsedTime />"," ago"]})})]})]})}}const rr=(0,k.cV)(nr);var ar=l(84596),ir=l(17548),is=l(57852),ls=l(5556),Ht=l(49256),Bt=l(77824),lr=l(97095),De=l(18027),Ke=l(21285),ne=l(29043),cr=l(44376),dr=l(17896),cs=l(48575),ur=l(27789),pr=l(96195),ds=l(82423),us=l(29457),po=l(37234),$t=l(7795),gr=l(24162),ft=l(8535);function hr(){(0,N.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-added"})}function mr(){(0,N.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-deleted"})}function fr(){(0,N.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-limit-reached"})}function xr(){(0,N.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-clicked"})}function yr(){(0,N.rR)("explore_toolbar_contentoutline_clicked",{item:"section",type:"Logs:pinned:pinned-log-deleted"})}function dl(t){reportInteraction("explore_toolbar_contentoutline_clicked",{item:"section",type:`Logs:filter:${t}`})}var ps=l(55133),vr=l(89640);function br({feedbackUrl:t}){return(0,e.jsx)(Ve.B,{children:(0,e.jsx)(vr.Y,{href:t,external:!0,children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs-feedback.give-feedback",children:"Give feedback"})})})}var gs=l(59896);const hs=t=>({metaContainer:(0,u.css)({flex:1,color:t.colors.text.secondary,marginBottom:t.spacing(2),minWidth:"30%",display:"flex",flexWrap:"wrap"}),metaItem:(0,u.css)({marginRight:t.spacing(2),marginTop:t.spacing(.5),display:"flex",alignItems:"center",".logs-meta-item__error":{color:t.colors.error.text}}),metaLabel:(0,u.css)({marginRight:`calc(${t.spacing(2)} / 2)`,fontSize:t.typography.bodySmall.fontSize,fontWeight:t.typography.fontWeightMedium,whiteSpace:"nowrap"}),metaValue:(0,u.css)({fontFamily:t.typography.fontFamilyMonospace,fontSize:t.typography.bodySmall.fontSize})}),Cr=(0,d.memo)(function(o){const s=(0,k.of)(hs),{label:n,value:r}=o;return(0,e.jsxs)("div",{"data-testid":"meta-info-text-item",className:s.metaItem,children:[n&&(0,e.jsxs)("span",{className:s.metaLabel,children:[n,":"]}),(0,e.jsx)("span",{className:s.metaValue,children:r})]})}),go=(0,d.memo)(function(o){const s=(0,k.of)(hs),{metaItems:n}=o;return(0,e.jsx)("div",{className:s.metaContainer,"data-testid":"meta-info-text",children:n.map((r,i)=>(0,e.jsx)(Cr,{label:r.label,value:r.value},`${i}-${r.label}`))})});var X=l(70159);const Sr=()=>({metaContainer:(0,u.css)({flex:1,display:"flex",flexWrap:"wrap","& span":{fontWeight:"normal",lineHeight:"1.25em"}})}),ms=(0,d.memo)(({meta:t,dedupStrategy:o,dedupCount:s,displayedFields:n,clearDetectedFields:r,logRows:i})=>{const c=(0,k.of)(Sr),h=[...t];o!==te.fY.none&&h.push({label:(0,a.t)("explore.logs-meta-row.label.deduplication-count","Deduplication count"),value:s,kind:ee.tG.Number}),n?.length>0&&h.push({label:(0,a.t)("explore.logs-meta-row.label.showing-only-selected-fields","Showing only selected fields"),value:(0,e.jsx)(gs.A,{labels:n})},{label:"",value:(0,e.jsx)(b.$n,{variant:"primary",fill:"outline",size:"sm",onClick:r,children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs-meta-row.show-original-line",children:"Show original line"})})});function m(f){(0,N.rR)("grafana_logs_download_logs_clicked",{app:je.Jk.Explore,format:f,area:"logs-meta-row"}),(0,de.K7)(f,i,t)}const x=(0,e.jsxs)(ke.W,{children:[(0,e.jsx)(ke.W.Item,{label:"txt",onClick:()=>m(de.s.Text)}),(0,e.jsx)(ke.W.Item,{label:"json",onClick:()=>m(de.s.Json)}),(0,e.jsx)(ke.W.Item,{label:"csv",onClick:()=>m(de.s.CSV)})]}),g={onDisplayMaxToggle:f=>{Xe.M.set(X.$Z.commonLabels,f)},displayMax:3,displayAll:Xe.M.getBool(X.$Z.commonLabels,!1)};return(0,e.jsx)(e.Fragment,{children:h&&(0,e.jsxs)("div",{className:c.metaContainer,children:[(0,e.jsx)(go,{metaItems:h.map(f=>({label:f.label,value:"kind"in f?jr(f.value,f.kind,g):f.value}))}),!P.$.featureToggles.logsPanelControls&&!P.$.featureToggles.newLogsPanel&&!P.$.exploreHideLogsDownload&&(0,e.jsx)(mt.m,{overlay:x,children:(0,e.jsx)(ie.I,{isOpen:!1,variant:"canvas",icon:"download-alt",children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs-meta-row.download",children:"Download"})})})]})})});ms.displayName="LogsMetaRow";function jr(t,o,s){return typeof t=="string"||typeof t=="number"?(0,e.jsx)(e.Fragment,{children:t}):o===ee.tG.LabelsMap?(0,e.jsx)(gs.h,{labels:t,...s}):o===ee.tG.Error?(0,e.jsx)("span",{className:"logs-meta-item__error",children:t.toString()}):(console.error(`Meta type ${typeof t} ${t} not recognized.`),(0,e.jsx)(e.Fragment,{}))}var ho=l(68079),Rr=l(31937),Tr=l(5421);function wr({pages:t,currentPageIndex:o,oldestLogsFirst:s,timeZone:n,loading:r,onClick:i}){const c=p=>`${(0,rs.LE)(p,{format:Tr.WC.interval.second,timeZone:n})}`,h=(p,g)=>{if(o===g&&r)return(0,e.jsx)(ho.y,{});const f=c(s?p.logsRange.from:p.logsRange.to),y=c(s?p.logsRange.to:p.logsRange.from);return`${f} \u2014 ${y}`},m=(0,k.$j)(),x=Lr(m,r);return(0,e.jsx)(oo.P,{children:(0,e.jsx)("div",{className:x.pagesWrapper,"data-testid":"logsNavigationPages",children:(0,e.jsx)("div",{className:x.pagesContainer,children:t.map((p,g)=>(0,e.jsxs)("button",{type:"button","data-testid":`page${g+1}`,className:(0,u.cx)((0,b.my)(m),x.page),onClick:()=>{i(p,g+1)},disabled:r,children:[(0,e.jsx)("div",{className:(0,u.cx)(x.line,{selectedBg:o===g})}),(0,e.jsx)("div",{className:(0,u.cx)(x.time,{selectedText:o===g}),children:h(p,g)})]},p.queryRange.to))})})})}const Lr=(t,o)=>({pagesWrapper:(0,u.css)({height:"100%",paddingLeft:t.spacing(.5),display:"flex",flexDirection:"column","&::after":{content:"''",display:"block",background:`repeating-linear-gradient(135deg, ${t.colors.background.primary}, ${t.colors.background.primary} 5px, ${t.colors.background.secondary} 5px, ${t.colors.background.secondary} 15px)`,width:"3px",height:"inherit",marginBottom:t.spacing(1)}}),pagesContainer:(0,u.css)({display:"flex",padding:0,flexDirection:"column"}),page:(0,u.css)({display:"flex",margin:t.spacing(2,0),cursor:o?"auto":"pointer",whiteSpace:"normal",".selectedBg":{background:t.colors.primary.main},".selectedText":{color:t.colors.primary.main}}),line:(0,u.css)({width:"3px",height:"100%",alignItems:"center",background:t.colors.text.secondary}),time:(0,u.css)({width:"60px",minHeight:"80px",fontSize:t.v1.typography.size.sm,paddingLeft:t.spacing(.5),display:"flex",alignItems:"center"})});function Ir({absoluteRange:t,logsSortOrder:o,timeZone:s,loading:n,onChangeTime:r,scrollToTopLogs:i,scrollToBottomLogs:c,visibleRange:h,queries:m,clearCache:x,addResultsToCache:p}){const[g,f]=(0,d.useState)([]),y=(0,d.useRef)(),T=(0,d.useRef)(),v=(0,d.useRef)(0),j=(0,d.useMemo)(()=>g.findIndex(K=>K.queryRange.to===t.to),[t.to,g]),R=o===te.uH.Ascending,F=R?j===g.length-1:j===0,I=R?j===0:j===g.length-1,C=(0,k.$j)(),L=Fr(C,R);(0,d.useEffect)(()=>{const K={logsRange:h,queryRange:t};let V=[];!(0,_.isEqual)(T.current,t)||!(0,_.isEqual)(y.current,m)?(x(),f([K]),y.current=m,v.current=t.to-t.from):f(se=>(V=se.filter(le=>!(0,_.isEqual)(K.queryRange,le.queryRange)),V=[...V,K].sort((le,Te)=>D(le,Te,o)),V))},[h,t,o,m,x,p]);const S=(0,d.useCallback)(({from:K,to:V})=>{p(),T.current={from:K,to:V},r({from:K,to:V})},[r,p]),D=(K,V,se)=>se===te.uH.Ascending?K.queryRange.to>V.queryRange.to?1:-1:K.queryRange.to>V.queryRange.to?-1:1,M=(0,e.jsx)(b.$n,{"data-testid":"olderLogsButton",className:L.navButton,variant:"secondary",onClick:()=>{if((0,N.rR)("grafana_explore_logs_pagination_clicked",{pageType:"olderLogsButton"}),I)S({from:h.from-v.current,to:h.from});else{const K=R?-1:1;S({from:g[j+K].queryRange.from,to:g[j+K].queryRange.to})}i()},disabled:n,children:(0,e.jsxs)("div",{className:L.navButtonContent,children:[n?(0,e.jsx)(ho.y,{}):(0,e.jsx)(ue.I,{name:R?"angle-up":"angle-down",size:"lg"}),(0,e.jsx)(a.x6,{i18nKey:"logs.logs-navigation.older-logs",children:"Older logs"})]})}),H=(0,e.jsx)(b.$n,{"data-testid":"newerLogsButton",className:L.navButton,variant:"secondary",onClick:()=>{if((0,N.rR)("grafana_explore_logs_pagination_clicked",{pageType:"newerLogsButton"}),!F){const K=R?1:-1;S({from:g[j+K].queryRange.from,to:g[j+K].queryRange.to})}i()},disabled:n||F,children:(0,e.jsxs)("div",{className:L.navButtonContent,children:[n&&(0,e.jsx)(ho.y,{}),F||n?null:(0,e.jsx)(ue.I,{name:R?"angle-down":"angle-up",size:"lg"}),F?(0,a.t)("logs.logs-navigation.start-of-range","Start of range"):(0,a.t)("logs.logs-navigation.newer-logs","Newer logs")]})}),Q=(0,d.useCallback)((K,V)=>{(0,N.rR)("grafana_explore_logs_pagination_clicked",{pageType:"page",pageNumber:V}),S({from:K.queryRange.from,to:K.queryRange.to}),i()},[S,i]),E=(0,d.useCallback)(()=>{(0,N.rR)("grafana_explore_logs_scroll_top_clicked"),i()},[i]),J=(0,d.useCallback)(()=>{(0,N.rR)("grafana_explore_logs_scroll_bottom_clicked"),c?.()},[c]);return(0,e.jsxs)("div",{className:L.navContainer,children:[!P.$.featureToggles.logsInfiniteScrolling&&(0,e.jsxs)(e.Fragment,{children:[R?M:H,(0,e.jsx)(wr,{pages:g,currentPageIndex:j,oldestLogsFirst:R,timeZone:s,loading:n,onClick:Q}),R?H:M]}),c&&(0,e.jsx)(b.$n,{"data-testid":"scrollToBottom",className:L.scrollToBottomButton,variant:"secondary",onClick:J,title:(0,a.t)("logs.logs-navigation.scroll-bottom","Scroll to bottom"),children:(0,e.jsx)(ue.I,{name:"arrow-down",size:"lg"})}),(0,e.jsx)(b.$n,{"data-testid":"scrollToTop",className:L.scrollToTopButton,variant:"secondary",onClick:E,title:(0,a.t)("logs.logs-navigation.scroll-top","Scroll to top"),children:(0,e.jsx)(ue.I,{name:"arrow-up",size:"lg"})})]})}const Er=(0,d.memo)(Ir),Fr=(t,o)=>{const s=`calc(100vh - 2*${t.spacing(2)} - 2*${(0,Rr.vn)()}px)`;return{navContainer:(0,u.css)({maxHeight:s,width:o&&!P.$.featureToggles.newLogsPanel?"58px":"auto",display:"flex",flexDirection:"column",justifyContent:P.$.featureToggles.logsInfiniteScrolling?"flex-end":o?"flex-start":"space-between",position:"sticky",top:t.spacing(2),right:0}),navButton:(0,u.css)({width:"58px",height:"68px",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",lineHeight:1}),navButtonContent:(0,u.css)({display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",width:"100%",height:"100%",whiteSpace:"normal"}),scrollToBottomButton:(0,u.css)({width:"40px",height:"40px",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",position:"absolute",top:0}),scrollToTopButton:(0,u.css)({width:"40px",height:"40px",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",marginTop:t.spacing(1)})}};var fs=l(25984),Dr=l(16515),Or=l(76732);const Ar=100;function Vt(t){const[o,s]=(0,d.useState)(!1),[n,r]=(0,d.useState)(!1),{dismissable:i,error:c,title:h,suggestedAction:m,onSuggestedAction:x,onRemove:p,severity:g="warning"}=t,f=t.message??c?.message??c?.data?.message??"",y=typeof f=="string"&&f.length>Ar,T=(0,k.$j)(),v=Pr(T),j=(0,d.useCallback)(()=>{r(!0)},[]),R=i?j:p;return n?null:(0,e.jsx)("div",{className:v.supplementaryErrorContainer,children:(0,e.jsx)(ht.F,{title:h,severity:g,onRemove:R,children:y?(0,e.jsx)("div",{className:v.messageWrapper,children:o?f:(0,e.jsx)(b.$n,{variant:"secondary",size:"xs",onClick:()=>{s(!0)},children:(0,e.jsx)(a.x6,{i18nKey:"explore.supplementary-result-error.show-details",children:"Show details"})})}):(0,e.jsxs)("div",{className:`${v.messageWrapper} ${v.suggestedActionWrapper}`,children:[f,m&&x&&(0,e.jsx)(b.$n,{variant:"primary",size:"xs",onClick:x,children:m})]})})})}const Pr=t=>({supplementaryErrorContainer:(0,u.css)({width:"60%",minWidth:`${t.breakpoints.values.sm}px`,maxWidth:`${t.breakpoints.values.md}px`,margin:"0 auto"}),messageWrapper:(0,u.css)({minHeight:t.spacing(3),ul:{paddingLeft:t.spacing(2)},button:{position:"absolute",bottom:t.spacing(2),right:t.spacing(2)}}),suggestedActionWrapper:(0,u.css)({paddingBottom:t.spacing(5)})});var Nr=l(97486);function kr(t){const{width:o,timeZone:s,splitOpen:n,onUpdateTimeRange:r,onHiddenSeriesChanged:i,allLogsVolumeMaximum:c,toggleLegendRef:h}=t,m=(0,k.$j)(),x=(0,k.of)(Mr),p=parseInt(m.spacing(2).slice(0,-2),10),g=150,f=t.logsVolumeData,y=(0,de.Dm)(f?.data);let T=y?`${y.name}`:"";(0,de.e3)(f.data)&&(T=[T,"This datasource does not support full-range histograms. The graph below is based on the logs seen in the response."].filter(_.identity).join(". "));let v=(0,e.jsx)("span",{children:T});return f.state===pe.Gu.Streaming&&(v=(0,e.jsxs)(e.Fragment,{children:[v,(0,e.jsx)(ye.m,{content:(0,a.t)("explore.logs-volume-panel.content-streaming","Streaming"),children:(0,e.jsx)(ue.I,{name:"circle-mono",size:"md",className:x.streaming,"data-testid":"logs-volume-streaming"})})]})),(0,e.jsxs)("div",{style:{height:g},className:x.contentContainer,children:[(0,e.jsx)(Nr.k,{toggleLegendRef:h,vizLegendOverrides:{calcs:["sum"]},graphStyle:"lines",loadingState:f.state??pe.Gu.Done,data:f.data,height:g,width:o-p*2,timeRange:t.timeRange,onChangeTime:r,timeZone:s,splitOpenFn:n,tooltipDisplayMode:te.$N.Multi,onHiddenSeriesChanged:i,anchorToZero:!0,yAxisMaximum:c,eventBus:t.eventBus,annotations:t.annotations}),v&&(0,e.jsx)("div",{className:x.extraInfoContainer,children:v})]})}const Mr=t=>({extraInfoContainer:(0,u.css)({display:"flex",justifyContent:"end",position:"absolute",right:"5px",top:"-10px",fontSize:t.typography.bodySmall.fontSize,color:t.colors.text.secondary}),contentContainer:(0,u.css)({display:"flex",alignItems:"center",justifyContent:"center",position:"relative"}),streaming:(0,u.css)({color:t.colors.success.text})});function Hr(t){return!t||!t.error&&!t.errors?!1:(t.error?[t.error]:t.errors||[]).some(s=>(`${s.message||s.data?.message}`?.toLowerCase()).includes("timeout"))}const Br=({logsVolumeData:t,absoluteRange:o,onUpdateTimeRange:s,width:n,onLoadLogsVolume:r,onDisplayedSeriesChanged:i,eventBus:c,splitOpen:h,timeZone:m,onClose:x,toggleLegendRef:p})=>{const{logVolumes:g,maximumValue:f,maximumRange:y,annotations:T}=(0,d.useMemo)(()=>{let M=-1/0;const H=t?.data.filter(se=>se.meta?.dataTopic!==te.QR.Annotations),Q=t?.data.filter(se=>se.meta?.dataTopic===te.QR.Annotations)||[],E=(0,_.sortBy)(H||[],"meta.custom.datasourceName"),J=(0,_.groupBy)(E,"meta.custom.datasourceName"),K=(0,_.mapValues)(J,se=>{const le=(0,de.oT)(se);return M=Math.max(M,le.maximum),le.dataFrames}),V=(0,de.Dx)((0,_.flatten)(Object.values(K)));return{maximumValue:M,maximumRange:V,logVolumes:K,annotations:Q}},[t]),v=(0,k.of)($r),j=Object.keys(g).length,R=Object.values(g).some(M=>{const H=Vr(M,o);return!(0,de.e3)(M)&&H&&H<1}),F=P.$.featureToggles.lokiShardSplitting&&t&&t.data.length>0,I=Hr(t),C=(0,et.KQ)(Math.max(o.from,y.from)),L=(0,et.KQ)(Math.min(o.to,y.to)),S={from:C,to:L,raw:{from:C,to:L}},D=(0,d.useCallback)(M=>{if(j>1)return;const H=[...new Set(Object.values(g).map(E=>E.map(J=>(0,Dr.Ri)(J))).flat())],Q=H.filter(E=>!M.includes(E));i((0,Or.ab)(H,Q)?[]:Q)},[g,j,i]);return t?.state===pe.Gu.Loading?(0,e.jsx)("span",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs-volume-panel-list.loading",children:"Loading..."})}):I&&!F?(0,e.jsx)(Vt,{title:(0,a.t)("explore.logs-volume-panel-list.title-unable-to-show-log-volume","Unable to show log volume"),message:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("p",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs.logs-volume.much-data",children:"The query is trying to access too much data. Try one or more of the following:"})}),(0,e.jsxs)("ul",{children:[(0,e.jsx)("li",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs.logs-volume.add-filters",children:"Add more labels to your query to narrow down your search."})}),(0,e.jsx)("li",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs.logs-volume.decrease-timerange",children:"Decrease the time range of your query."})})]})]}),severity:"info",suggestedAction:"Retry",onSuggestedAction:r,onRemove:x}):t?.error!==void 0&&!F?(0,e.jsx)(Vt,{error:t.error,title:(0,a.t)("explore.logs-volume-panel-list.title-failed-volume-query","Failed to load log volume for this query")}):j===0&&t?.state!==pe.Gu.Streaming?(0,e.jsx)("div",{className:v.alertContainer,children:(0,e.jsx)(ht.F,{severity:"info",title:(0,a.t)("explore.logs-volume-panel-list.title-no-logs-volume-available","No logs volume available"),children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs-volumne-panel-list.body-no-logs-volume-available",children:"No volume information available for the current queries and time range."})})}):(0,e.jsxs)("div",{className:v.listContainer,children:[I&&F&&(0,e.jsx)(Vt,{title:(0,a.t)("explore.logs-volume-panel-list.title-showing-partial-data","Showing partial data"),message:"The query is trying to access too much data and some sharded requests could not be completed. Try decreasing the time range or adding more labels to your query.",severity:"info",dismissable:!0}),Object.keys(g).map((M,H)=>(0,e.jsx)(kr,{toggleLegendRef:p,timeRange:S,allLogsVolumeMaximum:f,width:n,logsVolumeData:{data:g[M],state:t?.state},onUpdateTimeRange:s,timeZone:m,splitOpen:h,onLoadLogsVolume:r,onHiddenSeriesChanged:j>1?()=>{}:D,eventBus:c,annotations:T},H)),R&&(0,e.jsx)("div",{className:v.extraInfoContainer,children:(0,e.jsx)(De.I,{label:(0,a.t)("explore.logs-volume-panel-list.label-reload-log-volume","Reload log volume"),transparent:!0,children:(0,e.jsx)(b.$n,{"aria-label":(0,a.t)("explore.logs-volume-panel-list.aria-label-reload-log-volume","Reload log volume"),size:"xs",icon:"sync",variant:"secondary",onClick:r,id:"reload-volume"})})})]})},$r=t=>({listContainer:(0,u.css)({paddingTop:"10px"}),extraInfoContainer:(0,u.css)({display:"flex",justifyContent:"end",position:"absolute",right:"5px",top:"5px"}),oldInfoText:(0,u.css)({fontSize:t.typography.bodySmall.fontSize,color:t.colors.text.secondary}),alertContainer:(0,u.css)({width:"50%",minWidth:`${t.breakpoints.values.sm}px`,margin:"0 auto"})});function Vr(t,o){const s=t&&t[0]&&t[0].meta?.custom?.absoluteRange;return s?(o.from-o.to)/(s.from-s.to):void 0}const Qr=[te.fY.none,te.fY.exact,te.fY.numbers,te.fY.signature],mo=()=>{const t=ne.A.get(X.r3);return t==="table"?"table":t==="logs"?"logs":P.$.featureToggles.logsExploreTableDefaultVisualization?"table":"logs"},Qt=10,fo="Pinned log",xs="Pin to content outline",Wt="Logs",Wr=t=>{const{width:o,splitOpen:s,logRows:n,logsMeta:r,logsVolumeEnabled:i,logsVolumeData:c,loadLogsVolumeData:h,loading:m=!1,onClickFilterLabel:x,onClickFilterOutLabel:p,timeZone:g,scanning:f,scanRange:y,showContextToggle:T,absoluteRange:v,onChangeTime:j,getFieldLinks:R,theme:F,logsQueries:I,clearCache:C,addResultsToCache:L,exploreId:S,getRowContext:D,getLogRowContextUi:M,getRowContextQuery:H,loadMoreLogs:Q,panelState:E,eventBus:J,onPinLineCallback:K,scrollElement:V}=t,[se,le]=(0,d.useState)(ne.A.getBool(X.$Z.showLabels,!1)),[Te,nt]=(0,d.useState)(ne.A.getBool(X.$Z.showTime,!0)),[Me,Kt]=(0,d.useState)(ne.A.getBool(X.$Z.wrapLogMessage,!0)),[W,Oe]=(0,d.useState)(ne.A.getBool(X.$Z.prettifyLogMessage,!1)),[Ae,As]=(0,d.useState)(te.fY.none),[He,Qi]=(0,d.useState)(ne.A.get(X.$Z.logsSortOrder)||te.uH.Descending),[Wi,Ps]=(0,d.useState)(!1),[ge,yt]=(0,d.useState)([]),[Ns,ks]=(0,d.useState)(!1),[we,Ms]=(0,d.useState)(void 0),[wo,Hs]=(0,d.useState)(xs),[ce,Bs]=(0,d.useState)(E?.logs?.visualisationType??mo()),Se=(0,d.useRef)(null),Be=(0,A.wA)(),$s=(0,ar.A)(m),zi=J.newScopedBus("logsvolume",{onlyLocal:!1}),{register:Vs,unregister:Lo,outlineItems:rt,updateItem:Io}=no()??{},Eo=(0,d.useRef)(void 0),Fo=(0,d.useRef)(void 0),Ut=(0,d.useRef)(()=>{}),Do=(0,d.useRef)(null),[Qs,Ws]=(0,d.useState)(void 0),Ki=(0,fs.z)(),G=Kr(F,Me||ce==="table",Ki),vt=n&&n.length>0,Ui=y?`Scanning ${ir.describeTimeRange(y)}`:"Scanning...",zs=rt?.find(w=>w.panelId===Wt&&w.level==="root"),bt=(0,d.useMemo)(()=>zs?.children?.filter(w=>w.title===fo).map(w=>w.id),[zs?.children]),Ct=(0,d.useCallback)(()=>rt?.find(B=>B.panelId===Wt&&B.level==="root")?.children?.filter(B=>B.title===fo).length??0,[rt]);(0,d.useEffect)(()=>{Ct()===Qt?Hs((0,e.jsxs)("span",{style:{display:"flex",textAlign:"center"},children:["\u2757\uFE0F",(0,e.jsxs)(a.x6,{i18nKey:"explore.logs.maximum-pinned-logs",children:["Maximum of ",{PINNED_LOGS_LIMIT:Qt}," pinned logs reached. Unpin a log to add another."]})]})):Hs(xs)},[rt,Ct]),(0,d.useEffect)(()=>{m&&!$s&&E?.logs?.id&&(delete E.logs.id,Be((0,ve.EA)(S,"logs",{...E})))},[Be,S,m,E,$s]),(0,d.useEffect)(()=>{const w=E?.logs?.visualisationType??mo();Bs(w),ne.A.set(X.r3,w)},[E?.logs?.visualisationType]),(0,d.useEffect)(()=>{let w=[];Array.isArray(E?.logs?.displayedFields)?w=E?.logs?.displayedFields:E?.logs?.displayedFields&&typeof E?.logs?.displayedFields=="object"&&(w=Object.values(E?.logs?.displayedFields)),yt(w)},[E?.logs?.displayedFields]),(0,lt.A)(()=>{Eo&&window.clearTimeout(Eo.current),Fo&&window.clearTimeout(Fo.current)}),(0,lt.A)(()=>{(E?.logs?.columns||E?.logs?.refId||E?.logs?.labelFieldName||E?.logs?.displayedFields)&&Be((0,ve.EA)(S,"logs",{...E?.logs,columns:void 0,visualisationType:ce,labelFieldName:void 0,refId:void 0,displayedFields:void 0}))});const Le=(0,d.useCallback)(w=>{const B=(0,ft.Gu)().explore.panes[S];B?.panelsState&&Be((0,ve.EA)(S,"logs",{...B.panelsState.logs,columns:w.columns??E?.logs?.columns,visualisationType:w.visualisationType??ce,labelFieldName:w.labelFieldName,refId:w.refId??E?.logs?.refId,displayedFields:w.displayedFields??E?.logs?.displayedFields}))},[Be,S,E?.logs?.columns,E?.logs?.displayedFields,E?.logs?.refId,ce]),Oo=(0,d.useCallback)(w=>{w?t.eventBus.publish(new is.b_({point:{time:w.timeEpochMs}})):t.eventBus.publish(new is.ql)},[t.eventBus]),qi=(0,d.useCallback)(w=>{if(P.$.featureToggles.logsInfiniteScrolling){Se.current&&(Do.current?.scrollIntoView(),Se.current.scroll({behavior:"smooth",top:Se.current.scrollTop+w.getBoundingClientRect().top-window.innerHeight/2}));return}V&&V.scroll({behavior:"smooth",top:V.scrollTop+w.getBoundingClientRect().top-window.innerHeight/2})},[V]),qt=(0,d.useCallback)(w=>{if(!I)return;let B=!1;const Y=I.map(re=>{if(re.datasource?.type!=="loki"||!(0,gr.kr)(re)||re.direction===$t.ti.Scan)return re;B=!0;const xe=w===te.uH.Ascending?$t.ti.Forward:$t.ti.Backward;return xe!==re.direction&&(re.direction=xe),re});B&&(Be((0,z.bO)({exploreId:S,queries:Y})),Be((0,z.Od)({exploreId:S})))},[Be,S,I]),Gi=(0,d.useCallback)(w=>{Ps(!0),Eo.current=window.setTimeout(()=>{ne.A.set(X.$Z.logsSortOrder,w),qt(w),Qi(w)},0),Fo.current=window.setTimeout(()=>Ps(!1),1e3)},[qt]),Zi=(0,d.useCallback)(w=>{Bs(w);const B={...E?.logs,visualisationType:w};Le(B),(0,N.rR)("grafana_explore_logs_visualisation_changed",{newVisualizationType:w,datasourceType:t.datasourceType??"unknown",defaultVisualisationType:P.$.featureToggles.logsExploreTableDefaultVisualization?"table":"logs"})},[E?.logs,t.datasourceType,Le]),Yi=(0,d.useCallback)(w=>{(0,N.rR)("grafana_explore_logs_deduplication_clicked",{deduplicationType:w,datasourceType:t.datasourceType}),As(w)},[t.datasourceType]),Ji=(0,d.useCallback)(w=>{const{target:B}=w;if(B){const Y=B.checked;le(Y),ne.A.set(X.$Z.showLabels,Y)}},[]),Xi=(0,d.useCallback)(w=>{const{target:B}=w;if(B){const Y=B.checked;nt(Y),ne.A.set(X.$Z.showTime,Y)}},[]),_i=(0,d.useCallback)(w=>{const{target:B}=w;if(B){const Y=B.checked;Kt(Y),ne.A.set(X.$Z.wrapLogMessage,Y)}},[]),el=(0,d.useCallback)(w=>{const{target:B}=w;if(B){const Y=B.checked;Oe(Y),ne.A.set(X.$Z.prettifyLogMessage,Y)}},[]),Ks=(0,d.useCallback)(w=>{t.onSetLogsVolumeEnabled(!w),(0,N.rR)("grafana_explore_logs_histogram_toggle_clicked",{datasourceType:t.datasourceType,type:w?"close":"open"})},[t]),tl=(0,d.useCallback)(w=>{w.preventDefault(),t.onStartScanning&&(t.onStartScanning(),(0,N.rR)("grafana_explore_logs_scanning_button_clicked",{type:"start",datasourceType:t.datasourceType}))},[t]),ol=(0,d.useCallback)(w=>{w.preventDefault(),t.onStopScanning&&t.onStopScanning()},[t]),Gt=(0,d.useCallback)(w=>{if(ge.indexOf(w)===-1){const Y=ge.concat(w);yt(Y),Le({...E?.logs,displayedFields:Y})}},[ge,E?.logs,Le]),Zt=(0,d.useCallback)(w=>{if(ge.indexOf(w)>-1){const Y=ge.filter(re=>w!==re);yt(Y),Le({...E?.logs,displayedFields:Y})}},[ge,E?.logs,Le]),sl=(0,d.useCallback)(()=>{Le({...E?.logs,displayedFields:[]}),yt([])},[E?.logs,Le]),Ao=(0,d.useRef)(()=>{});let Us=(0,d.useCallback)(()=>{ks(!1),Ms(void 0),P.$.featureToggles.newLogContext||(0,N.rR)("grafana_explore_logs_log_context_closed",{datasourceType:we?.datasourceType,logRowUid:we?.uid}),Ao?.current()},[we?.datasourceType,we?.uid,Ao]);const St=(0,d.useCallback)((w,B)=>{ks(!0),Ms(w),P.$.featureToggles.newLogContext||(0,N.rR)("grafana_explore_logs_log_context_opened",{datasourceType:w.datasourceType,logRowUid:w.uid}),Ao.current=B},[]),Po=(0,d.useCallback)(async w=>{if(w.rowId===void 0)return;const B=(0,ps.m)((0,ft.Gu)().explore.panes[S]);B.panelsState={...E,logs:{id:w.uid,visualisationType:ce??mo(),displayedFields:ge}},B.range=(0,kt.sU)(w,n,v);const Y=(0,ls.Pp)(B),re=/.*(?=\/explore)/.exec(`${window.location.href}`)[0],xe=ls.kM.renderUrl(`${re}/explore`,{left:Y});await(0,kt.VP)(xe),(0,N.rR)("grafana_explore_logs_permalink_clicked",{datasourceType:w.datasourceType??"unknown",logRowUid:w.uid,logRowLevel:w.logLevel})},[v,ge,S,n,E,ce]),nl=(0,d.useCallback)(()=>{P.$.featureToggles.logsInfiniteScrolling&&Se.current&&Se.current.scroll({behavior:"auto",top:0}),Do.current?.scrollIntoView()},[]),at=(0,d.useCallback)((w,B=!0)=>{if(Ct()===Qt&&!B){fr();return}const Y=rt?.find(xe=>xe.panelId===Wt&&xe.level==="root");Y&&Io&&Io(Y.id,{expanded:!0});const re=bt?.find(xe=>xe===w.rowId);re&&w.rowId&&B?(Lo?.(w.rowId),mr()):Ct()!==Qt&&!re&&(Vs?.({id:w.rowId,icon:"gf-logs",title:fo,panelId:Wt,level:"child",ref:null,color:po.cZ[w.logLevel],childOnTop:!0,onClick:()=>{St(w,()=>{}),xr()},onRemove:xe=>{Lo?.(xe),yr()}}),hr()),K?.()},[Ct,St,K,rt,bt,Vs,Lo,Io]),{dedupedRows:No,dedupCount:rl}=(0,d.useMemo)(()=>Ur(n,Ae),[Ae,n]),al=(0,d.useMemo)(()=>qr(n),[n]),qs=(0,d.useMemo)(()=>!I?.some(w=>"direction"in w&&w.direction===$t.ti.Scan),[I]),Yt=(0,d.useRef)(!0),Gs=(0,d.useCallback)((w,B)=>{if(w==="sortOrder"&&(0,us.Q4)(B))qt(B);else if(w==="dedupStrategy"&&(0,us.KB)(B))As(B);else if(w==="filterLevels"&&Array.isArray(B)&&i){const Y=c?.data.filter(jt=>jt.meta?.dataTopic!==te.QR.Annotations)??[],re=(0,_.groupBy)(Y,"meta.custom.datasourceName");if(Object.keys(re).length>1)return;const Zs=[...new Set(Y.map(jt=>{const{level:Jt}=(0,de.tX)(jt,Y);return(0,de.EK)(Jt)}))];Ws(jt=>{const Jt=B.map(he=>(0,de.EK)(he)),ko=Jt.filter(he=>Zs.includes(he)),Mo=jt?.filter(he=>Zs.includes(he))??[];if(!ko.length){Ut.current?.(void 0,Ht.B.ToggleSelection);return}const ll=ko.filter(he=>!Mo.includes(he)),cl=Mo.filter(he=>!ko.includes(he));return ll.forEach(he=>{Yt.current=!0,Ut.current?.(he,Mo.length?Ht.B.AppendToSelection:Ht.B.ToggleSelection)}),cl.forEach(he=>{Yt.current=!0,Ut.current?.(he,Ht.B.AppendToSelection)}),Jt})}},[c?.data,i,qt]),il=(0,d.useCallback)(w=>{if(Yt.current){Yt.current=!1;return}Ws(w.map(B=>(0,de.EK)(B)))},[]);return(0,e.jsxs)(e.Fragment,{children:[(!P.$.featureToggles.newLogsPanel||!P.$.featureToggles.newLogContext)&&D&&we&&(0,e.jsx)(ur.V,{open:Ns,row:we,onClose:Us,getRowContext:(w,B)=>D(w,we,B),getRowContextQuery:H,getLogRowContextUi:M,logsSortOrder:He,timeZone:g}),P.$.featureToggles.newLogsPanel&&P.$.featureToggles.newLogContext&&D&&we&&(0,e.jsx)(pr.gG,{open:Ns,log:we,onClose:Us,getRowContext:(w,B)=>D(w,we,B),getRowContextQuery:H,getLogRowContextUi:M,logOptionsStorageKey:X.OY,timeZone:g,displayedFields:ge,onClickShowField:Gt,onClickHideField:Zt}),(0,e.jsx)(Fe.NR,{title:(0,a.t)("explore.unthemed-logs.title-logs-volume","Logs volume"),collapsible:!0,collapsed:!i,onToggleCollapse:Ks,children:i&&(0,e.jsx)(Br,{toggleLegendRef:Ut,absoluteRange:v,width:o,logsVolumeData:c,onUpdateTimeRange:j,timeZone:g,splitOpen:s,onLoadLogsVolume:h,onDisplayedSeriesChanged:il,eventBus:zi,onClose:()=>Ks(!0)})}),(0,e.jsxs)(Fe.NR,{titleItems:[P.$.featureToggles.logsExploreTableVisualisation?ce==="logs"?null:(0,e.jsx)(Fe.NR.TitleItem,{title:(0,a.t)("explore.unthemed-logs.title-feedback","Feedback"),children:(0,e.jsx)(br,{feedbackUrl:"https://forms.gle/5YyKdRQJ5hzq4c289"})},"A"):null],title:(0,a.t)("explore.unthemed-logs.title-logs","Logs"),actions:(0,e.jsx)(e.Fragment,{children:P.$.featureToggles.logsExploreTableVisualisation&&(0,e.jsx)("div",{className:G.visualisationType,children:(0,e.jsx)(Bt.z,{className:G.visualisationTypeRadio,options:[{label:(0,a.t)("explore.unthemed-logs.label.logs","Logs"),value:"logs",description:(0,a.t)("explore.unthemed-logs.description.show-results-in-logs-visualisation","Show results in logs visualisation")},{label:(0,a.t)("explore.unthemed-logs.label.table","Table"),value:"table",description:(0,a.t)("explore.unthemed-logs.description.show-results-in-table-visualisation","Show results in table visualisation")}],size:"sm",value:ce,onChange:Zi})})}),loadingState:m?pe.Gu.Loading:pe.Gu.Done,children:[(0,e.jsxs)("div",{className:G.stickyNavigation,children:[ce!=="table"&&!P.$.featureToggles.newLogsPanel&&!P.$.featureToggles.logsPanelControls&&(0,e.jsxs)("div",{className:G.logOptions,children:[(0,e.jsxs)(lr.C,{children:[(0,e.jsx)(De.I,{label:(0,a.t)("explore.unthemed-logs.label-time","Time"),className:G.horizontalInlineLabel,transparent:!0,children:(0,e.jsx)(Ke.K,{value:Te,onChange:Xi,className:G.horizontalInlineSwitch,transparent:!0,id:`show-time_${S}`})}),(0,e.jsx)(De.I,{label:(0,a.t)("explore.unthemed-logs.label-unique-labels","Unique labels"),className:G.horizontalInlineLabel,transparent:!0,children:(0,e.jsx)(Ke.K,{value:se,onChange:Ji,className:G.horizontalInlineSwitch,transparent:!0,id:`unique-labels_${S}`})}),(0,e.jsx)(De.I,{label:(0,a.t)("explore.unthemed-logs.label-wrap-lines","Wrap lines"),className:G.horizontalInlineLabel,transparent:!0,children:(0,e.jsx)(Ke.K,{value:Me,onChange:_i,className:G.horizontalInlineSwitch,transparent:!0,id:`wrap-lines_${S}`})}),(0,e.jsx)(De.I,{label:(0,a.t)("explore.unthemed-logs.label-prettify-json","Prettify JSON"),className:G.horizontalInlineLabel,transparent:!0,children:(0,e.jsx)(Ke.K,{value:W,onChange:el,className:G.horizontalInlineSwitch,transparent:!0,id:`prettify_${S}`})}),(0,e.jsx)(De.I,{label:(0,a.t)("explore.unthemed-logs.label-deduplication","Deduplication"),className:G.horizontalInlineLabel,transparent:!0,children:(0,e.jsx)(Bt.z,{options:Qr.map(w=>({label:(0,_.capitalize)(w),value:w,description:ee._C[w]})),value:Ae,onChange:Yi,className:G.radioButtons})})]}),(0,e.jsx)("div",{children:(0,e.jsx)(De.I,{label:(0,a.t)("explore.unthemed-logs.label-display-results","Display results"),className:G.horizontalInlineLabel,transparent:!0,disabled:Wi||m,children:(0,e.jsx)(Bt.z,{options:[{label:(0,a.t)("explore.unthemed-logs.label.newest-first","Newest first"),value:te.uH.Descending,description:(0,a.t)("explore.unthemed-logs.description.show-results-newest-to-oldest","Show results newest to oldest")},{label:(0,a.t)("explore.unthemed-logs.label.oldest-first","Oldest first"),value:te.uH.Ascending,description:(0,a.t)("explore.unthemed-logs.description.show-results-oldest-to-newest","Show results oldest to newest")}],value:He,onChange:Gi,className:G.radioButtons})})})]}),(0,e.jsx)("div",{ref:Do}),(0,e.jsx)(ms,{logRows:n,meta:r||[],dedupStrategy:Ae,dedupCount:rl,displayedFields:ge,clearDetectedFields:sl})]}),(0,e.jsxs)("div",{className:(0,u.cx)(G.logsSection,ce==="table"?G.logsTable:void 0),children:[!P.$.featureToggles.logsPanelControls&&ce==="table"&&vt&&(0,e.jsx)("div",{className:G.logRows,"data-testid":"logRowsTable",children:(0,e.jsx)(fs.Y,{logsSortOrder:He,range:t.range,splitOpen:s,timeZone:g,width:o-80,logsFrames:t.logsFrames??[],onClickFilterLabel:x,onClickFilterOutLabel:p,panelState:E?.logs,theme:F,updatePanelState:Le,datasourceType:t.datasourceType})}),(!P.$.featureToggles.newLogsPanel||ce==="table")&&P.$.featureToggles.logsPanelControls&&vt&&(0,e.jsx)("div",{className:G.logRowsWrapper,"data-testid":"logRows",children:(0,e.jsx)(cr.U,{logsTableFrames:t.logsFrames,width:o,updatePanelState:Le,panelState:E?.logs,datasourceType:t.datasourceType,splitOpen:s,visualisationType:ce,loading:m,loadMoreLogs:qs?Q:void 0,range:t.range,pinnedLogs:bt,logRows:n,deduplicatedRows:No,dedupStrategy:Ae,onClickFilterLabel:x,onClickFilterOutLabel:p,showContextToggle:T,getRowContextQuery:H,showLabels:se,showTime:Te,enableLogDetails:!0,wrapLogMessage:Me,prettifyLogMessage:W,timeZone:g,getFieldLinks:R,logsSortOrder:He,displayedFields:ge,onClickShowField:Gt,onClickHideField:Zt,app:je.Jk.Explore,onLogRowHover:Oo,onOpenContext:St,onPermalinkClick:Po,permalinkedRowId:E?.logs?.id,isFilterLabelActive:t.isFilterLabelActive,onClickFilterString:t.onClickFilterString,onClickFilterOutString:t.onClickFilterOutString,onUnpinLine:at,onPinLine:at,pinLineButtonTooltipTitle:wo,logsMeta:r,logOptionsStorageKey:X.OY,onLogOptionsChange:Gs,filterLevels:Qs})}),!P.$.featureToggles.logsPanelControls&&!P.$.featureToggles.newLogsPanel&&ce==="logs"&&vt&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("div",{className:P.$.featureToggles.logsInfiniteScrolling?G.scrollableLogRows:G.logRows,"data-testid":"logRows",ref:Se,children:(0,e.jsx)(dr.u8,{loading:m,loadMoreLogs:qs?Q:void 0,range:t.range,timeZone:g,rows:n,scrollElement:Se.current,sortOrder:He,app:je.Jk.Explore,children:(0,e.jsx)(cs.k,{pinnedLogs:bt,logRows:n,deduplicatedRows:No,dedupStrategy:Ae,onClickFilterLabel:x,onClickFilterOutLabel:p,showContextToggle:T,getRowContextQuery:H,showLabels:se,showTime:Te,enableLogDetails:!0,wrapLogMessage:Me,prettifyLogMessage:W,timeZone:g,getFieldLinks:R,logsSortOrder:He,displayedFields:ge,onClickShowField:Gt,onClickHideField:Zt,app:je.Jk.Explore,onLogRowHover:Oo,onOpenContext:St,onPermalinkClick:Po,permalinkedRowId:E?.logs?.id,scrollIntoView:qi,isFilterLabelActive:t.isFilterLabelActive,scrollElement:Se.current,onClickFilterString:t.onClickFilterString,onClickFilterOutString:t.onClickFilterOutString,onUnpinLine:at,onPinLine:at,pinLineButtonTooltipTitle:wo,renderPreview:!0})})}),(0,e.jsx)(Er,{logsSortOrder:He,visibleRange:al??v,absoluteRange:v,timeZone:g,onChangeTime:j,loading:m,queries:I??[],scrollToTopLogs:nl,addResultsToCache:L,clearCache:C})]}),P.$.featureToggles.newLogsPanel&&ce==="logs"&&(0,e.jsx)("div",{"data-testid":"logRows",ref:Se,className:G.logRowsWrapper,children:Se.current&&vt&&(0,e.jsx)(ds.Z,{app:je.Jk.Explore,containerElement:Se.current,enableLogDetails:!0,dedupStrategy:Ae,displayedFields:ge,filterLevels:Qs,getFieldLinks:R,getRowContextQuery:H,isLabelFilterActive:t.isFilterLabelActive,loading:m,loadMore:Q,logOptionsStorageKey:X.OY,logs:No,logsMeta:r,logSupportsContext:T,onClickShowField:Gt,onClickHideField:Zt,onClickFilterLabel:x,onClickFilterOutLabel:p,onClickFilterString:t.onClickFilterString,onClickFilterOutString:t.onClickFilterOutString,onLogOptionsChange:Gs,onLogLineHover:Oo,onOpenContext:St,onPermalinkClick:Po,onPinLine:at,onUnpinLine:at,permalinkedLogId:E?.logs?.id,pinLineButtonTooltipTitle:wo,pinnedLogs:bt,setDisplayedFields:yt,showControls:!0,showTime:Te,sortOrder:He,timeRange:t.range,timeZone:g,wrapLogMessage:Me})}),!m&&!vt&&!f&&(0,e.jsx)("div",{className:G.noDataWrapper,children:(0,e.jsxs)("div",{className:G.noData,children:[(0,e.jsx)(a.x6,{i18nKey:"explore.logs.no-logs-found",children:"No logs found."}),(0,e.jsx)(b.$n,{size:"sm",variant:"secondary",className:G.scanButton,onClick:tl,children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs.scan-for-older-logs",children:"Scan for older logs"})})]})}),f&&(0,e.jsx)("div",{className:G.noDataWrapper,children:(0,e.jsxs)("div",{className:G.noData,children:[(0,e.jsx)("span",{children:Ui}),(0,e.jsx)(b.$n,{size:"sm",variant:"secondary",className:G.scanButton,onClick:ol,children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs.stop-scan",children:"Stop scan"})})]})})]})]})]})},zr=(0,k.cV)(Wr),Kr=(t,o,s)=>({noDataWrapper:(0,u.css)({display:"flex",justifyContent:"center",width:"100%",paddingBottom:t.spacing(2)}),noData:(0,u.css)({display:"inline-block"}),scanButton:(0,u.css)({marginLeft:t.spacing(1)}),logOptions:(0,u.css)({display:"flex",justifyContent:"space-between",alignItems:"baseline",flexWrap:"wrap",backgroundColor:t.colors.background.primary,padding:`${t.spacing(1)} ${t.spacing(2)}`,borderRadius:t.shape.radius.default,margin:`${t.spacing(0,0,1)}`,border:`1px solid ${t.colors.border.medium}`}),headerButton:(0,u.css)({margin:`${t.spacing(.5,0,0,1)}`}),horizontalInlineLabel:(0,u.css)({"& > label":{marginRight:"0"}}),horizontalInlineSwitch:(0,u.css)({padding:`0 ${t.spacing(1)} 0 0`}),radioButtons:(0,u.css)({margin:"0"}),logsSection:(0,u.css)({display:"flex",flexDirection:"row",justifyContent:"space-between",position:"relative"}),logsTable:(0,u.css)({maxHeight:`${s}px`}),scrollableLogRows:(0,u.css)({overflowY:"scroll",width:"100%",maxHeight:"80vh"}),logRows:(0,u.css)({overflowX:`${o?"unset":"scroll"}`,overflowY:"visible",width:"100%"}),logRowsWrapper:(0,u.css)({width:"100%"}),visualisationType:(0,u.css)({display:"flex",flex:"1",justifyContent:"space-between"}),visualisationTypeRadio:(0,u.css)({margin:`0 0 0 ${t.spacing(1)}`}),stickyNavigation:(0,u.css)({overflow:"visible",...P.$.featureToggles.logsInfiniteScrolling&&{marginBottom:"0px"}})}),Ur=(t,o)=>{const s=(0,po.M0)(t,o),n=s.reduce((r,i)=>i.duplicates?r+i.duplicates:r,0);return{dedupedRows:s,dedupCount:n}},qr=t=>{if(!t||t.length===0)return;const o=t[0].timeEpochMs,s=t[t.length-1].timeEpochMs;return s<o?{from:s,to:o}:{from:o,to:s}},xo=500,yo=100,Gr=t=>({logsEnter:(0,u.css)({label:"logsEnter",position:"absolute",opacity:0,height:"auto",width:"100%"}),logsEnterActive:(0,u.css)({label:"logsEnterActive",opacity:1,[t.transitions.handleMotion("no-preference","reduce")]:{transition:`opacity ${xo}ms ease-out ${yo}ms`}}),logsExit:(0,u.css)({label:"logsExit",position:"absolute",opacity:1,height:"auto",width:"100%"}),logsExitActive:(0,u.css)({label:"logsExitActive",opacity:0,[t.transitions.handleMotion("no-preference","reduce")]:{transition:`opacity ${xo}ms ease-out ${yo}ms`}})});function ys(t){const{visible:o,children:s}=t,n=(0,d.useRef)(null),r=(0,k.of)(Gr);return(0,e.jsx)(_o.A,{in:o,mountOnEnter:!0,unmountOnExit:!0,timeout:xo+yo,classNames:{enter:r.logsEnter,enterActive:r.logsEnterActive,exit:r.logsExit,exitActive:r.logsExitActive},nodeRef:n,children:(0,e.jsx)("div",{ref:n,children:s})})}class Zr extends d.PureComponent{constructor(){super(...arguments),this.state={dsInstances:{}},this.onChangeTime=o=>{const{exploreId:s,updateTimeRange:n}=this.props;n({exploreId:s,absoluteRange:o})},this.loadMoreLogs=o=>{const{exploreId:s,loadMoreLogs:n}=this.props;n({exploreId:s,absoluteRange:o})},this.getLogRowContext=async(o,s,n)=>{const{logsQueries:r}=this.props;if(!s.dataFrame.refId||!this.state.dsInstances[s.dataFrame.refId])return Promise.resolve({data:[]});const i=this.state.dsInstances[s.dataFrame.refId];if(!(0,ee.Ol)(i))return Promise.resolve({data:[]});const c=this.getQuery(r,s,i);return c?i.getLogRowContext(o,n,c):Promise.resolve({data:[]})},this.getLogRowContextQuery=async(o,s,n=!0)=>{const{logsQueries:r}=this.props;if(!o.dataFrame.refId||!this.state.dsInstances[o.dataFrame.refId])return Promise.resolve(null);const i=this.state.dsInstances[o.dataFrame.refId];if(!(0,ee.Ol)(i))return Promise.resolve(null);const c=this.getQuery(r,o,i);return c&&i.getLogRowContextQuery?i.getLogRowContextQuery(o,s,c,n):Promise.resolve(null)},this.getLogRowContextUi=(o,s)=>{const{logsQueries:n}=this.props;if(!o.dataFrame.refId||!this.state.dsInstances[o.dataFrame.refId])return(0,e.jsx)(e.Fragment,{});const r=this.state.dsInstances[o.dataFrame.refId];if(!(0,ee.Ol)(r))return(0,e.jsx)(e.Fragment,{});const i=this.getQuery(n,o,r);return i&&(0,ee.wj)(r)&&r.getLogRowContextUi?r.getLogRowContextUi(o,s,i):(0,e.jsx)(e.Fragment,{})},this.showContextToggle=o=>!o?.dataFrame.refId||!this.state.dsInstances[o.dataFrame.refId]?!1:(0,ee.Ol)(this.state.dsInstances[o.dataFrame.refId]),this.getFieldLinks=(o,s,n,r)=>{const{splitOpenFn:i,range:c}=this.props;return(0,ot.QL)({field:o,rowIndex:s,splitOpenFn:i,range:c,dataFrame:n,vars:r})},this.logDetailsFilterAvailable=()=>Object.values(this.state.dsInstances).some(o=>o?.modifyQuery||(0,ee._0)(o)||(0,ee.FP)(o)),this.filterValueAvailable=()=>Object.values(this.state.dsInstances).some(o=>(0,ee._0)(o)&&o?.getSupportedQueryModifications().includes("ADD_STRING_FILTER")),this.filterOutValueAvailable=()=>Object.values(this.state.dsInstances).some(o=>(0,ee._0)(o)&&o?.getSupportedQueryModifications().includes("ADD_STRING_FILTER_OUT")),this.addResultsToCache=()=>{this.props.addResultsToCache(this.props.exploreId)},this.clearCache=()=>{this.props.clearCache(this.props.exploreId)},this.loadLogsVolumeData=()=>{this.props.loadSupplementaryQueryData(this.props.exploreId,ee.cF.LogsVolume)},this.onSetLogsVolumeEnabled=o=>{this.props.setSupplementaryQueryEnabled(this.props.exploreId,o,ee.cF.LogsVolume)}}componentDidMount(){this.updateDataSourceInstances()}componentDidUpdate(o){o.logsQueries!==this.props.logsQueries&&this.updateDataSourceInstances()}updateDataSourceInstances(){const{logsQueries:o,datasourceInstance:s}=this.props;if(!o||!s)return;const n={};if(s.uid!==Ye.uv){o.forEach(({refId:i})=>{n[i]=s}),this.setState({dsInstances:n});return}const r=[];for(const i of o){if(!i.datasource)continue;(!n[i.refId]||n[i.refId].uid!==i.datasource.uid)&&r.push(new Promise(h=>{(0,We.l)().get(i.datasource).then(m=>{h({ds:m,refId:i.refId})})}))}r.length&&Promise.all(r).then(i=>{i.forEach(({ds:c,refId:h})=>{n[h]=c}),this.setState({dsInstances:n})})}getQuery(o,s,n){return(o??[]).find(r=>r.refId===s.dataFrame.refId&&r.datasource!=null&&r.datasource.type===n.type)}render(){const{loading:o,loadingState:s,logRows:n,logsMeta:r,logsSeries:i,logsQueries:c,onClickFilterLabel:h,onClickFilterOutLabel:m,onStartScanning:x,onStopScanning:p,absoluteRange:g,timeZone:f,visibleRange:y,scanning:T,range:v,width:j,splitOpenFn:R,isLive:F,exploreId:I,logsVolume:C,scrollElement:L,onPinLineCallback:S}=this.props;return n?(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(ys,{visible:F,children:(0,e.jsx)(Dt.S,{label:(0,a.t)("explore.logs-container.label-logs","Logs"),loading:!1,isOpen:!0,children:(0,e.jsx)(ss,{exploreId:I,children:D=>(0,e.jsx)(rr,{logRows:n,timeZone:f,stopLive:D.stop,isPaused:this.props.isPaused,onPause:D.pause,onResume:D.resume,onClear:D.clear,clearedAtIndex:this.props.clearedAtIndex})})})}),(0,e.jsx)(ys,{visible:!F,children:(0,e.jsx)(zr,{exploreId:I,datasourceType:this.props.datasourceInstance?.type,logRows:n,logsMeta:r,logsSeries:i,logsVolumeEnabled:C.enabled,onSetLogsVolumeEnabled:this.onSetLogsVolumeEnabled,logsVolumeData:C.data,logsQueries:c,width:j,splitOpen:R,loading:o,loadingState:s,loadLogsVolumeData:this.loadLogsVolumeData,onChangeTime:this.onChangeTime,loadMoreLogs:this.loadMoreLogs,onClickFilterLabel:this.logDetailsFilterAvailable()?h:void 0,onClickFilterOutLabel:this.logDetailsFilterAvailable()?m:void 0,onStartScanning:x,onStopScanning:p,absoluteRange:g,visibleRange:y,timeZone:f,scanning:T,scanRange:v.raw,showContextToggle:this.showContextToggle,getRowContext:this.getLogRowContext,getRowContextQuery:this.getLogRowContextQuery,getLogRowContextUi:this.getLogRowContextUi,getFieldLinks:this.getFieldLinks,addResultsToCache:this.addResultsToCache,clearCache:this.clearCache,eventBus:this.props.eventBus,panelState:this.props.panelState,logsFrames:this.props.logsFrames,scrollElement:L,isFilterLabelActive:this.logDetailsFilterAvailable()?this.props.isFilterLabelActive:void 0,range:v,onPinLineCallback:S,onClickFilterString:this.filterValueAvailable()?this.props.onClickFilterString:void 0,onClickFilterOutString:this.filterOutValueAvailable()?this.props.onClickFilterOutString:void 0})})]}):null}}function Yr(t,{exploreId:o}){const n=t.explore.panes[o],{logsResult:r,scanning:i,datasourceInstance:c,isLive:h,isPaused:m,clearedAtIndex:x,range:p,absoluteRange:g,supplementaryQueries:f}=n,y=(0,z.h1)(o)(t),T=n.panelsState,v=(0,wt.O)(t.user),j=f[ee.cF.LogsVolume];return{loading:y,logRows:r?.rows,logsMeta:r?.meta,logsSeries:r?.series,logsQueries:r?.queries,visibleRange:r?.visibleRange,scanning:i,timeZone:v,datasourceInstance:c,isLive:h,isPaused:m,clearedAtIndex:x,range:p,absoluteRange:g,logsVolume:j,panelState:T,logsFrames:n.queryResponse.logsFrames}}const Jr={updateTimeRange:fe.GH,loadMoreLogs:fe.zY,addResultsToCache:z.He,clearCache:z.IL,loadSupplementaryQueryData:z.Az,setSupplementaryQueryEnabled:z.TO},Xr=(0,be.connect)(Yr,Jr)(Zr);function _r(t){const{queryResponse:o,timeZone:s,enabled:n,setLogsSampleEnabled:r,datasourceInstance:i,queries:c,splitOpen:h}=t,m=(0,k.of)(ea),x=(0,d.useRef)(null),p=y=>{r(y),(0,N.rR)("grafana_explore_logs_sample_toggle_clicked",{datasourceType:i?.type??"unknown",type:y?"open":"close"})},g=()=>{if(!i||!(0,ee.Nc)(i,ee.cF.LogsSample))return null;const y=c.map(v=>i.getSupplementaryQuery({type:ee.cF.LogsSample},v)).filter(v=>!!v);if(!y.length)return null;const T=()=>{h({queries:y,datasourceUid:i.uid}),(0,N.rR)("grafana_explore_logs_sample_split_button_clicked",{datasourceType:i?.type??"unknown",queriesCount:y.length})};return(0,e.jsx)(b.$n,{size:"sm",className:m.logSamplesButton,onClick:T,children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs-sample-panel.open-in-split-view-button.open-logs-in-split-view",children:"Open logs in split view"})})};let f;if(o===void 0)f=null;else if(o.error!==void 0)f=(0,e.jsx)(Vt,{error:o.error,title:(0,a.t)("explore.logs-sample-panel.title-failed-sample-query","Failed to load logs sample for this query")});else if(o.state===pe.Gu.Loading)f=(0,e.jsx)("span",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs-sample-panel.logs-sample-is-loading",children:"Logs sample is loading..."})});else if(o.data.length===0||o.data.every(y=>y.length===0))f=(0,e.jsx)("span",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.logs-sample-panel.no-logs-sample-data",children:"No logs sample data."})});else{const y=(0,po.HT)(o.data);f=P.$.featureToggles.newLogsPanel&&x.current?(0,e.jsx)(ds.Z,{app:je.Jk.Explore,containerElement:x.current,enableLogDetails:!0,dedupStrategy:te.fY.none,displayedFields:[],logOptionsStorageKey:X.OY,logs:y.rows,showControls:!0,showTime:ne.A.getBool(X.$Z.showTime,!0),sortOrder:ne.A.get(X.$Z.logsSortOrder)||te.uH.Descending,timeRange:t.timeRange,timeZone:s,wrapLogMessage:ne.A.getBool(X.$Z.wrapLogMessage,!0)}):(0,e.jsx)(cs.k,{logRows:y.rows,dedupStrategy:te.fY.none,showLabels:ne.A.getBool(X.$Z.showLabels,!1),showTime:ne.A.getBool(X.$Z.showTime,!0),wrapLogMessage:ne.A.getBool(X.$Z.wrapLogMessage,!0),prettifyLogMessage:ne.A.getBool(X.$Z.prettifyLogMessage,!1),timeZone:s,enableLogDetails:!0,scrollElement:null})}return o?.state!==pe.Gu.NotStarted?(0,e.jsxs)(Dt.S,{label:(0,e.jsxs)("div",{children:[(0,e.jsx)(a.x6,{i18nKey:"explore.logs-sample-panel.label",children:"Logs sample"}),(0,e.jsx)(ye.m,{content:(0,a.t)("explore.logs-sample-panel.tooltip","Show log lines that contributed to visualized metrics"),children:(0,e.jsx)(ue.I,{name:"info-circle",className:m.infoTooltip})})]}),isOpen:n,collapsible:!0,onToggle:p,children:[(0,e.jsx)(g,{}),(0,e.jsx)("div",{className:m.logContainer,ref:x,children:f})]}):null}const ea=t=>({logSamplesButton:(0,u.css)({position:"absolute",top:t.spacing(1),right:t.spacing(1)}),logContainer:(0,u.css)({overflow:P.$.featureToggles.newLogsPanel?"visible":"scroll"}),infoTooltip:(0,u.css)({marginLeft:t.spacing(1)})}),ta=()=>{const t=(0,k.of)(oa);return(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(so._,{"data-testid":"explore-no-data",className:t.wrapper,children:(0,e.jsx)("span",{className:t.message,children:"No data"})})})},oa=t=>({wrapper:(0,u.css)({label:"no-data-card",padding:t.spacing(3),background:t.colors.background.primary,borderRadius:t.shape.radius.default,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",flexGrow:1}),message:(0,u.css)({fontSize:t.typography.h2.fontSize,padding:t.spacing(4),color:t.colors.text.disabled})});var sa=l(43951);function na(t){return(0,u.css)({maxWidth:`${t.breakpoints.values.lg}px`,marginTop:t.spacing(2),alignSelf:"center"})}const ra=()=>{const t=(0,k.of)(na),o=uo.TP.hasPermission(Je.w.DataSourcesCreate)&&uo.TP.hasPermission(Je.w.DataSourcesWrite),s="Explore requires at least one data source. Once you have added a data source, you can query it here.",n=(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(ue.I,{name:"rocket"}),(0,e.jsx)(e.Fragment,{children:(0,e.jsxs)(a.x6,{i18nKey:"explore.no-data-source-call-to-action.footer.pro-tip-define-sources-through-configuration-files",children:[" ","ProTip: You can also define data sources through configuration files."," "]})}),(0,e.jsx)("a",{href:"http://docs.grafana.org/administration/provisioning/?utm_source=explore#data-sources",target:"_blank",rel:"noreferrer",className:"text-link",children:(0,e.jsx)(a.x6,{i18nKey:"explore.no-data-source-call-to-action.footer.learn-more",children:"Learn more"})})]}),r=(0,e.jsx)(b.z9,{size:"lg",href:"datasources/new",icon:"database",disabled:!o,children:(0,e.jsx)(a.x6,{i18nKey:"explore.no-data-source-call-to-action.cta-element.add-data-source",children:"Add data source"})});return(0,e.jsx)(sa.c,{callToActionElement:r,className:t,footer:n,message:s})};var vo=l(52908),bo=l(60519),vs=l(29147),bs=l(18209),aa=l(81753);const ia=t=>({warningText:(0,u.css)({label:"warningText",display:"flex",alignItems:"center",fontSize:t.typography.bodySmall.fontSize,color:t.colors.text.secondary})});function la(t){const{dataFrames:o,range:s,splitOpenFn:n,withTraceView:r,datasourceType:i}=t,c=(0,ot.JQ)(s,n),h=(0,k.$j)(),m=(0,k.of)(ia),x=(0,bo.we)({fieldConfig:{defaults:{},overrides:[]},data:o,replaceVariables:S=>S,theme:h}),{nodes:p}=(0,aa.d)(x),[g,f]=(0,Qo.A)(!0),T=(p[0]?.length||0)>vs.E?bs.S.Force:bs.S.Layered,v=()=>{f(),(0,N.rR)("grafana_traces_node_graph_panel_clicked",{datasourceType:i,grafana_version:P.$.buildInfo.version,isExpanded:!g})},{height:j}=(0,vo.A)(),R=(0,d.useRef)(null),[F,I]=(0,d.useState)(250);(0,d.useEffect)(()=>{if(R.current){const{top:S}=R.current.getBoundingClientRect();I(S)}},[R]);const C=j-F-32,L=r&&p[0]?.length>1e3?(0,e.jsxs)("span",{className:m.warningText,children:[" ",(0,e.jsxs)(a.x6,{i18nKey:"explore.unconnected-node-graph-container.count-warning",values:{numNodes:p[0].length},children:["(","{{numNodes}}"," nodes, can be slow to load)"]})]}):null;return(0,e.jsx)(Fe.NR,{title:(0,a.t)("explore.unconnected-node-graph-container.title-node-graph","Node graph"),titleItems:L,collapsible:!!r,collapsed:r?g:!1,onToggleCollapse:r?v:void 0,children:(0,e.jsx)("div",{ref:R,style:r?{height:500}:{minHeight:600,height:C},children:(0,e.jsx)(vs.F,{dataFrames:x,getLinks:c,layoutAlgorithm:T})})})}function ca(t,{exploreId:o}){return{range:t.explore.panes[o].range}}const da=(0,be.connect)(ca,{})(la);var st=l(25508),ua=l(28998),pa=l(65966),Co=l(98838);const ga=t=>{const o=(0,U.qq)(t);return{getQueries:(0,st.Mz)(o,s=>s.queries),getQueryResponse:(0,st.Mz)(o,s=>s.queryResponse),getHistory:(0,st.Mz)(o,s=>s.history),getEventBridge:(0,st.Mz)(o,s=>s.eventBridge),getDatasourceInstanceSettings:(0,st.Mz)(o,s=>(0,ua.tR)().getInstanceSettings(s.datasourceInstance?.uid)),getQueryLibraryRef:(0,st.Mz)(o,s=>s.queryLibraryRef)}},ha=({exploreId:t,isOpen:o,changeCompactMode:s})=>{const n=(0,A.wA)(),{openDrawer:r}=(0,Co.Y)(),{getQueries:i,getDatasourceInstanceSettings:c,getQueryResponse:h,getHistory:m,getEventBridge:x,getQueryLibraryRef:p}=(0,d.useMemo)(()=>ga(t),[t]),g=(0,A.d4)(i),f=(0,A.d4)(c),y=(0,A.d4)(h),T=(0,A.d4)(m),v=(0,A.d4)(x),j=(0,A.d4)(p),R=(0,d.useCallback)(()=>{n((0,z.Od)({exploreId:t}))},[n,t]),F=(0,d.useCallback)((E,J)=>{n((0,z.bO)({exploreId:t,queries:E,options:J}))},[n,t]),I=(0,d.useCallback)(E=>{n((0,Ee.wh)({exploreId:t,datasource:E}))},[n,t]),C=(0,d.useCallback)(E=>{F([...g,{...E,refId:(0,$o.M)(g)}])},[F,g]),L=()=>{(0,N.rR)("grafana_explore_query_row_copy")},S=()=>{(0,N.rR)("grafana_explore_query_replaced_from_library")},D=()=>{(0,N.rR)("grafana_explore_query_row_remove")},M=E=>{(0,N.rR)("grafana_query_row_toggle",E===void 0?{}:{queryEnabled:E})},H=()=>{const E=j;n((0,ve._9)({exploreId:t,queryLibraryRef:void 0})),E&&r({datasourceFilters:[],options:{context:"explore",highlightQuery:E}})},Q=()=>{s(!1)};return(0,e.jsx)(pa.L,{dsSettings:f,queries:g,onQueriesChange:F,onUpdateDatasources:I,onAddQuery:C,onRunQueries:R,onQueryCopied:L,onQueryRemoved:D,onQueryToggled:M,onQueryReplacedFromLibrary:S,onQueryOpenChanged:Q,data:y,app:je.Jk.Explore,history:T,eventBus:v,queryLibraryRef:j,onCancelQueryLibraryEdit:H,isOpen:o,queryRowWrapper:(E,J)=>(0,e.jsx)(Ce,{title:J,icon:"arrow",panelId:"Queries",customTopOffset:-10,level:"child",children:E},J)})};var zt=l(2863),Cs=l(24343),So=l(65642),ma=l(95943),fa=l(91793),xa=l(44720),ya=l(3642),Ss=l(53593);const xt={wrapper:(0,u.css)({height:"100%",overflow:"scroll"}),switchWrapper:(0,u.css)({display:"flex",flexDirection:"row",marginBottom:0}),switchLabel:(0,u.css)({marginLeft:"15px",marginBottom:0}),switch:(0,u.css)({marginLeft:"10px"}),resultCount:(0,u.css)({marginBottom:"4px"}),header:(0,u.css)({display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 0",fontSize:"12px",lineHeight:1.25})},va=480,ba=2,Ca=t=>{const{tableResult:o}=t,s=(0,_.cloneDeep)(o),n=(0,d.useRef)(null),r=s.fields.filter(y=>y.name.includes("Value")),i=(0,Ss.E)(s),{width:c}=(0,vo.A)(),[h,m]=(0,d.useState)(c<=va||r.length>ba),x=()=>{m(!h);const y={isExpanded:!h};(0,N.rR)("grafana_explore_prometheus_instant_query_ui_raw_toggle_expand",y)};(0,d.useEffect)(()=>{n.current?.resetAfterIndex(0,!0)},[h]);const p=y=>{if(y<10){let j=0;for(let R=0;R<y;R++)j+=g(R,!0);return Math.min(600,j)}return 600},g=(y,T)=>{if(!T)return 32;const R=i[y];return 1.5*32+(Object.keys(R).length-r.length)*22},f=`isExpandedView ${(0,d.useId)()}`;return(0,e.jsxs)("section",{children:[(0,e.jsxs)("header",{className:xt.header,children:[(0,e.jsx)(Ne.D,{className:xt.switchWrapper,label:(0,a.t)("explore.raw-list-container.label-expand-results","Expand results"),htmlFor:"isExpandedView",noMargin:!0,children:(0,e.jsx)("div",{className:xt.switch,children:(0,e.jsx)(Ke.d,{onChange:x,id:f,value:h,label:(0,a.t)("explore.raw-list-container.label-expand-results","Expand results")})})}),(0,e.jsx)("div",{className:xt.resultCount,children:(0,e.jsxs)(a.x6,{i18nKey:"explore.raw-list-container.item-count",values:{numItems:i.length},children:["Result series: ","{{numItems}}"]})})]}),(0,e.jsx)("div",{role:"table",children:(0,e.jsxs)(e.Fragment,{children:[r.length>1&&!h&&(0,e.jsx)(xa.d,{valueLabels:r,expanded:h}),(0,e.jsx)(fa._m,{ref:n,itemCount:i.length,className:xt.wrapper,itemSize:y=>g(y,h),height:p(i.length),width:"100%",children:({index:y,style:T})=>{let v;return h&&(v=r.filter(j=>{const R=i[y][j.name];return R&&R!==Ss.M})),(0,e.jsx)("div",{role:"row",style:{...T,overflow:"hidden"},children:(0,e.jsx)(ya.Ay,{isExpandedView:h,valueLabels:v,totalNumberOfValues:r.length,listKey:i[y].__name__||`item-${y}`,listItemData:i[y]})})}})]})})]})};function Sa(t,{exploreId:o}){const n=t.explore.panes[o],{rawPrometheusResult:r,range:i,queryResponse:c}=n,h=r?[r]:[];return{loading:c.state,tableResult:h,range:i}}const ja=(0,be.connect)(Sa,{});class Ra extends d.PureComponent{constructor(o){super(o),this.onChangeResultsStyle=s=>{this.setState({resultsStyle:s})},this.renderLabel=()=>{const s=(0,u.css)({display:"flex",justifyContent:"space-between",flex:"1"}),n=O.jH.map(r=>({value:r,label:r[0].toUpperCase()+r.slice(1).replace(/_/," ")}));return(0,e.jsx)("div",{className:s,children:(0,e.jsx)(Bt.z,{onClick:()=>{const r={state:this.state.resultsStyle===O.aA.table?O.aA.raw:O.aA.table};(0,N.rR)("grafana_explore_prometheus_instant_query_ui_toggle_clicked",r)},size:"sm",options:n,value:this.state?.resultsStyle,onChange:this.onChangeResultsStyle})})},o.showRawPrometheus&&(this.state={resultsStyle:O.aA.raw})}getTableHeight(){const{tableResult:o}=this.props;return!o||o.length===0?200:Math.max(Math.min(600,o[0].length*35)+35)}render(){const{loading:o,onCellFilterAdded:s,tableResult:n,width:r,splitOpenFn:i,range:c,ariaLabel:h,timeZone:m}=this.props,x=this.getTableHeight(),p=r-So.$W.theme.panelPadding*2-ma.IZ;let g=n;const f=(0,ot.YV)(i,c);g?.length&&(g=(0,bo.we)({data:g,timeZone:m,theme:So.$W.theme2,replaceVariables:(0,zt.w)().replace.bind((0,zt.w)()),fieldConfig:{defaults:{},overrides:[]},dataLinkPostProcessor:f}));const y=g?.filter(R=>!!R&&R.length!==0),T=this.state.resultsStyle===O.aA.raw?"Raw":"Table",v=this.state?.resultsStyle!==void 0?this.renderLabel():"Table",j=!this.state?.resultsStyle||this.state?.resultsStyle===O.aA.table;return(0,e.jsxs)(Fe.NR,{title:T,actions:v,loadingState:o,children:[y?.length&&(0,e.jsxs)(e.Fragment,{children:[j&&(0,e.jsx)(Cs.X,{ariaLabel:h,data:y[0],width:p,height:x,onCellFilterAdded:s}),this.state?.resultsStyle===O.aA.raw&&(0,e.jsx)(Ca,{tableResult:y[0]})]}),!y?.length&&(0,e.jsx)(go,{metaItems:[{value:"0 series returned"}]})]})}}const Ta=ja(Ra);var wa=l(22669);const La=t=>{const o=(0,d.useRef)(null),s={transition:`opacity ${t.duration}ms linear`,opacity:0},n={exited:{opacity:0,display:"none"},entering:{opacity:0},entered:{opacity:1},exiting:{opacity:0}};return(0,e.jsx)(wa.Ay,{in:t.in,timeout:t.duration,unmountOnExit:t.unmountOnExit||!1,onExited:t.onExited,nodeRef:o,children:r=>(0,e.jsx)("div",{ref:o,style:{...s,...n[r]},children:t.children})})},Ia=t=>{const{queryError:o}=t,s=!!o,n=s?100:10,r=o?"Query error":"Unknown error",i=o?.message||o?.data?.message||null;return(0,e.jsx)(La,{in:s,duration:n,children:(0,e.jsx)(ht.F,{severity:"error",title:r,topSpacing:2,children:i})})};function Ea(t){const o=(0,A.d4)(n=>n.explore.panes[t.exploreId].queryResponse),s=o?.state===pe.Gu.Error?o?.error:void 0;return s?.refId?null:(0,e.jsx)(Ia,{queryError:s})}var ae=l(81970);const Fa=t=>({containerMargin:(0,u.css)({display:"flex",flexWrap:"wrap",gap:t.spacing(1),marginTop:t.spacing(2)})});function Da({addQueryRowButtonDisabled:t,addQueryRowButtonHidden:o,onClickAddQueryRowButton:s,onClickQueryInspectorButton:n,onSelectQueryFromLibrary:r,queryInspectorButtonActive:i}){const c=(0,k.$j)(),h=Fa(c),m=(0,A.d4)(U.Kl),x=(0,ae.TR)(),p=m.dsToExplore.map(y=>x.find(T=>T.uid===y.datasource?.uid)?.name).filter(y=>!!y&&y!==Ye.uv),{queryLibraryEnabled:g,openDrawer:f}=(0,Co.Y)();return(0,e.jsxs)("div",{className:h.containerMargin,children:[!o&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(ie.I,{variant:"canvas","aria-label":(0,a.t)("explore.secondary-actions.query-add-button-aria-label","Add query"),onClick:s,disabled:t,icon:"plus",children:(0,e.jsx)(a.x6,{i18nKey:"explore.secondary-actions.query-add-button",children:"Add query"})}),g&&(0,e.jsx)(ie.I,{"data-testid":Qe.Tp.pages.Explore.General.addFromQueryLibrary,"aria-label":(0,a.t)("explore.secondary-actions.add-from-query-library","Add from saved queries"),variant:"canvas",onClick:()=>f({datasourceFilters:p,onSelectQuery:r,options:{context:je.Jk.Explore}}),icon:"plus",disabled:t,children:(0,e.jsx)(a.x6,{i18nKey:"explore.secondary-actions.add-from-query-library",children:"Add from saved queries"})})]}),(0,e.jsx)(ie.I,{variant:i?"active":"canvas","aria-label":(0,a.t)("explore.secondary-actions.query-inspector-button-aria-label","Query inspector"),onClick:n,icon:"info-circle",children:(0,e.jsx)(a.x6,{i18nKey:"explore.secondary-actions.query-inspector-button",children:"Query inspector"})})]})}var Oa=l(95004),js=l(32776),Aa=l(15757);const Rs=20;function Pa(t,{exploreId:o}){const n=t.explore.panes[o],{tableResult:r,range:i}=n,c=(0,z.h1)(o);return{loading:r&&r.length>0?!1:c,tableResult:r,range:i}}const Na=(0,be.connect)(Pa,{});class Ts extends d.PureComponent{constructor(){super(...arguments),this.state={showAll:!1},this.hasSubFrames=o=>o.fields.some(s=>s.type===Oa.PU.nestedFrames)}getTableHeight(o,s){return o===0?200:Math.min(600,Math.max(o*36,s?300:0)+40+46)}getTableTitle(o,s,n){let r=s.name;return!r&&(o?.length??0)>1&&(r=s.refId||`${n}`),r?(0,a.t)("explore.table.title-with-name","Table - {{name}}",{name:r,interpolation:{escapeValue:!1}}):(0,a.t)("explore.table.title","Table")}showAll(){this.setState({showAll:!0})}render(){const{loading:o,onCellFilterAdded:s,tableResult:n,width:r,splitOpenFn:i,range:c,ariaLabel:h,timeZone:m,theme:x}=this.props,{showAll:p}=this.state;let g=(0,js.gy)(n)?(0,js.S5)(n):n;const f=(0,ot.YV)(i,c);let y=!1;g?.length&&(g=g.map(v=>(v.fields.forEach((j,R)=>{const F=p?!1:R>=Rs;j.config.custom={hidden:F},y=y||F}),v)),g=(0,bo.we)({data:g,timeZone:m,theme:So.$W.theme2,replaceVariables:(0,zt.w)().replace.bind((0,zt.w)()),fieldConfig:{defaults:{},overrides:[]},dataLinkPostProcessor:f}));const T=g?.filter(v=>!!v&&v.length!==0);return(0,e.jsxs)(e.Fragment,{children:[T&&T.length===0&&(0,e.jsx)(Fe.NR,{title:(0,a.t)("explore.table.title","Table"),width:r,height:200,children:()=>(0,e.jsx)(go,{metaItems:[{value:(0,a.t)("explore.table.no-data","0 series returned")}]})}),T&&T.length>0&&(0,e.jsx)("div",{className:(0,u.css)({display:"flex",flexDirection:"column",gap:x.spacing(1)}),children:T.map((v,j)=>(0,e.jsx)(Fe.NR,{title:this.getTableTitle(g,v,j),titleItems:[!p&&y&&(0,e.jsx)(Aa.m,{toggleShowAllSeries:()=>this.showAll(),info:(0,e.jsxs)(a.x6,{i18nKey:"table.container.show-only-series",children:["Showing only ",{MAX_NUMBER_OF_COLUMNS:Rs}," columns"]}),tooltip:(0,a.t)("table.container.content","Showing too many columns in a single table may impact performance and make data harder to read. Consider refining your queries."),buttonLabel:(0,e.jsx)(a.x6,{i18nKey:"table.container.show-all-series",children:"Show all columns"})})],width:r,height:this.getTableHeight(v.length,this.hasSubFrames(v)),loadingState:o?pe.Gu.Loading:void 0,children:(R,F)=>(0,e.jsx)(Cs.X,{ariaLabel:h,data:v,width:R,height:F,onCellFilterAdded:s})},v.refId||`table-${j}`))})]})}}const hl=(0,k.cV)(Ts),ka=(0,k.cV)(Na(Ts));var Ma=l(40476),Ha=l(88535);function Ba(t){const o=t.dataFrames[0],{dataFrames:s,splitOpenFn:n,exploreId:r,scrollElement:i,timeRange:c}=t,h=(0,d.useMemo)(()=>(0,Ha.L)(o),[o]),m=(0,A.d4)(x=>x.explore.panes[t.exploreId]?.datasourceInstance??void 0);return h?(0,e.jsx)(Fe.NR,{padding:"none",title:(0,a.t)("explore.trace-view-container.title-trace","Trace"),children:(0,e.jsx)(Ma.V,{exploreId:r,dataFrames:s,splitOpenFn:n,scrollElement:i,traceProp:h,datasource:m,timeRange:c})}):null}const $a=t=>({exploreMain:(0,u.css)({label:"exploreMain",position:"relative",marginTop:"21px",display:"flex",flexDirection:"column",gap:t.spacing(1)}),queryContainer:(0,u.css)({label:"queryContainer",padding:t.spacing(1)}),exploreContainer:(0,u.css)({label:"exploreContainer",display:"flex",flexDirection:"column",paddingRight:t.spacing(2),marginBottom:t.spacing(2)}),wrapper:(0,u.css)({position:"absolute",top:0,left:t.spacing(2),right:0,bottom:0,display:"flex"})});class Va extends d.PureComponent{constructor(o){super(o),this.onChangeTime=s=>{const{updateTimeRange:n,exploreId:r}=this.props;n({exploreId:r,rawRange:s})},this.onClickExample=s=>{this.props.setQueries(this.props.exploreId,[s])},this.onCellFilterAdded=s=>{const{value:n,key:r,operator:i}=s;i===Vo.mc&&this.onClickFilterLabel(r,n),i===Vo.Zi&&this.onClickFilterOutLabel(r,n)},this.onContentOutlineToogle=()=>{Xe.M.set(Lt.visible,!this.state.contentOutlineVisible),this.setState(s=>{const n=this.props.compact?!0:!s.contentOutlineVisible;return(0,N.rR)("explore_toolbar_contentoutline_clicked",{item:"outline",type:n?"open":"close"}),{contentOutlineVisible:n}}),this.props.changeCompactMode(this.props.exploreId,!1)},this.isFilterLabelActive=async(s,n,r)=>{const i=this.props.queries.find(h=>h.refId===r);if(!i)return!1;const c=await(0,We.l)().get(i.datasource);return!!((0,ee.FP)(c)&&c.queryHasFilter(i,{key:s,value:n.toString()}))},this.onClickFilterLabel=(s,n,r)=>{this.onModifyQueries({type:"ADD_FILTER",options:{key:s,value:n.toString()},frame:r},r?.refId)},this.onClickFilterOutLabel=(s,n,r)=>{this.onModifyQueries({type:"ADD_FILTER_OUT",options:{key:s,value:n.toString()},frame:r},r?.refId)},this.onClickFilterString=(s,n)=>{this.onModifyQueries({type:"ADD_STRING_FILTER",options:{value:s.toString()}},n)},this.onClickFilterOutString=(s,n)=>{this.onModifyQueries({type:"ADD_STRING_FILTER_OUT",options:{value:s.toString()}},n)},this.onClickAddQueryRowButton=()=>{const{exploreId:s,queryKeys:n}=this.props;this.props.addQueryRow(s,n.length)},this.onModifyQueries=(s,n)=>{const r=async(i,c)=>{if(n&&n!==i.refId)return i;const{datasource:h}=i;if(h==null)return i;const m=await(0,We.l)().get(h),x=["ADD_FILTER","ADD_FILTER_OUT"];return(0,ee.FP)(m)&&x.includes(c.type)?m.toggleQueryFilter(i,{type:c.type==="ADD_FILTER"?"FILTER_FOR":"FILTER_OUT",options:c.options??{},frame:c.frame}):m.modifyQuery?m.modifyQuery(i,c):i};this.props.modifyQueries(this.props.exploreId,s,r)},this.onResize=s=>{this.props.changeSize(this.props.exploreId,s)},this.onStartScanning=()=>{this.props.scanStart(this.props.exploreId)},this.onStopScanning=()=>{this.props.scanStopAction({exploreId:this.props.exploreId})},this.onUpdateTimeRange=s=>{const{exploreId:n,updateTimeRange:r}=this.props;r({exploreId:n,absoluteRange:s})},this.onSplitOpen=s=>async n=>{if(this.props.splitOpen(n&&{...n,compact:!0}),n&&this.props.datasourceInstance){const r=(await(0,We.l)().get(n.datasourceUid)).type,i=this.props.datasourceInstance.uid===Ye.uv?(0,_.get)(this.props.queries,"0.datasource.type"):this.props.datasourceInstance.type,c={origin:"panel",panelType:s,source:i,target:r,exploreId:this.props.exploreId};(0,N.rR)("grafana_explore_split_view_opened",c)}},this.onPinLineCallback=()=>{this.setState({contentOutlineVisible:!0})},this.splitOpenFnLogs=this.onSplitOpen("logs"),this.state={contentOutlineVisible:Xe.M.getBool(Lt.visible,!0)},this.graphEventBus=o.eventBus.newScopedBus("graph",{onlyLocal:!1}),this.logsEventBus=o.eventBus.newScopedBus("logs",{onlyLocal:!1})}renderEmptyState(o){return(0,e.jsx)("div",{className:(0,u.cx)(o),children:(0,e.jsx)(ra,{})})}renderNoData(){return(0,e.jsx)(ta,{})}renderCustom(o){const{timeZone:s,queryResponse:n,eventBus:r}=this.props,i=(0,_.groupBy)(n?.customFrames,"meta.preferredVisualisationPluginId");return Object.entries(i).map(([c,h],m)=>(0,e.jsx)(Ce,{panelId:c,title:c,icon:"plug",children:(0,e.jsx)(wn,{timeZone:s,pluginId:c,frames:h,state:n.state,timeRange:n.timeRange,height:400,width:o,splitOpenFn:this.onSplitOpen(c),eventBus:r},m)},m))}renderGraphPanel(o){const{graphResult:s,timeZone:n,queryResponse:r,showFlameGraph:i}=this.props;return(0,e.jsx)(Ce,{panelId:"Graph",title:(0,a.t)("explore.explore.title-graph","Graph"),icon:"graph-bar",children:(0,e.jsx)(Yn.y,{data:s,height:i?180:400,width:o,timeRange:r.timeRange,timeZone:n,onChangeTime:this.onUpdateTimeRange,annotations:r.annotations,splitOpenFn:this.onSplitOpen("graph"),loadingState:r.state,eventBus:this.graphEventBus})})}renderTablePanel(o){const{exploreId:s,timeZone:n}=this.props;return(0,e.jsx)(Ce,{panelId:"Table",title:(0,a.t)("explore.explore.title-table","Table"),icon:"table",children:(0,e.jsx)(ka,{ariaLabel:Qe.Tp.pages.Explore.General.table,width:o,exploreId:s,onCellFilterAdded:this.onCellFilterAdded,timeZone:n,splitOpenFn:this.onSplitOpen("table")})})}renderRawPrometheus(o){const{exploreId:s,datasourceInstance:n,timeZone:r}=this.props;return(0,e.jsx)(Ce,{panelId:"Raw Prometheus",title:(0,a.t)("explore.explore.title-raw-prometheus","Raw Prometheus"),icon:"gf-prometheus",children:(0,e.jsx)(Ta,{showRawPrometheus:!0,ariaLabel:Qe.Tp.pages.Explore.General.table,width:o,exploreId:s,onCellFilterAdded:n?.modifyQuery?this.onCellFilterAdded:void 0,timeZone:r,splitOpenFn:this.onSplitOpen("table")})})}renderLogsPanel(o){const{exploreId:s,syncedTimes:n,theme:r,queryResponse:i}=this.props,c=parseInt(r.spacing(2).slice(0,-2),10),h=(0,u.css)({display:"flex",flexDirection:"column",gap:r.spacing(1)});return(0,e.jsx)(Ce,{panelId:"Logs",title:(0,a.t)("explore.explore.title-logs","Logs"),icon:"gf-logs",className:h,children:(0,e.jsx)(Xr,{exploreId:s,loadingState:i.state,syncedTimes:n,width:o-c,onClickFilterLabel:this.onClickFilterLabel,onClickFilterOutLabel:this.onClickFilterOutLabel,onStartScanning:this.onStartScanning,onStopScanning:this.onStopScanning,eventBus:this.logsEventBus,splitOpenFn:this.splitOpenFnLogs,scrollElement:this.scrollElement,isFilterLabelActive:this.isFilterLabelActive,onClickFilterString:this.onClickFilterString,onClickFilterOutString:this.onClickFilterOutString,onPinLineCallback:this.onPinLineCallback})})}renderLogsSamplePanel(){const{logsSample:o,timeZone:s,setSupplementaryQueryEnabled:n,exploreId:r,datasourceInstance:i,queries:c,queryResponse:h}=this.props;return(0,e.jsx)(Ce,{panelId:"Logs Sample",title:(0,a.t)("explore.explore.title-logs-sample","Logs sample"),icon:"gf-logs",children:(0,e.jsx)(_r,{queryResponse:o.data,timeZone:s,enabled:o.enabled,queries:c,datasourceInstance:i,splitOpen:this.onSplitOpen("logsSample"),setLogsSampleEnabled:m=>n(r,m,ee.cF.LogsSample),timeRange:h.timeRange})})}renderNodeGraphPanel(){const{exploreId:o,showTrace:s,queryResponse:n,datasourceInstance:r}=this.props,i=r?r?.type:"unknown";return(0,e.jsx)(Ce,{panelId:"Node Graph",title:(0,a.t)("explore.explore.title-node-graph","Node graph"),icon:"code-branch",children:(0,e.jsx)(da,{dataFrames:n.nodeGraphFrames,exploreId:o,withTraceView:s,datasourceType:i,splitOpenFn:this.onSplitOpen("nodeGraph")})})}renderFlameGraphPanel(){const{queryResponse:o}=this.props;return(0,e.jsx)(Ce,{panelId:"Flame Graph",title:(0,a.t)("explore.explore.title-flame-graph","Flame graph"),icon:"fire",children:(0,e.jsx)(Gn,{dataFrames:o.flameGraphFrames})})}renderTraceViewPanel(){const{queryResponse:o,exploreId:s}=this.props,n=o.series.filter(r=>r.meta?.preferredVisualisationType==="trace");return n.length&&(0,e.jsx)(Ce,{panelId:"Traces",title:(0,a.t)("explore.explore.title-traces","Traces"),icon:"file-alt",children:(0,e.jsx)(Ba,{exploreId:s,dataFrames:n,splitOpenFn:this.onSplitOpen("traceView"),scrollElement:this.scrollElement,timeRange:o.timeRange})})}render(){const{datasourceInstance:o,exploreId:s,graphResult:n,queryResponse:r,isLive:i,theme:c,showMetrics:h,showTable:m,showRawPrometheus:x,showLogs:p,showTrace:g,showCustom:f,showNodeGraph:y,showFlameGraph:T,showLogsSample:v,correlationEditorDetails:j,correlationEditorHelperData:R,showQueryInspector:F,setShowQueryInspector:I,compact:C,queryLibraryRef:L}=this.props,{contentOutlineVisible:S}=this.state,D=$a(c),M=r&&r.state!==pe.Gu.NotStarted,H=!(0,gt.gQ)().queryHistoryAvailable,Q=r.state===pe.Gu.Done&&[r.logsFrames,r.graphFrames,r.nodeGraphFrames,r.flameGraphFrames,r.tableFrames,r.rawPrometheusFrames,r.traceFrames,r.customFrames].every(V=>V.length===0);let E;const J=j?.editorMode;return!!(J||j?.correlationDirty)&&R!==void 0&&(E=(0,e.jsx)(bn,{exploreId:s,correlations:R})),(0,e.jsxs)(cn,{refreshDependencies:this.props.queries,children:[(0,e.jsx)(Un,{exploreId:s,onChangeTime:this.onChangeTime,onContentOutlineToogle:this.onContentOutlineToogle,isContentOutlineOpen:S}),(0,e.jsx)("div",{style:{position:"relative",height:"100%",paddingLeft:c.spacing(2)},children:(0,e.jsxs)("div",{className:D.wrapper,children:[S&&!C&&(0,e.jsx)(pn,{scroller:this.scrollElement,panelId:`content-outline-container-${s}`}),(0,e.jsx)(oo.P,{"data-testid":Qe.Tp.pages.Explore.General.scrollView,ref:V=>this.scrollElement=V||void 0,children:(0,e.jsx)("div",{className:D.exploreContainer,children:o?(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(Ce,{panelId:"Queries",title:(0,a.t)("explore.explore.title-queries","Queries"),icon:"arrow",mergeSingleChild:!0,children:(0,e.jsxs)(so._,{className:D.queryContainer,children:[E,(0,e.jsx)(ha,{exploreId:s,isOpen:C?!1:void 0,changeCompactMode:V=>this.props.changeCompactMode(this.props.exploreId,!1)}),(0,e.jsx)(Da,{addQueryRowButtonDisabled:i||J&&o.meta.mixed||!!L,addQueryRowButtonHidden:!1,richHistoryRowButtonHidden:H,queryInspectorButtonActive:F,onClickAddQueryRowButton:this.onClickAddQueryRowButton,onClickQueryInspectorButton:()=>I(!F),onSelectQueryFromLibrary:async V=>{const{changeDatasource:se,queries:le,setQueries:Te}=this.props,nt=[...le,{...V,refId:(0,$o.M)(le)}];if(Te(s,nt),V.datasource?.uid){const W={uid:new Set(nt.map(Ae=>Ae.datasource?.uid)).size>1?Ye.uv:V.datasource.uid};o.uid!==W.uid&&await se({exploreId:s,datasource:W})}}}),(0,e.jsx)(Ea,{exploreId:s})]})}),(0,e.jsx)(nn.Ay,{onResize:this.onResize,disableHeight:!0,children:({width:V})=>V===0?null:(0,e.jsx)("main",{className:(0,u.cx)(D.exploreMain),style:{width:V},children:(0,e.jsx)(oe.Xw,{children:M&&(0,e.jsxs)(e.Fragment,{children:[h&&n&&(0,e.jsx)(oe.Xw,{children:this.renderGraphPanel(V)}),x&&(0,e.jsx)(oe.Xw,{children:this.renderRawPrometheus(V)}),m&&(0,e.jsx)(oe.Xw,{children:this.renderTablePanel(V)}),p&&(0,e.jsx)(oe.Xw,{children:this.renderLogsPanel(V)}),y&&(0,e.jsx)(oe.Xw,{children:this.renderNodeGraphPanel()}),T&&(0,e.jsx)(oe.Xw,{children:this.renderFlameGraphPanel()}),g&&(0,e.jsx)(oe.Xw,{children:this.renderTraceViewPanel()}),v&&(0,e.jsx)(oe.Xw,{children:this.renderLogsSamplePanel()}),f&&(0,e.jsx)(oe.Xw,{children:this.renderCustom(V)}),Q&&(0,e.jsx)(oe.Xw,{children:this.renderNoData()})]})})})})]}):this.renderEmptyState(D.exploreContainer)})})]})})]})}}function Qa(t,{exploreId:o}){const s=t.explore,{syncedTimes:n}=s,r=s.panes[o],i=(0,wt.O)(t.user),{datasourceInstance:c,queryKeys:h,queries:m,isLive:x,graphResult:p,tableResult:g,logsResult:f,showLogs:y,showMetrics:T,showTable:v,showTrace:j,showCustom:R,queryResponse:F,showNodeGraph:I,showFlameGraph:C,showRawPrometheus:L,supplementaryQueries:S,correlationEditorHelperData:D,compact:M,queryLibraryRef:H}=r,Q=(0,z.h1)(o)(t),E=S[ee.cF.LogsSample],J=!!(E.dataProvider!==void 0&&!f&&(p||g));return{datasourceInstance:c,queryKeys:h,queries:m,isLive:x,graphResult:p,logsResult:f??void 0,queryResponse:F,syncedTimes:n,timeZone:i,showLogs:y,showMetrics:T,showTable:v,showTrace:j,showCustom:R,showNodeGraph:I,showRawPrometheus:L,showFlameGraph:C,splitted:(0,U.pF)(t),compact:M,loading:Q,logsSample:E,showLogsSample:J,correlationEditorHelperData:D,correlationEditorDetails:s.correlationEditorDetails,exploreActiveDS:(0,U.Kl)(t),queryLibraryRef:H}}const Wa={changeDatasource:Ee.wh,changeSize:ve.QZ,modifyQueries:z.PD,scanStart:z.GI,scanStopAction:z.q9,setQueries:z.Rk,updateTimeRange:fe.GH,addQueryRow:z._0,splitOpen:q.ve,setSupplementaryQueryEnabled:z.TO,changeCompactMode:ve.RE},za=(0,be.connect)(Qa,Wa),Ka=(0,k.cV)(za(Va));var ws=l(86848),Ua=l(42836),qa=l(80307),Ga=l(82049),Za=l(55072),Ya=l(96065);function Ja(t){const{onClose:o,queryResponse:s,timeZone:n,isMixed:r,exploreId:i}=t,[c,h]=(0,d.useState)({withTransforms:!1,withFieldConfig:!0}),m=s?.series||[];let x=s?.errors;!x?.length&&s?.error&&(x=[s.error]);const p=(0,k.of)(ei);(0,d.useEffect)(()=>{(0,N.rR)("grafana_explore_query_inspector_opened")},[]);const g={label:(0,a.t)("explore.explore-query-inspector.stats-tab.label.stats","Stats"),value:"stats",icon:"chart-line",content:(0,e.jsx)(Za.N,{data:s,timeZone:s?.request?.timezone??te.vp})},f={label:(0,a.t)("explore.explore-query-inspector.json-tab.label.json","JSON"),value:"json",icon:"brackets-curly",content:(0,e.jsx)(Ga.w,{data:s,onClose:o})},y={label:(0,a.t)("explore.explore-query-inspector.data-tab.label.data","Data"),value:"data",icon:"database",content:(0,e.jsx)(Ua.q,{data:m,dataName:"Explore",isLoading:s.state===pe.Gu.Loading,options:c,timeZone:n,app:je.Jk.Explore,formattedDataDescription:"Matches the format in the panel",onOptionsChange:h})},T={label:(0,a.t)("explore.explore-query-inspector.query-tab.label.query","Query"),value:"query",icon:"info-circle",content:(0,e.jsx)("div",{className:p.queryInspectorWrapper,children:(0,e.jsx)(Ya.e,{instanceId:r?(0,Ye.qM)(0,(0,pt.uq)(i)):(0,pt.uq)(i),data:s,onRefreshQuery:()=>t.runQueries({exploreId:i})})})},v=[g,T,f,y];if(x?.length){const j={label:(0,a.t)("explore.explore-query-inspector.error-tab.label.error","Error"),value:"error",icon:"exclamation-triangle",content:(0,e.jsx)(qa.y,{errors:x})};v.push(j)}return(0,e.jsx)(Ho,{children:(0,e.jsx)(ws.q,{tabs:v,onClose:o,closeIconTooltip:"Close query inspector"})})}function Xa(t,{exploreId:o}){const n=t.explore.panes[o],{queryResponse:r}=n;return{queryResponse:r,isMixed:n.datasourceInstance?.meta.mixed||!1}}const _a={runQueries:z.Od},ei=t=>({queryInspectorWrapper:(0,u.css)({paddingBottom:t.spacing(3)})}),ti=(0,be.connect)(Xa,_a)(Ja),oi=(0,u.css)({label:"explorePaneContainer",display:"flex",flexDirection:"column",minWidth:"600px",height:"100%"});function si({exploreId:t}){ai(t);const o=(0,d.useRef)(new sn.o),s=(0,d.useRef)(null),[n,r]=(0,d.useState)(!1);return(0,d.useEffect)(()=>{const i=o.current;return()=>i.removeAllListeners()},[]),(0,e.jsxs)("div",{className:oi,ref:s,"data-testid":Qe.Tp.pages.Explore.General.container,children:[(0,e.jsx)(Ka,{exploreId:t,eventBus:o.current,showQueryInspector:n,setShowQueryInspector:r}),n&&(0,e.jsx)(ti,{exploreId:t,onClose:()=>r(!1),timeZone:(0,Bo.O)()})]})}function ni(t,o){return{pane:t.explore.panes[o.exploreId]}}const ri=(0,be.connect)(ni)(si);function ai(t){const o=(0,d.useMemo)(()=>(0,U.qq)(t),[t]),s=(0,d.useRef)();s.current=(0,A.d4)(o),(0,d.useEffect)(()=>()=>{(0,pt._u)(s.current?.querySubscription)},[])}var Re=l(11280),ii=l(21103),Ls=l(12737),Ue=l(75234),li=l(87105),jo=l(6890),Ro=l(64762),qe=l(87745),ci=l(19729);const di={setQueries:z.Rk,changeDatasource:Ee.wh},ui=(0,be.connect)(void 0,di);function pi({rootDatasourceUid:t,queries:o,disabled:s=!1,onClick:n,changeDatasource:r,setQueries:i}){const[c,h]=(0,d.useState)(!1),m=(0,A.d4)(U.pF),x=(0,A.d4)(U.Kl),p=(0,A.d4)(U.K6),g=(v,j)=>!x.dsToExplore.find(R=>R.datasource.uid===v)?.exploreIds.includes(j),f=(v,j)=>j!==void 0&&v!==void 0&&g(j,v)?{fallbackText:"Switch data source and run query",translation:(0,a.t)("explore.run-query.switch-datasource-button","Switch data source and run query")}:{fallbackText:"Run query",translation:(0,a.t)("explore.run-query.run-query-button","Run query")},y=async v=>{const j=g(t,v);j&&await r({exploreId:v,datasource:t}),i(v,o),(0,N.rR)("grafana_explore_query_history_run",{queryHistoryEnabled:P.$.queryHistoryEnabled,differentDataSource:j})},T=()=>{const v=s||o.length===0||t===void 0;if(m){const j=(0,e.jsx)(ke.W,{children:p.map((R,F)=>{const I=f(R[0],t),C=F===0?(0,a.t)("explore.run-query.left-pane","Left pane"):(0,a.t)("explore.run-query.right-pane","Right pane");return(0,e.jsx)(ke.W.Item,{ariaLabel:I.fallbackText,onClick:()=>{y(R[0]),n?.()},label:`${C}: ${I.translation}`,disabled:v||R[0]===void 0},F)})});return(0,e.jsx)(mt.m,{onVisibleChange:R=>h(R),placement:"bottom-start",overlay:j,children:(0,e.jsx)(ie.I,{"aria-label":(0,a.t)("explore.explore-run-query-button.run-button.aria-label-run-query-options","Run query options"),variant:"canvas",isOpen:c,children:(0,a.t)("explore.run-query.run-query-button","Run query")})})}else{const j=x.exploreToDS[0]?.exploreId,R=f(j,t);return(0,e.jsx)(b.$n,{variant:"primary","aria-label":R.translation,onClick:()=>{y(j),n?.()},disabled:v||j===void 0,children:R.translation})}};return(0,e.jsx)(e.Fragment,{children:T()})}const gi=ui(pi),hi=({query:t})=>{const[o,s]=(0,d.useState)(!1),{openDrawer:n,queryLibraryEnabled:r}=(0,Co.Y)(),i=(0,A.wA)(),h=(0,A.d4)(U.Kl).exploreToDS[0]?.exploreId,m=p=>{(0,N.rR)("grafana_explore_query_replaced_from_library"),h&&i((0,z.bO)({exploreId:h,queries:[p]}))},x=(0,a.t)("explore.rich-history-card.add-to-library","Save query");return ut.TP.hasRole("Viewer")?null:r&&!o?(0,e.jsx)(e.Fragment,{children:(0,e.jsx)(b.$n,{variant:"secondary","aria-label":x,onClick:()=>{n({query:t,onSelectQuery:m,options:{onSave:()=>{s(!0)},context:"rich-history"}})},children:x})}):null},mi={changeDatasource:Ee.wh,deleteHistoryItem:Re.VM,commentHistoryItem:Re.H9,starHistoryItem:Re.sh,setQueries:z.Rk},fi=(0,be.connect)(void 0,mi),xi=t=>{const o="240px",s="170px",n=t.colors.background.secondary;return{queryCard:(0,u.css)({position:"relative",display:"flex",flexDirection:"column",border:`1px solid ${t.colors.border.weak}`,margin:t.spacing(1,0),backgroundColor:n,borderRadius:t.shape.radius.default,".starred":{color:t.v1.palette.orange}}),cardRow:(0,u.css)({display:"flex",alignItems:"center",justifyContent:"space-between",padding:t.spacing(1),borderBottom:"none",":first-of-type":{borderBottom:`1px solid ${t.colors.border.weak}`,padding:t.spacing(.5,1)},img:{height:`${t.typography.fontSize}px`,maxWidth:`${t.typography.fontSize}px`,marginRight:t.spacing(1)}}),queryActionButtons:(0,u.css)({maxWidth:s,display:"flex",justifyContent:"flex-end",fontSize:t.typography.size.base,button:{marginLeft:t.spacing(1)}}),queryContainer:(0,u.css)({fontWeight:t.typography.fontWeightMedium,width:`calc(100% - ${o})`}),updateCommentContainer:(0,u.css)({width:`calc(100% + ${o})`,marginTop:t.spacing(1)}),comment:(0,u.css)({overflowWrap:"break-word",fontSize:t.typography.bodySmall.fontSize,fontWeight:t.typography.fontWeightRegular,marginTop:t.spacing(.5)}),commentButtonRow:(0,u.css)({"> *":{marginTop:t.spacing(1),marginRight:t.spacing(1)}}),textArea:(0,u.css)({width:"100%"}),runButton:(0,u.css)({maxWidth:s,display:"flex",justifyContent:"flex-end",button:{height:"auto",padding:t.spacing(.5,2),lineHeight:1.4,span:{whiteSpace:"normal !important"}}}),loader:(0,u.css)({position:"absolute",width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:t.colors.background.secondary})}};function yi(t){const{queryHistoryItem:o,commentHistoryItem:s,starHistoryItem:n,deleteHistoryItem:r,datasourceInstances:i}=t,[c,h]=(0,d.useState)(!1),[m,x]=(0,d.useState)(o.comment),p=(0,k.of)(xi),g=i?i.find(S=>S.uid===o.datasourceUid):void 0,f=async()=>{const S=[...o.queries.map(M=>M.datasource?.type||"unknown")];(0,N.rR)("grafana_explore_query_history_copy_query",{datasources:S,mixed:!!g?.meta.mixed});const D=o.queries.map(M=>{let H=i?.find(Q=>Q.uid===o.datasourceUid);return H?.meta.mixed&&(H=i?.find(Q=>Q.uid===M.datasource?.uid)),(0,ae.Ax)(M,H)}).join(`
`);(0,pt.uJ)(D),(0,ft.JD)((0,jo.dx)((0,Ro.tZ)((0,a.t)("explore.rich-history-notification.query-copied","Query copied to clipboard"))))},y=async()=>{const S=(0,ae.U3)(o);await(0,kt.VP)(S)},T=()=>{const S=D=>{r(D),(0,ft.JD)((0,jo.dx)((0,Ro.tZ)((0,a.t)("explore.rich-history-notification.query-deleted","Query deleted")))),(0,N.rR)("grafana_explore_query_history_deleted",{queryHistoryEnabled:P.$.queryHistoryEnabled})};o.starred?(0,Ue.J7)().publish(new qe.bY({title:(0,a.t)("explore.rich-history-card.delete-query-confirmation-title","Delete"),text:(0,a.t)("explore.rich-history-card.delete-starred-query-confirmation-text","Are you sure you want to permanently delete your starred query?"),yesText:(0,a.t)("explore.rich-history-card.confirm-delete","Delete"),icon:"trash-alt",onConfirm:()=>S(o.id)})):S(o.id)},v=()=>{n(o.id,!o.starred),(0,N.rR)("grafana_explore_query_history_starred",{queryHistoryEnabled:P.$.queryHistoryEnabled,newValue:!o.starred})},j=()=>h(!c),R=()=>{s(o.id,m),h(!1),(0,N.rR)("grafana_explore_query_history_commented",{queryHistoryEnabled:P.$.queryHistoryEnabled})},F=()=>{h(!1),x(o.comment)},I=S=>{S.key==="Enter"&&(S.shiftKey||S.ctrlKey)&&R(),S.key==="Escape"&&F()},C=(0,e.jsxs)("div",{className:p.updateCommentContainer,"aria-label":m?(0,a.t)("explore.rich-history-card.update-comment-form","Update comment form"):(0,a.t)("explore.rich-history-card.add-comment-form","Add comment form"),children:[(0,e.jsx)(li.f,{onKeyDown:I,value:m,placeholder:m?void 0:(0,a.t)("explore.rich-history-card.optional-description","An optional description of what the query does."),onChange:S=>x(S.currentTarget.value),className:p.textArea}),(0,e.jsxs)("div",{className:p.commentButtonRow,children:[(0,e.jsx)(b.$n,{onClick:R,children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-card.save-comment",children:"Save comment"})}),(0,e.jsx)(b.$n,{variant:"secondary",onClick:F,children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-card.cancel",children:"Cancel"})})]})]}),L=(0,e.jsxs)("div",{className:p.queryActionButtons,children:[(0,e.jsx)(_e.K,{name:"comment-alt",onClick:j,tooltip:o.comment?.length>0?(0,a.t)("explore.rich-history-card.edit-comment-tooltip","Edit comment"):(0,a.t)("explore.rich-history-card.add-comment-tooltip","Add comment")}),(0,e.jsx)(_e.K,{name:"copy",onClick:f,tooltip:(0,a.t)("explore.rich-history-card.copy-query-tooltip","Copy query to clipboard")}),g&&(0,e.jsx)(_e.K,{name:"share-alt",onClick:y,tooltip:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-card.copy-shortened-link-tooltip",children:"Copy shortened link to clipboard"})}),(0,e.jsx)(_e.K,{name:"trash-alt",title:(0,a.t)("explore.rich-history-card.delete-query-title","Delete query"),tooltip:(0,a.t)("explore.rich-history-card.delete-query-tooltip","Delete query"),onClick:T}),(0,e.jsx)(_e.K,{name:o.starred?"favorite":"star",iconType:o.starred?"mono":"default",onClick:v,tooltip:o.starred?(0,a.t)("explore.rich-history-card.unstar-query-tooltip","Unstar query"):(0,a.t)("explore.rich-history-card.star-query-tooltip","Star query")})]});return(0,e.jsxs)("div",{className:p.queryCard,children:[(0,e.jsxs)("div",{className:p.cardRow,children:[(0,e.jsx)(Is,{dsApi:g,size:"sm"}),L]}),(0,e.jsxs)("div",{className:(0,u.cx)(p.cardRow),children:[(0,e.jsxs)("div",{className:p.queryContainer,children:[o?.queries.map((S,D)=>{const M=i?.find(H=>H.uid===S.datasource?.uid);return(0,e.jsx)(bi,{query:{query:S,datasource:M},showDsInfo:g?.meta.mixed},`${S}-${D}`)}),!c&&o.comment&&(0,e.jsx)("div",{"aria-label":(0,a.t)("explore.rich-history-card.query-comment-label","Query comment"),className:p.comment,children:o.comment}),c&&C]}),!c&&(0,e.jsx)(hi,{query:o?.queries[0]}),!c&&(0,e.jsx)("div",{className:p.runButton,children:(0,e.jsx)(gi,{queries:o.queries,rootDatasourceUid:g?.uid})})]})]})}const vi=t=>({queryRow:(0,u.css)({borderTop:`1px solid ${t.colors.border.weak}`,display:"flex",flexDirection:"row",padding:t.spacing(.5,0),gap:t.spacing(.5),":first-child":{borderTop:"none"}}),dsInfoContainer:(0,u.css)({display:"flex",alignItems:"center"}),queryText:(0,u.css)({wordBreak:"break-all"})}),bi=({query:t,showDsInfo:o=!1})=>{const s=(0,k.of)(vi);return(0,e.jsxs)("div",{className:s.queryRow,children:[o&&(0,e.jsxs)("div",{className:s.dsInfoContainer,children:[(0,e.jsx)(Is,{dsApi:t.datasource,size:"md"}),": "]}),(0,e.jsx)("span",{"aria-label":(0,a.t)("explore.rich-history-card.query-text-label","Query text"),className:s.queryText,children:(0,ae.Ax)(t.query,t.datasource)})]})},Ci=t=>o=>(0,u.css)({display:"flex",alignItems:"center",fontSize:o.typography[t==="sm"?"bodySmall":"body"].fontSize,fontWeight:o.typography.fontWeightMedium,whiteSpace:"nowrap"});function Is({dsApi:t,size:o}){const s=(0,d.useCallback)(r=>Ci(o)(r),[o]),n=(0,k.of)(s);return(0,e.jsxs)("div",{className:n,children:[(0,e.jsx)("img",{src:t?.meta.info.logos.small||ci,alt:t?.type||(0,a.t)("explore.rich-history-card.datasource-not-exist","Data source does not exist anymore"),"aria-label":(0,a.t)("explore.rich-history-card.datasource-icon-label","Data source icon")}),(0,e.jsx)("div",{"aria-label":(0,a.t)("explore.rich-history-card.datasource-name-label","Data source name"),children:t?.name||(0,a.t)("explore.rich-history-card.datasource-not-exist","Data source does not exist anymore")})]})}const Es=fi(yi),Si=(t,o)=>({container:(0,u.css)({display:"flex"}),labelSlider:(0,u.css)({fontSize:t.typography.bodySmall.fontSize,"&:last-of-type":{marginTop:t.spacing(3)},"&:first-of-type":{fontWeight:t.typography.fontWeightMedium,marginBottom:t.spacing(2)}}),containerContent:(0,u.css)({width:"calc(100% - 134px)"}),containerSlider:(0,u.css)({width:"129px",marginRight:t.spacing(1)}),fixedSlider:(0,u.css)({position:"fixed"}),slider:(0,u.css)({bottom:"10px",height:`${o-180}px`,width:"129px",padding:t.spacing(1,0)}),selectors:(0,u.css)({display:"flex",justifyContent:"space-between",flexWrap:"wrap"}),filterInput:(0,u.css)({marginBottom:t.spacing(1)}),multiselect:(0,u.css)({width:"100%",marginBottom:t.spacing(1)}),sort:(0,u.css)({width:"170px"}),sessionName:(0,u.css)({display:"flex",alignItems:"flex-start",justifyContent:"flex-start",marginTop:t.spacing(3),h4:{margin:"0 10px 0 0"}}),heading:(0,u.css)({fontSize:t.typography.h4.fontSize,margin:t.spacing(2,.25,1,.25)}),footer:(0,u.css)({height:"60px",display:"flex",justifyContent:"center",alignItems:"center",fontWeight:t.typography.fontWeightLight,fontSize:t.typography.bodySmall.fontSize,a:{fontWeight:t.typography.fontWeightMedium,marginLeft:t.spacing(.25)}}),queries:(0,u.css)({fontSize:t.typography.bodySmall.fontSize,fontWeight:t.typography.fontWeightRegular,marginLeft:t.spacing(.5)})});function ji(t){const{queries:o,totalQueries:s,loading:n,richHistorySearchFilters:r,updateFilters:i,clearRichHistoryResults:c,loadMoreRichHistory:h,richHistorySettings:m,height:x,listOfDatasources:p,activeDatasources:g}=t,f=(0,k.of)(Si,x);(0,d.useEffect)(()=>{const I=!m.activeDatasourcesOnly&&m.lastUsedDatasourceFilters?m.lastUsedDatasourceFilters:g,C={search:"",sortOrder:ae.xB.Descending,datasourceFilters:I,from:0,to:m.retentionPeriod,starred:!1};return i(C),()=>{c()}},[]);const{value:y,loading:T}=(0,ao.A)(async()=>{const C=p.map(L=>L.uid).map(async L=>{try{return(0,We.l)().get(L)}catch{return Promise.resolve()}});return C!==void 0?(await Promise.all(C)).filter(S=>!!S):[]},[r?.datasourceFilters]);if(!r)return(0,e.jsx)("span",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-queries-tab.loading",children:"Loading..."})});const v=(0,ae.x8)(o,r.sortOrder),j=Fs(),R=o.length&&o.length!==s,F=[r.from||0,r.to||m.retentionPeriod];return(0,e.jsxs)("div",{className:f.container,children:[(0,e.jsx)("div",{className:f.containerSlider,children:(0,e.jsxs)("div",{className:f.fixedSlider,children:[(0,e.jsx)("div",{className:f.labelSlider,children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-queries-tab.filter-history",children:"Filter history"})}),(0,e.jsx)("div",{className:f.labelSlider,children:(0,ae.IA)(F[0])}),(0,e.jsx)("div",{className:f.slider,children:(0,e.jsx)(ii.F,{tooltipAlwaysVisible:!1,min:0,max:m.retentionPeriod,value:F,orientation:"vertical",formatTooltipResult:ae.IA,reverse:!0,onAfterChange:I=>{i({from:I[0],to:I[1]})}})}),(0,e.jsx)("div",{className:f.labelSlider,children:(0,ae.IA)(F[1])})]})}),(0,e.jsxs)("div",{className:f.containerContent,"data-testid":"query-history-queries-tab",children:[(0,e.jsxs)("div",{className:f.selectors,children:[!m.activeDatasourcesOnly&&(0,e.jsx)(ze.KF,{className:f.multiselect,options:p.map(I=>({value:I.name,label:I.name})),value:r.datasourceFilters,placeholder:(0,a.t)("explore.rich-history-queries-tab.filter-placeholder","Filter queries for data sources(s)"),"aria-label":(0,a.t)("explore.rich-history-queries-tab.filter-aria-label","Filter queries for data sources(s)"),onChange:I=>{i({datasourceFilters:I.map(C=>C.value)})}}),(0,e.jsx)("div",{className:f.filterInput,children:(0,e.jsx)(Ls.Z,{escapeRegex:!1,placeholder:(0,a.t)("explore.rich-history-queries-tab.search-placeholder","Search queries"),value:r.search,onChange:I=>i({search:I})})}),(0,e.jsx)("div",{"aria-label":(0,a.t)("explore.rich-history-queries-tab.sort-aria-label","Sort queries"),className:f.sort,children:(0,e.jsx)(ze.l6,{value:j.filter(I=>I.value===r.sortOrder),options:j,placeholder:(0,a.t)("explore.rich-history-queries-tab.sort-placeholder","Sort queries by"),onChange:I=>i({sortOrder:I.value})})})]}),(n||T)&&(0,e.jsx)("span",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-queries-tab.loading-results",children:"Loading results..."})}),!(n||T)&&Object.keys(v).map(I=>(0,e.jsxs)("div",{children:[(0,e.jsxs)("div",{className:f.heading,children:[I," ",(0,e.jsx)("span",{className:f.queries,children:R?(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-queries-tab.displaying-partial-queries",defaults:"Displaying {{ count }} queries",values:{count:v[I].length}}):(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-queries-tab.displaying-queries",defaults:"{{ count }} queries",values:{count:v[I].length}})})]}),v[I].map(C=>(0,e.jsx)(Es,{datasourceInstances:y,queryHistoryItem:C},C.id))]},I)),R?(0,e.jsx)("div",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-queries-tab.showing-queries",defaults:"Showing {{ shown }} of {{ total }} <0>Load more</0>",values:{shown:o.length,total:s},components:[(0,e.jsx)(b.$n,{onClick:h,children:"Load more"},"loadMoreButton")]})}):null,(0,e.jsx)("div",{className:f.footer,children:P.$.queryHistoryEnabled?"":(0,a.t)("explore.rich-history-queries-tab.history-local","The history is local to your browser and is not shared with others.")})]})]})}var Ri=l(66594);const Ti=t=>({container:(0,u.css)({fontSize:t.typography.bodySmall.fontSize}),spaceBetween:(0,u.css)({marginBottom:t.spacing(3)}),input:(0,u.css)({maxWidth:"200px"}),bold:(0,u.css)({fontWeight:t.typography.fontWeightBold}),bottomMargin:(0,u.css)({marginBottom:t.spacing(1)})});function wi(t){const{retentionPeriod:o,starredTabAsFirstTab:s,activeDatasourcesOnly:n,onChangeRetentionPeriod:r,toggleStarredTabAsFirstTab:i,toggleActiveDatasourcesOnly:c,deleteRichHistory:h}=t,m=(0,k.of)(Ti),x=[{value:2,label:(0,a.t)("explore.rich-history-settings-tab.retention-period.2-days","2 days")},{value:5,label:(0,a.t)("explore.rich-history-settings-tab.retention-period.5-days","5 days")},{value:7,label:(0,a.t)("explore.rich-history-settings-tab.retention-period.1-week","1 week")},{value:14,label:(0,a.t)("explore.rich-history-settings-tab.retention-period.2-weeks","2 weeks")}],p=x.find(f=>f.value===o),g=()=>{(0,Ue.J7)().publish(new qe.bY({title:(0,a.t)("explore.rich-history-settings-tab.delete-title","Delete"),text:(0,a.t)("explore.rich-history-settings-tab.delete-confirm-text","Are you sure you want to permanently delete your query history?"),yesText:(0,a.t)("explore.rich-history-settings-tab.delete-confirm","Delete"),icon:"trash-alt",onConfirm:()=>{h(),(0,ft.JD)((0,jo.dx)((0,Ro.tZ)((0,a.t)("explore.rich-history-settings-tab.query-history-deleted","Query history deleted"))))}}))};return(0,e.jsxs)("div",{className:m.container,children:[(0,gt.gQ)().changeRetention?(0,e.jsx)(Ne.D,{label:(0,a.t)("explore.rich-history-settings-tab.history-time-span","History time span"),description:(0,a.t)("explore.rich-history-settings-tab.history-time-span-description","Select the period of time for which Grafana will save your query history. Up to {{MAX_HISTORY_ITEMS}} entries will be stored.",{MAX_HISTORY_ITEMS:Ri.$H}),children:(0,e.jsx)("div",{className:m.input,children:(0,e.jsx)(ze.l6,{value:p,options:x,onChange:r})})}):(0,e.jsx)(ht.F,{severity:"info",title:(0,a.t)("explore.rich-history-settings-tab.history-time-span","History time span"),children:(0,a.t)("explore.rich-history-settings-tab.alert-info","Grafana will keep entries up to {{optionLabel}}.Starred entries won't be deleted.",{optionLabel:p?.label})}),(0,e.jsx)(De.I,{label:(0,a.t)("explore.rich-history-settings-tab.change-default-tab","Change the default active tab from \u201CQuery history\u201D to \u201CStarred\u201D"),className:m.spaceBetween,children:(0,e.jsx)(Ke.K,{id:"explore-query-history-settings-default-active-tab",value:s,onChange:i})}),(0,gt.gQ)().onlyActiveDataSource&&(0,e.jsx)(De.I,{label:(0,a.t)("explore.rich-history-settings-tab.only-show-active-datasource","Only show queries for data source currently active in Explore"),className:m.spaceBetween,children:(0,e.jsx)(Ke.K,{id:"explore-query-history-settings-data-source-behavior",value:n,onChange:c})}),(0,gt.gQ)().clearHistory&&(0,e.jsxs)("div",{children:[(0,e.jsx)("div",{className:m.bold,children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-settings-tab.clear-query-history",children:"Clear query history"})}),(0,e.jsx)("div",{className:m.bottomMargin,children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-settings-tab.clear-history-info",children:"Delete all of your query history, permanently."})}),(0,e.jsx)(b.$n,{variant:"destructive",onClick:g,children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-settings-tab.clear-query-history-button",children:"Clear query history"})})]})]})}const Li=t=>({container:(0,u.css)({display:"flex"}),containerContent:(0,u.css)({width:"100%"}),selectors:(0,u.css)({display:"flex",justifyContent:"space-between",flexWrap:"wrap"}),multiselect:(0,u.css)({width:"100%",marginBottom:t.spacing(1)}),filterInput:(0,u.css)({marginBottom:t.spacing(1)}),sort:(0,u.css)({width:"170px"}),footer:(0,u.css)({height:"60px",display:"flex",justifyContent:"center",alignItems:"center",fontWeight:t.typography.fontWeightLight,fontSize:t.typography.bodySmall.fontSize,a:{fontWeight:t.typography.fontWeightMedium,marginLeft:t.spacing(.25)}})});function Ii(t){const{updateFilters:o,clearRichHistoryResults:s,loadMoreRichHistory:n,richHistorySettings:r,queries:i,totalQueries:c,loading:h,richHistorySearchFilters:m}=t,x=(0,k.of)(Li),p=(0,A.d4)(U.Kl),g=(0,ae.TR)();(0,d.useEffect)(()=>{const v=r.activeDatasourcesOnly&&r.lastUsedDatasourceFilters?r.lastUsedDatasourceFilters:p.dsToExplore.map(R=>g.find(F=>F.uid===R.datasource?.uid)?.name).filter(R=>!!R),j={search:"",sortOrder:ae.xB.Descending,datasourceFilters:v,from:0,to:r.retentionPeriod,starred:!0};return o(j),()=>{s()}},[]);const{value:f,loading:y}=(0,ao.A)(async()=>{const j=await(m?.datasourceFilters&&m?.datasourceFilters.length>0?m?.datasourceFilters:g.map(R=>R.uid)).map(async R=>{try{return(0,We.l)().get(R)}catch{return Promise.resolve()}});return j!==void 0?(await Promise.all(j)).filter(F=>!!F):[]},[m?.datasourceFilters]);if(!m)return(0,e.jsxs)("span",{children:[(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-starred-tab.loading",children:"Loading..."}),";"]});const T=Fs();return(0,e.jsx)("div",{className:x.container,children:(0,e.jsxs)("div",{className:x.containerContent,children:[(0,e.jsxs)("div",{className:x.selectors,children:[!r.activeDatasourcesOnly&&(0,e.jsx)(ze.KF,{className:x.multiselect,options:g.map(v=>({value:v.name,label:v.name})),value:m.datasourceFilters,placeholder:(0,a.t)("explore.rich-history-starred-tab.filter-queries-placeholder","Filter queries for data sources(s)"),"aria-label":(0,a.t)("explore.rich-history-starred-tab.filter-queries-aria-label","Filter queries for data sources(s)"),onChange:v=>{o({datasourceFilters:v.map(j=>j.value)})}}),(0,e.jsx)("div",{className:x.filterInput,children:(0,e.jsx)(Ls.Z,{escapeRegex:!1,placeholder:(0,a.t)("explore.rich-history-starred-tab.search-queries-placeholder","Search queries"),value:m.search,onChange:v=>o({search:v})})}),(0,e.jsx)("div",{"aria-label":(0,a.t)("explore.rich-history-starred-tab.sort-queries-aria-label","Sort queries"),className:x.sort,children:(0,e.jsx)(ze.l6,{value:T.filter(v=>v.value===m.sortOrder),options:T,placeholder:(0,a.t)("explore.rich-history-starred-tab.sort-queries-placeholder","Sort queries by"),onChange:v=>o({sortOrder:v.value})})})]}),h&&y&&(0,e.jsx)("span",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-starred-tab.loading-results",children:"Loading results..."})}),!(h&&y)&&i.map(v=>(0,e.jsx)(Es,{queryHistoryItem:v,datasourceInstances:f},v.id)),i.length&&i.length!==c?(0,e.jsx)("div",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-starred-tab.showing-queries",defaults:"Showing {{ shown }} of {{ total }} <0>Load more</0>",values:{shown:i.length,total:c},components:[(0,e.jsx)(b.$n,{onClick:n,children:"Load more"},"loadMoreButton")]})}):null,(0,e.jsx)("div",{className:x.footer,children:P.$.queryHistoryEnabled?"":(0,a.t)("explore.rich-history-starred-tab.local-history-message","The history is local to your browser and is not shared with others.")})]})})}const Fs=()=>[{label:(0,a.t)("explore.rich-history.newest-first","Newest first"),value:ae.xB.Descending},{label:(0,a.t)("explore.rich-history.oldest-first","Oldest first"),value:ae.xB.Ascending},{label:(0,a.t)("explore.rich-history.datasource-a-z","Data source A-Z"),value:ae.xB.DatasourceAZ},{label:(0,a.t)("explore.rich-history.datasource-z-a","Data source Z-A"),value:ae.xB.DatasourceZA}].filter(t=>(0,gt.gQ)().availableFilters.includes(t.value));function Ei(t){const{richHistory:o,richHistoryTotal:s,height:n,deleteRichHistory:r,onClose:i,firstTab:c}=t,[h,m]=(0,d.useState)(!1),x=S=>{t.updateHistorySettings({...t.richHistorySettings,...S})},p=S=>{const D={...t.richHistorySearchFilters,...S,page:1};t.updateHistorySearchFilters(D),g()},g=(0,_.debounce)(()=>{t.loadRichHistory(),m(!0)},300),f=S=>{S.value!==void 0&&x({retentionPeriod:S.value})},y=()=>x({starredTabAsFirstTab:!t.richHistorySettings.starredTabAsFirstTab}),T=()=>x({activeDatasourcesOnly:!t.richHistorySettings.activeDatasourcesOnly});(0,d.useEffect)(()=>{m(!1)},[o]);const v=(0,A.d4)(U.Kl),j=(0,ae.TR)(),R=v.dsToExplore.map(S=>j.find(D=>D.uid===S.datasource?.uid)?.name).filter(S=>!!S),F={label:(0,a.t)("explore.rich-history.query-history","Query history"),value:tt.tU.RichHistory,content:(0,e.jsx)(ji,{queries:o,totalQueries:s||0,loading:h,updateFilters:p,clearRichHistoryResults:()=>t.clearRichHistoryResults(),loadMoreRichHistory:()=>t.loadMoreRichHistory(),richHistorySettings:t.richHistorySettings,richHistorySearchFilters:t.richHistorySearchFilters,height:n,activeDatasources:R,listOfDatasources:j}),icon:"history"},I={label:(0,a.t)("explore.rich-history.starred","Starred"),value:tt.tU.Starred,content:(0,e.jsx)(Ii,{queries:o,totalQueries:s||0,loading:h,updateFilters:p,clearRichHistoryResults:()=>t.clearRichHistoryResults(),loadMoreRichHistory:()=>t.loadMoreRichHistory(),richHistorySettings:t.richHistorySettings,richHistorySearchFilters:t.richHistorySearchFilters}),icon:"star"},C={label:(0,a.t)("explore.rich-history.settings","Settings"),value:tt.tU.Settings,content:(0,e.jsx)(wi,{retentionPeriod:t.richHistorySettings.retentionPeriod,starredTabAsFirstTab:t.richHistorySettings.starredTabAsFirstTab,activeDatasourcesOnly:t.richHistorySettings.activeDatasourcesOnly,onChangeRetentionPeriod:f,toggleStarredTabAsFirstTab:y,toggleActiveDatasourcesOnly:T,deleteRichHistory:r}),icon:"sliders-v-alt"};let L=[F,I,C];return(0,e.jsx)(ws.q,{tabs:L,onClose:i,defaultTab:c,closeIconTooltip:(0,a.t)("explore.rich-history.close-tooltip","Close query history"),testId:Qe.Tp.pages.Explore.QueryHistory.container})}function Fi(t){const o=t.explore,s=o.richHistorySearchFilters,{richHistorySettings:n,richHistory:r,richHistoryTotal:i}=o;return{richHistory:r,richHistoryTotal:i,richHistorySettings:n,richHistorySearchFilters:s}}const Di={initRichHistory:Re.PA,loadRichHistory:Re.jX,loadMoreRichHistory:Re.Uu,clearRichHistoryResults:Re.wk,updateHistorySettings:Re.fP,updateHistorySearchFilters:Re.Bj,deleteRichHistory:Re.s1},Oi=(0,be.connect)(Fi,Di);function Ai(t){const o=(0,k.$j)(),{richHistory:s,richHistoryTotal:n,deleteRichHistory:r,initRichHistory:i,loadRichHistory:c,loadMoreRichHistory:h,clearRichHistoryResults:m,richHistorySettings:x,updateHistorySettings:p,richHistorySearchFilters:g,updateHistorySearchFilters:f,onClose:y}=t;(0,d.useEffect)(()=>{i()},[i]);const{selectedTab:T}=(0,tt.sz)(),[v,j]=(0,d.useState)(!1);return(0,d.useEffect)(()=>{v||(j(!0),(0,N.rR)("grafana_explore_query_history_opened",{queryHistoryEnabled:P.$.queryHistoryEnabled,selectedTab:T}))},[v,T]),x?(0,e.jsx)(Ei,{richHistory:s,richHistoryTotal:n,firstTab:T,onClose:y,height:o.components.horizontalDrawer.defaultHeight,deleteRichHistory:r,richHistorySettings:x,richHistorySearchFilters:g,updateHistorySettings:p,updateHistorySearchFilters:f,loadRichHistory:c,loadMoreRichHistory:h,clearRichHistoryResults:m}):(0,e.jsx)("span",{children:(0,e.jsx)(a.x6,{i18nKey:"explore.rich-history-container.loading",children:"Loading..."})})}const Pi=Oi(Ai);var Ds=l(92948),Os=l(8692);function Ni(t){const o=(0,it.C)("explore"),{chrome:s}=(0,$e.Il)();(0,d.useEffect)(()=>{if(!t.panes||typeof t.panes!="string")return;let n;try{n=JSON.parse(t.panes)}catch{return}typeof n!="object"||n===null||Promise.allSettled(Object.values(n).map(r=>!r||typeof r!="object"||!(0,Os.C)("datasource",r)||!r.datasource||typeof r.datasource!="string"?Promise.reject():(0,We.l)().get(r.datasource))).then(r=>r.filter(Os.s).map(i=>i.value)).then(r=>{if(r.length===0){l.g.document.title=`${o.main.text} - ${Ds.M.AppTitle}`,s.update({pageNav:void 0});return}const i=r.map(c=>c.name).join(" | ");s.update({pageNav:{text:i}}),l.g.document.title=`${o.main.text} - ${i} - ${Ds.M.AppTitle}`})},[t.panes,o.main.text,s])}function ki(){const{keybindings:t}=(0,$e.Il)(),o=(0,A.wA)();(0,d.useEffect)(()=>{t.setupTimeRangeBindings(!1);const s=[];return s.push((0,Ue.J7)().subscribe(qe.Rh,()=>{o((0,fe.$_)())})),s.push((0,Ue.J7)().subscribe(qe.Io,n=>{o((0,fe.Iy)(n.payload.direction))})),s.push((0,Ue.J7)().subscribe(qe.U0,n=>{o((0,fe.ke)(n.payload.scale))})),s.push((0,Ue.J7)().subscribe(qe.Bt,()=>{o((0,fe.Xk)())})),s.push((0,Ue.J7)().subscribe(qe.VZ,()=>{o((0,fe.GA)())})),()=>{s.forEach(n=>n.unsubscribe())}},[o,t])}const Mi=t=>{const o=(0,A.wA)(),{width:s}=(0,vo.A)(),n=(0,A.d4)(U.K6),r=(0,A.d4)(U.pF),[i,c]=(0,d.useState)(.5),h=(0,A.d4)(p=>p.explore),m=p=>{const g=s/2,f=(0,_.inRange)(p,g-100,g+100);o(f?(0,q.nD)({largerExploreId:void 0}):(0,q.nD)({largerExploreId:p>g?n[1][0]:n[0][0]})),c(p/s)};let x=0;return r&&(!h.evenSplitPanes&&h.maxedExploreId?x=h.maxedExploreId===n[1][0]?s-t:t:h.evenSplitPanes?x=Math.floor(s/2):i!==void 0&&(x=s*i)),{updateSplitSize:m,widthCalc:x}};function Hi(){const{location:t}=(0,$e.Il)();(0,d.useEffect)(()=>{const o=t.getSearchObject();(o.from||o.to)&&t.partial({from:void 0,to:void 0},!0)},[t])}const To=200;function Bi(t){return(0,e.jsx)($i,{...t})}function $i(t){const o=(0,k.of)(Vi),s=(0,k.$j)();Hi(),(0,ps.s)(t.queryParams),Ni(t.queryParams);const{chrome:n}=(0,$e.Il)(),r=(0,it.C)("explore"),{updateSplitSize:i,widthCalc:c}=Mi(To),h=(0,A.d4)(U.K6),m=(0,A.d4)(U.pF),x=(0,A.d4)(U.vC),{drawerOpened:p,setDrawerOpened:g}=(0,tt.sz)(),f=P.$.featureToggles.correlations&&(x?.editorMode||!1);return(0,d.useEffect)(()=>{n.update({sectionNav:r})},[n,r]),ki(),(0,e.jsxs)("div",{className:(0,u.cx)(o.pageScrollbarWrapper,{[o.correlationsEditorIndicator]:f}),children:[(0,e.jsx)("h1",{className:"sr-only",children:(0,e.jsx)(a.x6,{i18nKey:"nav.explore.title"})}),(0,e.jsx)(Xs,{}),f&&(0,e.jsx)(Ys,{panes:h}),(0,e.jsx)(_t.g,{splitOrientation:"vertical",paneSize:c,minSize:To,maxSize:To*-1,primary:"second",splitVisible:m,parentStyle:f?{height:`calc(100% - ${s.spacing(6)}`}:{},paneStyle:{overflow:"auto",display:"flex",flexDirection:"column"},onDragFinished:y=>y&&i(y),children:h.map(([y,T])=>(0,e.jsx)(oe.Xw,{style:"page",children:T.initialized?(0,e.jsx)(ri,{exploreId:y}):(0,e.jsx)(Rt._,{text:(0,a.t)("explore.pane.loading-placeholder","Loading...")})},y))}),p&&(0,e.jsx)(Ho,{children:(0,e.jsx)(Pi,{onClose:()=>{g(!1)}})})]})}const Vi=t=>({pageScrollbarWrapper:(0,u.css)({width:"100%",flexGrow:1,minHeight:0,height:"100%",position:"relative",overflow:"hidden"}),correlationsEditorIndicator:(0,u.css)({borderLeft:`4px solid ${t.colors.primary.main}`,borderRight:`4px solid ${t.colors.primary.main}`,borderBottom:`4px solid ${t.colors.primary.main}`,overflow:"scroll"})})},58843:(Xt,Pe,l)=>{l.d(Pe,{L5:()=>d,hr:()=>a,jN:()=>P});var e=l(79609),u=l(92745);function d(k){}function a(k){switch(k){case e.CC.Logfmt:return{label:(0,u.t)("correlations.trans-details.logfmt-label","Logfmt"),value:e.CC.Logfmt,description:(0,u.t)("correlations.trans-details.logfmt-description","Parse provided field with logfmt to get variables"),expressionDetails:{show:!1},mapValueDetails:{show:!1}};case e.CC.Regex:return{label:(0,u.t)("correlations.trans-details.regex-label","Regular expression"),value:e.CC.Regex,description:(0,u.t)("correlations.trans-details.regex-description","Field will be parsed with regex. Use named capture groups to return multiple variables, or a single unnamed capture group to add variable to named map value. Regex is case insensitive."),expressionDetails:{show:!0,required:!0,helpText:(0,u.t)("correlations.trans-details.regex-expression","Use capture groups to extract a portion of the field.")},mapValueDetails:{show:!0,required:!1,helpText:(0,u.t)("correlations.trans-details.regex-map-values","Defines the name of the variable if the capture group is not named.")}};default:return{label:k,value:k,expressionDetails:{show:!1},mapValueDetails:{show:!1}}}}const P=()=>Object.values(e.CC).map(k=>{const oe=a(k);return{label:oe.label,value:oe.value,description:oe.description}})},66178:(Xt,Pe,l)=>{l.d(Pe,{A:()=>d});var e=l(96540),u=function(a,P){var k=(0,e.useRef)(function(){});(0,e.useEffect)(function(){k.current=a}),(0,e.useEffect)(function(){if(P!==null){var oe=setInterval(function(){return k.current()},P||0);return function(){return clearInterval(oe)}}},[P])};const d=u}}]);

//# sourceMappingURL=explore.bf3d9a70cdfcc91fa967.js.map