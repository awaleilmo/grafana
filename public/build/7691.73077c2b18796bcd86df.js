"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[7691],{27522:(ve,te,d)=>{d.d(te,{B:()=>Q,a:()=>p});var se=d(96426);function Q(R,D,v,ae){if(!R)return!1;const Y=P(D,ae);if(!Y.length)return!1;let z=Y;if(R!==D){const M=P(R,ae);z=Y.flatMap(X=>M.filter(Ce=>X.text===Ce.text)||X)}return z.map(M=>T(R,v,M)).filter(I)}function P(R,D){const v=[];return D.parse(R).iterate({enter:Y=>{if(Y.type.id===se.Ql){const z=Y.node;v.push({node:z,text:R.substring(z.from,z.to)})}}}),v}function T(R,D,v){if(D.length===1){const z=v.node.from===v.node.to,M=z&&v.node.parent?v.node.parent:v.node,X=z?R.substring(M.from,M.to):v.text;return{startLineNumber:1,startColumn:M.from+1,endLineNumber:1,endColumn:M.to+1,error:X}}let ae=0,Y=0;for(let z=0;z<D.length;z++){if(Y=ae+D[z].length,v.node.from>Y){ae+=D[z].length+1;continue}return{startLineNumber:z+1,startColumn:v.node.from-ae+1,endLineNumber:z+1,endColumn:v.node.to-ae+1,error:v.text}}return null}function I(R){return R!==null}const p={__interval:{text:"1s",value:"1s"},__rate_interval:{text:"1s",value:"1s"},__auto:{text:"1s",value:"1s"},__interval_ms:{text:"1000",value:1e3},__range_ms:{text:"1000",value:1e3},__range_s:{text:"1",value:1},__range:{text:"1s",value:"1s"}}},32300:(ve,te,d)=>{d.d(te,{U:()=>I});var se=d(22803),Q=d(96540),P=d(63142),T=d(46936);const I=({children:R})=>{const D=(0,P.of)(p);return Q.createElement("div",{className:D.root},Q.createElement(T.C,{gap:2},R))},p=R=>({root:(0,se.css)({padding:R.spacing(1),backgroundColor:R.colors.background.secondary,borderRadius:R.shape.radius.default})})},41391:(ve,te,d)=>{d.d(te,{A:()=>P});const se=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function Q(T){return typeof T=="string"&&se.test(T)}const P=Q},46936:(ve,te,d)=>{d.d(te,{C:()=>P});var se=d(96540),Q=d(41654);const P=({children:T,wrap:I=!0,...p})=>{var R,D;return se.createElement(Q.B,{wrap:I?"wrap":void 0,direction:(R=p.direction)!=null?R:"row",gap:(D=p.gap)!=null?D:2,...p},T)}},54078:(ve,te,d)=>{d.d(te,{Z:()=>p});var se=d(22803),Q=d(28848),P=d(96540),T=d(63704),I=d(63142);function p({query:D,language:v,className:ae}){const Y=(0,I.$j)(),z=R(Y),M=Q.highlight(D,v.grammar,v.name);return P.createElement("div",{className:(0,se.cx)(z.editorField,"prism-syntax-highlight",ae),"aria-label":"selector",dangerouslySetInnerHTML:{__html:T.sQ.sanitize(M)}})}const R=D=>({editorField:(0,se.css)({fontFamily:D.typography.fontFamilyMonospace,fontSize:D.typography.bodySmall.fontSize})})},72316:(ve,te,d)=>{d.d(te,{v:()=>P});var se=d(88483),Q=d(15964);function P(T){return new se.c(function(I){(0,Q.Tg)(T()).subscribe(I)})}},87691:(ve,te,d)=>{d.r(te),d.d(te,{plugin:()=>va});var se=d(16207),Q=d(739),P=d(67770),T=d(92745),I=d(43173),p=d(74848),R=d(22803),D=d(2543),v=d(96540),ae=d(50832),Y=d(75505),z=d(57852),M=d(1906),X=d(28105),Ce=d(5556),J=d(25229),Ae=d(17548),Ps=d(75234),Dt=d(63142),Os=d(64400),Ms=d(92807),ks=d(78529),Us=d(44376),Ns=d(17896),Qs=d(27789),Vs=d(96195),js=d(82423),Bs=d(88642),_=d(95004),Pt=d(51388),Ot=d(76732),$s=d(39443),Ie=d(88483),Mt=d(59099),_e=d(24726),_s=d(27359);function zs(r,e,t){if(e-r<=t)return[[r,e]];const s=[];for(let n=e;n>r;n-=t){const a=Math.max(n-t,r);s.push([a,n])}return s.reverse(),s}function Ws(r,e,t,s){if(s<t)return[[r,e]];const n=Math.trunc(s/t)*t,a=r-r%t,i=[];for(let o=a;o<e;o+=n){const l=Math.min(o+n-t,e);i.push([o,l])}return i}var w=d(24162),ie=d(69457),ce=d(27489),kt=d(13288),Ut=d(44240),ze=d(62467),Te=d(81160),Nt=d(66847),Qt=d(63720),Ks=d(88673),Vt=d(428),ee=d(36195),Hs=d(36580),Gs=d(2863);const be=typeof performance=="object"&&performance&&typeof performance.now=="function"?performance:Date,jt=new Set,We=typeof process=="object"&&process?process:{},Bt=(r,e,t,s)=>{typeof We.emitWarning=="function"?We.emitWarning(r,e,t,s):console.error(`[${t}] ${e}: ${r}`)};let De=globalThis.AbortController,$t=globalThis.AbortSignal;if(typeof De>"u"){$t=class{onabort;_onabort=[];reason;aborted=!1;addEventListener(s,n){this._onabort.push(n)}},De=class{constructor(){e()}signal=new $t;abort(s){if(!this.signal.aborted){this.signal.reason=s,this.signal.aborted=!0;for(const n of this.signal._onabort)n(s);this.signal.onabort?.(s)}}};let r=We.env?.LRU_CACHE_IGNORE_AC_WARNING!=="1";const e=()=>{r&&(r=!1,Bt("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",e))}}const Js=r=>!jt.has(r),wa=Symbol("type"),fe=r=>r&&r===Math.floor(r)&&r>0&&isFinite(r),_t=r=>fe(r)?r<=Math.pow(2,8)?Uint8Array:r<=Math.pow(2,16)?Uint16Array:r<=Math.pow(2,32)?Uint32Array:r<=Number.MAX_SAFE_INTEGER?Pe:null:null;class Pe extends Array{constructor(e){super(e),this.fill(0)}}class xe{heap;length;static#l=!1;static create(e){const t=_t(e);if(!t)return[];xe.#l=!0;const s=new xe(e,t);return xe.#l=!1,s}constructor(e,t){if(!xe.#l)throw new TypeError("instantiate Stack using Stack.create(n)");this.heap=new t(e),this.length=0}push(e){this.heap[this.length++]=e}pop(){return this.heap[--this.length]}}class ye{#l;#d;#p;#F;#m;#D;#P;ttl;ttlResolution;ttlAutopurge;updateAgeOnGet;updateAgeOnHas;allowStale;noDisposeOnSet;noUpdateTTL;maxEntrySize;sizeCalculation;noDeleteOnFetchRejection;noDeleteOnStaleGet;allowStaleOnFetchAbort;allowStaleOnFetchRejection;ignoreFetchAbort;#r;#y;#n;#s;#e;#c;#f;#o;#a;#v;#i;#b;#x;#h;#S;#R;#u;#O;static unsafeExposeInternals(e){return{starts:e.#x,ttls:e.#h,sizes:e.#b,keyMap:e.#n,keyList:e.#s,valList:e.#e,next:e.#c,prev:e.#f,get head(){return e.#o},get tail(){return e.#a},free:e.#v,isBackgroundFetch:t=>e.#t(t),backgroundFetch:(t,s,n,a)=>e.#U(t,s,n,a),moveToTail:t=>e.#I(t),indexes:t=>e.#L(t),rindexes:t=>e.#T(t),isStale:t=>e.#g(t)}}get max(){return this.#l}get maxSize(){return this.#d}get calculatedSize(){return this.#y}get size(){return this.#r}get fetchMethod(){return this.#D}get memoMethod(){return this.#P}get dispose(){return this.#p}get onInsert(){return this.#F}get disposeAfter(){return this.#m}constructor(e){const{max:t=0,ttl:s,ttlResolution:n=1,ttlAutopurge:a,updateAgeOnGet:i,updateAgeOnHas:o,allowStale:l,dispose:c,onInsert:f,disposeAfter:u,noDisposeOnSet:g,noUpdateTTL:h,maxSize:m=0,maxEntrySize:y=0,sizeCalculation:x,fetchMethod:b,memoMethod:E,noDeleteOnFetchRejection:k,noDeleteOnStaleGet:A,allowStaleOnFetchRejection:j,allowStaleOnFetchAbort:$,ignoreFetchAbort:B}=e;if(t!==0&&!fe(t))throw new TypeError("max option must be a nonnegative integer");const F=t?_t(t):Array;if(!F)throw new Error("invalid max value: "+t);if(this.#l=t,this.#d=m,this.maxEntrySize=y||this.#d,this.sizeCalculation=x,this.sizeCalculation){if(!this.#d&&!this.maxEntrySize)throw new TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if(typeof this.sizeCalculation!="function")throw new TypeError("sizeCalculation set to non-function")}if(E!==void 0&&typeof E!="function")throw new TypeError("memoMethod must be a function if defined");if(this.#P=E,b!==void 0&&typeof b!="function")throw new TypeError("fetchMethod must be a function if specified");if(this.#D=b,this.#R=!!b,this.#n=new Map,this.#s=new Array(t).fill(void 0),this.#e=new Array(t).fill(void 0),this.#c=new F(t),this.#f=new F(t),this.#o=0,this.#a=0,this.#v=xe.create(t),this.#r=0,this.#y=0,typeof c=="function"&&(this.#p=c),typeof f=="function"&&(this.#F=f),typeof u=="function"?(this.#m=u,this.#i=[]):(this.#m=void 0,this.#i=void 0),this.#S=!!this.#p,this.#O=!!this.#F,this.#u=!!this.#m,this.noDisposeOnSet=!!g,this.noUpdateTTL=!!h,this.noDeleteOnFetchRejection=!!k,this.allowStaleOnFetchRejection=!!j,this.allowStaleOnFetchAbort=!!$,this.ignoreFetchAbort=!!B,this.maxEntrySize!==0){if(this.#d!==0&&!fe(this.#d))throw new TypeError("maxSize must be a positive integer if specified");if(!fe(this.maxEntrySize))throw new TypeError("maxEntrySize must be a positive integer if specified");this.#_()}if(this.allowStale=!!l,this.noDeleteOnStaleGet=!!A,this.updateAgeOnGet=!!i,this.updateAgeOnHas=!!o,this.ttlResolution=fe(n)||n===0?n:1,this.ttlAutopurge=!!a,this.ttl=s||0,this.ttl){if(!fe(this.ttl))throw new TypeError("ttl must be a positive integer if specified");this.#N()}if(this.#l===0&&this.ttl===0&&this.#d===0)throw new TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!this.#l&&!this.#d){const W="LRU_CACHE_UNBOUNDED";Js(W)&&(jt.add(W),Bt("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",W,ye))}}getRemainingTTL(e){return this.#n.has(e)?1/0:0}#N(){const e=new Pe(this.#l),t=new Pe(this.#l);this.#h=e,this.#x=t,this.#Q=(a,i,o=be.now())=>{if(t[a]=i!==0?o:0,e[a]=i,i!==0&&this.ttlAutopurge){const l=setTimeout(()=>{this.#g(a)&&this.#E(this.#s[a],"expire")},i+1);l.unref&&l.unref()}},this.#C=a=>{t[a]=e[a]!==0?be.now():0},this.#w=(a,i)=>{if(e[i]){const o=e[i],l=t[i];if(!o||!l)return;a.ttl=o,a.start=l,a.now=s||n();const c=a.now-l;a.remainingTTL=o-c}};let s=0;const n=()=>{const a=be.now();if(this.ttlResolution>0){s=a;const i=setTimeout(()=>s=0,this.ttlResolution);i.unref&&i.unref()}return a};this.getRemainingTTL=a=>{const i=this.#n.get(a);if(i===void 0)return 0;const o=e[i],l=t[i];if(!o||!l)return 1/0;const c=(s||n())-l;return o-c},this.#g=a=>{const i=t[a],o=e[a];return!!o&&!!i&&(s||n())-i>o}}#C=()=>{};#w=()=>{};#Q=()=>{};#g=()=>!1;#_(){const e=new Pe(this.#l);this.#y=0,this.#b=e,this.#A=t=>{this.#y-=e[t],e[t]=0},this.#V=(t,s,n,a)=>{if(this.#t(s))return 0;if(!fe(n))if(a){if(typeof a!="function")throw new TypeError("sizeCalculation must be a function");if(n=a(s,t),!fe(n))throw new TypeError("sizeCalculation return invalid (expect positive integer)")}else throw new TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");return n},this.#M=(t,s,n)=>{if(e[t]=s,this.#d){const a=this.#d-e[t];for(;this.#y>a;)this.#k(!0)}this.#y+=e[t],n&&(n.entrySize=s,n.totalCalculatedSize=this.#y)}}#A=e=>{};#M=(e,t,s)=>{};#V=(e,t,s,n)=>{if(s||n)throw new TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0};*#L({allowStale:e=this.allowStale}={}){if(this.#r)for(let t=this.#a;!(!this.#j(t)||((e||!this.#g(t))&&(yield t),t===this.#o));)t=this.#f[t]}*#T({allowStale:e=this.allowStale}={}){if(this.#r)for(let t=this.#o;!(!this.#j(t)||((e||!this.#g(t))&&(yield t),t===this.#a));)t=this.#c[t]}#j(e){return e!==void 0&&this.#n.get(this.#s[e])===e}*entries(){for(const e of this.#L())this.#e[e]!==void 0&&this.#s[e]!==void 0&&!this.#t(this.#e[e])&&(yield[this.#s[e],this.#e[e]])}*rentries(){for(const e of this.#T())this.#e[e]!==void 0&&this.#s[e]!==void 0&&!this.#t(this.#e[e])&&(yield[this.#s[e],this.#e[e]])}*keys(){for(const e of this.#L()){const t=this.#s[e];t!==void 0&&!this.#t(this.#e[e])&&(yield t)}}*rkeys(){for(const e of this.#T()){const t=this.#s[e];t!==void 0&&!this.#t(this.#e[e])&&(yield t)}}*values(){for(const e of this.#L())this.#e[e]!==void 0&&!this.#t(this.#e[e])&&(yield this.#e[e])}*rvalues(){for(const e of this.#T())this.#e[e]!==void 0&&!this.#t(this.#e[e])&&(yield this.#e[e])}[Symbol.iterator](){return this.entries()}[Symbol.toStringTag]="LRUCache";find(e,t={}){for(const s of this.#L()){const n=this.#e[s],a=this.#t(n)?n.__staleWhileFetching:n;if(a!==void 0&&e(a,this.#s[s],this))return this.get(this.#s[s],t)}}forEach(e,t=this){for(const s of this.#L()){const n=this.#e[s],a=this.#t(n)?n.__staleWhileFetching:n;a!==void 0&&e.call(t,a,this.#s[s],this)}}rforEach(e,t=this){for(const s of this.#T()){const n=this.#e[s],a=this.#t(n)?n.__staleWhileFetching:n;a!==void 0&&e.call(t,a,this.#s[s],this)}}purgeStale(){let e=!1;for(const t of this.#T({allowStale:!0}))this.#g(t)&&(this.#E(this.#s[t],"expire"),e=!0);return e}info(e){const t=this.#n.get(e);if(t===void 0)return;const s=this.#e[t],n=this.#t(s)?s.__staleWhileFetching:s;if(n===void 0)return;const a={value:n};if(this.#h&&this.#x){const i=this.#h[t],o=this.#x[t];if(i&&o){const l=i-(be.now()-o);a.ttl=l,a.start=Date.now()}}return this.#b&&(a.size=this.#b[t]),a}dump(){const e=[];for(const t of this.#L({allowStale:!0})){const s=this.#s[t],n=this.#e[t],a=this.#t(n)?n.__staleWhileFetching:n;if(a===void 0||s===void 0)continue;const i={value:a};if(this.#h&&this.#x){i.ttl=this.#h[t];const o=be.now()-this.#x[t];i.start=Math.floor(Date.now()-o)}this.#b&&(i.size=this.#b[t]),e.unshift([s,i])}return e}load(e){this.clear();for(const[t,s]of e){if(s.start){const n=Date.now()-s.start;s.start=be.now()-n}this.set(t,s.value,s)}}set(e,t,s={}){if(t===void 0)return this.delete(e),this;const{ttl:n=this.ttl,start:a,noDisposeOnSet:i=this.noDisposeOnSet,sizeCalculation:o=this.sizeCalculation,status:l}=s;let{noUpdateTTL:c=this.noUpdateTTL}=s;const f=this.#V(e,t,s.size||0,o);if(this.maxEntrySize&&f>this.maxEntrySize)return l&&(l.set="miss",l.maxEntrySizeExceeded=!0),this.#E(e,"set"),this;let u=this.#r===0?void 0:this.#n.get(e);if(u===void 0)u=this.#r===0?this.#a:this.#v.length!==0?this.#v.pop():this.#r===this.#l?this.#k(!1):this.#r,this.#s[u]=e,this.#e[u]=t,this.#n.set(e,u),this.#c[this.#a]=u,this.#f[u]=this.#a,this.#a=u,this.#r++,this.#M(u,f,l),l&&(l.set="add"),c=!1,this.#O&&this.#F?.(t,e,"add");else{this.#I(u);const g=this.#e[u];if(t!==g){if(this.#R&&this.#t(g)){g.__abortController.abort(new Error("replaced"));const{__staleWhileFetching:h}=g;h!==void 0&&!i&&(this.#S&&this.#p?.(h,e,"set"),this.#u&&this.#i?.push([h,e,"set"]))}else i||(this.#S&&this.#p?.(g,e,"set"),this.#u&&this.#i?.push([g,e,"set"]));if(this.#A(u),this.#M(u,f,l),this.#e[u]=t,l){l.set="replace";const h=g&&this.#t(g)?g.__staleWhileFetching:g;h!==void 0&&(l.oldValue=h)}}else l&&(l.set="update");this.#O&&this.onInsert?.(t,e,t===g?"update":"replace")}if(n!==0&&!this.#h&&this.#N(),this.#h&&(c||this.#Q(u,n,a),l&&this.#w(l,u)),!i&&this.#u&&this.#i){const g=this.#i;let h;for(;h=g?.shift();)this.#m?.(...h)}return this}pop(){try{for(;this.#r;){const e=this.#e[this.#o];if(this.#k(!0),this.#t(e)){if(e.__staleWhileFetching)return e.__staleWhileFetching}else if(e!==void 0)return e}}finally{if(this.#u&&this.#i){const e=this.#i;let t;for(;t=e?.shift();)this.#m?.(...t)}}}#k(e){const t=this.#o,s=this.#s[t],n=this.#e[t];return this.#R&&this.#t(n)?n.__abortController.abort(new Error("evicted")):(this.#S||this.#u)&&(this.#S&&this.#p?.(n,s,"evict"),this.#u&&this.#i?.push([n,s,"evict"])),this.#A(t),e&&(this.#s[t]=void 0,this.#e[t]=void 0,this.#v.push(t)),this.#r===1?(this.#o=this.#a=0,this.#v.length=0):this.#o=this.#c[t],this.#n.delete(s),this.#r--,t}has(e,t={}){const{updateAgeOnHas:s=this.updateAgeOnHas,status:n}=t,a=this.#n.get(e);if(a!==void 0){const i=this.#e[a];if(this.#t(i)&&i.__staleWhileFetching===void 0)return!1;if(this.#g(a))n&&(n.has="stale",this.#w(n,a));else return s&&this.#C(a),n&&(n.has="hit",this.#w(n,a)),!0}else n&&(n.has="miss");return!1}peek(e,t={}){const{allowStale:s=this.allowStale}=t,n=this.#n.get(e);if(n===void 0||!s&&this.#g(n))return;const a=this.#e[n];return this.#t(a)?a.__staleWhileFetching:a}#U(e,t,s,n){const a=t===void 0?void 0:this.#e[t];if(this.#t(a))return a;const i=new De,{signal:o}=s;o?.addEventListener("abort",()=>i.abort(o.reason),{signal:i.signal});const l={signal:i.signal,options:s,context:n},c=(y,x=!1)=>{const{aborted:b}=i.signal,E=s.ignoreFetchAbort&&y!==void 0;if(s.status&&(b&&!x?(s.status.fetchAborted=!0,s.status.fetchError=i.signal.reason,E&&(s.status.fetchAbortIgnored=!0)):s.status.fetchResolved=!0),b&&!E&&!x)return u(i.signal.reason);const k=h;return this.#e[t]===h&&(y===void 0?k.__staleWhileFetching?this.#e[t]=k.__staleWhileFetching:this.#E(e,"fetch"):(s.status&&(s.status.fetchUpdated=!0),this.set(e,y,l.options))),y},f=y=>(s.status&&(s.status.fetchRejected=!0,s.status.fetchError=y),u(y)),u=y=>{const{aborted:x}=i.signal,b=x&&s.allowStaleOnFetchAbort,E=b||s.allowStaleOnFetchRejection,k=E||s.noDeleteOnFetchRejection,A=h;if(this.#e[t]===h&&(!k||A.__staleWhileFetching===void 0?this.#E(e,"fetch"):b||(this.#e[t]=A.__staleWhileFetching)),E)return s.status&&A.__staleWhileFetching!==void 0&&(s.status.returnedStale=!0),A.__staleWhileFetching;if(A.__returned===A)throw y},g=(y,x)=>{const b=this.#D?.(e,a,l);b&&b instanceof Promise&&b.then(E=>y(E===void 0?void 0:E),x),i.signal.addEventListener("abort",()=>{(!s.ignoreFetchAbort||s.allowStaleOnFetchAbort)&&(y(void 0),s.allowStaleOnFetchAbort&&(y=E=>c(E,!0)))})};s.status&&(s.status.fetchDispatched=!0);const h=new Promise(g).then(c,f),m=Object.assign(h,{__abortController:i,__staleWhileFetching:a,__returned:void 0});return t===void 0?(this.set(e,m,{...l.options,status:void 0}),t=this.#n.get(e)):this.#e[t]=m,m}#t(e){if(!this.#R)return!1;const t=e;return!!t&&t instanceof Promise&&t.hasOwnProperty("__staleWhileFetching")&&t.__abortController instanceof De}async fetch(e,t={}){const{allowStale:s=this.allowStale,updateAgeOnGet:n=this.updateAgeOnGet,noDeleteOnStaleGet:a=this.noDeleteOnStaleGet,ttl:i=this.ttl,noDisposeOnSet:o=this.noDisposeOnSet,size:l=0,sizeCalculation:c=this.sizeCalculation,noUpdateTTL:f=this.noUpdateTTL,noDeleteOnFetchRejection:u=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:g=this.allowStaleOnFetchRejection,ignoreFetchAbort:h=this.ignoreFetchAbort,allowStaleOnFetchAbort:m=this.allowStaleOnFetchAbort,context:y,forceRefresh:x=!1,status:b,signal:E}=t;if(!this.#R)return b&&(b.fetch="get"),this.get(e,{allowStale:s,updateAgeOnGet:n,noDeleteOnStaleGet:a,status:b});const k={allowStale:s,updateAgeOnGet:n,noDeleteOnStaleGet:a,ttl:i,noDisposeOnSet:o,size:l,sizeCalculation:c,noUpdateTTL:f,noDeleteOnFetchRejection:u,allowStaleOnFetchRejection:g,allowStaleOnFetchAbort:m,ignoreFetchAbort:h,status:b,signal:E};let A=this.#n.get(e);if(A===void 0){b&&(b.fetch="miss");const j=this.#U(e,A,k,y);return j.__returned=j}else{const j=this.#e[A];if(this.#t(j)){const H=s&&j.__staleWhileFetching!==void 0;return b&&(b.fetch="inflight",H&&(b.returnedStale=!0)),H?j.__staleWhileFetching:j.__returned=j}const $=this.#g(A);if(!x&&!$)return b&&(b.fetch="hit"),this.#I(A),n&&this.#C(A),b&&this.#w(b,A),j;const B=this.#U(e,A,k,y),W=B.__staleWhileFetching!==void 0&&s;return b&&(b.fetch=$?"stale":"refresh",W&&$&&(b.returnedStale=!0)),W?B.__staleWhileFetching:B.__returned=B}}async forceFetch(e,t={}){const s=await this.fetch(e,t);if(s===void 0)throw new Error("fetch() returned undefined");return s}memo(e,t={}){const s=this.#P;if(!s)throw new Error("no memoMethod provided to constructor");const{context:n,forceRefresh:a,...i}=t,o=this.get(e,i);if(!a&&o!==void 0)return o;const l=s(e,o,{options:i,context:n});return this.set(e,l,i),l}get(e,t={}){const{allowStale:s=this.allowStale,updateAgeOnGet:n=this.updateAgeOnGet,noDeleteOnStaleGet:a=this.noDeleteOnStaleGet,status:i}=t,o=this.#n.get(e);if(o!==void 0){const l=this.#e[o],c=this.#t(l);return i&&this.#w(i,o),this.#g(o)?(i&&(i.get="stale"),c?(i&&s&&l.__staleWhileFetching!==void 0&&(i.returnedStale=!0),s?l.__staleWhileFetching:void 0):(a||this.#E(e,"expire"),i&&s&&(i.returnedStale=!0),s?l:void 0)):(i&&(i.get="hit"),c?l.__staleWhileFetching:(this.#I(o),n&&this.#C(o),l))}else i&&(i.get="miss")}#B(e,t){this.#f[t]=e,this.#c[e]=t}#I(e){e!==this.#a&&(e===this.#o?this.#o=this.#c[e]:this.#B(this.#f[e],this.#c[e]),this.#B(this.#a,e),this.#a=e)}delete(e){return this.#E(e,"delete")}#E(e,t){let s=!1;if(this.#r!==0){const n=this.#n.get(e);if(n!==void 0)if(s=!0,this.#r===1)this.#$(t);else{this.#A(n);const a=this.#e[n];if(this.#t(a)?a.__abortController.abort(new Error("deleted")):(this.#S||this.#u)&&(this.#S&&this.#p?.(a,e,t),this.#u&&this.#i?.push([a,e,t])),this.#n.delete(e),this.#s[n]=void 0,this.#e[n]=void 0,n===this.#a)this.#a=this.#f[n];else if(n===this.#o)this.#o=this.#c[n];else{const i=this.#f[n];this.#c[i]=this.#c[n];const o=this.#c[n];this.#f[o]=this.#f[n]}this.#r--,this.#v.push(n)}}if(this.#u&&this.#i?.length){const n=this.#i;let a;for(;a=n?.shift();)this.#m?.(...a)}return s}clear(){return this.#$("delete")}#$(e){for(const t of this.#T({allowStale:!0})){const s=this.#e[t];if(this.#t(s))s.__abortController.abort(new Error("deleted"));else{const n=this.#s[t];this.#S&&this.#p?.(s,n,e),this.#u&&this.#i?.push([s,n,e])}}if(this.#n.clear(),this.#e.fill(void 0),this.#s.fill(void 0),this.#h&&this.#x&&(this.#h.fill(0),this.#x.fill(0)),this.#b&&this.#b.fill(0),this.#o=0,this.#a=0,this.#v.length=0,this.#y=0,this.#r=0,this.#u&&this.#i){const t=this.#i;let s;for(;s=t?.shift();)this.#m?.(...s)}}}var Ys=d(94644),Xs=d(22592),Z=d(22420),Zs=d(32783),L=d(12282);const qs=1e6,Oe="{}",en=["__aggregated_metric__","__tenant_id__","__stream_shard__"];class tn extends Ys.Is{constructor(e){super(),this.started=!1,this.seriesCache=new ye({max:10}),this.labelsCache=new ye({max:10}),this.detectedFieldValuesCache=new ye({max:10}),this.labelsPromisesCache=new ye({max:10}),this.detectedLabelValuesPromisesCache=new ye({max:10}),this.request=async(t,s,n,a)=>{try{return await this.datasource.metadataRequest(t,s,a)}catch(i){if(n)throw i;console.error(i)}},this.start=t=>{const s=t??this.getDefaultTimeRange(),n=this.datasource.getTimeRangeParams(s),a=this.startedTimeRange?this.datasource.getTimeRangeParams(this.startedTimeRange):null;return(!this.startTask||!a||n.start!==a.start||n.end!==a.end)&&(this.startedTimeRange=s,this.startTask=this.fetchLabels({timeRange:s}).then(()=>(this.started=!0,[]))),this.startTask},this.fetchSeriesLabels=async(t,s)=>{const n=this.datasource.interpolateString(t),a="series",i=s?.timeRange??this.getDefaultTimeRange(),{start:o,end:l}=this.datasource.getTimeRangeParams(i),c=this.generateCacheKey(a,o,l,n);let f=this.seriesCache.get(c);if(!f){const u={"match[]":n,start:o,end:l},g=await this.request(a,u);if(!Array.isArray(g))return{};const{values:h}=(0,Z.P7)(g);f=h,this.seriesCache.set(c,f)}return f},this.fetchSeries=async(t,s)=>{const n="series",a=s?.timeRange??this.getDefaultTimeRange(),{start:i,end:o}=this.datasource.getTimeRangeParams(a),l={"match[]":t,start:i,end:o};return await this.request(n,l)},this.datasource=e,this.labelKeys=[]}getLabelKeys(){return this.labelKeys}importFromAbstractQuery(e){return{refId:e.refId,expr:(0,Z.tt)(e),queryType:L.U3.Range}}exportToAbstractQuery(e){if(!e.expr||e.expr.length===0)return{refId:e.refId,labelMatchers:[]};const s=(0,w.pk)(e.expr).map(n=>(0,Zs.u_)(n).query.labels.map(o=>({name:o.label,value:o.value,operator:Z.sM[o.op]})));return{refId:e.refId,labelMatchers:(0,D.flatten)(s)}}async fetchLabels(e){if(I.$.featureToggles.lokiLabelNamesQueryApi||!e?.streamSelector)return this.fetchLabelsByLabelsEndpoint(e);{const t=await this.fetchSeriesLabels(e.streamSelector,{timeRange:e.timeRange});return Object.keys(t??{})}}async fetchLabelsByLabelsEndpoint(e){const t="labels",s=e?.timeRange??this.getDefaultTimeRange(),{start:n,end:a}=this.datasource.getTimeRangeParams(s),i={start:n,end:a};e?.streamSelector&&e?.streamSelector!==Oe&&(i.query=e.streamSelector);const o=await this.request(t,i);if(Array.isArray(o)){const l=Array.from(new Set(o)).slice().sort().filter(c=>en.includes(c)===!1);return this.labelKeys=l,this.labelKeys}return[]}generateCacheKey(e,t,s,n){return[e,this.roundTime(t),this.roundTime(s),n].join()}roundTime(e){return e?Math.floor(e/qs/1e3/60/5):0}async fetchDetectedFields(e,t){const s=e.expr&&e.expr!==Oe?this.datasource.interpolateString(e.expr,e.scopedVars):void 0;if(!s)throw new Error("fetchDetectedFields requires query expression");const n="detected_fields",a=e?.timeRange??this.getDefaultTimeRange(),i=this.datasource.getTimeRangeParams(a),{start:o,end:l}=i,c={start:o,end:l,limit:e?.limit??1e3};return c.query=s,new Promise(async(f,u)=>{try{const g=await this.request(n,c,!0,t);f(g)}catch(g){console.error("error",g),u(g)}})}async fetchDetectedFieldValues(e,t,s){return this.fetchDetectedLabelValues(e,t,s)}async fetchDetectedLabelValues(e,t,s){const n=encodeURIComponent(this.datasource.interpolateString(e)),a=t?.expr&&t.expr!==Oe?this.datasource.interpolateString(t.expr,t.scopedVars):void 0,i=`detected_field/${n}/values`,o=t?.timeRange??this.getDefaultTimeRange(),l=this.datasource.getTimeRangeParams(o),{start:c,end:f}=l,u={start:c,end:f,limit:t?.limit??1e3};let g=n;a&&(u.query=a,g+=a);const h=this.generateCacheKey(i,c,f,g),m=this.detectedFieldValuesCache.get(h);if(m)return m;let y=this.detectedLabelValuesPromisesCache.get(h);return y||(y=new Promise(async(x,b)=>{try{const E=await this.request(i,u,t?.throwError,s);if(Array.isArray(E)){const k=E.slice().sort();this.detectedFieldValuesCache.set(h,k),this.detectedLabelValuesPromisesCache.delete(h),x(k)}}catch(E){t?.throwError?b(E):(console.error(E),x([]))}}),this.detectedLabelValuesPromisesCache.set(h,y),y)}async fetchLabelValues(e,t){const s=encodeURIComponent(this.datasource.interpolateString(e)),n=t?.streamSelector&&t.streamSelector!==Oe?this.datasource.interpolateString(t.streamSelector):void 0,a=`label/${s}/values`,i=t?.timeRange??this.getDefaultTimeRange(),o=this.datasource.getTimeRangeParams(i),{start:l,end:c}=o,f={start:l,end:c};let u=s;n&&(f.query=n,u+=n);const g=this.generateCacheKey(a,l,c,u),h=this.labelsCache.get(g);if(h)return h;let m=this.labelsPromisesCache.get(g);return m||(m=new Promise(async y=>{try{const x=await this.request(a,f);if(Array.isArray(x)){const b=x.slice().sort();this.labelsCache.set(g,b),this.labelsPromisesCache.delete(g),y(b)}}catch(x){console.error(x),y([])}}),this.labelsPromisesCache.set(g,m),m)}async getParserAndLabelKeys(e,t){const s={extractedLabelKeys:[],structuredMetadataKeys:[],unwrapLabelKeys:[],hasJSON:!1,hasLogfmt:!1,hasPack:!1},n=await this.datasource.getDataSamples({expr:e,refId:"data-samples",maxLines:t?.maxLines||os},t?.timeRange??this.getDefaultTimeRange());if(!n.length)return s;const{hasLogfmt:a,hasJSON:i,hasPack:o}=(0,ie.YB)(n[0]);return{extractedLabelKeys:[...(0,ie.fV)(n[0],L.HD.Indexed),...(0,ie.fV)(n[0],L.HD.Parsed)],structuredMetadataKeys:(0,ie.fV)(n[0],L.HD.StructuredMetadata),unwrapLabelKeys:(0,ie.aN)(n[0]),hasJSON:i,hasPack:o,hasLogfmt:a}}getDefaultTimeRange(){return(0,Xs.E2)()}}var sn=d(39697),nn=d(37748),zt=d(69862),rn=d(69850),Wt=d(31635),Ke=d(13752),an=d(75508),on=d(64423),He=d(39741),ln={url:"",deserializer:function(r){return JSON.parse(r.data)},serializer:function(r){return JSON.stringify(r)}},cn="WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }",un=function(r){(0,Wt.__extends)(e,r);function e(t,s){var n=r.call(this)||this;if(n._socket=null,t instanceof Ie.c)n.destination=s,n.source=t;else{var a=n._config=(0,Wt.__assign)({},ln);if(n._output=new Ke.B,typeof t=="string")a.url=t;else for(var i in t)t.hasOwnProperty(i)&&(a[i]=t[i]);if(!a.WebSocketCtor&&WebSocket)a.WebSocketCtor=WebSocket;else if(!a.WebSocketCtor)throw new Error("no WebSocket constructor can be found");n.destination=new He.m}return n}return e.prototype.lift=function(t){var s=new e(this._config,this.destination);return s.operator=t,s.source=this,s},e.prototype._resetState=function(){this._socket=null,this.source||(this.destination=new He.m),this._output=new Ke.B},e.prototype.multiplex=function(t,s,n){var a=this;return new Ie.c(function(i){try{a.next(t())}catch(l){i.error(l)}var o=a.subscribe({next:function(l){try{n(l)&&i.next(l)}catch(c){i.error(c)}},error:function(l){return i.error(l)},complete:function(){return i.complete()}});return function(){try{a.next(s())}catch(l){i.error(l)}o.unsubscribe()}})},e.prototype._connectSocket=function(){var t=this,s=this._config,n=s.WebSocketCtor,a=s.protocol,i=s.url,o=s.binaryType,l=this._output,c=null;try{c=a?new n(i,a):new n(i),this._socket=c,o&&(this._socket.binaryType=o)}catch(u){l.error(u);return}var f=new on.yU(function(){t._socket=null,c&&c.readyState===1&&c.close()});c.onopen=function(u){var g=t._socket;if(!g){c.close(),t._resetState();return}var h=t._config.openObserver;h&&h.next(u);var m=t.destination;t.destination=an.vU.create(function(y){if(c.readyState===1)try{var x=t._config.serializer;c.send(x(y))}catch(b){t.destination.error(b)}},function(y){var x=t._config.closingObserver;x&&x.next(void 0),y&&y.code?c.close(y.code,y.reason):l.error(new TypeError(cn)),t._resetState()},function(){var y=t._config.closingObserver;y&&y.next(void 0),c.close(),t._resetState()}),m&&m instanceof He.m&&f.add(m.subscribe(t.destination))},c.onerror=function(u){t._resetState(),l.error(u)},c.onclose=function(u){c===t._socket&&t._resetState();var g=t._config.closeObserver;g&&g.next(u),u.wasClean?l.complete():l.error(u)},c.onmessage=function(u){try{var g=t._config.deserializer;l.next(g(u))}catch(h){l.error(h)}}},e.prototype._subscribe=function(t){var s=this,n=this.source;return n?n.subscribe(t):(this._socket||this._connectSocket(),this._output.subscribe(t),t.add(function(){var a=s._socket;s._output.observers.length===0&&(a&&(a.readyState===1||a.readyState===0)&&a.close(),s._resetState())}),t)},e.prototype.unsubscribe=function(){var t=this._socket;t&&(t.readyState===1||t.readyState===0)&&t.close(),this._resetState(),r.prototype.unsubscribe.call(this)},e}(Ke.k);function dn(r){return new un(r)}var fn=d(35479);function hn(r,e,t,s){switch(r){case 0:return e&t^~e&s;case 1:return e^t^s;case 2:return e&t^e&s^t&s;case 3:return e^t^s}}function Ge(r,e){return r<<e|r>>>32-e}function gn(r){const e=[1518500249,1859775393,2400959708,3395469782],t=[1732584193,4023233417,2562383102,271733878,3285377520],s=new Uint8Array(r.length+1);s.set(r),s[r.length]=128,r=s;const n=r.length/4+2,a=Math.ceil(n/16),i=new Array(a);for(let o=0;o<a;++o){const l=new Uint32Array(16);for(let c=0;c<16;++c)l[c]=r[o*64+c*4]<<24|r[o*64+c*4+1]<<16|r[o*64+c*4+2]<<8|r[o*64+c*4+3];i[o]=l}i[a-1][14]=(r.length-1)*8/Math.pow(2,32),i[a-1][14]=Math.floor(i[a-1][14]),i[a-1][15]=(r.length-1)*8&4294967295;for(let o=0;o<a;++o){const l=new Uint32Array(80);for(let m=0;m<16;++m)l[m]=i[o][m];for(let m=16;m<80;++m)l[m]=Ge(l[m-3]^l[m-8]^l[m-14]^l[m-16],1);let c=t[0],f=t[1],u=t[2],g=t[3],h=t[4];for(let m=0;m<80;++m){const y=Math.floor(m/20),x=Ge(c,5)+hn(y,f,u,g)+h+e[y]+l[m]>>>0;h=g,g=u,u=Ge(f,30)>>>0,f=c,c=x}t[0]=t[0]+c>>>0,t[1]=t[1]+f>>>0,t[2]=t[2]+u>>>0,t[3]=t[3]+g>>>0,t[4]=t[4]+h>>>0}return Uint8Array.of(t[0]>>24,t[0]>>16,t[0]>>8,t[0],t[1]>>24,t[1]>>16,t[1]>>8,t[1],t[2]>>24,t[2]>>16,t[2]>>8,t[2],t[3]>>24,t[3]>>16,t[3]>>8,t[3],t[4]>>24,t[4]>>16,t[4]>>8,t[4])}const pn=gn;var mn=d(41391);function yn(r){if(!(0,mn.A)(r))throw TypeError("Invalid UUID");let e;return Uint8Array.of((e=parseInt(r.slice(0,8),16))>>>24,e>>>16&255,e>>>8&255,e&255,(e=parseInt(r.slice(9,13),16))>>>8,e&255,(e=parseInt(r.slice(14,18),16))>>>8,e&255,(e=parseInt(r.slice(19,23),16))>>>8,e&255,(e=parseInt(r.slice(24,36),16))/1099511627776&255,e/4294967296&255,e>>>24&255,e>>>16&255,e>>>8&255,e&255)}const Kt=yn;var vn=d(71060);function bn(r){r=unescape(encodeURIComponent(r));const e=new Uint8Array(r.length);for(let t=0;t<r.length;++t)e[t]=r.charCodeAt(t);return e}const xn="6ba7b810-9dad-11d1-80b4-00c04fd430c8",Sn="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function Ln(r,e,t,s,n,a){const i=typeof t=="string"?bn(t):t,o=typeof s=="string"?Kt(s):s;if(typeof s=="string"&&(s=Kt(s)),s?.length!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let l=new Uint8Array(16+i.length);if(l.set(o),l.set(i,o.length),l=e(l),l[6]=l[6]&15|r,l[8]=l[8]&63|128,n){a=a||0;for(let c=0;c<16;++c)n[a+c]=l[c];return n}return(0,vn.k)(l)}function Je(r,e,t,s){return Ln(80,pn,r,e,t,s)}Je.DNS=xn,Je.URL=Sn;const Tn=Je,En="6ec946da-0f49-47a8-983a-1d76d17e7c92";function wn(r,e){const t=r.streams;if(!t||!t.length)return;const s=e.fields[0],n=e.fields[1],a=e.fields[2],i={};for(const o of t){const l=Object.entries(o.stream).map(([c,f])=>`${c}="${f}"`).sort().join("");for(const[c,f]of o.values)s.values.push(new Date(parseInt(c.slice(0,-6),10)).toISOString()),n.values.push(f),a.values.push(Rn(c,l,f,i,e.refId))}}function Rn(r,e,t,s,n){let a=Tn(`${r}_${e}_${t}`,En);if(a in s){const i=s[a]+1;s[a]=i,a=`${a}_${i}`}else s[a]=0;return n?`${n}_${a}`:a}class Fn{constructor(){this.streams={}}getStream(e,t=5e3){let s=this.streams[e.url];if(s)return s;const n=new fn.x({capacity:e.size});return n.addField({name:"Time",type:_.PU.time,config:{}}),n.addField({name:"Line",type:_.PU.string}),n.addField({name:"id",type:_.PU.string}),n.meta={...n.meta,preferredVisualisationType:"logs"},n.refId=e.refId,s=dn(e.url).pipe((0,Te.T)(a=>(wn(a,n),[n])),(0,nn.l)(a=>a.pipe((0,zt.Z)((i,o)=>{const l=o+1;return i.code===1006&&l<30?(l>10&&console.warn(`Websocket connection is being disrupted. We keep reconnecting but consider starting new live tailing again. Error: ${i.reason}`),(0,sn.O)(t)):(0,kt.$)(i)}))),(0,rn.j)(()=>{delete this.streams[e.url]})),this.streams[e.url]=s,s}}var Cn=d(10279),Ht=d(16817),An=d(67458),In=d(54078),Dn=d(34999),Pn=d(45861),On=d(89599),Mn=d(45967),kn=d(30703),Un=d(68079),Gt=d(72636),Me=d(18857),Ye=d(97095),Ee=d(18027),Nn=d(70663),Qn=d(21285),Vn=d(77236);function jn(r){return{labels:(0,R.css)({display:"flex",gap:r.spacing(.5)}),wrapper:(0,R.css)({display:"flex",flexDirection:"column",flex:1,gap:r.spacing(.5),position:"relative"}),textWrapper:(0,R.css)({display:"flex",alignItems:"center"}),hidden:(0,R.css)({visibility:"hidden"}),label:(0,R.css)({maxWidth:"100%","&:first-of-type":{marginBottom:r.spacing(2)},"&:not(:first-of-type)":{margin:r.spacing(2,0)}}),rawQueryContainer:(0,R.css)({textAlign:"start",lineBreak:"anywhere",marginTop:r.spacing(-.25),marginRight:r.spacing(6),minHeight:r.spacing(4)}),ui:(0,R.css)({backgroundColor:r.colors.background.secondary,padding:r.spacing(2)}),notification:(0,R.css)({position:"absolute",zIndex:r.zIndex.portal,top:0,right:0}),rawQuery:(0,R.css)({display:"inline"}),queryDescription:(0,R.css)({marginLeft:r.spacing(.5)}),iconButton:(0,R.css)({position:"absolute",top:r.spacing(1),right:r.spacing(1),zIndex:r.zIndex.navbarFixed}),operationsToggle:(0,R.css)({margin:r.spacing(1,0,-1,0),"& > div":{margin:0,"& > label":{padding:0}}})}}const Jt="isLogContextQueryUiOpen";function Bn(r){const{row:e,logContextProvider:t,updateFilter:s,onClose:n,origQuery:a,runContextQuery:i}=r,o=(0,Dt.of)(jn),[l,c]=(0,v.useState)([]),[f,u]=(0,v.useState)(!1),[g,h]=(0,v.useState)(!1),[m,y]=(0,v.useState)(!1),[x,b]=(0,v.useState)(window.localStorage.getItem(Jt)==="true"),[E,k]=(0,v.useState)(window.localStorage.getItem(ke)==="true"),A=(0,v.useRef)(),j=(0,v.useRef)(!1),$=(0,v.useRef)([]),B=(0,v.useMemo)(()=>!(g&&l.some(C=>C.nonIndexed===C.enabled)||E&&t.queryContainsValidPipelineStages(a)),[l,E,g,t,a]);(0,v.useEffect)(()=>{if(g){if(!j.current){j.current=g;return}if(l.filter(({enabled:C,nonIndexed:G})=>C&&!G).length===0){c($.current);return}return $.current=structuredClone(l),A.current&&clearTimeout(A.current),y(!0),A.current=window.setTimeout(()=>{s(l.filter(({enabled:G})=>G));const C={removedLabels:[],selectedExtractedLabels:[]};l.forEach(({enabled:G,nonIndexed:U,label:re})=>{!G&&!U&&C.removedLabels.push(re),G&&U&&C.selectedExtractedLabels.push(re)}),window.localStorage.setItem(Xe,JSON.stringify(C)),y(!1)},1500),()=>{clearTimeout(A.current)}}},[l,g]),(0,v.useEffect)(()=>()=>{clearTimeout(A.current),n()},[n]),(0,Ht.A)(async()=>{y(!0);const C=await t.getInitContextFilters(e,a,{from:(0,J.KQ)(e.timeEpochMs),to:(0,J.KQ)(e.timeEpochMs),raw:{from:(0,J.KQ)(e.timeEpochMs),to:(0,J.KQ)(e.timeEpochMs)}});c(C.contextFilters),u(C.preservedFiltersApplied),h(!0),y(!1)}),(0,v.useEffect)(()=>{f&&setTimeout(()=>{u(!1)},2e3)},[f]),(0,v.useEffect)(()=>((0,ce.rR)("grafana_explore_logs_loki_log_context_loaded",{logRowUid:e.uid,type:"load"}),()=>{(0,ce.rR)("grafana_explore_logs_loki_log_context_loaded",{logRowUid:e.uid,type:"unload"})}),[e.uid]);const F=l.filter(({nonIndexed:C})=>!C),W=F.filter(({enabled:C})=>C),H=l.filter(({nonIndexed:C})=>C),he=H.filter(({enabled:C})=>C),Se=(0,v.useCallback)(C=>({label:`${C.label}="${(0,Z.Bb)(C.value)}"`,value:C.label}),[]),gt=H.length>0;let oe=t.prepareExpression(l.filter(({enabled:C})=>C),a);return(0,p.jsxs)("div",{className:o.wrapper,children:[f&&(0,p.jsx)(Dn.F,{className:o.notification,title:"Previously used filters have been applied.",severity:"info",elevated:!0}),(0,p.jsx)("div",{className:o.iconButton,children:(0,p.jsx)(Pn.$n,{tooltip:"Revert to initial log context query","data-testid":"revert-button",icon:"history-alt",variant:"secondary",disabled:B,onClick:C=>{(0,ce.rR)("grafana_explore_logs_loki_log_context_reverted",{logRowUid:e.uid}),c(G=>G.map(U=>({...U,enabled:!U.nonIndexed}))),window.localStorage.removeItem(Xe),window.localStorage.removeItem(ke),k(!1)}})}),(0,p.jsx)(On.S,{collapsible:!0,isOpen:x,onToggle:()=>{window.localStorage.setItem(Jt,(!x).toString()),b(C=>!C),(0,ce.rR)("grafana_explore_logs_loki_log_context_toggled",{logRowUid:e.uid,action:x?"close":"open"})},label:(0,p.jsx)("div",{className:o.rawQueryContainer,children:g?(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)(In.Z,{language:{grammar:Vn.vB,name:"loki"},query:oe,className:o.rawQuery}),(0,p.jsx)(Mn.m,{content:"The initial log context query is created from all labels defining the stream for the selected log line. Use the editor below to customize the log context query.",children:(0,p.jsx)(kn.I,{name:"info-circle",size:"sm",className:o.queryDescription})})]}):(0,p.jsx)(Un.y,{})}),children:(0,p.jsxs)("div",{className:o.ui,children:[(0,p.jsx)(Gt.J,{className:o.label,description:"The initial log context query is created from all labels defining the stream for the selected log line. You can broaden your search by removing one or more of the label filters.",children:"Widen the search"}),(0,p.jsx)(Me.KF,{isLoading:m,options:F.map(Se),value:W.map(Se),closeMenuOnSelect:!0,maxMenuHeight:200,noOptionsMessage:"No further labels available",onChange:(C,G)=>(G.action==="select-option"&&(0,ce.rR)("grafana_explore_logs_loki_log_context_filtered",{logRowUid:e.uid,type:"label",action:"select"}),G.action==="remove-value"&&(0,ce.rR)("grafana_explore_logs_loki_log_context_filtered",{logRowUid:e.uid,type:"label",action:"remove"}),c(l.map(U=>(U.nonIndexed||(U.enabled=C.some(re=>re.value===U.label)),U))))}),gt&&(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)(Gt.J,{className:o.label,description:"By using a parser in your original query, you can use filters for extracted labels. Refine your search by applying extracted labels created from the selected log line.",children:"Refine the search"}),(0,p.jsx)(Me.KF,{isLoading:m,options:H.map(Se),value:he.map(Se),closeMenuOnSelect:!0,maxMenuHeight:200,noOptionsMessage:"No further labels available",isClearable:!0,onChange:(C,G)=>{G.action==="select-option"&&(0,ce.rR)("grafana_explore_logs_loki_log_context_filtered",{logRowUid:e.uid,type:"parsed_label",action:"select"}),G.action==="remove-value"&&(0,ce.rR)("grafana_explore_logs_loki_log_context_filtered",{logRowUid:e.uid,type:"parsed_label",action:"remove"}),c(l.map(U=>(U.nonIndexed&&(U.enabled=C.some(re=>re.value===U.label)),U)))}})]}),t.queryContainsValidPipelineStages(a)&&(0,p.jsx)(Ye.C,{className:o.operationsToggle,children:(0,p.jsx)(Ee.I,{label:"Include LogQL pipeline operations",tooltip:(0,p.jsx)(Nn.I,{content:(0,An.G)("This will include LogQL operations such as `line_format` or `label_format`. It won't include line or label filter operations.")}),children:(0,p.jsx)(Qn.K,{value:E,showLabel:!0,transparent:!0,onChange:C=>{(0,ce.rR)("grafana_explore_logs_loki_log_context_pipeline_toggled",{logRowUid:e.uid,action:C.currentTarget.checked?"enable":"disable"}),window.localStorage.setItem(ke,C.currentTarget.checked.toString()),k(C.currentTarget.checked),i&&i()}})})})]})})]})}var V=d(76160),Yt=(r=>(r[r.Ascending=0]="Ascending",r[r.Descending=1]="Descending",r))(Yt||{});function $n(r,e){const t=r.values,{nanos:s}=r,n=Array(t.length);for(let i=0;i<n.length;i++)n[i]=i;const a=e===0;return n.sort((i,o)=>{const l=t[i],c=t[o];if(l<c)return a?-1:1;if(l>c)return a?1:-1;if(s===void 0)return 0;const f=s[i],u=s[o];return f<u?a?-1:1:f>u?a?1:-1:0}),n}function _n(r,e){const{fields:t,...s}=r,n=t.find(i=>i.type===_.PU.time);if(n===void 0)throw new Error("missing timestamp field. should never happen");const a=$n(n,e);return{...s,fields:t.map(i=>({...i,values:Xt(i.values,a),nanos:i.nanos===void 0?void 0:Xt(i.nanos,a)}))}}function Xt(r,e){return r.map((t,s)=>r[e[s]])}const Xe="lokiLogContextPreservedLabels",ke="lokiLogContextShouldIncludePipelineOperations";class zn{constructor(e){this.getLogRowContextQuery=async(t,s,n,a=!0)=>{n&&s?.scopedVars&&(n=this.datasource.applyTemplateVariables(n,s?.scopedVars));const{query:i}=await this.getQueryAndRange(t,s,n,a);return a||(this.cachedContextFilters=[]),i},this.getLogRowContext=async(t,s,n)=>{n&&s?.scopedVars&&(n=this.datasource.applyTemplateVariables(n,s?.scopedVars));const a=s&&s.direction||P.ZF.Backward,{query:i,range:o}=await this.getQueryAndRange(t,s,n),l=f=>{const g=f.data.map(h=>_n(h,Yt.Descending));return{...f,data:g}},c=M.Jk.Explore;return(0,Y.s)(this.datasource.query(st(i,o,c,`${tt}${a}`)).pipe((0,Nt.W)(f=>{throw{message:"Error during context query. Please check JS console logs.",status:f.status,statusText:f.statusText}}),(0,Qt.n)(f=>(0,ze.of)(l(f)))))},this.processContextFiltersToExpr=(t,s)=>{let a=`{${t.map(i=>!i.nonIndexed&&i.enabled?`${i.label}="${(0,Z.Qn)(i.value)}"`:"").filter(i=>!!i).join(",")}}`;if(s){let i=!1;if((0,w.MX)(s.expr).parserCount===1){i=!0;const l=(0,w.aw)(s.expr);l&&(a=(0,V.aH)(a,l))}const o=t.filter(l=>l.nonIndexed&&l.enabled);for(const l of o)l.enabled&&(a=(0,V.tE)(a,l.label,"=",l.value,i?L.HD.Parsed:L.HD.StructuredMetadata))}return a},this.processPipelineStagesToExpr=(t,s)=>{let n=t;const a=s?.expr??"";if((0,w.MX)(a).parserCount>1)return n;const i=(0,w.TQ)(a,[ee.t3,ee.iT,ee.c$,ee.LM,ee.CX,ee.bY]),o=i.filter(c=>c.type?.id===ee.t3),l=i.filter(c=>c.type?.id!==ee.t3);for(const c of o)l.some(f=>c.contains(f))||(n+=` ${c.getExpression(a)}`);return n},this.queryContainsValidPipelineStages=t=>{const s=t?.expr??"",n=(0,w.TQ)(s,[ee.t3,ee.iT,ee.CX,ee.bY]),a=n.filter(o=>o.type?.id===ee.t3),i=n.filter(o=>o.type?.id!==ee.t3);return a.some(o=>i.every(l=>o.contains(l)===!1))},this.getInitContextFilters=async(t,s,n)=>{let a=!1;if(!s||(0,D.isEmpty)(t.labels))return{contextFilters:[],preservedFiltersApplied:a};const i=t.labels;let o=[];if(!(0,w.MX)(s.expr).queryWithParser)await this.datasource.languageProvider.start(n),o=this.datasource.languageProvider.getLabelKeys();else{const u=(0,w.pk)(s.expr);o=await this.datasource.languageProvider.fetchLabels({streamSelector:u[0],timeRange:n})}const l=[];Object.entries(i).forEach(([u,g])=>{const h=(0,Z.Ed)(u,t.dataFrame,t.rowIndex),m={label:u,value:g,enabled:o.includes(u),nonIndexed:h!==null&&h!==L.HD.Indexed};l.push(m)});let c;const f=window.localStorage.getItem(Xe);if(f)try{c=JSON.parse(f)}catch{}if(c){let u=!1;const g=l.map(m=>c.removedLabels.includes(m.label)?(u=!0,{...m,enabled:!1}):c.selectedExtractedLabels.includes(m.label)?(u=!0,{...m,enabled:!0}):{...m});return g.some(({enabled:m,nonIndexed:y})=>m&&!y)?(u&&(a=!0),{contextFilters:g,preservedFiltersApplied:a}):{contextFilters:l,preservedFiltersApplied:a}}else return{contextFilters:l,preservedFiltersApplied:a}},this.datasource=e,this.cachedContextFilters=[]}async getQueryAndRange(e,t,s,n=!0){const a=t&&t.direction||P.ZF.Backward,i=t&&t.limit||this.datasource.maxLines;if(this.cachedContextFilters.length===0||!n){const o=(await this.getInitContextFilters(e,s,{from:(0,J.KQ)(e.timeEpochMs),to:(0,J.KQ)(e.timeEpochMs),raw:{from:(0,J.KQ)(e.timeEpochMs),to:(0,J.KQ)(e.timeEpochMs)}})).contextFilters.filter(l=>l.enabled);this.cachedContextFilters=o}return await this.prepareLogRowContextQueryTarget(e,i,a,s,t?.timeWindowMs)}async prepareLogRowContextQueryTarget(e,t,s,n,a=7200*1e3){const i=this.prepareExpression(this.cachedContextFilters,n),o=s===P.ZF.Forward?L.ti.Forward:L.ti.Backward,l={expr:i,queryType:L.U3.Range,refId:`${tt}_${Math.random().toString()}`,maxLines:t,direction:o,datasource:{uid:this.datasource.uid,type:this.datasource.type}},f=new Cn.L(e.dataFrame).getFirstFieldOfType(_.PU.time);if(f===void 0)throw new Error("loki: data frame missing time-field, should never happen");const u=f.values[e.rowIndex],g=(0,J.yT)(u),h=o===L.ti.Forward?{from:g,to:(0,J.yT)(e.timeEpochMs+a)}:{from:(0,J.yT)(e.timeEpochMs-a),to:g};return{query:l,range:{from:h.from,to:h.to,raw:h}}}getLogRowContextUi(e,t,s,n){s&&n&&(s=this.datasource.applyTemplateVariables(s,n));const a=i=>{this.cachedContextFilters=i,t&&t()};return this.onContextClose=this.onContextClose??(()=>{this.cachedContextFilters=[]}),Bn({row:e,origQuery:s,updateFilter:a,onClose:this.onContextClose,logContextProvider:this,runContextQuery:t})}prepareExpression(e,t){let s=this.processContextFiltersToExpr(e,t);return window.localStorage.getItem(ke)==="true"&&(s=this.processPipelineStagesToExpr(s,t)),s}}var Wn=d(65474),Kn=d(48592),Hn=d(84596),we=d(63527);const Zt=/^label_names\(\)\s*$/,qt=/^label_values\((?:(.+),\s*)?([a-zA-Z_$][a-zA-Z0-9_]*)\)\s*$/;function Gn(r){if(typeof r!="string")return r;const e={refId:"LokiVariableQueryEditor-VariableQuery",type:L.ie.LabelNames};if(r.match(Zt))return{...e,type:L.ie.LabelNames};const s=r.match(qt);return s?{...e,type:L.ie.LabelValues,label:s[2]?s[2]:s[1],stream:s[2]?s[1]:void 0}:e}const Jn=[{label:"Label names",value:L.ie.LabelNames},{label:"Label values",value:L.ie.LabelValues}],Yn="LokiVariableQueryEditor-VariableQuery",Xn=({onChange:r,query:e,datasource:t,range:s})=>{const[n,a]=(0,v.useState)(void 0),[i,o]=(0,v.useState)(""),[l,c]=(0,v.useState)([]),[f,u]=(0,v.useState)(""),g=(0,Hn.A)(n);(0,v.useEffect)(()=>{if(!e)return;const b=typeof e=="string"?Gn(e):e;a(b.type),o(b.label||""),u(b.stream||"")},[e]),(0,v.useEffect)(()=>{n!==L.ie.LabelValues||g===n||t.languageProvider.fetchLabels({timeRange:s}).then(b=>{c(b.map(E=>({label:E,value:E})))})},[t,n,s,g]);const h=b=>{a(b.value),b.value!==void 0&&r({type:b.value,label:i,stream:f,refId:Yn})},m=b=>{o(b.value||"")},y=b=>{u(b.currentTarget.value)},x=()=>{n!==void 0&&r({type:n,label:i,stream:f,refId:"LokiVariableQueryEditor-VariableQuery"})};return(0,p.jsxs)(p.Fragment,{children:[(0,p.jsxs)(Ye.C,{children:[(0,p.jsx)(Ee.I,{label:"Query type",labelWidth:20,children:(0,p.jsx)(Me.l6,{"aria-label":"Query type",onChange:h,onBlur:x,value:n,options:Jn,width:16})}),n===L.ie.LabelValues&&(0,p.jsx)(p.Fragment,{children:(0,p.jsx)(Ee.I,{label:"Label",labelWidth:20,children:(0,p.jsx)(Me.l6,{"aria-label":"Label",onChange:m,onBlur:x,value:{label:i,value:i},options:l,width:16,allowCustomValue:!0})})})]}),n===L.ie.LabelValues&&(0,p.jsx)(Ye.C,{children:(0,p.jsx)(Ee.I,{label:"Stream selector",labelWidth:20,grow:!0,tooltip:(0,p.jsx)("div",{children:'Optional. If defined, a list of values for the specified log stream selector is returned. For example: {label="value"} or {label="$variable"}'}),children:(0,p.jsx)(we.p,{type:"text","aria-label":"Stream selector",placeholder:"Optional stream selector",value:f,onChange:y,onBlur:x})})})]})};class Zn extends Kn.f5{constructor(e){super(),this.datasource=e,this.editor=Xn}async execute(e,t,s){return this.datasource.metricFindQuery(e,{scopedVars:t,range:s})}query(e){const t=this.execute(e.targets[0],e.scopedVars,e.range);return(0,Wn.H)(t).pipe((0,Te.T)(s=>({data:s})))}}var qn=d(41119),es=d(78282);function er(r,e){if(!e.length)return[];const t=(0,D.groupBy)(e,"name"),s=Object.values(t).map(tr),n=r.fields.find(i=>i.type===_.PU.string);if(n===void 0)throw new Error("invalid logs-dataframe, string-field missing");const a=r.fields.find(i=>i.type===_.PU.other&&i.name==="labels");for(let i=0;i<n.values.length;i++)for(const o of s)if(t[o.name][0].matcherType==="label"&&a){const l=a.values[i];if(l){const c=Object.keys(l).find(f=>new RegExp(t[o.name][0].matcherRegex).test(f));if(c){o.values.push(l[c]);continue}}o.values.push(null)}else if(t[o.name][0].matcherType==="regex"||t[o.name][0].matcherType===void 0){const c=n.values[i].match(t[o.name][0].matcherRegex);if(c&&c[1]){o.values.push(c[1]);continue}o.values.push(null)}else o.values.push(null);return s}function tr(r){const e=(0,es.l)(),t=r.reduce((s,n)=>{if(n.datasourceUid){const a=e.getInstanceSettings(n.datasourceUid),i=o=>{switch(o){case"tempo":return"traceql";case"grafana-x-ray-datasource":return"getTrace";default:return}};s.push({title:n.urlDisplayLabel||"",url:"",internal:{query:{query:n.url,queryType:i(a?.type)},datasourceUid:n.datasourceUid,datasourceName:a?.name??"Data source not found"},targetBlank:n.targetBlank})}else n.url&&s.push({title:n.urlDisplayLabel||"",url:n.url,targetBlank:n.targetBlank});return s},[]);return{name:r[0].name,type:_.PU.string,config:{links:t},values:[]}}function sr(r){const e=r.filter(s=>s.refId!==void 0),t=(0,D.groupBy)(e,s=>s.refId);return Object.entries(t).map(([s,n])=>nr(n,s))}function nr(r,e){const t={name:"Time",config:{},values:[],type:_.PU.time},s={name:`Value #${e}`,config:{},values:[],type:_.PU.number},n=new Set(r.map(o=>o.fields.map(l=>Object.keys(l.labels??{})).flat()).flat()),i=Array.from(n).sort().map(o=>({name:o,config:{filterable:!0},values:[],type:_.PU.string}));return r.forEach(o=>{const l=o.fields.find(h=>h.type===_.PU.time),c=o.fields.find(h=>h.type===_.PU.number);if(l==null||c==null)return;const f=l.values,u=c.values;for(let h of f)t.values.push(h);for(let h of u)s.values.push(h);const g=c.labels??{};for(let h of i){const m=g[h.name]??"";for(let y=0;y<u.length;y++)h.values.push(m)}}),{fields:[t,...i,s],refId:e,meta:{preferredVisualisationType:"table"},length:t.values.length}}function rr(r){return r.fields.every(e=>e.type===_.PU.time||e.type===_.PU.number)}function ts(r,e){const{meta:t,...s}=r,n={...t,...e};return{...s,meta:n}}function ar(r,e,t){const s={...r.meta?.custom,lokiQueryStatKey:"Summary: total bytes processed"};(0,ie.nE)(r)&&(s.error="Error when parsing some of the logs");const n={preferredVisualisationType:"logs",limit:e?.maxLines,searchWords:e?(0,w.H0)(e.expr):void 0,custom:s},a=ts(r,n),i=er(a,t);return{...a,fields:[...a.fields,...i]}}function ir(r,e,t){return r.map(s=>{const n=s.refId!==void 0?e.get(s.refId):void 0;return ar(s,n,t)})}function or(r){return r.length>0?sr(r):[]}function lr(r){const e={preferredVisualisationType:"graph"};return r.map(t=>ts(t,e))}function cr(r,e){const t=[],s=[],n=[];return r.forEach(a=>{rr(a)?a.refId!=null&&e.get(a.refId)?.queryType===L.U3.Instant?s.push(a):n.push(a):t.push(a)}),{streamsFrames:t,metricInstantFrames:s,metricRangeFrames:n}}function ur(r,e){if(r===void 0)return r;const{refId:t,message:s}=r;if(t===void 0||s===void 0)return r;const n=e.get(t);return n===void 0?r:s.includes("escape")&&n.expr.includes("\\")?{...r,message:`${s}. Make sure that all special characters are escaped with \\. For more information on escaping of special characters visit LogQL documentation at https://grafana.com/docs/loki/latest/logql/.`}:r}function dr(r,e,t){const{data:s,error:n,...a}=r,i=s.map(u=>{if(!(0,qn.ci)(u))throw new Error("transformation only supports dataframe responses");return u}),o=new Map(e.map(u=>{const g=r.data.find(m=>m.refId===u.refId)?.meta.executedQueryString,h={...u,expr:g?(0,w.mW)(g):u.expr};return[u.refId,h]})),{streamsFrames:l,metricInstantFrames:c,metricRangeFrames:f}=cr(i,o);return{...a,error:ur(n,o),data:[...lr(f),...or(c),...ir(l,o,t)]}}var fr=d(32300),Ze=d(30048),Ue=d(41654);const hr=[{value:L.U3.Range,label:"Range",description:"Run query over a range of time."},{value:L.U3.Instant,label:"Instant",description:'Run query against a single point in time. For this query, the "To" time is used.'}],ss=[{value:L.ti.Backward,label:"Backward",description:"Search in backward direction."},{value:L.ti.Forward,label:"Forward",description:"Search in forward direction."}];I.$.featureToggles.lokiShardSplitting&&ss.push({value:L.ti.Scan,label:"Scan",description:"Experimental. Split the query into smaller units and stop at the requested log line limit.",icon:"exclamation-triangle"}),I.$.featureToggles.lokiExperimentalStreaming&&hr.push({value:L.U3.Stream,label:"Stream",description:"Run a query and keep sending results on an interval"});function Ra(r){return ss.find(e=>e.value===r)?.label??"Unknown"}function ns(r){const{lineLimitValue:e,onRunQuery:t,runOnBlur:s,onChange:n}=r,a=r.query??{};function i(c){const f=rs(c),u={...a,maxLines:f};n(u),(0,ce.rR)("grafana_loki_max_lines_changed",{maxLines:f})}function o(c){a.maxLines!==rs(c.currentTarget.value)&&i(c.currentTarget.value)}function l(c){c.key==="Enter"&&t()}return(0,p.jsx)(Ue.B,{alignItems:"flex-start",gap:.5,"aria-label":"Loki extra field",children:(0,p.jsx)(Ue.B,{wrap:"nowrap",gap:0,"data-testid":"lineLimitField","aria-label":"Line limit field",children:(0,p.jsx)(Ee.I,{label:"Line limit",tooltip:"Upper limit for number of log lines returned by query.",children:(0,p.jsx)(we.p,{className:"width-4",placeholder:"auto",type:"number",min:0,onChange:o,onKeyDown:l,value:e,onBlur:()=>{s&&t()}})})})})}const Fa=(0,v.memo)(ns);function rs(r){const e=parseInt(r,10);if(!(isNaN(e)||e<0))return e}const gr=(0,v.lazy)(()=>d.e(1952).then(d.bind(d,32833))),pr=r=>(0,p.jsx)(v.Suspense,{fallback:null,children:(0,p.jsx)(gr,{...r})}),mr=r=>{const e=(0,v.useRef)(null),{onRunQuery:t,onChange:s,...n}=r,a=o=>{e.current=o,s(o),t()},i=o=>{s(o)};return(0,p.jsx)(pr,{onRunQuery:a,onBlur:i,onChange:s,...n})};class yr extends v.PureComponent{constructor(e){super(e),this._isMounted=!1,this.onChangeQuery=(t,s)=>{const{query:n,onChange:a,onRunQuery:i}=this.props;if(a){const o={...n,expr:t};a(o),s&&i&&i()}},this.state={labelsLoaded:!1}}async componentDidMount(){this._isMounted=!0,await this.props.datasource.languageProvider.start(this.props.range),this._isMounted&&this.setState({labelsLoaded:!0})}componentWillUnmount(){this._isMounted=!1}componentDidUpdate(e){const{range:t,datasource:{languageProvider:s}}=this.props;(0,Z.WV)(t,e.range)&&s.fetchLabels({timeRange:t})}render(){const{ExtraFieldElement:e,query:t,datasource:s,history:n,onRunQuery:a,range:i}=this.props,o=this.props.placeholder??"Enter a Loki query (run with Shift+Enter)";return(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)("div",{className:"gf-form-inline gf-form-inline--xs-view-flex-column flex-grow-1","data-testid":this.props["data-testid"],children:(0,p.jsx)("div",{className:"gf-form--grow flex-shrink-1 min-width-15",children:(0,p.jsx)(mr,{datasource:s,history:n??[],onChange:this.onChangeQuery,onRunQuery:a,initialValue:t.expr??"",placeholder:o,timeRange:i})})}),e]})}}const vr=(0,v.memo)(function(e){const{annotation:t,onAnnotationChange:s,history:n}=e;if(t===void 0||s===void 0)return null;const a=o=>{s({...t,expr:o.expr,maxLines:o.maxLines,queryType:"range"})},i={refId:"",expr:t.expr,maxLines:t.maxLines,instant:t.instant,queryType:t.queryType};return(0,p.jsxs)(Ue.B,{gap:5,direction:"column",children:[(0,p.jsx)(Ue.B,{gap:0,direction:"column",children:(0,p.jsx)(yr,{datasource:e.datasource,query:i,onChange:a,onRunQuery:()=>{},history:n,ExtraFieldElement:(0,p.jsx)(ns,{lineLimitValue:i?.maxLines?.toString()||"",query:i,onRunQuery:()=>{},onChange:a})})}),(0,p.jsxs)(fr.U,{children:[(0,p.jsx)(Ze.c,{label:"Title",tooltip:"Use either the name or a pattern. For example, {{instance}} is replaced with label value for the label instance.",children:(0,p.jsx)(we.p,{type:"text",placeholder:"alertname",value:t.titleFormat,onChange:o=>{s({...t,titleFormat:o.currentTarget.value})}})}),(0,p.jsx)(Ze.c,{label:"Tags",children:(0,p.jsx)(we.p,{type:"text",placeholder:"label1,label2",value:t.tagKeys,onChange:o=>{s({...t,tagKeys:o.currentTarget.value})}})}),(0,p.jsx)(Ze.c,{label:"Text",tooltip:"Use either the name or a pattern. For example, {{instance}} is replaced with label value for the label instance.",children:(0,p.jsx)(we.p,{type:"text",placeholder:"instance",value:t.textFormat,onChange:o=>{s({...t,textFormat:o.currentTarget.value})}})})]})]})});var qe=d(27522);function br(r,e){if(e.length===0)return[];const t=[],{queryWithParser:s,parserCount:n}=(0,w.MX)(r);if(!s){const{hasLogfmt:o,hasJSON:l,hasPack:c}=(0,ie.YB)(e[0]);l&&(c?t.push({type:"ADD_UNPACK_PARSER",label:"Selected log stream selector has packed logs.",fix:{title:"add unpack parser",label:"Consider using unpack parser.",action:{type:"ADD_UNPACK_PARSER",query:r}}}):t.push({type:"ADD_JSON_PARSER",label:"Selected log stream selector has JSON formatted logs.",fix:{title:"add json parser",label:"Consider using JSON parser.",action:{type:"ADD_JSON_PARSER",query:r}}})),o&&t.push({type:"ADD_LOGFMT_PARSER",label:"Selected log stream selector has logfmt formatted logs.",fix:{title:"add logfmt parser",label:"Consider using logfmt parser to turn key-value pairs in your log lines to labels.",action:{type:"ADD_LOGFMT_PARSER",query:r}}})}if(s){if(n===1){const l=(0,w.d_)(r);(0,ie.db)(e[0])&&!l&&t.push({type:"ADD_NO_PIPELINE_ERROR",label:"Some logs in your selected log streams have parsing error.",fix:{title:"remove pipeline errors",label:"Consider filtering out logs with parsing errors.",action:{type:"ADD_NO_PIPELINE_ERROR",query:r}}})}(0,w.pS)(r)||t.push({type:"ADD_LABEL_FILTER",label:"Consider filtering logs by their label and value.",fix:{title:"add label filter",label:"",action:{type:"ADD_LABEL_FILTER",query:r}}})}if(!(0,w._i)(r)){const o=(0,ie.Ac)(e[0]),l=(0,ie.sz)(e[0]);!o&&l&&t.push({type:"ADD_LEVEL_LABEL_FORMAT",label:`Some logs in your selected log stream have "${l}" label.`,fix:{title:"add label level format",label:`If ${l} label has level values, consider using label_format to rename it to "level". Level label can be then visualized in log volumes.`,action:{type:"ADD_LEVEL_LABEL_FORMAT",query:r,options:{renameTo:"level",originalLabel:l}}}})}return(0,w.Rn)(r)||t.push({type:"ADD_LINE_FILTER",label:"Consider filtering logs for specific string.",fix:{title:"add line filter",label:"",action:{type:"ADD_LINE_FILTER",query:r}}}),t}var as=d(96426);function xr(r,e){const t=e.targets.filter(s=>s.expr).filter(s=>!s.hide).map(s=>r.applyTemplateVariables(s,e.scopedVars,e.filters));return Sr(r,e,t)}function Sr(r,e,t){let s=!1,n={data:[],state:X.Gu.Streaming,key:(0,_e.A)()},a=null,i=new Map,o=null;const l=(f,u,g)=>{let h=g[u].groupSize;const{shards:m,groupSize:y,cycle:x}=g[u];let b=!1;a!=null&&(a.unsubscribe(),a=null);const E=()=>{n.state=s?X.Gu.Error:X.Gu.Done,f.next(n),f.complete()};if(s){E();return}const k=()=>{const F=g[u+1]&&(g[u+1].shards===void 0||is(g[u+1]))?g[u+1]:g.find(W=>is(W));if(F===void 0){E();return}g[u].groupSize=h,l(f,g.indexOf(F),g)},A=F=>{try{if(F&&!(0,ie.BY)(F))return!1}catch(he){return console.error(he),s=!0,!1}if(y!==void 0&&y>1)return g[u].groupSize=Math.floor(Math.sqrt(y)),Re(`Possible time out, new group size ${g[u].groupSize}`),b=!0,l(f,u,g),!0;const W=`${u}_${x}`,H=i.get(W)??0;return H>1?(s=!0,!1):(i.set(W,H+1),o=setTimeout(()=>{console.warn(`Retrying ${u} ${x} (${H+1})`),l(f,u,g),o=null},1500*Math.pow(2,H)),b=!0,!0)},j=ps(g[u].targets,n);if(!j.length){k();return}const $=m&&x!==void 0&&y?wr(m,x,y):[],B={...e,targets:(0,w.Bg)(j,$)};e.requestId&&(B.requestId=$.length>0?`${e.requestId}_shard_${u}_${x}_${y}`:e.requestId),Re($.length?`Querying ${$.join(", ")}`:"Running regular query"),a=ms(r,B,{skipPartialUpdates:!0,disableRetry:!0}).subscribe({next:F=>{((F.errors??[]).length>0||F.error!=null)&&A(F)||(y&&x!==void 0&&m!==void 0&&(h=Er(x+y,Tr(F,g[u]),m.length),h!==y&&Re(`New group size ${h}`)),n=$.length>0?rt(n,F):Gr(n,F),$.length===0&&f.next(n))},complete:()=>{b||(f.next(n),k())},error:F=>{console.error(F,{msg:"failed to shard"}),f.next(n),!A()&&k()}})};return new Ie.c(f=>(Lr(t,r,e).then(u=>{l(f,0,u)}),()=>{s=!0,o&&clearTimeout(o),a!=null&&(a.unsubscribe(),a=null)}))}async function Lr(r,e,t){const[s,n]=(0,D.partition)(r,o=>(0,w.E2)([o])),a=[];n.length&&a.push({targets:n});const i=(0,D.groupBy)(s,o=>(0,w.tO)(o.expr));for(const o in i)try{const c=(await e.languageProvider.fetchLabelValues("__stream_shard__",{timeRange:t.range,streamSelector:o})).map(f=>parseInt(f,10));c&&(c.sort((f,u)=>u-f),Re(`Querying ${o} with shards ${c.join(", ")}`)),a.push({targets:i[o],shards:c.length?c:void 0,groupSize:c.length?Rr(c):void 0,cycle:0})}catch(l){console.error(l,{msg:"failed to fetch label values for __stream_shard__"}),a.push({targets:i[o]})}return a}function is(r){if(r.cycle===void 0||!r.groupSize||!r.shards)return!1;const{cycle:e,groupSize:t,shards:s}=r,n=Math.min(e+t,s.length);return r.cycle=n,e<s.length&&n<=s.length}function Tr(r,e){const{groupSize:t}=e;if(!t)return 1;if(!r.data.length)return t+1;const s=r.data[0].meta?.stats?.find(n=>n.displayName==="Summary: exec time");if(s){const n=Math.round(s.value);return Re(`${s.value}`),n<=1?Math.floor(t*1.5):n<6?Math.ceil(t*1.1):t===1?t:n<20?Math.ceil(t*.9):Math.floor(t/2)}return t}function Er(r,e,t){return Math.min(e,Math.max(Math.floor((t-r)*.7),1))}function wr(r,e,t){return e===r.length?[-1]:r.slice(e,e+t)}function Rr(r){return Math.floor(Math.sqrt(r.length))}const Fr=!!localStorage.getItem("loki.sharding_debug_enabled");function Re(r){Fr&&console.log(r)}var Cr=d(72316),Ar=d(38619),Ir=d(33184);async function Dr(r){const e=JSON.stringify({expr:r.expr}),t=new TextEncoder().encode(e),s=await crypto.subtle.digest("SHA-1",t),n=Array.from(new Uint8Array(s.slice(0,8)));return`${r.datasource?.uid}/${n.map(a=>a.toString(16).padStart(2,"0")).join("")}/${I.$.bootData.user.orgId}`}function Pr(r,e,t){const s=t.range,n=s.to.valueOf()-s.from.valueOf()+1e3;let a=t.maxDataPoints??1e3;a>100&&(a*=2);let i;const o=l=>{if("message"in l&&l.message){const c=l.message;i?i.push(c):i=Pt.k9.fromDataFrameJSON(c,{maxLength:a,maxDelta:n,displayNameFormat:r.legendFormat})}return i};return(0,Cr.v)(()=>Dr(r)).pipe((0,zt.Z)(l=>(0,Ir.oF)().getStream({scope:Ar.qD.DataSource,namespace:e.uid,path:`tail/${l}`,data:{...r,timeRange:{from:s.from.valueOf().toString(),to:s.to.valueOf().toString()}}}).pipe((0,Te.T)(c=>{const f=o(c);return{data:f?[f]:[],state:X.Gu.Streaming}}))))}const Or=r=>{let t=`${window.location.protocol==="https:"?"wss://":"ws://"}${window.location.host}${I.$.appSubUrl}`;return t.endsWith("/")&&(t=t.slice(0,-1)),`${t}${r}`},Mr=1e3,os=10,Ca="/loki/api/v1",et="loki-data-samples",ls="annotation-",tt="log-row-context-query-",cs="log-volume-",us="log-sample-",kr="log-stats-",ds=1e6;function st(r,e,t,s,n){const a=Ae.calculateInterval(e,1);return{targets:[r],requestId:s,interval:a.interval,intervalMs:a.intervalMs,range:e,scopedVars:{},timezone:"UTC",app:t,startTime:Date.now(),hideFromInspector:n}}class Aa extends Hs.iy{constructor(e,t=(0,Gs.w)()){super(e),this.instanceSettings=e,this.templateSrv=t,this.streams=new Fn,this.runLiveQuery=(n,a)=>{const i=this.createLiveTarget(n,a);return this.streams.getStream(i).pipe((0,Te.T)(o=>({data:o||[],key:`loki-${i.refId}`,state:X.Gu.Streaming})),(0,Nt.W)(o=>(0,kt.$)(()=>`Live tailing was stopped due to following error: ${o.reason}`)))},this.getLogRowContext=async(n,a,i)=>await this.logContextProvider.getLogRowContext(n,a,(0,w.sc)(i)),this.getLogRowContextQuery=async(n,a,i,o)=>await this.logContextProvider.getLogRowContextQuery(n,a,(0,w.sc)(i),o),this.languageProvider=new tn(this);const s=e.jsonData||{};this.maxLines=parseInt(s.maxLines??"0",10)||Mr,this.annotations={QueryEditor:vr},this.variables=new Zn(this),this.logContextProvider=new zn(this),this.supportsAdjustableWindow=!0}getSupplementaryRequest(e,t,s){switch(e){case P.cF.LogsVolume:const n=s?.type===P.cF.LogsVolume?s:{type:e};return this.getLogsVolumeDataProvider(t,n);case P.cF.LogsSample:const a=s?.type===P.cF.LogsSample?s:{type:e};return this.getLogsSampleDataProvider(t,a);default:return}}getSupportedSupplementaryQueryTypes(){return[P.cF.LogsVolume,P.cF.LogsSample]}getSupplementaryQuery(e,t){if(t.hide)return;const s=(0,w.vV)(t);let n=(0,V.Lv)(s.expr),a=!1;switch(e.type){case P.cF.LogsVolume:if(a=!!(n&&(0,w.sI)(n)&&s.queryType===L.U3.Range),!a)return;const i=`${n} | drop __error__`,o=e.field||"level, detected_level";return(0,w.FV)(this.interpolateString(i,qe.a))===!1&&(n=i),{...s,refId:`${cs}${s.refId}`,queryType:L.U3.Range,supportingQueryType:L.Q$.LogsVolume,expr:`sum by (${o}) (count_over_time(${n}[$__auto]))`};case P.cF.LogsSample:return a=!!(n&&!(0,w.sI)(n)),a?{...s,queryType:L.U3.Range,refId:`${us}${s.refId}`,expr:(0,w.OT)(n),maxLines:Number.isNaN(Number(e.limit))?this.maxLines:Number(e.limit),supportingQueryType:L.Q$.LogsSample}:void 0;default:return}}getLogsVolumeDataProvider(e,t){const s=(0,D.cloneDeep)(e),n=s.targets.map(a=>this.getSupplementaryQuery(t,a)).filter(a=>!!a);if(n.length)return{...s,targets:n}}getLogsSampleDataProvider(e,t){const s=(0,D.cloneDeep)(e),n=s.targets.map(a=>this.getSupplementaryQuery({type:P.cF.LogsSample,limit:100},a)).filter(a=>!!a);if(n.length)return{...s,targets:n}}query(e){const t=e.targets.map(w.vV).map(i=>({...i,maxLines:i.maxLines??this.maxLines,scopes:I.$.featureToggles.scopeFilters&&I.$.featureToggles.logQLScope?e.scopes?.flatMap(o=>o.spec.filters):void 0})),s={...e,targets:t},n=s.targets.filter(i=>i.queryType===L.U3.Stream);if(I.$.featureToggles.lokiExperimentalStreaming&&n.length>0&&s.rangeRaw?.to==="now"){const i={...s,targets:n};return(0,Ut.h)(...n.map(o=>Pr(this.applyTemplateVariables(o,e.scopedVars,e.filters),this,i)))}if(s.liveStreaming)return this.runLiveQueryThroughBackend(s);if(I.$.featureToggles.lokiShardSplitting&&(0,w.E2)(s.targets))return xr(this,s);if(I.$.featureToggles.lokiQuerySplitting&&(0,w.gy)(s.targets))return ms(this,s);const a=new Date;return this.runQuery(s).pipe((0,Mt.M)(i=>hs(i,s,a)))}runQuery(e){return super.query(e).pipe((0,Te.T)(t=>dr(t,e.targets,this.instanceSettings.jsonData.derivedFields??[])))}runLiveQueryThroughBackend(e){const t=e.targets.filter(n=>n.expr!==""&&(0,w.sI)(n.expr));if(t.length===0)return(0,ze.of)({data:[],state:X.Gu.Done});const s=t.map(n=>{const a=this.applyTemplateVariables(n,e.scopedVars,e.filters),i=a.maxLines||this.maxLines;return this.runLiveQuery(a,i)});return(0,Ut.h)(...s)}createLiveTarget(e,t){const s=e.expr,n=this.instanceSettings.url,a=Ce.kM.serializeParams({query:s});return{query:s,url:Or(`${n}/loki/api/v1/tail?${a}`),refId:e.refId,size:t}}interpolateVariablesInQueries(e,t,s){let n=e;return e&&e.length&&(n=e.map(a=>({...a,datasource:this.getRef(),expr:this.addAdHocFilters(this.templateSrv.replace(a.expr,t,this.interpolateQueryExpr),s)}))),n}getQueryDisplayText(e){return e.expr}getTimeRangeParams(e){return{start:e.from.valueOf()*ds,end:e.to.valueOf()*ds}}async importFromAbstractQueries(e){await this.languageProvider.start();const t=this.languageProvider.labelKeys;return t&&t.length&&(e=e.map(s=>(s.labelMatchers=s.labelMatchers.filter(n=>t.includes(n.name)),s))),e.map(s=>this.languageProvider.importFromAbstractQuery(s))}async exportToAbstractQueries(e){return e.map(t=>this.languageProvider.exportToAbstractQuery(t))}async metadataRequest(e,t,s){if(e.startsWith("/"))throw new Error(`invalid metadata request url: ${e}`);const n=await this.getResource(e,t,s);return!n.data&&n.values?n.values??[]:!n.data&&n.fields?n.fields??[]:n.data??[]}async statsMetadataRequest(e,t,s){if(e.startsWith("/"))throw new Error(`invalid metadata request url: ${e}`);return await this.getResource(e,t,s)}async getQueryStats(e,t){if((0,w.FV)(this.interpolateString(e.expr,qe.a)))return;const s=(0,w.pk)(e.expr);let n={streams:0,chunks:0,bytes:0,entries:0};for(const a in s){const{start:i,end:o}=this.getStatsTimeRange(e,Number(a),t);if(i===void 0||o===void 0)return{streams:0,chunks:0,bytes:0,entries:0,message:"Query size estimate not available."};try{const l=await this.statsMetadataRequest("index/stats",{query:s[a],start:i,end:o},{showErrorAlert:!1,requestId:`${kr}${e.refId}`});n={streams:n.streams+l.streams,chunks:n.chunks+l.chunks,bytes:n.bytes+l.bytes,entries:n.entries+l.entries}}catch{break}}return n}getStatsTimeRange(e,t,s){let n,a;const l=(0,w.QH)(e.expr,[ee.dw]).map(c=>e.expr.substring(c.from,c.to));return(0,w.sI)(e.expr)?e.queryType===L.U3.Instant?{start:void 0,end:void 0}:this.getTimeRangeParams(s):e.queryType===L.U3.Instant?l[t]?(a=this.getTimeRangeParams(s).end,n=a-Ae.intervalToMs(l[t])*1e6,{start:n,end:a}):/(\$__auto|\$__range)/.test(e.expr)?this.getTimeRangeParams(s):{start:void 0,end:void 0}:this.getTimeRangeParams(s)}async getStats(e,t){if(!e.expr)return null;const s=await this.getQueryStats(e,t);return s?Object.values(s).every(n=>n===0)?null:s:null}async metricFindQuery(e,t){if(!e)return Promise.resolve([]);let s;return typeof e=="string"?s=this.parseStringToVariableQuery(this.interpolateString(e,t?.scopedVars)):s={...e,label:this.interpolateString(e.label||"",t?.scopedVars),stream:this.interpolateString(e.stream||"",t?.scopedVars)},s?await this.processMetricFindQuery(s,t?.range):Promise.resolve([])}async processMetricFindQuery(e,t){return e.type===L.ie.LabelNames?(await this.languageProvider.fetchLabels({timeRange:t})).map(a=>({text:a})):e.label?(await this.languageProvider.fetchLabelValues(e.label,{streamSelector:e.stream,timeRange:t})).map(n=>({text:n})):[]}parseStringToVariableQuery(e){const t="LokiVariableQueryEditor-VariableQuery";if(e.match(Zt))return{type:L.ie.LabelNames,refId:t};const n=e.match(qt);if(n)return{type:L.ie.LabelValues,label:n[2],stream:n[1],refId:t}}async getDataSamples(e,t,s){let n=e.expr;if((0,w.FV)(this.interpolateString(n,qe.a)))return[];if(!(0,w.sI)(n))if(s?.convertMetricQueryToLogQuery)n=(0,w.OT)(n);else return[];const a={expr:n,queryType:L.U3.Range,refId:et,maxLines:e.maxLines||os,supportingQueryType:L.Q$.DataSample},i=st(a,t,M.Jk.Unknown,et,!0);return await(0,Y.s)(this.query(i).pipe((0,Qt.n)(o=>(0,ze.of)(o.data))))}async getTagKeys(e){let t="{}";for(const n of e?.filters??[])t=(0,V.tE)(t,n.key,n.operator,n.value);return(await this.languageProvider.fetchLabels({timeRange:e?.timeRange,streamSelector:t})).map(n=>({text:n}))}async getTagValues(e){let t="{}";for(const n of e?.filters??[])t=(0,V.tE)(t,n.key,n.operator,n.value);return(await this.languageProvider.fetchLabelValues(e.key,{timeRange:e.timeRange,streamSelector:t})).map(n=>({text:n}))}interpolateQueryExpr(e,t){return!t.multi&&!t.includeAll?e:typeof e=="string"?fs(e):(0,D.map)(e,fs).join("|")}toggleQueryFilter(e,t){let s=e.expr??"";const n=(0,Z.Ed)(t.options.key,t.frame,0);switch(t.type){case"FILTER_FOR":{if(t.options?.key&&t.options?.value){const a=(0,Z.Bb)(t.options.value);s=(0,V.je)(s,t.options.key,"=",a)?(0,V.FN)(s,t.options.key,"=",a):(0,V.tE)(s,t.options.key,"=",a,n)}break}case"FILTER_OUT":{if(t.options?.key&&t.options?.value){const a=(0,Z.Bb)(t.options.value);(0,V.je)(s,t.options.key,"=",a)&&(s=(0,V.FN)(s,t.options.key,"=",a)),s=(0,V.tE)(s,t.options.key,"!=",a,n)}break}default:break}return{...e,expr:s}}queryHasFilter(e,t){let s=e.expr??"";return(0,V.je)(s,t.key,"=",t.value)}modifyQuery(e,t){let s=e.expr??"";switch(t.type){case"ADD_FILTER":{if(t.options?.key&&t.options?.value){const n=(0,Z.Ed)(t.options.key,t.frame,0),a=(0,Z.Bb)(t.options.value);s=(0,V.tE)(s,t.options.key,"=",a,n)}break}case"ADD_FILTER_OUT":{if(t.options?.key&&t.options?.value){const n=(0,Z.Ed)(t.options.key,t.frame,0),a=(0,Z.Bb)(t.options.value);s=(0,V.tE)(s,t.options.key,"!=",a,n)}break}case"ADD_LOGFMT_PARSER":{s=(0,V.aH)(s,"logfmt");break}case"ADD_JSON_PARSER":{s=(0,V.aH)(s,"json");break}case"ADD_UNPACK_PARSER":{s=(0,V.aH)(s,"unpack");break}case"ADD_NO_PIPELINE_ERROR":{s=(0,V.yI)(s);break}case"ADD_LEVEL_LABEL_FORMAT":{t.options?.originalLabel&&t.options?.renameTo&&(s=(0,V.o9)(s,{renameTo:t.options.renameTo,originalLabel:t.options.originalLabel}));break}case"ADD_LABEL_FILTER":{const n=(0,V.cH)(e.expr),a=(0,V.lN)(e.expr),i=(0,V.lq)([...n,...a]),o=(0,V.i6)("","","=");s=(0,V.cQ)(s,[i],o);break}case"ADD_STRING_FILTER":case"ADD_LINE_FILTER":{s=(0,V.OS)(s,t.options?.value);break}case"ADD_STRING_FILTER_OUT":case"ADD_LINE_FILTER_OUT":{s=(0,V.OS)(s,t.options?.value,"!=");break}default:break}return{...e,expr:s}}getSupportedQueryModifications(){return["ADD_FILTER","ADD_FILTER_OUT","ADD_LOGFMT_PARSER","ADD_JSON_PARSER","ADD_UNPACK_PARSER","ADD_NO_PIPELINE_ERROR","ADD_LEVEL_LABEL_FORMAT","ADD_LABEL_FILTER","ADD_STRING_FILTER","ADD_STRING_FILTER_OUT"]}getLogRowContextUi(e,t,s,n){return this.logContextProvider.getLogRowContextUi(e,t,(0,w.sc)(s),n)}async annotationQuery(e){const{expr:t,maxLines:s,instant:n,tagKeys:a="",titleFormat:i="",textFormat:o=""}=e.annotation;if(!t)return[];const l=`${ls}${e.annotation.name}`,c={refId:l,expr:t,maxLines:s,instant:n,queryType:n?L.U3.Instant:L.U3.Range},f=st(c,e.range,M.Jk.Dashboard,l),{data:u}=await(0,Y.s)(this.query(f)),g=[],h=a.split(",").filter(y=>y!==""),m=I.$.featureToggles.lokiLogsDataplane;for(const y of u)new Ks.R(y).forEach(b=>{const{labels:E}=b,k=Object.entries(E).map(([$,B])=>[$,B.trim()]).filter(([$,B])=>!(B===""||h.length&&!h.includes($))).map(([$,B])=>B),A=Array.from(new Set(k)),j=m?b.body:b.Line;g.push({time:m?new Date(b.timestamp).valueOf():new Date(b.Time).valueOf(),title:(0,Vt.j)(i,E),text:(0,Vt.j)(o,E)||j,tags:A})});return g}addAdHocFilters(e,t){if(!t?.length)return e;let s=(0,as.qk)(e);return s=t.reduce((n,a)=>{const{key:i,operator:o}=a;let{value:l}=a;return(0,Z.N4)(o)||(l=(0,Z.Bb)(l,o)),(0,V.tE)(n,i,o,l)},s),(0,as.If)(s)}filterQuery(e){return!(e.hide||e.expr==="")}applyTemplateVariables(e,t,s){const{__auto:n,__interval:a,__interval_ms:i,__range:o,__range_s:l,__range_ms:c,...f}=t||{},u={...f,__interval:{value:"$__interval"},__interval_ms:{value:"$__interval_ms"}},g=this.addAdHocFilters(this.templateSrv.replace(e.expr,u,this.interpolateQueryExpr),s),h=this.templateSrv.replace(e.step,u),m=this.templateSrv.replace(e.legendFormat,u);return{...e,expr:g,step:h,legendFormat:m}}interpolateString(e,t){return this.templateSrv.replace(e,t,this.interpolateQueryExpr)}getVariables(){return this.templateSrv.getVariables().map(e=>`$${e.name}`)}getQueryHints(e,t){return br(e.expr,t)}getDefaultQuery(e){const t={refId:"A",expr:""};return e===M.Jk.UnifiedAlerting?{...t,queryType:L.U3.Instant}:{...t,queryType:L.U3.Range}}}function fs(r){return typeof r=="string"?r.replace(/\\/g,"\\\\\\\\").replace(/[$^*{}\[\]+?.()|]/g,"\\\\$&"):r}var Ia=d(51814);const Da=({payload:{dashboardId:r,orgId:e,grafanaVersion:t,queries:s}})=>{try{const n=s[pluginJson.id]?.filter(x=>!x.hide)?.map(x=>getNormalizedLokiQuery(x));if(!n?.length)return;const a=n.filter(x=>isLogsQuery(x.expr)),i=n.filter(x=>!isLogsQuery(x.expr)),o=n.filter(x=>x.queryType===LokiQueryType.Instant),l=n.filter(x=>x.queryType===LokiQueryType.Range),c=n.filter(x=>x.editorMode===QueryEditorMode.Builder),f=n.filter(x=>x.editorMode===QueryEditorMode.Code),u=n.filter(Ur),g=n.filter(Nr),h=n.filter(Qr),m=n.filter(Vr),y={grafana_version:t,dashboard_id:r,org_id:e,queries_count:n.length,logs_queries_count:a.length,metric_queries_count:i.length,instant_queries_count:o.length,range_queries_count:l.length,builder_mode_queries_count:c.length,code_mode_queries_count:f.length,queries_with_template_variables_count:u.length,queries_with_changed_resolution_count:g.length,queries_with_changed_line_limit_count:h.length,queries_with_changed_legend_count:m.length};reportInteraction("grafana_loki_dashboard_loaded",y)}catch(n){console.error("error in loki tracking handler",n)}},Ur=r=>variableRegex.test(r.expr),Nr=r=>r.resolution?r.resolution!==1:!1,Qr=r=>r.maxLines!==null&&r.maxLines!==void 0,Vr=r=>r.legendFormat?r.legendFormat!=="":!1,jr=r=>!![ls,tt,cs,us,et].some(t=>r.startsWith(t)),Br=r=>{let e=0;for(const t of r.data){const s=t.meta?.custom?.lokiQueryStatKey;s&&(e+=t.meta?.stats?.find(n=>n.displayName===s)?.value??0)}return e};function hs(r,e,t,s={}){const{app:n,targets:a}=e;if(n!==M.Jk.Explore)return;let i=Br(r);for(const o of a){if(jr(o.refId))return;(0,ce.rR)("grafana_explore_loki_query_executed",{grafana_version:I.$.buildInfo.version,editor_mode:o.editorMode,has_data:r.data.some(l=>l.length>0),has_error:r.error!==void 0,legend:o.legendFormat,line_limit:o.maxLines,obfuscated_query:(0,w.$F)(o.expr),query_type:(0,w.sI)(o.expr)?"logs":"metric",query_vector_type:o.queryType,resolution:o.resolution,simultaneously_executed_query_count:a.filter(l=>!l.hide).length,simultaneously_hidden_query_count:a.filter(l=>l.hide).length,time_range_from:e?.range?.from?.toISOString(),time_range_to:e?.range?.to?.toISOString(),time_taken:Date.now()-t.getTime(),bytes_processed:i,is_split:!1,...s})}}function $r(r,e,t,s){const n={split_query_group_count:e.length,split_query_largest_partition_size:Math.max(...e.map(({partition:a})=>a.length)),split_query_total_request_count:e.reduce((a,{partition:i})=>a+i.length,0),is_split:!0,simultaneously_executed_query_count:t.targets.filter(a=>!a.hide).length,simultaneously_hidden_query_count:t.targets.filter(a=>a.hide).length};for(const a of e){const i=a.partition.length;hs(r,a.request,s,{...n,split_query_partition_size:i})}}function gs(r,e,t,s){const n=e.from.toDate().getTime(),a=e.to.toDate().getTime();return(r?zs(n,a,s):Ws(n,a,t,s)).map(([o,l])=>{const c=(0,J.KQ)(o),f=(0,J.KQ)(l);return{from:c,to:f,raw:{from:c,to:f}}})}function ps(r,e){return e?r.map(t=>{if(!t.maxLines||!(0,w.sI)(t.expr))return t;const s=e.data.find(a=>a.refId===t.refId);if(!s)return t;const n=t.maxLines-s.length;return{...t,maxLines:n<0?0:n}}).filter(t=>t.maxLines===void 0||t.maxLines>0):r}function _r(r,e,t={}){const s=e.length?e[0].request.queryGroupId:(0,_e.A)();let n={data:[],state:X.Gu.Streaming,key:s};const a=Math.max(...e.map(({partition:h})=>h.length)),i=e.filter(({partition:h})=>h.length===a)[0].partition;let o=!1,l=null,c=new Map,f=null;const u=(h,m,y)=>{let x=!1;if(l!=null&&(l.unsubscribe(),l=null),o){h.complete();return}const b=()=>{n.state=X.Gu.Done,h.next(n),h.complete()},E=()=>{const{nextRequestN:F,nextRequestGroup:W}=Wr(e,y,m);if(F>0&&W>=0){u(h,F,W);return}b()},k=F=>{if(t.disableRetry)return!1;try{if(F&&!(0,ie.BY)(F))return!1}catch(he){return console.error(he),o=!0,!1}const W=`${m}-${y}`,H=c.get(W)??0;return H>0?!1:(c.set(W,H+1),f=setTimeout(()=>{u(h,m,y)},1500*Math.pow(2,H)),x=!0,!0)},A=e[y],j=A.partition[m-1],$=ps(A.request.targets,n);if(!$.length){E();return}const B={...e[y].request,range:j,targets:$};A.request.requestId&&(B.requestId=`${A.request.requestId}_${m}`),l=r.runQuery(B).subscribe({next:F=>{if((F.errors??[]).length>0||F.error!=null){if(k(F))return;o=!0}n=rt(n,F),t.skipPartialUpdates||(n=zr(n,B,i,m))},complete:()=>{x||(t.skipPartialUpdates||h.next(n),E())},error:F=>{h.error(F),k()}})};return new Ie.c(h=>(u(h,a,0),()=>{o=!0,f&&(clearTimeout(f),f=null),l!=null&&(l.unsubscribe(),l=null)}))}const nt="loki-splitting-progress";function zr(r,e,t,s){if((0,w.sI)(e.targets[0].expr)||(r.data=r.data.filter(a=>a.name!==nt),s<=1))return r;const n=(0,_s.I)([{time:t[0].from.valueOf(),timeEnd:t[s-2].to.valueOf(),isRegion:!0,color:"rgba(120, 120, 120, 0.1)"}]);return n.name=nt,n.meta={dataTopic:Q.QR.Annotations},r.data.push(n),r}function Wr(r,e,t){for(let s=e+1;s<r.length;s++)if(r[s].partition[t-1])return{nextRequestGroup:s,nextRequestN:t};return{nextRequestGroup:r.findIndex(s=>s?.partition[t-1]!==void 0),nextRequestN:t-1}}function Kr(r){return r.queryType!==L.U3.Instant&&!(0,w.Cg)(r.expr)}function ms(r,e,t={}){const s=e.targets.filter(h=>!h.hide).filter(h=>h.expr).map(h=>r.applyTemplateVariables(h,e.scopedVars,e.filters)),[n,a]=(0,D.partition)(s,h=>!Kr(h)),[i,o]=(0,D.partition)(a,h=>(0,w.sI)(h.expr));e.queryGroupId=(0,_e.A)();const l=1440*60*1e3,c=(0,D.groupBy)(i,h=>h.direction===L.ti.Forward?L.ti.Forward:L.ti.Backward),f=[];for(const h in c){const m=c[h],y=(0,D.groupBy)(m,x=>x.resolution||1);for(const x in y){const b={request:{...e,targets:y[x]},partition:gs(!0,e.range,e.intervalMs,l)};h===L.ti.Forward&&b.partition.reverse(),f.push(b)}}const u=(0,D.groupBy)(o,h=>Hr(e.intervalMs,e.range,h.resolution||1,h.step));for(const h in u){const m=u[h].map(y=>{const{maxLines:x,...b}=y;return b});f.push({request:{...e,targets:m},partition:gs(!1,e.range,Number(h),l)})}n.length&&f.push({request:{...e,targets:n},partition:[e.range]});const g=new Date;return _r(r,f,t).pipe((0,Mt.M)(h=>{h.state===X.Gu.Done&&$r(h,f,e,g)}))}function Hr(r,e,t,s){const n=/(-?\d+(?:\.\d+)?)(ms|[Mwdhmsy])/;if(s?.match(n))return Ae.intervalToMs(s)*t;const a=r*t,i=Math.round((e.to.valueOf()-e.from.valueOf())/11e3);return Math.max(a,i)}function rt(r,e){if(!r)return ys(e);e.data.forEach(a=>{const i=r.data.find(o=>vs(o,a));if(!i){r.data.push(at(a));return}Jr(i,a)});const t=[...r.errors??[],...e.errors??[]];t.length>0&&(r.errors=t);const s=r.error??e.error;s!=null&&(r.error=s);const n=[...r.traceIds??[],...e.traceIds??[]];return n.length>0&&(r.traceIds=n),r}function Gr(r,e){if(!r)return ys(e);e.data.forEach(a=>{const i=r.data.findIndex(o=>vs(o,a));if(i<0){r.data.push(at(a));return}r.data[i]=a}),e.state===X.Gu.Done&&(r.data=r.data.filter(a=>a.name!==nt));const t=[...r.errors??[],...e.errors??[]];t.length>0&&(r.errors=t);const s=r.error??e.error;s!=null&&(r.error=s);const n=[...r.traceIds??[],...e.traceIds??[]];return n.length>0&&(r.traceIds=n),r}function Jr(r,e){const t=r.fields.find(l=>l.type===_.PU.time),s=r.fields.find(l=>l.type===_.PU.string&&l.name==="id"),n=e.fields.find(l=>l.type===_.PU.time),a=e.fields.find(l=>l.type===_.PU.string&&l.name==="id");if(!t||!n){console.error(new Error("Time fields not found in the data frames"));return}const i=n?.values.slice(0)??[],o=Math.max(r.fields.length,e.fields.length);for(let l=0;l<i.length;l++){const c=Yr(t,n,l),f=Xr(t,s,c,n,a,l);for(let u=0;u<o;u++){if(!r.fields[u])continue;const g=qr(r.fields[u],e.fields,u);if(g)if(f){if(r.fields[u].type===_.PU.time)continue;r.fields[u].type===_.PU.number?r.fields[u].values[c]=(r.fields[u].values[c]??0)+g.values[l]:r.fields[u].type===_.PU.other?typeof g.values[l]=="object"?r.fields[u].values[c]={...r.fields[u].values[c],...g.values[l]}:g.values[l]&&(r.fields[u].values[c]=g.values[l]):r.fields[u].values[c]=g.values[l]}else g.values[l]!==void 0&&(r.fields[u].values.splice(c,0,g.values[l]),g.nanos?(r.fields[u].nanos=r.fields[u].nanos??new Array(r.fields[u].values.length-1).fill(0),r.fields[u].nanos?.splice(c,0,g.nanos[l])):r.fields[u].nanos&&r.fields[u].nanos?.splice(c,0,0))}}r.length=r.fields[0].values.length,r.meta={...r.meta,stats:sa(r.meta?.stats??[],e.meta?.stats??[])}}function Yr(r,e,t){const s=(0,Pt.Ls)(e.values[t],r.values);return s<0?0:e.values[t]===r.values[s]&&e.nanos&&r.nanos?e.nanos[t]>r.nanos[s]?s+1:s:e.values[t]>r.values[s]?s+1:s}function Xr(r,e,t,s,n,a){return Zr(r,t,s,a)?!e||!n?!0:e.values[t]!==void 0&&e.values[t]===n.values[a]:!1}function Zr(r,e,t,s){return r.nanos&&t.nanos?r.values[e]!==void 0&&r.values[e]===t.values[s]&&r.nanos[e]!==void 0&&r.nanos[e]===t.nanos[s]:r.values[e]!==void 0&&r.values[e]===t.values[s]}function qr(r,e,t){const s=e.filter(n=>n.name===r.name);return s.length===1?s[0]:r.labels?s.find(n=>(0,Ot.ab)(r.labels??{},n.labels??{})):e[t]}const ea="Summary: total bytes processed",ta="Summary: exec time";function sa(r,e){const t=[];for(const s of[ea,ta]){const n=r.find(o=>o.displayName===s),a=e.find(o=>o.displayName===s);if(a!=null&&n!=null){t.push({value:a.value+n.value,displayName:s,unit:n.unit});continue}const i=a??n;i!=null&&t.push(i)}return t}function ys(r){return{...r,data:r.data.map(at)}}function at(r){return{...r,fields:r.fields.map(e=>({...e,values:e.values}))}}function vs(r,e){if(r.refId!==e.refId||r.name!==e.name)return!1;const t=r.meta?.type,s=e.meta?.type;if(t!==s)return!1;if(t===$s.m.TimeSeriesMulti){const i=r.fields.find(l=>l.type===_.PU.number),o=e.fields.find(l=>l.type===_.PU.number);return i===void 0||o===void 0?!1:(0,Ot.ab)(i.labels??{},o.labels??{})}const n=r.meta?.custom?.frameType,a=e.meta?.custom?.frameType;return n==="LabeledTimeValues"&&a==="LabeledTimeValues"?!0:n===a}var bs=d(71673),na=d(59896),ra=d(48575),it=d(37234);function ot(r){return typeof r=="function"}function lt(r){return typeof r=="function"}function ct(r){return typeof r=="function"}function ut(r){return typeof r=="function"}function dt(r){return typeof r=="function"}function aa(r){return typeof r=="function"}function ia(r){return typeof r=="function"}function oa(r){return typeof r=="function"}function la(r){return typeof r=="function"}function xs(r){return typeof r=="function"}function Ne(r){return Array.isArray(r)&&r.every(v.isValidElement)}function ft(r){const e=Object.values(M.Jk).map(t=>t.toString());return typeof r=="string"&&e.includes(r)}function ca(r){return Array.isArray(r)&&r.every(e=>"divider"in e||"onClick"in e&&"label"in e)}const ua=r=>{const[e,t]=(0,v.useState)(new Map);return(0,Ht.A)(async()=>{if(!r){t(new Map);return}const s=await Promise.all(r.filter(n=>!!n.datasource?.uid).map(n=>(0,es.l)().get(n.datasource?.uid).then(a=>({key:n.refId,ds:a}))));t(new Map(s.map(({key:n,ds:a})=>[n,a])))},[r]),e},da={},fa=({data:r,timeZone:e,fieldConfig:t,options:{showControls:s,controlsStorageKey:n,showLabels:a,showTime:i,wrapLogMessage:o,showCommonLabels:l,prettifyLogMessage:c,sortOrder:f,dedupStrategy:u,enableLogDetails:g,showLogContextToggle:h,onClickFilterLabel:m,onClickFilterOutLabel:y,onClickFilterOutString:x,onClickFilterString:b,onLogOptionsChange:E,isFilterLabelActive:k,logRowMenuIconsBefore:A,logRowMenuIconsAfter:j,logLineMenuCustomItems:$,enableInfiniteScrolling:B,onNewLogsReceived:F,fontSize:W,syntaxHighlighting:H,detailsMode:he,noInteractions:Se,timestampResolution:gt,...oe},height:C,id:G})=>{const U=f===Q.uH.Ascending,re=(0,Dt.of)(ha),pt=(0,v.useRef)(null),[ge,Ls]=(0,v.useState)(null),[K,mt]=(0,v.useState)(null),[q,Qe]=(0,v.useState)(oe.displayedFields??[]),[yt,Ts]=(0,v.useState)(!1),vt=(0,v.useRef)(!1),[O,Es]=(0,v.useState)(r),ue=ua(O.request?.targets),pe=(0,v.useRef)(null);let Fe=(0,v.useRef)();const{app:de,eventBus:Ve,onAddAdHocFilter:Le}=(0,Os.d2)();(0,v.useEffect)(()=>{(0,Ps.J7)().publish(new P.Df({order:f}))},[f]);const bt=(0,v.useCallback)(S=>{S&&Ve.publish(new z.b_({point:{time:S.timeEpochMs}}))},[Ve]),xt=(0,v.useCallback)(()=>{Ve.publish(new z.ql)},[Ve]),ws=(0,v.useCallback)(()=>{Ls(null),Fe.current&&Fe.current()},[Fe]),St=(0,v.useCallback)((S,N)=>{Ls(S),Fe.current=N},[Fe]),Lt=(0,v.useCallback)(S=>{if(!S.dataFrame.refId||!ue||!h&&O.request?.app!==M.Jk.Dashboard&&O.request?.app!==M.Jk.PanelEditor&&O.request?.app!==M.Jk.PanelViewer)return!1;const N=ue.get(S.dataFrame.refId);return(0,P.Ol)(N)},[ue,h,O.request?.app]),Rs=(0,v.useCallback)(()=>!(O.request?.app!==M.Jk.Dashboard&&O.request?.app!==M.Jk.PanelEditor&&O.request?.app!==M.Jk.PanelViewer),[O.request?.app]),Tt=(0,v.useCallback)(async(S,N,ne)=>{if(!N.dataFrame.refId||!ue)return Promise.resolve({data:[]});const le=O.request?.targets[0];if(!le)return Promise.resolve({data:[]});const $e=ue.get(N.dataFrame.refId);return(0,P.Ol)($e)?(ne.scopedVars=O.request?.scopedVars,$e.getLogRowContext(S,ne,le)):Promise.resolve({data:[]})},[O.request?.targets,O.request?.scopedVars,ue]),Fs=(0,v.useCallback)((S,N)=>{if(!S.dataFrame.refId||!ue)return(0,p.jsx)(p.Fragment,{});const ne=O.request?.targets[0];if(!ne)return(0,p.jsx)(p.Fragment,{});const le=ue.get(S.dataFrame.refId);return(0,P.wj)(le)?le.getLogRowContextUi?le.getLogRowContextUi(S,N,ne,O.request?.scopedVars):(0,p.jsx)(p.Fragment,{}):(0,p.jsx)(p.Fragment,{})},[O.request?.targets,O.request?.scopedVars,ue]),[me,je,Cs]=(0,v.useMemo)(()=>{const S=O?(0,it.HT)(O.series,O.request?.intervalMs,void 0,O.request?.targets,!!B):null,N=S?.rows||[],ne=S?.meta?.find($e=>$e.label===it.yR),le=(0,it.M0)(N,u);return[N,le,ne]},[u,B,O]),Et=(0,v.useCallback)(async S=>await ga(S,me,O.timeRange),[O.timeRange,me]);(0,v.useEffect)(()=>{r.state!==X.Gu.Loading&&Es(r)},[r]),(0,v.useLayoutEffect)(()=>{if(!I.$.featureToggles.newLogsPanel){if(!pt.current||!K||pe.current){pe.current=pe.current==="infinite-scroll"?null:pe.current;return}(O.request?.app===M.Jk.Dashboard||O.request?.app===M.Jk.PanelEditor)&&K.scrollTo(0,U?pt.current.scrollHeight:0)}},[O.request?.app,U,K,me]);const wt=(0,v.useCallback)((S,N,ne,le)=>(0,ks.QL)({field:S,rowIndex:N,range:O.timeRange,dataFrame:ne,vars:le}),[O]),As=(0,v.useCallback)(S=>{K?.scrollTo({top:S.offsetTop,behavior:"smooth"})},[K]),ba=(0,v.useCallback)((S,N)=>{Le?.({key:S,value:N,operator:"="})},[Le]),xa=(0,v.useCallback)((S,N)=>{Le?.({key:S,value:N,operator:"!="})},[Le]),Is=(0,v.useCallback)(S=>{q?.indexOf(S)===-1&&Qe(q?.concat(S))},[q]),Ds=(0,v.useCallback)(S=>{const N=q?.indexOf(S);N!==void 0&&N>-1&&Qe(q?.filter(ne=>S!==ne))},[q]);(0,v.useEffect)(()=>{oe.displayedFields&&Qe(oe.displayedFields)},[oe.displayedFields]),(0,v.useEffect)(()=>{function S(){if(!K)return;pe.current="user";const N=K.scrollHeight-K.scrollTop-K.clientHeight===0;(K.scrollTop===0&&!U||N&&U)&&(pe.current=null)}return K?.addEventListener("scroll",S),K?.addEventListener("wheel",S),()=>{K?.removeEventListener("scroll",S),K?.removeEventListener("wheel",S)}},[U,K]);const Rt=(0,v.useCallback)(async S=>{if(!r.request||!I.$.featureToggles.logsInfiniteScrolling||vt.current)return;vt.current=!0,Ts(!0);const N=la(F)?F:void 0;let ne=[];try{ne=await pa(ue,O,S,e,N)}catch(le){console.error(le)}finally{Ts(!1),vt.current=!1}pe.current="infinite-scroll",Es({...O,series:ne})},[r.request,ue,F,O,e]),Be=()=>(0,p.jsxs)("div",{className:(0,R.cx)(re.labelContainer,U&&re.labelContainerAscending),children:[(0,p.jsx)("span",{className:re.label,children:(0,p.jsx)(T.x6,{i18nKey:"logs.logs-panel.render-common-labels.common-labels",children:"Common labels:"})}),(0,p.jsx)(na.h,{labels:typeof Cs?.value=="object"?Cs?.value:da,emptyMessage:"(no common labels)"})]}),Sa=(0,v.useMemo)(()=>(de===M.Jk.Dashboard||de===M.Jk.PanelEditor)&&f===Q.uH.Ascending?"bottom":"top",[de,f]),La=(0,v.useMemo)(()=>{if(n)return n;if(r.request)return`${r.request?.dashboardUID}.${G}`},[n,r.request,G]);if(!r||me.length===0)return(0,p.jsx)(Bs.a,{fieldConfig:t,panelId:G,data:r,needsStringField:!0});const Ft=Le?ba:void 0,Ct=Le?xa:void 0,At=aa(oe.onClickShowField)?oe.onClickShowField:Is,It=ia(oe.onClickHideField)?oe.onClickHideField:Ds,Ta=oa(oe.setDisplayedFields)?oe.setDisplayedFields:Qe,Ea=he||(de===M.Jk.Dashboard?"inline":void 0);return(0,p.jsxs)(p.Fragment,{children:[(!I.$.featureToggles.newLogsPanel||!I.$.featureToggles.newLogContext)&&ge&&(0,p.jsx)(Qs.V,{open:ge!==null,row:ge,onClose:ws,getRowContext:(S,N)=>Tt(S,ge,N),logsSortOrder:f,timeZone:e,getLogRowContextUi:Fs}),I.$.featureToggles.newLogsPanel&&I.$.featureToggles.newLogContext&&Tt&&ge&&(0,p.jsx)(Vs.gG,{open:ge!==null,log:ge,onClose:ws,getRowContext:(S,N)=>Tt(S,ge,N),getLogRowContextUi:Fs,logOptionsStorageKey:n,timeZone:e,displayedFields:q,onClickShowField:Is,onClickHideField:Ds}),I.$.featureToggles.newLogsPanel&&(0,p.jsx)("div",{onMouseLeave:xt,className:re.logListContainer,style:C?{minHeight:C}:void 0,ref:S=>mt(S),children:je.length>0&&K&&(0,p.jsx)(js.Z,{app:ft(de)?de:M.Jk.Dashboard,containerElement:K,dedupStrategy:u,detailsMode:Ea,displayedFields:q,enableLogDetails:g,fontSize:W,getFieldLinks:wt,isLabelFilterActive:dt(k)?k:void 0,initialScrollPosition:Sa,loading:yt,logLineMenuCustomItems:ca($)?$:void 0,logs:je,logSupportsContext:Lt,loadMore:B?Rt:void 0,noInteractions:Se,onClickFilterLabel:ot(m)?m:Ft,onClickFilterOutLabel:lt(y)?y:Ct,onClickFilterString:ct(b)?b:void 0,onClickFilterOutString:ut(x)?x:void 0,onClickShowField:q!==void 0?At:void 0,onClickHideField:q!==void 0?It:void 0,onLogLineHover:bt,onLogOptionsChange:xs(E)?E:void 0,onOpenContext:St,onPermalinkClick:Rs()?Et:void 0,permalinkedLogId:ht()?.logs?.id??void 0,setDisplayedFields:Ta,showControls:!!s,showTime:i,sortOrder:f,logOptionsStorageKey:La,syntaxHighlighting:H,timeRange:r.timeRange,timestampResolution:gt,timeZone:e,wrapLogMessage:o})}),!I.$.featureToggles.newLogsPanel&&!s&&(0,p.jsx)(Ms.P,{ref:S=>mt(S),children:(0,p.jsxs)("div",{onMouseLeave:xt,className:re.container,ref:pt,children:[l&&!U&&Be(),(0,p.jsx)(Ns.u8,{loading:yt,loadMoreLogs:B?Rt:void 0,range:r.timeRange,timeZone:e,rows:me,scrollElement:K,sortOrder:f,children:(0,p.jsx)(ra.k,{scrollElement:K,scrollIntoView:As,permalinkedRowId:ht()?.logs?.id??void 0,onPermalinkClick:Rs()?Et:void 0,logRows:me,showContextToggle:Lt,deduplicatedRows:je,dedupStrategy:u,showLabels:a,showTime:i,wrapLogMessage:o,prettifyLogMessage:c,timeZone:e,getFieldLinks:wt,logsSortOrder:f,enableLogDetails:g,previewLimit:U?me.length:void 0,onLogRowHover:bt,app:ft(de)?de:M.Jk.Dashboard,onOpenContext:St,onClickFilterLabel:ot(m)?m:Ft,onClickFilterOutLabel:lt(y)?y:Ct,onClickFilterString:ct(b)?b:void 0,onClickFilterOutString:ut(x)?x:void 0,isFilterLabelActive:dt(k)?k:void 0,displayedFields:q,onClickShowField:q!==void 0?At:void 0,onClickHideField:q!==void 0?It:void 0,logRowMenuIconsBefore:Ne(A)?A:void 0,logRowMenuIconsAfter:Ne(j)?j:void 0,renderPreview:!U})}),l&&U&&Be()]})}),!I.$.featureToggles.newLogsPanel&&s&&(0,p.jsxs)("div",{onMouseLeave:xt,className:re.controlledLogsContainer,children:[l&&!U&&Be(),(0,p.jsx)(Us.U,{ref:S=>mt(S),visualisationType:"logs",loading:yt,loadMoreLogs:B?Rt:void 0,range:r.timeRange,logRows:me,deduplicatedRows:je,dedupStrategy:u,onClickFilterLabel:ot(m)?m:Ft,onClickFilterOutLabel:lt(y)?y:Ct,showContextToggle:Lt,showLabels:a,showTime:i,enableLogDetails:g,wrapLogMessage:o,prettifyLogMessage:c,timeZone:e,getFieldLinks:wt,logsSortOrder:f,displayedFields:q,onClickShowField:q!==void 0?At:void 0,onClickHideField:q!==void 0?It:void 0,app:ft(de)?de:M.Jk.Dashboard,onLogRowHover:bt,onOpenContext:St,onPermalinkClick:Et,permalinkedRowId:ht()?.logs?.id??void 0,scrollIntoView:As,isFilterLabelActive:dt(k)?k:void 0,onClickFilterString:ct(b)?b:void 0,onClickFilterOutString:ut(x)?x:void 0,logRowMenuIconsBefore:Ne(A)?A:void 0,logRowMenuIconsAfter:Ne(j)?j:void 0,onLogOptionsChange:xs(E)?E:void 0,logOptionsStorageKey:n,renderPreview:!U}),l&&U&&Be()]})]})},ha=r=>({container:(0,R.css)({marginBottom:r.spacing(1.5)}),logListContainer:(0,R.css)({minHeight:"100%",maxHeight:"100%",display:"flex",flex:1,flexDirection:"column",overflow:"hidden"}),controlledLogsContainer:(0,R.css)({height:"100%"}),labelContainer:(0,R.css)({margin:r.spacing(0,0,.5,.5),display:"flex",alignItems:"center"}),labelContainerAscending:(0,R.css)({margin:r.spacing(.5,0,.5,0)}),label:(0,R.css)({marginRight:r.spacing(.5),fontSize:r.typography.bodySmall.fontSize,fontWeight:r.typography.fontWeightMedium})});function ht(){const e=Ce.kM.getUrlSearchParams()?.panelState;if(e&&Array.isArray(e)&&e?.length>0&&typeof e[0]=="string")try{return JSON.parse(e[0])}catch(t){console.error("error parsing logsPanelState",t)}}async function ga(r,e,t){if(r.rowId===void 0||!r.dataFrame.refId)return;const s={logs:{id:r.uid}},n=new URL(window.location.href);n.searchParams.set("panelState",JSON.stringify(s));const a=(0,bs.sU)(r,e,{from:(0,J.yT)(t.from).valueOf(),to:(0,J.yT)(t.to).valueOf()});return n.searchParams.set("from",a.from.toString()),n.searchParams.set("to",a.to.toString()),await(0,bs.VP)(n.toString()),Promise.resolve()}async function pa(r,e,t,s,n){if(!e.request)return[];const a=Ae.convertRawToRange({from:(0,J.oZ)(s,t.from),to:(0,J.oZ)(s,t.to)}),i=(0,D.groupBy)(e.request.targets,"datasource.uid"),o=[];for(const f in i){const u=r.get(e.request.targets[0].refId);if(!u){console.warn(`Could not resolve data source for target ${e.request.targets[0].refId}`);continue}o.push(u.query({...e.request,range:a,targets:i[f]}))}const l=await Promise.all(o);let c=e.series;for(const f of l){const u=(0,ae.A)(f)?await(0,Y.s)(f):f;c=rt({data:c},{data:u.data}).data,n&&n(c,u.data)}return c}var ma=d(38919),Ss=d(73495);class ya{getSuggestionsForData(e){const t=e.getListAppender({name:"",pluginId:"logs",options:{},fieldConfig:{defaults:{custom:{}},overrides:[]}}),{dataSummary:s}=e;!s.hasData||!s.hasTimeField||!s.hasStringField||(s.preferredVisualisationType==="logs"?t.append({name:Ss.m.Logs,score:ma.nQ.Best}):t.append({name:Ss.m.Logs}))}}const va=new se.m(fa).setPanelOptions((r,e)=>{const t=[(0,T.t)("logs.category-logs","Logs")];r.addBooleanSwitch({path:"showTime",name:(0,T.t)("logs.name-time","Show timestamps"),category:t,description:"",defaultValue:!1}),I.$.featureToggles.newLogsPanel?e.options?.showTime&&r.addRadio({path:"timestampResolution",name:(0,T.t)("logs.timestamp-format","Timestamp resolution"),category:t,description:"",defaultValue:"ms",settings:{options:[{value:"ms",label:(0,T.t)("logs.logs.timestamp-resolution.label-milliseconds","Milliseconds")},{value:"ns",label:(0,T.t)("logs.logs.timestamp-resolution.label-nanoseconds","Nanoseconds")}]}}):r.addBooleanSwitch({path:"showLabels",name:(0,T.t)("logs.name-unique-labels","Unique labels"),category:t,description:"",defaultValue:!1}).addBooleanSwitch({path:"showCommonLabels",name:(0,T.t)("logs.name-common-labels","Common labels"),category:t,description:"",defaultValue:!1}),r.addBooleanSwitch({path:"wrapLogMessage",name:(0,T.t)("logs.name-wrap-lines","Wrap lines"),category:t,description:"",defaultValue:!1}),I.$.featureToggles.newLogsPanel?r.addBooleanSwitch({path:"syntaxHighlighting",name:(0,T.t)("logs.name-enable-syntax-highlighting","Enable syntax highlighting"),category:t,description:(0,T.t)("logs.description-enable-syntax-highlighting","Use a predefined syntax coloring grammar to highlight relevant parts of the log lines")}):r.addBooleanSwitch({path:"prettifyLogMessage",name:(0,T.t)("logs.name-prettify-json","Prettify JSON"),category:t,description:"",defaultValue:!1}),r.addBooleanSwitch({path:"enableLogDetails",name:(0,T.t)("logs.name-enable-log-details","Enable log details"),category:t,description:"",defaultValue:!0}),I.$.featureToggles.newLogsPanel&&e.options?.enableLogDetails&&r.addRadio({path:"detailsMode",name:(0,T.t)("logs.name-details-mode","Log Details panel mode"),category:t,description:"",settings:{options:[{value:"inline",label:(0,T.t)("logs.name-details-options.label-inline","Inline")},{value:"sidebar",label:(0,T.t)("logs.name-details-options.label-sidebar","Sidebar")}]}}),r.addBooleanSwitch({path:"enableInfiniteScrolling",name:(0,T.t)("logs.name-enable-infinite-scrolling","Enable infinite scrolling"),category:t,description:(0,T.t)("logs.description-enable-infinite-scrolling","Experimental. Request more results by scrolling to the bottom of the logs list."),defaultValue:!1}),I.$.featureToggles.newLogsPanel&&r.addBooleanSwitch({path:"showControls",name:(0,T.t)("logs.name-show-controls","Show controls"),category:t,description:(0,T.t)("logs.description-show-controls","Display controls to jump to the last or first log line, and filters by log level"),defaultValue:!1}).addRadio({path:"fontSize",name:(0,T.t)("logs.name-font-size","Font size"),category:t,description:"",settings:{options:[{value:"default",label:(0,T.t)("logs.font-size-options.label-default","Default")},{value:"small",label:(0,T.t)("logs.font-size-options.label-small","Small")}]}}),r.addRadio({path:"dedupStrategy",name:(0,T.t)("logs.name-deduplication","Deduplication"),category:t,description:"",settings:{options:[{value:Q.fY.none,label:(0,T.t)("logs.deduplication-options.label-none","None"),description:P._C[Q.fY.none]},{value:Q.fY.exact,label:(0,T.t)("logs.deduplication-options.label-exact","Exact"),description:P._C[Q.fY.exact]},{value:Q.fY.numbers,label:(0,T.t)("logs.deduplication-options.label-numbers","Numbers"),description:P._C[Q.fY.numbers]},{value:Q.fY.signature,label:(0,T.t)("logs.deduplication-options.label-signature","Signature"),description:P._C[Q.fY.signature]}]},defaultValue:Q.fY.none}).addRadio({path:"sortOrder",name:(0,T.t)("logs.name-order","Order"),category:t,description:"",settings:{options:[{value:Q.uH.Descending,label:(0,T.t)("logs.order-options.label-newest-first","Newest first")},{value:Q.uH.Ascending,label:(0,T.t)("logs.order-options.label-oldest-first","Oldest first")}]},defaultValue:Q.uH.Descending})}).setSuggestionsSupplier(new ya)}}]);

//# sourceMappingURL=7691.73077c2b18796bcd86df.js.map