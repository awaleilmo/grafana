{"version":3,"file":"DashboardScenePage.9659d451e038c7b241fb.js","mappings":"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","sources":["webpack://grafana/./public/app/features/dashboard-scene/saving/DashboardPrompt.tsx","webpack://grafana/./public/app/features/dashboard-scene/pages/DashboardScenePage.tsx","webpack://grafana/./public/app/features/provisioning/components/Dashboards/DashboardPreviewBanner.tsx","webpack://grafana/./public/app/features/provisioning/Wizard/types.ts","webpack://grafana/./public/app/features/provisioning/components/Shared/PreviewBannerViewPR.tsx","webpack://grafana/./public/app/core/components/FormPrompt/Prompt.tsx","webpack://grafana/./public/app/features/provisioning/hooks/usePullRequestParam.ts","webpack://grafana/./public/app/features/dashboard/containers/DashboardPageError.tsx"],"sourcesContent":["import { css } from '@emotion/css';\nimport * as H from 'history';\nimport { memo, useContext, useEffect, useMemo } from 'react';\n\nimport { Trans, t } from '@grafana/i18n';\nimport { locationService } from '@grafana/runtime';\nimport { ModalsContext, Modal, Button, useStyles2 } from '@grafana/ui';\nimport { Prompt } from 'app/core/components/FormPrompt/Prompt';\nimport { contextSrv } from 'app/core/services/context_srv';\n\nimport { SaveLibraryVizPanelModal } from '../panel-edit/SaveLibraryVizPanelModal';\nimport { DashboardScene } from '../scene/DashboardScene';\nimport { getLibraryPanelBehavior, isLibraryPanel } from '../utils/utils';\n\ninterface DashboardPromptProps {\n  dashboard: DashboardScene;\n}\n\nexport const DashboardPrompt = memo(({ dashboard }: DashboardPromptProps) => {\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  const originalPath = useMemo(() => locationService.getLocation().pathname, [dashboard]);\n  const { showModal, hideModal } = useContext(ModalsContext);\n\n  useEffect(() => {\n    const handleUnload = (event: BeforeUnloadEvent) => {\n      if (ignoreChanges(dashboard)) {\n        return;\n      }\n\n      if (dashboard.state.isDirty) {\n        event.preventDefault();\n        // No browser actually displays this message anymore.\n        // But Chrome requires it to be defined else the popup won't show.\n        event.returnValue = '';\n      }\n    };\n\n    window.addEventListener('beforeunload', handleUnload);\n    return () => window.removeEventListener('beforeunload', handleUnload);\n  }, [dashboard]);\n\n  const onHistoryBlock = (location: H.Location) => {\n    const panelEditor = dashboard.state.editPanel;\n    const vizPanel = panelEditor?.getPanel();\n    const search = new URLSearchParams(location.search);\n\n    // Are we leaving panel edit & library panel?\n    if (panelEditor && vizPanel && isLibraryPanel(vizPanel) && panelEditor.state.isDirty && !search.has('editPanel')) {\n      const libPanelBehavior = getLibraryPanelBehavior(vizPanel);\n\n      showModal(SaveLibraryVizPanelModal, {\n        dashboard,\n        isUnsavedPrompt: true,\n        libraryPanel: libPanelBehavior!,\n        onConfirm: () => {\n          panelEditor.onConfirmSaveLibraryPanel();\n          hideModal();\n          moveToBlockedLocationAfterReactStateUpdate(location);\n        },\n        onDiscard: () => {\n          panelEditor.onDiscard();\n          hideModal();\n          moveToBlockedLocationAfterReactStateUpdate(location);\n        },\n        onDismiss: hideModal,\n      });\n      return false;\n    }\n\n    // Are we still on the same dashboard?\n    if (originalPath === location.pathname) {\n      return true;\n    }\n\n    if (ignoreChanges(dashboard)) {\n      return true;\n    }\n\n    if (!dashboard.state.isDirty) {\n      return true;\n    }\n\n    showModal(UnsavedChangesModal, {\n      dashboard,\n      onSaveDashboardClick: () => {\n        hideModal();\n        dashboard.openSaveDrawer({\n          onSaveSuccess: () => {\n            moveToBlockedLocationAfterReactStateUpdate(location);\n          },\n        });\n      },\n\n      onDiscard: () => {\n        dashboard.exitEditMode({ skipConfirm: true });\n        hideModal();\n        moveToBlockedLocationAfterReactStateUpdate(location);\n      },\n      onDismiss: hideModal,\n    });\n\n    return false;\n  };\n\n  return <Prompt when={true} message={onHistoryBlock} />;\n});\n\nDashboardPrompt.displayName = 'DashboardPrompt';\n\nfunction moveToBlockedLocationAfterReactStateUpdate(location?: H.Location | null) {\n  if (location) {\n    setTimeout(() => locationService.push(location), 10);\n  }\n}\n\ninterface UnsavedChangesModalProps {\n  onDiscard: () => void;\n  onDismiss: () => void;\n  onSaveDashboardClick?: () => void;\n}\n\nexport const UnsavedChangesModal = ({ onDiscard, onDismiss, onSaveDashboardClick }: UnsavedChangesModalProps) => {\n  const styles = useStyles2(getStyles);\n\n  return (\n    <Modal\n      isOpen={true}\n      title={t('dashboard-scene.unsaved-changes-modal.title-unsaved-changes', 'Unsaved changes')}\n      onDismiss={onDismiss}\n      icon=\"exclamation-triangle\"\n      className={styles.modal}\n    >\n      <h5>\n        <Trans i18nKey=\"dashboard-scene.unsaved-changes-modal.changes\">Do you want to save your changes?</Trans>\n      </h5>\n      <Modal.ButtonRow>\n        <Button variant=\"secondary\" onClick={onDismiss} fill=\"outline\">\n          <Trans i18nKey=\"dashboard-scene.unsaved-changes-modal.cancel\">Cancel</Trans>\n        </Button>\n        <Button variant=\"destructive\" onClick={onDiscard}>\n          <Trans i18nKey=\"dashboard-scene.unsaved-changes-modal.discard\">Discard</Trans>\n        </Button>\n        <Button onClick={onSaveDashboardClick}>\n          <Trans i18nKey=\"dashboard-scene.unsaved-changes-modal.save-dashboard\">Save dashboard</Trans>\n        </Button>\n      </Modal.ButtonRow>\n    </Modal>\n  );\n};\n\nconst getStyles = () => ({\n  modal: css({\n    width: '500px',\n  }),\n});\n\n/**\n * For some dashboards and users changes should be ignored *\n */\nexport function ignoreChanges(scene: DashboardScene | null) {\n  const original = scene?.getInitialSaveModel();\n\n  if (!original) {\n    return true;\n  }\n\n  // Ignore changes if original is unsaved\n  if (scene?.state.meta.version === 0) {\n    return true;\n  }\n\n  // Ignore changes if the user has been signed out\n  if (!contextSrv.isSignedIn) {\n    return true;\n  }\n\n  if (!scene) {\n    return true;\n  }\n\n  const { canSave, fromScript, fromFile } = scene.state.meta;\n  if (!contextSrv.isEditor && !canSave) {\n    return true;\n  }\n\n  return !canSave || fromScript || fromFile;\n}\n","import { useEffect, useRef } from 'react';\nimport { Params, useParams } from 'react-router-dom-v5-compat';\nimport { usePrevious } from 'react-use';\n\nimport { PageLayoutType } from '@grafana/data';\nimport { locationService } from '@grafana/runtime';\nimport { UrlSyncContextProvider } from '@grafana/scenes';\nimport { Box } from '@grafana/ui';\nimport { Page } from 'app/core/components/Page/Page';\nimport PageLoader from 'app/core/components/PageLoader/PageLoader';\nimport { GrafanaRouteComponentProps } from 'app/core/navigation/types';\nimport { DashboardPageError } from 'app/features/dashboard/containers/DashboardPageError';\nimport { DashboardPageRouteParams, DashboardPageRouteSearchParams } from 'app/features/dashboard/containers/types';\nimport { getDashboardSceneProfiler } from 'app/features/dashboard/services/DashboardProfiler';\nimport { DashboardPreviewBanner } from 'app/features/provisioning/components/Dashboards/DashboardPreviewBanner';\nimport { DashboardRoutes } from 'app/types/dashboard';\n\nimport { DashboardPrompt } from '../saving/DashboardPrompt';\nimport { preserveDashboardSceneStateInLocalStorage } from '../utils/dashboardSessionState';\n\nimport { getDashboardScenePageStateManager } from './DashboardScenePageStateManager';\n\nexport interface Props\n  extends Omit<GrafanaRouteComponentProps<DashboardPageRouteParams, DashboardPageRouteSearchParams>, 'match'> {}\n\nexport function DashboardScenePage({ route, queryParams, location }: Props) {\n  const params = useParams();\n  const { type, slug, uid } = params;\n  // User by /admin/provisioning/:slug/dashboard/preview/* to load dashboards based on their file path in a remote repository\n  const path = params['*'];\n  const prevMatch = usePrevious({ params });\n  const stateManager = getDashboardScenePageStateManager();\n  const { dashboard, isLoading, loadError } = stateManager.useState();\n  // After scene migration is complete and we get rid of old dashboard we should refactor dashboardWatcher so this route reload is not need\n  const routeReloadCounter = (location.state as any)?.routeReloadCounter;\n  const prevParams = useRef<Params<string>>(params);\n\n  useEffect(() => {\n    if (route.routeName === DashboardRoutes.Normal && type === 'snapshot') {\n      stateManager.loadSnapshot(slug!);\n    } else {\n      stateManager.loadDashboard({\n        uid: (route.routeName === DashboardRoutes.Provisioning ? path : uid) ?? '',\n        type,\n        slug,\n        route: route.routeName as DashboardRoutes,\n        urlFolderUid: queryParams.folderUid,\n      });\n    }\n\n    return () => {\n      getDashboardSceneProfiler().cancelProfile();\n      preserveDashboardSceneStateInLocalStorage(locationService.getSearch(), uid);\n      stateManager.clearState();\n      stateManager.resetActiveManager();\n    };\n\n    // removing slug and path (which has slug in it) from dependencies to prevent unmount when data links reference\n    //  the same dashboard with no slug in url\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [stateManager, uid, route.routeName, queryParams.folderUid, routeReloadCounter, type]);\n\n  useEffect(() => {\n    // This use effect corrects URL without refresh when navigating to the same dashboard\n    //  using data link that has no slug in url\n    if (route.routeName === DashboardRoutes.Normal) {\n      // correct URL only when there are no new slug\n      // if slug is defined and incorrect it will be corrected in stateManager\n      if (uid === prevParams.current.uid && prevParams.current.slug && !slug) {\n        const correctedUrl = `/d/${uid}/${prevParams.current.slug}`;\n        locationService.replace({\n          ...locationService.getLocation(),\n          pathname: correctedUrl,\n        });\n      }\n    }\n\n    return () => {\n      prevParams.current = { uid, slug: !slug ? prevParams.current.slug : slug };\n    };\n  }, [route, slug, type, uid]);\n\n  if (!dashboard) {\n    let errorElement;\n    if (loadError) {\n      errorElement = <DashboardPageError error={loadError} type={type} />;\n    }\n\n    return (\n      errorElement || (\n        <Page navId=\"dashboards/browse\" layout={PageLayoutType.Canvas} data-testid={'dashboard-scene-page'}>\n          <Box paddingY={4} display=\"flex\" direction=\"column\" alignItems=\"center\">\n            {isLoading && <PageLoader />}\n          </Box>\n        </Page>\n      )\n    );\n  }\n\n  // Do not render anything when transitioning from one dashboard to another\n  // A bit tricky for transition to or from Home dashboard that does not have a uid in the url (but could have it in the dashboard model)\n  // if prevMatch is undefined we are going from normal route to home route or vice versa\n  if (type !== 'snapshot' && (!prevMatch || uid !== prevMatch?.params.uid)) {\n    console.log('skipping rendering');\n    return null;\n  }\n\n  return (\n    <UrlSyncContextProvider scene={dashboard} updateUrlOnInit={true} createBrowserHistorySteps={true}>\n      <DashboardPreviewBanner queryParams={queryParams} route={route.routeName} slug={slug} path={path} />\n      <dashboard.Component model={dashboard} key={dashboard.state.key} />\n      <DashboardPrompt dashboard={dashboard} />\n    </UrlSyncContextProvider>\n  );\n}\n\nexport default DashboardScenePage;\n","import { Trans, t } from '@grafana/i18n';\nimport { config } from '@grafana/runtime';\nimport { Alert } from '@grafana/ui';\nimport { useGetRepositoryFilesWithPathQuery } from 'app/api/clients/provisioning/v0alpha1';\nimport { DashboardPageRouteSearchParams } from 'app/features/dashboard/containers/types';\nimport { usePullRequestParam } from 'app/features/provisioning/hooks/usePullRequestParam';\nimport { DashboardRoutes } from 'app/types/dashboard';\n\nimport { PreviewBannerViewPR } from '../Shared/PreviewBannerViewPR';\n\nexport interface CommonBannerProps {\n  queryParams: DashboardPageRouteSearchParams;\n  path?: string;\n  slug?: string;\n}\n\ninterface DashboardPreviewBannerProps extends CommonBannerProps {\n  route?: string;\n}\n\ninterface DashboardPreviewBannerContentProps extends Required<Omit<CommonBannerProps, 'route'>> {}\n\nexport const commonAlertProps = {\n  severity: 'info' as const,\n  style: { flex: 0 } as const,\n};\n\nfunction DashboardPreviewBannerContent({ queryParams, slug, path }: DashboardPreviewBannerContentProps) {\n  const { prURL } = usePullRequestParam();\n  const file = useGetRepositoryFilesWithPathQuery({ name: slug, path, ref: queryParams.ref });\n\n  if (file.data?.errors) {\n    return (\n      <Alert\n        title={t('dashboard-scene.dashboard-preview-banner.title-error-loading-dashboard', 'Error loading dashboard')}\n        severity=\"error\"\n        style={{ flex: 0 }}\n      >\n        {file.data.errors.map((error, index) => (\n          <div key={index}>{error}</div>\n        ))}\n      </Alert>\n    );\n  }\n\n  // This page was loaded with a `pull_request_url` in the URL\n  if (prURL?.length) {\n    return <PreviewBannerViewPR prParam={prURL} isNewPr />;\n  }\n\n  // Check if this is a repo link\n  const repoUrl = file.data?.urls?.newPullRequestURL ?? file.data?.urls?.compareURL;\n  if (repoUrl) {\n    return <PreviewBannerViewPR prParam={repoUrl} />;\n  }\n\n  return (\n    <Alert\n      {...commonAlertProps}\n      title={t(\n        'dashboard-scene.dashboard-preview-banner.title-dashboard-loaded-external-repository',\n        'This dashboard is loaded from an external repository'\n      )}\n    >\n      <Trans i18nKey=\"dashboard-scene.dashboard-preview-banner.not-yet-saved\">\n        The value is not saved in the Grafana database\n      </Trans>\n    </Alert>\n  );\n}\n\nexport function DashboardPreviewBanner({ queryParams, route, slug, path }: DashboardPreviewBannerProps) {\n  const provisioningEnabled = config.featureToggles.provisioning;\n  if (!provisioningEnabled || 'kiosk' in queryParams || !path || route !== DashboardRoutes.Provisioning || !slug) {\n    return null;\n  }\n\n  return <DashboardPreviewBannerContent queryParams={queryParams} slug={slug} path={path} />;\n}\n","import { RepositorySpec, SyncOptions } from 'app/api/clients/provisioning/v0alpha1';\n\nimport { StatusInfo, RepositoryFormData } from '../types';\n\nexport type WizardStep = 'connection' | 'bootstrap' | 'finish' | 'synchronize';\n\nexport type RepoType = RepositorySpec['type'];\n\nexport interface MigrateFormData {\n  history: boolean;\n  identifier: boolean;\n}\n\nexport interface WizardFormData {\n  repository: RepositoryFormData;\n  migrate?: MigrateFormData;\n  repositoryName?: string;\n}\n\nexport type Target = SyncOptions['target'];\n\nexport interface ModeOption {\n  target: Target;\n  label: string;\n  description: string;\n  subtitle: string;\n}\n\nexport type StepStatus = 'idle' | 'running' | 'error' | 'success';\n\nexport const RepoTypeDisplay: { [key in RepoType]: string } = {\n  github: 'GitHub',\n  gitlab: 'GitLab',\n  bitbucket: 'Bitbucket',\n  git: 'Git',\n  local: 'Local',\n};\n\nexport type StepStatusInfo =\n  | { status: 'idle' | 'running' }\n  | { status: 'success'; success?: string | StatusInfo }\n  | { status: 'error'; error: string | StatusInfo }\n  | { status: 'warning'; warning: string | StatusInfo };\n\nexport type InstructionAvailability = Extract<RepoType, 'bitbucket' | 'gitlab' | 'github'>;\n","import { textUtil } from '@grafana/data';\nimport { Trans, t } from '@grafana/i18n';\nimport { Alert, Icon, Stack } from '@grafana/ui';\nimport { RepoTypeDisplay, RepoType } from 'app/features/provisioning/Wizard/types';\nimport { usePullRequestParam } from 'app/features/provisioning/hooks/usePullRequestParam';\n\nimport { commonAlertProps } from '../Dashboards/DashboardPreviewBanner';\n\n// TODO: We have this https://github.com/grafana/git-ui-sync-project/issues/166 to add more details about the PR.\n\ninterface Props {\n  prParam?: string;\n  isNewPr?: boolean;\n  behindBranch?: boolean;\n  repoUrl?: string;\n}\n\n/**\n * @description This component is used to display a banner when a provisioned dashboard/folder is created or loaded from a new branch in repo.\n */\nexport function PreviewBannerViewPR({ prParam, isNewPr, behindBranch, repoUrl }: Props) {\n  const { repoType } = usePullRequestParam();\n\n  const capitalizedRepoType = isValidRepoType(repoType) ? RepoTypeDisplay[repoType] : 'repository';\n\n  const titleText = isNewPr\n    ? t(\n        'provisioned-resource-preview-banner.title-created-branch-in-repo',\n        'A new resource has been created in a branch in {{repoType}}.',\n        {\n          repoType: capitalizedRepoType,\n        }\n      )\n    : t(\n        'provisioned-resource-preview-banner.title-loaded-pull-request-in-repo',\n        'This resource is loaded from the branch you just created in {{repoType}} and it is only visible to you',\n        {\n          repoType: capitalizedRepoType,\n        }\n      );\n\n  if (behindBranch) {\n    return (\n      <Alert\n        {...commonAlertProps}\n        buttonContent={\n          <Stack alignItems=\"center\">\n            {t('provisioned-resource-preview-banner.preview-banner.open-in-repo-button', 'Open in {{repoType}}', {\n              repoType: capitalizedRepoType,\n            })}\n            <Icon name=\"external-link-alt\" />\n          </Stack>\n        }\n        title={t(\n          'provisioned-resource-preview-banner.preview-banner.behind-branch-text',\n          'This resource is behind the branch in {{repoType}}.',\n          {\n            repoType: capitalizedRepoType,\n          }\n        )}\n        onRemove={repoUrl ? () => window.open(textUtil.sanitizeUrl(repoUrl), '_blank') : undefined}\n      >\n        <Trans\n          i18nKey=\"provisioned-resource-preview-banner.preview-banner.view-in-repo-button\"\n          values={{ repoType: capitalizedRepoType }}\n        >\n          View it in {{ repoType }} to see the latest changes.\n        </Trans>\n      </Alert>\n    );\n  }\n\n  return (\n    <Alert\n      {...commonAlertProps}\n      title={titleText}\n      buttonContent={\n        <Stack alignItems=\"center\">\n          {isNewPr\n            ? t(\n                'provisioned-resource-preview-banner.preview-banner.open-pull-request-in-repo',\n                'Open pull request in {{repoType}}',\n                { repoType: capitalizedRepoType }\n              )\n            : t(\n                'provisioned-resource-preview-banner.preview-banner.view-pull-request-in-repo',\n                'View pull request in {{repoType}}',\n                { repoType: capitalizedRepoType }\n              )}\n          <Icon name=\"external-link-alt\" />\n        </Stack>\n      }\n      onRemove={prParam ? () => window.open(textUtil.sanitizeUrl(prParam), '_blank') : undefined}\n    >\n      <Trans i18nKey=\"provisioned-resource-preview-banner.preview-banner.not-saved\">\n        The rest of Grafana users in your organization will still see the current version saved to configured default\n        branch until this branch is merged\n      </Trans>\n    </Alert>\n  );\n}\n\nexport function isValidRepoType(repoType: string | undefined): repoType is RepoType {\n  if (typeof repoType !== 'string') {\n    return false;\n  }\n  return repoType in RepoTypeDisplay;\n}\n","import * as H from 'history';\nimport { useEffect } from 'react';\n\nimport { locationService } from '@grafana/runtime';\n\ninterface PromptProps {\n  when?: boolean;\n  message: string | ((location: H.Location) => string | boolean);\n}\n\nexport const Prompt = ({ message, when = true }: PromptProps) => {\n  const history = locationService.getHistory();\n\n  useEffect(() => {\n    if (!when) {\n      return undefined;\n    }\n    //@ts-expect-error TODO Update the history package to fix types\n    const unblock = history.block(message);\n\n    return () => {\n      unblock();\n    };\n  }, [when, message, history]);\n\n  return null;\n};\n","import { textUtil } from '@grafana/data';\nimport { useUrlParams } from 'app/core/navigation/hooks';\n\nexport const usePullRequestParam = () => {\n  const [params] = useUrlParams();\n  const prParam = params.get('pull_request_url');\n  const newPrParam = params.get('new_pull_request_url');\n  const repoUrl = params.get('repo_url');\n  const repoType = params.get('repo_type');\n\n  return {\n    prURL: prParam ? textUtil.sanitizeUrl(prParam) : undefined,\n    newPrURL: newPrParam ? textUtil.sanitizeUrl(newPrParam) : undefined,\n    repoURL: repoUrl ? textUtil.sanitizeUrl(repoUrl) : undefined,\n    repoType: repoType ? textUtil.sanitizeUrl(repoType) : undefined,\n  };\n};\n","import { PageLayoutType } from '@grafana/data';\nimport { t } from '@grafana/i18n';\nimport { Alert, Box } from '@grafana/ui';\nimport { Page } from 'app/core/components/Page/Page';\nimport { EntityNotFound } from 'app/core/components/PageNotFound/EntityNotFound';\nimport { getMessageFromError, getStatusFromError } from 'app/core/utils/errors';\n\nexport function DashboardPageError({ error, type }: { error: unknown; type?: string }) {\n  const status = getStatusFromError(error);\n  const message = getMessageFromError(error);\n  const entity = type === 'snapshot' ? 'Snapshot' : 'Dashboard';\n\n  return (\n    <Page\n      navId=\"dashboards/browse\"\n      layout={PageLayoutType.Canvas}\n      pageNav={{ text: t('dashboard.dashboard-page-error.text.not-found', 'Not found') }}\n    >\n      <Box paddingY={4} display=\"flex\" direction=\"column\" alignItems=\"center\">\n        {status === 404 ? (\n          <EntityNotFound entity={entity} />\n        ) : (\n          <Alert\n            title={t('dashboard.errors.failed-to-load', 'Failed to load dashboard')}\n            severity=\"error\"\n            data-testid=\"dashboard-page-error\"\n          >\n            {message}\n          </Alert>\n        )}\n      </Box>\n    </Page>\n  );\n}\n"],"names":["DashboardPrompt","dashboard","originalPath","showModal","hideModal","ModalsContext","handleUnload","event","ignoreChanges","onHistoryBlock","location","panelEditor","vizPanel","search","libPanelBehavior","SaveLibraryVizPanelModal","moveToBlockedLocationAfterReactStateUpdate","UnsavedChangesModal","Prompt","onDiscard","onDismiss","onSaveDashboardClick","styles","getStyles","Modal","Button","scene","canSave","fromScript","fromFile","DashboardScenePage","route","queryParams","params","type","slug","uid","path","prevMatch","usePrevious","stateManager","isLoading","loadError","routeReloadCounter","prevParams","correctedUrl","errorElement","DashboardPageError","Page","Box","PageLoader","DashboardPreviewBanner","commonAlertProps","DashboardPreviewBannerContent","prURL","file","error","index","repoUrl","RepoTypeDisplay","PreviewBannerViewPR","prParam","isNewPr","behindBranch","repoType","usePullRequestParam","capitalizedRepoType","isValidRepoType","titleText","Alert","Stack","Icon","message","when","history","unblock","newPrParam","status","entity"],"sourceRoot":""}