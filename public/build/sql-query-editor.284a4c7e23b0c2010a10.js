"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[168],{1667:(U,M,n)=>{n.d(M,{D:()=>w});var e=n(96540),i=n(46936);const w=({children:b})=>e.createElement(i.C,{gap:.5,direction:"column"},b)},6904:(U,M,n)=>{n.d(M,{X:()=>b});var e=n(22803),i=n(96540),w=n(63142);const b=({children:O})=>{const C=(0,w.of)(T);return i.createElement("div",{className:C.root},O)},T=O=>({root:(0,e.css)({display:"flex",flexWrap:"wrap",alignItems:"center",gap:O.spacing(3),minHeight:O.spacing(4)})})},20301:(U,M,n)=>{n.d(M,{Z:()=>T});var e=n(22803),i=n(96540),w=n(45861),b=n(63142);const T=({className:C,...R})=>{const I=(0,b.of)(O);return i.createElement(w.$n,{...R,className:(0,e.cx)(C,I.button)})},O=C=>({button:(0,e.css)({paddingLeft:C.spacing(3/2),paddingRight:C.spacing(3/2)})})},26774:(U,M,n)=>{n.d(M,{o:()=>b});var e=n(45861),i=n(96540),w=n(46936);const b=i.forwardRef(function({items:O,renderItem:C,onChange:R},I){const r=()=>{const $=[...O,{}];R($)},V=($,L)=>{const F=[...O];F[$]=L,R(F)},N=$=>{const L=[...O];L.splice($,1),R(L)};return i.createElement(w.C,null,O.map(($,L)=>i.createElement("div",{key:L},C($,F=>V(L,F),()=>N(L)))),i.createElement(e.$n,{ref:I,onClick:r,variant:"secondary",size:"md",icon:"plus","aria-label":"Add",type:"button"}))})},32300:(U,M,n)=>{n.d(M,{U:()=>T});var e=n(22803),i=n(96540),w=n(63142),b=n(46936);const T=({children:C})=>{const R=(0,w.of)(O);return i.createElement("div",{className:R.root},i.createElement(b.C,{gap:2},C))},O=C=>({root:(0,e.css)({padding:C.spacing(1),backgroundColor:C.colors.background.secondary,borderRadius:C.shape.radius.default})})},40263:(U,M,n)=>{n.d(M,{Z:()=>i});var e=n(96540);const i=({grow:w,shrink:b})=>e.createElement("div",{style:{display:"block",flexGrow:w,flexShrink:b}})},46936:(U,M,n)=>{n.d(M,{C:()=>w});var e=n(96540),i=n(41654);const w=({children:b,wrap:T=!0,...O})=>{var C,R;return e.createElement(i.B,{wrap:T?"wrap":void 0,direction:(C=O.direction)!=null?C:"row",gap:(R=O.gap)!=null?R:2,...O},b)}},47805:(U,M,n)=>{n.r(M),n.d(M,{default:()=>ht});var e=n(74848),i=n(96540),w=n(16817),b=n(41778),T=n(35137),O=n(81045),C=n(25274),R=n(73287),I=n(51898),r=n(92745),V=n(6904),N=n(75686),$=n(40263),L=n(32300),F=n(30048),K=n(27489),ee=n(21285),z=n(45861),ce=n(45967),de=n(77824),X=n(11194),P=n(22803),q=n(63142),oe=n(22787),re=n(30703);function Ee({isOpen:t,onCancel:a,onDiscard:s,onCopy:o}){const c=(0,i.useRef)(null),l=(0,q.of)(Se);return(0,i.useEffect)(()=>{t&&c.current?.focus()},[t]),(0,e.jsxs)(oe.a,{title:(0,e.jsxs)("div",{className:l.modalHeaderTitle,children:[(0,e.jsx)(re.I,{name:"exclamation-triangle",size:"lg"}),(0,e.jsx)("span",{className:l.titleText,children:(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.confirm-modal.warning",children:"Warning"})})]}),onDismiss:a,isOpen:t,children:[(0,e.jsx)("p",{children:(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.confirm-modal.builder-mode",children:"Builder mode does not display changes made in code. The query builder will display the last changes you made in builder mode."})}),(0,e.jsx)("p",{children:(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.confirm-modal.clipboard",children:"Do you want to copy your code to the clipboard?"})}),(0,e.jsxs)(oe.a.ButtonRow,{children:[(0,e.jsx)(z.$n,{type:"button",variant:"secondary",onClick:a,fill:"outline",children:(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.confirm-modal.cancel",children:"Cancel"})}),(0,e.jsx)(z.$n,{variant:"destructive",type:"button",onClick:s,ref:c,children:(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.confirm-modal.discard-code-and-switch",children:"Discard code and switch"})}),(0,e.jsx)(z.$n,{variant:"primary",onClick:o,children:(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.confirm-modal.copy-code-and-switch",children:"Copy code and switch"})})]})]})}const Se=t=>({titleText:(0,P.css)({paddingLeft:t.spacing(2)}),modalHeaderTitle:(0,P.css)({fontSize:t.typography.size.lg,float:"left",paddingTop:t.spacing(1),margin:t.spacing(0,2)})});var W=n(18857);const we=({dataset:t,db:a,dialect:s,onChange:o,inputId:c,preconfiguredDataset:l})=>{const m=!!l||s==="postgres",d=(0,w.A)(async()=>m?(o((0,X.zL)(l)),[(0,X.zL)(l)]):(t&&o((0,X.zL)(t)),(await a.datasets()).map(X.zL)),[]);return(0,e.jsx)(W.l6,{"aria-label":(0,r.t)("grafana-sql.components.dataset-selector.aria-label-dataset-selector","Dataset selector"),inputId:c,value:t,options:d.value,onChange:o,disabled:d.loading,isLoading:d.loading,menuShouldPortal:!0})};var k=n(47184);const Ie=({db:t,dataset:a,table:s,className:o,onChange:c,inputId:l})=>{const m=(0,w.A)(async()=>a?(await t.tables(a)).map(k.z):[],[a]);return(0,e.jsx)(W.l6,{className:o,disabled:m.loading,"aria-label":(0,r.t)("grafana-sql.components.table-selector.aria-label-table-selector","Table selector"),inputId:l,"data-testid":I.Tp.components.SQLQueryEditor.headerTableSelector,value:s,options:m.value,onChange:c,isLoading:m.loading,menuShouldPortal:!0,placeholder:m.loading?(0,r.t)("grafana-sql.components.table-selector.placeholder-loading","Loading tables"):(0,r.t)("grafana-sql.components.table-selector.placeholder-select-table","Select table"),allowCustomValue:!0})};function Oe({db:t,dialect:a,isQueryRunnable:s,onChange:o,onQueryRowChange:c,onRunQuery:l,preconfiguredDataset:m,query:d,queryRowFilter:g}){const{editorMode:p}=d,[v,x]=(0,R.A)(),[f,u]=(0,i.useState)(!1),h=t.toRawSql,y=(0,i.useId)(),j=[{label:(0,r.t)("grafana-sql.components.query-header.editor-modes.label-builder","Builder"),value:b.lX.Builder},{label:(0,r.t)("grafana-sql.components.query-header.editor-modes.label-code","Code"),value:b.lX.Code}],Q=(0,i.useCallback)(S=>{if(S===b.lX.Code&&(0,K.rR)("grafana_sql_editor_mode_changed",{datasource:d.datasource?.type,selectedEditorMode:b.lX.Code}),p===b.lX.Code){u(!0);return}o({...d,editorMode:S})},[p,o,d]),D=S=>{const G={...d,format:S.value!==void 0?S.value:X.gv.Table};(0,K.rR)("grafana_sql_format_changed",{datasource:d.datasource?.type,selectedFormat:G.format}),o(G)},A=S=>{if(S.value===d.dataset)return;const G={...d,dataset:S.value,table:void 0,sql:void 0,rawSql:""};o(G)},_=S=>{if(S.value===d.table)return;const G={...d,table:S.value,sql:void 0,rawSql:""};o(G)},B=()=>a!=="influx";return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(V.X,{children:[(0,e.jsx)(N.W,{label:(0,r.t)("grafana-sql.components.query-header.label-format","Format"),value:d.format,placeholder:(0,r.t)("grafana-sql.components.query-header.placeholder-select-format","Select format"),menuShouldPortal:!0,onChange:D,options:X.cO}),p===b.lX.Builder&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(ee.K,{id:`sql-filter-${y}`,label:(0,r.t)("grafana-sql.components.query-header.label-filter","Filter"),"data-testid":I.Tp.components.SQLQueryEditor.headerFilterSwitch,transparent:!0,showLabel:!0,value:g.filter,onChange:S=>{S.target instanceof HTMLInputElement&&((0,K.rR)("grafana_sql_filter_toggled",{datasource:d.datasource?.type,displayed:S.target.checked}),c({...g,filter:S.target.checked}))}}),(0,e.jsx)(ee.K,{id:`sql-group-${y}`,label:(0,r.t)("grafana-sql.components.query-header.label-group","Group"),"data-testid":I.Tp.components.SQLQueryEditor.headerGroupSwitch,transparent:!0,showLabel:!0,value:g.group,onChange:S=>{S.target instanceof HTMLInputElement&&((0,K.rR)("grafana_sql_group_toggled",{datasource:d.datasource?.type,displayed:S.target.checked}),c({...g,group:S.target.checked}))}}),(0,e.jsx)(ee.K,{id:`sql-order-${y}`,label:(0,r.t)("grafana-sql.components.query-header.label-order","Order"),"data-testid":I.Tp.components.SQLQueryEditor.headerOrderSwitch,transparent:!0,showLabel:!0,value:g.order,onChange:S=>{S.target instanceof HTMLInputElement&&((0,K.rR)("grafana_sql_order_toggled",{datasource:d.datasource?.type,displayed:S.target.checked}),c({...g,order:S.target.checked}))}}),(0,e.jsx)(ee.K,{id:`sql-preview-${y}`,label:(0,r.t)("grafana-sql.components.query-header.label-preview","Preview"),"data-testid":I.Tp.components.SQLQueryEditor.headerPreviewSwitch,transparent:!0,showLabel:!0,value:g.preview,onChange:S=>{S.target instanceof HTMLInputElement&&((0,K.rR)("grafana_sql_preview_toggled",{datasource:d.datasource?.type,displayed:S.target.checked}),c({...g,preview:S.target.checked}))}})]}),(0,e.jsx)($.Z,{grow:1}),s?(0,e.jsx)(z.$n,{icon:"play",variant:"primary",size:"sm",onClick:()=>l(),children:(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.query-header.run-query",children:"Run query"})}):(0,e.jsx)(ce.m,{theme:"error",content:(0,e.jsxs)(r.x6,{i18nKey:"grafana-sql.components.query-header.content-invalid-query",children:["Your query is invalid. Check below for details. ",(0,e.jsx)("br",{}),"However, you can still run this query."]}),placement:"top",children:(0,e.jsx)(z.$n,{icon:"exclamation-triangle",variant:"secondary",size:"sm",onClick:()=>l(),children:(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.query-header.run-query",children:"Run query"})})}),(0,e.jsx)(de.z,{options:j,size:"sm",value:p,onChange:Q}),(0,e.jsx)(Ee,{isOpen:f,onCopy:()=>{(0,K.rR)("grafana_sql_editor_mode_changed",{datasource:d.datasource?.type,selectedEditorMode:b.lX.Builder,type:"copy"}),u(!1),x(d.rawSql),o({...d,rawSql:h(d),editorMode:b.lX.Builder})},onDiscard:()=>{(0,K.rR)("grafana_sql_editor_mode_changed",{datasource:d.datasource?.type,selectedEditorMode:b.lX.Builder,type:"discard"}),u(!1),o({...d,rawSql:h(d),editorMode:b.lX.Builder})},onCancel:()=>{(0,K.rR)("grafana_sql_editor_mode_changed",{datasource:d.datasource?.type,selectedEditorMode:b.lX.Builder,type:"cancel"}),u(!1)}})]}),p===b.lX.Builder&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(T.$,{v:.5}),(0,e.jsxs)(L.U,{children:[B()&&(0,e.jsx)(F.c,{label:(0,r.t)("grafana-sql.components.query-header.label-dataset","Dataset"),width:25,children:(0,e.jsx)(we,{db:t,inputId:`sql-dataset-${y}`,dataset:d.dataset,dialect:a,preconfiguredDataset:m,onChange:A})}),(0,e.jsx)(F.c,{label:(0,r.t)("grafana-sql.components.query-header.label-table","Table"),width:25,children:(0,e.jsx)(Ie,{db:t,inputId:`sql-tableselect-${y}`,dataset:d.dataset||m,table:d.table,onChange:_})})]})]})]})}var ue=n(49185),Te=n(70713),Me=n(14170);function De({children:t,onChange:a,query:s,width:o,height:c,editorLanguageDefinition:l}){const m=(0,i.useRef)(s);(0,i.useEffect)(()=>{m.current=s},[s]);const d=(0,i.useCallback)((g,p)=>{const v={...m.current,rawQuery:!0,rawSql:g};a(v,p)},[a]);return(0,e.jsx)(Me.Y,{width:o,height:c,query:s.rawSql,onChange:d,language:l,children:t})}var Z=n(41654),me=n(76319),Re=n(41053),Be=n(40996),pe=n(55386),Le=n(68079);function Pe({db:t,query:a,onValidate:s,range:o}){const[c,l]=(0,i.useState)(),m=(0,q.$j)(),d=(0,i.useMemo)(()=>(0,pe.j_)("bytes"),[]),g=(0,i.useMemo)(()=>({error:(0,P.css)({color:m.colors.error.text,fontSize:m.typography.bodySmall.fontSize,fontFamily:m.typography.fontFamilyMonospace}),valid:(0,P.css)({color:m.colors.success.text}),info:(0,P.css)({color:m.colors.text.secondary})}),[m]),[p,v]=(0,Re.A)(async f=>f.rawSql?.trim()===""?null:await t.validateQuery(f,o),[t]),[,]=(0,Be.A)(async()=>{const f=await v(a);return f&&l(f),null},1e3,[a,v]);if((0,i.useEffect)(()=>{c?.isError&&s(!1),c?.isValid&&s(!0)},[c,s]),!p.value&&!p.loading)return null;const x=p.value?.error?Fe(p.value.error):"";return(0,e.jsxs)(e.Fragment,{children:[p.loading&&(0,e.jsxs)("div",{className:g.info,children:[(0,e.jsx)(Le.y,{inline:!0,size:"xs"})," ",(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.query-validator.validating-query",children:"Validating query..."})]}),!p.loading&&p.value&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(e.Fragment,{children:p.value.isValid&&p.value.statistics&&(0,e.jsx)("div",{className:g.valid,children:(0,e.jsxs)(r.x6,{i18nKey:"grafana-sql.components.query-validator.query-will-process",values:{bytes:(0,pe.cN)(d(p.value.statistics.TotalBytesProcessed))},children:[(0,e.jsx)(re.I,{name:"check"})," This query will process ",(0,e.jsx)("strong",{children:"{{bytes}}"})," when run."]})})}),(0,e.jsx)(e.Fragment,{children:p.value.isError&&(0,e.jsx)("div",{className:g.error,children:x})})]})]})}function Fe(t){const a=t.split(":");return a.length>2?a.slice(2).join(":"):t}function fe({showTools:t,onFormatCode:a,onExpand:s,isExpanded:o,...c}){const l=(0,q.$j)(),[m,d]=(0,i.useState)(),g=(0,i.useMemo)(()=>({container:(0,P.css)({border:`1px solid ${l.colors.border.medium}`,borderTop:"none",padding:l.spacing(.5,.5,.5,.5),display:"flex",flexGrow:1,justifyContent:"space-between",fontSize:l.typography.bodySmall.fontSize}),error:(0,P.css)({color:l.colors.error.text,fontSize:l.typography.bodySmall.fontSize,fontFamily:l.typography.fontFamilyMonospace}),valid:(0,P.css)({color:l.colors.success.text}),info:(0,P.css)({color:l.colors.text.secondary}),hint:(0,P.css)({color:l.colors.text.disabled,whiteSpace:"nowrap",cursor:"help"})}),[l]);let p={};return!t&&m===void 0&&(p={height:0,padding:0,visibility:"hidden"}),(0,e.jsxs)("div",{className:g.container,style:p,children:[(0,e.jsx)("div",{children:c.onValidate&&(0,e.jsx)(Pe,{...c,onValidate:v=>{d(v),c.onValidate(v)}})}),t&&(0,e.jsx)("div",{children:(0,e.jsxs)(Z.B,{gap:1,children:[a&&(0,e.jsx)(me.K,{onClick:()=>{(0,K.rR)("grafana_sql_query_formatted",{datasource:c.query.datasource?.type}),a()},name:"brackets-curly",size:"xs",tooltip:(0,r.t)("grafana-sql.components.query-toolbox.tooltip-format-query","Format query")}),s&&(0,e.jsx)(me.K,{onClick:()=>{(0,K.rR)("grafana_sql_editor_expand",{datasource:c.query.datasource?.type,expanded:!o}),s(!o)},name:o?"angle-up":"angle-down",size:"xs",tooltip:o?(0,r.t)("grafana-sql.components.query-toolbox.tooltip-collapse","Collapse editor"):(0,r.t)("grafana-sql.components.query-toolbox.tooltip-expand","Expand editor")}),(0,e.jsx)(ce.m,{content:(0,r.t)("grafana-sql.components.query-toolbox.content-hit-ctrlcmdreturn-to-run-query","Hit CTRL/CMD+Return to run query"),children:(0,e.jsx)(re.I,{className:g.hint,name:"keyboard"})})]})})]})}function Ae({db:t,query:a,onChange:s,onRunQuery:o,onValidate:c,queryToValidate:l,range:m}){const d=(0,q.$j)(),g=(0,q.of)($e),[p,v]=(0,i.useState)(!1),[x,f]=(0,ue.A)(),[u,h]=(0,ue.A)(),y=(0,i.useMemo)(()=>t.getEditorLanguageDefinition(),[t]),j=(A,_)=>(0,e.jsx)(De,{editorLanguageDefinition:y,query:a,width:A,height:_?_-f.height:void 0,onChange:s,children:({formatQuery:B})=>(0,e.jsx)("div",{ref:x,children:(0,e.jsx)(fe,{db:t,query:l,onValidate:c,onFormatCode:B,showTools:!0,range:m,onExpand:v,isExpanded:p})})}),Q=(A=!1)=>A?(0,e.jsx)(Te.Ay,{children:({width:_,height:B})=>j(_,B)}):(0,e.jsx)("div",{ref:u,children:j()}),D=()=>(0,e.jsx)("div",{style:{width:h.width,height:h.height,background:d.colors.background.primary,display:"flex",alignItems:"center",justifyContent:"center"},children:(0,e.jsx)(r.x6,{i18nKey:"grafana-sql.components.raw-editor.render-placeholder.editing-in-expanded-code-editor",children:"Editing in expanded code editor"})});return(0,e.jsxs)(e.Fragment,{children:[p?D():Q(),p&&(0,e.jsx)(oe.a,{title:(0,r.t)("grafana-sql.components.raw-editor.title-query-num","Query {{queryNum}}",{queryNum:a.refId}),closeOnBackdropClick:!1,closeOnEscape:!1,className:g.modal,contentClassName:g.modalContent,isOpen:p,onDismiss:()=>{(0,K.rR)("grafana_sql_editor_expand",{datasource:a.datasource?.type,expanded:!1}),v(!1)},children:Q(!0)})]})}function $e(t){return{modal:(0,P.css)({width:"95vw",height:"95vh"}),modalContent:(0,P.css)({height:"100%",paddingTop:0})}}var Qe=n(1667),Ke=n(27074);function ge(t,a){if(!a||!t.sql?.columns)return a;const s=t.sql.columns.map((o,c)=>{const l=o.name?`${o.name}(${o.parameters?.map(m=>m.name).join(", ")})`:o.parameters?.map(m=>m.name).join(", ");return{value:l,label:`${c+1} - ${l}`}});return[{value:"",label:(0,r.t)("grafana-sql.utils.get-columns-width-indices.label-selected-columns","Selected columns"),options:s,expanded:!0},...a]}function te({query:t,onQueryChange:a,db:s}){return{onSqlChange:(0,i.useCallback)(c=>{const l=s.toRawSql,m=l({sql:c,dataset:t.dataset,table:t.table,refId:t.refId}),d={...t,sql:c,rawSql:m};a(d)},[s,a,t])}}var We=n(26774),he=n(72500),Ne=n(20301);function ze({sql:t,columns:a,onSqlChange:s}){const o=(0,i.useCallback)(c=>{const l=c.map(d=>(0,C.xG)(d.property?.name)),m={...t,groupBy:l};s(m)},[s,t]);return(0,e.jsx)(We.o,{items:t.groupBy,onChange:o,renderItem:Ue({options:a})})}function Ue({options:t}){return function(s,o,c){return(0,e.jsxs)(he.M,{children:[(0,e.jsx)(W.l6,{value:s.property?.name?(0,k.z)(s.property.name):null,"aria-label":(0,r.t)("grafana-sql.components.make-render-column.render-column.aria-label-group-by","Group by"),options:t,menuShouldPortal:!0,onChange:({value:l})=>l&&o((0,C.xG)(l))}),(0,e.jsx)(Ne.Z,{"aria-label":(0,r.t)("grafana-sql.components.make-render-column.render-column.title-remove-group-by-column","Remove group by column"),icon:"times",variant:"secondary",onClick:c})]})}}function Ve({fields:t,query:a,onQueryChange:s,db:o}){const{onSqlChange:c}=te({query:a,onQueryChange:s,db:o});let l=ge(a,t);return(0,e.jsx)(ze,{columns:l,sql:a.sql,onSqlChange:c})}var Y=n(2543),H=n(63527);const qe=[{description:"Sort by ascending",value:"ASC",icon:"sort-amount-up"},{description:"Sort by descending",value:"DESC",icon:"sort-amount-down"}];function _e({sql:t,onSqlChange:a,columns:s,showOffset:o}){const c=(0,i.useCallback)(g=>{const p={...t,orderByDirection:g};a(p)},[a,t]),l=(0,i.useCallback)(g=>{const p={...t,limit:Number.parseInt(g.currentTarget.value,10)};a(p)},[a,t]),m=(0,i.useCallback)(g=>{const p={...t,offset:Number.parseInt(g.currentTarget.value,10)};a(p)},[a,t]),d=(0,i.useCallback)(g=>{const p={...t,orderBy:(0,C.Kj)(g?.value)};g===null&&(p.orderByDirection=void 0),a(p)},[a,t]);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(F.c,{label:(0,r.t)("grafana-sql.components.order-by-row.label-order-by","Order by"),width:25,children:(0,e.jsxs)(he.M,{children:[(0,e.jsx)(W.l6,{"aria-label":(0,r.t)("grafana-sql.components.order-by-row.aria-label-order-by","Order by"),options:s,value:t.orderBy?.property.name?(0,k.z)(t.orderBy.property.name):null,isClearable:!0,menuShouldPortal:!0,onChange:d}),(0,e.jsx)(T.$,{h:1.5}),(0,e.jsx)(de.z,{options:qe,disabled:!t?.orderBy?.property.name,value:t.orderByDirection,onChange:c})]})}),(0,e.jsx)(F.c,{label:(0,r.t)("grafana-sql.components.order-by-row.label-limit","Limit"),optional:!0,width:25,children:(0,e.jsx)(H.p,{type:"number",min:0,id:(0,Y.uniqueId)("limit-"),value:t.limit||"",onChange:l})}),o&&(0,e.jsx)(F.c,{label:(0,r.t)("grafana-sql.components.order-by-row.label-offset","Offset"),optional:!0,width:25,children:(0,e.jsx)(H.p,{type:"number",id:(0,Y.uniqueId)("offset-"),value:t.offset||"",onChange:m})})]})}function Ge({fields:t,query:a,onQueryChange:s,db:o}){const{onSqlChange:c}=te({query:a,onQueryChange:s,db:o});let l=ge(a,t);return(0,e.jsx)(_e,{sql:a.sql,onSqlChange:c,columns:l})}var Xe=n(2863),E=n(32901),ve=n(25229),ke=n(27282);const le={add:"Add",remove:"Remove"},ye={id:E.Aq.uuid(),type:"group"},xe="timeFilter",be=[xe],He={...E.d$.widgets,text:{...E.d$.widgets.text,factory:function(a){return(0,e.jsx)(H.p,{value:a?.value||"",placeholder:a?.placeholder,onChange:s=>a?.setValue(s.currentTarget.value)})}},number:{...E.d$.widgets.number,factory:function(a){return(0,e.jsx)(H.p,{value:a?.value,placeholder:a?.placeholder,type:"number",onChange:s=>a?.setValue(Number.parseInt(s.currentTarget.value,10))})}},datetime:{...E.d$.widgets.datetime,factory:function(a){if(a?.operator==="macros")return(0,e.jsx)(W.l6,{id:a.id,"aria-label":(0,r.t)("grafana-sql.components.widgets.aria-label-macros-value-selector","Macros value selector"),menuShouldPortal:!0,options:be.map(k.z),value:a?.value,onChange:o=>a.setValue(o.value)});const s=(0,ve.KQ)(a?.value).isValid()?(0,ve.KQ)(a?.value).utc():void 0;return(0,e.jsx)(ke.K,{onChange:o=>{a?.setValue(o?.format(E.d$.widgets.datetime.valueFormat))},date:s})},sqlFormatValue:(t,a,s,o,c,l)=>o==="macros"?be.includes(t)?t:void 0:typeof E.d$.widgets.datetime.sqlFormatValue=="string"||typeof E.d$.widgets.datetime.sqlFormatValue=="object"?void 0:E.d$.widgets.datetime.sqlFormatValue?.call(E.d$.ctx,t,a,s,o,c,l)||""}},Je={...E.d$.settings,canRegroup:!1,maxNesting:1,canReorder:!1,showNot:!1,addRuleLabel:le.add,deleteLabel:le.remove,renderConjs:function(a){return(0,e.jsx)(W.l6,{id:a?.id,"aria-label":(0,r.t)("grafana-sql.components.settings.aria-label-conjunction","Conjunction"),"data-testid":I.Tp.components.SQLQueryEditor.filterConjunction,menuShouldPortal:!0,options:a?.conjunctionOptions?Object.keys(a?.conjunctionOptions).map(k.z):void 0,value:a?.selectedConjunction,onChange:s=>a?.setConjunction(s.value)})},renderField:function(a){const s=a?.config?.fields||{};return(0,e.jsx)(W.l6,{id:a?.id,width:25,"aria-label":(0,r.t)("grafana-sql.components.settings.aria-label-field","Field"),"data-testid":I.Tp.components.SQLQueryEditor.filterField,menuShouldPortal:!0,options:a?.items.map(o=>{const c=s[o.key].mainWidgetProps?.customProps?.icon;return{label:o.label,value:o.key,icon:c}}),value:a?.selectedKey,onChange:o=>{a?.setField(o.label)}})},renderButton:function(a){return(0,e.jsx)(z.$n,{type:"button","aria-label":(0,r.t)("grafana-sql.components.settings.title-button-filter","{{ buttonLabel }} filter",{buttonLabel:a?.label}),onClick:a?.onClick,variant:"secondary",size:"md",icon:a?.label===le.add?"plus":"times"})},renderOperator:function(a){return(0,e.jsx)(W.l6,{options:a?.items.map(s=>({label:s.label,value:s.key})),"aria-label":(0,r.t)("grafana-sql.components.settings.aria-label-operator","Operator"),"data-testid":I.Tp.components.SQLQueryEditor.filterOperator,menuShouldPortal:!0,value:a?.selectedKey,onChange:s=>{a?.setField(s.value||"")}})}};var Ze=(t=>(t.IN="select_any_in",t.NOT_IN="select_not_any_in",t.MACROS="macros",t))(Ze||{});const Ye=st(E.d$),je=E.d$.types.text.widgets.text,et=[...je.operators||[],"select_any_in","select_not_any_in"],tt={...je,operators:et},at={...E.d$.types,text:{...E.d$.types.text,widgets:{...E.d$.types.text.widgets,text:tt}},datetime:{...E.d$.types.datetime,widgets:{...E.d$.types.datetime.widgets,datetime:{...E.d$.types.datetime.widgets.datetime,operators:["macros",...E.d$.types.datetime.widgets.datetime.operators||[]]}}}},nt={...E.d$,widgets:He,settings:Je,operators:Ye,types:at},ae=()=>"";function st(t){const{...a}=t.operators,s=a.select_any_in.sqlFormatOp?.bind(t.ctx)||ae,o=a.select_any_in.formatOp?.bind(t.ctx)||ae,c=(p,v,x,f,u,h,y,j)=>s(p,v,ne(x),f,u,h,y,j),l=a.select_not_any_in.sqlFormatOp?.bind(t.ctx)||ae,m=a.select_not_any_in.formatOp?.bind(t.ctx)||ae,d=(p,v,x,f,u,h,y,j)=>l(p,v,ne(x),f,u,h,y,j);return{...a,select_any_in:{...a.select_any_in,formatOp:(p,v,x,f)=>o(p,v,ne(x),f),sqlFormatOp:c},select_not_any_in:{...a.select_not_any_in,formatOp:(p,v,x,f)=>m(p,v,ne(x),f),sqlFormatOp:d},macros:{label:(0,r.t)("grafana-sql.components.get-custom-operators.custom-operators.label.macros","Macros"),sqlFormatOp:(p,v,x)=>{if(x===xe)return`$__timeFilter(${p})`;throw new Error("Invalid macro")}}}}function ne(t){return(0,Y.isString)(t)?t.split(","):t}function ot({sql:t,config:a,onSqlChange:s}){const[o,c]=(0,i.useState)(),l=(0,i.useMemo)(()=>({...nt,...a}),[a]);(0,i.useEffect)(()=>{if(!o){const d=E.Aq.checkTree(E.Aq.loadTree(t.whereJsonTree??ye),l);c(d)}},[l,t.whereJsonTree,o]),(0,i.useEffect)(()=>{t.whereJsonTree||c(E.Aq.checkTree(E.Aq.loadTree(ye),l))},[l,t.whereJsonTree]);const m=(0,i.useCallback)((d,g)=>{c(d);const p={...t,whereJsonTree:E.Aq.getTree(d),whereString:E.Aq.sqlFormat(d,g)};s(p)},[s,t]);return o?(0,e.jsx)(E.XK,{...l,value:o,onChange:m,renderBuilder:d=>(0,e.jsx)(E.M$,{...d})}):null}function se(t){return`
    display: flex;
    gap: 8px;
    flex-direction: ${t};`}(0,P.injectGlobal)`
  .group--header {
    ${se("row")}
  }

  .group-or-rule {
    ${se("column")}
    .rule {
      flex-direction: row;
    }
  }

  .rule--body {
    ${se("row")}
  }

  .group--children {
    ${se("column")}
  }

  .group--conjunctions:empty {
    display: none;
  }
`;function rt({query:t,fields:a,onQueryChange:s,db:o}){const c=(0,w.A)(async()=>lt(a),[a]),{onSqlChange:l}=te({query:t,onQueryChange:s,db:o});return(0,e.jsx)(ot,{config:{fields:c.value||{}},sql:t.sql,onSqlChange:m=>{const d=(0,Xe.w)().getVariables();it(m,d),l(m)}},JSON.stringify(c.value))}function lt(t){const a={};for(const s of t)a[s.value]={type:s.raqbFieldType||"text",valueSources:["value"],mainWidgetProps:{customProps:{icon:s.icon}}};return a}function it(t,a){const s=o=>"multi"in o&&o.multi&&(t.whereString?.includes(`\${${o.name}}`)||t.whereString?.includes(`$${o.name}`));a.some(o=>s(o))&&(t.whereString=t.whereString?.replaceAll("')",")"),t.whereString=t.whereString?.replaceAll("('","("))}var ie=n(36656),J=n(79233);function Ce({columns:t,onParameterChange:a,value:s}){const o=(0,i.useId)();return(0,e.jsx)(F.c,{label:(0,r.t)("grafana-sql.components.select-column.label-column","Column"),width:25,children:(0,e.jsx)(W.l6,{value:s,"data-testid":I.Tp.components.SQLQueryEditor.selectColumn,inputId:o,menuShouldPortal:!0,options:[{label:"*",value:"*"},...t],allowCustomValue:!0,onChange:c=>a(c.value)})})}function ct({columns:t,query:a,onSqlChange:s,onParameterChange:o,currentColumnIndex:c}){const l=(0,q.of)(dt),m=a.sql?.columns?.[c],d=(0,i.useCallback)(v=>{const x=a.sql?.columns?.[v];if(!x)return;x.parameters=x.parameters?[...x.parameters,{type:ie._.FunctionParameter,name:""}]:[];const f={...a.sql,columns:a.sql?.columns?.map((u,h)=>h===v?x:u)};s(f)},[s,a.sql]),g=(0,i.useCallback)((v,x)=>{const f=a.sql?.columns?.[v];if(!f?.parameters)return;f.parameters=f.parameters?.filter((h,y)=>y!==x);const u={...a.sql,columns:a.sql?.columns?.map((h,y)=>y===v?f:h)};s(u)},[s,a.sql]);function p(v){return!m?.parameters||m.parameters.length<=1?null:m.parameters.map((f,u)=>u===0?null:(0,e.jsxs)(Z.B,{gap:2,children:[(0,e.jsx)(J.c,{className:l.label,children:","}),(0,e.jsx)(H.p,{onChange:h=>o(u)(h.currentTarget.value),value:f.name,"aria-label":(0,r.t)("grafana-sql.components.select-custom-function-parameters.aria-label-parameter","Parameter {{index}} for column {{columnIndex}}",{index:u,columnIndex:v}),"data-testid":I.Tp.components.SQLQueryEditor.selectInputParameter,addonAfter:(0,e.jsx)(z.$n,{"aria-label":(0,r.t)("grafana-sql.components.select-custom-function-parameters.render-parameters.params.title-remove-parameter","Remove parameter"),type:"button",icon:"times",variant:"secondary",size:"md",onClick:()=>g(v,u)})})]},u))}return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(J.c,{className:l.label,children:"("}),(0,e.jsx)(Ce,{columns:t,onParameterChange:v=>o(0)(v),value:(0,C.oG)(m?.parameters?.[0])}),p(c),(0,e.jsx)(z.$n,{type:"button",onClick:()=>d(c),variant:"secondary",size:"md",icon:"plus","aria-label":(0,r.t)("grafana-sql.components.select-custom-function-parameters.title-add-parameter","Add parameter")}),(0,e.jsx)(J.c,{className:l.label,children:")"})]})}const dt=()=>({label:(0,P.css)({padding:0,margin:0,width:"unset"})});function ut({query:t,onSqlChange:a,currentColumnIndex:s,db:o,columns:c}){const l=(0,i.useId)(),m=t.sql?.columns?.[s],d=(0,q.of)(mt),g=o.functions().find(u=>u.name===m?.name),[p,v]=(0,i.useState)([]);(0,i.useEffect)(()=>{(async()=>{if(!g)return;const h=[];for(const y of g.parameters??[])y.options?h.push(await y.options(t)):h.push([]);v(h)})()},[m?.name]);const x=(0,i.useCallback)((u,h)=>y=>{const j=t.sql?.columns?.[s];if(!j)return;j.parameters||(j.parameters=[]),j.parameters[u]===void 0?j.parameters[u]={type:ie._.FunctionParameter,name:y}:y==null&&h?(j.parameters=j.parameters.map((D,A)=>A===u?{...D,name:""}:D),j.parameters[j.parameters.length-1]?.name===""&&(j.parameters=j.parameters.filter(D=>D.name!==""))):y==null?j.parameters=j.parameters.filter((D,A)=>A!==u):j.parameters=j.parameters.map((D,A)=>A===u?{...D,name:y}:D);const Q={...t.sql,columns:t.sql?.columns?.map((D,A)=>A===s?j:D)};a(Q)},[s,a,t.sql]);function f(){return g?.parameters?g?.parameters.map((u,h)=>(0,e.jsxs)(Z.B,{alignItems:"flex-end",gap:2,children:[(0,e.jsx)(F.c,{label:u.name,width:25,optional:!u.required,children:(0,e.jsx)(e.Fragment,{children:u.options?(0,e.jsx)(W.l6,{value:(0,C.oG)(m?.parameters[h]),options:p?.[h],"data-testid":I.Tp.components.SQLQueryEditor.selectFunctionParameter(u.name),inputId:l,menuShouldPortal:!0,allowCustomValue:!0,isClearable:!0,onChange:y=>x(h,!0)(y?.value)}):(0,e.jsx)(H.p,{onChange:y=>x(h,!0)(y.currentTarget.value),value:m?.parameters[h]?.name,"data-testid":I.Tp.components.SQLQueryEditor.selectInputParameter})})}),g.parameters.length!==h+1&&(0,e.jsx)(J.c,{className:d.label,children:","})]},h)):null}return m?.name===void 0?(0,e.jsx)(Ce,{columns:c,onParameterChange:u=>x(0)(u),value:(0,C.oG)(m?.parameters?.[0])}):g?(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(J.c,{className:d.label,children:"("}),f(),(0,e.jsx)(J.c,{className:d.label,children:")"})]}):(0,e.jsx)(ct,{query:t,onSqlChange:a,currentColumnIndex:s,columns:c,onParameterChange:x})}const mt=()=>({label:(0,P.css)({padding:0,margin:0,width:"unset"})});function pt({query:t,onQueryChange:a,db:s,columns:o}){const c=(0,q.of)(ft),{onSqlChange:l}=te({query:t,onQueryChange:a,db:s}),m=[];t.format===X.gv.Timeseries&&(m.push({label:(0,r.t)("grafana-sql.components.select-row.label.time","time"),value:"time"}),m.push({label:(0,r.t)("grafana-sql.components.select-row.label.value","value"),value:"value"}));const d=(0,i.useCallback)((f,u)=>h=>{const y={...f,name:h?.value,parameters:[{type:ie._.FunctionParameter,name:f.parameters?.[0]?.name||""}]},j={...t.sql,columns:t.sql?.columns?.map((Q,D)=>D===u?y:Q)};l(j)},[l,t.sql]),g=(0,i.useCallback)((f,u)=>h=>{let y={...f};h!==null?y={...f,alias:`"${h?.value?.trim()}"`}:delete y.alias;const j={...t.sql,columns:t.sql?.columns?.map((Q,D)=>D===u?y:Q)};l(j)},[l,t.sql]),p=(0,i.useCallback)(f=>()=>{const u=[...t.sql?.columns||[]];u.splice(f,1);const h={...t.sql,columns:u};l(h)},[l,t.sql]),v=(0,i.useCallback)(()=>{const f={...t.sql,columns:[...t.sql?.columns||[],(0,C.JD)()]};l(f)},[l,t.sql]),x=()=>{const f=[{label:(0,r.t)("grafana-sql.components.select-row.aggregate-options.options.label.aggregations","Aggregations"),options:[]},{label:(0,r.t)("grafana-sql.components.select-row.aggregate-options.options.label.macros","Macros"),options:[]}];for(const u of s.functions())u.name.startsWith("$__")?f[1].options.push({label:u.name,value:u.name}):f[0].options.push({label:u.name,value:u.name});return f};return(0,e.jsxs)(Z.B,{gap:2,wrap:"wrap",direction:"column",children:[t.sql?.columns?.map((f,u)=>(0,e.jsx)("div",{children:(0,e.jsxs)(Z.B,{gap:2,alignItems:"end",children:[(0,e.jsx)(F.c,{label:(0,r.t)("grafana-sql.components.select-row.label-data-operations","Data operations"),optional:!0,width:25,children:(0,e.jsx)(W.l6,{value:f.name?(0,k.z)(f.name):null,inputId:`select-aggregation-${u}-${(0,Y.uniqueId)()}`,"data-testid":I.Tp.components.SQLQueryEditor.selectAggregation,isClearable:!0,menuShouldPortal:!0,allowCustomValue:!0,options:x(),onChange:d(f,u)})}),(0,e.jsx)(ut,{currentColumnIndex:u,columns:o,onSqlChange:l,query:t,db:s}),(0,e.jsx)(F.c,{label:(0,r.t)("grafana-sql.components.select-row.label-alias","Alias"),optional:!0,width:15,children:(0,e.jsx)(W.l6,{value:f.alias?(0,k.z)(f.alias):null,inputId:`select-alias-${u}-${(0,Y.uniqueId)()}`,"data-testid":I.Tp.components.SQLQueryEditor.selectAlias,options:m,onChange:g(f,u),isClearable:!0,menuShouldPortal:!0,allowCustomValue:!0})}),(0,e.jsx)(z.$n,{"aria-label":(0,r.t)("grafana-sql.components.select-row.title-remove-column","Remove column"),type:"button",icon:"trash-alt",variant:"secondary",size:"md",onClick:p(u)})]})},u)),(0,e.jsx)(z.$n,{type:"button",onClick:v,variant:"secondary","aria-label":(0,r.t)("grafana-sql.components.select-row.title-add-column","Add column"),size:"md",icon:"plus",className:c.addButton})]})}const ft=()=>({addButton:(0,P.css)({alignSelf:"flex-start"}),label:(0,P.css)({padding:0,margin:0,width:"unset"})}),gt=({query:t,db:a,queryRowFilter:s,onChange:o,onValidate:c,range:l})=>{const m=(0,w.A)(async()=>await a.fields(t),[a,t.dataset,t.table]);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(Qe.D,{children:[(0,e.jsx)(L.U,{children:(0,e.jsx)(pt,{columns:m.value||[],query:t,onQueryChange:o,db:a})}),s.filter&&(0,e.jsx)(L.U,{children:(0,e.jsx)(F.c,{label:(0,r.t)("grafana-sql.components.visual-editor.label-filter-by-column-value","Filter by column value"),optional:!0,children:(0,e.jsx)(rt,{fields:m.value||[],query:t,onQueryChange:o,db:a})})}),s.group&&(0,e.jsx)(L.U,{children:(0,e.jsx)(F.c,{label:(0,r.t)("grafana-sql.components.visual-editor.label-group-by-column","Group by column"),children:(0,e.jsx)(Ve,{fields:m.value||[],query:t,onQueryChange:o,db:a})})}),s.order&&(0,e.jsx)(L.U,{children:(0,e.jsx)(Ge,{fields:m.value||[],query:t,onQueryChange:o,db:a})}),s.preview&&t.rawSql&&(0,e.jsx)(L.U,{children:(0,e.jsx)(Ke.l,{rawSql:t.rawSql,datasourceType:t.datasource?.type})})]}),(0,e.jsx)(fe,{db:a,query:t,onValidate:c,range:l})]})};function ht({datasource:t,query:a,onChange:s,onRunQuery:o,range:c,queryHeaderProps:l}){const[m,d]=(0,i.useState)(!0),g=t.getDB(),{preconfiguredDatabase:p}=t,v=l?.dialect??"other",{loading:x,error:f}=(0,w.A)(async()=>()=>{t.getDB(t.id).init!==void 0&&t.getDB(t.id).init()},[t]),u=(0,O.T)(a),[h,y]=(0,i.useState)({filter:!!u.sql?.whereString,group:!!u.sql?.groupBy?.[0]?.property.name,order:!!u.sql?.orderBy?.property.name,preview:!0}),[j,Q]=(0,i.useState)(u);(0,i.useEffect)(()=>()=>{t.getDB(t.id).dispose!==void 0&&t.getDB(t.id).dispose()},[t]);const D=(0,i.useCallback)(B=>{vt(B)&&o&&o()},[o]),A=(B,S=!0)=>{Q(B),s(B),(0,C.YW)(B.sql?.columns)&&B.sql?.columns.some(G=>G.name)&&!h.group&&y({...h,group:!0}),S&&D(B)},_=B=>{Q(B),s(B)};return x||f?null:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(Oe,{db:g,preconfiguredDataset:p,onChange:_,onRunQuery:o,onQueryRowChange:y,queryRowFilter:h,query:u,isQueryRunnable:m,dialect:v}),(0,e.jsx)(T.$,{v:.5}),u.editorMode!==b.lX.Code&&(0,e.jsx)(gt,{db:g,query:u,onChange:B=>A(B,!1),queryRowFilter:h,onValidate:d,range:c}),u.editorMode===b.lX.Code&&(0,e.jsx)(Ae,{db:g,query:u,queryToValidate:j,onChange:A,onRunQuery:o,onValidate:d,range:c})]})}const vt=t=>!!t.rawSql},72500:(U,M,n)=>{n.d(M,{M:()=>b});var e=n(22803),i=n(63142),w=n(96540);const b=({children:C})=>{const R=(0,i.of)(O),I=w.Children.map(C,r=>(0,w.isValidElement)(r)&&r.props.invalid?(0,w.cloneElement)(r,{className:(0,e.cx)(r.props.className,R.invalidChild)}):r);return w.createElement("div",{className:R.root},I)},T=["","base","hovered","invalid","focused"],O=()=>({root:(0,e.css)({display:"flex","> *":{"&:not(:first-child)":{marginLeft:-1},"&:first-child":{borderTopRightRadius:0,borderBottomRightRadius:0},"&:last-child":{borderTopLeftRadius:0,borderBottomLeftRadius:0},"&:not(:first-child):not(:last-child)":{borderRadius:0},position:"relative",zIndex:T.indexOf("base"),"&:hover":{zIndex:T.indexOf("hovered")},"&:focus-within":{zIndex:T.indexOf("focused")}}}),invalidChild:(0,e.css)({zIndex:T.indexOf("invalid")})})},75686:(U,M,n)=>{n.d(M,{W:()=>O});var e=n(22803),i=n(96540),w=n(73744),b=n(18857),T=n(63142);function O({label:r,...V}){const[N]=(0,i.useState)(()=>Math.random().toString(16).slice(2)),$=(0,T.of)(I),L={SelectContainer:C,ValueContainer:R,SingleValue:R};return i.createElement("div",{className:$.root},r&&i.createElement("label",{className:$.label,htmlFor:N},r,":","\xA0"),i.createElement(b.l6,{openMenuOnFocus:!0,inputId:N,...V,components:L}))}const C=r=>{const{children:V}=r,N=(0,T.of)(I);return i.createElement(w.K,{...r,className:(0,e.cx)(r.className,N.container)},V)},R=r=>{const{className:V,children:N}=r,$=(0,T.of)(I);return i.createElement("div",{className:(0,e.cx)(V,$.valueContainer)},N)},I=r=>({root:(0,e.css)({display:"flex",fontSize:12,alignItems:"center"}),label:(0,e.css)({color:r.colors.text.secondary,whiteSpace:"nowrap"}),container:(0,e.css)({background:"none",borderColor:"transparent"}),valueContainer:(0,e.css)({display:"flex",alignItems:"center",flex:"initial",color:r.colors.text.secondary,fontSize:12})})}}]);

//# sourceMappingURL=sql-query-editor.284a4c7e23b0c2010a10.js.map