{"version":3,"file":"9473.e5d28da3a811c12024b3.js","mappings":"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","sources":["webpack://grafana/./node_modules/@grafana/plugin-ui/dist/esm/components/VisualQueryBuilder/components/OperationsEditorRow.js","webpack://grafana/./public/app/plugins/datasource/dashboard/DashboardQueryEditor.tsx","webpack://grafana/./public/app/plugins/datasource/dashboard/datasource.ts","webpack://grafana/./public/app/plugins/datasource/dashboard/module.ts","webpack://grafana/./node_modules/@grafana/plugin-ui/dist/esm/components/QueryEditor/EditorStack.js","webpack://grafana/./node_modules/rxjs/dist/esm5/internal/operators/debounce.js","webpack://grafana/./node_modules/rxjs/dist/esm5/internal/observable/defer.js"],"sourcesContent":["import { css } from '@emotion/css';\nimport React__default from 'react';\nimport '@grafana/data';\nimport { useStyles2 } from '@grafana/ui';\nimport '../../QueryEditor/types.js';\nimport 'lodash';\nimport '../../QueryEditor/EditorList.js';\nimport { EditorStack } from '../../QueryEditor/EditorStack.js';\nimport '../../QueryEditor/Space.js';\nimport 'react-use';\nimport '../../QueryEditor/QueryHeader.js';\nimport 'react-virtualized-auto-sizer';\nimport 'sql-formatter-plus';\nimport '../../SQLEditor/standardSql/language.js';\nimport 'uuid';\nimport '@grafana/runtime';\nimport '../../SQLEditor/utils/debugger.js';\nimport '../../SQLEditor/standardSql/macros.js';\nimport '../../QueryEditor/visual-query-builder/AwesomeQueryBuilder.js';\nimport '../../QueryEditor/visual-query-builder/WhereRow.js';\nimport '../../QueryEditor/visual-query-builder/EditorField.js';\nimport 'rxjs';\nimport 'rxjs/operators';\n\nfunction OperationsEditorRow({ children }) {\n  const styles = useStyles2(getStyles);\n  return /* @__PURE__ */ React__default.createElement(\"div\", { className: styles.root }, /* @__PURE__ */ React__default.createElement(EditorStack, { gap: 1 }, children));\n}\nconst getStyles = (theme) => {\n  return {\n    root: css({\n      padding: theme.spacing(1, 1, 0, 1),\n      backgroundColor: theme.colors.background.secondary,\n      borderRadius: theme.shape.radius.default\n    })\n  };\n};\n\nexport { OperationsEditorRow };\n//# sourceMappingURL=OperationsEditorRow.js.map\n","import { css } from '@emotion/css';\nimport { useId } from '@react-aria/utils';\nimport pluralize from 'pluralize';\nimport { useCallback, useMemo } from 'react';\nimport { useAsync } from 'react-use';\n\nimport { DataQuery, GrafanaTheme2, SelectableValue, DataTopic, QueryEditorProps } from '@grafana/data';\nimport { OperationsEditorRow } from '@grafana/plugin-ui';\nimport { Field, Select, useStyles2, Spinner, RadioButtonGroup, Stack, InlineSwitch } from '@grafana/ui';\nimport config from 'app/core/config';\nimport { getDashboardSrv } from 'app/features/dashboard/services/DashboardSrv';\nimport { PanelModel } from 'app/features/dashboard/state/PanelModel';\nimport { DashboardScene } from 'app/features/dashboard-scene/scene/DashboardScene';\nimport { getDatasourceSrv } from 'app/features/plugins/datasource_srv';\nimport { filterPanelDataToQuery } from 'app/features/query/components/QueryEditorRow';\n\nimport { MIXED_DATASOURCE_NAME } from '../mixed/MixedDataSource';\n\nimport { SHARED_DASHBOARD_QUERY } from './constants';\nimport { DashboardDatasource } from './datasource';\nimport { DashboardQuery, ResultInfo } from './types';\n\nfunction getQueryDisplayText(query: DataQuery): string {\n  return JSON.stringify(query);\n}\n\nfunction isPanelInEdit(panelId: number, panelInEditId?: number) {\n  let idToCompareWith = panelInEditId;\n\n  if (window.__grafanaSceneContext && window.__grafanaSceneContext instanceof DashboardScene) {\n    idToCompareWith = window.__grafanaSceneContext.state.editPanel?.getPanelId();\n  }\n\n  return panelId === idToCompareWith;\n}\n\ninterface Props extends QueryEditorProps<DashboardDatasource, DashboardQuery> {}\n\nconst topics = [\n  { label: 'All data', value: false },\n  { label: 'Annotations', value: true, description: 'Include annotations as regular data' },\n];\n\nexport const INVALID_PANEL_DESCRIPTION = 'Contains a shared dashboard query';\n\nexport function DashboardQueryEditor({ data, query, onChange, onRunQuery }: Props) {\n  const { value: defaultDatasource } = useAsync(() => getDatasourceSrv().get());\n\n  const panel = useMemo(() => {\n    const dashboard = getDashboardSrv().getCurrent();\n    return dashboard?.getPanelById(query.panelId ?? -124134);\n  }, [query.panelId]);\n\n  const { value: results, loading: loadingResults } = useAsync(async (): Promise<ResultInfo[]> => {\n    if (!panel || !data) {\n      return [];\n    }\n    const mainDS = await getDatasourceSrv().get(panel.datasource);\n    return Promise.all(\n      panel.targets.map(async (query) => {\n        const ds = query.datasource ? await getDatasourceSrv().get(query.datasource) : mainDS;\n        const fmt = ds.getQueryDisplayText || getQueryDisplayText;\n        const queryData = filterPanelDataToQuery(data, query.refId) ?? data;\n        return {\n          refId: query.refId,\n          query: fmt(query),\n          name: ds.name,\n          img: ds.meta.info.logos.small,\n          data: queryData.series,\n          error: queryData.error,\n        };\n      })\n    );\n  }, [data, panel]);\n\n  const onUpdateQuery = useCallback(\n    (query: DashboardQuery) => {\n      onChange(query);\n      onRunQuery();\n    },\n    [onChange, onRunQuery]\n  );\n\n  const onPanelChanged = useCallback(\n    (id: number) => {\n      onUpdateQuery({\n        ...query,\n        panelId: id,\n      });\n    },\n    [query, onUpdateQuery]\n  );\n\n  const onTransformToggle = useCallback(() => {\n    onUpdateQuery({\n      ...query,\n      withTransforms: !query.withTransforms,\n    });\n  }, [query, onUpdateQuery]);\n\n  const onTopicChanged = useCallback(\n    (t: boolean) => {\n      onUpdateQuery({\n        ...query,\n        topic: t ? DataTopic.Annotations : undefined,\n      });\n    },\n    [query, onUpdateQuery]\n  );\n\n  const onAdHocFiltersToggle = useCallback(() => {\n    onUpdateQuery({\n      ...query,\n      adHocFiltersEnabled: !query.adHocFiltersEnabled,\n    });\n  }, [query, onUpdateQuery]);\n\n  const isMixedDSWithDashboardQueries = (panel: PanelModel) => {\n    return (\n      panel.datasource?.uid === MIXED_DATASOURCE_NAME &&\n      panel.targets.some((t) => t.datasource?.uid === SHARED_DASHBOARD_QUERY)\n    );\n  };\n\n  const getPanelDescription = useCallback(\n    (panel: PanelModel): string => {\n      const datasource = panel.datasource ?? defaultDatasource;\n      const dsname = getDatasourceSrv().getInstanceSettings(datasource)?.name;\n      const queryCount = panel.targets.length;\n      return `${queryCount} ${pluralize('query', queryCount)} to ${dsname}`;\n    },\n    [defaultDatasource]\n  );\n\n  const dashboard = getDashboardSrv().getCurrent();\n  const showTransforms = Boolean(query.withTransforms || panel?.transformations?.length);\n  const panels: Array<SelectableValue<number>> = useMemo(\n    () =>\n      dashboard?.panels\n        .filter(\n          (panel) => config.panels[panel.type] && panel.targets && !isPanelInEdit(panel.id, dashboard.panelInEdit?.id)\n        )\n        .map((panel) => {\n          let description = getPanelDescription(panel);\n          let isDisabled = false;\n          if (panel.datasource?.uid === SHARED_DASHBOARD_QUERY || isMixedDSWithDashboardQueries(panel)) {\n            description = INVALID_PANEL_DESCRIPTION;\n            isDisabled = true;\n          }\n\n          return {\n            value: panel.id,\n            label: panel.title ?? 'Panel ' + panel.id,\n            imgUrl: config.panels[panel.type].info.logos.small,\n            description,\n            isDisabled,\n          };\n        }) ?? [],\n    [dashboard, getPanelDescription]\n  );\n\n  const styles = useStyles2(getStyles);\n  const selectId = useId();\n\n  if (!dashboard) {\n    return null;\n  }\n\n  if (panels.length < 1) {\n    return (\n      <p className={styles.noQueriesText}>\n        This dashboard does not have any other panels. Add queries to other panels and try again.\n      </p>\n    );\n  }\n\n  const selected = panels.find((panel) => panel.value === query.panelId);\n\n  return (\n    <OperationsEditorRow>\n      <Stack direction=\"column\">\n        <Stack gap={3}>\n          <Field label=\"Source panel\" description=\"Use query results from another panel\">\n            <Select\n              inputId={selectId}\n              placeholder=\"Choose panel\"\n              isSearchable={true}\n              options={panels}\n              value={selected}\n              onChange={(item) => onPanelChanged(item.value!)}\n            />\n          </Field>\n\n          <Field label=\"Data\" description=\"Use data or annotations from the panel\">\n            <RadioButtonGroup\n              options={topics}\n              value={query.topic === DataTopic.Annotations}\n              onChange={onTopicChanged}\n            />\n          </Field>\n\n          {showTransforms && (\n            <Field label=\"Transform\" description=\"Apply transformations from the source panel\">\n              <InlineSwitch value={Boolean(query.withTransforms)} onChange={onTransformToggle} />\n            </Field>\n          )}\n\n          {config.featureToggles.dashboardDsAdHocFiltering && (\n            <Field\n              label=\"AdHoc Filters\"\n              description=\"Apply --Dashboard-- data source AdHoc filters to this panel\"\n              noMargin\n            >\n              <InlineSwitch value={Boolean(query.adHocFiltersEnabled)} onChange={onAdHocFiltersToggle} />\n            </Field>\n          )}\n        </Stack>\n\n        {loadingResults ? (\n          <Spinner />\n        ) : (\n          <>\n            {results && Boolean(results.length) && (\n              <Field label=\"Queries from panel\">\n                <Stack direction=\"column\">\n                  {results.map((target, i) => (\n                    <Stack key={i} alignItems=\"center\" gap={1}>\n                      <div>{target.refId}</div>\n                      <img src={target.img} alt={target.name} title={target.name} width={16} />\n                      <div>{target.query}</div>\n                    </Stack>\n                  ))}\n                </Stack>\n              </Field>\n            )}\n          </>\n        )}\n      </Stack>\n    </OperationsEditorRow>\n  );\n}\n\nfunction getStyles(theme: GrafanaTheme2) {\n  return {\n    noQueriesText: css({\n      padding: theme.spacing(1.25),\n    }),\n  };\n}\n","import { Observable, debounce, debounceTime, defer, finalize, first, interval, map, of } from 'rxjs';\n\nimport {\n  DataSourceApi,\n  DataQueryRequest,\n  DataQueryResponse,\n  DataSourceInstanceSettings,\n  TestDataSourceResponse,\n  ScopedVar,\n  DataTopic,\n  PanelData,\n  DataFrame,\n  LoadingState,\n  Field,\n  FieldType,\n  AdHocVariableFilter,\n  MetricFindValue,\n  getValueMatcher,\n  ValueMatcherID,\n  DataSourceGetDrilldownsApplicabilityOptions,\n  DrilldownsApplicability,\n} from '@grafana/data';\nimport { config } from '@grafana/runtime';\nimport { SceneDataProvider, SceneDataTransformer, SceneObject } from '@grafana/scenes';\nimport {\n  activateSceneObjectAndParentTree,\n  findVizPanelByKey,\n  getVizPanelKeyForPanelId,\n} from 'app/features/dashboard-scene/utils/utils';\n\nimport { MIXED_REQUEST_PREFIX } from '../mixed/MixedDataSource';\n\nimport { DashboardQuery } from './types';\n\n/**\n * This should not really be called\n */\nexport class DashboardDatasource extends DataSourceApi<DashboardQuery> {\n  constructor(instanceSettings: DataSourceInstanceSettings) {\n    super(instanceSettings);\n  }\n\n  getCollapsedText(query: DashboardQuery) {\n    return `Dashboard Reference: ${query.panelId}`;\n  }\n\n  query(options: DataQueryRequest<DashboardQuery>): Observable<DataQueryResponse> {\n    const sceneScopedVar: ScopedVar | undefined = options.scopedVars?.__sceneObject;\n    let scene: SceneObject | undefined = sceneScopedVar ? (sceneScopedVar.value.valueOf() as SceneObject) : undefined;\n\n    if (!scene) {\n      throw new Error('Can only be called from a scene');\n    }\n\n    const query = options.targets[0];\n    if (!query) {\n      return of({ data: [] });\n    }\n\n    const panelId = query.panelId;\n\n    if (!panelId) {\n      return of({ data: [] });\n    }\n\n    let sourcePanel = findVizPanelByKey(scene, getVizPanelKeyForPanelId(panelId));\n\n    if (!sourcePanel) {\n      return of({ data: [], error: { message: 'Could not find source panel' } });\n    }\n\n    let sourceDataProvider: SceneDataProvider | undefined = sourcePanel.state.$data;\n\n    if (!query.withTransforms && sourceDataProvider instanceof SceneDataTransformer) {\n      sourceDataProvider = sourceDataProvider.state.$data;\n    }\n\n    if (!sourceDataProvider || !sourceDataProvider.getResultsStream) {\n      return of({ data: [] });\n    }\n\n    // Extract AdHoc filters from the request\n    const adHocFilters = options.filters || [];\n\n    return defer(() => {\n      if (!sourceDataProvider!.isActive && sourceDataProvider?.setContainerWidth) {\n        sourceDataProvider?.setContainerWidth(500);\n      }\n\n      const cleanUp = activateSceneObjectAndParentTree(sourceDataProvider!);\n\n      return sourceDataProvider!.getResultsStream!().pipe(\n        debounceTime(50),\n        map((result) => {\n          return {\n            data: this.getDataFramesForQueryTopic(result.data, query, adHocFilters),\n            state: result.data.state,\n            errors: result.data.errors,\n            error: result.data.error,\n            key: 'source-ds-provider',\n          };\n        }),\n        this.emitFirstLoadedDataIfMixedDS(options.requestId),\n        finalize(() => cleanUp?.())\n      );\n    });\n  }\n\n  private getDataFramesForQueryTopic(\n    data: PanelData,\n    query: DashboardQuery,\n    filters: AdHocVariableFilter[]\n  ): DataFrame[] {\n    const annotations = data.annotations ?? [];\n    if (query.topic === DataTopic.Annotations) {\n      return annotations.map((frame) => ({\n        ...frame,\n        meta: {\n          ...frame.meta,\n          dataTopic: DataTopic.Series,\n        },\n      }));\n    } else {\n      const series = data.series.map((s) => {\n        return {\n          ...s,\n          fields: s.fields.map((field: Field) => ({\n            ...field,\n            config: {\n              ...field.config,\n              // Enable AdHoc filtering for string and numeric fields only when feature toggle and per-panel setting are enabled\n              filterable:\n                config.featureToggles.dashboardDsAdHocFiltering && query.adHocFiltersEnabled\n                  ? field.type === FieldType.string || field.type === FieldType.number\n                  : field.config.filterable,\n            },\n            state: {\n              ...field.state,\n            },\n          })),\n        };\n      });\n\n      if (!config.featureToggles.dashboardDsAdHocFiltering || !query.adHocFiltersEnabled || filters.length === 0) {\n        return [...series, ...annotations];\n      }\n\n      // Apply AdHoc filters to series data\n      const filteredSeries = series.map((frame) => this.applyAdHocFilters(frame, filters));\n      return [...filteredSeries, ...annotations];\n    }\n  }\n\n  /**\n   * Apply AdHoc filters to a DataFrame\n   * Optimized version with pre-computed field indices and value matchers for better performance\n   */\n  private applyAdHocFilters(frame: DataFrame, filters: AdHocVariableFilter[]): DataFrame {\n    if (filters.length === 0 || frame.length === 0) {\n      return frame;\n    }\n\n    // Filter out non-applicable filters for this specific DataFrame\n    const applicableFilters = this.getApplicableFiltersForFrame(frame, filters);\n\n    // If no filters remain after filtering, return original frame\n    if (applicableFilters.length === 0) {\n      return frame;\n    }\n\n    // Check for impossible filters (missing field with '=' operator)\n    const hasImpossibleFilter = applicableFilters.some(\n      ({ fieldIndex, filter }) => fieldIndex === -1 && filter.operator === '='\n    );\n    if (hasImpossibleFilter) {\n      return this.reconstructDataFrame(frame);\n    }\n\n    const matchingRows = new Set<number>();\n\n    // Check each row to see if it matches all filters (AND logic)\n    for (let rowIndex = 0; rowIndex < frame.length; rowIndex++) {\n      const rowMatches = applicableFilters.every(({ matcher, fieldIndex }) => {\n        const field = frame.fields[fieldIndex];\n\n        // Use Grafana's value matcher system\n        return matcher?.(rowIndex, field, frame, [frame]) ?? false;\n      });\n\n      if (rowMatches) {\n        matchingRows.add(rowIndex);\n      }\n    }\n\n    // Early return if no filtering occurred\n    if (matchingRows.size === frame.length) {\n      return frame;\n    }\n\n    return this.reconstructDataFrame(frame, matchingRows);\n  }\n\n  /**\n   * Get applicable filters for a specific DataFrame, considering field existence and type compatibility.\n   */\n  private getApplicableFiltersForFrame(\n    frame: DataFrame,\n    filters: AdHocVariableFilter[]\n  ): Array<{ filter: AdHocVariableFilter; fieldIndex: number; matcher: ReturnType<typeof getValueMatcher> | null }> {\n    return filters\n      .map((filter) => {\n        const fieldIndex = frame.fields.findIndex((f) => f.name === filter.key);\n        return { filter, fieldIndex, matcher: this.createValueMatcher(filter, fieldIndex, frame) };\n      })\n      .filter(({ filter, fieldIndex, matcher }) => {\n        // If field is not present:\n        // - Keep filters with '=' operator (will always be false - reject rows)\n        // - Remove filters with '!=' operator (will always be true - no effect)\n        if (fieldIndex === -1) {\n          return filter.operator === '=';\n        }\n        // Only keep filters with valid matchers\n        return matcher !== null;\n      });\n  }\n\n  /**\n   * Create a value matcher from an AdHoc filter.\n   */\n  private createValueMatcher(filter: AdHocVariableFilter, fieldIndex: number, frame: DataFrame) {\n    // Return null for missing fields - they are handled separately\n    if (fieldIndex === -1) {\n      return null;\n    }\n\n    const field = frame.fields[fieldIndex];\n\n    // Only support string and numeric fields when feature toggle is enabled\n    if (config.featureToggles.dashboardDsAdHocFiltering) {\n      if (field.type !== FieldType.string && field.type !== FieldType.number) {\n        return null;\n      }\n    }\n\n    // Map operator to matcher ID\n    let matcherId: ValueMatcherID;\n    switch (filter.operator) {\n      case '=':\n        matcherId = ValueMatcherID.equal;\n        break;\n      case '!=':\n        matcherId = ValueMatcherID.notEqual;\n        break;\n      default:\n        return null; // Unknown operator\n    }\n\n    try {\n      return getValueMatcher({\n        id: matcherId,\n        options: { value: filter.value },\n      });\n    } catch (error) {\n      console.warn('Failed to create value matcher for filter:', filter, error);\n      return null;\n    }\n  }\n\n  /**\n   * Reconstruct DataFrame with only matching rows\n   * Optimized to avoid repeated array operations\n   */\n  private reconstructDataFrame(frame: DataFrame, matchingRows?: Set<number>): DataFrame {\n    // Default to empty set if no matching rows provided (reject all rows)\n    const rows = matchingRows ?? new Set<number>();\n\n    const fields: Field[] = frame.fields.map((field) => {\n      // Pre-allocate array and use direct assignment for better performance with large datasets\n      const newValues = new Array(rows.size);\n      let i = 0;\n      for (const rowIndex of rows) {\n        newValues[i++] = field.values[rowIndex];\n      }\n\n      return {\n        ...field,\n        values: newValues,\n        state: {}, // Clean the state as it's being recalculated\n      };\n    });\n\n    return {\n      ...frame,\n      fields: fields,\n      length: rows.size,\n    };\n  }\n\n  private emitFirstLoadedDataIfMixedDS(\n    requestId: string\n  ): (source: Observable<DataQueryResponse>) => Observable<DataQueryResponse> {\n    return (source: Observable<DataQueryResponse>) => {\n      if (requestId.includes(MIXED_REQUEST_PREFIX)) {\n        let count = 0;\n\n        return source.pipe(\n          /*\n           * We can have the following piped values scenarios:\n           * Loading -> Done         - initial load\n           * Done -> Loading -> Done - refresh\n           * Done                    - adding another query in editor\n           *\n           * When we see Done as a first element this is because of ReplaySubject in SceneQueryRunner\n           *\n           * we use first(...) below to emit correct result which is last value with Done/Error states\n           *\n           * to avoid emitting first Done/Error (due to ReplaySubject) we selectively debounce only first value with such states\n           */\n          debounce((val) => {\n            if ([LoadingState.Done, LoadingState.Error].includes(val.state!) && count === 0) {\n              count++;\n              // in the refresh scenario we need to debounce first Done/Error until Loading arrives\n              //   400ms here is a magic number that was sufficient enough with the 20x cpu throttle\n              //   this still might affect slower machines but the issue affects only panel view/edit modes\n              return interval(400);\n            }\n            count++;\n            return interval(0);\n          }),\n          first((val) => val.state === LoadingState.Done || val.state === LoadingState.Error)\n        );\n      }\n\n      return source;\n    };\n  }\n\n  testDatasource(): Promise<TestDataSourceResponse> {\n    return Promise.resolve({ message: '', status: '' });\n  }\n\n  /**\n   * Check which AdHoc filters are applicable based on operator and field type support\n   */\n  async getDrilldownsApplicability(\n    options?: DataSourceGetDrilldownsApplicabilityOptions<DashboardQuery>\n  ): Promise<DrilldownsApplicability[]> {\n    if (!config.featureToggles.dashboardDsAdHocFiltering) {\n      return [];\n    }\n\n    // Check if any query has adhoc filters enabled\n    const hasAdHocFiltersEnabled = options?.queries?.some((query) => query.adHocFiltersEnabled);\n\n    if (!hasAdHocFiltersEnabled) {\n      return [];\n    }\n\n    const filters = options?.filters || [];\n\n    return filters.map((filter): DrilldownsApplicability => {\n      // Check operator support\n      if (filter.operator !== '=' && filter.operator !== '!=') {\n        return {\n          key: filter.key,\n          applicable: false,\n          reason: `Operator '${filter.operator}' is not supported. Only '=' and '!=' operators are supported.`,\n        };\n      }\n\n      // For dashboard datasource, we can't determine field existence/type\n      // without the actual DataFrame context, so we assume applicable here\n      // and let the actual filtering logic handle field-specific checks\n      return {\n        key: filter.key,\n        applicable: true,\n      };\n    });\n  }\n\n  getTagKeys(): Promise<MetricFindValue[]> {\n    // Stub implementation to indicate AdHoc filter support\n    // Full implementation will be added in future PRs\n    return Promise.resolve([]);\n  }\n}\n","import { DataSourcePlugin } from '@grafana/data';\n\nimport { DashboardQueryEditor } from './DashboardQueryEditor';\nimport { DashboardDatasource } from './datasource';\n\nexport const plugin = new DataSourcePlugin(DashboardDatasource).setQueryEditor(DashboardQueryEditor);\n","import React__default from 'react';\nimport { Stack } from '@grafana/ui';\nimport '@grafana/data';\n\nconst EditorStack = ({ children, wrap: wrapItems = true, ...props }) => {\n  var _a, _b;\n  return /* @__PURE__ */ React__default.createElement(Stack, { wrap: wrapItems ? \"wrap\" : undefined, direction: (_a = props.direction) != null ? _a : \"row\", gap: (_b = props.gap) != null ? _b : 2, ...props }, children);\n};\n\nexport { EditorStack };\n//# sourceMappingURL=EditorStack.js.map\n","import { operate } from '../util/lift';\nimport { noop } from '../util/noop';\nimport { createOperatorSubscriber } from './OperatorSubscriber';\nimport { innerFrom } from '../observable/innerFrom';\nexport function debounce(durationSelector) {\n    return operate(function (source, subscriber) {\n        var hasValue = false;\n        var lastValue = null;\n        var durationSubscriber = null;\n        var emit = function () {\n            durationSubscriber === null || durationSubscriber === void 0 ? void 0 : durationSubscriber.unsubscribe();\n            durationSubscriber = null;\n            if (hasValue) {\n                hasValue = false;\n                var value = lastValue;\n                lastValue = null;\n                subscriber.next(value);\n            }\n        };\n        source.subscribe(createOperatorSubscriber(subscriber, function (value) {\n            durationSubscriber === null || durationSubscriber === void 0 ? void 0 : durationSubscriber.unsubscribe();\n            hasValue = true;\n            lastValue = value;\n            durationSubscriber = createOperatorSubscriber(subscriber, emit, noop);\n            innerFrom(durationSelector(value)).subscribe(durationSubscriber);\n        }, function () {\n            emit();\n            subscriber.complete();\n        }, undefined, function () {\n            lastValue = durationSubscriber = null;\n        }));\n    });\n}\n//# sourceMappingURL=debounce.js.map","import { Observable } from '../Observable';\nimport { innerFrom } from './innerFrom';\nexport function defer(observableFactory) {\n    return new Observable(function (subscriber) {\n        innerFrom(observableFactory()).subscribe(subscriber);\n    });\n}\n//# sourceMappingURL=defer.js.map"],"names":["OperationsEditorRow","children","styles","getStyles","EditorStack","theme","getQueryDisplayText","query","isPanelInEdit","panelId","panelInEditId","idToCompareWith","DashboardScene","topics","INVALID_PANEL_DESCRIPTION","DashboardQueryEditor","data","onChange","onRunQuery","defaultDatasource","useAsync","panel","results","loadingResults","mainDS","ds","fmt","queryData","onUpdateQuery","onPanelChanged","id","onTransformToggle","onTopicChanged","t","onAdHocFiltersToggle","isMixedDSWithDashboardQueries","getPanelDescription","datasource","dsname","queryCount","dashboard","showTransforms","panels","config","description","isDisabled","selectId","useId","selected","Stack","Field","Select","item","RadioButtonGroup","Spinner","target","i","DashboardDatasource","instanceSettings","options","sceneScopedVar","scene","of","sourcePanel","sourceDataProvider","adHocFilters","defer","cleanUp","debounceTime","map","result","finalize","filters","annotations","frame","series","s","field","applicableFilters","fieldIndex","filter","matchingRows","rowIndex","matcher","f","matcherId","error","rows","fields","newValues","requestId","source","count","debounce","val","interval","first","wrapItems","props","_a","_b","durationSelector","subscriber","hasValue","lastValue","durationSubscriber","emit","value","observableFactory"],"sourceRoot":""}