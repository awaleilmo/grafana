"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9473],{39473:(K,p,e)=>{e.r(p),e.d(p,{plugin:()=>Dt});var D=e(94644),o=e(74848),m=e(22803),I=e(92145),T=e(55127),C=e.n(T),f=e(96540),v=e(16817),E=e(739),x=e(63142),h=e(2543),S=e(46936),y=e(70713),yt=e(27633);function w({children:u}){const t=(0,x.of)(k);return f.createElement("div",{className:t.root},f.createElement(S.C,{gap:1},u))}const k=u=>({root:(0,m.css)({padding:u.spacing(1,1,0,1),backgroundColor:u.colors.background.secondary,borderRadius:u.shape.radius.default})});var M=e(41654),P=e(37386),q=e(18857),_=e(77824),z=e(21285),tt=e(68079),L=e(65642),V=e(22429),et=e(11534),O=e(28998),at=e(96041),N=e(18615),G=e(9931);function nt(u){return JSON.stringify(u)}function st(u,t){let l=t;return window.__grafanaSceneContext&&window.__grafanaSceneContext instanceof et.H$&&(l=window.__grafanaSceneContext.state.editPanel?.getPanelId()),u===l}const rt=[{label:"All data",value:!1},{label:"Annotations",value:!0,description:"Include annotations as regular data"}],ot="Contains a shared dashboard query";function lt({data:u,query:t,onChange:l,onRunQuery:s}){const{value:n}=(0,v.A)(()=>(0,O.tR)().get()),r=(0,f.useMemo)(()=>(0,V.UA)().getCurrent()?.getPanelById(t.panelId??-124134),[t.panelId]),{value:c,loading:i}=(0,v.A)(async()=>{if(!r||!u)return[];const a=await(0,O.tR)().get(r.datasource);return Promise.all(r.targets.map(async g=>{const F=g.datasource?await(0,O.tR)().get(g.datasource):a,Q=F.getQueryDisplayText||nt,Z=(0,at.E)(u,g.refId)??u;return{refId:g.refId,query:Q(g),name:F.name,img:F.meta.info.logos.small,data:Z.series,error:Z.error}}))},[u,r]),d=(0,f.useCallback)(a=>{l(a),s()},[l,s]),b=(0,f.useCallback)(a=>{d({...t,panelId:a})},[t,d]),A=(0,f.useCallback)(()=>{d({...t,withTransforms:!t.withTransforms})},[t,d]),Et=(0,f.useCallback)(a=>{d({...t,topic:a?E.QR.Annotations:void 0})},[t,d]),At=(0,f.useCallback)(()=>{d({...t,adHocFiltersEnabled:!t.adHocFiltersEnabled})},[t,d]),Ft=a=>a.datasource?.uid===N.uv&&a.targets.some(g=>g.datasource?.uid===G.K),X=(0,f.useCallback)(a=>{const g=a.datasource??n,F=(0,O.tR)().getInstanceSettings(g)?.name,Q=a.targets.length;return`${Q} ${C()("query",Q)} to ${F}`},[n]),U=(0,V.UA)().getCurrent(),It=!!(t.withTransforms||r?.transformations?.length),W=(0,f.useMemo)(()=>U?.panels.filter(a=>L.Ay.panels[a.type]&&a.targets&&!st(a.id,U.panelInEdit?.id)).map(a=>{let g=X(a),F=!1;return(a.datasource?.uid===G.K||Ft(a))&&(g=ot,F=!0),{value:a.id,label:a.title??"Panel "+a.id,imgUrl:L.Ay.panels[a.type].info.logos.small,description:g,isDisabled:F}})??[],[U,X]),Tt=(0,x.of)(it),Ct=(0,I.Bi)();if(!U)return null;if(W.length<1)return(0,o.jsx)("p",{className:Tt.noQueriesText,children:"This dashboard does not have any other panels. Add queries to other panels and try again."});const xt=W.find(a=>a.value===t.panelId);return(0,o.jsx)(w,{children:(0,o.jsxs)(M.B,{direction:"column",children:[(0,o.jsxs)(M.B,{gap:3,children:[(0,o.jsx)(P.D,{label:"Source panel",description:"Use query results from another panel",children:(0,o.jsx)(q.l6,{inputId:Ct,placeholder:"Choose panel",isSearchable:!0,options:W,value:xt,onChange:a=>b(a.value)})}),(0,o.jsx)(P.D,{label:"Data",description:"Use data or annotations from the panel",children:(0,o.jsx)(_.z,{options:rt,value:t.topic===E.QR.Annotations,onChange:Et})}),It&&(0,o.jsx)(P.D,{label:"Transform",description:"Apply transformations from the source panel",children:(0,o.jsx)(z.K,{value:!!t.withTransforms,onChange:A})}),L.Ay.featureToggles.dashboardDsAdHocFiltering&&(0,o.jsx)(P.D,{label:"AdHoc Filters",description:"Apply --Dashboard-- data source AdHoc filters to this panel",noMargin:!0,children:(0,o.jsx)(z.K,{value:!!t.adHocFiltersEnabled,onChange:At})})]}),i?(0,o.jsx)(tt.y,{}):(0,o.jsx)(o.Fragment,{children:c&&!!c.length&&(0,o.jsx)(P.D,{label:"Queries from panel",children:(0,o.jsx)(M.B,{direction:"column",children:c.map((a,g)=>(0,o.jsxs)(M.B,{alignItems:"center",gap:1,children:[(0,o.jsx)("div",{children:a.refId}),(0,o.jsx)("img",{src:a.img,alt:a.name,title:a.name,width:16}),(0,o.jsx)("div",{children:a.query})]},g))})})})]})})}function it(u){return{noQueriesText:(0,m.css)({padding:u.spacing(1.25)})}}var R=e(62467),dt=e(72316),ct=e(56978),ut=e(81160),ft=e(69850),gt=e(51575),J=e(96083),ht=e(57532),j=e(95004),Y=e(57866),vt=e(36638),B=e(28105),H=e(43173),mt=e(45863),$=e(8285);class pt extends D.mA{constructor(t){super(t)}getCollapsedText(t){return`Dashboard Reference: ${t.panelId}`}query(t){const l=t.scopedVars?.__sceneObject;let s=l?l.value.valueOf():void 0;if(!s)throw new Error("Can only be called from a scene");const n=t.targets[0];if(!n)return(0,R.of)({data:[]});const r=n.panelId;if(!r)return(0,R.of)({data:[]});let c=(0,$.vL)(s,(0,$.XA)(r));if(!c)return(0,R.of)({data:[],error:{message:"Could not find source panel"}});let i=c.state.$data;if(!n.withTransforms&&i instanceof mt.Es&&(i=i.state.$data),!i||!i.getResultsStream)return(0,R.of)({data:[]});const d=t.filters||[];return(0,dt.v)(()=>{!i.isActive&&i?.setContainerWidth&&i?.setContainerWidth(500);const b=(0,$.sf)(i);return i.getResultsStream().pipe((0,ct.B)(50),(0,ut.T)(A=>({data:this.getDataFramesForQueryTopic(A.data,n,d),state:A.data.state,errors:A.data.errors,error:A.data.error,key:"source-ds-provider"})),this.emitFirstLoadedDataIfMixedDS(t.requestId),(0,ft.j)(()=>b?.()))})}getDataFramesForQueryTopic(t,l,s){const n=t.annotations??[];if(l.topic===E.QR.Annotations)return n.map(r=>({...r,meta:{...r.meta,dataTopic:E.QR.Series}}));{const r=t.series.map(i=>({...i,fields:i.fields.map(d=>({...d,config:{...d.config,filterable:H.$.featureToggles.dashboardDsAdHocFiltering&&l.adHocFiltersEnabled?d.type===j.PU.string||d.type===j.PU.number:d.config.filterable},state:{...d.state}}))}));return!H.$.featureToggles.dashboardDsAdHocFiltering||!l.adHocFiltersEnabled||s.length===0?[...r,...n]:[...r.map(i=>this.applyAdHocFilters(i,s)),...n]}}applyAdHocFilters(t,l){if(l.length===0||t.length===0)return t;const s=this.getApplicableFiltersForFrame(t,l);if(s.length===0)return t;if(s.some(({fieldIndex:c,filter:i})=>c===-1&&i.operator==="="))return this.reconstructDataFrame(t);const r=new Set;for(let c=0;c<t.length;c++)s.every(({matcher:d,fieldIndex:b})=>{const A=t.fields[b];return d?.(c,A,t,[t])??!1})&&r.add(c);return r.size===t.length?t:this.reconstructDataFrame(t,r)}getApplicableFiltersForFrame(t,l){return l.map(s=>{const n=t.fields.findIndex(r=>r.name===s.key);return{filter:s,fieldIndex:n,matcher:this.createValueMatcher(s,n,t)}}).filter(({filter:s,fieldIndex:n,matcher:r})=>n===-1?s.operator==="=":r!==null)}createValueMatcher(t,l,s){if(l===-1)return null;const n=s.fields[l];if(H.$.featureToggles.dashboardDsAdHocFiltering&&n.type!==j.PU.string&&n.type!==j.PU.number)return null;let r;switch(t.operator){case"=":r=Y.Js.equal;break;case"!=":r=Y.Js.notEqual;break;default:return null}try{return(0,vt.kK)({id:r,options:{value:t.value}})}catch(c){return console.warn("Failed to create value matcher for filter:",t,c),null}}reconstructDataFrame(t,l){const s=l??new Set,n=t.fields.map(r=>{const c=new Array(s.size);let i=0;for(const d of s)c[i++]=r.values[d];return{...r,values:c,state:{}}});return{...t,fields:n,length:s.size}}emitFirstLoadedDataIfMixedDS(t){return l=>{if(t.includes(N.bG)){let s=0;return l.pipe((0,gt.s)(n=>[B.Gu.Done,B.Gu.Error].includes(n.state)&&s===0?(s++,(0,J.Y)(400)):(s++,(0,J.Y)(0))),(0,ht.$)(n=>n.state===B.Gu.Done||n.state===B.Gu.Error))}return l}}testDatasource(){return Promise.resolve({message:"",status:""})}async getDrilldownsApplicability(t){return H.$.featureToggles.dashboardDsAdHocFiltering?t?.queries?.some(n=>n.adHocFiltersEnabled)?(t?.filters||[]).map(n=>n.operator!=="="&&n.operator!=="!="?{key:n.key,applicable:!1,reason:`Operator '${n.operator}' is not supported. Only '=' and '!=' operators are supported.`}:{key:n.key,applicable:!0}):[]:[]}getTagKeys(){return Promise.resolve([])}}const Dt=new D.tD(pt).setQueryEditor(lt)},46936:(K,p,e)=>{e.d(p,{C:()=>m});var D=e(96540),o=e(41654);const m=({children:I,wrap:T=!0,...C})=>{var f,v;return D.createElement(o.B,{wrap:T?"wrap":void 0,direction:(f=C.direction)!=null?f:"row",gap:(v=C.gap)!=null?v:2,...C},I)}},51575:(K,p,e)=>{e.d(p,{s:()=>T});var D=e(92908),o=e(92357),m=e(64878),I=e(15964);function T(C){return(0,D.N)(function(f,v){var E=!1,x=null,h=null,S=function(){if(h?.unsubscribe(),h=null,E){E=!1;var y=x;x=null,v.next(y)}};f.subscribe((0,m._)(v,function(y){h?.unsubscribe(),E=!0,x=y,h=(0,m._)(v,S,o.l),(0,I.Tg)(C(y)).subscribe(h)},function(){S(),v.complete()},void 0,function(){x=h=null}))})}},72316:(K,p,e)=>{e.d(p,{v:()=>m});var D=e(88483),o=e(15964);function m(I){return new D.c(function(T){(0,o.Tg)(I()).subscribe(T)})}}}]);

//# sourceMappingURL=9473.e5d28da3a811c12024b3.js.map