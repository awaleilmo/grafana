"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[5413],{8149:(te,L,t)=>{t.r(L),t.d(L,{plugin:()=>q});var v=t(16207),s=t(74848),f=t(22803),M=t(96540),d=t(38619),m=t(92745),F=t(34999),O=t(72636),A=t(18857),K=t(43243),D=t(65240),V=t(65642),w=t(75505),Z=t(81160),J=t(68143);async function Q(){return await(0,w.s)((0,J.AI)().fetch({method:"GET",url:"/apis",headers:{Accept:"application/json;g=apidiscovery.k8s.io;v=v2;as=APIGroupDiscoveryList,application/json;g=apidiscovery.k8s.io;v=v2beta1;as=APIGroupDiscoveryList,application/json"}}).pipe((0,Z.T)(r=>{for(let i of r.data.items)for(let o of i.versions)for(let c of o.resources)if(c.responseKind.group=i.metadata.name,c.responseKind.version=o.version,c.subresources)for(let b of c.subresources)b.responseKind.group=i.metadata.name,b.responseKind.version=o.version;return r.data})))}function X(r){const i=[];for(let o of r.items)for(let c of o.versions)for(let b of c.resources)i.push(b);return i}var Y=t(11205);const G=[{label:"Grafana",value:d.qD.Grafana,description:"Core grafana live features"},{label:"Data Sources",value:d.qD.DataSource,description:"Data sources with live support"},{label:"Plugins",value:d.qD.Plugin,description:"Plugins with live support"},{label:"Stream",value:d.qD.Stream,description:"data streams (eg, influx style)"},{label:"Watch",value:d.qD.Watch,description:"Watch k8s style resources"}];function k(r){const[i,o]=(0,M.useState)([]),[c,b]=(0,M.useMemo)(()=>{const g=[],S=[],N=r.value.scope,ae=r.value.namespace;if(!N?.length)return[g,S];const oe={};for(let ie of i){const U=(0,d.DG)(ie.value);!U||U.scope!==N||(oe[U.namespace]||(g.push({value:U.namespace,label:U.namespace}),oe[U.namespace]=!0),ae?.length&&ae===U.namespace&&S.push({...ie,value:U.path}))}return[g,S]},[i,r.value.scope,r.value.namespace]);(0,M.useEffect)(()=>{(0,Y.l)().then(g=>{o(g.channels)})},[r.value.scope]);const y=g=>{g.value&&r.onChange({scope:g.value,namespace:void 0,path:void 0})},W=g=>{r.onChange({scope:r.value?.scope,namespace:g?.value,path:void 0})},z=g=>{const{value:S,onChange:N}=r;N({scope:S.scope,namespace:S.namespace,path:g?.value})},p=async g=>{const S=await Q();return X(S).filter(N=>N.verbs.includes("watch")).map(N=>({value:`${N.responseKind.group}/${N.responseKind.version}/${N.resource}`,resource:N}))},{scope:T,namespace:H,path:re}=r.value,se=e(V.$W.theme2);return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(F.F,{title:(0,m.t)("live.live-channel-editor.title-grafana-live","Grafana Live"),severity:"info",children:(0,s.jsx)(m.x6,{i18nKey:"live.live-channel-editor.description-grafana-live",children:"This supports real-time event streams in Grafana core. This feature is under heavy development. Expect the interfaces and structures to change as this becomes more production ready."})}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:se.dropWrap,children:[(0,s.jsx)(O.J,{children:(0,s.jsx)(m.x6,{i18nKey:"live.live-channel-editor.scope",children:"Scope"})}),(0,s.jsx)(A.l6,{options:G,value:G.find(g=>g.value===T),onChange:y})]}),T===d.qD.Watch&&(0,s.jsx)("div",{className:se.dropWrap,children:(0,s.jsx)(K.G,{options:p,placeholder:(0,m.t)("live.live-channel-editor.placeholder-select-watchable-resource","Select watchable resource"),onChange:g=>{const S=g.resource;S&&r.onChange({scope:d.qD.Watch,namespace:S.responseKind.group,path:`${S.responseKind.version}/${S.resource}/${V.$W.bootData.user.uid}`})}})}),T&&(0,s.jsxs)("div",{className:se.dropWrap,children:[(0,s.jsx)(O.J,{children:(0,s.jsx)(m.x6,{i18nKey:"live.live-channel-editor.namespace",children:"Namespace"})}),(0,s.jsx)(A.l6,{options:c,value:c.find(g=>g.value===H)??(H?{label:H,value:H}:void 0),onChange:W,allowCustomValue:!0,backspaceRemovesValue:!0,isClearable:!0})]}),T&&H&&(0,s.jsxs)("div",{className:se.dropWrap,children:[(0,s.jsx)(O.J,{children:(0,s.jsx)(m.x6,{i18nKey:"live.live-channel-editor.path",children:"Path"})}),(0,s.jsx)(A.l6,{options:b,value:_(b,re),onChange:z,allowCustomValue:!0,backspaceRemovesValue:!0,isClearable:!0})]})]})]})}function _(r,i){const o=r.find(c=>c.value===i);if(o)return o;if(i)return{label:i,value:i}}const e=(0,D.N)(r=>({dropWrap:(0,f.css)({marginBottom:r.spacing(1)})}));var l=t(2543),n=t(51388),a=t(60519),C=t(28105),P=t(43173),h=t(33184),E=t(50275),u=t(52718),R=t(25205),I=t(50992),B=t(45861),j=(r=>(r.Raw="raw",r.JSON="json",r.Auto="auto",r.None="none",r))(j||{}),x=(r=>(r.None="none",r.JSON="json",r.Influx="influx",r))(x||{});function ee({height:r,mode:i,body:o,addr:c,onSave:b}){const y=(0,M.useMemo)(()=>i===x.JSON?o?JSON.stringify(o,null,2):"{ }":o==null?"":`${o}`,[i,o]),W=p=>{i===x.JSON?b(JSON.parse(p)):b(p)},z=async()=>{if(i===x.Influx){if(c?.scope!=="stream"){alert("expected stream scope!");return}return(0,J.AI)().post(`api/live/push/${c.namespace}`,o)}if(!(0,d.aj)(c)){alert("invalid address");return}const p=await(0,h.oF)().publish(c,o);console.log("onPublishClicked (response from publish)",p)};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(I.B,{height:r-32,language:i===x.JSON?"json":"text",value:y,onBlur:W,onSave:W,showMiniMap:!1,showLineNumbers:!0}),(0,s.jsx)("div",{style:{height:32},children:(0,s.jsx)(B.$n,{onClick:z,children:(0,s.jsx)(m.x6,{i18nKey:"live.live-publish.publish",children:"Publish"})})})]})}class ne extends M.PureComponent{constructor(i){super(i),this.styles=$(P.$.theme2),this.streamObserver={next:o=>{(0,d.ew)(o)?this.setState({status:o,changed:Date.now()}):(0,d.Z7)(o)?this.setState({message:o.message,changed:Date.now()}):console.log("ignore",o)}},this.unsubscribe=()=>{this.subscription&&(this.subscription.unsubscribe(),this.subscription=void 0)},this.isValid=!!(0,h.oF)(),this.state={changed:0}}async componentDidMount(){this.loadChannel()}componentWillUnmount(){this.subscription&&this.subscription.unsubscribe()}componentDidUpdate(i){this.props.options?.channel!==i.options?.channel&&this.loadChannel()}async loadChannel(){const i=this.props.options?.channel;if(!(0,d.aj)(i)){console.log("INVALID",i),this.unsubscribe(),this.setState({addr:void 0});return}if((0,l.isEqual)(i,this.state.addr)){console.log("Same channel",this.state.addr);return}const o=(0,h.oF)();if(!o){console.log("INVALID",i),this.unsubscribe(),this.setState({addr:void 0});return}this.unsubscribe(),console.log("LOAD",i);try{this.subscription=o.getStream(i).subscribe(this.streamObserver),this.setState({addr:i,error:void 0})}catch(c){this.setState({addr:void 0,error:c})}}renderNotEnabled(){return(0,s.jsxs)(F.F,{title:(0,m.t)("live.live-panel.title-grafana-live","Grafana Live"),severity:"info",children:[(0,s.jsx)("p",{children:(0,s.jsx)(m.x6,{i18nKey:"live.live-panel.grafana-requires-feature",children:"Grafana live requires a feature flag to run"})}),(0,s.jsx)("b",{children:"custom.ini:"}),(0,s.jsx)("pre",{children:`[feature_toggles]
    enable = live`})]})}renderMessage(i){const{options:o}=this.props,{message:c}=this.state;if(!c)return(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{children:(0,s.jsx)(m.x6,{i18nKey:"live.live-panel.waiting-for-data",children:"Waiting for data:"})}),o.channel?.scope,"/",o.channel?.namespace,"/",o.channel?.path]});if(o.display===j.JSON)return(0,s.jsx)(E.B,{json:c,open:5});if(o.display===j.Auto&&c instanceof n.k9){const b={series:(0,a.we)({data:[c],theme:P.$.theme2,replaceVariables:W=>W,fieldConfig:{defaults:{},overrides:[]}}),state:C.Gu.Streaming},y={...this.props,options:{frameIndex:0,showHeader:!0}};return(0,s.jsx)(R.L,{...y,data:b,height:i})}return(0,s.jsx)("pre",{children:JSON.stringify(c)})}renderPublish(i){const{options:o}=this.props;return(0,s.jsx)(ee,{height:i,body:o.message,mode:o.publish??x.JSON,onSave:c=>this.props.onOptionsChange({...o,message:c}),addr:this.state.addr})}renderStatus(){const{status:i}=this.state;if(i?.state===d.ZF.Connected)return;let o="";return i&&(o=this.styles.status[i.state]),(0,s.jsx)("div",{className:(0,f.cx)(o,this.styles.statusWrap),children:i?.state})}renderBody(){const{status:i}=this.state,{options:o,height:c}=this.props;if(o.publish===x.JSON||o.publish===x.Influx){if(o.display===j.None)return this.renderPublish(c);const y=c/2;return(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{style:{height:y,overflow:"hidden"},children:(0,s.jsx)(u.E,{autoHeightMin:"100%",autoHeightMax:"100%",children:this.renderMessage(y)})}),(0,s.jsx)("div",{children:this.renderPublish(y)})]})}return o.display===j.None?(0,s.jsx)("pre",{children:JSON.stringify(i)}):(0,s.jsx)("div",{style:{overflow:"hidden",height:c},children:(0,s.jsx)(u.E,{autoHeightMin:"100%",autoHeightMax:"100%",children:this.renderMessage(c)})})}render(){if(!this.isValid)return this.renderNotEnabled();const{addr:i,error:o}=this.state;return i?o?(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{children:(0,s.jsx)(m.x6,{i18nKey:"live.live-panel.error",children:"Error"})}),(0,s.jsx)("div",{children:JSON.stringify(o)})]}):(0,s.jsxs)(s.Fragment,{children:[this.renderStatus(),this.renderBody()]}):(0,s.jsx)(F.F,{title:(0,m.t)("live.live-panel.title-grafana-live","Grafana Live"),severity:"info",children:(0,s.jsx)(m.x6,{i18nKey:"live.live-panel.panel-editor-channel",children:"Use the panel editor to pick a channel"})})}}const $=(0,D.N)(r=>({statusWrap:(0,f.css)({margin:"auto",position:"absolute",top:0,right:0,background:r.components.panel.background,padding:"10px",zIndex:r.zIndex.modal}),status:{[d.ZF.Pending]:(0,f.css)({border:`1px solid ${r.v1.palette.orange}`}),[d.ZF.Connected]:(0,f.css)({border:`1px solid ${r.colors.success.main}`}),[d.ZF.Connecting]:(0,f.css)({border:`1px solid ${r.v1.palette.brandWarning}`}),[d.ZF.Disconnected]:(0,f.css)({border:`1px solid ${r.colors.warning.main}`}),[d.ZF.Shutdown]:(0,f.css)({border:`1px solid ${r.colors.error.main}`}),[d.ZF.Invalid]:(0,f.css)({border:"1px solid red"})}})),q=new v.m(ne).setPanelOptions(r=>{r.addCustomEditor({category:["Channel"],id:"channel",path:"channel",name:"Channel",editor:k,defaultValue:{}}),r.addRadio({path:"display",name:"Show message",description:"Display the last message received on this channel",settings:{options:[{value:j.Raw,label:"Raw Text"},{value:j.JSON,label:"JSON"},{value:j.Auto,label:"Auto"},{value:j.None,label:"None"}]},defaultValue:j.JSON}).addRadio({path:"publish",name:"Publish",description:"Display a form to publish values",settings:{options:[{value:x.None,label:"None"},{value:x.JSON,label:"JSON"},{value:x.Influx,label:"Influx"}]},defaultValue:x.None})})},11205:(te,L,t)=>{t.d(L,{l:()=>f});var v=t(77154),s=t(68143);async function f(){return(0,s.AI)().get("api/live/list").then(M=>{const d=M.channels??[],m={},F=d.map(O=>{if(O.data){const A=new Set,K=(0,v.or)(O.data);for(const D of K.fields)A.add(D.name);m[O.channel]=Array.from(A).map(D=>({value:D,label:D}))}return{value:O.channel,label:O.channel+" ["+O.minute_rate+" msg/min]"}});return{channelFields:m,channels:F}})}},16264:()=>{},25205:(te,L,t)=>{t.d(L,{L:()=>Q});var v=t(74848),s=t(22803),f=t(96540),M=t(16515),d=t(57866),m=t(84229),F=t(43173),O=t(14477),A=t(64400),K=t(18857),D=t(63142),V=t(11142),w=t(65642),Z=t(73163),J=t(32776);function Q(n){const{data:a,height:C,width:P,options:h,fieldConfig:E,id:u,timeRange:R,replaceVariables:I,transparent:B}=n;(0,f.useMemo)(()=>{(0,M.Fm)(a.series)},[a.series]);const j=(0,D.$j)(),x=(0,A.d2)(),ee=(0,f.useMemo)(()=>x.canExecuteActions?.()??!1,[x]),ne=(0,f.useCallback)((p,T,H)=>ee?e(p,T,H,I):[],[I,ee]),$=(0,J.gy)(a.series)?(0,J.S5)(a.series):a.series,q=$?.length,r=$.some(p=>p.fields.length>0),i=X($,h),o=$[i];let c=C;if(!q||!r)return(0,v.jsx)(O.a,{panelId:u,fieldConfig:E,data:a});if(q>1){const p=j.spacing.gridSize*j.components.height.md,T=j.spacing.gridSize;c=C-p-T}const b=x.sync&&x.sync()!==m.y.Off,y=(0,w.zj)().disableSanitizeHtml,W=(0,v.jsx)(V.i,{height:c,width:P,data:o,noHeader:!h.showHeader,showTypeIcons:h.showTypeIcons,resizable:!0,initialSortBy:h.sortBy,onSortByChange:p=>G(p,n),onColumnResize:(p,T)=>Y(p,T,n),onCellFilterAdded:x.onAddAdHocFilter,frozenColumns:h.frozenColumns?.left,enablePagination:h.enablePagination,cellHeight:h.cellHeight,maxRowHeight:h.maxRowHeight,timeRange:R,enableSharedCrosshair:F.$.featureToggles.tableSharedCrosshair&&b,fieldConfig:E,getActions:ne,structureRev:a.structureRev,transparent:B,disableSanitizeHtml:y});if(q===1)return W;const z=$.map((p,T)=>({label:(0,M.Ri)(p),value:T}));return(0,v.jsxs)("div",{className:l.wrapper,children:[W,(0,v.jsx)("div",{className:l.selectWrapper,children:(0,v.jsx)(K.l6,{options:z,value:z[i],onChange:p=>k(p,n)})})]})}function X(n,a){return a.frameIndex>0&&a.frameIndex<n.length?a.frameIndex:0}function Y(n,a,C){const{fieldConfig:P}=C,{overrides:h}=P,E=d.Ct.byName,u="custom.width",R=h.find(I=>I.matcher.id===E&&I.matcher.options===n);if(R){const I=R.properties.find(B=>B.id===u);I?I.value=a:R.properties.push({id:u,value:a})}else h.push({matcher:{id:E,options:n},properties:[{id:u,value:a}]});C.onFieldConfigChange({...P,overrides:h})}function G(n,a){a.onOptionsChange({...a.options,sortBy:n})}function k(n,a){a.onOptionsChange({...a.options,frameIndex:n.value||0})}const _=n=>n,e=(n,a,C,P)=>{if((a.config.actions?.length??0)>0){const E=(0,Z.ko)(n,a,a.state.scopedVars,P??_,a.config.actions??[],{valueRowIndex:C});if(E.length===1)return E;{const u=[],R=new Set;return E.forEach(I=>{const B=I.title;R.has(B)||(u.push(I),R.add(B))}),u}}return[]},l={wrapper:(0,s.css)({display:"flex",flexDirection:"column",justifyContent:"space-between",height:"100%"}),selectWrapper:(0,s.css)({padding:"8px 8px 0px 8px"})}},32776:(te,L,t)=>{t.d(L,{S5:()=>X,fq:()=>F,gy:()=>Y,l1:()=>J});var v=t(2543),s=t.n(v),f=t(57866),M=t(4575),d=t(33553),m=t(95004);const F=e=>(!e.pluginVersion&&"columns"in e&&console.log("Was angular table",e),G(e),k(e),_(e),e.options),O={timeseries_to_rows:"seriesToRows",timeseries_to_columns:"seriesToColumns",timeseries_aggregations:"reduce",table:"merge"},A={avg:"mean",min:"min",max:"max",total:"sum",current:"lastNotNull",count:"count"},K={cell:"color-background",row:"color-background",value:"color-text"},D=(e,l)=>[-1/0,...e].map((n,a)=>({color:l[a],value:(0,v.isNumber)(n)?n:parseInt(n,10)})),V=(e,l)=>{const n=e.transformations??[];if(Object.keys(O).includes(l.transform)){const a={reducers:[]};l.transform==="timeseries_aggregations"&&(a.includeTimeField=!1,a.reducers=l.columns.map(C=>A[C.value])),n.push({id:O[l.transform],options:a})}return n},w=e=>{const n={matcher:{id:/^\/.*\/$/.test(e.pattern)?f.Ct.byRegexp:f.Ct.byName,options:e.pattern},properties:[]};return e.alias&&n.properties.push({id:"displayName",value:e.alias}),e.unit&&n.properties.push({id:"unit",value:e.unit}),e.decimals!==void 0&&n.properties.push({id:"decimals",value:e.decimals}),e.type==="date"&&n.properties.push({id:"unit",value:`time: ${e.dateFormat}`}),e.type==="hidden"&&n.properties.push({id:"custom.hidden",value:!0}),e.link&&n.properties.push({id:"links",value:[{title:(0,v.defaultTo)(e.linkTooltip,""),url:(0,v.defaultTo)(e.linkUrl,""),targetBlank:(0,v.defaultTo)(e.linkTargetBlank,!1)}]}),e.colorMode&&n.properties.push({id:"custom.cellOptions",value:{type:K[e.colorMode]}}),e.align&&n.properties.push({id:"custom.align",value:e.align==="auto"?null:e.align}),e.thresholds?.length&&e.colors?.length&&n.properties.push({id:"thresholds",value:{mode:d.O.Absolute,steps:D(e.thresholds,e.colors)}}),n},Z=e=>{let l={custom:{}};if(e){if(l=(0,v.omitBy)({unit:e.unit,decimals:e.decimals,displayName:e.alias,custom:{align:e.align==="auto"?null:e.align}},v.isNil),e.thresholds&&e.thresholds.length){const n={mode:d.O.Absolute,steps:D(e.thresholds,e.colors)};l.thresholds=n}e.colorMode&&(l.custom.cellOptions={type:K[e.colorMode]})}return l},J=(e,l,n)=>{if(l==="table-old"&&n.angular){const a=n.angular,C=V(e,a),P=a.styles.find(u=>u.pattern==="/.*/"),h=Z(P),E=a.styles.filter(u=>u.pattern!=="/.*/").map(w);e.transformations=C,e.fieldConfig={defaults:h,overrides:E}}return{}},Q=e=>e?.filter(l=>l.meta?.custom?.parentRowIndex===void 0)||[e?.[0]],X=e=>{const l=[];return Q(e).filter(a=>!!a&&a.length!==0)?.forEach(a=>{const C=e?.filter(u=>a.refId===u.refId&&u.meta?.custom?.parentRowIndex!==void 0),P=(0,v.groupBy)(C,u=>u.meta?.custom?.parentRowIndex),h=Object.keys(P).map(u=>P[u]),E={...a};C&&C.length>0&&E.fields.push({name:"nested",type:m.PU.nestedFrames,config:{},values:h}),l.push(E)}),l},Y=e=>e?.some(l=>l.meta?.custom?.parentRowIndex!==void 0),G=e=>{if(e.fieldConfig?.defaults.custom?.wrapText!==void 0)return;const l=e.fieldConfig?.defaults.custom?.cellOptions?.wrapText;return e.fieldConfig.overrides=e.fieldConfig.overrides.map(n=>(n.properties&&(n.properties=n.properties.flatMap(a=>a.id==="custom.cellOptions"&&a.value&&a.value.wrapText!==void 0?[{...a,value:{...(0,v.omit)(a.value,"wrapText")}},{id:"custom.wrapText",value:a.value.wrapText}]:[a])),n)),e.fieldConfig.defaults.custom=e.fieldConfig.defaults.custom??{},e.fieldConfig.defaults.custom.wrapText=l,delete e.fieldConfig.defaults.custom.cellOptions?.wrapText,e},k=e=>(e.fieldConfig.overrides=e.fieldConfig.overrides.map(l=>(l.properties&&(l.properties=l.properties.map(n=>n.id==="custom.hidden"?{...n,id:"custom.hideFrom.viz"}:n)),l)),e),_=e=>{if(e.options&&"footer"in e.options){const l=e.options.footer;if(l.show){const n=l.reducer;e.fieldConfig.defaults.custom={...e.fieldConfig.defaults.custom,footer:{reducers:n}},l.countRows&&n[0]==="count"?e.fieldConfig.defaults.custom.footer.reducers=["countAll"]:l.fields&&l.fields.length>1?(delete e.fieldConfig.defaults.custom.footer,e.fieldConfig.overrides.push({matcher:{id:f.Ct.byNames,options:{mode:M.PP.include,names:l.fields}},properties:[{id:"custom.footer.reducers",value:n}]})):l.fields&&l.fields.length===1&&(delete e.fieldConfig.defaults.custom.footer,e.fieldConfig.overrides.push({matcher:{id:f.Ct.byName,options:l.fields[0]},properties:[{id:"custom.footer.reducers",value:n}]}))}l.enablePagination!=null&&(e.options.enablePagination=l.enablePagination),delete e.options.footer}}}}]);

//# sourceMappingURL=livePanel.e4c7307fe8ee3e219b7c.js.map