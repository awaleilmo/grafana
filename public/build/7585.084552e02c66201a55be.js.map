{"version":3,"file":"7585.084552e02c66201a55be.js","mappings":"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","sources":["webpack://grafana/./public/app/features/expressions/components/GenAI/sqlPromptConfig.ts","webpack://grafana/./public/app/features/expressions/components/GenAI/GenAISQLExplainButton.tsx"],"sourcesContent":["/**\n * Configuration file for SQL AI prompts used across expression components\n * NOTE: Schema and error context information integration is planned for future implementation\n */\n\nimport { DataQuery } from '@grafana/schema';\n\n// Common SQL context information shared across all prompts\nconst COMMON_SQL_CONTEXT = {\n  engineInfo: 'MySQL dialectic based on dolthub go-mysql-server. The tables are all in memory',\n  refIdExplanation: 'RefIDs (A, B, C, etc.) represent data from other queries',\n  columnInfo: 'value should always be represented as __value__',\n} as const;\n\n// Template placeholders used in prompts\nconst TEMPLATE_PLACEHOLDERS = {\n  refIds: '{refIds}',\n  currentQuery: '{currentQuery}',\n  queryInstruction: '{queryInstruction}',\n  schemaInfo: '{schemaInfo}', // Note: Schema information will be implemented in future updates\n  errorContext: '{errorContext}', // Note: Error context will be implemented in future updates\n  queryContext: '{queryContext}',\n} as const;\n\nexport interface QueryUsageContext {\n  panelId?: string;\n  alerting?: boolean;\n  queries?: DataQuery[];\n  dashboardContext?: {\n    dashboardTitle?: string;\n    panelName?: string;\n  };\n  datasources?: string[];\n  totalRows?: number;\n  requestTime?: number;\n  numberOfQueries?: number;\n  seriesData?: unknown;\n}\n\n/**\n * System prompt for SQL suggestion generation with enhanced context\n */\nconst SQL_SUGGESTION_SYSTEM_PROMPT = `You are a SQL expert for Grafana expressions specializing in time series data analysis.\nIMPORTANT - Current SQL Errors (if any): ${TEMPLATE_PLACEHOLDERS.errorContext}\n\nSQL dialect required by Grafana expressions: ${COMMON_SQL_CONTEXT.engineInfo}\n\nRefIDs context: ${COMMON_SQL_CONTEXT.refIdExplanation}\nGrafana specific context: ${COMMON_SQL_CONTEXT.columnInfo}\n\nAvailable RefIDs to use in composable queries: ${TEMPLATE_PLACEHOLDERS.refIds}\n\nCurrent query to be improved: ${TEMPLATE_PLACEHOLDERS.currentQuery}\n\nSchema information to use in composable queries: ${TEMPLATE_PLACEHOLDERS.schemaInfo}\n\n${TEMPLATE_PLACEHOLDERS.queryContext}\n\nQuery instruction: ${TEMPLATE_PLACEHOLDERS.queryInstruction}\n\nYou may be able to derive schema information from the series data in queryContext.\n\nGiven the above data, help users with their SQL query by:\n- **PRIORITY: If there are errors listed above, focus on fixing them first**\n- Fixing syntax errors using available field and data type information\n- Suggesting optimal queries based on actual data schema and patterns.\n- Look at query context stats: totalRows, requestTime, numberOfQueries, and if it looks like performance should be part of the conversation, suggest optimizing for performance. Note indexing is not supported in Grafana expressions.\n- Leveraging time series patterns and Grafana-specific use cases\n\nGuidelines:\n- Use proper field names and types based on schema information\n- Include LIMIT clauses for performance unless aggregating\n- Consider time-based filtering and grouping for time series data\n- Suggest meaningful aggregations for metric data\n- Use appropriate JOIN conditions when correlating multiple RefIDs\n`;\n\n/**\n * System prompt for SQL explanation generation with enhanced context\n */\nconst SQL_EXPLANATION_SYSTEM_PROMPT = `You are an expert in SQL and Grafana SQL expressions with deep knowledge of time series data.\n\nSQL dialect: ${COMMON_SQL_CONTEXT.engineInfo}\n\nRefIDs: ${COMMON_SQL_CONTEXT.refIdExplanation}\n\nGrafana specific context: ${COMMON_SQL_CONTEXT.columnInfo}\n\nAvailable RefIDs: ${TEMPLATE_PLACEHOLDERS.refIds}\n\nSchema: ${TEMPLATE_PLACEHOLDERS.schemaInfo}\n\n${TEMPLATE_PLACEHOLDERS.queryContext}\n\nExplain SQL queries clearly and concisely, focusing on:\n- What data is being selected and from which RefIDs\n- How the data is being transformed or aggregated\n- The purpose and business meaning of the query using dashboard and panel name from query context if relevant\n- Performance implications and optimization opportunities. Database columns can not be indexed in context of Grafana sql expressions. Don't focus on \n  performance unless the query context has a requestTime or totalRows that looks like it could benefit from it.\n- Time series specific patterns and their significance\n\nProvide a clear explanation of what this SQL query does:`;\n\n/**\n * Generate query context text for prompts\n */\nconst generateQueryContext = (queryContext?: QueryUsageContext): string => {\n  if (!queryContext) {\n    return '';\n  }\n\n  const contextParts = [];\n  if (queryContext.panelId) {\n    contextParts.push(\n      `Panel Type: ${queryContext.panelId}. Please use this to generate suggestions that are relevant to the panel type.`\n    );\n  }\n  if (queryContext.alerting) {\n    contextParts.push(\n      'Context: Alerting rule (focus on boolean/threshold results). Please use this to generate suggestions that are relevant to the alerting rule.'\n    );\n  }\n  if (queryContext.queries) {\n    const queriesText = Array.isArray(queryContext.queries)\n      ? JSON.stringify(queryContext.queries, null, 2)\n      : String(queryContext.queries);\n    contextParts.push(`Queries available to use in the SQL Expression: ${queriesText}`);\n  }\n  if (queryContext.dashboardContext) {\n    const dashboardText =\n      typeof queryContext.dashboardContext === 'object'\n        ? JSON.stringify(queryContext.dashboardContext, null, 2)\n        : String(queryContext.dashboardContext);\n    contextParts.push(`Dashboard context (dashboard title and panel name): ${dashboardText}`);\n  }\n  if (queryContext.datasources) {\n    const datasourcesText = Array.isArray(queryContext.datasources)\n      ? JSON.stringify(queryContext.datasources, null, 2)\n      : String(queryContext.datasources);\n    contextParts.push(`Datasources available to use in the SQL Expression: ${datasourcesText}`);\n  }\n  if (queryContext.totalRows) {\n    contextParts.push(`Total rows in the query: ${queryContext.totalRows}`);\n  }\n  if (queryContext.requestTime) {\n    contextParts.push(`Request time: ${queryContext.requestTime}`);\n  }\n  if (queryContext.numberOfQueries) {\n    contextParts.push(`Number of queries: ${queryContext.numberOfQueries}`);\n  }\n  if (queryContext.seriesData) {\n    const seriesDataText =\n      typeof queryContext.seriesData === 'object'\n        ? JSON.stringify(queryContext.seriesData, null, 2)\n        : String(queryContext.seriesData);\n    contextParts.push(`Series data: ${seriesDataText}`);\n  }\n\n  return contextParts.length\n    ? `Query Context:\n${contextParts.join('\\n')}`\n    : '';\n};\n\n/**\n * Enhanced interface for prompt generation variables\n */\nexport interface SQLPromptVariables {\n  refIds: string;\n  currentQuery: string;\n  queryInstruction: string;\n  schemas?: unknown; // Reserved for future schema implementation\n  errorContext?: string[];\n  queryContext?: QueryUsageContext;\n}\n\n/**\n * Generate the complete system prompt for SQL suggestions with enhanced context\n *\n * Note: Schema information integration is planned for future implementation\n */\nexport const getSQLSuggestionSystemPrompt = (variables: SQLPromptVariables): string => {\n  const queryContext = generateQueryContext(variables.queryContext);\n  const schemaInfo = ''; // Placeholder for future schema information\n  const errorContext = variables.errorContext?.length\n    ? variables.errorContext.join('\\n')\n    : 'No current errors detected.';\n\n  return SQL_SUGGESTION_SYSTEM_PROMPT.replaceAll(TEMPLATE_PLACEHOLDERS.refIds, variables.refIds)\n    .replaceAll(TEMPLATE_PLACEHOLDERS.currentQuery, variables.currentQuery)\n    .replaceAll(TEMPLATE_PLACEHOLDERS.queryInstruction, variables.queryInstruction)\n    .replaceAll(TEMPLATE_PLACEHOLDERS.schemaInfo, schemaInfo)\n    .replaceAll(TEMPLATE_PLACEHOLDERS.errorContext, errorContext)\n    .replaceAll(TEMPLATE_PLACEHOLDERS.queryContext, queryContext);\n};\n\n/**\n * Generate the complete system prompt for SQL explanations with enhanced context\n */\nexport const getSQLExplanationSystemPrompt = (variables: Omit<SQLPromptVariables, 'queryInstruction'>): string => {\n  const queryContext = generateQueryContext(variables.queryContext);\n\n  const schemaInfo = ''; // Placeholder for future schema information\n\n  return SQL_EXPLANATION_SYSTEM_PROMPT.replaceAll(TEMPLATE_PLACEHOLDERS.refIds, variables.refIds)\n    .replaceAll(TEMPLATE_PLACEHOLDERS.schemaInfo, schemaInfo)\n    .replaceAll(TEMPLATE_PLACEHOLDERS.queryContext, queryContext);\n};\n","import { useCallback } from 'react';\n\nimport { t } from '@grafana/i18n';\n\nimport { GenAIButton } from '../../../dashboard/components/GenAI/GenAIButton';\nimport { EventTrackingSrc } from '../../../dashboard/components/GenAI/tracking';\nimport { Message, Role } from '../../../dashboard/components/GenAI/utils';\n\nimport { getSQLExplanationSystemPrompt, QueryUsageContext } from './sqlPromptConfig';\n\ninterface GenAISQLExplainButtonProps {\n  currentQuery: string;\n  onExplain: (explanation: string) => void;\n  refIds: string[];\n  schemas?: unknown; // Reserved for future schema implementation\n  queryContext?: QueryUsageContext;\n}\n\n// AI prompt for explaining SQL expressions\n\nconst getExplanationPrompt = (currentQuery: string): string => {\n  if (!currentQuery || currentQuery.trim() === '') {\n    return 'There is no SQL query to explain. Please enter a SQL expression first.';\n  }\n\n  return `${currentQuery}\n\nExplain what this query does in simple terms.`;\n};\n\n/**\n * Creates messages for the LLM to explain SQL queries\n *\n * @param refIds - The list of RefIDs available in the current context\n * @param currentQuery - The current SQL query to explain\n * @param schemas - Optional schema information (planned for future implementation)\n * @param queryContext - Optional query usage context\n * @returns A list of messages to be sent to the LLM for explaining the SQL query\n */\nconst getSQLExplanationMessages = (\n  refIds: string[],\n  currentQuery: string,\n  schemas?: unknown,\n  queryContext?: QueryUsageContext\n): Message[] => {\n  const systemPrompt = getSQLExplanationSystemPrompt({\n    refIds: refIds.length > 0 ? refIds.join(', ') : 'A',\n    currentQuery: currentQuery.trim() || 'No current query provided',\n    schemas, // Will be utilized once schema extraction is implemented\n    queryContext,\n  });\n\n  const userPrompt = getExplanationPrompt(currentQuery);\n\n  return [\n    {\n      role: Role.system,\n      content: systemPrompt,\n    },\n    {\n      role: Role.user,\n      content: userPrompt,\n    },\n  ];\n};\n\nexport const GenAISQLExplainButton = ({\n  currentQuery,\n  onExplain,\n  queryContext,\n  refIds,\n  schemas, // Future implementation will use this for enhanced context\n}: GenAISQLExplainButtonProps) => {\n  const messages = useCallback(() => {\n    return getSQLExplanationMessages(refIds, currentQuery, schemas, queryContext);\n  }, [refIds, currentQuery, schemas, queryContext]);\n\n  const hasQuery = currentQuery && currentQuery.trim() !== '';\n\n  return (\n    <GenAIButton\n      disabled={!hasQuery}\n      eventTrackingSrc={EventTrackingSrc.sqlExpressions}\n      messages={messages}\n      onGenerate={onExplain}\n      temperature={0.3}\n      text={t('sql-expressions.explain-query', 'Explain query')}\n      timeout={60000} // 60 seconds\n      toggleTipTitle={t('sql-expressions.ai-explain-title', 'AI-powered SQL expression explanation')}\n      tooltip={\n        !hasQuery\n          ? t('sql-expressions.explain-empty-query-tooltip', 'Enter a SQL expression to get an explanation')\n          : t(\n              'expressions.sql-expr.tooltip-experimental',\n              'SQL Expressions LLM integration is experimental. Please report any issues to the Grafana team.'\n            )\n      }\n    />\n  );\n};\n"],"names":["COMMON_SQL_CONTEXT","TEMPLATE_PLACEHOLDERS","SQL_SUGGESTION_SYSTEM_PROMPT","SQL_EXPLANATION_SYSTEM_PROMPT","generateQueryContext","queryContext","contextParts","queriesText","dashboardText","datasourcesText","seriesDataText","getSQLSuggestionSystemPrompt","variables","schemaInfo","errorContext","getSQLExplanationSystemPrompt","getExplanationPrompt","currentQuery","getSQLExplanationMessages","refIds","schemas","systemPrompt","userPrompt","GenAISQLExplainButton","onExplain","messages","hasQuery"],"sourceRoot":""}