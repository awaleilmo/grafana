(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[3686],{4392:(I,v,d)=>{"use strict";d.d(v,{A:()=>h});var s=d(94701),i=function(b){(0,s.A)(function(){b()})};const h=i},6255:I=>{"use strict";I.exports=function(){var v=this;v.instances.forEach(function(d){d.reset()})}},7641:I=>{"use strict";I.exports={option:"alt",command:"meta",return:"enter",escape:"esc",mod:/Mac|iPod|iPhone|iPad/.test(navigator.platform)?"meta":"ctrl"}},7922:(I,v,d)=>{"use strict";I.exports=function(s,i,h,b){var L=this,M,g;L.stopCallback(i,i.target||i.srcElement,h,b)||s(i,h)===!1&&(M=d(12156),M(i),g=d(31849),g(i))}},11065:(I,v,d)=>{"use strict";d.d(v,{R:()=>i});var s=d(84140);function i(h,b,L){if(h.isLight)return b;{if(L){const _=(0,s.A)(b);return s.A.mostReadable(L,[_.clone().lighten(25),_.clone().lighten(10),_,_.clone().darken(10),_.clone().darken(25)],{includeFallbackColors:!1}).toHex8String()}const M=(0,s.A)(b).toHsl();M.l=1-M.l;const g=(0,s.A)(M);return g.isLight()?g.darken(5).toHex8String():g.lighten(5).toHex8String()}}},11908:(I,v,d)=>{"use strict";d.d(v,{s:()=>s});var s;(function(i){i[i.UNSET=0]="UNSET",i[i.OK=1]="OK",i[i.ERROR=2]="ERROR"})(s||(s={}))},12156:I=>{"use strict";I.exports=function(v){if(v.preventDefault){v.preventDefault();return}v.returnValue=!1}},12904:I=>{I.exports=v,I.exports.on=v,I.exports.off=d;function v(s,i,h,b){return!s.addEventListener&&(i="on"+i),(s.addEventListener||s.attachEvent).call(s,i,h,b),h}function d(s,i,h,b){return!s.removeEventListener&&(i="on"+i),(s.removeEventListener||s.detachEvent).call(s,i,h,b),h}},14082:I=>{"use strict";I.exports={106:"*",107:"plus",109:"minus",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"}},16004:I=>{"use strict";I.exports=function(v,d,s){var i=this;return s||(s=i.getReverseMap()[v]?"keydown":"keypress"),s==="keypress"&&d.length&&(s="keydown"),s}},19132:(I,v,d)=>{"use strict";I.exports=function(s,i,h,b,L,M){var g=this,_,U,R=[],H=h.type,D,ne;if(H==="keypress"&&!(h.code&&h.code.slice(0,5)==="Arrow")){var me=g.callbacks["any-character"]||[];me.forEach(function(w){R.push(w)})}if(!g.callbacks[s])return R;for(D=d(95962),H==="keyup"&&D(s)&&(i=[s]),_=0;_<g.callbacks[s].length;++_)if(U=g.callbacks[s][_],!(!b&&U.seq&&g.sequenceLevels[U.seq]!==U.level)&&H===U.action&&(ne=d(27238),H==="keypress"&&!h.metaKey&&!h.ctrlKey||ne(i,U.modifiers))){var X=!b&&U.combo===L,x=b&&U.seq===b&&U.level===M;(X||x)&&g.callbacks[s].splice(_,1),R.push(U)}return R}},20301:(I,v,d)=>{"use strict";d.d(v,{Z:()=>L});var s=d(22803),i=d(96540),h=d(45861),b=d(63142);const L=({className:g,..._})=>{const U=(0,b.of)(M);return i.createElement(h.$n,{..._,className:(0,s.cx)(g,U.button)})},M=g=>({button:(0,s.css)({paddingLeft:g.spacing(3/2),paddingRight:g.spacing(3/2)})})},21961:(I,v,d)=>{"use strict";d.d(v,{Ay:()=>z});var s=d(74848),i=d(22803),h=d(46942),b=d.n(h),L=d(30703),M=d(63142),g=d(11065),_=d(96540),U=d(92745),R=d(45967),H=d(45861);const D=()=>({CopyIcon:(0,i.css)({backgroundColor:"transparent",border:"none",color:"inherit",overflow:"hidden","&:focus":{backgroundColor:"rgba(255, 255, 255, 0.25)",color:"inherit"}})});function ne({copyText:k,icon:V="copy",tooltipTitle:S}){const $=(0,M.of)(D),[B,P]=(0,_.useState)(!1),Y=()=>{navigator.clipboard.writeText(k),P(!0)};return(0,s.jsx)(R.m,{content:B?(0,U.t)("explore.trace-view.tooltip-copy-icon","Copied"):S,children:(0,s.jsx)(H.$n,{"aria-label":(0,U.t)("explore.trace-view.aria-label-copy","Copy to clipboard"),className:b()($.CopyIcon),type:"button",icon:V,onClick:Y})})}const me="    ";function X(k){let V="";return k&&Object.keys(k).forEach(function(S){V+=S+":"+k[S]+";"}),V}function x(k){function V($){return'class="'+$+'"'}function S($){return'style="'+X(k["."+$])+'"'}return k?S:V}function w(k){return k===null?"null":Array.isArray(k)?"array":typeof k=="string"&&/^https?:/.test(k)?"link":typeof k=="object"&&typeof k.toISOString=="function"?"date":typeof k}function E(k){return k.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function W(k,V){let S="";const $=x(V);let B=function(Y,le,we,Ge){if(!Y.length)return le+" "+we;let ae=le+`
`;return S+=me,Y.forEach(function(Te,De){ae+=S+Ge(Te)+(De<Y.length-1?",":"")+`
`}),S=S.slice(0,-me.length),ae+S+we};function P(Y){if(Y===void 0)return"";switch(w(Y)){case"boolean":return"<span "+$("json-markup-bool")+">"+Y+"</span>";case"number":return"<span "+$("json-markup-number")+">"+Y+"</span>";case"date":return'<span class="json-markup-string">"'+E(Y.toISOString())+'"</span>';case"null":return"<span "+$("json-markup-null")+">null</span>";case"string":return"<span "+$("json-markup-string")+'>"'+E(Y.replace(/\n/g,`
`+S))+'"</span>';case"link":return"<span "+$("json-markup-string")+'>"<a href="'+encodeURI(Y)+'">'+E(Y)+'</a>"</span>';case"array":return B(Y,"[","]",P);case"object":const le=Object.keys(Y).filter(function(we){return Y[we]!==void 0});return B(le,"{","}",function(we){return"<span "+$("json-markup-key")+'>"'+E(we)+'":</span> '+P(Y[we])})}return""}return"<div "+$("json-markup")+">"+P(k)+"</div>"}const te="copyIcon",q=k=>({KeyValueTable:(0,i.css)({label:"KeyValueTable",background:(0,g.R)(k,"#fff"),border:`1px solid ${(0,g.R)(k,"#ddd")}`,marginBottom:"0.5rem",maxHeight:"450px",overflow:"auto"}),table:(0,i.css)({width:"100%"}),body:(0,i.css)({label:"body",verticalAlign:"baseline"}),row:(0,i.css)({label:"row","& > td":{padding:"0 0.5rem",height:"30px"},"&:nth-child(2n) > td":{background:(0,g.R)(k,"#f5f5f5")},[`&:not(:hover) .${te}`]:{visibility:"hidden"},"a span":{color:`${k.colors.text.link} !important`},"a:hover span":{textDecoration:"underline"}}),keyColumn:(0,i.css)({label:"keyColumn",color:(0,g.R)(k,"#888"),whiteSpace:"pre",width:"125px"}),copyColumn:(0,i.css)({label:"copyColumn",textAlign:"right"}),linkIcon:(0,i.css)({label:"linkIcon",verticalAlign:"middle",fontWeight:"bold"}),jsonTable:(0,i.css)({display:"inline-block"})}),J=/^(\[|\{)/;function be(k){if(typeof k=="string"&&J.test(k))try{return JSON.parse(k)}catch{}return k}const K=({link:k,children:V})=>{const{path:S,title:$="",onClick:B,icon:P="external-link-alt"}=k;return(0,s.jsxs)("a",{href:S,title:$,onClick:B,target:"_blank",rel:"noopener noreferrer",children:[V," ",(0,s.jsx)(L.I,{name:P})]})};function z(k){const{data:V,linksGetter:S,onlyValues:$}=k,B=(0,M.of)(q);return(0,s.jsx)("div",{className:b()(B.KeyValueTable),"data-testid":"KeyValueTable",children:(0,s.jsx)("table",{className:B.table,children:(0,s.jsx)("tbody",{className:B.body,children:V.map((P,Y)=>{let le={__html:""};P.type==="code"?le={__html:`<pre style="border: none; background: none">${P.value}</pre>`}:P.type==="text"?le={__html:`<span style="white-space: pre-wrap;">${P.value}</span>`}:le={__html:W(be(P.value))};const we=(0,s.jsx)("div",{className:B.jsonTable,dangerouslySetInnerHTML:le}),Ge=S?.(V,Y);let ae;return Ge&&Ge.length?ae=(0,s.jsx)("div",{children:(0,s.jsx)(K,{link:Ge[0],children:we})}):ae=we,(0,s.jsxs)("tr",{className:B.row,children:[!$&&(0,s.jsx)("td",{className:B.keyColumn,"data-testid":"KeyValueTable--keyColumn",children:P.key}),(0,s.jsx)("td",{children:ae}),(0,s.jsx)("td",{className:B.copyColumn,children:(0,s.jsx)(ne,{className:te,copyText:P.type==="code"||P.type==="text"?P.value:JSON.stringify(P,null,2),tooltipTitle:"Copy"})})]},`${P.key}-${Y}`)})})})})}},22214:I=>{"use strict";I.exports=function(v,d,s,i,h){var b=this;b.directMap[v+":"+s]=d,v=v.replace(/\s+/g," ");var L=v.split(" "),M;if(L.length>1){b.bindSequence(v,L,d,s);return}M=b.getKeyInfo(v,s),b.callbacks[M.key]=b.callbacks[M.key]||[],b.getMatches(M.key,M.modifiers,{type:M.action},i,v,h),b.callbacks[M.key][i?"unshift":"push"]({callback:d,modifiers:M.modifiers,action:M.action,seq:i,level:h,combo:v})}},23970:(I,v,d)=>{"use strict";I.exports=function(s){var i,h;if(i=d(56814),h=d(14082),s.type==="keypress"){var b=String.fromCharCode(s.which);return s.shiftKey||(b=b.toLowerCase()),b}return i[s.which]!==void 0?i[s.which]:h[s.which]!==void 0?h[s.which]:String.fromCharCode(s.which).toLowerCase()}},25273:I=>{"use strict";I.exports=function(v){var d=[];return v.shiftKey&&d.push("shift"),v.altKey&&d.push("alt"),v.ctrlKey&&d.push("ctrl"),v.metaKey&&d.push("meta"),d}},26726:I=>{"use strict";I.exports=function(){var v=this;return v.callbacks={},v.directMap={},this}},27238:I=>{"use strict";I.exports=function(v,d){return v.sort().join(",")===d.sort().join(",")}},27486:I=>{"use strict";I.exports=function(v){return v==="+"?["+"]:v.split("+")}},31849:I=>{"use strict";I.exports=function(v){if(v.stopPropagation){v.stopPropagation();return}v.cancelBubble=!0}},34282:(I,v,d)=>{"use strict";d.d(v,{ID:()=>g,Nd:()=>s,XQ:()=>i,Zh:()=>L,gz:()=>M,mT:()=>b,x9:()=>h});const s="kind",i="status",h="status.message",b="library.name",L="library.version",M="trace.state",g="id"},40476:(I,v,d)=>{"use strict";d.d(v,{V:()=>Pr});var s=d(74848),i=d(22803),h=d(96540),b=d(42941),L=d(1906),M=d(38036),g=d(92745);function _(e){if(e?.tracesToLogsV2)return e.tracesToLogsV2;if(!e?.tracesToLogs)return;const t={customQuery:!1};return t.datasourceUid=e.tracesToLogs.datasourceUid,t.tags=e.tracesToLogs.mapTagNamesEnabled?e.tracesToLogs.mappedTags:e.tracesToLogs.tags?.map(n=>({key:n})),t.filterByTraceID=e.tracesToLogs.filterByTraceID,t.filterBySpanID=e.tracesToLogs.filterBySpanID,t.spanStartTimeShift=e.tracesToLogs.spanStartTimeShift,t.spanEndTimeShift=e.tracesToLogs.spanEndTimeShift,t}function U({options:e,onOptionsChange:t}){const n=["loki","elasticsearch","grafana-splunk-datasource","grafana-opensearch-datasource","grafana-falconlogscale-datasource","googlecloud-logging-datasource","victoriametrics-logs-datasource"],a=useMemo(()=>_(e.jsonData)||{customQuery:!1},[e.jsonData]),{query:r="",tags:o,customQuery:l}=a,c=useCallback(u=>{t({...e,jsonData:{...e.jsonData,tracesToLogsV2:{...a,...u},tracesToLogs:void 0}})},[t,e,a]);return jsxs("div",{className:css({width:"100%"}),children:[jsx(InlineFieldRow,{children:jsx(InlineField,{tooltip:"The logs data source the trace is going to navigate to",label:"Data source",labelWidth:26,children:jsx(DataSourcePicker,{inputId:"trace-to-logs-data-source-picker",filter:u=>n.includes(u.type),current:a.datasourceUid,noDefault:!0,width:40,onChange:u=>c({datasourceUid:u.uid}),onClear:()=>c({datasourceUid:void 0})})})}),jsx(InlineFieldRow,{children:jsx(IntervalInput,{label:H("start"),tooltip:D("start","0"),value:a.spanStartTimeShift||"",onChange:u=>{c({spanStartTimeShift:u})},isInvalidError:ne})}),jsx(InlineFieldRow,{children:jsx(IntervalInput,{label:H("end"),tooltip:D("end","0"),value:a.spanEndTimeShift||"",onChange:u=>{c({spanEndTimeShift:u})},isInvalidError:ne})}),jsx(InlineFieldRow,{children:jsx(InlineField,{tooltip:"Tags that will be used in the query. Default tags: 'cluster', 'hostname', 'namespace', 'pod', 'service.name', 'service.namespace'",label:"Tags",labelWidth:26,children:jsx(TagMappingInput,{values:o??[],onChange:u=>c({tags:u})})})}),jsx(R,{disabled:l,type:"trace",id:"filterByTraceID",value:!!a.filterByTraceID,onChange:u=>c({filterByTraceID:u})}),jsx(R,{disabled:l,type:"span",id:"filterBySpanID",value:!!a.filterBySpanID,onChange:u=>c({filterBySpanID:u})}),jsx(InlineFieldRow,{children:jsx(InlineField,{tooltip:"Use a custom query with the possibility to interpolate variables from the trace or span",label:"Use custom query",labelWidth:26,children:jsx(InlineSwitch,{id:"customQuerySwitch",value:l,onChange:u=>c({customQuery:u.currentTarget.checked})})})}),l&&jsx(InlineField,{label:"Query",labelWidth:26,tooltip:"The query that will run when navigating from a trace to logs data source. Interpolate tags using the `$__tags` keyword",grow:!0,children:jsx(Input,{label:"Query",type:"text",allowFullScreen:!0,value:r,onChange:u=>c({query:u.currentTarget.value})})})]})}function R(e){return jsx(InlineFieldRow,{children:jsx(InlineField,{disabled:e.disabled,label:`Filter by ${e.type} ID`,labelWidth:26,grow:!0,tooltip:`Filters logs by ${e.type} ID, where the ${e.type} ID should be part of the log line`,children:jsx(InlineSwitch,{id:e.id,value:e.value,onChange:t=>e.onChange(t.currentTarget.checked)})})})}const H=e=>`Span ${e} time shift`,D=(e,t)=>`Shifts the ${e} time of the span. Default: ${t} (Time units can be used here, for example: 5s, -1m, 3h)`,ne="Invalid time shift. See tooltip for examples.",me=({options:e,onOptionsChange:t})=>{let n=e.type;return n+=e.type==="tempo"?"/configure-tempo-data-source/#trace-to-logs":"/#trace-to-logs",jsx(ConfigSection,{title:"Trace to logs",description:jsx(ConfigDescriptionLink,{description:"Navigate from a trace span to the selected data source's logs.",suffix:n,feature:"trace to logs"}),isCollapsible:!0,isInitiallyOpen:!0,children:jsx(U,{options:e,onOptionsChange:t})})};var X=d(2863),x=d(63142),w=d(28998),E=d(34984),W=d(52763),te=d(51845),q=d(41811);const be=(e,t,n)=>{let a;return n?a=t?.childSpanIds.find(r=>e.has(r)&&e.get(r).startTime+e.get(r).duration<n):a=t.childSpanIds[0],a?e.get(a):void 0},z=e=>{const t=[],n=[];e.forEach(o=>{if(o.references[0]?.refType==="FOLLOWS_FROM"){t.push(o.spanID);const l=e.get(o.references[0].spanID);l.childSpanIds=l.childSpanIds.filter(c=>c!==o.spanID),e.set(l.spanID,{...l})}});const a=o=>{o.forEach(l=>{const c=e.get(l);c.hasChildren&&(n.push(...c.childSpanIds),a(c.childSpanIds))})};return a(t),[...t,...n].forEach(o=>e.delete(o)),e},V=e=>{let t=[...e.keys()];return t.forEach(n=>{const a=e.get(n);if(!(a&&a.references.length&&a.depth))return;const r=e.get(a.references[0].spanID);if(!r){e.delete(a.spanID);return}const o=a.startTime+a.duration,l=r.startTime+r.duration;if(a.startTime>=r.startTime){if(a.startTime>=l){e.delete(a.spanID),r.childSpanIds=r.childSpanIds.filter(c=>c!==a.spanID);return}if(o>l){e.set(a.spanID,{...a,duration:l-a.startTime});return}return}o<=r.startTime?(e.delete(a.spanID),r.childSpanIds=r.childSpanIds.filter(c=>c!==a.spanID)):o<=l?e.set(a.spanID,{...a,startTime:r.startTime,duration:o-r.startTime}):e.set(a.spanID,{...a,startTime:r.startTime,duration:l-r.startTime})}),t=[...e.keys()],t.forEach(n=>{const a=e.get(n);if(a.references.length){const r=e.get(a.references[0].spanID);a.references[0].span=r,e.set(n,{...a})}}),e},S=(e,t,n,a)=>{const r=e.get(t);if(!r)return n;const o=be(e,r,a);let l;if(o)l={spanId:r.spanID,section_start:o.startTime+o.duration,section_end:a||r.startTime+r.duration},l.section_start!==l.section_end&&n.push(l),S(e,o.spanID,n);else if(l={spanId:r.spanID,section_start:r.startTime,section_end:a||r.startTime+r.duration},l.section_start!==l.section_end&&n.push(l),r.references.length){const c=r.references.filter(u=>u.refType==="CHILD_OF")[0].spanID;S(e,c,n,r.startTime)}return n};function $(e){let t=[];const n=e?.spans[0].spanID;if(n){const a=e.spans.reduce((r,o)=>(r.set(o.spanID,o),r),new Map);try{const r=z(a),o=V(r);t=S(o,n,t)}catch(r){console.log("error while computing critical path for a trace",r)}}return t}const P=(0,q.default)($);var Y=d(54092),le=d(80011),we=d(46907),Ge=d(33604),ae=d(27489),Te=d(22099),De=d(87063),pe=d(99887),Ae=d(45967),ce=d(45861),je=d(93256),et=d(88559),oe=d(30703),pt=d(64762),$t=d(65642),Ks=d(7542),Wt=d(57944),ke=d(2543),Zr=d(84743);const zs="YYYY-MM-DD",Us="HH:mm",Ze=1e3,Tt=1e3*Ze,Kt=60*Tt,zt=60*Kt,Gs=24*zt,Ut=Math.log10(Ze),Gt=[{unit:"d",microseconds:Gs,ofPrevious:24},{unit:"h",microseconds:zt,ofPrevious:60},{unit:"m",microseconds:Kt,ofPrevious:60},{unit:"s",microseconds:Tt,ofPrevious:1e3},{unit:"ms",microseconds:Ze,ofPrevious:1e3},{unit:"\u03BCs",microseconds:1,ofPrevious:1e3}],Zt=(e,t,n)=>toFloatPrecision(e/n,t)*n;function Xr(e){return moment(e/Ze).format(zs)}function Qr(e){return moment(e/Ze).format(Us)}function Yr(e){const t=Zt(e,Ut,Ze);return`${moment.duration(t/Ze).asMilliseconds()}ms`}function Jr(e){const t=Zt(e,Ut,Tt);return`${moment.duration(t/Ze).asSeconds()}s`}function Je(e){const[t,n]=(0,ke.dropWhile)(Gt,({microseconds:u},p)=>p<Gt.length-1&&u>e);if(t.ofPrevious===1e3)return`${(0,ke.round)(e/t.microseconds,2)}${t.unit}`;let a=Math.floor(e/t.microseconds),r=e/n.microseconds%t.ofPrevious;const o=Math.round(r);o===t.ofPrevious?(a+=1,r=0):r=o;const l=`${a}${t.unit}`;if(r===0)return l;const c=`${r}${n.unit}`;return`${l} ${c}`}var Fe=d(47184),Zs=d(40996),lt=d(18027),Xt=d(63527);const Xs=/^(-?\d+(?:\.\d+)?)(ms|[Mwdhmsy])$/,Qt=(e,t=Xs)=>!(e.match(t)||!e),Yt=e=>{const[t,n]=(0,h.useState)(()=>e.value?Qt(e.value,e.validationRegex):!1);(0,Zs.A)(()=>{n(Qt(e.value,e.validationRegex))},500,[e.value]);const a={labelWidth:26,disabled:e.disabled??!1,invalid:t,error:e.isInvalidError};return e.label&&(a.label=e.label,a.tooltip=e.tooltip||""),(0,s.jsx)(lt.I,{...a,children:(0,s.jsx)(Xt.p,{type:"text",placeholder:e.placeholder||"0",width:e.width||40,onChange:r=>{e.onChange(r.currentTarget.value)},value:e.value,"aria-label":e.ariaLabel||"interval input"})})};var Qs=d(89599),ht=d(97095),Dt=d(41654),tt=d(18857),Ys=d(2513),Jt=d(87826),Js=d(76319);class qs extends h.PureComponent{constructor(){super(...arguments),this.clearUiFind=()=>{this.props.onChange("")}}static{this.defaultProps={value:void 0}}render(){const{value:t}=this.props,n=(0,s.jsx)(s.Fragment,{children:t&&t.length&&(0,s.jsx)(Js.K,{name:"times",onClick:this.clearUiFind,tooltip:(0,g.t)("explore.search-bar-input.suffix.tooltip-clear-input","Clear input")})});return(0,s.jsx)("div",{style:{width:"200px"},children:(0,s.jsx)(Xt.p,{placeholder:(0,g.t)("explore.search-bar-input.placeholder-find","Find..."),onChange:a=>this.props.onChange(a.currentTarget.value),suffix:n,value:t})})}}var Pe=d(43173);const qt=(0,h.memo)(function(t){const{trace:n,spanFilterMatches:a,setFocusedSpanIdForSearch:r,focusedSpanIndexForSearch:o,setFocusedSpanIndexForSearch:l,datasourceType:c,showSpanFilters:u}=t,p=en((0,x.$j)(),u);(0,h.useEffect)(()=>{if(a&&o!==-1){const O=Array.from(a);r(O[o])}},[o,r,a]);const f=(O,ee)=>{if(O.preventDefault(),O.stopPropagation(),ee){if((0,ae.rR)("grafana_traces_trace_view_find_next_prev_clicked",{datasourceType:c,grafana_version:Pe.$.buildInfo.version,direction:"next"}),o===-1||a&&o===a.size-1){l(0);return}l(o+1)}},m=(O,ee)=>{if(O.preventDefault(),O.stopPropagation(),ee){if((0,ae.rR)("grafana_traces_trace_view_find_next_prev_clicked",{datasourceType:c,grafana_version:Pe.$.buildInfo.version,direction:"prev"}),a&&(o===-1||o===0)){l(a.size-1);return}l(o-1)}},y=(O,ee)=>{O.key==="Enter"&&f(O,ee)},C=(O,ee)=>{O.key==="Enter"&&m(O,ee)},A=(a&&a?.size>0)??!1,T=A?p.button:(0,i.cx)(p.button,p.buttonDisabled),N=(0,h.useCallback)(O=>(0,s.jsx)(Ae.m,{content:O,placement:"top",children:(0,s.jsx)("span",{className:p.tooltip,children:(0,s.jsx)(oe.I,{name:"info-circle",size:"md"})})}),[p.tooltip]),F=(0,h.useCallback)((O,ee)=>{let ie=(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("span",{children:`${n.spans.length} spans`}),N((0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{children:(0,s.jsxs)(g.x6,{i18nKey:"explore.next-prev-result.services",children:["Services: ",{services:ee}]})}),(0,s.jsx)("div",{children:(0,s.jsxs)(g.x6,{i18nKey:"explore.next-prev-result.depth",children:["Depth: ",{depth:O}]})})]}))]});if(a)if(a.size===0)ie=(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("span",{children:(0,s.jsx)(g.x6,{i18nKey:"explore.get-matches-metadata.matches",children:"0 matches"})}),N("There are 0 span matches for the filters selected. Please try removing some of the selected filters.")]});else{const ue=a.size===1?"match":"matches",he=o!==-1?`${o+1}/${a.size} ${ue}`:`${a.size} ${ue}`,se=[];a.forEach(Se=>{n.processes[Se]&&se.push(n.processes[Se].serviceName)}),ie=(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("span",{children:he}),N((0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{children:(0,s.jsxs)(g.x6,{i18nKey:"explore.next-prev-result.services-span-filter-matches",values:{total:new Set(se).size},children:["Services: ","{{total}}","/",{services:ee}]})}),(0,s.jsx)("div",{children:(0,s.jsxs)(g.x6,{i18nKey:"explore.next-prev-result.depth-span-filter-matches",children:["Depth: ",{depth:O}]})})]}))]})}return ie},[o,N,a,n.processes,n.spans]),G=new Set((0,ke.values)(n.processes).map(O=>O.serviceName)).size,Z=(0,ke.get)((0,ke.maxBy)(n.spans,"depth"),"depth",0)+1;return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("span",{className:p.matches,children:F(Z,G)}),(0,s.jsxs)("div",{className:A?p.buttons:(0,i.cx)(p.buttons,p.buttonsDisabled),children:[(0,s.jsx)("div",{"aria-label":(0,g.t)("explore.next-prev-result.aria-label-prev","Prev result button"),className:T,onClick:O=>m(O,A),onKeyDown:O=>C(O,A),role:"button",tabIndex:A?0:-1,children:(0,s.jsx)(g.x6,{i18nKey:"explore.prev",children:"Prev"})}),(0,s.jsx)("div",{"aria-label":(0,g.t)("explore.next-prev-result.aria-label-next","Next result button"),className:T,onClick:O=>f(O,A),onKeyDown:O=>y(O,A),role:"button",tabIndex:A?0:-1,children:(0,s.jsx)(g.x6,{i18nKey:"explore.next",children:"Next"})})]})]})}),en=(e,t)=>{const n=(0,ce.hs)({theme:e,variant:"secondary",size:t?"md":"sm",iconOnly:!1,fill:"outline"});return{buttons:(0,i.css)({display:"inline-flex",gap:"4px"}),buttonsDisabled:(0,i.css)({cursor:"not-allowed"}),button:n.button,buttonDisabled:(0,i.css)(n.disabled,{pointerEvents:"none"}),matches:(0,i.css)({marginRight:e.spacing(2),textWrap:"nowrap"}),tooltip:(0,i.css)({color:"#aaa",margin:"0 0 0 5px"})}};var es=d(21285),ts=d(57208);const tn=(0,h.memo)(function(t){const{trace:n,search:a,spanFilterMatches:r,setShowSpanFilterMatchesOnly:o,setShowCriticalPathSpansOnly:l,focusedSpanIndexForSearch:c,setFocusedSpanIndexForSearch:u,setFocusedSpanIdForSearch:p,datasourceType:f,clear:m,showSpanFilters:y}=t,C=(0,x.of)(sn),A=(0,h.useMemo)(()=>a.serviceName&&a.serviceName!==""||a.spanName&&a.spanName!==""||(0,ts.BL)(a.from||"")||(0,ts.BL)(a.to||"")||a.tags.length>1||a.tags.some(T=>T.key)||a.query&&a.query!==""||a.matchesOnly,[a.serviceName,a.spanName,a.from,a.to,a.tags,a.query,a.matchesOnly]);return(0,s.jsx)("div",{className:C.container,children:(0,s.jsx)("div",{className:C.controls,children:(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{children:[(0,s.jsx)(ce.$n,{variant:"destructive",disabled:!A,type:"button",fill:"outline","aria-label":(0,g.t)("explore.trace-page-search-bar.aria-label-clear-filters","Clear filters button"),onClick:m,children:(0,s.jsx)(g.x6,{i18nKey:"explore.clear",children:"Clear"})}),(0,s.jsxs)("div",{className:C.matchesOnly,children:[(0,s.jsx)(es.d,{value:a.matchesOnly,onChange:T=>o(T.currentTarget.checked??!1),label:(0,g.t)("explore.trace-page-search-bar.label-show-matches","Show matches only switch"),disabled:!r?.size}),(0,s.jsx)(ce.$n,{onClick:()=>o(!a.matchesOnly),className:C.clearMatchesButton,variant:"secondary",fill:"text",disabled:!r?.size,children:(0,s.jsx)(g.x6,{i18nKey:"explore.show-matches-only",children:"Show matches only"})})]}),(0,s.jsxs)("div",{className:C.matchesOnly,children:[(0,s.jsx)(es.d,{value:a.criticalPathOnly,onChange:T=>l(T.currentTarget.checked??!1),label:(0,g.t)("explore.trace-page-search-bar.label-show-paths","Show critical path only switch")}),(0,s.jsx)(ce.$n,{onClick:()=>l(!a.criticalPathOnly),className:C.clearMatchesButton,variant:"secondary",fill:"text",children:(0,s.jsx)(g.x6,{i18nKey:"explore.show-critical-path-only",children:"Show critical path only"})})]})]}),(0,s.jsx)("div",{className:C.nextPrevResult,children:(0,s.jsx)(qt,{trace:n,spanFilterMatches:r,setFocusedSpanIdForSearch:p,focusedSpanIndexForSearch:c,setFocusedSpanIndexForSearch:u,datasourceType:f,showSpanFilters:y})})]})})})}),sn=e=>{const t=(0,ce.hs)({theme:e,variant:"secondary",size:"md",iconOnly:!1,fill:"outline"});return{button:(0,i.css)(t.button),buttonDisabled:(0,i.css)(t.disabled,{pointerEvents:"none",cursor:"not-allowed"}),container:(0,i.css)({display:"inline"}),controls:(0,i.css)({display:"flex",justifyContent:"flex-end",margin:"5px 0 0 0"}),matchesOnly:(0,i.css)({display:"inline-flex",margin:"0 0 0 25px",verticalAlign:"middle",alignItems:"center"}),clearMatchesButton:(0,i.css)({color:e.colors.text.primary,"&:hover":{background:"inherit"}}),nextPrevResult:(0,i.css)({marginLeft:"auto",display:"flex",alignItems:"center"})}};var nn=d(69192);const ss=(0,h.memo)(e=>{const{trace:t,search:n,setSearch:a,showSpanFilters:r,setShowSpanFilters:o,setFocusedSpanIdForSearch:l,spanFilterMatches:c,datasourceType:u}=e,p={...(0,x.of)(an)},[f,m]=(0,h.useState)(),[y,C]=(0,h.useState)(),[A,T]=(0,h.useState)(-1),[N,F]=(0,h.useState)(),[G,Z]=(0,h.useState)({}),O=(0,h.useRef)(),ee=/^\d+(?:\.\d)?\d*(?:ns|us|Âµs|ms|s|m|h)$/,ie=(0,h.useCallback)(()=>{m(void 0),C(void 0),F(void 0),Z({}),a(Ys.$A)},[a]);(0,h.useEffect)(()=>{const Q=t?.traceID;O.current&&O.current!==Q&&ie(),O.current=Q},[ie,t]);const ue=(0,h.useCallback)(Q=>{a({...n,matchesOnly:Q})},[n,a]),he=(0,h.useCallback)(Q=>{a({...n,criticalPathOnly:Q})},[n,a]);if(!t)return null;const se=Q=>{T(-1),l(""),a(Q)},Se=()=>{f||m((0,Jt.pG)(t).map(Fe.z))},Re=()=>{y||C((0,Jt.m8)(t).map(Fe.z))},Le=(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(Ae.m,{content:(0,g.t)("explore.span-filters.tooltip-collapse","Filter your spans below. You can continue to apply filters until you have narrowed down your resulting spans to the select few you are most interested in."),placement:"right",children:(0,s.jsxs)("span",{className:p.collapseLabel,children:[(0,s.jsx)(g.x6,{i18nKey:"explore.span-filters.label-collapse",children:"Span Filters"}),(0,s.jsx)(oe.I,{size:"md",name:"info-circle"})]})}),!r&&(0,s.jsx)("div",{className:p.nextPrevResult,children:(0,s.jsx)(qt,{trace:t,spanFilterMatches:c,setFocusedSpanIdForSearch:l,focusedSpanIndexForSearch:A,setFocusedSpanIndexForSearch:T,datasourceType:u,showSpanFilters:r})})]});return(0,s.jsx)("div",{className:p.container,children:(0,s.jsxs)(Qs.S,{label:Le,collapsible:!0,isOpen:r,onToggle:o,children:[(0,s.jsxs)(ht.C,{className:p.flexContainer,children:[(0,s.jsx)(lt.I,{label:(0,g.t)("explore.span-filters.label-service-name","Service name"),labelWidth:16,children:(0,s.jsxs)(Dt.B,{gap:.5,children:[(0,s.jsx)(tt.l6,{"aria-label":(0,g.t)("explore.span-filters.aria-label-select-service-name-operator","Select service name operator"),onChange:Q=>se({...n,serviceNameOperator:Q.value}),options:[(0,Fe.z)("="),(0,Fe.z)("!=")],value:n.serviceNameOperator}),(0,s.jsx)(tt.l6,{"aria-label":(0,g.t)("explore.span-filters.aria-label-select-service-name","Select service name"),isClearable:!0,onChange:Q=>se({...n,serviceName:Q?.value||""}),onOpenMenu:Se,options:f||(n.serviceName?[n.serviceName].map(Fe.z):[]),placeholder:(0,g.t)("explore.span-filters.placeholder-all-service-names","All service names"),value:n.serviceName||null,defaultValue:n.serviceName||null})]})}),(0,s.jsx)(qs,{onChange:Q=>{se({...n,query:Q,matchesOnly:Q!==""})},value:n.query||""})]}),(0,s.jsx)(ht.C,{children:(0,s.jsx)(lt.I,{label:(0,g.t)("explore.span-filters.label-span-name","Span name"),labelWidth:16,children:(0,s.jsxs)(Dt.B,{gap:.5,children:[(0,s.jsx)(tt.l6,{"aria-label":(0,g.t)("explore.span-filters.aria-label-select-span-name-operator","Select span name operator"),onChange:Q=>se({...n,spanNameOperator:Q.value}),options:[(0,Fe.z)("="),(0,Fe.z)("!=")],value:n.spanNameOperator}),(0,s.jsx)(tt.l6,{"aria-label":(0,g.t)("explore.span-filters.aria-label-select-span-name","Select span name"),isClearable:!0,onChange:Q=>se({...n,spanName:Q?.value||""}),onOpenMenu:Re,options:y||(n.spanName?[n.spanName].map(Fe.z):[]),placeholder:(0,g.t)("explore.span-filters.placeholder-all-span-names","All span names"),value:n.spanName||null})]})})}),(0,s.jsx)(ht.C,{children:(0,s.jsx)(lt.I,{label:(0,g.t)("explore.span-filters.label-duration","Duration"),labelWidth:16,tooltip:(0,g.t)("explore.span-filters.tooltip-duration","Filter by duration. Accepted units are {{units}}",{units:"ns, us, ms, s, m, h"}),children:(0,s.jsxs)(Dt.B,{alignItems:"flex-start",gap:.5,children:[(0,s.jsx)(tt.l6,{"aria-label":(0,g.t)("explore.span-filters.aria-label-select-min-span-operator","Select min span operator"),onChange:Q=>se({...n,fromOperator:Q.value}),options:[(0,Fe.z)(">"),(0,Fe.z)(">=")],value:n.fromOperator}),(0,s.jsx)("div",{className:p.intervalInput,children:(0,s.jsx)(Yt,{ariaLabel:(0,g.t)("explore.span-filters.ariaLabel-select-min-span-duration","Select min span duration"),onChange:Q=>se({...n,from:Q}),isInvalidError:"Invalid duration",placeholder:"e.g. 100ms, 1.2s",width:18,value:n.from||"",validationRegex:ee})}),(0,s.jsx)(tt.l6,{"aria-label":(0,g.t)("explore.span-filters.aria-label-select-max-span-operator","Select max span operator"),onChange:Q=>se({...n,toOperator:Q.value}),options:[(0,Fe.z)("<"),(0,Fe.z)("<=")],value:n.toOperator}),(0,s.jsx)(Yt,{ariaLabel:(0,g.t)("explore.span-filters.ariaLabel-select-max-span-duration","Select max span duration"),onChange:Q=>se({...n,to:Q}),isInvalidError:"Invalid duration",placeholder:"e.g. 100ms, 1.2s",width:18,value:n.to||"",validationRegex:ee})]})})}),(0,s.jsx)(ht.C,{className:p.tagsRow,children:(0,s.jsx)(lt.I,{label:(0,g.t)("explore.span-filters.label-tags","Tags"),labelWidth:16,tooltip:(0,g.t)("explore.span-filters.tooltip-tags","Filter by tags, process tags or log fields in your spans."),children:(0,s.jsx)(nn.T,{search:n,setSearch:se,trace:t,tagKeys:N,setTagKeys:F,tagValues:G,setTagValues:Z})})}),(0,s.jsx)(tn,{trace:t,search:n,spanFilterMatches:c,setShowSpanFilterMatchesOnly:ue,setShowCriticalPathSpansOnly:he,setFocusedSpanIdForSearch:l,focusedSpanIndexForSearch:A,setFocusedSpanIndexForSearch:T,datasourceType:u,clear:ie,showSpanFilters:r})]})})});ss.displayName="SpanFilters";const an=e=>({container:(0,i.css)({label:"SpanFilters",margin:`0.5em 0 -${e.spacing(1)} 0`,zIndex:5,"& > div":{borderLeft:"none",borderRight:"none"}}),collapseLabel:(0,i.css)({svg:{color:"#aaa",margin:"-2px 0 0 10px"}}),flexContainer:(0,i.css)({display:"flex",justifyContent:"space-between"}),intervalInput:(0,i.css)({margin:"0 -4px 0 0"}),tagsRow:(0,i.css)({margin:"-4px 0 0 0"}),nextPrevResult:(0,i.css)({flex:1,alignItems:"center",display:"flex",justifyContent:"flex-end",marginRight:e.spacing(1)})}),ns=(0,h.memo)(e=>{const{trace:t,data:n,app:a,timeZone:r,search:o,setSearch:l,showSpanFilters:c,setShowSpanFilters:u,setFocusedSpanIdForSearch:p,spanFilterMatches:f,datasourceType:m,datasourceName:y,datasourceUid:C,setHeaderHeight:A}=e,T=(0,x.of)(rn),N=(0,x.$j)(),F=(0,pt._2)(),[G,Z]=(0,h.useState)(!1);(0,h.useEffect)(()=>{A(document.querySelector("."+T.header)?.scrollHeight??0)},[A,c,T.header]);const O=t?{...t,datasource:{name:y,uid:C,type:m}}:void 0,{links:ee}=(0,we.U)({extensionPointId:Y.SM.TraceViewHeaderActions,context:O,limitPerPlugin:2}),{components:ie}=(0,Ge.f)({extensionPointId:Y.SM.TraceViewHeaderActions});if(!t)return null;const{method:ue,status:he,url:se}=(0,Wt.h9)(t.spans),Se=(0,Wt.tV)(t.spans),Re=(0,le.LE)(t.startTime/1e3,{timeZone:r,defaultWithMS:!0}),Le=(0,h.useMemo)(()=>new Set(t.spans.map(fe=>fe.process?.serviceName)).size,[t.spans]);let Q="green";he&&he.length>0&&(he[0].value.toString().charAt(0)==="4"?Q="orange":he[0].value.toString().charAt(0)==="5"&&(Q="red"));const Ee=()=>{navigator.clipboard.writeText(t.traceID),Z(!0),setTimeout(()=>{Z(!1)},5e3)},Ce=()=>{const fe=(0,Ks.ek)(n,"Trace-"+t.traceID.substring(t.traceID.length-6));(0,ae.rR)("grafana_traces_download_traces_clicked",{app:a,grafana_version:$t.$W.buildInfo.version,trace_format:fe,location:"trace-view"})},ve=(0,s.jsxs)(De.W,{children:[(0,s.jsx)(De.W.Item,{label:(0,g.t)("explore.trace-page-header.share-copy-link","Copy link"),icon:"link",onClick:()=>{navigator.clipboard.writeText(window.location.href),F.success((0,g.t)("explore.trace-page-header.link-copied","Link copied to clipboard"))}}),(0,s.jsx)(De.W.Item,{label:(0,g.t)("explore.trace-page-header.share-export-json","Export as JSON"),icon:"download-alt",onClick:()=>{Ce(),F.success((0,g.t)("explore.trace-page-header.export-started","Export started"))}})]});return(0,s.jsxs)("header",{className:T.header,children:[(0,s.jsxs)("div",{className:T.titleRow,children:[(0,s.jsxs)("div",{className:T.titleSection,children:[(0,s.jsx)("h1",{className:T.title,children:Se}),(0,s.jsxs)("div",{className:T.badges,children:[ue&&ue.length>0&&(0,s.jsx)(pe.E,{text:ue[0].value,color:"blue"}),he&&he.length>0&&(0,s.jsx)(pe.E,{text:he[0].value,color:Q})]})]}),(0,s.jsxs)("div",{className:T.actions,children:[ee.length>0&&(0,s.jsx)("div",{className:T.actions,children:ee.map(fe=>(0,s.jsx)(Ae.m,{content:fe.description||fe.title,children:(0,s.jsx)(ce.$n,{size:"sm",variant:"primary",fill:"outline",icon:fe.icon,onClick:Me=>{fe.path&&window.open(fe.path,"_blank"),fe.onClick?.(Me)},children:fe.title})},fe.id))}),(0,s.jsx)("div",{className:T.actions,children:O?(0,Te.RC)({props:O,components:ie,limit:2}):null}),$t.$W.feedbackLinksEnabled&&(0,s.jsx)(Ae.m,{content:(0,g.t)("explore.trace-page-header.title-share-thoughts-about-tracing-grafana","Share your thoughts about tracing in Grafana."),children:(0,s.jsx)(ce.z9,{size:"sm",variant:"secondary",fill:"outline",icon:"comment-alt-message",href:"https://forms.gle/RZDEx8ScyZNguDoC8",target:"_blank",children:(0,s.jsx)(g.x6,{i18nKey:"explore.trace-page-header.give-feedback",children:"Feedback"})})}),(0,s.jsxs)(je.e,{children:[(0,s.jsx)(Ae.m,{content:(0,g.t)("explore.trace-page-header.share-tooltip","Share trace"),children:(0,s.jsx)(ce.$n,{size:"sm",variant:"secondary",fill:"outline",icon:"share-alt",onClick:()=>{navigator.clipboard.writeText(window.location.href),F.success((0,g.t)("explore.trace-page-header.link-copied","Link copied to clipboard"))},children:(0,g.t)("explore.trace-page-header.share","Share")})}),(0,s.jsx)(et.m,{overlay:ve,placement:"bottom-end",children:(0,s.jsx)(ce.$n,{"aria-label":(0,g.t)("explore.trace-page-header.aria-label-share-dropdown","Open share trace options menu"),size:"sm",variant:"secondary",fill:"outline",icon:"angle-down"})})]})]})]}),(0,s.jsxs)("div",{className:T.metadataRow,children:[(0,s.jsxs)("div",{className:T.metadataItem,children:[(0,s.jsx)("span",{className:T.metadataLabel,children:(0,g.t)("explore.trace-page-header.trace-id","Trace ID")}),(0,s.jsx)("span",{className:T.metadataValue,children:(0,s.jsxs)("button",{className:T.traceIdButton,onClick:Ee,children:[t.traceID,(0,s.jsx)(oe.I,{name:G?"check":"copy",size:"sm",className:T.copyIcon})]})})]}),(0,s.jsxs)("div",{className:T.metadataItem,children:[(0,s.jsx)("span",{className:T.metadataLabel,children:(0,g.t)("explore.trace-page-header.start-time","Start time")}),(0,s.jsxs)("span",{className:(0,i.cx)(T.metadataValue,(0,i.css)({gap:N.spacing(.5)})),children:[(0,s.jsx)("span",{children:Re}),(0,s.jsxs)("span",{className:T.timestampDetail,children:["(",(0,le.fq)(t.startTime/1e3),")"]})]})]}),(0,s.jsxs)("div",{className:T.metadataItem,children:[(0,s.jsx)("span",{className:T.metadataLabel,children:(0,g.t)("explore.trace-page-header.duration","Duration")}),(0,s.jsx)("span",{className:T.metadataValue,children:Je(t.duration)})]}),(0,s.jsxs)("div",{className:T.metadataItem,children:[(0,s.jsx)("span",{className:T.metadataLabel,children:(0,g.t)("explore.trace-page-header.services","Services")}),(0,s.jsx)("span",{className:T.metadataValue,children:Le})]}),se&&se.length>0&&(0,s.jsxs)("div",{className:T.metadataItem,children:[(0,s.jsxs)("span",{className:T.metadataLabel,children:[se[0].key==="http.route"&&(0,g.t)("explore.trace-page-header.route","Route"),se[0].key==="http.url"&&(0,g.t)("explore.trace-page-header.url","URL"),se[0].key==="http.target"&&(0,g.t)("explore.trace-page-header.target","Target"),se[0].key==="http.path"&&(0,g.t)("explore.trace-page-header.path","Path")]}),(0,s.jsx)("span",{className:T.metadataValue,children:(0,s.jsx)(Ae.m,{content:(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{children:(0,s.jsxs)(g.x6,{i18nKey:"explore.trace-page-header.tooltip-url",values:{route:"http.route",url:"http.url",target:"http.target",path:"http.path"},children:["{{route}}"," or ","{{url}}"," or ","{{target}}"," or ","{{path}}"]})}),(0,s.jsxs)("div",{children:["(",se[0].value,")"]})]}),interactive:!0,children:(0,s.jsx)("span",{className:T.url,children:se[0].value})})})]})]}),(0,s.jsx)(ss,{trace:t,showSpanFilters:c,setShowSpanFilters:u,search:o,setSearch:l,spanFilterMatches:f,setFocusedSpanIdForSearch:p,datasourceType:m})]})});ns.displayName="TracePageHeader";const rn=e=>({header:(0,i.css)({label:"TracePageHeader",backgroundColor:e.colors.background.primary,padding:"0.5em",position:"sticky",top:0,zIndex:5,textAlign:"left"}),titleRow:(0,i.css)({display:"flex",alignItems:"flex-start",justifyContent:"space-between",marginBottom:e.spacing(1),gap:e.spacing(2)}),titleSection:(0,i.css)({display:"flex",alignItems:"center",gap:e.spacing(2),flex:1,minWidth:0}),title:(0,i.css)({color:e.colors.text.primary,fontSize:e.typography.h3.fontSize,fontWeight:e.typography.h3.fontWeight,lineHeight:e.typography.h3.lineHeight,margin:0,minWidth:0,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}),badges:(0,i.css)({display:"flex",gap:e.spacing(1),alignItems:"center",flexShrink:0}),actions:(0,i.css)({display:"flex",alignItems:"center",gap:e.spacing(1),flexShrink:0}),metadataRow:(0,i.css)({display:"flex",alignItems:"center",columnGap:e.spacing(3),marginBottom:e.spacing(1),fontSize:e.typography.bodySmall.fontSize,color:e.colors.text.secondary,flexWrap:"wrap"}),metadataItem:(0,i.css)({display:"flex",alignItems:"center",gap:e.spacing(.5)}),metadataLabel:(0,i.css)({fontWeight:e.typography.fontWeightMedium,color:e.colors.text.secondary}),metadataValue:(0,i.css)({color:e.colors.text.primary,display:"flex",alignItems:"center",gap:e.spacing(1)}),traceIdButton:(0,i.css)({background:"none",border:"none",color:e.colors.text.primary,cursor:"pointer",textDecoration:"underline",display:"flex",alignItems:"center",gap:e.spacing(.5),padding:0,font:"inherit","&:hover":{color:e.colors.emphasize(e.colors.text.primary,.15)}}),copyIcon:(0,i.css)({opacity:.7}),copiedText:(0,i.css)({color:e.colors.success.text,fontSize:e.typography.bodySmall.fontSize,fontWeight:e.typography.fontWeightMedium}),timestampDetail:(0,i.css)({color:e.colors.text.disabled}),url:(0,i.css)({maxWidth:"700px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",display:"inline-block",color:e.colors.text.primary})});var Xe=d(65240),j=d(11065),Ct=d(84140),as=d(8255);function on(e){if(e.length!==7)return[0,0,0];const t=e.slice(1,3),n=e.slice(3,5),a=e.slice(5);return[parseInt(t,16),parseInt(n,16),parseInt(a,16)]}class ln{constructor(t,n){const a=dn(t,n);this.colorsHex=a,this.colorsRgb=a.map(on),this.cache=new Map,this.prevColorIndex=void 0}_getColorIndex(t){let n=this.cache.get(t);if(n==null){const a=this.hashCode(t?t.toLowerCase():"");if(n=Math.abs(a%this.colorsHex.length),this.prevColorIndex!==void 0){this.prevColorIndex===n&&(n=this.getNextIndex(n));const r=this.colorsHex[this.prevColorIndex];if(Ct.A.readability(r,this.colorsHex[n])<1.5){let o=n;for(let l=0;l<this.colorsHex.length;l++)if(o=this.getNextIndex(o),Ct.A.readability(r,this.colorsHex[o])>1.5){n=o;break}}}this.cache.set(t,n),this.prevColorIndex=n}return n}getNextIndex(t){return t+1<this.colorsHex.length?t+1:0}hashCode(t){let n=0,a,r;for(a=0;a<t.length;a++)r=t.charCodeAt(a),n=(n<<5)-n+r;return n}getColorByKey(t){const n=this._getColorIndex(t);return this.colorsHex[n]}getRgbColorByKey(t){const n=this._getColorIndex(t);return this.colorsRgb[n]}clear(){this.cache.clear()}}const Rt=(0,q.default)((e,t)=>new ln(e,t));function qr(e){Rt([],e)}function gt(e,t){return Rt(as.Tj,t).getColorByKey(e)}function cn(e,t){return Rt(as.Tj,t).getRgbColorByKey(e)}function dn(e,t){const n=[...e],a=n.indexOf("#E24D42");a>-1&&n.splice(a,1);const r=e.indexOf("#BF1B00");r>-1&&n.splice(r,1);let o=[];for(const l of n)Ct.A.readability(t.colors.background.primary,l)>=3&&o.push(l);return o}const un=.8,pn=2,hn=200,rs=10,is=60,gn=6;function fn(e,t,n,a,r){const o=new Map,l=t.length<is?is:Math.min(t.length,hn),c=window.innerWidth*2;e.width=c,e.height=l;const u=Math.min(gn,Math.max(pn,l/t.length)),p=l/t.length,f=e.getContext("2d",{alpha:!1});if(f){f.fillStyle=r,f.fillRect(0,0,c,l);for(let m=0;m<t.length;m++){const{valueWidth:y,valueOffset:C,serviceName:A}=t[m],T=C/n*c;let N=y/n*c;N<rs&&(N=rs);let F=o.get(A);F||(F=`rgba(${a(A).concat(un).join()})`,o.set(A,F)),f.fillStyle=F,f.fillRect(T,m*p,N,u)}}}const mn=(0,Xe.N)(e=>({CanvasSpanGraph:(0,i.css)({label:"CanvasSpanGraph",background:(0,j.R)(e,"#fafafa"),height:"60px",position:"absolute",width:"100%",imageRendering:"crisp-edges"})}));class xn extends h.PureComponent{constructor(t){super(t),this.getColor=n=>cn(n,this.props.theme),this._setCanvasRef=n=>{this._canvasElm=n},this._canvasElm=void 0}componentDidMount(){this._draw()}componentDidUpdate(){this._draw()}_draw(){if(this._canvasElm){const{valueWidth:t,items:n}=this.props;fn(this._canvasElm,n,t,this.getColor,(0,j.R)(this.props.theme,"#fff"))}}render(){return(0,s.jsx)("canvas",{className:mn(this.props.theme).CanvasSpanGraph,ref:this._setCanvasRef,"data-testid":"CanvasSpanGraph"})}}const vn=(0,x.cV)(xn),yn=()=>({TickLabels:(0,i.css)({label:"TickLabels",height:"1rem",position:"relative"}),TickLabelsLabel:(0,i.css)({label:"TickLabelsLabel",color:"#717171",fontSize:"0.7rem",position:"absolute",userSelect:"none"})});function bn(e){const{numTicks:t,duration:n}=e,a=(0,x.of)(yn),r=[];for(let o=0;o<t+1;o++){const l=o/t,c=l===1?{right:"0%"}:{left:`${l*100}%`};r.push((0,s.jsx)("div",{className:a.TickLabelsLabel,style:c,"data-testid":"tick",children:Je(n*l)},l))}return(0,s.jsx)("div",{className:a.TickLabels,"data-testid":"TickLabels",children:r})}var Sn=d(46942),de=d.n(Sn),os=(e=>(e.DragEnd="DragEnd",e.DragMove="DragMove",e.DragStart="DragStart",e.MouseEnter="MouseEnter",e.MouseLeave="MouseLeave",e.MouseMove="MouseMove",e))(os||{});const Qe=os,ls=0;class ct{constructor({getBounds:t,tag:n,resetBoundsOnResize:a=!0,...r}){this.resetBounds=()=>{this._bounds=void 0},this._handleMinorMouseEvent=o=>{const{button:l,clientX:c,type:u}=o;if(this._isDragging||l!==ls)return;let p=null,f;if(u==="mouseenter")p=Qe.MouseEnter,f=this._onMouseEnter;else if(u==="mouseleave")p=Qe.MouseLeave,f=this._onMouseLeave;else if(u==="mousemove")p=Qe.MouseMove,f=this._onMouseMove;else throw new Error(`invalid event type: ${u}`);if(!f)return;const{value:m,x:y}=this._getPosition(c);f({event:o,type:p,value:m,x:y,manager:this,tag:this.tag})},this._handleDragEvent=o=>{const{button:l,clientX:c,type:u}=o;let p=null,f;if(u==="mousedown"){if(this._isDragging||l!==ls)return;window.addEventListener("mousemove",this._handleDragEvent),window.addEventListener("mouseup",this._handleDragEvent);const C=(0,ke.get)(document,"body.style");C&&(C.userSelect="none"),this._isDragging=!0,p=Qe.DragStart,f=this._onDragStart}else if(u==="mousemove"){if(!this._isDragging)return;p=Qe.DragMove,f=this._onDragMove}else if(u==="mouseup"){if(!this._isDragging)return;this._stopDragging(),p=Qe.DragEnd,f=this._onDragEnd}else throw new Error(`invalid event type: ${u}`);if(!f)return;const{value:m,x:y}=this._getPosition(c);f({event:o,type:p,value:m,x:y,manager:this,tag:this.tag})},this.handleMouseDown=this._handleDragEvent,this.handleMouseEnter=this._handleMinorMouseEvent,this.handleMouseMove=this._handleMinorMouseEvent,this.handleMouseLeave=this._handleMinorMouseEvent,this.getBounds=t,this.tag=n,this._isDragging=!1,this._bounds=void 0,this._resetBoundsOnResize=!!a,this._resetBoundsOnResize&&window.addEventListener("resize",this.resetBounds),this._onMouseEnter=r.onMouseEnter,this._onMouseLeave=r.onMouseLeave,this._onMouseMove=r.onMouseMove,this._onDragStart=r.onDragStart,this._onDragMove=r.onDragMove,this._onDragEnd=r.onDragEnd}_getBounds(){return this._bounds||(this._bounds=this.getBounds(this.tag)),this._bounds}_getPosition(t){const{clientXLeft:n,maxValue:a,minValue:r,width:o}=this._getBounds();let l=t-n,c=l/o;return r!=null&&c<r?(c=r,l=r*o):a!=null&&c>a&&(c=a,l=a*o),{value:c,x:l}}_stopDragging(){window.removeEventListener("mousemove",this._handleDragEvent),window.removeEventListener("mouseup",this._handleDragEvent);const t=(0,ke.get)(document,"body.style");t&&(t.userSelect="auto"),this._isDragging=!1}isDragging(){return this._isDragging}dispose(){this._isDragging&&this._stopDragging(),this._resetBoundsOnResize&&window.removeEventListener("resize",this.resetBounds),this._bounds=void 0,this._onMouseEnter=void 0,this._onMouseLeave=void 0,this._onMouseMove=void 0,this._onDragStart=void 0,this._onDragMove=void 0,this._onDragEnd=void 0}}const In=()=>({GraphTick:(0,i.css)({label:"GraphTick",stroke:"#aaa",strokeWidth:"1px"})});function wn(e){const{numTicks:t}=e,n=(0,x.of)(In),a=[];for(let r=1;r<t;r++){const o=`${r/t*100}%`;a.push((0,s.jsx)("line",{className:n.GraphTick,x1:o,y1:"0%",x2:o,y2:"100%"},r/t))}return(0,s.jsx)("g",{"data-testid":"ticks","aria-hidden":"true",children:a})}const Tn=()=>({ScrubberHandleExpansion:de()((0,i.css)({label:"ScrubberHandleExpansion",cursor:"col-resize",fillOpacity:0,fill:"#44f"}),"scrubber-handle-expansion"),ScrubberHandle:de()((0,i.css)({label:"ScrubberHandle",cursor:"col-resize",fill:"#555"}),"scrubber-handle"),ScrubberLine:de()((0,i.css)({label:"ScrubberLine",pointerEvents:"none",stroke:"#555"}),"scrubber-line"),ScrubberDragging:(0,i.css)({label:"ScrubberDragging","& .scrubber-handle-expansion":{fillOpacity:1},"& .scrubber-handle":{fill:"#44f"},"& > .scrubber-line":{stroke:"#44f"}}),ScrubberHandles:(0,i.css)({label:"ScrubberHandles","&:hover > .scrubber-handle-expansion":{fillOpacity:1},"&:hover > .scrubber-handle":{fill:"#44f"},"&:hover + .scrubber.line":{stroke:"#44f"}})});function cs({isDragging:e,onMouseDown:t,onMouseEnter:n,onMouseLeave:a,position:r}){const o=`${r*100}%`,l=(0,x.of)(Tn),c=de()({[l.ScrubberDragging]:e});return(0,s.jsxs)("g",{className:c,"data-testid":"scrubber-component",children:[(0,s.jsxs)("g",{"data-testid":"scrubber-component-g",className:l.ScrubberHandles,onMouseDown:t,onMouseEnter:n,onMouseLeave:a,children:[(0,s.jsx)("rect",{"data-testid":"scrubber-component-rect-1",x:o,className:l.ScrubberHandleExpansion,style:{transform:"translate(-4.5px)"},width:"9",height:"20"}),(0,s.jsx)("rect",{"data-testid":"scrubber-component-rect-2",x:o,className:l.ScrubberHandle,style:{transform:"translate(-1.5px)"},width:"3",height:"20"})]}),(0,s.jsx)("line",{className:l.ScrubberLine,y2:"100%",x1:o,x2:o,"data-testid":"scrubber-component-line"})]})}const ds=(0,Xe.N)(e=>{const t="JaegerUiComponents__ViewingLayerResetZoomHoverClassName",n=(0,i.css)({label:"ViewingLayerResetZoom",display:"none",position:"absolute",right:"1%",top:"10%",zIndex:1});return{ViewingLayer:(0,i.css)({label:"ViewingLayer",cursor:"vertical-text",position:"relative",zIndex:1,[`&:hover > .${t}`]:{display:"unset"}}),ViewingLayerGraph:(0,i.css)({label:"ViewingLayerGraph",border:`1px solid ${(0,j.R)(e,"#999")}`,overflow:"visible !important",position:"relative",transformOrigin:"0 0",width:"100%"}),ViewingLayerInactive:(0,i.css)({label:"ViewingLayerInactive",fill:(0,j.R)(e,"rgba(214, 214, 214, 0.5)")}),ViewingLayerCursorGuide:(0,i.css)({label:"ViewingLayerCursorGuide",stroke:(0,j.R)(e,"#f44"),strokeWidth:1}),ViewingLayerDraggedShift:(0,i.css)({label:"ViewingLayerDraggedShift",fillOpacity:.2}),ViewingLayerDrag:(0,i.css)({label:"ViewingLayerDrag",fill:(0,j.R)(e,"#44f")}),ViewingLayerFullOverlay:(0,i.css)({label:"ViewingLayerFullOverlay",bottom:0,cursor:"col-resize",left:0,position:"fixed",right:0,top:0,userSelect:"none"}),ViewingLayerResetZoom:n,ViewingLayerResetZoomHoverClassName:t}}),$e={SHIFT_END:"SHIFT_END",SHIFT_START:"SHIFT_START",REFRAME:"REFRAME"};function Dn(e,t){const[n,a]=e<t?[e,t]:[t,e];return{x:`${n*100}%`,width:`${(a-n)*100}%`,leadingX:`${t*100}%`}}class Cn extends h.PureComponent{constructor(t){super(t),this._setRoot=n=>{this._root=n},this._getDraggingBounds=n=>{if(!this._root)throw new Error("invalid state");const{left:a,width:r}=this._root.getBoundingClientRect(),[o,l]=this.props.viewRange.time.current;let c=1,u=0;return n===$e.SHIFT_START?c=l:n===$e.SHIFT_END&&(u=o),{clientXLeft:a,maxValue:c,minValue:u,width:r}},this._handleReframeMouseMove=({value:n})=>{this.props.updateNextViewRangeTime({cursor:n})},this._handleReframeMouseLeave=()=>{this._draggerReframe.resetBounds(),this.props.updateNextViewRangeTime({cursor:null})},this._handleReframeDragUpdate=({value:n})=>{const a=n,{time:r}=this.props.viewRange,l={reframe:{anchor:r.reframe?r.reframe.anchor:a,shift:a}};this.props.updateNextViewRangeTime(l)},this._handleReframeDragEnd=({manager:n,value:a})=>{const{time:r}=this.props.viewRange,o=r.reframe?r.reframe.anchor:a,[l,c]=a<o?[a,o]:[o,a];n.resetBounds(),this.props.updateViewRangeTime(l,c,"minimap")},this._handleScrubberEnterLeave=({type:n})=>{const a=n===Qe.MouseEnter;this.setState({preventCursorLine:a})},this._handleScrubberDragUpdate=({event:n,tag:a,type:r,value:o})=>{r===Qe.DragStart&&n.stopPropagation(),a===$e.SHIFT_START?this.props.updateNextViewRangeTime({shiftStart:o}):a===$e.SHIFT_END&&this.props.updateNextViewRangeTime({shiftEnd:o})},this._handleScrubberDragEnd=({manager:n,tag:a,value:r})=>{const[o,l]=this.props.viewRange.time.current;let c;if(a===$e.SHIFT_START)c=[r,l];else if(a===$e.SHIFT_END)c=[o,r];else throw new Error("bad state");n.resetBounds(),this.setState({preventCursorLine:!1}),this.props.updateViewRangeTime(c[0],c[1],"minimap")},this._resetTimeZoomClickHandler=()=>{this.props.updateViewRangeTime(0,1)},this._draggerReframe=new ct({getBounds:this._getDraggingBounds,onDragEnd:this._handleReframeDragEnd,onDragMove:this._handleReframeDragUpdate,onDragStart:this._handleReframeDragUpdate,onMouseMove:this._handleReframeMouseMove,onMouseLeave:this._handleReframeMouseLeave,tag:$e.REFRAME}),this._draggerStart=new ct({getBounds:this._getDraggingBounds,onDragEnd:this._handleScrubberDragEnd,onDragMove:this._handleScrubberDragUpdate,onDragStart:this._handleScrubberDragUpdate,onMouseEnter:this._handleScrubberEnterLeave,onMouseLeave:this._handleScrubberEnterLeave,tag:$e.SHIFT_START}),this._draggerEnd=new ct({getBounds:this._getDraggingBounds,onDragEnd:this._handleScrubberDragEnd,onDragMove:this._handleScrubberDragUpdate,onDragStart:this._handleScrubberDragUpdate,onMouseEnter:this._handleScrubberEnterLeave,onMouseLeave:this._handleScrubberEnterLeave,tag:$e.SHIFT_END}),this._root=void 0,this.state={preventCursorLine:!1}}componentWillUnmount(){this._draggerReframe.dispose(),this._draggerEnd.dispose(),this._draggerStart.dispose()}_getMarkers(t,n){const a=ds(this.props.theme),r=Dn(t,n);return[(0,s.jsx)("rect",{className:de()(a.ViewingLayerDraggedShift,a.ViewingLayerDrag),x:r.x,y:"0",width:r.width,height:this.props.height-2},"fill"),(0,s.jsx)("rect",{className:de()(a.ViewingLayerDrag),x:r.leadingX,y:"0",width:"1",height:this.props.height-2},"edge")]}render(){const{height:t,viewRange:n,numTicks:a,theme:r}=this.props,{preventCursorLine:o}=this.state,{current:l,cursor:c,shiftStart:u,shiftEnd:p,reframe:f}=n.time,m=u!=null||p!=null||f!=null,[y,C]=l;let A=0;y&&(A=y*100);let T=100;C&&(T=100-C*100);let N;!m&&c!=null&&!o&&(N=`${c*100}%`);const F=ds(r);return(0,s.jsxs)("div",{"aria-hidden":!0,className:F.ViewingLayer,style:{height:t},children:[(y!==0||C!==1)&&(0,s.jsx)(ce.$n,{onClick:this._resetTimeZoomClickHandler,className:de()(F.ViewingLayerResetZoom,F.ViewingLayerResetZoomHoverClassName),type:"button",variant:"secondary",children:(0,s.jsx)(g.x6,{i18nKey:"explore.unthemed-viewing-layer.reset-selection",children:"Reset selection"})}),(0,s.jsxs)("svg",{height:t,className:F.ViewingLayerGraph,ref:this._setRoot,onMouseDown:this._draggerReframe.handleMouseDown,onMouseLeave:this._draggerReframe.handleMouseLeave,onMouseMove:this._draggerReframe.handleMouseMove,children:[A>0&&(0,s.jsx)("rect",{x:0,y:0,height:"100%",width:`${A}%`,className:F.ViewingLayerInactive,"data-testid":"left-ViewingLayerInactive"}),T>0&&(0,s.jsx)("rect",{x:`${100-T}%`,y:0,height:"100%",width:`${T}%`,className:F.ViewingLayerInactive,"data-testid":"right-ViewingLayerInactive"}),(0,s.jsx)(wn,{numTicks:a}),N&&(0,s.jsx)("line",{className:F.ViewingLayerCursorGuide,x1:N,y1:"0",x2:N,y2:t-2,strokeWidth:"1","data-testid":"ViewingLayerCursorGuide"}),u!=null&&this._getMarkers(y,u),p!=null&&this._getMarkers(C,p),(0,s.jsx)(cs,{isDragging:u!=null,onMouseDown:this._draggerStart.handleMouseDown,onMouseEnter:this._draggerStart.handleMouseEnter,onMouseLeave:this._draggerStart.handleMouseLeave,position:y||0}),(0,s.jsx)(cs,{isDragging:p!=null,position:C||1,onMouseDown:this._draggerEnd.handleMouseDown,onMouseEnter:this._draggerEnd.handleMouseEnter,onMouseLeave:this._draggerEnd.handleMouseLeave}),f!=null&&this._getMarkers(f.anchor,f.shift)]}),m&&(0,s.jsx)("div",{className:F.ViewingLayerFullOverlay})]})}}const Rn=(0,x.cV)(Cn),kn=()=>({container:(0,i.css)({padding:"0 0.5rem 0.5rem 0.5rem"}),canvasContainer:(0,i.css)({position:"relative"})}),us=60,ps=4;function Ln(e){return{valueOffset:e.relativeStartTime,valueWidth:e.duration,serviceName:e.process.serviceName}}function En(e){return e.spans.map(Ln)}const jn=(0,q.default)(En);class Nn extends h.PureComponent{static{this.defaultProps={height:us}}render(){const{height:t,trace:n,viewRange:a,updateNextViewRangeTime:r,updateViewRangeTime:o}=this.props,l=kn();if(!n)return(0,s.jsx)("div",{});const c=jn(n);return(0,s.jsxs)("div",{className:l.container,children:[(0,s.jsx)(bn,{numTicks:ps,duration:n.duration}),(0,s.jsxs)("div",{className:l.canvasContainer,children:[(0,s.jsx)(vn,{valueWidth:n.duration,items:c}),(0,s.jsx)(Rn,{viewRange:a,numTicks:ps,height:t||us,updateViewRangeTime:o,updateNextViewRangeTime:r})]})]})}}var Mn=d(75888),An=d.n(Mn);const Fn={scrollPageDown:{binding:"s",label:"Scroll down"},scrollPageUp:{binding:"w",label:"Scroll up"},scrollToNextVisibleSpan:{binding:"f",label:"Scroll to the next visible span"},scrollToPrevVisibleSpan:{binding:"b",label:"Scroll to the previous visible span"},panLeft:{binding:["a","left"],label:"Pan left"},panLeftFast:{binding:["shift+a","shift+left"],label:"Pan left \u2014 Large"},panRight:{binding:["d","right"],label:"Pan right"},panRightFast:{binding:["shift+d","shift+right"],label:"Pan right \u2014 Large"},zoomIn:{binding:"up",label:"Zoom in"},zoomInFast:{binding:"shift+up",label:"Zoom in \u2014 Large"},zoomOut:{binding:"down",label:"Zoom out"},zoomOutFast:{binding:"shift+down",label:"Zoom out \u2014 Large"},collapseAll:{binding:"]",label:"Collapse All"},expandAll:{binding:"[",label:"Expand All"},collapseOne:{binding:"p",label:"Collapse One Level"},expandOne:{binding:"o",label:"Expand One Level"},searchSpans:{binding:"ctrl+b",label:"Search Spans"},clearSearch:{binding:"escape",label:"Clear Search"}};let kt;function hs(){if(kt)return kt;const e=new(An())(document.body);return kt=e,e}function On(e){const t=hs();Object.keys(e).forEach(n=>{const a=e[n];a&&t.bind(Fn[n].binding,a)})}function ti(){hs().reset()}function _n(e){const{min:t,max:n,viewStart:a,viewEnd:r}=e,o=n-t,l=t+a*o,u=n-(1-r)*o-l;return(p,f)=>({start:(p-l)/u,end:(f-l)/u})}function ft(e,t,n){return!Array.isArray(n.tags)||!n.tags.length?!1:n.tags.some(a=>a.key===e&&a.value===t)}const Vn=e=>e.kind==="client",Bn=ft.bind(null,"span.kind","client"),Pn=e=>Vn(e)||Bn(e),Hn=e=>e.kind==="server",$n=ft.bind(null,"span.kind","server"),Wn=e=>Hn(e)||$n(e),Kn=e=>e.statusCode===2,zn=ft.bind(null,"error",!0),Un=ft.bind(null,"error","true"),gs=e=>Kn(e)||zn(e)||Un(e);function Gn(e,t){const{depth:n}=e[t];let a=t+1;for(;a<e.length&&e[a].depth>n;a++)if(gs(e[a]))return!0;return!1}function Zn(e){if(e.length<=1||!Pn(e[0]))return!1;const n=e[0].depth+1;let a=1;for(;a<e.length&&e[a].depth===n;){if(Wn(e[a]))return e[a];a++}return null}const Xn=e=>e.kind?e.kind==="client":e.tags.some(({key:t,value:n})=>t==="span.kind"&&n==="client"),Qn=e=>({Ticks:(0,i.css)({label:"Ticks",pointerEvents:"none"}),TicksTick:(0,i.css)({label:"TicksTick",position:"absolute",height:"100%",width:"1px",background:(0,j.R)(e,"#d8d8d8"),"&:last-child":{width:0}}),TicksTickLabel:(0,i.css)({label:"TicksTickLabel",left:"0.25rem",position:"absolute",whiteSpace:"nowrap"}),TicksTickLabelEndAnchor:(0,i.css)({label:"TicksTickLabelEndAnchor",left:"initial",right:"0.25rem"})});function fs({endTime:e=null,numTicks:t,showLabels:n=null,startTime:a=null}){let r;if(n){r=[];const c=(e||0)-(a||0);for(let u=0;u<t;u++){const p=(a||0)+u/(t-1)*c;r.push(Je(p))}}const o=(0,x.of)(Qn),l=[];for(let c=0;c<t;c++){const u=c/(t-1);l.push((0,s.jsx)("div",{"data-testid":"TicksID",className:o.TicksTick,style:{left:`${u*100}%`},children:r&&(0,s.jsx)("span",{className:de()(o.TicksTickLabel,{[o.TicksTickLabelEndAnchor]:u>=1}),children:r[c]})},u))}return(0,s.jsx)("div",{className:o.Ticks,children:l})}const ms=()=>({row:(0,i.css)({display:"flex",flex:"0 1 auto",flexDirection:"row"}),rowCell:(0,i.css)({position:"relative"})});function We({children:e,className:t="",...n}){const a=(0,x.of)(ms);return(0,s.jsx)("div",{className:de()(a.row,t),...n,children:e})}function Yn({children:e,className:t="",width:n,style:a={},...r}){const o=`${n*100}%`,l={...a,flexBasis:o,maxWidth:o},c=(0,x.of)(ms);return(0,s.jsx)("div",{className:de()(c.rowCell,t),style:l,"data-testid":"TimelineRowCell",...r,children:e})}We.Cell=Yn;const Jn=e=>({TimelineCollapser:(0,i.css)({alignItems:"center",display:"flex",flex:"none",justifyContent:"center",marginRight:"0.5rem"}),buttonsContainer:(0,i.css)({display:"flex",flexDirection:"row",gap:"0.5rem",paddingRight:e.spacing(1)}),buttonContainer:(0,i.css)({display:"flex",alignItems:"center"})});function qn(e){const{onExpandAll:t,onExpandOne:n,onCollapseAll:a,onCollapseOne:r}=e,o=(0,x.of)(Jn);return(0,s.jsx)("div",{className:o.TimelineCollapser,"data-testid":"TimelineCollapser",children:(0,s.jsxs)("div",{className:o.buttonsContainer,children:[(0,s.jsxs)("div",{className:o.buttonContainer,children:[(0,s.jsx)(ce.$n,{"aria-label":(0,g.t)("explore.timeline-collapser.tooltip-expand","Expand +1"),tooltip:(0,g.t)("explore.timeline-collapser.tooltip-expand","Expand +1"),size:"sm",tooltipPlacement:"top",icon:"angle-down",onClick:n,fill:"solid",variant:"secondary"}),(0,s.jsx)(ce.$n,{"aria-label":(0,g.t)("explore.timeline-collapser.tooltip-collapse","Collapse +1"),tooltip:(0,g.t)("explore.timeline-collapser.tooltip-collapse","Collapse +1"),size:"sm",tooltipPlacement:"top",icon:"angle-up",onClick:r,fill:"solid",variant:"secondary"})]}),(0,s.jsxs)("div",{className:o.buttonContainer,children:[(0,s.jsx)(ce.$n,{"aria-label":(0,g.t)("explore.timeline-collapser.tooltip-expand-all","Expand all"),tooltip:(0,g.t)("explore.timeline-collapser.tooltip-expand-all","Expand all"),size:"sm",tooltipPlacement:"top",icon:"angle-double-down",onClick:t,fill:"solid",variant:"secondary"}),(0,s.jsx)(ce.$n,{"aria-label":(0,g.t)("explore.timeline-collapser.tooltip-collapse-all","Collapse all"),tooltip:(0,g.t)("explore.timeline-collapser.tooltip-collapse-all","Collapse all"),size:"sm",tooltipPlacement:"top",icon:"angle-double-up",onClick:a,fill:"solid",variant:"secondary"})]})]})})}const ea=()=>({TimelineColumnResizer:(0,i.css)({left:0,position:"absolute",right:0,top:0}),wrapper:(0,i.css)({bottom:0,position:"absolute",top:0}),dragger:(0,i.css)({borderLeft:"2px solid transparent",cursor:"col-resize",height:"5000px",marginLeft:"-1px",position:"absolute",top:0,width:"1px",zIndex:10,"&:hover":{borderLeft:"2px solid rgba(0, 0, 0, 0.3)"},"&::before":{position:"absolute",top:0,bottom:0,left:"-8px",right:0,content:'" "'}}),draggerDragging:(0,i.css)({background:"rgba(136, 0, 136, 0.05)",width:"unset","&::before":{left:-2e3,right:-2e3}}),draggerDraggingLeft:(0,i.css)({borderLeft:"2px solid #808",borderRight:"1px solid #999"}),draggerDraggingRight:(0,i.css)({borderLeft:"1px solid #999",borderRight:"2px solid #808"}),gripIcon:(0,i.css)({position:"absolute",top:0,bottom:0,"&::before, &::after":{borderRight:"1px solid #ccc",content:'" "',height:"9px",position:"absolute",right:"9px",top:"25px"},"&::after":{right:"5px"}}),gripIconDragging:(0,i.css)({"&::before, &::after":{borderRight:"1px solid rgba(136, 0, 136, 0.5)"}})});class ta extends h.PureComponent{constructor(t){super(t),this._setRootElm=n=>{this._rootElm=n},this._getDraggingBounds=()=>{if(!this._rootElm)throw new Error("invalid state");const{left:n,width:a}=this._rootElm.getBoundingClientRect(),{min:r,max:o}=this.props;return{clientXLeft:n,width:a,maxValue:o,minValue:r}},this._handleDragUpdate=({value:n})=>{this.setState({dragPosition:n})},this._handleDragEnd=({manager:n,value:a})=>{n.resetBounds(),this.setState({dragPosition:null}),this.props.onChange(a)},this._dragManager=new ct({getBounds:this._getDraggingBounds,onDragEnd:this._handleDragEnd,onDragMove:this._handleDragUpdate,onDragStart:this._handleDragUpdate}),this._rootElm=void 0,this.state={dragPosition:null}}componentWillUnmount(){this._dragManager.dispose()}render(){let t,n;const{position:a,columnResizeHandleHeight:r}=this.props,{dragPosition:o}=this.state;t=`${a*100}%`;const l={left:t};let c=!1,u=!1;const p=ea();if(this._dragManager.isDragging()&&this._rootElm&&o!=null){c=o<a,u=o>a;const m=`${Math.min(a,o)*100}%`,y=`calc(${(1-Math.max(a,o))*100}% - 1px)`;n={left:m,right:y}}else n=l;n.height=r;const f=c||u;return(0,s.jsxs)("div",{className:p.TimelineColumnResizer,ref:this._setRootElm,"data-testid":"TimelineColumnResizer",children:[(0,s.jsx)("div",{className:de()(p.gripIcon,f&&p.gripIconDragging),style:l,"data-testid":"TimelineColumnResizer--gripIcon"}),(0,s.jsx)("div",{"aria-hidden":!0,className:de()(p.dragger,f&&p.draggerDragging,u&&p.draggerDraggingRight,c&&p.draggerDraggingLeft),onMouseDown:this._dragManager.handleMouseDown,style:n,"data-testid":"TimelineColumnResizer--dragger"})]})}}const xs=(0,Xe.N)(()=>({TimelineViewingLayer:(0,i.css)({label:"TimelineViewingLayer",bottom:0,cursor:"vertical-text",left:0,position:"absolute",right:0,top:0}),TimelineViewingLayerCursorGuide:(0,i.css)({label:"TimelineViewingLayerCursorGuide",position:"absolute",top:0,bottom:0,left:0,width:"1px",backgroundColor:"red"}),TimelineViewingLayerDragged:(0,i.css)({label:"TimelineViewingLayerDragged",position:"absolute",top:0,bottom:0}),TimelineViewingLayerDraggedDraggingLeft:(0,i.css)({label:"TimelineViewingLayerDraggedDraggingLeft",borderLeft:"1px solid"}),TimelineViewingLayerDraggedDraggingRight:(0,i.css)({label:"TimelineViewingLayerDraggedDraggingRight",borderRight:"1px solid"}),TimelineViewingLayerDraggedShiftDrag:(0,i.css)({label:"TimelineViewingLayerDraggedShiftDrag",backgroundColor:"rgba(68, 68, 255, 0.2)",borderColor:"#44f"}),TimelineViewingLayerDraggedReframeDrag:(0,i.css)({label:"TimelineViewingLayerDraggedReframeDrag",backgroundColor:"rgba(255, 68, 68, 0.2)",borderColor:"#f44"}),TimelineViewingLayerFullOverlay:(0,i.css)({label:"TimelineViewingLayerFullOverlay",bottom:0,cursor:"col-resize",left:0,position:"fixed",right:0,top:0,userSelect:"none"})}));function sa(e){return Reflect.has(e,"isOutOfView")}function Lt(e,t,n){return e+n*(t-e)}function Et(e,t,n){return(n-e)/(t-e)}function na(e,t){let[n,a]=e<t?[e,t]:[t,e];return n>=1||a<=0?{isOutOfView:!0}:(n<0&&(n=0),a>1&&(a=1),{isDraggingLeft:e>t,left:`${n*100}%`,width:`${(a-n)*100}%`})}function jt(e,t,n,a,r){const o=Et(e,t,n),l=Et(e,t,a),c=na(o,l);if(sa(c))return null;const{isDraggingLeft:u,left:p,width:f}=c,m=xs(),y=(0,i.cx)({[m.TimelineViewingLayerDraggedDraggingRight]:!u,[m.TimelineViewingLayerDraggedReframeDrag]:!r,[m.TimelineViewingLayerDraggedShiftDrag]:r});return(0,s.jsx)("div",{className:(0,i.cx)(m.TimelineViewingLayerDragged,m.TimelineViewingLayerDraggedDraggingLeft,y),style:{left:p,width:f},"data-testid":"Dragged"})}class aa extends h.PureComponent{constructor(t){super(t),this._setRoot=n=>{this._root=n},this._getDraggingBounds=()=>{if(!this._root)throw new Error("invalid state");const{left:n,width:a}=this._root.getBoundingClientRect();return{clientXLeft:n,width:a}},this._handleReframeMouseMove=({value:n})=>{const[a,r]=this.props.viewRangeTime.current,o=Lt(a,r,n);this.props.updateNextViewRangeTime({cursor:o})},this._handleReframeMouseLeave=()=>{this.props.updateNextViewRangeTime({cursor:void 0})},this._handleReframeDragUpdate=({value:n})=>{const{current:a,reframe:r}=this.props.viewRangeTime,[o,l]=a,c=Lt(o,l,n),p={reframe:{anchor:r?r.anchor:c,shift:c}};this.props.updateNextViewRangeTime(p)},this._handleReframeDragEnd=({manager:n,value:a})=>{const{current:r,reframe:o}=this.props.viewRangeTime,[l,c]=r,u=Lt(l,c,a),p=o?o.anchor:u,[f,m]=u<p?[u,p]:[p,u];n.resetBounds(),this.props.updateViewRangeTime(f,m,"timeline-header")},this._draggerReframe=new ct({getBounds:this._getDraggingBounds,onDragEnd:this._handleReframeDragEnd,onDragMove:this._handleReframeDragUpdate,onDragStart:this._handleReframeDragUpdate,onMouseLeave:this._handleReframeMouseLeave,onMouseMove:this._handleReframeMouseMove}),this._root=void 0}UNSAFE_componentWillReceiveProps(t){const{boundsInvalidator:n}=this.props;n!==t.boundsInvalidator&&this._draggerReframe.resetBounds()}componentWillUnmount(){this._draggerReframe.dispose()}render(){const{viewRangeTime:t}=this.props,{current:n,cursor:a,reframe:r,shiftEnd:o,shiftStart:l}=t,[c,u]=n,p=r!=null||o!=null||l!=null;let f;!p&&a!=null&&a>=c&&a<=u&&(f=`${Et(c,u,a)*100}%`);const m=xs();return(0,s.jsxs)("div",{"aria-hidden":!0,className:m.TimelineViewingLayer,ref:this._setRoot,onMouseDown:this._draggerReframe.handleMouseDown,onMouseLeave:this._draggerReframe.handleMouseLeave,onMouseMove:this._draggerReframe.handleMouseMove,"data-testid":"TimelineViewingLayer",children:[f!=null&&(0,s.jsx)("div",{className:m.TimelineViewingLayerCursorGuide,style:{left:f},"data-testid":"TimelineViewingLayer--cursorGuide"}),r!=null&&jt(c,u,r.anchor,r.shift,!1),o!=null&&jt(c,u,u,o,!0),l!=null&&jt(c,u,c,l,!0)]})}}const ra=e=>({TimelineHeaderRow:(0,i.css)({label:"TimelineHeaderRow",background:(0,j.R)(e,"#ececec"),borderBottom:`1px solid ${(0,j.R)(e,"#ccc")}`,height:"38px",lineHeight:"38px",width:"100%",zIndex:4,position:"relative"}),TimelineHeaderRowTitle:(0,i.css)({label:"TimelineHeaderRowTitle",flex:1,overflow:"hidden",margin:0,textOverflow:"ellipsis",whiteSpace:"nowrap"}),TimelineHeaderWrapper:(0,i.css)({label:"TimelineHeaderWrapper",alignItems:"center",display:"flex",paddingLeft:e.spacing(1),paddingRight:e.spacing(1)})});function ia(e){const{duration:t,nameColumnWidth:n,numTicks:a,onCollapseAll:r,onCollapseOne:o,onColummWidthChange:l,onExpandAll:c,onExpandOne:u,updateViewRangeTime:p,updateNextViewRangeTime:f,viewRangeTime:m,columnResizeHandleHeight:y}=e,[C,A]=m.current,T=(0,x.of)(ra);return(0,s.jsxs)(We,{className:T.TimelineHeaderRow,"data-testid":"TimelineHeaderRow",children:[(0,s.jsxs)(We.Cell,{className:T.TimelineHeaderWrapper,width:n,children:[(0,s.jsx)("h4",{className:T.TimelineHeaderRowTitle,children:(0,s.jsx)(g.x6,{i18nKey:"explore.timeline-header-row.title",children:"Service & Operation"})}),(0,s.jsx)(qn,{onCollapseAll:r,onExpandAll:c,onCollapseOne:o,onExpandOne:u})]}),(0,s.jsxs)(We.Cell,{width:1-n,children:[(0,s.jsx)(aa,{boundsInvalidator:n,updateNextViewRangeTime:f,updateViewRangeTime:p,viewRangeTime:m}),(0,s.jsx)(fs,{numTicks:a,startTime:C*t,endTime:A*t,showLabels:!0})]}),(0,s.jsx)(ta,{columnResizeHandleHeight:y,position:n,onChange:l,min:.2,max:.85})]})}var vs=d(7895);const oa="peer.service";class la{constructor(t){this.ys=[],this.heights=[],this.bufferLen=t,this.dataLen=-1,this.lastI=-1}profileData(t){t!==this.dataLen&&(this.dataLen=t,this.ys.length=t,this.heights.length=t,this.lastI>=t&&(this.lastI=t-1))}calcHeights(t,n,a){a!=null&&(this.lastI=a);let r=t+this.bufferLen;if(r<=this.lastI)return;r>=this.heights.length&&(r=this.heights.length-1);let o=this.lastI;for(this.lastI===-1&&(o=0,this.ys[0]=0);o<=r;){const l=this.heights[o]=n(o);this.ys[o+1]=this.ys[o]+l,o++}this.lastI=r}calcYs(t,n){for(;(this.ys[this.lastI]==null||t>this.ys[this.lastI])&&this.lastI<this.dataLen-1;)this.calcHeights(this.lastI,n)}confirmHeight(t,n){let a=t;if(a>this.lastI){this.calcHeights(a,n);return}const r=n(a);if(r===this.heights[a])return;const o=r-this.heights[a];for(this.heights[a]=r;++a<=this.lastI;)this.ys[a]+=o;this.ys[this.lastI+1]!=null&&(this.ys[this.lastI+1]+=o)}findFloorIndex(t,n){this.calcYs(t,n);let a=0,r=this.lastI;if(this.ys.length<2||t<this.ys[1])return 0;if(t>this.ys[r])return r;let o;for(;a<r;)if(o=a+.5*(r-a)|0,t>this.ys[o]){if(t<=this.ys[o+1])return o;a=o}else if(t<this.ys[o]){if(t>=this.ys[o-1])return o-1;r=o}else return o;throw new Error(`unable to find floor index for y=${t}`)}getRowPosition(t,n){return this.confirmHeight(t,n),{height:this.heights[t],y:this.ys[t]}}getEstimatedHeight(){const t=this.ys[this.lastI]+this.heights[this.lastI];return this.lastI>=this.dataLen-1?t|0:t/(this.lastI+1)*this.heights.length|0}}const ys=100;class ca extends h.Component{constructor(t){super(t),this.getViewHeight=()=>this._viewHeight,this.getBottomVisibleIndex=()=>{const n=this._scrollTop+this._viewHeight;return this._yPositions.findFloorIndex(n,this._getHeight)},this.getTopVisibleIndex=()=>this._yPositions.findFloorIndex(this._scrollTop,this._getHeight),this.getRowPosition=n=>this._yPositions.getRowPosition(n,this._getHeight),this.scrollToIndex=(n,a)=>{const{scrollElement:r}=this.props,o=r?.getBoundingClientRect().top||0,c=(r?.scrollTop||0)+(this._itemHolderElm?.getBoundingClientRect().top||0)-o,u=this.getRowPosition(n).y;this.props.scrollElement?.scrollTo({top:u+c-a-80})},this._onScroll=()=>{this._isScrolledOrResized||(this._isScrolledOrResized=!0,window.requestAnimationFrame(this._positionList))},this._positionList=()=>{if(this._isScrolledOrResized=!1,!this._wrapperElm)return;this._calcViewIndexes();const n=this.props.viewBufferMin>this._startIndex?0:this._startIndex-this.props.viewBufferMin,a=this.props.viewBufferMin<this.props.dataLength-this._endIndex?this._endIndex+this.props.viewBufferMin:this.props.dataLength-1;(n<this._startIndexDrawn||a>this._endIndexDrawn)&&this.forceUpdate()},this._initWrapper=n=>{this.props.windowScroller&&(this._wrapperElm=n,n&&(this._viewHeight=n.clientHeight))},this._initItemHolder=n=>{this._itemHolderElm=n,this._scanItemHeights()},this._scanItemHeights=()=>{const n=this.props.getIndexFromKey;if(!this._itemHolderElm)return;let a=null,r=null,o=!1;const l=this._itemHolderElm.childNodes,c=l.length;for(let u=0;u<c;u++){const p=l[u];if(p instanceof HTMLElement){const f=p.getAttribute("data-item-key");if(!f){console.warn("itemKey not found");continue}const y=(p.firstElementChild||p).clientHeight,C=this._knownHeights.get(f);y!==C&&(this._knownHeights.set(f,y),o?r=f:(o=!0,a=r=f))}}if(a!=null&&r!=null){const u=n(a),p=r===a?u:n(r);this._yPositions.calcHeights(p,this._getHeight,u),this.forceUpdate()}},this._getHeight=n=>{const a=this.props.getKeyFromIndex(n),r=this._knownHeights.get(a);return r!=null&&r===r?r:this.props.itemHeightGetter(n,a)},this._yPositions=new la(200),this._knownHeights=new Map,this._startIndexDrawn=2**20,this._endIndexDrawn=-(2**20),this._startIndex=0,this._endIndex=0,this._viewHeight=-1,this._scrollTop=-1,this._isScrolledOrResized=!1,this._htmlTopOffset=-1,this._windowScrollListenerAdded=!1,this._htmlElm=document.documentElement,this._wrapperElm=void 0,this._itemHolderElm=void 0}static{this.defaultProps={initialDraw:ys,itemsWrapperClassName:"",windowScroller:!1}}componentDidMount(){if(this.props.windowScroller){if(this._wrapperElm){const{top:t}=this._wrapperElm.getBoundingClientRect();this._htmlTopOffset=t+this._htmlElm.scrollTop}window.addEventListener("scroll",this._onScroll),this._windowScrollListenerAdded=!0}else this._wrapperElm=this.props.scrollElement,this._wrapperElm?.addEventListener("scroll",this._onScroll)}componentDidUpdate(t){this._itemHolderElm&&this._scanItemHeights(),!this.props.windowScroller&&t.scrollElement!==this.props.scrollElement&&(t.scrollElement?.removeEventListener("scroll",this._onScroll),this._wrapperElm=this.props.scrollElement,this._wrapperElm?.addEventListener("scroll",this._onScroll))}componentWillUnmount(){this._windowScrollListenerAdded?window.removeEventListener("scroll",this._onScroll):this._wrapperElm?.removeEventListener("scroll",this._onScroll)}_isViewChanged(){if(!this._wrapperElm)return!1;const t=this.props.windowScroller,n=t?this._htmlElm.clientHeight:this._wrapperElm.clientHeight,a=t?this._htmlElm.scrollTop:this._wrapperElm.scrollTop;return n!==this._viewHeight||a!==this._scrollTop}_calcViewIndexes(){if(this.props.windowScroller)this._viewHeight=window.innerHeight-this._htmlTopOffset,this._scrollTop=window.scrollY;else{if(!this._wrapperElm){this._viewHeight=-1,this._startIndex=0,this._endIndex=0;return}this._viewHeight=this._wrapperElm.clientHeight,this._scrollTop=this._wrapperElm.scrollTop}const n=this._scrollTop,a=this._scrollTop+this._viewHeight;this._startIndex=this._yPositions.findFloorIndex(n,this._getHeight),this._endIndex=this._yPositions.findFloorIndex(a,this._getHeight)}render(){const{dataLength:t,getKeyFromIndex:n,initialDraw:a=ys,itemRenderer:r,viewBuffer:o,viewBufferMin:l}=this.props,c=this._getHeight,u=[];let p,f;if(this._yPositions.profileData(t),!this._wrapperElm)p=0,f=(a<t?a:t)-1;else{this._isViewChanged()&&this._calcViewIndexes();const C=l>this._startIndex?0:this._startIndex-l,A=l<t-this._endIndex?this._endIndex+l:t-1;C<this._startIndexDrawn||A>this._endIndexDrawn?(p=o>this._startIndex?0:this._startIndex-o,f=this._endIndex+o,f>=t&&(f=t-1)):(p=this._startIndexDrawn>t-1?0:this._startIndexDrawn,f=this._endIndexDrawn>t-1?t-1:this._endIndexDrawn)}this._yPositions.calcHeights(f,c,p||-1),this._startIndexDrawn=p,this._endIndexDrawn=f,u.length=f-p+1;for(let C=p;C<=f;C++){const{y:A,height:T}=this._yPositions.getRowPosition(C,c),N={height:T,top:A,position:"absolute"},F=n(C),G={"data-item-key":F};u.push(r(F,N,C,G))}const m={style:{position:"relative"},ref:this._initWrapper};this.props.windowScroller||(m.onScroll=this._onScroll,m.style.height="100%",m.style.overflowY="auto");const y={position:"relative",height:this._yPositions.getEstimatedHeight()};return(0,s.jsx)("div",{...m,"data-testid":"ListView",children:(0,s.jsx)("div",{style:y,children:(0,s.jsx)("div",{style:{position:"absolute",top:0,margin:0,padding:0},className:this.props.itemsWrapperClassName,ref:this._initItemHolder,children:u})})})}}const bs="None",Ss="Duration",Nt="Tag";function da({options:e,onOptionsChange:t}){const n=useStyles2(ua),a=[bs,Ss,Nt].map(toOption);return jsxs("div",{className:css({width:"100%"}),children:[jsx(InlineFieldRow,{className:n.row,children:jsx(InlineField,{label:"Label",labelWidth:26,tooltip:"Default: duration",grow:!0,children:jsx(Select,{inputId:"label",options:a,value:e.jsonData.spanBar?.type||"",onChange:r=>{updateDatasourcePluginJsonDataOption({onOptionsChange:t,options:e},"spanBar",{...e.jsonData.spanBar,type:r?.value??""})},placeholder:"Duration",isClearable:!0,"aria-label":"select-label-name",width:40})})}),e.jsonData.spanBar?.type===Nt&&jsx(InlineFieldRow,{className:n.row,children:jsx(InlineField,{label:"Tag key",labelWidth:26,tooltip:"Tag key which will be used to get the tag value. A span's attributes and resources will be searched for the tag key",children:jsx(Input,{type:"text",placeholder:"Enter tag key",onChange:r=>updateDatasourcePluginJsonDataOption({onOptionsChange:t,options:e},"spanBar",{...e.jsonData.spanBar,tag:r.currentTarget.value}),value:e.jsonData.spanBar?.tag||"",width:40})})})]})}const si=({options:e,onOptionsChange:t})=>{let n=e.type;return n+=e.type==="tempo"?"/configure-tempo-data-source/#span-bar":"/#span-bar",jsx(ConfigSubSection,{title:"Span bar",description:jsx(ConfigDescriptionLink,{description:"Add additional info next to the service and operation on a span bar row in the trace view.",suffix:n,feature:"the span bar"}),children:jsx(da,{options:e,onOptionsChange:t})})},ua=e=>({infoText:css({label:"infoText",paddingBottom:e.spacing(2),color:e.colors.text.secondary}),row:css({label:"row",alignItems:"baseline"})});var pa=d(51898),ha=d(43533),ga=d(2381);function fa({children:e,content:t,overlayClassName:n}){const a=(0,h.useRef)(null);return(0,s.jsx)(ha.I,{content:t,hideAfter:300,children:(r,o,l)=>(0,s.jsxs)(s.Fragment,{children:[a.current&&(0,s.jsx)(ga.A,{...l,referenceElement:a.current,wrapperClassName:n,onMouseLeave:o,onMouseEnter:r}),(0,h.cloneElement)(e,{ref:a,onMouseEnter:r,onMouseLeave:o})]})})}var Mt=d(72489);const ma="label";var xa=d(21961),va=d(11908),mt=d(17548),xt=d(25229),Is=d(78529),xe=(e=>(e.Logs="log",e.Traces="trace",e.Metrics="metric",e.Profiles="profile",e.ProfilesDrilldown="profile-drilldown",e.Session="session",e.Unknown="unknown",e))(xe||{});function ya({splitOpenFn:e,traceToLogsOptions:t,traceToMetricsOptions:n,traceToProfilesOptions:a,dataFrame:r,createFocusSpanLink:o,trace:l}){if(!r)return;let c=Rs(l.duration,l.traceName,l.traceID);const u=r.fields.some(f=>!!f.config.links?.length),p=Sa(e,r.fields[0],t,n,o,c);return function(m){let y=p(m);if(u){c={...c,...Ft(m),...ks(m,a)};const C=r.fields.filter(A=>!!A.config.links?.length);try{let A;a?.datasourceUid&&(A=(0,w.tR)().getInstanceSettings(a.datasourceUid));const T=A?.type==="grafana-pyroscope-datasource",N=m.tags.some(O=>O.key===vt),F=T&&N;let G=[];C.forEach(O=>{const ee=(0,Is.QL)({field:O,rowIndex:m.dataFrameRowIndex,splitOpenFn:e,range:At(m,void 0,void 0,F),dataFrame:r,vars:c});G=G.concat(ee)});const Z=G.map(O=>({title:O.title,href:O.href,onClick:O.onClick,content:(0,s.jsx)(oe.I,{name:"link",title:O.title||"Link"}),field:O.origin,type:F?xe.Profiles:xe.Unknown,target:O.target}));y.push.apply(y,Z)}catch(A){return console.error(A),y}}return y}}const ws=e=>e.map(t=>({key:t,value:t.includes(".")?t.replace(".","_"):void 0})),Ts=ws(["cluster","hostname","namespace","pod","service.name","service.namespace"]),Ds=ws(["service.name","service.namespace"]),vt="pyroscope.profile.id",ba="gf.feo11y.app.id";function Sa(e,t,n,a,r,o){let l;n?.datasourceUid&&(l=(0,w.tR)().getInstanceSettings(n.datasourceUid));const c=l?.type==="grafana-splunk-datasource";let u;return a?.datasourceUid&&(u=(0,w.tR)().getInstanceSettings(a.datasourceUid)),function(f){o={...o,...Ft(f)};const m=[];let y,C="";if(l&&n){const T=n.customQuery?n.query:void 0,N=n.tags&&n.tags.length>0?n.tags:Ts;switch(l?.type){case"loki":C=Ke(f,N),y=Ia(f,n,C,T);break;case"grafana-splunk-datasource":C=Ke(f,N,{joinBy:" "}),y=Da(f,n,C,T);break;case"elasticsearch":case"grafana-opensearch-datasource":C=Ke(f,N,{labelValueSign:":",joinBy:" AND "}),y=Ta(f,n,C,T);break;case"grafana-falconlogscale-datasource":C=Ke(f,N,{joinBy:" OR "}),y=Ra(f,n,C,T);break;case"googlecloud-logging-datasource":C=Ke(f,N,{joinBy:" AND "}),y=Ca(f,n,C,T);break;case"victoriametrics-logs-datasource":C=Ke(f,N,{labelValueSign:":=",joinBy:" AND "}),y=ka(f,n,C,T);break}if(y){const F={title:l.name,url:"",internal:{datasourceUid:l.uid,datasourceName:l.name,query:y}};if(o={...o,__tags:{text:(0,g.t)("explore.legacy-create-span-link-factory.text.tags","Tags"),value:C}},(0,Is.O1)(F.internal.query,o).allVariablesDefined){const G=(0,M.u)({link:F,internalLink:F.internal,scopedVars:o,range:At(f,{startMs:n.spanStartTimeShift?mt.intervalToMs(n.spanStartTimeShift):0,endMs:n.spanEndTimeShift?mt.intervalToMs(n.spanEndTimeShift):0},c),field:{},onClickFn:e,replaceVariables:(0,X.w)().replace.bind((0,X.w)())});m.push({href:G.href,title:(0,g.t)("explore.legacy-create-span-link-factory.title.related-logs","Related logs"),onClick:G.onClick,content:(0,s.jsx)(oe.I,{name:"gf-logs",title:(0,g.t)("explore.legacy-create-span-link-factory.title-explore-split","Explore the logs for this in split view")}),field:t,type:xe.Logs})}}}if(u&&a?.queries)for(const T of a.queries){const N=T.query||`histogram_quantile(0.5, sum(rate(traces_spanmetrics_latency_bucket{service="${f.process.serviceName}"}[5m])) by (le))`,F={title:u.name,url:"",internal:{datasourceUid:u.uid,datasourceName:u.name,query:{expr:N,refId:"A"}}},G=a.tags&&a.tags.length>0?a.tags:Ts;o={...o,__tags:{text:(0,g.t)("explore.legacy-create-span-link-factory.text.tags","Tags"),value:Ke(f,G)}};const Z=(0,M.u)({link:F,internalLink:F.internal,scopedVars:o,range:At(f,{startMs:a.spanStartTimeShift?mt.intervalToMs(a.spanStartTimeShift):-12e4,endMs:a.spanEndTimeShift?mt.intervalToMs(a.spanEndTimeShift):12e4}),field:{},onClickFn:e,replaceVariables:(0,X.w)().replace.bind((0,X.w)())});m.push({title:T?.name,href:Z.href,onClick:Z.onClick,content:(0,s.jsx)(oe.I,{name:"chart-line",title:(0,g.t)("explore.legacy-create-span-link-factory.title-explore-metrics-for-this-span","Explore metrics for this span")}),field:t,type:xe.Metrics})}if(f.references&&r)for(const T of f.references){if(T.refType==="CHILD_OF")continue;const N=r(T.traceID,T.spanID),F=Cs(T);m.push({href:N.href,title:F,content:(0,s.jsx)(oe.I,{name:"link",title:F}),onClick:N.onClick,field:N.origin,type:xe.Traces})}if(f.subsidiarilyReferencedBy&&r)for(const T of f.subsidiarilyReferencedBy){const N=r(T.traceID,T.spanID),F=Cs(T);m.push({href:N.href,title:F,content:(0,s.jsx)(oe.I,{name:"link",title:F}),onClick:N.onClick,field:N.origin,type:xe.Traces})}const A=wa(f);return A&&m.push({title:(0,g.t)("explore.legacy-create-span-link-factory.title.session-for-this-span","Session for this span"),href:A,content:(0,s.jsx)(oe.I,{name:"frontend-observability",title:(0,g.t)("explore.legacy-create-span-link-factory.title-session-for-this-span","Session for this span")}),field:t,type:xe.Session}),m}}const Cs=e=>{let t=e.span?e.span.operationName:"View linked span";return e.refType==="EXTERNAL"&&(t="View linked span"),t};function Ia(e,t,n,a){const{filterByTraceID:r,filterBySpanID:o}=t;if(a)return{expr:a,refId:""};if(!n)return;let l="{${__tags}}";return r&&e.traceID&&(l+=' | label_format log_line_contains_trace_id=`{{ contains "${__span.traceId}" __line__  }}` | log_line_contains_trace_id="true" or trace_id="${__span.traceId}"'),o&&e.spanID&&(l+=' | label_format log_line_contains_span_id=`{{ contains "${__span.spanId}" __line__  }}` | log_line_contains_span_id="true" or span_id="${__span.spanId}"'),{expr:l,refId:""}}function wa(e){const t=e.process.tags.find(a=>a.key===ba)?.value,n=e.tags.find(a=>a.key==="session_id"||a.key==="session.id")?.value;return t&&n?`/a/grafana-kowalski-app/apps/${t}/sessions/${n}`:void 0}function Ta(e,t,n,a){const{filterByTraceID:r,filterBySpanID:o}=t;if(a)return{query:a,refId:"",metrics:[{id:"1",type:"logs"}]};let l=[];return o&&e.spanID&&l.push('"${__span.spanId}"'),r&&e.traceID&&l.push('"${__span.traceId}"'),n&&l.push("${__tags}"),{query:l.join(" AND "),refId:"",metrics:[{id:"1",type:"logs"}]}}function Da(e,t,n,a){const{filterByTraceID:r,filterBySpanID:o}=t;if(a)return{query:a,refId:""};let l="";return n&&(l+="${__tags}"),r&&e.traceID&&(l+=' "${__span.traceId}"'),o&&e.spanID&&(l+=' "${__span.spanId}"'),{query:l,refId:""}}function Ca(e,t,n,a){const{filterByTraceID:r,filterBySpanID:o}=t;if(a)return{query:a,refId:""};let l=[];return o&&e.spanID&&l.push('"${__span.spanId}"'),r&&e.traceID&&l.push('"${__span.traceId}"'),n&&l.push("${__tags}"),{query:l.join(" AND "),refId:""}}function Ra(e,t,n,a){const{filterByTraceID:r,filterBySpanID:o}=t;if(a)return{lsql:a,refId:""};if(!n)return;let l="${__tags}";return r&&e.traceID&&(l+=' or "${__span.traceId}"'),o&&e.spanID&&(l+=' or "${__span.spanId}"'),{lsql:l,refId:""}}function ka(e,t,n,a){const{filterByTraceID:r,filterBySpanID:o}=t;if(a)return{expr:a,refId:""};const l=[];if(o&&e.spanID&&l.push('span_id:="${__span.spanId}"'),r&&e.traceID&&l.push('trace_id:="${__span.traceId}"'),n&&l.push("${__tags}"),!!l.length)return{expr:l.join(" AND "),refId:""}}function Ke(e,t,{labelValueSign:n="=",joinBy:a=", "}={}){return[...e.process.tags,...e.tags,{key:"spanId",value:e.spanID},{key:"traceId",value:e.traceID},{key:"name",value:e.operationName},{key:"duration",value:e.duration}].map(r=>{const o=t.find(l=>l.key===r.key);if(o)return`${o.value?o.value:o.key}${n}"${r.value}"`}).filter(r=>!!r).join(a)}function At(e,t={startMs:0,endMs:0},n=!1,a=!1){let r=Math.floor(e.startTime/1e3+t.startMs);const o=(e.startTime+e.duration)/1e3;let l=Math.floor(o+t.endMs);n&&l-r<1e3?l=r+1e3:a?(r=r-6e4,l=l+6e4):r===l&&l++;const c=(0,xt.KQ)(l),u=(0,xt.KQ)(r);return{from:u,to:c,raw:{from:u,to:c}}}function Rs(e,t,n){return{__trace:{text:(0,g.t)("explore.scoped-vars-from-trace.text.trace","Trace"),value:{duration:e,name:t,traceId:n}}}}function Ft(e){const t={};for(const n of e.process.tags)t[n.key]=n.value;for(const n of e.tags)t[n.key]=n.value;return{__span:{text:(0,g.t)("explore.scoped-vars-from-span.text.span","Span"),value:{spanId:e.spanID,traceId:e.traceID,duration:e.duration,name:e.operationName,tags:t}}}}function ks(e,t){let n={};if(t){const a=t.tags&&t.tags.length>0?t.tags:Ds;n={__tags:{text:(0,g.t)("explore.scoped-vars-from-tags.text.tags","Tags"),value:Ke(e,a)}}}return n}const La=e=>t=>({LabeledList:(0,i.css)({label:"LabeledList",listStyle:"none",margin:0,padding:0,...e?{marginRight:"-8px",display:"flex",flexWrap:"wrap",justifyContent:"flex-end"}:{}}),LabeledListItem:(0,i.css)({label:"LabeledListItem",display:"inline-block",...e?{borderRight:`1px solid ${(0,j.R)(t,"#ddd")}`,padding:"0 8px"}:{padding:"0 4px"}}),LabeledListLabel:(0,i.css)({label:"LabeledListLabel",color:t.isLight?"#999":"#666",marginRight:"0.25rem"}),LabeledListValue:(0,i.css)({label:"LabeledListValue",marginRight:e?void 0:"0.55rem"}),LabeledListIcon:(0,i.css)({label:"LabeledListIcon",marginRight:"0.25rem",marginTop:"-0.1rem"}),LabeledListServiceLine:(0,i.css)({label:"LabeledListServiceLine",display:"inline-block",width:"1.25rem",height:"0.35rem",marginRight:"0.5rem",verticalAlign:"middle",borderRadius:t.shape.radius.default})});function Ea(e){const{className:t,divider:n=!1,items:a,color:r}=e,o=(0,x.of)(La(n));return(0,s.jsx)("ul",{className:de()(o.LabeledList,t),children:a.map(({key:l,label:c,value:u,icon:p})=>(0,s.jsxs)("li",{className:o.LabeledListItem,children:[c==="Service:"&&(0,s.jsx)("div",{className:o.LabeledListServiceLine,style:{backgroundColor:r}}),p&&(0,s.jsx)(oe.I,{name:p,className:o.LabeledListIcon}),(0,s.jsx)("span",{className:o.LabeledListLabel,children:c}),(0,s.jsx)("strong",{className:o.LabeledListValue,children:u})]},`${l}`))})}var st=d(34282);function ja(e){const{reference:t,children:n,createFocusSpanLink:a}=e,r=a(t.traceID,t.spanID);return(0,s.jsx)("a",{href:r.href,target:r.target,rel:"noopener noreferrer",onClick:r.onClick?o=>{o.preventDefault(),r.onClick(o)}:void 0,children:n})}const Ls=e=>({AccordianReferenceItem:(0,i.css)({borderBottom:`1px solid ${(0,j.R)(e,"#d8d8d8")}`}),AccordianKeyValues:(0,i.css)({marginLeft:"10px"}),AccordianReferences:(0,i.css)({label:"AccordianReferences",position:"relative",marginBottom:"0.25rem"}),AccordianReferencesHeader:(0,i.css)({label:"AccordianReferencesHeader",color:"inherit",display:"block",padding:"0.25rem 0","&:hover":{background:(0,j.R)(e,"#dadada")}}),AccordianReferencesContent:(0,i.css)({label:"AccordianReferencesContent",background:(0,j.R)(e,"#f0f0f0"),borderTop:`1px solid ${(0,j.R)(e,"#d8d8d8")}`,padding:"0.5rem 0.5rem 0.25rem 0.5rem"}),AccordianReferencesFooter:(0,i.css)({label:"AccordianReferencesFooter",color:(0,j.R)(e,"#999")}),AccordianKeyValuesItem:(0,i.css)({marginBottom:e.spacing(.5)}),ReferencesList:(0,i.css)({background:"#fff",border:"1px solid #ddd",marginBottom:"0.7em",maxHeight:"450px",overflow:"auto"}),list:(0,i.css)({width:"100%",listStyle:"none",padding:0,margin:0,background:"#fff"}),itemContent:(0,i.css)({padding:"0.25rem 0.5rem",display:"flex",width:"100%",justifyContent:"space-between"}),item:(0,i.css)({"&:nth-child(2n)":{background:"#f5f5f5"}}),debugInfo:(0,i.css)({letterSpacing:"0.25px",margin:"0.5em 0 0",flexWrap:"wrap",display:"flex",justifyContent:"flex-end"}),debugLabel:(0,i.css)({margin:"0 5px 0 5px","&::before":{color:"#bbb",content:"attr(data-label)"}}),serviceName:(0,i.css)({marginRight:"8px"}),title:(0,i.css)({display:"flex",alignItems:"center",gap:"4px"})});function Na(e){const{data:t,createFocusSpanLink:n,openedItems:a,onItemToggle:r,interactive:o}=e,l=(0,x.of)(Ls);return(0,s.jsx)("div",{className:l.AccordianReferencesContent,children:t.map((c,u)=>(0,s.jsxs)("div",{className:u<t.length-1?l.AccordianReferenceItem:void 0,children:[(0,s.jsx)("div",{className:l.item,children:(0,s.jsx)(ja,{reference:c,createFocusSpanLink:n,children:(0,s.jsxs)("span",{className:l.itemContent,children:[c.span?(0,s.jsxs)("span",{children:[(0,s.jsx)("span",{className:(0,i.cx)("span-svc-name",l.serviceName),children:c.span.process.serviceName}),(0,s.jsx)("small",{className:"endpoint-name",children:c.span.operationName})]}):(0,s.jsxs)("span",{className:(0,i.cx)("span-svc-name",l.title),children:[(0,s.jsx)(g.x6,{i18nKey:"explore.accordian-references.view-linked-span",children:"View Linked Span"})," ",(0,s.jsx)(oe.I,{name:"external-link-alt"})]}),(0,s.jsxs)("small",{className:l.debugInfo,children:[(0,s.jsx)("span",{className:l.debugLabel,"data-label":"TraceID:",children:c.traceID}),(0,s.jsx)("span",{className:l.debugLabel,"data-label":"SpanID:",children:c.spanID})]})]})})},`${c.spanID}`),!!c.tags?.length&&(0,s.jsx)("div",{className:l.AccordianKeyValues,children:(0,s.jsx)(nt,{className:u<t.length-1?l.AccordianKeyValuesItem:null,data:c.tags||[],highContrast:!0,interactive:o,isOpen:a?a.has(c):!1,label:(0,g.t)("explore.references.label-attributes","attributes"),onToggle:o&&r?()=>r(c):null})})]},u))})}const Ma=({data:e,interactive:t=!0,isOpen:n,onToggle:a,onItemToggle:r,openedItems:o,createFocusSpanLink:l})=>{const c=!Array.isArray(e)||!e.length;let u=null,p="span",f=null;t&&(u=n?(0,s.jsx)(oe.I,{name:"angle-down",className:yt}):(0,s.jsx)(oe.I,{name:"angle-right",className:yt}),p="a",f={"aria-checked":n,onClick:c?null:a,role:"switch"});const m=(0,x.of)(Ls);return(0,s.jsxs)("div",{className:m.AccordianReferences,children:[(0,s.jsxs)(p,{className:m.AccordianReferencesHeader,...f,children:[u,(0,s.jsx)("strong",{children:(0,s.jsx)("span",{children:(0,s.jsx)(g.x6,{i18nKey:"explore.accordian-references.references",children:"References"})})})," ",(0,s.jsx)(Mt.p,{value:e.length})]}),n&&(0,s.jsx)(Na,{data:e,openedItems:o,createFocusSpanLink:l,onItemToggle:r,interactive:t})]})},Aa=h.memo(Ma);function Fa(e){const{focusSpanLink:t}=e;return(0,s.jsx)("span",{children:(0,s.jsx)("a",{"data-testid":"share-span-button",...t,onClick:n=>{t.onClick&&n.button===0&&(!n.currentTarget.target||n.currentTarget.target==="_self")&&!(n.metaKey||n.altKey||n.ctrlKey||n.shiftKey)&&(n.preventDefault(),t.onClick(n))},children:(0,s.jsx)(ce.$n,{variant:"secondary",size:"sm",icon:"share-alt",fill:"outline",children:(0,s.jsx)(g.x6,{i18nKey:"explore.span-detail.share-span",children:"Share"})})})})}var Oa=d(36490),_a=d(5753),Va=d(2733);const Es=[xe.Metrics,xe.Logs,xe.Profiles,xe.ProfilesDrilldown,xe.Session],Ba=3,Pa=/^https?:\/\//i,Ha=e=>{const{span:t,createSpanLink:n,traceToProfilesOptions:a,timeRange:r,datasourceType:o,app:l}=e;let c;if(n){const u=(n(t)||[]).filter(p=>p.type!==xe.Traces).map(p=>p.type===xe.Logs?dt(p,xe.Logs,"Logs for this span","gf-logs",o):p.type===xe.Profiles&&p.title===Va.cd?(c=p,dt(p,xe.Profiles,"Profiles for this span","link",o)):p.type===xe.Session?dt(p,xe.Session,"Session for this span","frontend-observability",o):dt(p,xe.Unknown,p.title||"","link",o));if(c&&l===L.Jk.Explore){const p="grafana-pyroscope-app",f=Wa(t,a,r),m=Y.SM.TraceViewDetails,{links:y}=(0,we.U)({extensionPointId:m,context:f,limitPerPlugin:1}),C=y&&y.length>0?y.find(N=>N.pluginId===p):null,A="Open in Profiles Drilldown",T={...c,href:"",onClick:()=>{C?.onClick?.()}};u.push(dt(T,xe.ProfilesDrilldown,A,"link",o))}return u.sort((p,f)=>{const m=Es.indexOf(p.type),y=Es.indexOf(f.type),C=m===-1?Number.MAX_SAFE_INTEGER:m,A=y===-1?Number.MAX_SAFE_INTEGER:y;return C-A}),u.length>Ba?(0,s.jsx)($a,{links:u}):(0,s.jsx)(s.Fragment,{children:u.map(({linkModel:p,icon:f,className:m},y)=>(0,s.jsx)(_a.R,{link:p,buttonProps:{icon:f,className:m}},y))})}return(0,s.jsx)(s.Fragment,{})},$a=({links:e})=>{const[t,n]=h.useState(!1),a=(0,s.jsx)(De.W,{children:e.map(({linkModel:r},o)=>(0,s.jsx)(De.W.Item,{label:r.title,onClick:l=>r.onClick?.(l)},o))});return(0,s.jsx)(et.m,{overlay:a,placement:"bottom-start",onVisibleChange:n,children:(0,s.jsx)(vs.I,{variant:"primary",icon:"link",isOpen:t,"aria-label":(0,g.t)("explore.drop-down-menu.aria-label-links","Links"),children:(0,s.jsx)(g.x6,{i18nKey:"explore.drop-down-menu.links",children:"Links"})})})},Wa=(e,t,n)=>{const a=e.tags.filter(o=>o.key===vt);return{serviceName:e.process.serviceName??"",profileTypeId:t?.profileTypeId??"",spanSelector:a.length===1&&a[0].value?a[0].value:"",explorationType:"flame-graph",timeRange:{from:n.from.toISOString(),to:n.to.toISOString()},datasource:{uid:t?.datasourceUid}}},dt=(e,t,n,a,r,o)=>({icon:a,className:o,type:t,linkModel:{...e,title:n,target:"_blank",origin:e.field,onClick:l=>{(0,ae.rR)("grafana_traces_trace_view_span_link_clicked",{datasourceType:r,grafana_version:Pe.$.buildInfo.version,type:t,location:"spanDetails"}),e.onClick?e.onClick?.(l):Pa.test(e.href)?window.open(e.href,"_blank","noopener,noreferrer"):Oa.Ny.push(e.href)}}});var Ka=d(49185),za=d(75505),Ua=d(94814),Ga=d(36580);function Za(e){const{span:t,traceToProfilesOptions:n,timeZone:a,traceFlameGraphs:r,setTraceFlameGraphs:o,setRedrawListView:l,traceDuration:c,traceName:u}=e,[p,{height:f}]=(0,Ka.A)(),m=(0,x.of)(Xa),y=t.tags.filter(F=>F.key===vt),C=y.length>0?y[0].value:void 0,A=(0,h.useCallback)(()=>{const F=Math.floor(t.startTime/1e3)-3e4,G=(t.startTime+t.duration)/1e3+3e4,Z=(0,xt.KQ)(G),O=(0,xt.KQ)(F);return{from:O,to:Z,raw:{from:O,to:Z}}},[t.duration,t.startTime]),T=async(F,G)=>{const Z=await(0,w.tR)().get(G);if(Z instanceof Ga.iy){const ee=(await(0,za.s)(Z.query(F))).data.find(ie=>ie.name==="response");if(ee&&ee.length>1)return ee}},N=(0,h.useCallback)(async(F,G,Z)=>{let O="{}";if(G.customQuery&&G.query){const ue={...Rs(c,u,Z.traceID),...Ft(Z),...ks(Z,G)};O=(0,X.w)().replace(G.query,ue)}else{const ue=G.tags&&G.tags.length>0?G.tags:Ds;O=`{${Ke(Z,ue)}}`}const ee={requestId:"span-flamegraph-requestId",interval:"2s",intervalMs:2e3,range:A(),scopedVars:{},app:L.Jk.Unknown,timezone:a,startTime:Z.startTime,targets:[{labelSelector:O,groupBy:[],profileTypeId:G.profileTypeId??"",queryType:"profile",spanSelector:[C],refId:"span-flamegraph-refId",datasource:{type:F.type,uid:F.uid}}]},ie=await T(ee,F.uid);ie&&ie.length>0&&o({...r,[C]:ie})},[A,C,o,a,c,r,u]);return(0,h.useEffect)(()=>{if(!Object.keys(r).includes(C)){let F;n&&n?.datasourceUid&&(F=(0,w.tR)().getInstanceSettings(n.datasourceUid)),n&&F&&N(F,n,t)}},[o,t,r,n,A,a,N,C]),(0,h.useEffect)(()=>{l({})},[f,l]),r[C]?(0,s.jsxs)("div",{className:m.flameGraph,ref:p,children:[(0,s.jsx)("div",{className:m.flameGraphTitle,children:(0,s.jsx)(g.x6,{i18nKey:"explore.span-flame-graph.flame-graph",children:"Flame graph"})}),(0,s.jsx)(Ua.Ay,{data:r[C],getTheme:()=>Pe.$.theme2,showFlameGraphOnly:!0,disableCollapsing:!0})]}):(0,s.jsx)(s.Fragment,{})}const Xa=()=>({flameGraph:(0,i.css)({label:"flameGraphInSpan",margin:"5px"}),flameGraphTitle:(0,i.css)({label:"flameGraphTitleInSpan",marginBottom:"5px",fontWeight:"bold"})}),Qa=(e,t,n,a)=>{const r=(0,h.useMemo)(()=>{const c=(e.tags??[]).reduce((p,f)=>(p[f.key]?p[f.key].push(f.value):p[f.key]=[f.value],p),{}),u=(t??[]).reduce((p,f)=>(p[f.key]?p[f.key].push(f.value):p[f.key]=[f.value],p),{});return{attributes:c,spanAttributes:u,datasource:{type:n,uid:a}}},[e.tags,t,n,a]),{links:o}=(0,we.U)({extensionPointId:Y.SM.TraceViewResourceAttributes,limitPerPlugin:10,context:r});return(0,h.useCallback)((c,u)=>{const{key:p}=c[u]??{};return o.filter(f=>f.category===p)},[o])},Ya=e=>({header:(0,i.css)({display:"flex",alignItems:"flex-start",justifyContent:"space-between",gap:"0 1rem",marginBottom:"0.25rem"}),content:(0,i.css)({fontSize:e.typography.bodySmall.fontSize}),listWrapper:(0,i.css)({overflow:"hidden",flexGrow:1,display:"flex",justifyContent:"flex-end"}),list:(0,i.css)({textAlign:"left"}),operationName:(0,i.css)({margin:0,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",maxWidth:"50%",flexGrow:0,flexShrink:0}),AccordianWarnings:(0,i.css)({label:"AccordianWarnings",background:(0,j.R)(e,"#fafafa"),border:`1px solid ${(0,j.R)(e,"#e4e4e4")}`,marginBottom:"0.25rem"}),AccordianWarningsHeader:(0,i.css)({label:"AccordianWarningsHeader",background:(0,j.R)(e,"#fff7e6"),padding:"0.25rem 0.5rem","&:hover":{background:(0,j.R)(e,"#ffe7ba")}}),AccordianWarningsHeaderOpen:(0,i.css)({label:"AccordianWarningsHeaderOpen",borderBottom:`1px solid ${(0,j.R)(e,"#e8e8e8")}`}),AccordianWarningsLabel:(0,i.css)({label:"AccordianWarningsLabel",color:(0,j.R)(e,"#d36c08")}),Textarea:(0,i.css)({wordBreak:"break-all",whiteSpace:"pre"}),linkList:(0,i.css)({display:"flex",flexWrap:"wrap",gap:"10px",marginBottom:e.spacing(2)})}),yt=(0,i.css)({margin:"-0.2rem 0.25rem 0 0"});function Ja(e){const{color:t,detailState:n,logItemToggle:a,logsToggle:r,processToggle:o,span:l,tagsToggle:c,traceStartTime:u,traceDuration:p,traceName:f,warningsToggle:m,stackTracesToggle:y,referencesToggle:C,referenceItemToggle:A,createSpanLink:T,createFocusSpanLink:N,datasourceType:F,datasourceUid:G,traceFlameGraphs:Z,setTraceFlameGraphs:O,traceToProfilesOptions:ee,setRedrawListView:ie,timeRange:ue,app:he}=e,{isTagsOpen:se,isProcessOpen:Se,logs:Re,isWarningsOpen:Le,references:Q,isStackTracesOpen:Ee}=n,{operationName:Ce,process:ve,duration:fe,relativeStartTime:Me,startTime:Oe,traceID:re,spanID:ye,logs:Ne,tags:Ve,warnings:Ie,references:_e,stackTraces:ge}=l,{timeZone:ze}=e;let Ue=[{key:"svc",label:(0,g.t)("explore.span-detail.overview-items.label.service","Service:"),value:ve.serviceName},{key:"duration",label:(0,g.t)("explore.span-detail.overview-items.label.duration","Duration:"),value:Je(fe),icon:"hourglass"},{key:"start",label:(0,g.t)("explore.span-detail.overview-items.label.start-time","Start Time:"),value:Je(Me)+qa(Oe,ze),icon:"clock-nine"},...l.childSpanCount>0?[{key:"child_count",label:(0,g.t)("explore.span-detail.overview-items.label.child-count","Child Count:"),value:l.childSpanCount}]:[]];const Ye=(0,x.of)(Ya);l.kind&&Ue.push({key:st.Nd,label:(0,g.t)("explore.span-detail.label.kind","Kind:"),value:l.kind}),l.statusCode!==void 0&&Ue.push({key:st.XQ,label:(0,g.t)("explore.span-detail.label.status","Status:"),value:va.s[l.statusCode].toLowerCase()}),l.statusMessage&&Ue.push({key:st.x9,label:(0,g.t)("explore.span-detail.label.status-message","Status Message:"),value:l.statusMessage}),l.instrumentationLibraryName&&Ue.push({key:st.mT,label:(0,g.t)("explore.span-detail.label.library-name","Library Name:"),value:l.instrumentationLibraryName}),l.instrumentationLibraryVersion&&Ue.push({key:st.Zh,label:(0,g.t)("explore.span-detail.label.library-version","Library Version:"),value:l.instrumentationLibraryVersion}),l.traceState&&Ue.push({key:st.gz,label:(0,g.t)("explore.span-detail.label.trace-state","Trace State:"),value:l.traceState});const Bt=Ha({span:l,createSpanLink:T,datasourceType:F,traceToProfilesOptions:ee,timeRange:ue,app:he}),Pt=N(re,ye),ot=Qa(ve,Ve,F,G);return(0,s.jsxs)("div",{"data-testid":"span-detail-component",children:[(0,s.jsxs)("div",{className:Ye.header,children:[(0,s.jsx)("h6",{className:Ye.operationName,title:Ce,children:Ce}),(0,s.jsx)("div",{className:Ye.listWrapper,children:(0,s.jsx)(Ea,{className:Ye.list,divider:!1,items:Ue,color:t})}),(0,s.jsx)(Fa,{focusSpanLink:Pt})]}),(0,s.jsx)("div",{className:Ye.linkList,children:Bt}),(0,s.jsxs)("div",{className:Ye.content,children:[(0,s.jsxs)("div",{children:[(0,s.jsx)(nt,{data:Ve,label:(0,g.t)("explore.span-detail.label-span-attributes","Span attributes"),isOpen:se,linksGetter:ot,onToggle:()=>c(ye)}),ve.tags&&(0,s.jsx)(nt,{data:ve.tags,label:(0,g.t)("explore.span-detail.label-resource-attributes","Resource attributes"),linksGetter:ot,isOpen:Se,onToggle:()=>o(ye)})]}),Ne&&Ne.length>0&&(0,s.jsx)(Ns,{logs:Ne,isOpen:Re.isOpen,openedItems:Re.openedItems,onToggle:()=>r(ye),onItemToggle:Be=>a(ye,Be),timestamp:u}),Ie&&Ie.length>0&&(0,s.jsx)(nt,{data:Ie.map(Be=>({key:"",value:Be,type:"text"})),showSummary:!1,showCountBadge:!0,isOpen:Le,onlyValues:!0,onToggle:()=>m(ye),label:(0,g.t)("explore.span-detail.warnings","Warnings")}),ge?.length?(0,s.jsx)(nt,{data:ge.map(Be=>({key:"",value:Be,type:"code"})),onlyValues:!0,showSummary:!1,showCountBadge:!0,isOpen:Ee,onToggle:()=>y(ye),label:(0,g.t)("explore.span-detail.label-stack-trace","Stack trace")}):null,_e&&_e.length>0&&(_e.length>1||_e[0].refType!=="CHILD_OF")&&(0,s.jsx)(Aa,{data:_e,isOpen:Q.isOpen,openedItems:Q.openedItems,onToggle:()=>C(ye),onItemToggle:Be=>A(ye,Be),createFocusSpanLink:N}),l.tags.some(Be=>Be.key===vt)&&(0,s.jsx)(Za,{span:l,timeZone:ze,traceFlameGraphs:Z,setTraceFlameGraphs:O,traceToProfilesOptions:ee,setRedrawListView:ie,traceDuration:p,traceName:f})]})]})}const qa=(e,t)=>{const n=(0,le.LE)(e/1e3,{timeZone:t,defaultWithMS:!0}),a=n.split(" ");return` (${a[1]?a[1]:n})`},js=e=>({container:(0,i.css)({textOverflow:"ellipsis"}),header:(0,i.css)({label:"header",cursor:"pointer",overflow:"hidden",padding:"0.25em 0.1em",textOverflow:"ellipsis",whiteSpace:"nowrap","&:hover":{background:(0,j.R)(e,"#e8e8e8")}}),headerLabel:(0,i.css)({width:"120px",display:"inline-block"}),headerEmpty:(0,i.css)({label:"headerEmpty",background:"none",cursor:"initial"}),headerHighContrast:(0,i.css)({label:"headerHighContrast","&:hover":{background:(0,j.R)(e,"#ddd")}}),emptyIcon:(0,i.css)({label:"emptyIcon",color:(0,j.R)(e,"#aaa")}),summary:(0,i.css)({label:"summary",display:"inline",listStyle:"none",padding:0}),summaryItem:(0,i.css)({label:"summaryItem",display:"inline",paddingRight:"0.5rem","&:last-child":{paddingRight:0,borderRight:"none"}}),summaryLabel:(0,i.css)({label:"summaryLabel",color:(0,j.R)(e,"#777"),paddingRight:"0.5rem"})});function er({data:e=null}){const t=(0,x.of)(js);return!Array.isArray(e)||!e.length?null:(0,s.jsx)("ul",{className:t.summary,children:e.map((n,a)=>(0,s.jsxs)("li",{className:t.summaryItem,children:[(0,s.jsx)("span",{className:t.summaryLabel,children:n.key}),String(n.value)]},`${n.key}-${a}`))})}function nt({className:e=null,data:t,logName:n,highContrast:a=!1,interactive:r=!0,isOpen:o,label:l,linksGetter:c,onlyValues:u=!1,showSummary:p=!0,showCountBadge:f=!1,onToggle:m=null}){const y=(!Array.isArray(t)||!t.length)&&!n,C=(0,x.of)(js),A=de()(yt,{[C.emptyIcon]:y});let T=null,N=null;const F=n?[{key:"event name",value:n},...t]:t;r&&(T=o?(0,s.jsx)(oe.I,{name:"angle-down",className:A}):(0,s.jsx)(oe.I,{name:"angle-right",className:A}),N={"aria-checked":o,onClick:y?null:m,role:"switch"});const G=p&&t.length>0&&!o;return(0,s.jsxs)("div",{className:de()(e,C.container),children:[(0,s.jsxs)("div",{className:de()(C.header,{[C.headerEmpty]:y,[C.headerHighContrast]:a&&!y}),...N,"data-testid":"AccordianKeyValues--header",children:[T,(0,s.jsxs)("strong",{"data-test":ma,className:C.headerLabel,children:[l,f?(0,s.jsx)(Mt.p,{value:t.length,variant:"secondary"}):null]}),G&&(0,s.jsx)("span",{className:(0,i.css)({marginLeft:"0.7em"}),children:(0,s.jsx)(er,{data:t})})]}),o&&(0,s.jsx)(xa.Ay,{data:F,linksGetter:c,onlyValues:u})]})}const tr=e=>({AccordianLogs:(0,i.css)({label:"AccordianLogs",position:"relative"}),AccordianLogsHeader:(0,i.css)({label:"AccordianLogsHeader",color:"inherit",display:"flex",alignItems:"center","&:hover":{background:(0,j.R)(e,"#e8e8e8")}}),AccordianLogsContent:(0,i.css)({label:"AccordianLogsContent",background:(0,j.R)(e,"#f0f0f0"),padding:"0.5rem 0.5rem 0.25rem 0.5rem"}),AccordianLogsFooter:(0,i.css)({label:"AccordianLogsFooter",color:(0,j.R)(e,"#999")}),AccordianKeyValuesItem:(0,i.css)({marginBottom:e.spacing(.5)}),parenthesis:(0,i.css)({color:`${(0,j.R)(e,"#777")}`})});function Ns({interactive:e=!0,isOpen:t,logs:n,openedItems:a,onItemToggle:r,onToggle:o,timestamp:l}){let c=null,u="span",p=null;e&&(c=t?(0,s.jsx)(oe.I,{name:"angle-down",className:yt}):(0,s.jsx)(oe.I,{name:"angle-right",className:"u-align-icon",style:{margin:"0 0.25rem 0 0"}}),u="a",p={"aria-checked":t,onClick:o,role:"switch"});const f=(0,x.of)(tr);return(0,s.jsxs)("div",{className:f.AccordianLogs,children:[(0,s.jsxs)(u,{className:f.AccordianLogsHeader,...p,children:[c," ",(0,s.jsx)("strong",{children:(0,s.jsx)(g.x6,{i18nKey:"explore.accordian-logs.events",children:"Events"})})," ",(0,s.jsx)(Mt.p,{value:n.length,variant:"secondary"})]}),t&&(0,s.jsxs)("div",{className:f.AccordianLogsContent,children:[(0,ke.sortBy)(n,"timestamp").map((m,y)=>{const C=Je(m.timestamp-l),A=m.name&&m.name.length>20,T=m.name&&A?m.name.slice(0,20)+"...":m.name,N=T?(0,s.jsxs)("span",{children:[C," ",(0,s.jsxs)("span",{children:["(",T,")"]})]}):C;return(0,s.jsx)(nt,{className:y<n.length-1?f.AccordianKeyValuesItem:null,data:m.fields||[],logName:A?m.name:void 0,highContrast:!0,interactive:e,isOpen:a?a.has(m):!1,label:N,onToggle:e&&r?()=>r(m):null},`${m.timestamp}-${y}`)}),(0,s.jsx)("small",{className:f.AccordianLogsFooter,children:(0,s.jsx)(g.x6,{i18nKey:"explore.accordian-logs.footer",children:"Event timestamps are relative to the start time of the full trace."})})]})]})}const sr=e=>({wrapper:(0,i.css)({label:"wrapper",bottom:0,left:0,position:"absolute",right:0,top:0,overflow:"hidden",zIndex:0}),bar:(0,i.css)({label:"bar",borderRadius:e.shape.radius.default,minWidth:"2px",position:"absolute",height:"36%",top:"32%"}),rpc:(0,i.css)({label:"rpc",position:"absolute",top:"35%",bottom:"35%",zIndex:1}),label:(0,i.css)({label:"label",color:"#aaa",fontSize:"12px",fontFamily:"'Helvetica Neue', Helvetica, Arial, sans - serif",lineHeight:"1em",whiteSpace:"nowrap",padding:"0 0.5em",position:"absolute"}),logMarker:(0,i.css)({label:"logMarker",backgroundColor:(0,j.R)(e,"#2c3235"),cursor:"pointer",height:"60%",minWidth:"1px",position:"absolute",top:"20%","&:hover":{backgroundColor:(0,j.R)(e,"#464c54")},"&::before, &::after":{content:"''",position:"absolute",top:0,bottom:0,right:0,border:"1px solid transparent"},"&::after":{left:0}}),criticalPath:(0,i.css)({position:"absolute",top:"45%",height:"11%",zIndex:2,overflow:"hidden",background:(0,j.R)(e,"#f1f1f1"),borderLeft:`1px solid ${(0,j.R)(e,"#2c3235")}`,borderRight:`1px solid ${(0,j.R)(e,"#2c3235")}`})});function ut(e){return`${(e*100).toFixed(1)}%`}function Ms(e){return`${e*100}%`}function nr({criticalPath:e,viewEnd:t,viewStart:n,getViewedBounds:a,color:r,shortLabel:o,longLabel:l,onClick:c,rpc:u,traceStartTime:p,span:f,className:m,labelClassName:y}){const[C,A]=(0,h.useState)(o),T=()=>A(o),N=()=>A(l),F=(0,ke.groupBy)(f.logs,Z=>{const O=a(Z.timestamp,Z.timestamp).start;return ut(Math.round(O*500)/500)}),G=(0,x.of)(sr);return(0,s.jsxs)("div",{className:de()(G.wrapper,m),onBlur:T,onClick:c,onFocus:N,onMouseOut:T,onMouseOver:N,"aria-hidden":!0,"data-testid":pa.Tp.components.TraceViewer.spanBar,children:[(0,s.jsx)("div",{"aria-label":C,className:de()(G.bar),style:{background:r,left:ut(n),width:ut(t-n)},children:(0,s.jsx)("div",{className:de()(G.label,y),"data-testid":"SpanBar--label",children:C})}),(0,s.jsx)("div",{children:Object.keys(F).map(Z=>(0,s.jsx)(fa,{content:(0,s.jsx)(Ns,{interactive:!1,isOpen:!0,logs:F[Z],timestamp:p}),children:(0,s.jsx)("div",{"data-testid":"SpanBar--logMarker",className:de()(G.logMarker),style:{left:Z}})},Z))}),u&&(0,s.jsx)("div",{className:de()(G.rpc),style:{background:u.color,left:ut(u.viewStart),width:ut(u.viewEnd-u.viewStart)}}),e?.map((Z,O)=>{const ee=a(Z.section_start,Z.section_end),ie=ee.start,ue=ee.end,he=`${Z.spanId}-${O}`;return(0,s.jsx)(Ae.m,{placement:"top",content:(0,s.jsx)("div",{children:(0,s.jsxs)(g.x6,{i18nKey:"explore.span-bar.tooltip-critical-path",children:["A segment on the ",(0,s.jsx)("em",{children:"critical path"})," of the overall trace / request / workflow."]})}),children:(0,s.jsx)("div",{"data-testid":"SpanBar--criticalPath",className:G.criticalPath,style:{left:Ms(ie),width:Ms(ue-ie)}})},he)})]})}const ar=h.memo(nr);var rr=d(94535),ir=d(97375);const or=(e,t,n,a)=>(e.sort(function(r,o){return(r.title||"link").toLowerCase().localeCompare((o.title||"link").toLowerCase())}),e.map((r,o)=>(0,s.jsx)(rr.D,{label:r.title||"Link",onClick:r.onClick?l=>{(0,ae.rR)("grafana_traces_trace_view_span_link_clicked",{datasourceType:a,grafana_version:Pe.$.buildInfo.version,type:r.type,location:"menu"}),l?.preventDefault(),r.onClick(l),n()}:void 0,url:r.href,target:r.target,className:t.menuItem},o))),lr=({links:e,datasourceType:t,color:n})=>{const a=(0,x.of)(()=>cr(n)),[r,o]=(0,h.useState)(!1),[l,c]=(0,h.useState)({x:0,y:0}),u=()=>o(!1);return(0,s.jsxs)("div",{"data-testid":"SpanLinksMenu",className:a.wrapper,children:[(0,s.jsx)("button",{onClick:p=>{o(!0),c({x:p.clientX,y:p.clientY})},className:a.button,children:(0,s.jsx)(oe.I,{name:"link",className:a.icon})}),r?(0,s.jsx)(ir.t,{onClose:()=>o(!1),renderMenuItems:()=>or(e,a,u,t),focusOnOpen:!1,x:l.x,y:l.y}):null]})},cr=e=>({wrapper:(0,i.css)({border:"none",background:`${e}10`,borderBottom:`1px solid ${e}CF`,paddingRight:"4px"}),button:(0,i.css)({background:"transparent",border:"none",padding:0}),icon:(0,i.css)({background:"transparent",border:"none",padding:0}),menuItem:(0,i.css)({maxWidth:"60ch",overflow:"hidden"})});function As(e){return(0,ke.get)((0,ke.find)(e.references,({span:t,refType:n})=>t&&t.spanID&&(n==="CHILD_OF"||n==="FOLLOWS_FROM")),"span")}function dr(e){const t=[];if(!e)return t;let n=As(e);for(;n;)t.push(n.spanID),n=As(n);return t}const ur=(0,Xe.N)(e=>({SpanTreeOffset:(0,i.css)({label:"SpanTreeOffset",color:(0,j.R)(e,"#000"),position:"relative"}),SpanTreeOffsetParent:(0,i.css)({label:"SpanTreeOffsetParent","&:hover":{cursor:"pointer"}}),indentGuide:(0,i.css)({label:"indentGuide",paddingRight:"1rem",height:"100%",display:"inline-flex",[e.transitions.handleMotion("no-preference")]:{transition:"padding 300ms ease-out"},"&::before":{content:'""',paddingLeft:"1px",backgroundColor:(0,j.R)(e,"lightgrey")}}),indentGuideActive:(0,i.css)({label:"indentGuideActive","&::before":{backgroundColor:(0,j.R)(e,"#777")}}),indentGuideThin:(0,i.css)({paddingRight:"0.3rem"}),iconWrapper:(0,i.css)({label:"iconWrapper",position:"absolute",right:0})}));class pr extends h.PureComponent{constructor(t){super(t),this.handleMouseLeave=(n,a)=>{(!(n.relatedTarget instanceof HTMLSpanElement)||(0,ke.get)(n,"relatedTarget.dataset.ancestorId")!==a)&&this.props.removeHoverIndentGuideId(a)},this.handleMouseEnter=(n,a)=>{(!(n.relatedTarget instanceof HTMLSpanElement)||(0,ke.get)(n,"relatedTarget.dataset.ancestorId")!==a)&&this.props.addHoverIndentGuideId(a)},this.ancestorIds=dr(t.span),this.ancestorIds.push("root"),this.ancestorIds.reverse()}static{this.displayName="UnthemedSpanTreeOffset"}static{this.defaultProps={childrenVisible:!1,showChildrenIcon:!0}}render(){const{childrenVisible:t,onClick:n,showChildrenIcon:a,span:r,theme:o,visibleSpanIds:l}=this.props,{hasChildren:c,spanID:u}=r,p=c?{onClick:n,role:"switch","aria-checked":t}:null,f=a&&c&&(t?(0,s.jsx)(oe.I,{name:"angle-down","data-testid":"icon-arrow-down",size:"sm"}):(0,s.jsx)(oe.I,{name:"angle-right","data-testid":"icon-arrow-right",size:"sm"})),m=ur(o);return(0,s.jsxs)("span",{className:de()(m.SpanTreeOffset,{[m.SpanTreeOffsetParent]:c}),...p,children:[this.ancestorIds.map((y,C)=>(0,s.jsx)("span",{className:de()(m.indentGuide,{[m.indentGuideActive]:this.props.hoverIndentGuideIds.has(y),[m.indentGuideThin]:C!==this.ancestorIds.length-1&&y!=="root"&&!l.includes(y)}),"data-ancestor-id":y,"data-testid":"SpanTreeOffset--indentGuide",onMouseEnter:A=>this.handleMouseEnter(A,y),onMouseLeave:A=>this.handleMouseLeave(A,y)},y)),f&&(0,s.jsx)("span",{className:m.iconWrapper,onMouseEnter:y=>this.handleMouseEnter(y,u),onMouseLeave:y=>this.handleMouseLeave(y,u),"data-testid":"icon-wrapper",children:f})]})}}const Fs=(0,x.cV)(pr),bt="spanBar",St="spanBarLabel",at="nameWrapper",Os="nameWrapperMatchingFilter",qe="jaegerView",_s="nameColumn",hr=(0,Xe.N)((e,t)=>{const n={flash:(0,i.keyframes)`
    from {
      background-color: ${(0,j.R)(e,"#68b9ff")};
    }
    to {
      background-color: 'default';
    }
  `},a=t?"":(0,j.R)(e,"#fffce4");return{nameWrapper:(0,i.css)({label:"nameWrapper",lineHeight:"27px",overflow:"hidden",display:"flex"}),nameWrapperMatchingFilter:(0,i.css)({label:"nameWrapperMatchingFilter",backgroundColor:a}),nameColumn:(0,i.css)({label:"nameColumn",position:"relative",whiteSpace:"nowrap",zIndex:1,"&:hover":{zIndex:1}}),endpointName:(0,i.css)({label:"endpointName",color:(0,j.R)(e,"#484848"),fontSize:"0.9em"}),view:(0,i.css)({label:"view",position:"relative"}),viewExpanded:(0,i.css)({label:"viewExpanded",background:(0,j.R)(e,"#f8f8f8"),outline:`1px solid ${(0,j.R)(e,"#ddd")}`}),viewExpandedAndMatchingFilter:(0,i.css)({label:"viewExpandedAndMatchingFilter",background:(0,j.R)(e,"#fff3d7"),outline:`1px solid ${(0,j.R)(e,"#ddd")}`}),row:(0,i.css)({label:"row",fontSize:"0.9em",[`&:hover .${bt}`]:{opacity:1},[`&:hover .${St}`]:{color:(0,j.R)(e,"#000")},[`&:hover .${at}`]:{background:`linear-gradient(
          90deg,
          ${(0,j.R)(e,"#fafafa")},
          ${(0,j.R)(e,"#f8f8f8")} 75%,
          ${(0,j.R)(e,"#eee")}
        )`},[`&:hover .${qe}`]:{backgroundColor:(0,j.R)(e,"#f5f5f5"),outline:`1px solid ${(0,j.R)(e,"#ddd")}`}}),rowClippingLeft:(0,i.css)({label:"rowClippingLeft",[`& .${_s}::before`]:{content:'" "',height:"100%",position:"absolute",width:"6px",backgroundImage:`linear-gradient(
          to right,
          ${(0,j.R)(e,"rgba(25, 25, 25, 0.25)")},
          ${(0,j.R)(e,"rgba(32, 32, 32, 0)")}
        )`,left:"100%",zIndex:-1}}),rowClippingRight:(0,i.css)({label:"rowClippingRight",[`& .${qe}::before`]:{content:'" "',height:"100%",position:"absolute",width:"6px",backgroundImage:`linear-gradient(
          to left,
          ${(0,j.R)(e,"rgba(25, 25, 25, 0.25)")},
          ${(0,j.R)(e,"rgba(25, 25, 25, 0.25)")}
        )`,right:"0%",zIndex:1}}),rowExpanded:(0,i.css)({label:"rowExpanded",[`& .${bt}`]:{opacity:1},[`& .${St}`]:{color:(0,j.R)(e,"#000")},[`& .${at}, &:hover .${at}`]:{background:(0,j.R)(e,"#f0f0f0"),boxShadow:`0 1px 0 ${(0,j.R)(e,"#ddd")}`},[`& .${Os}`]:{background:(0,j.R)(e,"#fff3d7")},[`&:hover .${qe}`]:{background:(0,j.R)(e,"#eee")}}),rowMatchingFilter:(0,i.css)({label:"rowMatchingFilter",[`&:hover .${at}`]:{background:`linear-gradient(
          90deg,
          ${(0,j.R)(e,"#fffbde")},
          ${(0,j.R)(e,"#fffbde")} 75%,
          ${(0,j.R)(e,"#f7f1c6")}
        )`},[`&:hover .${qe}`]:{backgroundColor:(0,j.R)(e,"#f7f1c6"),outline:`1px solid ${(0,j.R)(e,"#ddd")}`}}),rowFocused:(0,i.css)({label:"rowFocused",backgroundColor:(0,j.R)(e,"#cbe7ff"),[e.transitions.handleMotion("no-preference","reduce")]:{animation:`${n.flash} 1s cubic-bezier(0.12, 0, 0.39, 0)`},[`& .${at}, .${qe}, .${Os}`]:{backgroundColor:(0,j.R)(e,"#cbe7ff"),animation:`${n.flash} 1s cubic-bezier(0.12, 0, 0.39, 0)`},[`& .${bt}`]:{opacity:1},[`& .${St}`]:{color:(0,j.R)(e,"#000")},"&:hover .${nameWrapperClassName}, :hover .${viewClassName}":{background:(0,j.R)(e,"#d5ebff"),boxShadow:`0 1px 0 ${(0,j.R)(e,"#ddd")}`}}),rowExpandedAndMatchingFilter:(0,i.css)({label:"rowExpandedAndMatchingFilter",[`&:hover .${qe}`]:{background:(0,j.R)(e,"#ffeccf")}}),name:(0,i.css)({label:"name",color:(0,j.R)(e,"#000"),cursor:"pointer",flex:"1 1 auto",outline:"none",overflowY:"hidden",overflowX:"auto",paddingLeft:"4px",paddingRight:"0.25em",position:"relative","-ms-overflow-style":"none",scrollbarWidth:"none","&::-webkit-scrollbar":{display:"none"},"&:focus":{textDecoration:"none"},"&:hover > span":{color:(0,j.R)(e,"#000")},textAlign:"left",background:"transparent",border:"none",borderBottomWidth:"1px",borderBottomStyle:"solid"}),nameDetailExpanded:(0,i.css)({label:"nameDetailExpanded","&::before":{bottom:0}}),svcName:(0,i.css)({label:"svcName",fontSize:"0.9em",fontWeight:"bold",marginRight:"0.25rem"}),svcNameChildrenCollapsed:(0,i.css)({label:"svcNameChildrenCollapsed",fontWeight:"bold",fontStyle:"italic"}),errorIcon:(0,i.css)({label:"errorIcon",borderRadius:"6.5px",color:(0,j.R)(e,"#fff"),fontSize:"0.85em",marginRight:"0.25rem",padding:"1px"}),rpcColorMarker:(0,i.css)({label:"rpcColorMarker",borderRadius:"6.5px",display:"inline-block",fontSize:"0.85em",height:"1em",marginRight:"0.25rem",padding:"1px",width:"1em",verticalAlign:"middle"}),labelRight:(0,i.css)({label:"labelRight",left:"100%"}),labelLeft:(0,i.css)({label:"labelLeft",right:"100%"})}});class gr extends h.PureComponent{constructor(){super(...arguments),this._detailToggle=()=>{this.props.onDetailToggled(this.props.span.spanID)},this._childrenToggle=()=>{this.props.onChildrenToggled(this.props.span.spanID)},this.getSpanBarLabel=(t,n,a)=>{const r=n?.type??"";if(r===bs)return"";if(r===""||r===Ss)return`(${a})`;if(r===Nt){const o=n?.tag?.trim()??"";if(o!==""&&t.tags){const l=t.tags?.find(u=>u.key===o);if(l)return`(${l.value})`;const c=t.process?.tags?.find(u=>u.key===o);if(c)return`(${c.value})`}}return""}}static{this.displayName="UnthemedSpanBarRow"}static{this.defaultProps={className:"",rpc:null}}render(){const{className:t,color:n,spanBarOptions:a,columnDivision:r,isChildrenExpanded:o,isDetailExpanded:l,isMatchingFilter:c,showSpanFilterMatchesOnly:u,isFocused:p,numTicks:f,rpc:m,noInstrumentedServer:y,showErrorIcon:C,getViewedBounds:A,traceStartTime:T,span:N,hoverIndentGuideIds:F,addHoverIndentGuideId:G,removeHoverIndentGuideId:Z,clippingLeft:O,clippingRight:ee,theme:ie,createSpanLink:ue,datasourceType:he,showServiceName:se,visibleSpanIds:Se,criticalPath:Re}=this.props,{duration:Le,hasChildren:Q,operationName:Ee,process:{serviceName:Ce}}=N,ve=Je(Le),fe=A(N.startTime,N.startTime+N.duration),Me=fe.start,Oe=fe.end,re=hr(ie,u),ye=`${Ce}::${Ee}`;let Ne,Ve;return Me>1-Oe?(Ne=`${ye} | ${ve}`,Ve=re.labelLeft):(Ne=`${ve} | ${ye}`,Ve=re.labelRight),(0,s.jsxs)(We,{className:de()(re.row,{[re.rowExpanded]:l,[re.rowMatchingFilter]:c,[re.rowExpandedAndMatchingFilter]:c&&l,[re.rowFocused]:p,[re.rowClippingLeft]:O,[re.rowClippingRight]:ee},t),children:[(0,s.jsx)(We.Cell,{className:de()(re.nameColumn,_s),width:r,children:(0,s.jsxs)("div",{className:de()(re.nameWrapper,at,{[re.nameWrapperMatchingFilter]:c,nameWrapperMatchingFilter:c}),children:[(0,s.jsx)(Fs,{onClick:Q?this._childrenToggle:void 0,childrenVisible:o,span:N,hoverIndentGuideIds:F,addHoverIndentGuideId:G,removeHoverIndentGuideId:Z,visibleSpanIds:Se}),(0,s.jsxs)("button",{type:"button",className:de()(re.name,{[re.nameDetailExpanded]:l}),"aria-checked":l,title:ye,onClick:this._detailToggle,role:"switch",style:{background:`${n}10`,borderBottomColor:`${n}CF`},tabIndex:0,children:[C&&(0,s.jsx)(oe.I,{name:"exclamation-circle",style:{backgroundColor:N.errorIconColor?(0,j.R)(ie,N.errorIconColor):(0,j.R)(ie,"#db2828")},className:re.errorIcon}),se&&(0,s.jsx)("span",{className:de()(re.svcName,{[re.svcNameChildrenCollapsed]:Q&&!o}),children:`${Ce} `}),m&&(0,s.jsxs)("span",{children:[(0,s.jsx)(oe.I,{name:"arrow-right"})," ",(0,s.jsx)("i",{className:re.rpcColorMarker,style:{background:m.color}}),m.serviceName]}),y&&(0,s.jsxs)("span",{children:[(0,s.jsx)(oe.I,{name:"arrow-right"})," ",(0,s.jsx)("i",{className:re.rpcColorMarker,style:{background:y.color}}),y.serviceName]}),(0,s.jsx)("span",{className:re.endpointName,children:m?m.operationName:Ee}),(0,s.jsxs)("span",{className:re.endpointName,children:[" ",this.getSpanBarLabel(N,a,ve)]})]}),ue&&(()=>{const Ie=ue(N),_e=Ie?.length||0;return Ie&&_e===1?Ie[0]?(0,s.jsx)("a",{href:Ie[0].href,target:"_blank",style:{background:`${n}10`,borderBottom:`1px solid ${n}CF`,paddingRight:"4px"},rel:"noopener noreferrer",onClick:Ie[0].onClick?ge=>{!(ge.ctrlKey||ge.metaKey||ge.shiftKey)&&Ie[0].onClick&&(ge.preventDefault(),Ie[0].onClick(ge))}:void 0,children:Ie[0].content}):null:Ie&&_e>1?(0,s.jsx)(lr,{links:Ie,datasourceType:he,color:n}):null})()]})}),(0,s.jsxs)(We.Cell,{className:de()(re.view,qe,{[re.viewExpanded]:l,[re.viewExpandedAndMatchingFilter]:c&&l}),"data-testid":"span-view",style:{cursor:"pointer"},width:1-r,onClick:this._detailToggle,children:[(0,s.jsx)(fs,{numTicks:f}),(0,s.jsx)(ar,{criticalPath:Re,rpc:m,viewStart:Me,viewEnd:Oe,getViewedBounds:A,color:n,shortLabel:ve,longLabel:Ne,traceStartTime:T,span:N,labelClassName:`${St} ${Ve}`,className:bt})]})]})}}const fr=(0,x.cV)(gr),mr=(0,Xe.N)(e=>({expandedAccent:(0,i.css)({cursor:"pointer",height:"100%",overflow:"hidden",position:"absolute",width:"100%","&::before":{borderLeft:"1px solid",pointerEvents:"none",width:"1000px"},"&::after":{borderRight:"1000px solid",borderColor:"inherit",cursor:"pointer",opacity:.2},"&::before, &::after":{borderColor:"inherit",content:'" "',position:"absolute",height:"100%"},"&:hover::after":{opacity:.35}}),infoWrapper:(0,i.css)({label:"infoWrapper",padding:"0.75rem"}),cell:(0,i.css)({label:"cell",display:"flex !important",width:"100% !important"}),indentSpacer:(0,i.css)({label:"indentSpacer",flex:"none"}),detailWrapper:(0,i.css)({label:"detailWrapper",flex:"1",minWidth:0})}));class xr extends h.PureComponent{constructor(){super(...arguments),this._detailToggle=()=>{this.props.onDetailToggled(this.props.span.spanID)}}render(){const{color:t,detailState:n,logItemToggle:a,logsToggle:r,processToggle:o,referenceItemToggle:l,referencesToggle:c,warningsToggle:u,stackTracesToggle:p,span:f,traceToProfilesOptions:m,timeZone:y,tagsToggle:C,traceStartTime:A,traceDuration:T,traceName:N,theme:F,createSpanLink:G,focusedSpanId:Z,createFocusSpanLink:O,datasourceType:ee,datasourceUid:ie,traceFlameGraphs:ue,setTraceFlameGraphs:he,setRedrawListView:se,timeRange:Se,app:Re,hoverIndentGuideIds:Le,addHoverIndentGuideId:Q,removeHoverIndentGuideId:Ee,visibleSpanIds:Ce}=this.props,ve=mr(F);return(0,s.jsx)(We,{children:(0,s.jsxs)(We.Cell,{width:1,className:ve.cell,children:[(0,s.jsx)("div",{className:ve.indentSpacer,children:(0,s.jsx)(Fs,{span:f,showChildrenIcon:!1,hoverIndentGuideIds:Le,addHoverIndentGuideId:Q,removeHoverIndentGuideId:Ee,visibleSpanIds:Ce})}),(0,s.jsx)("div",{className:ve.detailWrapper,children:(0,s.jsx)("div",{className:ve.infoWrapper,style:{borderTopColor:t},children:(0,s.jsx)(Ja,{color:t,detailState:n,logItemToggle:a,logsToggle:r,processToggle:o,referenceItemToggle:l,referencesToggle:c,warningsToggle:u,stackTracesToggle:p,span:f,traceToProfilesOptions:m,timeZone:y,tagsToggle:C,traceStartTime:A,traceDuration:T,traceName:N,createSpanLink:G,focusedSpanId:Z,createFocusSpanLink:O,datasourceType:ee,datasourceUid:ie,traceFlameGraphs:ue,setTraceFlameGraphs:he,setRedrawListView:se,timeRange:Se,app:Re})})})]})})}}const vr=(0,x.cV)(xr),Ot=(0,Xe.N)(()=>({rowsWrapper:(0,i.css)({width:"100%"}),row:(0,i.css)({width:"100%"}),scrollToTopButton:(0,i.css)({display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",width:"40px",height:"40px",position:"absolute",bottom:"30px",right:"30px",zIndex:1})})),_t={bar:28,detail:161,detailWithLogs:197},yr=5,It=33;function br(e,t,n,a,r,o,l){if(!e)return[];r&&a&&(e=e.filter(p=>a.has(p.spanID))),o&&l&&(e=e.filter(p=>l.find(f=>f.spanId===p.spanID)));let c=null;const u=[];for(let p=0;p<e.length;p++){const f=e[p],{spanID:m,depth:y}=f;let C=!1;c!=null&&(y>=c?C=!0:c=null),!C&&(t.has(m)&&(c=y+1),u.push({span:f,isDetail:!1,spanIndex:p}),n.has(m)&&u.push({span:f,isDetail:!0,spanIndex:p}))}return u}function Sr(e){const[t,n]=e;return{left:t>0,right:n<1}}function Ir(e,t,n,a,r,o,l){return e?br(e.spans,t,n,a,r,o,l):[]}function wr(e){const t=new Map;return e&&e.spans.forEach(n=>{n.childSpanIds.length&&t.set(n.spanID,n.childSpanIds)}),t}const Tr=(0,q.default)(Ir),Dr=(0,q.default)(_n,ke.isEqual),Cr=(0,q.default)(Sr,ke.isEqual),Rr=(0,q.default)(wr);class kr extends h.Component{constructor(){super(...arguments),this.hasScrolledToSpan=!1,this.getViewRange=()=>this.props.currentViewRangeTime,this.getSearchedSpanIDs=()=>this.props.findMatchesIDs,this.getCollapsedChildren=()=>this.props.childrenHiddenIDs,this.mapRowIndexToSpanIndex=t=>this.getRowStates()[t].spanIndex,this.mapSpanIndexToRowIndex=t=>{const n=this.getRowStates().length;for(let a=0;a<n;a++){const{spanIndex:r}=this.getRowStates()[a];if(r===t)return a}throw new Error(`unable to find row for span index: ${t}`)},this.setListView=t=>{this.listView=t},this.getKeyFromIndex=t=>{const{isDetail:n,span:a}=this.getRowStates()[t];return`${a.traceID}--${a.spanID}--${n?"detail":"bar"}`},this.getIndexFromKey=t=>{const n=t.split("--"),a=n[0],r=n[1],o=n[2]==="detail",l=this.getRowStates().length;for(let c=0;c<l;c++){const{span:u,isDetail:p}=this.getRowStates()[c];if(u.spanID===r&&u.traceID===a&&p===o)return c}return-1},this.getRowHeight=t=>{const{span:n,isDetail:a}=this.getRowStates()[t];return a?Array.isArray(n.logs)&&n.logs.length?_t.detailWithLogs:_t.detail:_t.bar},this.renderRow=(t,n,a,r)=>{const{isDetail:o,span:l,spanIndex:c}=this.getRowStates()[a],u=Math.max((this.listView?.getTopVisibleIndex()||0)-It,0),p=(this.listView?.getBottomVisibleIndex()||0)+It,f=this.getVisibleSpanIds(u,p);return o?this.renderSpanDetailRow(l,t,n,r,f):this.renderSpanBarRow(l,c,t,n,r,f)},this.scrollToSpan=(t,n)=>{if(n==null)return;const a=this.getRowStates().findIndex(r=>r.span.spanID===n);a>=0&&this.listView?.scrollToIndex(a,t)},this.scrollToTop=()=>{const{topOfViewRef:t,datasourceType:n,trace:a}=this.props;t?.current?.scrollIntoView({behavior:"smooth"}),(0,ae.rR)("grafana_traces_trace_view_scroll_to_top_clicked",{datasourceType:n,grafana_version:Pe.$.buildInfo.version,numServices:a.services.length,numSpans:a.spans.length})},this.getVisibleSpanIds=(0,q.default)((t,n)=>{const a=[];for(let r=t;r<n;r++){const o=this.getRowStates()[r];o?.span&&a.push(o.span.spanID)}return a})}componentDidMount(){this.scrollToSpan(this.props.headerHeight,this.props.focusedSpanId)}shouldComponentUpdate(t){let n;for(n in t)if(t[n]!==this.props[n])return!0;return!1}componentDidUpdate(t){const{headerHeight:n,focusedSpanId:a,focusedSpanIdForSearch:r}=this.props;this.hasScrolledToSpan||(this.scrollToSpan(n,a),this.hasScrolledToSpan=!0),a!==t.focusedSpanId&&this.scrollToSpan(n,a),r!==t.focusedSpanIdForSearch&&this.scrollToSpan(n,r)}getRowStates(){const{childrenHiddenIDs:t,detailStates:n,trace:a,findMatchesIDs:r,showSpanFilterMatchesOnly:o,showCriticalPathSpansOnly:l,criticalPath:c}=this.props;return Tr(a,t,n,r,o,l,c)}getClipping(){const{currentViewRangeTime:t}=this.props;return Cr(t)}getViewedBounds(){const{currentViewRangeTime:t,trace:n}=this.props,[a,r]=t;return Dr({min:n.startTime,max:n.endTime,viewStart:a,viewEnd:r})}getChildSpansMap(){return Rr(this.props.trace)}getAccessors(){const t=this.listView;if(!t)throw new Error("ListView unavailable");return{getViewRange:this.getViewRange,getSearchedSpanIDs:this.getSearchedSpanIDs,getCollapsedChildren:this.getCollapsedChildren,getViewHeight:t.getViewHeight,getBottomRowIndexVisible:t.getBottomVisibleIndex,getTopRowIndexVisible:t.getTopVisibleIndex,getRowPosition:t.getRowPosition,mapRowIndexToSpanIndex:this.mapRowIndexToSpanIndex,mapSpanIndexToRowIndex:this.mapSpanIndexToRowIndex}}renderSpanBarRow(t,n,a,r,o,l){const{spanID:c,childSpanIds:u}=t,{serviceName:p}=t.process,{childrenHiddenIDs:f,childrenToggle:m,detailStates:y,detailToggle:C,findMatchesIDs:A,spanNameColumnWidth:T,trace:N,spanBarOptions:F,hoverIndentGuideIds:G,addHoverIndentGuideId:Z,removeHoverIndentGuideId:O,createSpanLink:ee,focusedSpanId:ie,focusedSpanIdForSearch:ue,showSpanFilterMatchesOnly:he,theme:se,datasourceType:Se,criticalPath:Re}=this.props;if(!N)return null;const Le=gt(p,se),Q=f.has(c),Ee=y.has(c),Ce=A?A.has(c):!1,ve=c===ie||c===ue,fe=gs(t)||Q&&Gn(N.spans,n);let Me=null;if(Q){const ge=Zn(N.spans.slice(n));if(ge){const ze=this.getViewedBounds()(ge.startTime,ge.startTime+ge.duration);Me={color:gt(ge.process.serviceName,se),operationName:ge.operationName,serviceName:ge.process.serviceName,viewEnd:ze.end,viewStart:ze.start}}}const Oe=t.tags.find(ge=>ge.key===oa);let re=null;!t.hasChildren&&Oe&&Xn(t)&&(re={serviceName:Oe.value,color:gt(Oe.value,se)});const ye=n>0?N.spans[n-1]:null,Ne=[c,...u],Ve=ge=>{ge.forEach(ze=>{const it=this.getChildSpansMap().get(ze);it?.length&&(Ne.push(...it),Ve(it))})};Ve(u);const Ie=Re?.filter(ge=>Q?Ne.includes(ge.spanId):ge.spanId===c),_e=Ot();return(0,s.jsx)("div",{className:_e.row,style:r,...o,children:(0,s.jsx)(fr,{clippingLeft:this.getClipping().left,clippingRight:this.getClipping().right,color:Le,spanBarOptions:F,columnDivision:T,isChildrenExpanded:!Q,isDetailExpanded:Ee,isMatchingFilter:Ce,isFocused:ve,showSpanFilterMatchesOnly:he,numTicks:yr,onDetailToggled:C,onChildrenToggled:m,rpc:Me,noInstrumentedServer:re,showErrorIcon:fe,getViewedBounds:this.getViewedBounds(),traceStartTime:N.startTime,span:t,hoverIndentGuideIds:G,addHoverIndentGuideId:Z,removeHoverIndentGuideId:O,createSpanLink:ee,datasourceType:Se,showServiceName:ye===null||ye.process.serviceName!==t.process.serviceName,visibleSpanIds:l,criticalPath:Ie})},a)}renderSpanDetailRow(t,n,a,r,o){const{spanID:l}=t,{serviceName:c}=t.process,{detailLogItemToggle:u,detailLogsToggle:p,detailProcessToggle:f,detailReferencesToggle:m,detailReferenceItemToggle:y,detailWarningsToggle:C,detailStackTracesToggle:A,detailStates:T,detailTagsToggle:N,detailToggle:F,spanNameColumnWidth:G,trace:Z,traceToProfilesOptions:O,timeZone:ee,hoverIndentGuideIds:ie,addHoverIndentGuideId:ue,removeHoverIndentGuideId:he,createSpanLink:se,focusedSpanId:Se,createFocusSpanLink:Re,theme:Le,datasourceType:Q,datasourceUid:Ee,traceFlameGraphs:Ce,setTraceFlameGraphs:ve,setRedrawListView:fe,timeRange:Me,app:Oe}=this.props,re=T.get(l);if(!Z||!re)return null;const ye=gt(c,Le),Ne=Ot();return(0,s.jsx)("div",{className:(0,i.cx)(Ne.row,"span-detail-row"),style:{...a,zIndex:1},...r,children:(0,s.jsx)(vr,{color:ye,columnDivision:G,onDetailToggled:F,detailState:re,logItemToggle:u,logsToggle:p,processToggle:f,referenceItemToggle:y,referencesToggle:m,warningsToggle:C,stackTracesToggle:A,span:t,traceToProfilesOptions:O,timeZone:ee,tagsToggle:N,traceStartTime:Z.startTime,traceDuration:Z.duration,traceName:Z.traceName,hoverIndentGuideIds:ie,addHoverIndentGuideId:ue,removeHoverIndentGuideId:he,createSpanLink:se,focusedSpanId:Se,createFocusSpanLink:Re,datasourceType:Q,datasourceUid:Ee,visibleSpanIds:o,traceFlameGraphs:Ce,setTraceFlameGraphs:ve,setRedrawListView:fe,timeRange:Me,app:Oe})},n)}render(){const t=Ot(),{scrollElement:n,redrawListView:a}=this.props;return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(ca,{ref:this.setListView,dataLength:this.getRowStates().length,itemHeightGetter:this.getRowHeight,itemRenderer:this.renderRow,viewBuffer:It,viewBufferMin:It,itemsWrapperClassName:t.rowsWrapper,getKeyFromIndex:this.getKeyFromIndex,getIndexFromKey:this.getIndexFromKey,windowScroller:!1,scrollElement:n,redraw:a}),this.props.topOfViewRef&&(0,s.jsx)(vs.I,{className:t.scrollToTopButton,onClick:this.scrollToTop,title:(0,g.t)("explore.unthemed-virtualized-trace-view.title-scroll-to-top","Scroll to top"),icon:"arrow-up"})]})}}const Lr=(0,x.cV)(kr),Er=(0,Xe.N)(e=>({TraceTimelineViewer:(0,i.css)({label:"TraceTimelineViewer",borderBottom:`1px solid ${(0,j.R)(e,"#bbb")}`,"& .json-markup":{lineHeight:"17px",fontFamily:"monospace",whiteSpace:"pre-wrap"},"& .json-markup-key":{fontWeight:"bold"},"& .json-markup-bool":{color:(0,j.R)(e,"firebrick")},"& .json-markup-string":{color:(0,j.R)(e,"teal")},"& .json-markup-null":{color:(0,j.R)(e,"teal")},"& .json-markup-number":{color:(0,j.R)(e,"blue","black")}})})),jr=5;class Nr extends h.PureComponent{constructor(t){super(t),this.collapseAll=()=>{this.props.collapseAll(this.props.trace.spans),(0,ae.rR)("grafana_traces_traceID_expand_collapse_clicked",{datasourceType:this.props.datasourceType,grafana_version:Pe.$.buildInfo.version,type:"collapseAll"})},this.collapseOne=()=>{this.props.collapseOne(this.props.trace.spans),(0,ae.rR)("grafana_traces_traceID_expand_collapse_clicked",{datasourceType:this.props.datasourceType,grafana_version:Pe.$.buildInfo.version,type:"collapseOne"})},this.expandAll=()=>{this.props.expandAll(),(0,ae.rR)("grafana_traces_traceID_expand_collapse_clicked",{datasourceType:this.props.datasourceType,grafana_version:Pe.$.buildInfo.version,type:"expandAll"})},this.expandOne=()=>{this.props.expandOne(this.props.trace.spans),(0,ae.rR)("grafana_traces_traceID_expand_collapse_clicked",{datasourceType:this.props.datasourceType,grafana_version:Pe.$.buildInfo.version,type:"expandOne"})},this.state={height:0}}componentDidMount(){On({collapseAll:this.collapseAll,expandAll:this.expandAll,collapseOne:this.collapseOne,expandOne:this.expandOne})}render(){const{setSpanNameColumnWidth:t,updateNextViewRangeTime:n,updateViewRangeTime:a,viewRange:r,traceTimeline:o,theme:l,topOfViewRef:c,focusedSpanIdForSearch:u,...p}=this.props,{trace:f}=p,m=Er(l);return(0,s.jsxs)("div",{className:m.TraceTimelineViewer,ref:y=>y&&this.setState({height:y.getBoundingClientRect().height}),children:[(0,s.jsx)(ia,{duration:f.duration,nameColumnWidth:o.spanNameColumnWidth,numTicks:jr,onCollapseAll:this.collapseAll,onCollapseOne:this.collapseOne,onColummWidthChange:t,onExpandAll:this.expandAll,onExpandOne:this.expandOne,viewRangeTime:r.time,updateNextViewRangeTime:n,updateViewRangeTime:a,columnResizeHandleHeight:this.state.height}),(0,s.jsx)(Lr,{...p,...o,setSpanNameColumnWidth:t,currentViewRangeTime:r.time.current,topOfViewRef:c,focusedSpanIdForSearch:u,datasourceType:this.props.datasourceType,datasourceUid:this.props.datasourceUid})]})}}const Mr=(0,x.cV)(Nr);function Ar(){const[e,t]=(0,h.useState)(new Set),n=(0,h.useCallback)(function(u){if(e.size===0)return;let p=-1,f=!0;const m=u.reduce((y,C)=>(C.depth<=p&&(f=!0),f&&y.has(C.spanID)&&(y.delete(C.spanID),f=!1,p=C.depth),y),new Set(e));t(m)},[e]),a=(0,h.useCallback)(function(u){if(Vs(u,e))return;let p;const f=u.reduce((m,y)=>(p&&y.depth<=p.depth?(m.add(p.spanID),y.hasChildren&&(p=y)):y.hasChildren&&!m.has(y.spanID)&&(p=y),m),new Set(e));p&&f.add(p.spanID),t(f)},[e]),r=(0,h.useCallback)(function(){t(new Set)},[]),o=(0,h.useCallback)(function(u){if(Vs(u,e))return;const p=u.reduce((f,m)=>(m.hasChildren&&f.add(m.spanID),f),new Set);t(p)},[e]),l=(0,h.useCallback)(function(u){const p=new Set(e);e.has(u)?p.delete(u):p.add(u),t(p)},[e]);return{childrenHiddenIDs:e,expandOne:n,collapseOne:a,expandAll:r,collapseAll:o,childrenToggle:l}}function Vs(e,t){return e.filter(a=>a.hasChildren).length===t.size}class He{constructor(t){const{isTagsOpen:n,isProcessOpen:a,isReferencesOpen:r,isWarningsOpen:o,isStackTracesOpen:l,logs:c,references:u}=t||{};this.isTagsOpen=!!n,this.isProcessOpen=!!a,this.isReferencesOpen=!!r,this.isWarningsOpen=!!o,this.isStackTracesOpen=!!l,this.logs={isOpen:!!(c&&c.isOpen),openedItems:c&&c.openedItems?new Set(c.openedItems):new Set},this.references={isOpen:!!(u&&u.isOpen),openedItems:u&&u.openedItems?new Set(u.openedItems):new Set}}toggleTags(){const t=new He(this);return t.isTagsOpen=!this.isTagsOpen,t}toggleProcess(){const t=new He(this);return t.isProcessOpen=!this.isProcessOpen,t}toggleReferences(){const t=new He(this);return t.references.isOpen=!this.references.isOpen,t}toggleReferenceItem(t){const n=new He(this);return n.references.openedItems.has(t)?n.references.openedItems.delete(t):n.references.openedItems.add(t),n}toggleWarnings(){const t=new He(this);return t.isWarningsOpen=!this.isWarningsOpen,t}toggleStackTraces(){const t=new He(this);return t.isStackTracesOpen=!this.isStackTracesOpen,t}toggleLogs(){const t=new He(this);return t.logs.isOpen=!this.logs.isOpen,t}toggleLogItem(t){const n=new He(this);return n.logs.openedItems.has(t)?n.logs.openedItems.delete(t):n.logs.openedItems.add(t),n}}function Fr(e){const[t,n]=(0,h.useState)(new Map);(0,h.useEffect)(()=>{n(new Map)},[e,n]);const a=(0,h.useCallback)(function(c){const u=new Map(t);u.has(c)?u.delete(c):u.set(c,new He),n(u)},[t]),r=(0,h.useCallback)(function(c,u){const p=t.get(c);if(!p)return;const f=p.toggleLogItem(u),m=new Map(t);return m.set(c,f),n(m)},[t]),o=(0,h.useCallback)(function(c,u){const p=t.get(c);if(!p)return;const f=p.toggleReferenceItem(u),m=new Map(t);return m.set(c,f),n(m)},[t]);return{detailStates:t,toggleDetail:a,detailLogItemToggle:r,detailLogsToggle:(0,h.useCallback)(l=>rt("logs",t,n)(l),[t]),detailWarningsToggle:(0,h.useCallback)(l=>rt("warnings",t,n)(l),[t]),detailStackTracesToggle:(0,h.useCallback)(l=>rt("stackTraces",t,n)(l),[t]),detailReferenceItemToggle:o,detailReferencesToggle:(0,h.useCallback)(l=>rt("references",t,n)(l),[t]),detailProcessToggle:(0,h.useCallback)(l=>rt("process",t,n)(l),[t]),detailTagsToggle:(0,h.useCallback)(l=>rt("tags",t,n)(l),[t])}}function rt(e,t,n){return a=>{const r=t.get(a);if(!r)return;let o;e==="tags"?o=r.toggleTags():e==="process"?o=r.toggleProcess():e==="warnings"?o=r.toggleWarnings():e==="references"?o=r.toggleReferences():e==="stackTraces"?o=r.toggleStackTraces():o=r.toggleLogs();const l=new Map(t);l.set(a,o),n(l)}}function Or(){const[e,t]=(0,h.useState)(new Set),n=(0,h.useCallback)(function(o){t(l=>{const c=new Set(l);return c.add(o),c})},[]),a=(0,h.useCallback)(function(o){t(l=>{const c=new Set(l);return c.delete(o),c})},[]);return{hoverIndentGuideIds:e,addHoverIndentGuideId:n,removeHoverIndentGuideId:a}}var _r=d(77806);function Vr(){const[e,t]=(0,h.useState)({time:{current:[0,1]}}),n=(0,h.useCallback)(function(o){t(l=>{const c={...l.time,...o};return{...l,time:c}})},[]),a=(0,h.useCallback)(function(o,l){const u={current:[o,l]};t(p=>({...p,time:u}))},[]);return{viewRange:e,updateViewRangeTime:a,updateNextViewRangeTime:n}}const Br=e=>({noDataMsg:(0,i.css)({height:"100%",width:"100%",display:"grid",placeItems:"center",fontSize:e.typography.h4.fontSize,color:e.colors.text.secondary})});function Pr(e){const{traceProp:t,datasource:n,topOfViewRef:a,exploreId:r,createSpanLink:o,focusedSpanId:l,createFocusSpanLink:c,spanFilters:u}=e,{detailStates:p,toggleDetail:f,detailLogItemToggle:m,detailLogsToggle:y,detailProcessToggle:C,detailReferencesToggle:A,detailReferenceItemToggle:T,detailTagsToggle:N,detailWarningsToggle:F,detailStackTracesToggle:G}=Fr(e.dataFrames[0]),{removeHoverIndentGuideId:Z,addHoverIndentGuideId:O,hoverIndentGuideIds:ee}=Or(),{viewRange:ie,updateViewRangeTime:ue,updateNextViewRangeTime:he}=Vr(),{expandOne:se,collapseOne:Se,childrenToggle:Re,collapseAll:Le,childrenHiddenIDs:Q,expandAll:Ee}=Ar(),{search:Ce,setSearch:ve,spanFilterMatches:fe}=(0,_r.S)(r,t?.spans,u),[Me,Oe]=(0,h.useState)(""),[re,ye]=(0,b.A)(!1),[Ne,Ve]=(0,h.useState)(100),[Ie,_e]=(0,h.useState)({}),[ge,ze]=(0,h.useState)({}),it=(0,x.of)(Br),[Vt,Ue]=(0,h.useState)(.4),[Ye,Bt]=Hr({refId:e.dataFrames[0]?.refId,exploreId:e.exploreId,datasource:n,splitOpenFn:e.splitOpenFn}),Pt=l??Ye,ot=c??Bt,Be=(0,h.useMemo)(()=>({childrenHiddenIDs:Q,detailStates:p,hoverIndentGuideIds:ee,spanNameColumnWidth:Vt,traceID:e.traceProp?.traceID}),[Q,p,ee,Vt,e.traceProp?.traceID]),wt=(0,w.tR)().getInstanceSettings(n?.name),Bs=_(wt?.jsonData),Ps=wt?.jsonData?.tracesToMetrics,Ht=wt?.jsonData?.tracesToProfiles,$r=wt?.jsonData,Wr=(0,h.useMemo)(()=>o??ya({splitOpenFn:e.splitOpenFn,traceToLogsOptions:Bs,traceToMetricsOptions:Ps,traceToProfilesOptions:Ht,dataFrame:e.dataFrames[0],createFocusSpanLink:ot,trace:t}),[e.splitOpenFn,Bs,Ps,Ht,e.dataFrames,ot,t,o]),Hs=(0,W.d4)(Gr=>(0,E.O)(Gr.user)),$s=n?n?.type:"unknown",Kr=n?n?.name:"unknown",Ws=n?n?.uid:"",zr=e.scrollElement?e.scrollElement:document.getElementsByClassName(e.scrollElementClass??"")[0],Ur=P(t);return(0,s.jsx)(s.Fragment,{children:e.dataFrames?.length&&t?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(ns,{trace:t,data:e.dataFrames[0],timeZone:Hs,search:Ce,setSearch:ve,showSpanFilters:re,setShowSpanFilters:ye,setFocusedSpanIdForSearch:Oe,spanFilterMatches:fe,datasourceType:$s,datasourceName:Kr,datasourceUid:Ws,setHeaderHeight:Ve,app:r?L.Jk.Explore:L.Jk.Unknown}),(0,s.jsx)(Nn,{trace:t,viewRange:ie,updateNextViewRangeTime:he,updateViewRangeTime:ue}),(0,s.jsx)(Mr,{findMatchesIDs:fe,trace:t,traceToProfilesOptions:Ht,datasourceType:$s,datasourceUid:Ws,spanBarOptions:$r?.spanBar,traceTimeline:Be,updateNextViewRangeTime:he,updateViewRangeTime:ue,viewRange:ie,timeZone:Hs,setSpanNameColumnWidth:Ue,collapseAll:Le,collapseOne:Se,expandAll:Ee,expandOne:se,childrenToggle:Re,detailLogItemToggle:m,detailLogsToggle:y,detailWarningsToggle:F,detailStackTracesToggle:G,detailReferencesToggle:A,detailReferenceItemToggle:T,detailProcessToggle:C,detailTagsToggle:N,detailToggle:f,addHoverIndentGuideId:O,removeHoverIndentGuideId:Z,createSpanLink:Wr,scrollElement:zr,focusedSpanId:Pt,focusedSpanIdForSearch:Me,showSpanFilterMatchesOnly:Ce.matchesOnly,showCriticalPathSpansOnly:Ce.criticalPathOnly,createFocusSpanLink:ot,topOfViewRef:a,headerHeight:Ne,criticalPath:Ur,traceFlameGraphs:Ie,setTraceFlameGraphs:_e,redrawListView:ge,setRedrawListView:ze,timeRange:e.timeRange,app:r?L.Jk.Explore:L.Jk.Unknown})]}):(0,s.jsx)("div",{className:it.noDataMsg,children:(0,s.jsx)(g.x6,{i18nKey:"explore.trace-view.no-data",children:"No data"})})})}function Hr(e){const t=(0,W.d4)(c=>c.explore.panes[e.exploreId]?.panelsState.trace),n=t?.spanId,a=(0,W.wA)(),r=c=>a((0,te.EA)(e.exploreId,"trace",{...t,spanId:c})),o=(0,W.d4)(c=>c.explore.panes[e.exploreId]?.queries.find(u=>u.refId===e.refId));return[n,(c,u)=>{const p={title:(0,g.t)("explore.use-focus-span-link.create-focus-span-link.link.title.deep-link-to-this-span","Deep link to this span"),url:"",internal:{datasourceUid:e.datasource?.uid,datasourceName:e.datasource?.name,query:{...o,query:c},panelsState:{trace:{spanId:u}}}},f=o?.queryType==="traceql"&&o.query===c;return(0,M.u)({link:p,internalLink:p.internal,scopedVars:{},field:{},onClickFn:f?()=>r(n===u?void 0:u):e.splitOpenFn?()=>e.splitOpenFn({datasourceUid:e.datasource?.uid,queries:[{...o,query:c}],panelsState:{trace:{spanId:u}}}):void 0,replaceVariables:(0,X.w)().replace.bind((0,X.w)())})}]}},43149:I=>{"use strict";I.exports=function(v,d){var s=this;return s.directMap[v+":"+d]&&s.directMap[v+":"+d]({},v),this}},43709:I=>{"use strict";I.exports=function(v,d){var s=this;return s.bind(v,function(){},d)}},55610:I=>{"use strict";I.exports=function(v){var d=this;v=v||{};var s=!1,i;for(i in d.sequenceLevels){if(v[i]){s=!0;continue}d.sequenceLevels[i]=0}s||(d.nextExpectedAction=!1)}},56814:I=>{"use strict";I.exports={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",173:"minus",187:"plus",189:"minus",224:"meta"};for(var v=1;v<20;++v)I.exports[111+v]="f"+v;for(v=0;v<=9;++v)I.exports[v+96]=v},57208:(I,v,d)=>{"use strict";d.d(v,{BL:()=>X,od:()=>h});var s=d(11908),i=d(34282);function h(x,w){if(!w)return;let E=!1;x.serviceName&&(w=D(w,x),E=!0),x.spanName&&(w=ne(w,x),E=!0),(x.from||x.to)&&(w=me(w,x),E=!0);const W=L(w,x.tags);if(W&&(w=W,E=!0),x.query){const te=b(x.query,w);te&&(w=te,E=!0)}return E?new Set(w.map(te=>te.spanID)):void 0}function b(x,w){if(!w)return;const E=[];x.split(/\s+/).filter(Boolean).forEach(J=>{E.push(J.toLowerCase())});const W=(J,be)=>J.some(K=>be.toLowerCase().includes(K)),te=J=>J?J.some(be=>W(E,be.key)||W(E,H(be.value))):!1,q=J=>W(E,J.operationName)||W(E,J.process.serviceName)||te(J.tags)||J.kind&&W(E,J.kind)||J.statusCode!==void 0&&W(E,s.s[J.statusCode])||J.statusMessage&&W(E,J.statusMessage)||J.instrumentationLibraryName&&W(E,J.instrumentationLibraryName)||J.instrumentationLibraryVersion&&W(E,J.instrumentationLibraryVersion)||J.traceState&&W(E,J.traceState)||J.logs!==null&&J.logs.some(be=>be.name&&W(E,be.name)||te(be.fields))||te(J.process.tags)||E.some(be=>be===J.spanID);return w.filter(q)}const L=(x,w)=>{if(w=w.filter(E=>E.key&&E.key!==""||E.value),w.length>0)return x.filter(E=>w.every(W=>W.key&&W.value?!!(W.operator==="="&&g(W,E)||W.operator==="=~"&&M(W,E)||W.operator==="!="&&!g(W,E)||W.operator==="!~"&&!M(W,E)):W.key?E.tags.some(te=>_(W.key,te.key))||E.process.tags.some(te=>_(W.key,te.key))||E.logs&&E.logs.some(te=>te.fields.some(q=>_(W.key,q.key)))||E.kind&&W.key===i.Nd||E.statusCode!==void 0&&W.key===i.XQ||E.statusMessage&&W.key===i.x9||E.instrumentationLibraryName&&W.key===i.mT||E.instrumentationLibraryVersion&&W.key===i.Zh||E.traceState&&W.key===i.gz||W.key===i.ID?W.operator==="="||W.operator==="=~":!(W.operator==="="||W.operator==="=~"):!1))},M=(x,w)=>w.tags.some(E=>R(x,E))||w.process.tags.some(E=>R(x,E))||w.logs&&w.logs.some(E=>E.fields.some(W=>R(x,W)))||w.kind&&x.key===i.Nd&&x.value?.includes(w.kind)||w.statusCode!==void 0&&x.key===i.XQ&&x.value?.includes(s.s[w.statusCode].toLowerCase())||w.statusMessage&&x.key===i.x9&&x.value?.includes(w.statusMessage)||w.instrumentationLibraryName&&x.key===i.mT&&x.value?.includes(w.instrumentationLibraryName)||w.instrumentationLibraryVersion&&x.key===i.Zh&&x.value?.includes(w.instrumentationLibraryVersion)||w.traceState&&x.key===i.gz&&x.value?.includes(w.traceState)||x.key===i.ID&&x.value?.includes(w.spanID),g=(x,w)=>w.tags.some(E=>U(x,E))||w.process.tags.some(E=>U(x,E))||w.logs&&w.logs.some(E=>E.fields.some(W=>U(x,W)))||w.kind&&x.key===i.Nd&&x.value===w.kind||w.statusCode!==void 0&&x.key===i.XQ&&x.value===s.s[w.statusCode].toLowerCase()||w.statusMessage&&x.key===i.x9&&x.value===w.statusMessage||w.instrumentationLibraryName&&x.key===i.mT&&x.value===w.instrumentationLibraryName||w.instrumentationLibraryVersion&&x.key===i.Zh&&x.value===w.instrumentationLibraryVersion||w.traceState&&x.key===i.gz&&x.value===w.traceState||x.key===i.ID&&x.value===w.spanID,_=(x,w)=>x===w.toString(),U=(x,w)=>x.key===w.key&&x.value===H(w.value),R=(x,w)=>w.key.includes(x.key||"")&&H(w.value).includes(x.value||""),H=x=>x?x.toString():"",D=(x,w)=>x.filter(E=>w.serviceNameOperator==="="?E.process.serviceName===w.serviceName:E.process.serviceName!==w.serviceName),ne=(x,w)=>x.filter(E=>w.spanNameOperator==="="?E.operationName===w.spanName:E.operationName!==w.spanName),me=(x,w)=>{const E=X(w?.from||""),W=X(w?.to||"");let te=[];if(E&&(te=x.filter(q=>w.fromOperator===">"?q.duration>E:q.duration>=E)),W){const q=J=>w.toOperator==="<"?J.duration<W:J.duration<=W;te=te.length>0?te.filter(J=>q(J)):x.filter(J=>q(J))}return te},X=x=>{if(x.includes("ns"))return parseFloat(x.split("ns")[0])/1e3;if(x.includes("us"))return parseFloat(x.split("us")[0]);if(x.includes("\xB5s"))return parseFloat(x.split("\xB5s")[0]);if(x.includes("ms"))return parseFloat(x.split("ms")[0])*1e3;if(x.includes("s"))return parseFloat(x.split("s")[0])*1e3*1e3;if(x.includes("m"))return parseFloat(x.split("m")[0])*1e3*1e3*60;if(x.includes("h"))return parseFloat(x.split("h")[0])*1e3*1e3*60*60}},57944:(I,v,d)=>{"use strict";d.d(v,{h9:()=>M,tV:()=>b});var s=d(2543),i=d.n(s);function h(g){let _;const U=new Set(g.map(({spanID:R})=>R));for(let R=0;R<g.length;R++){if(g[R].references&&g[R].references.some(({traceID:me,spanID:X})=>me===g[R].traceID&&U.has(X)))continue;if(!_){_=g[R];continue}const D=g[R].references&&g[R].references.length||0,ne=_.references&&_.references.length||0;(D<ne||D===ne&&g[R].startTime<_.startTime)&&(_=g[R])}return _?`${_.process.serviceName}: ${_.operationName}`:""}const b=(0,s.memoize)(h,g=>g.length?g[0].traceID:0);function L(g){for(let _=0;_<g.length;_++){const U=g[_].tags.filter(D=>D.key==="http.request.method"),R=g[_].tags.filter(D=>D.key==="http.response.status_code"),H=g[_].tags.filter(D=>D.key==="http.route");if(U.length>0||R.length>0||H.length>0)return{method:U,status:R,url:H}}for(let _=0;_<g.length;_++){const U=g[_].tags.filter(D=>D.key==="http.method"),R=g[_].tags.filter(D=>D.key==="http.status_code"),H=g[_].tags.filter(D=>D.key==="http.url"||D.key==="http.target"||D.key==="http.path");if(U.length>0||R.length>0||H.length>0)return{method:U,status:R,url:H}}return{}}const M=(0,s.memoize)(L,g=>g.length?g[0].traceID:0)},57984:I=>{"use strict";I.exports={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"}},61210:I=>{"use strict";I.exports=function(v,d,s){var i=this;return v=v instanceof Array?v:[v],i.bindMultiple(v,d,s),i}},69192:(I,v,d)=>{"use strict";d.d(v,{T:()=>ne});var s=d(74848),i=d(22803),h=d(4392),b=d(47184),L=d(92745),M=d(20301),g=d(41654),_=d(18857),U=d(63527),R=d(63142),H=d(2513),D=d(87826);const ne=({search:X,trace:x,setSearch:w,tagKeys:E,setTagKeys:W,tagValues:te,setTagValues:q})=>{const J={...(0,R.of)(me)},be=()=>{E||W((0,D._g)(x).map(b.z))},K=S=>(0,D.Io)(x,S).map(b.z);(0,h.A)(()=>{X.tags&&X.tags.forEach(S=>{S.key&&q({...te,[S.id]:K(S.key)})})});const z=(S,$)=>{w({...X,tags:X.tags?.map(P=>P.id===S.id?{...P,key:$?.value||"",value:void 0}:P)}),(async()=>{if($?.value)q({...te,[S.id]:K($.value)});else{const P={...te};P[S.id]&&delete P[S.id],q(P)}})()},k=()=>{const S={id:(0,H.zE)(),operator:"="};w({...X,tags:[...X.tags,S]})},V=S=>{let $=X.tags.filter(B=>B.id!==S);$.length===0&&($=[{id:(0,H.zE)(),operator:"="}]),w({...X,tags:$})};return(0,s.jsx)("div",{children:X.tags?.map((S,$)=>(0,s.jsx)("div",{children:(0,s.jsxs)(g.B,{gap:0,width:"auto",justifyContent:"flex-start",alignItems:"center",children:[(0,s.jsx)("div",{children:(0,s.jsx)(_.l6,{"aria-label":(0,L.t)("explore.span-filters-tags.aria-label-select-tag-key","Select tag key"),isClearable:!0,onChange:B=>z(S,B),onOpenMenu:be,options:E||(S.key?[S.key].map(b.z):[]),placeholder:(0,L.t)("explore.span-filters-tags.placeholder-select-tag","Select tag"),value:S.key||null},S.key)}),(0,s.jsx)("div",{children:(0,s.jsx)(_.l6,{"aria-label":(0,L.t)("explore.span-filters-tags.aria-label-select-tag-operator","Select tag operator"),onChange:B=>{w({...X,tags:X.tags?.map(P=>P.id===S.id?{...P,operator:B.value}:P)})},options:[(0,b.z)("="),(0,b.z)("!="),(0,b.z)("=~"),(0,b.z)("!~")],value:S.operator})}),(0,s.jsxs)("span",{className:J.tagValues,children:[(S.operator==="="||S.operator==="!=")&&(0,s.jsx)(_.l6,{"aria-label":(0,L.t)("explore.span-filters-tags.aria-label-select-tag-value","Select tag value"),isClearable:!0,onChange:B=>{w({...X,tags:X.tags?.map(P=>P.id===S.id?{...P,value:B?.value||""}:P)})},options:te[S.id]?te[S.id]:S.value?[S.value].map(b.z):[],placeholder:(0,L.t)("explore.span-filters-tags.placeholder-select-value","Select value"),value:S.value},S.value),(S.operator==="=~"||S.operator==="!~")&&(0,s.jsx)(U.p,{"aria-label":(0,L.t)("explore.span-filters-tags.aria-label-input-tag-value","Input tag value"),onChange:B=>{w({...X,tags:X.tags?.map(P=>P.id===S.id?{...P,value:B?.currentTarget?.value||""}:P)})},placeholder:(0,L.t)("explore.span-filters-tags.placeholder-tag-value","Tag value"),width:18,value:S.value||""})]}),(S.key||S.value||X.tags.length>1)&&(0,s.jsx)(M.Z,{"aria-label":(0,L.t)("explore.span-filters-tags.aria-label-remove-tag","Remove tag"),variant:"secondary",icon:"times",onClick:()=>V(S.id),tooltip:(0,L.t)("explore.span-filters-tags.tooltip-remove-tag","Remove tag")}),(S.key||S.value)&&$===X.tags.length-1&&(0,s.jsx)("span",{className:J.addTag,children:(0,s.jsx)(M.Z,{"aria-label":(0,L.t)("explore.span-filters-tags.aria-label-add-tag","Add tag"),variant:"secondary",icon:"plus",onClick:k,tooltip:(0,L.t)("explore.span-filters-tags.tooltip-add-tag","Add tag")})})]})},S.id))})},me=X=>({addTag:(0,i.css)({marginLeft:X.spacing(1)}),tagValues:(0,i.css)({maxWidth:"200px"})})},74382:I=>{"use strict";I.exports=function(v,d,s){for(var i=this,h=0;h<v.length;++h)i.bindSingle(v[h],d,s)}},75888:(I,v,d)=>{"use strict";I.exports=function(s,i){var h=this,b=h.constructor;return h.options=Object.assign({storeInstancesGlobally:!0},i||{}),h.callbacks={},h.directMap={},h.sequenceLevels={},h.resetTimer=null,h.ignoreNextKeyup=!1,h.ignoreNextKeypress=!1,h.nextExpectedAction=!1,h.element=s,h.addEvents(),h.options.storeInstancesGlobally&&b.instances.push(h),h},I.exports.prototype.bind=d(61210),I.exports.prototype.bindMultiple=d(74382),I.exports.prototype.unbind=d(43709),I.exports.prototype.trigger=d(43149),I.exports.prototype.reset=d(26726),I.exports.prototype.stopCallback=d(84446),I.exports.prototype.handleKey=d(94320),I.exports.prototype.addEvents=d(96687),I.exports.prototype.bindSingle=d(22214),I.exports.prototype.getKeyInfo=d(84174),I.exports.prototype.pickBestAction=d(16004),I.exports.prototype.getReverseMap=d(95193),I.exports.prototype.getMatches=d(19132),I.exports.prototype.resetSequences=d(55610),I.exports.prototype.fireCallback=d(7922),I.exports.prototype.bindSequence=d(90875),I.exports.prototype.resetSequenceTimer=d(80602),I.exports.prototype.detach=d(93502),I.exports.instances=[],I.exports.reset=d(6255),I.exports.REVERSE_MAP=null},77806:(I,v,d)=>{"use strict";d.d(v,{Q:()=>U,S:()=>_});var s=d(2543),i=d.n(s),h=d(96540),b=d(52763),L=d(2513),M=d(51845),g=d(57208);function _(R,H,D){const ne=(0,b.wA)(),me=(0,b.d4)(q=>q.explore.panes[R??""]?.panelsState.trace),{spanFilters:X}=me||{},[x,w]=(0,h.useState)(()=>{const q=(0,s.merge)((0,s.cloneDeep)(L.$A),D??{});return(!q.tags||!Array.isArray(q.tags))&&(q.tags=[{id:(0,L.zE)(),operator:"="}]),q}),E=R?X||(0,s.merge)((0,s.cloneDeep)(L.$A),D??{}):x;E&&(!E.tags||!Array.isArray(E.tags))&&(E.tags=[{id:(0,L.zE)(),operator:"="}]),(0,h.useEffect)(()=>{if(R&&!X){const q=(0,s.merge)((0,s.cloneDeep)(L.$A),D??{});(!q.tags||!Array.isArray(q.tags))&&(q.tags=[{id:(0,L.zE)(),operator:"="}]),ne((0,M.EA)(R,"trace",{...me,spanFilters:q}))}},[R,D,X,ne,me]),(0,h.useEffect)(()=>{!R&&D&&w(q=>{const J=(0,s.merge)((0,s.cloneDeep)(q),D);return(!J.tags||!Array.isArray(J.tags))&&(J.tags=[{id:(0,L.zE)(),operator:"="}]),J})},[R,D]);const W=(0,h.useCallback)(q=>{R?ne((0,M.EA)(R,"trace",{...me,spanFilters:q})):w(q)},[R,ne,me]),te=(0,h.useMemo)(()=>H&&(0,g.od)(E,H),[E,H]);return{search:E,setSearch:W,spanFilterMatches:te}}function U(R,H){if(!H)return H;const D={...H};return(!D.tags||!Array.isArray(D.tags))&&(D.tags=[{id:(0,L.zE)(),operator:"="}]),D.query&&(D.query=R(D.query)),D.serviceNameOperator&&(D.serviceNameOperator=R(D.serviceNameOperator)),D.serviceName&&(D.serviceName=R(D.serviceName)),D.spanNameOperator&&(D.spanNameOperator=R(D.spanNameOperator)),D.spanName&&(D.spanName=R(D.spanName)),D.from&&(D.from=R(D.from)),D.to&&(D.to=R(D.to)),D.tags&&(D.tags=D.tags.map(ne=>({...ne,key:R(ne.key??""),value:R(ne.value??"")}))),D}},80602:I=>{"use strict";I.exports=function(){var v=this;clearTimeout(v.resetTimer),v.resetTimer=setTimeout(function(){v.resetSequences()},1e3)}},84174:(I,v,d)=>{"use strict";I.exports=function(s,i){var h=this,b,L,M,g,_=[],U,R,H;for(b=d(27486),L=b(s),U=d(7641),R=d(57984),H=d(95962),g=0;g<L.length;++g)M=L[g],U[M]&&(M=U[M]),i&&i!=="keypress"&&R[M]&&(M=R[M],_.push("shift")),H(M)&&_.push(M);return i=h.pickBestAction(M,_,i),{key:M,modifiers:_,action:i}}},84446:I=>{"use strict";I.exports=function(v,d){if((" "+d.className+" ").indexOf(" combokeys ")>-1)return!1;var s=d.tagName.toLowerCase();return s==="input"||s==="select"||s==="textarea"||d.isContentEditable}},87826:(I,v,d)=>{"use strict";d.d(v,{Io:()=>_,_g:()=>g,m8:()=>M,pG:()=>L});var s=d(11908),i=d(2543),h=d.n(i),b=d(34282);const L=U=>{const R=U.spans.map(H=>H.process.serviceName);return(0,i.uniq)(R).sort()},M=U=>{const R=U.spans.map(H=>H.operationName);return(0,i.uniq)(R).sort()},g=U=>{let R=[],H=[];return U.spans.forEach(D=>{D.tags.forEach(ne=>{R.push(ne.key)}),D.process.tags.forEach(ne=>{R.push(ne.key)}),D.logs!==null&&D.logs.forEach(ne=>{ne.fields.forEach(me=>{H.push(me.key)})}),D.kind&&R.push(b.Nd),D.statusCode!==void 0&&R.push(b.XQ),D.statusMessage&&R.push(b.x9),D.instrumentationLibraryName&&R.push(b.mT),D.instrumentationLibraryVersion&&R.push(b.Zh),D.traceState&&R.push(b.gz),R.push(b.ID)}),R=(0,i.uniq)(R).sort(),H=(0,i.uniq)(H).sort(),[...R,...H]},_=(U,R)=>{const H=[];return U.spans.forEach(D=>{const ne=D.tags.find(X=>X.key===R)?.value;ne&&H.push(ne.toString());const me=D.process.tags.find(X=>X.key===R)?.value;switch(me&&H.push(me.toString()),D.logs!==null&&D.logs.forEach(X=>{const x=X.fields.find(w=>w.key===R)?.value;x&&H.push(x.toString())}),R){case b.Nd:D.kind&&H.push(D.kind);break;case b.XQ:D.statusCode!==void 0&&H.push(s.s[D.statusCode].toLowerCase());break;case b.x9:D.statusMessage&&H.push(D.statusMessage);break;case b.mT:D.instrumentationLibraryName&&H.push(D.instrumentationLibraryName);break;case b.Zh:D.instrumentationLibraryVersion&&H.push(D.instrumentationLibraryVersion);break;case b.gz:D.traceState&&H.push(D.traceState);break;case b.ID:H.push(D.spanID);break;default:break}}),(0,i.uniq)(H).sort()}},88178:(I,v,d)=>{"use strict";I.exports=function(s){var i=this,h,b;typeof s.which!="number"&&(s.which=s.keyCode),h=d(23970);var L=h(s);if(L!==void 0){if(s.type==="keyup"&&i.ignoreNextKeyup===L){i.ignoreNextKeyup=!1;return}b=d(25273),i.handleKey(L,b(s),s)}}},88535:(I,v,d)=>{"use strict";d.d(v,{L:()=>J});var s=d(88673),i=d(2543),h=d(25508);class b{static iterFunction(z,k=0){return V=>z(V.value,V,k)}static searchFunction(z){return typeof z=="function"?z:(k,V)=>z instanceof b?V===z:k===z}constructor(z,k=[]){this.value=z,this.children=k}get depth(){return this.children.reduce((z,k)=>Math.max(k.depth+1,z),1)}get size(){let z=0;return this.walk(()=>z++),z}addChild(z){return this.children.push(z instanceof b?z:new b(z)),this}find(z){if(b.iterFunction(b.searchFunction(z))(this))return this;for(let V=0;V<this.children.length;V++){const S=this.children[V].find(z);if(S)return S}return null}getPath(z){const k=b.iterFunction(b.searchFunction(z)),V=(S,$)=>{const B=$.concat([S]);if(k(S))return B;for(let P=0;P<S.children.length;P++){const Y=S.children[P],le=V(Y,B);if(le)return le}return null};return V(this,[])}walk(z,k=0){const V=[];let S=k;for(V.push({node:this,depth:S});V.length;){const $=V[V.length-1];V.pop();const{node:B,depth:P}=$;z(B.value,B,P),S=P+1;let Y=B.children.length-1;for(;Y>=0;)V.push({node:B.children[Y],depth:S}),Y--}}paths(z){const k=[];k.push({node:this,childIndex:0});const V=[];for(;k.length;){const{node:S,childIndex:$}=k[k.length-1];if(S.children.length>=$+1)k[k.length-1].childIndex++,k.push({node:S.children[$],childIndex:0});else{if(S.children.length===0){const B=k.map(P=>P.node.value);z(B)}k.pop()}}return V}}const L=K=>K.spanID,M=K=>K.references||[],g=(0,h.Mz)((0,h.Mz)(({span:K})=>K,M),({type:K})=>K,(K,z)=>K.find(k=>k.refType===z)),_=(0,h.Mz)(K=>g({span:K,type:"CHILD_OF"}),K=>K?K.spanID:null),U=K=>K.spans,R=(0,h.Mz)(U,K=>K.reduce((z,k)=>z.set(L(k),k),new Map)),H="__root__";function D(K,z=null){const k=new Map(K.spans.map(B=>[B.spanID,new b(B.spanID)])),V=z??new Map(K.spans.map(B=>[B.spanID,B])),S=new b(H);K.spans.forEach(B=>{const P=k.get(B.spanID);if(Array.isArray(B.references)&&B.references.length){const{refType:Y,spanID:le}=B.references[0];if(Y==="CHILD_OF"||Y==="FOLLOWS_FROM")(k.get(le)||S).children?.push(P);else throw new Error(`Unrecognized ref type: ${Y}`)}else S.children.push(P)});const $=(B,P)=>{const Y=B?.value?V.get(B.value.toString()):void 0,le=P?.value?V.get(P.value.toString()):void 0;return+(Y?.startTime>le?.startTime)||+(Y?.startTime===le?.startTime)-1};return K.spans.forEach(B=>{const P=k.get(B.spanID);P.children.length>1&&P?.children.sort($)}),S.children.sort($),S}const ne=100,me="<trace-without-root-span>",X=Object.defineProperty({archiveEnabled:!1,dependencies:{dagMaxNumServices:ne,menuEnabled:!0},linkPatterns:[],search:{maxLookback:{label:"2 Days",value:"2d"},maxLimit:1500},tracking:{gaID:null,trackErrors:!0}},"__mergeFields",{value:["dependencies","search","tracking"]});function x(){return X}function w(K){return(0,i.get)(x(),K)}var E=d(57944);function W(K){const z=new Map,k=K.reduce((S,$)=>(S.some(B=>B.key===$.key&&B.value===$.value)?z.set(`${$.key}:${$.value}`,`Duplicate tag "${$.key}:${$.value}"`):S.push($),S),[]),V=Array.from(z.values());return{dedupedTags:k,warnings:V}}function te(K,z){const k=K?.slice()??[],V=(z||[]).map(S=>S.toLowerCase());return k.sort((S,$)=>{const B=S.key.toLowerCase(),P=$.key.toLowerCase();for(let Y=0;Y<V.length;Y++){const le=V[Y];if(B.startsWith(le)&&!P.startsWith(le))return-1;if(!B.startsWith(le)&&P.startsWith(le))return 1}return B>P?1:B<P?-1:0}),k}function q(K){if(!K?.traceID)return null;const z=K.traceID.toLowerCase();let k=0,V=Number.MAX_SAFE_INTEGER;const S=new Map,$=new Map;K.spans=K.spans.filter(ae=>!!ae.startTime),K.processes=Object.entries(K.processes).reduce((ae,[Te,De])=>(ae[Te]={...De,tags:te(De.tags)},ae),{});const B=K.spans.length;for(let ae=0;ae<B;ae++){const Te=K.spans[ae],{startTime:De,duration:pe,processID:Ae}=Te;let ce=Te.spanID;De<V&&(V=De),De+pe>k&&(k=De+pe);const je=S.get(ce);je!=null?(console.warn(`Dupe spanID, ${je+1} x ${ce}`,Te,$.get(ce)),(0,i.isEqual)(Te,$.get(ce))&&console.warn("	 two spans with same ID have `isEqual(...) === true`"),S.set(ce,je+1),ce=`${ce}_${je}`,Te.spanID=ce):S.set(ce,1),Te.process=K.processes[Ae],$.set(ce,Te)}const P=D(K,$),Y=[],le={};P.walk((ae,Te,De=0)=>{if(ae==="__root__"||typeof ae!="string")return;const pe=$.get(ae);if(!pe)return;const{serviceName:Ae}=pe.process;le[Ae]=(le[Ae]||0)+1,pe.relativeStartTime=pe.startTime-V,pe.depth=De-1,pe.hasChildren=Te.children.length>0,pe.childSpanCount=Te.children.length,pe.warnings=pe.warnings||[],pe.tags=pe.tags||[],pe.references=pe.references||[],pe.childSpanIds=Te.children.slice().sort((je,et)=>{const oe=$.get(je.value),pt=$.get(et.value);return pt.startTime+pt.duration-(oe.startTime+oe.duration)}).map(je=>je.value);const ce=W(pe.tags);pe.tags=te(ce.dedupedTags,w("topTagPrefixes")),pe.warnings=pe.warnings.concat(ce.warnings),pe.references.forEach((je,et)=>{const oe=$.get(je.spanID);oe&&(je.span=oe,et>0&&(oe.subsidiarilyReferencedBy=oe.subsidiarilyReferencedBy||[],oe.subsidiarilyReferencedBy.push({spanID:ae,traceID:z,span:pe,refType:je.refType})))}),Y.push(pe)});const we=(0,E.tV)(Y);return{services:Object.keys(le).map(ae=>({name:ae,numberOfSpans:le[ae]})),spans:Y,traceID:z,traceName:we,processes:K.processes,duration:k-V,startTime:V,endTime:k}}function J(K){if(!K)return null;let z=K.fields.length===1?K.fields[0].values[0]:be(K);return z?q(z):null}function be(K){const z=new s.R(K),k={};for(let V=0;V<z.length;V++){const S=z.get(V);if(!S.spanID)return null;k[S.spanID]||(k[S.spanID]={serviceName:S.serviceName,tags:S.serviceTags})}return{traceID:z.get(0).traceID,processes:k,spans:z.toArray().map((V,S)=>{const $=[];return V.parentSpanID&&$.push({refType:"CHILD_OF",spanID:V.parentSpanID,traceID:V.traceID}),V.references&&$.push(...V.references.map(B=>({refType:"FOLLOWS_FROM",...B}))),{...V,duration:V.duration*1e3,startTime:V.startTime*1e3,processID:V.spanID,flags:0,references:$,logs:V.logs?.map(B=>({...B,timestamp:B.timestamp*1e3}))||[],dataFrameRowIndex:S}})}}},90875:(I,v,d)=>{"use strict";I.exports=function(s,i,h,b){var L=this;L.sequenceLevels[s]=0;function M(H){return function(){L.nextExpectedAction=H,++L.sequenceLevels[s],L.resetSequenceTimer()}}function g(H){var D;L.fireCallback(h,H,s),b!=="keyup"&&(D=d(23970),L.ignoreNextKeyup=D(H)),setTimeout(function(){L.resetSequences()},10)}for(var _=0;_<i.length;++_){var U=_+1===i.length,R=U?g:M(b||L.getKeyInfo(i[_+1]).action);L.bindSingle(i[_],R,b,s,_)}}},93502:(I,v,d)=>{var s=d(12904).off;I.exports=function(){var i=this,h=i.element;s(h,"keypress",i.eventHandler),s(h,"keydown",i.eventHandler),s(h,"keyup",i.eventHandler)}},94320:(I,v,d)=>{"use strict";I.exports=function(s,i,h){var b=this,L,M,g={},_=0,U=!1,R,H;for(L=b.getMatches(s,i,h),M=0;M<L.length;++M)L[M].seq&&(_=Math.max(_,L[M].level));for(M=0;M<L.length;++M){if(L[M].seq){if(L[M].level!==_)continue;U=!0,g[L[M].seq]=1,b.fireCallback(L[M].callback,h,L[M].combo,L[M].seq);continue}U||b.fireCallback(L[M].callback,h,L[M].combo)}H=h.type==="keypress"&&b.ignoreNextKeypress,R=d(95962),h.type===b.nextExpectedAction&&!R(s)&&!H&&b.resetSequences(g),b.ignoreNextKeypress=U&&h.type==="keydown"}},95193:(I,v,d)=>{"use strict";I.exports=function(){var s=this,i=s.constructor,h;if(!i.REVERSE_MAP){i.REVERSE_MAP={},h=d(56814);for(var b in h)b>95&&b<112||h.hasOwnProperty(b)&&(i.REVERSE_MAP[h[b]]=b)}return i.REVERSE_MAP}},95962:I=>{"use strict";I.exports=function(v){return v==="shift"||v==="ctrl"||v==="alt"||v==="meta"}},96687:(I,v,d)=>{"use strict";I.exports=function(){var s=this,i=d(12904),h=s.element;s.eventHandler=d(88178).bind(s),i(h,"keypress",s.eventHandler),i(h,"keydown",s.eventHandler),i(h,"keyup",s.eventHandler)}}}]);

//# sourceMappingURL=3686.09de41ef527e0cd95dd5.js.map