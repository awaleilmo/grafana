"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[9886],{24296:(w,S,r)=>{r.d(S,{z:()=>a});var e=r(96540),x=r(55143),d=r(52161);const{useLazyDiscoverDsFeaturesQuery:R}=x.L;function a(){const[P,g]=(0,e.useState)([]),[I,{isLoading:A}]=R();return(0,e.useEffect)(()=>{(0,d.qi)().forEach(async f=>{const{data:j}=await I({uid:f.uid},!0);j?.rulerConfig&&g(B=>[...B,f])})},[I]),{rulesSourcesWithRuler:P,isLoading:A}}},25521:(w,S,r)=>{r.d(S,{G:()=>A});var e=r(74848),x=r(22803),d=r(92745),R=r(30703),a=r(59243),P=r(66404),g=r(41654),I=r(63142);function A({contentText:f,externalLink:j,linkText:B,title:N="Need help?"}){const W=(0,I.of)(O);return(0,e.jsx)(a.G,{content:(0,e.jsx)("div",{className:W.mutedText,children:f}),title:(0,e.jsxs)(g.B,{gap:.5,direction:"row",alignItems:"center",children:[(0,e.jsx)(R.I,{name:"question-circle"}),N]}),footer:j?(0,e.jsx)("a",{href:j,target:"_blank",rel:"noreferrer",children:(0,e.jsx)(g.B,{direction:"row",gap:.5,alignItems:"center",children:(0,e.jsxs)(P.E,{color:"link",children:[B," ",(0,e.jsx)(R.I,{size:"sm",name:"external-link-alt"})]})})}):void 0,closeButton:!0,placement:"bottom-start",children:(0,e.jsx)("div",{className:W.helpInfo,children:(0,e.jsxs)(g.B,{direction:"row",alignItems:"center",gap:.5,children:[(0,e.jsx)(R.I,{name:"question-circle",size:"sm"}),(0,e.jsx)(P.E,{variant:"bodySmall",color:"primary",children:(0,e.jsx)(d.x6,{i18nKey:"alerting.need-help-info.need-help",children:"Need help?"})})]})})})}const O=f=>({mutedText:(0,x.css)({color:f.colors.text.secondary,fontSize:f.typography.size.sm}),helpInfo:(0,x.css)({cursor:"pointer",textDecoration:"underline"})})},38133:(w,S,r)=>{r.d(S,{q:()=>a});var e=r(74848),x=r(96540),d=r(76792),R=r(24296);function a({value:P,disabled:g,...I}){const{rulesSourcesWithRuler:A,isLoading:O}=(0,R.z)(),f=(0,x.useCallback)(j=>A.some(({uid:B})=>B===j.uid),[A]);return(0,e.jsx)(d.sk,{disabled:O||g,noDefault:!0,alerting:!0,filter:f,current:P,...I})}},45097:(w,S,r)=>{r.r(S),r.d(S,{default:()=>_e,supportedImportTypes:()=>He});var e=r(74848),x=r(96540),d=r(49785),R=r(42941),a=r(92745),P=r(43173),g=r(41654),I=r(37386),A=r(16203),O=r(89599),f=r(31286),j=r(66404),B=r(3271),N=r(18027),W=r(21285),$=r(97095),V=r(45861),H=r(68079),y=r(57688),c=r(32225),p=r(76792),u=r(52161),h=r(77256),D=r(88547),T=r(36826),F=r(61293),z=r(38133),ee=r(25521),Z=r(22803),U=r(2543),re=r(16817),ye=r(36490),te=r(34999),ne=r(63142),se=r(22787),De=r(71599),Ee=r(50992),ie=r(64762),le=r(74268),je=r(5709);const Me=je.H.injectEndpoints({endpoints:t=>({convertToGMA:t.mutation({query:({payload:o,targetFolderUID:n,pauseRecordingRules:s,pauseAlerts:l,dataSourceUID:i,targetDatasourceUID:v})=>({url:"/api/convert/prometheus/config/v1/rules",method:"POST",body:o,headers:{"X-Grafana-Alerting-Datasource-UID":i,"X-Grafana-Alerting-Recording-Rules-Paused":s,"X-Grafana-Alerting-Alert-Rules-Paused":l,"X-Disable-Provenance":!0,...n?{"X-Grafana-Alerting-Folder-UID":n}:{},...v?{"X-Grafana-Alerting-Target-Datasource-UID":v}:{}}})})})});var Ie=r(29442),ue=r(29609),Te=r(75505),Re=r(68143),Ce=r(70327),Pe=r(55143),ce=r(59672);async function Ae(t){return(await(0,Te.s)((0,Re.AI)().fetch({url:"/api/folders",params:{parentUid:t},method:"GET",showErrorAlert:!1,showSuccessAlert:!1})))?.data}function Fe(t,o=!1){const[n,s]=(0,x.useState)([]);return(0,x.useEffect)(()=>{(async()=>{const l=o?[]:await Ae(t);s(l)})()},[t,o]),n}function Le(t,o,n){const s=Fe(o?.uid||"",t),l=t||s.length===0;return{rulesThatMightBeOverwritten:Se(s,n,l)}}function Oe(t,o){const n=t?void 0:o,{rulerRules:s,isLoading:l}=(0,ce.h$)(n);return{rulesToBeImported:s,isloadingCloudRules:l}}function Se(t,o,n=!0){const[s]=Ce.hK.endpoints.rulerNamespace.useLazyQuery(),[l,i]=(0,x.useState)({});return(0,x.useEffect)(()=>{if(n||(0,U.isEmpty)(t)||(0,U.isEmpty)(o)){i({});return}const v=t.filter(E=>Object.keys(o).includes(E.title));(async()=>{const E={};await Promise.all(v.map(async L=>{const{data:M}=await s({namespace:L.uid,rulerConfig:Pe.b});if(M){const C=Object.keys(M)[0];C&&(E[C]=M[C]||[])}})),i(E)})()},[t,o,n,s]),l}var Be=r(20382);function J(t){return typeof t=="object"&&!!t}function Ue(t){if(!J(t))return!1;const o="alert"in t&&typeof t.alert=="string"?t.alert:void 0,n="record"in t&&typeof t.record=="string"?t.record:void 0;return!(!("expr"in t&&typeof t.expr=="string"?t.expr:void 0)||!o&&!n||o&&n||"for"in t&&typeof t.for!="string"||"labels"in t&&!J(t.labels)||"annotations"in t&&!J(t.annotations))}function We(t){if(!J(t))return!1;const o="name"in t&&typeof t.name=="string"?t.name:void 0,n="rules"in t&&Array.isArray(t.rules)?t.rules:void 0;return!o||!n?!1:n.every(Ue)}function Ge(t){if(!J(t))return{isValid:!1,error:"Invalid YAML format: missing or invalid groups array"};if(!("groups"in t)||"groups"in t&&!Array.isArray(t.groups))return{isValid:!1,error:"Invalid YAML format: missing or invalid groups array"};if(!Array.isArray(t.groups))return{isValid:!1,error:"Invalid YAML format: missing or invalid groups array"};if("namespace"in t&&typeof t.namespace!="string")return{isValid:!1,error:"Invalid YAML format: namespace must be a string"};const n={groups:t.groups.map((s,l)=>{if(We(s))return s;throw new Error(`Invalid YAML format: missing or invalid groups array at index ${l}`)})};return"namespace"in t&&typeof t.namespace=="string"&&(n.namespace=t.namespace),{isValid:!0,data:n}}function Ne(t,o){const n=(0,Be.Hh)(t),s=Ge(n);if(!s.isValid)throw new Error(s.error);const l=s.data;return{[l.namespace??o]:l.groups}}async function de(t,o){const n=await t.text();return Ne(n,o)}const Ke=["SyntheticMonitoringCheckFailureAtHighSensitivity","SyntheticMonitoringCheckFailureAtMediumSensitivity","SyntheticMonitoringCheckFailureAtLowSensitivity","instance_job_severity:probe_success:mean5m"],me=()=>(0,e.jsx)(te.F,{title:(0,a.t)("alerting.import-to-gma.confirm-modal.plugin-rules-warning.title","Some rules are excluded from import"),severity:"info",children:(0,e.jsx)(j.E,{variant:"body",children:(0,e.jsx)(a.x6,{i18nKey:"alerting.import-to-gma.confirm-modal.plugin-rules-warning.text",children:"We have detected that some rules are managed by plugins. These rules will not be imported."})})}),Ye=()=>(0,e.jsx)(te.F,{title:(0,a.t)("alerting.import-to-gma.confirm-modal.not-using-rules-managed-by-integrations-or-plugins.title","Information"),severity:"info",children:(0,e.jsx)(j.E,{variant:"body",children:(0,e.jsx)(a.x6,{i18nKey:"alerting.import-to-gma.confirm-modal.not-using-rules-managed-by-integrations-or-plugins.text",children:"Rules managed by integrations or plugins should not be imported to Grafana-managed rules."})})}),ae={},be=({importPayload:t,isOpen:o,onDismiss:n})=>{const s=(0,ie._2)(),l=(0,ne.of)(fe),{importSource:i,selectedDatasourceName:v,selectedDatasourceUID:m,yamlFile:E,targetFolder:L,namespace:M,ruleGroup:C,targetDatasourceUID:G,yamlImportTargetDatasourceUID:K,pauseRecordingRules:Q,pauseAlertingRules:k}=t,q=o&&i==="datasource"?v??"":void 0,{rulesToBeImported:X,isloadingCloudRules:he}=Oe(!o||i==="yaml",q),{value:_=ae}=(0,re.A)(async()=>{if(!E||i!=="yaml")return ae;try{return await de(E,E.name)}catch(b){return s.error((0,a.t)("alerting.import-to-gma.yaml-error","Failed to parse YAML file: {{error}}",{error:(0,h.JZ)(b)})),ae}},[i,E]),{filteredConfig:Y,someRulesAreSkipped:ve}=(0,x.useMemo)(()=>i==="datasource"?Ve(X,M,C):{filteredConfig:_,someRulesAreSkipped:!1},[M,C,i,_,X]),{rulesThatMightBeOverwritten:xe}=Le(!o,L,Y),[er]=Me.useConvertToGMAMutation(),oe=(0,ie._2)();if(he)return(0,e.jsx)(se.a,{isOpen:o,title:(0,a.t)("alerting.import-to-gma.confirm-modal.loading","Loading..."),onDismiss:n,onClickBackdrop:n,children:(0,e.jsx)(j.E,{children:(0,a.t)("alerting.import-to-gma.confirm-modal.loading-body","Preparing data to be imported. This can take a while...")})});async function rr(){if(!K&&!m){oe.error((0,a.t)("alerting.import-to-gma.error","Failed to import alert rules: {{error}}",{error:"No data source selected"}));return}try{await er({dataSourceUID:i==="yaml"?K??"":m??"",targetFolderUID:L?.uid,pauseRecordingRules:Q,pauseAlerts:k,payload:Y,targetDatasourceUID:G}).unwrap();const b=(0,U.isEmpty)(L?.uid);(0,le.iF)({importSource:i,isRootFolder:b,namespace:M,ruleGroup:C,pauseRecordingRules:Q,pauseAlertingRules:k});const or=(0,Ie.tx)(b?[]:[["namespace",L?.title??""]],{skipSubPath:!0});oe.success((0,a.t)("alerting.import-to-gma.success","Successfully imported alert rules to Grafana-managed rules.")),ye.Ny.push(or)}catch(b){(0,le.Tc)({importSource:i}),oe.error((0,a.t)("alerting.import-to-gma.error","Failed to import alert rules: {{error}}",{error:(0,h.JZ)(b)}))}}if((0,U.isEmpty)(Y))return(0,e.jsx)(se.a,{isOpen:o,title:(0,a.t)("alerting.import-to-gma.confirm-modal.no-rules-title","No rules to import"),onDismiss:n,onClickBackdrop:n,children:(0,e.jsxs)(g.B,{direction:"column",gap:2,children:[ve&&(0,e.jsx)(me,{}),(0,e.jsx)(j.E,{children:i==="yaml"?(0,a.t)("alerting.import-to-gma.confirm-modal.no-rules-body-yaml","There are no rules to import. Please select a different yaml file."):(0,a.t)("alerting.import-to-gma.confirm-modal.no-rules-body","There are no rules to import. Please select a different namespace or rule group.")})]})});const tr=(0,a.t)("alerting.import-to-gma.confirm-modal.title","Confirm import"),ar=(0,a.t)("alerting.import-to-gma.confirm-modal.confirm","Import");return(0,e.jsx)(De.u,{isOpen:o,title:tr,confirmText:ar,confirmButtonVariant:"primary",modalClass:l.modal,body:(0,e.jsxs)(g.B,{direction:"column",gap:2,children:[!(0,U.isEmpty)(xe)&&(0,e.jsx)(we,{targetFolderRules:xe}),(0,e.jsx)(Ye,{}),ve&&(0,e.jsx)(me,{}),(0,e.jsx)(j.E,{variant:"h6",children:(0,e.jsx)(a.x6,{i18nKey:"alerting.to-gma.confirm-modal.summary",children:"The following alert rules will be imported:"})}),Y&&(0,e.jsx)(ge,{rules:Y})]}),onConfirm:rr,onDismiss:n})};function Ve(t,o,n){const s={};let l=!1;return Object.entries(t).forEach(([i,v])=>{if(o&&i!==o)return;const m=v.filter(E=>!(n&&E.name!==n)).map(E=>{const L=E.rules.filter(M=>ze(M)?(l=!0,!1):!0);return{...E,rules:L}}).filter(E=>E.rules.length>0);m.length>0&&(s[i]=m)}),{filteredConfig:s,someRulesAreSkipped:l}}function ze(t){if((0,ue.Tm)(t)||t.labels?.namespace?.startsWith("integrations-"))return!0;if(!(t.labels?.namespace==="synthetic_monitoring"))return!1;const l=(0,ue.qz)(t);return Ke.some(i=>i===l)}function ge({rules:t}){const o=(0,ne.of)(fe);return(0,e.jsx)("div",{className:o.content,children:(0,e.jsx)(Ee.B,{width:"100%",height:500,language:"json",value:JSON.stringify(t,null,4),monacoOptions:{minimap:{enabled:!1},scrollBeyondLastLine:!1,lineNumbers:"on",readOnly:!0}})})}const fe=()=>({content:(0,Z.css)({flex:"1 1 100%"}),modal:(0,Z.css)({width:"800px"})});function we({targetFolderRules:t}){const[o,n]=(0,R.A)(!1);return(0,e.jsxs)(g.B,{direction:"column",gap:2,children:[(0,e.jsx)(te.F,{title:(0,a.t)("alerting.to-gma.confirm-modal.title-warning","Warning"),severity:"warning",children:(0,e.jsx)(j.E,{variant:"body",children:(0,e.jsx)(a.x6,{i18nKey:"alerting.to-gma.confirm-modal.body",children:"The target folder is not empty, some rules may be overwritten or removed. Are you sure you want to import these alert rules to Grafana-managed rules?"})})}),t&&(0,e.jsx)(O.S,{label:(0,a.t)("alerting.import-to-gma.confirm-modal.target-folder-rules","Target folder rules that might be overwritten"),isOpen:o,onToggle:n,collapsible:!0,children:(0,e.jsx)(ge,{rules:t})})]})}var pe=r(43243);const $e=({rulesSourceName:t})=>{const{control:o,watch:n,formState:{errors:s},setValue:l}=(0,d.xW)(),i=n("namespace"),{namespaceGroups:v,isLoading:m}=(0,ce.$i)(t),E=(0,x.useMemo)(()=>Array.from(v.keys()).map(M=>({label:M,value:M})),[v]),L=(0,x.useMemo)(()=>i&&v.get(i)?.map(M=>({label:M,value:M}))||[],[i,v]);return(0,x.useEffect)(()=>{l("namespace",""),l("ruleGroup","")},[t,l]),(0,e.jsxs)(g.B,{direction:"row",gap:2,children:[(0,e.jsx)(I.D,{htmlFor:"namespace-picker","data-testid":"namespace-picker",label:(0,a.t)("alerting.import-to-gma.namespace.label","Namespace"),description:(0,a.t)("alerting.import-to-gma.namespace.description","Type to search for an existing namespace"),error:s.namespace?.message,invalid:!!s.namespace?.message,children:(0,e.jsx)(d.xI,{render:({field:{onChange:M,ref:C,...G}})=>(0,e.jsx)(pe.G,{...G,onChange:K=>{l("ruleGroup",""),M(K?.value)},id:"namespace-picker",placeholder:(0,a.t)("alerting.namespace-and-group-filter.select-namespace","Select namespace"),options:E,width:42,loading:m,disabled:m||!t,isClearable:!0}),name:"namespace",control:o})}),(0,e.jsx)(I.D,{htmlFor:"group-picker","data-testid":"group-picker",label:(0,a.t)("alerting.import-to-gma.group.label","Group"),description:(0,a.t)("alerting.import-to-gma.group.description","Type to search for an existing group"),error:s.ruleGroup?.message,invalid:!!s.ruleGroup?.message,children:(0,e.jsx)(d.xI,{render:({field:{ref:M,...C}})=>(0,e.jsx)(pe.G,{...C,options:L,width:42,onChange:G=>{l("ruleGroup",G?.value??"")},id:"group-picker",placeholder:(0,a.t)("alerting.namespace-and-group-filter.select-group","Select group"),loading:m,disabled:m||!i||!t,isClearable:!0}),name:"ruleGroup",control:o})})]})},He=[u.ol.Prometheus,u.ol.Loki],Je=()=>{const t=(0,d.mN)({defaultValues:{importSource:"datasource",yamlFile:null,yamlImportTargetDatasourceUID:void 0,selectedDatasourceUID:void 0,selectedDatasourceName:void 0,pauseAlertingRules:!0,pauseRecordingRules:!0,targetFolder:void 0,targetDatasourceUID:void 0}}),{register:o,handleSubmit:n,watch:s,control:l,setValue:i,formState:{errors:v,isSubmitting:m}}=t,[E,L]=(0,R.A)(!0),[M,C]=s(["selectedDatasourceName","importSource"]),[G,K]=(0,x.useState)(null),Q=P.$.featureToggles.alertingImportYAMLUI,k=async X=>{K(X)},q=[{label:(0,a.t)("alerting.import-to-gma.source.datasource","Existing data source-managed rules"),description:(0,a.t)("alerting.import-to-gma.source.datasource-description","Import rules from existing data sources"),value:"datasource"}];return Q&&q.push({label:(0,a.t)("alerting.import-to-gma.source.yaml","Prometheus YAML file"),description:(0,a.t)("alerting.import-to-gma.source.yaml-description","Import rules from a Prometheus YAML file."),value:"yaml"}),(0,e.jsx)(T.d,{navId:"alert-list",pageNav:{text:(0,a.t)("alerting.import-to-gma.pageTitle","Import alert rules")},children:(0,e.jsx)(g.B,{gap:2,direction:"column",children:(0,e.jsx)(d.Op,{...t,children:(0,e.jsxs)("form",{onSubmit:n(k),children:[(0,e.jsxs)(g.B,{direction:"column",gap:1,children:[(0,e.jsx)(I.D,{label:(0,a.t)("alerting.import-to-gma.import-source","Import source"),invalid:!!v.importSource,error:v.importSource?.message,htmlFor:"import-source",noMargin:!0,children:(0,e.jsx)(d.xI,{render:({field:{onChange:X,ref:he,..._}})=>(0,e.jsx)(A.a,{..._,onChange:Y=>i("importSource",Y),options:q}),control:l,name:"importSource"})}),C==="datasource"&&(0,e.jsx)(qe,{}),Q&&C==="yaml"&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(Qe,{}),(0,e.jsx)(Xe,{})]}),(0,e.jsxs)(O.S,{label:(0,a.t)("alerting.import-to-gma.additional-settings","Additional settings"),isOpen:E,onToggle:L,collapsible:!0,children:[(0,e.jsxs)(f.a,{marginLeft:1,children:[(0,e.jsx)(f.a,{marginBottom:2,children:(0,e.jsx)(j.E,{variant:"h5",children:(0,a.t)("alerting.import-to-gma.import-location-and-filters","Import location and filters")})}),(0,e.jsxs)(g.B,{direction:"column",gap:2,children:[(0,e.jsx)(ke,{}),C==="datasource"&&(0,e.jsx)($e,{rulesSourceName:M||void 0})]})]}),(0,e.jsx)(B.c,{}),(0,e.jsxs)(f.a,{children:[(0,e.jsx)(f.a,{marginLeft:1,marginBottom:1,children:(0,e.jsx)(j.E,{variant:"h5",children:(0,a.t)("alerting.import-to-gma.alert-rules","Alert rules")})}),(0,e.jsx)(N.I,{transparent:!0,label:(0,a.t)("alerting.import-to-gma.pause.label","Pause imported alerting rules"),labelWidth:30,htmlFor:"pause-alerting-rules",children:(0,e.jsx)(W.K,{transparent:!0,id:"pause-alerting-rules",...o("pauseAlertingRules"),showLabel:!1})})]}),(0,e.jsx)(B.c,{}),(0,e.jsxs)(f.a,{children:[(0,e.jsx)(f.a,{marginBottom:1,marginLeft:1,children:(0,e.jsx)(j.E,{variant:"h5",children:(0,a.t)("alerting.import-to-gma.recording-rules","Recording rules")})}),(0,e.jsx)($.C,{children:(0,e.jsx)(N.I,{transparent:!0,label:(0,a.t)("alerting.import-to-gma.pause-recording.label","Pause imported recording rules"),labelWidth:30,htmlFor:"pause-recording-rules",children:(0,e.jsx)(W.K,{transparent:!0,id:"pause-recording-rules",...o("pauseRecordingRules")})})}),(0,e.jsx)(f.a,{marginLeft:1,width:50,children:(0,e.jsx)(Ze,{})})]})]})]}),(0,e.jsx)(f.a,{marginTop:2,children:(0,e.jsxs)(g.B,{gap:1,children:[(0,e.jsx)(V.$n,{type:"submit",variant:"primary",disabled:m,children:(0,e.jsxs)(g.B,{direction:"row",gap:2,alignItems:"center",children:[m&&(0,e.jsx)(H.y,{inline:!0}),(0,e.jsx)(a.x6,{i18nKey:"alerting.import-to-gma.action-button",children:"Import"})]})}),(0,e.jsx)(V.z9,{variant:"secondary",href:"/alerting/list",children:(0,e.jsx)(a.x6,{i18nKey:"common.cancel",children:"Cancel"})})]})}),G&&(0,e.jsx)(be,{isOpen:!!G,onDismiss:()=>K(null),importPayload:G})]})})})})};function Qe(){const{formState:{errors:t}}=(0,d.xW)();return(0,e.jsx)(I.D,{label:(0,a.t)("alerting.import-to-gma.yaml.label","Prometheus YAML file"),invalid:!!t.yamlFile,error:t.yamlFile?.message,description:(0,a.t)("alerting.import-to-gma.yaml.description","Select a Prometheus-compatible YAML file to import"),noMargin:!0,children:(0,e.jsx)(d.xI,{name:"yamlFile",render:({field:{onChange:o,ref:n,...s}})=>(0,e.jsx)(y.e,{...s,onFileUpload:l=>{const i=l.currentTarget.files?.item(0);o(i),l.currentTarget.value=""},size:"sm",showFileName:!0,accept:".yaml,.yml,.json"}),rules:{required:{value:!0,message:(0,a.t)("alerting.import-to-gma.yaml.required-message","Please select a file")},validate:async o=>{if(!o)return(0,a.t)("alerting.import-to-gma.yaml.required-message","Please select a file");try{return await de(o,o.name),!0}catch(n){return(0,a.t)("alerting.import-to-gma.yaml-error","Failed to parse YAML file: {{error}}",{error:(0,h.JZ)(n)})}}}})})}function Xe(){const{formState:{errors:t},setValue:o,getValues:n}=(0,d.xW)();return(0,e.jsx)(I.D,{label:(0,a.t)("alerting.import-to-gma.yaml.target-datasource","Target data source"),description:(0,a.t)("alerting.import-to-gma.yaml.target-datasource-description","Select the data source that will be queried by the imported rules. Make sure metrics used in the imported rules are available in this data source."),invalid:!!t.yamlImportTargetDatasourceUID,error:t.yamlImportTargetDatasourceUID?.message,htmlFor:"yaml-target-data-source",noMargin:!0,children:(0,e.jsx)(d.xI,{name:"yamlImportTargetDatasourceUID",render:({field:{onChange:s,ref:l,value:i,...v}})=>(0,e.jsx)(p.sk,{...v,current:i,noDefault:!0,inputId:"yaml-target-data-source",alerting:!0,filter:m=>(0,u.bS)(m.type),onChange:m=>{o("yamlImportTargetDatasourceUID",m.uid),!n("targetDatasourceUID")&&(0,u.Gb)(m)&&o("targetDatasourceUID",m.uid)}}),rules:{required:{value:!0,message:(0,a.t)("alerting.import-to-gma.yaml.target-datasource-required","Please select a target data source")}}})})}function Ze(){const{control:t,formState:{errors:o},setValue:n}=(0,d.xW)();return(0,e.jsx)(I.D,{required:!0,label:(0,a.t)("alerting.recording-rules.label-target-data-source","Target data source"),description:(0,a.t)("alerting.recording-rules.description-target-data-source","The Prometheus data source to store recording rules in"),htmlFor:"recording-rules-target-data-source",error:o.targetDatasourceUID?.message,invalid:!!o.targetDatasourceUID?.message,noMargin:!0,children:(0,e.jsx)(d.xI,{render:({field:{onChange:s,ref:l,...i}})=>(0,e.jsx)(p.sk,{...i,current:i.value,inputId:"recording-rules-target-data-source",noDefault:!0,filter:u.Gb,onChange:v=>{n("targetDatasourceUID",v.uid)}}),name:"targetDatasourceUID",control:t,rules:{required:{value:!0,message:(0,a.t)("alerting.recording-rules.target-data-source-required","Please select a target data source")}}})})}function ke(){const{control:t,formState:{errors:o},setValue:n}=(0,d.xW)();return(0,e.jsx)(I.D,{label:(0,a.t)("alerting.import-to-gma.target-folder.label","Target folder"),description:(0,a.t)("alerting.import-to-gma.target-folder.description","The folder to import the rules to"),error:o.targetFolder?.message,htmlFor:"folder-picker",noMargin:!0,children:(0,e.jsxs)(g.B,{gap:2,children:[(0,e.jsx)(d.xI,{name:"targetFolder",render:({field:{onChange:s,ref:l,...i}})=>(0,e.jsx)(g.B,{width:42,children:(0,e.jsx)(c.NestedFolderPicker,{permission:"view",showRootFolder:!1,invalid:!!o.targetFolder?.message,...i,value:i.value?.uid,onChange:(v,m)=>{v&&m?n("targetFolder",{title:m,uid:v}):n("targetFolder",void 0)}})}),control:t}),(0,e.jsx)(F.x,{onCreate:s=>{n("targetFolder",s)}})]})})}function qe(){const{control:t,formState:{errors:o},setValue:n,getValues:s}=(0,d.xW)();return(0,e.jsx)(I.D,{label:(0,e.jsxs)(g.B,{direction:"row",gap:1,children:[(0,e.jsx)(j.E,{variant:"bodySmall",color:"secondary",children:(0,a.t)("alerting.import-to-gma.datasource.label","Data source")}),(0,e.jsx)(ee.G,{externalLink:"https://grafana.com/docs/grafana/latest/alerting/alerting-rules/alerting-migration/",linkText:"Read importing to Grafana alerting",contentText:(0,a.t)("alerting.import-to-gma.datasource.help-info.content","The dropdown only displays Mimir or Loki data sources that have the ruler API available."),title:(0,a.t)("alerting.import-to-gma.datasource.help-info.title","Data source")})]}),invalid:!!o.selectedDatasourceName,error:o.selectedDatasourceName?.message,htmlFor:"datasource-picker",noMargin:!0,children:(0,e.jsx)(d.xI,{name:"selectedDatasourceName",render:({field:{onChange:l,ref:i,...v}})=>(0,e.jsx)(z.q,{...v,width:50,inputId:"datasource-picker",onChange:m=>{if(n("selectedDatasourceUID",m.uid),n("selectedDatasourceName",m.name),!s("targetDatasourceUID")){const L=(0,u.Gb)(m)?m.uid:void 0;n("targetDatasourceUID",L)}}}),control:t,rules:{required:{value:!0,message:(0,a.t)("alerting.import-to-gma.datasource.required-message","Please select a data source")}}})})}const _e=(0,D.S)(Je)},59672:(w,S,r)=>{r.d(S,{$i:()=>B,DJ:()=>j,h$:()=>N});var e=r(29189),x=r(96540),d=r(70327),R=r(55143),a=r(74869);const{usePrometheusRuleNamespacesQuery:P,useLazyRulerRulesQuery:g,useRulerRulesQuery:I}=d.hK,{useDiscoverDsFeaturesQuery:A}=R.L,O={},f=(0,a.wS)();function j(y){const{data:c,isLoading:p}=A({rulesSourceName:y}),[u,{data:h=O,isLoading:D}]=g(),{data:T=[],isLoading:F}=P({ruleSourceName:y},{skip:!f});return(0,x.useEffect)(()=>{c?.rulerConfig&&!f&&u({rulerConfig:c.rulerConfig},!0)},[c?.rulerConfig,u]),{labels:(0,x.useMemo)(()=>F||D?new Map:f?V(T):H(h),[T,h,F,D]),isLoading:F||D||p}}function B(y){const{data:c,isLoading:p}=A(y?{rulesSourceName:y}:e.hT,{skip:!y}),[u,{data:h=O,isLoading:D}]=g(),{data:T=[],isLoading:F}=P(y&&f?{ruleSourceName:y}:e.hT);return(0,x.useEffect)(()=>{c?.rulerConfig&&!f&&u({rulerConfig:c.rulerConfig})},[c?.rulerConfig,u]),{namespaceGroups:(0,x.useMemo)(()=>F||D?new Map:f?W(T):$(h),[T,h,F,D]),isLoading:F||D||p,promNamespaces:T}}function N(y){const{data:c,isLoading:p}=A(y?{rulesSourceName:y}:e.hT),{data:u=O,isLoading:h}=I(c?.rulerConfig?{rulerConfig:c.rulerConfig}:e.hT);return{isLoading:h||p,rulerRules:u}}function W(y){const c=new Map;return y.forEach(p=>{c.set(p.name,p.groups.map(u=>u.name))}),c}function $(y){const c=new Map;return Object.entries(y).forEach(([p,u])=>{c.set(p,u.map(h=>h.name))}),c}function V(y){return y.flatMap(p=>p.groups).flatMap(p=>p.rules).reduce((p,u)=>(u.labels&&Object.entries(u.labels).forEach(([h,D])=>{if(!h||!D)return;const T=p.get(h);T?T.add(D):p.set(h,new Set([D]))}),p),new Map)}function H(y){const c=new Map;return Object.entries(y).flatMap(([u,h])=>h).flatMap(u=>u.rules).reduce((u,h)=>(h.labels&&Object.entries(h.labels).forEach(([D,T])=>{if(!D||!T)return;const F=u.get(D);F?F.add(T):u.set(D,new Set([T]))}),u),c)}},61293:(w,S,r)=>{r.d(S,{x:()=>V});var e=r(74848),x=r(22803),d=r(96540),R=r(51898),a=r(92745),P=r(22787),g=r(45861),I=r(41654),A=r(72636),O=r(37386),f=r(63527),j=r(63142),B=r(98970),N=r(64762),W=r(73427),$=r(11257);const V=({onCreate:c})=>{const[p,u]=(0,d.useState)(!1),h=D=>{c(D),u(!1)};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(g.$n,{onClick:()=>u(!0),type:"button",icon:"plus",fill:"outline",variant:"secondary",disabled:!W.TP.hasPermission($.w.FoldersCreate),children:(0,e.jsx)(a.x6,{i18nKey:"alerting.create-new-folder.new-folder",children:"New folder"})}),p&&(0,e.jsx)(H,{onCreate:h,onClose:()=>u(!1)})]})};function H({onClose:c,onCreate:p}){const u=(0,j.of)(y),h=(0,N._2)(),[D,T]=(0,d.useState)(""),[F,z]=(0,d.useState)(!1),[ee]=(0,B.Si)(),Z=async()=>{z(!0);const{data:U,error:re}=await ee({title:D});re?h.error("Failed to create folder"):U&&(p({title:U.title,uid:U.uid}),h.success("Folder created")),z(!1)};return(0,e.jsx)(P.a,{className:u.modal,isOpen:!0,title:(0,a.t)("alerting.create-new-folder.title-new-folder","New folder"),onDismiss:c,onClickBackdrop:c,children:(0,e.jsxs)(I.B,{direction:"column",gap:2,children:[(0,e.jsx)(O.D,{label:(0,e.jsx)(A.J,{htmlFor:"folder",children:(0,e.jsx)(a.x6,{i18nKey:"alerting.create-new-folder.folder.name",children:"Folder name"})}),children:(0,e.jsx)(f.p,{"data-testid":R.Tp.components.AlertRules.newFolderNameField,autoFocus:!0,id:"folderName",placeholder:(0,a.t)("alerting.create-new-folder.placeholder-enter-a-name","Enter a name"),value:D,onChange:U=>T(U.currentTarget.value)})}),(0,e.jsxs)(P.a.ButtonRow,{children:[(0,e.jsx)(g.$n,{variant:"secondary",type:"button",onClick:c,children:(0,e.jsx)(a.x6,{i18nKey:"alerting.create-new-folder.folder.cancel",children:"Cancel"})}),(0,e.jsx)(g.$n,{onClick:Z,disabled:!D||F,"data-testid":R.Tp.components.AlertRules.newFolderNameCreateButton,children:(0,e.jsx)(a.x6,{i18nKey:"alerting.create-new-folder.folder.create",children:"Create"})})]})]})})}const y=c=>({modal:(0,x.css)({width:`${c.breakpoints.values.sm}px`})})}}]);

//# sourceMappingURL=AlertingImportFromDSRules.d6dd294cd135a051c860.js.map