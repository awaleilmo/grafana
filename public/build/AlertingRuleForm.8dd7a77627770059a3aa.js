"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[4009],{14055:(We,Y,t)=>{t.d(Y,{V:()=>e});function e(f,p){const s=f.replace(/\(copy( [0-9]+)?\)$/,"").trim();let u=`${s} (copy)`;for(let z=2;p.includes(u);z++)u=`${s} (copy ${z})`;return u}},16996:(We,Y,t)=>{t.d(Y,{t:()=>ce});var e=t(74848),f=t(49785),p=t(92745),s=t(41654),u=t(66404),z=t(45861),R=t(96540),y=t(36303),l=t(74268);let k=null;const T=ee=>{if(!k)return null;const q=(0,y.Xc)(k,{title:(0,p.t)("alerting.ai.error-boundary.improve-labels-button","AI Improve Labels Button failed to load"),style:"alertbox",errorLogger:l.vV});return(0,R.createElement)(q,ee)};function I(ee){k=ee}var K=t(29609),V=t(25521),pe=t(8402);function ce({onEditClick:ee}){const{watch:q}=(0,f.xW)(),P=q("labels"),le=q("type"),C=le?(0,K.vE)(le):!1,Z=le?(0,K.H2)(le):!1,ue=C?(0,p.t)("alerting.alertform.labels.recording","Add labels to your rule."):(0,p.t)("alerting.alertform.labels.alerting","Add labels to your rule for searching, silencing, or routing to a notification policy."),O=Object.keys(P).length>0&&P.some(D=>D.key||D.value);return(0,e.jsxs)(s.B,{direction:"column",gap:2,children:[(0,e.jsxs)(s.B,{direction:"column",gap:1,children:[(0,e.jsx)(u.E,{element:"h5",children:(0,e.jsx)(p.x6,{i18nKey:"alerting.labels-field-in-form.labels",children:"Labels"})}),(0,e.jsxs)(s.B,{direction:"column",gap:1,children:[(0,e.jsxs)(s.B,{direction:"row",gap:1,children:[(0,e.jsx)(u.E,{variant:"bodySmall",color:"secondary",children:ue}),(0,e.jsx)(V.G,{externalLink:"https://grafana.com/docs/grafana/latest/alerting/fundamentals/alert-rules/annotation-label/",linkText:"Read about labels",contentText:`The dropdown only displays labels that you have previously used for alerts.
              Select a label from the options below or type in a new one.`,title:(0,p.t)("alerting.labels-field-in-form.title-labels","Labels")})]}),Z&&(0,e.jsx)(T,{})]})]}),(0,e.jsxs)(s.B,{direction:"row",gap:1,alignItems:"center",children:[(0,e.jsx)(pe.DI,{labels:P}),O?(0,e.jsx)(z.$n,{variant:"secondary",type:"button",onClick:ee,size:"sm",children:(0,e.jsx)(p.x6,{i18nKey:"alerting.labels-field-in-form.edit-labels",children:"Edit labels"})}):(0,e.jsxs)(s.B,{direction:"row",gap:2,alignItems:"center",children:[(0,e.jsx)(u.E,{children:(0,e.jsx)(p.x6,{i18nKey:"alerting.labels-field-in-form.no-labels-selected",children:"No labels selected"})}),(0,e.jsx)(z.$n,{icon:"plus",type:"button",variant:"secondary",onClick:ee,size:"sm","data-testid":"add-labels-button",children:(0,e.jsx)(p.x6,{i18nKey:"alerting.labels-field-in-form.add-labels",children:"Add labels"})})]})]})]})}},23878:(We,Y,t)=>{t.r(Y),t.d(Y,{RECORDING_TYPE:()=>ke,default:()=>Ue,defaultPageNav:()=>te});var e=t(74848),f=t(54148),p=t(92745),s=t(22803),u=t(34999),z=t(63142),R=t(45861);function y({title:c,children:h}){return(0,e.jsxs)(u.F,{className:(0,z.of)(l).warning,severity:"warning",title:c,children:[(0,e.jsx)("p",{children:h}),(0,e.jsx)(R.z9,{href:"alerting/list",children:(0,e.jsx)(p.x6,{i18nKey:"alerting.alert-warning.to-rule-list",children:"To rule list"})})]})}const l=c=>({warning:(0,s.css)({margin:c.spacing(4)})});var k=t(36826),T=t(96540),I=t(49785),K=t(43173),V=t(36490),pe=t(41654),ce=t(64762),ee=t(73427),q=t(85311),P=t(29609),le=t(44022),C=t(74268);function Z(c){return"message"in c}function ue(c){return"status"in c}var O=t(70654),D=t(23390),ae=t(84523),fe=t(6194),S=t(67817),Ee=t(29442),$=t(20437),re=t(94646),ot=t(6975),we=t(70327),de=t(77880),oe=t(25149),xe=t(78102);const se=({alertUid:c,exportFormat:h,onClose:w})=>{const{currentData:W="",isFetching:je}=we.hK.endpoints.exportRules.useQuery({ruleUid:c,format:h}),U=`${c}-${new Date().getTime()}`;return je?(0,e.jsx)(ot._,{text:(0,p.t)("alerting.grafana-rule-export-preview.text-loading","Loading....")}):(0,e.jsx)(de.J,{format:h,textDefinition:W,downloadFileName:U,onClose:w})},Pe=({onClose:c,alertUid:h})=>{const[w,W]=(0,T.useState)("yaml");return(0,e.jsx)(oe.m,{activeTab:w,onTabChange:W,onClose:c,formatProviders:Object.values(xe.sl),children:(0,e.jsx)(se,{alertUid:h,exportFormat:w,onClose:c})})};var Se=t(98395),Me=t(20593),ie=t(37386),Be=t(63527),ve=t(18857),ut=t(15629),Je=t(59672);const N=({rulesSourceName:c})=>{const{control:h,watch:w,formState:{errors:W},setValue:je}=(0,I.xW)(),U=(0,z.of)(ye),{namespaceGroups:H,isLoading:Ie}=(0,Je.$i)(c),qe=w("namespace"),He=(0,T.useMemo)(()=>Array.from(H.keys()).map(Ge=>({label:Ge,value:Ge})),[H]),Ye=(0,T.useMemo)(()=>qe&&H.get(qe)?.map(Ge=>({label:Ge,value:Ge}))||[],[qe,H]);return(0,e.jsxs)("div",{className:U.flexRow,children:[(0,e.jsx)(ie.D,{"data-testid":"namespace-picker",label:(0,p.t)("alerting.group-and-namespace-fields.namespace-picker-label-namespace","Namespace"),description:"Type to search for an existing namespace or create a new one",error:W.namespace?.message,invalid:!!W.namespace?.message,children:(0,e.jsx)(I.xI,{render:({field:{onChange:Ge,ref:tt,...mt}})=>(0,e.jsx)(ve.ip,{...mt,allowCustomValue:!0,className:U.input,onChange:ht=>{je("group",""),Ge(ht.value)},options:He,width:42,isLoading:Ie,disabled:Ie}),name:"namespace",control:h,rules:{required:{value:!0,message:(0,p.t)("alerting.group-and-namespace-fields.message.required","Required.")}}})}),(0,e.jsx)(ie.D,{"data-testid":"group-picker",label:(0,p.t)("alerting.group-and-namespace-fields.group-picker-label-group","Group"),description:"Type to search for an existing group or create a new one",error:W.group?.message,invalid:!!W.group?.message,children:(0,e.jsx)(I.xI,{render:({field:{ref:Ge,...tt}})=>(0,e.jsx)(ve.ip,{...tt,allowCustomValue:!0,options:Ye,width:42,onChange:mt=>{je("group",mt.value??"")},className:U.input,isLoading:Ie,disabled:Ie}),name:"group",control:h,rules:{required:{value:!0,message:(0,p.t)("alerting.group-and-namespace-fields.message.required","Required.")}}})})]})},ye=c=>({flexRow:(0,s.css)({display:"flex",flexDirection:"row",justifyContent:"flex-start","& > * + *":{marginLeft:c.spacing(3)}}),input:(0,s.css)({width:"330px !important"})});var ge=t(63008),M=t(58872);const Ae=()=>{const c=(0,z.of)(ze),{register:h,control:w,watch:W,formState:{errors:je}}=(0,I.xW)(),U=W("type"),H=W("dataSourceName");return(0,e.jsxs)(M.P,{stepNo:3,title:(0,p.t)("alerting.cloud-evaluation-behavior.title-set-evaluation-behavior","Set evaluation behavior"),children:[(0,e.jsx)(ie.D,{label:(0,p.t)("alerting.cloud-evaluation-behavior.label-pending-period","Pending period"),description:(0,p.t)("alerting.cloud-evaluation-behavior.description-pending-period",'Period during which the threshold condition must be met to trigger an alert. Selecting "None" triggers the alert immediately once the condition is met.'),children:(0,e.jsxs)("div",{className:c.flexRow,children:[(0,e.jsx)(ie.D,{invalid:!!je.forTime?.message,error:je.forTime?.message,className:c.inlineField,children:(0,e.jsx)(Be.p,{...h("forTime",{pattern:{value:/^\d+$/,message:(0,p.t)("alerting.cloud-evaluation-behavior.message.must-be-a-positive-integer","Must be a positive integer.")}}),width:8})}),(0,e.jsx)(I.xI,{name:"forTimeUnit",render:({field:{onChange:Ie,ref:qe,...He}})=>(0,e.jsx)(ve.l6,{...He,options:ut.sc,onChange:Ye=>Ie(Ye?.value),width:15,className:c.timeUnit}),control:w})]})}),U===S.Z.cloudAlerting&&H&&(0,e.jsx)(N,{rulesSourceName:H}),(0,e.jsx)(ge.L,{})]})},ze=c=>({inlineField:(0,s.css)({marginBottom:0}),flexRow:(0,s.css)({display:"flex",flexDirection:"row",justifyContent:"flex-start",alignItems:"flex-start"}),timeUnit:(0,s.css)({marginLeft:c.spacing(.5)})});var Le=t(10321),Ne=t(77946),st=t(96091);function Et(){const{watch:c}=(0,I.xW)(),h=c("dataSourceName");return h?(0,e.jsx)(M.P,{stepNo:3,title:(0,p.t)("alerting.recording-rules-name-space-and-group-step.title-add-namespace-and-group","Add namespace and group"),description:(0,p.t)("alerting.recording-rules-name-space-and-group-step.description-select-namespace-group-recording","Select the Namespace and Group for your recording rule."),children:(0,e.jsx)(N,{rulesSourceName:h})}):null}var it=t(29855),Ut=t(73228);const Rt=({existing:c,prefill:h,isManualRestore:w})=>{const W=(0,z.of)(Qt),je=(0,ce._2)(),U=(0,f.g)(),H=U.id,{redirectToDetailsPage:Ie}=gt(H),[qe,He]=(0,T.useState)(!1),[Ye]=(0,D.d)(),[Ge]=(0,D.pU)(),tt=(0,ae._u)(U.type),mt=(0,T.useMemo)(()=>c&&h?{...(0,ae.ir)(c),...(0,ae.b0)(h)}:c?(0,ae.ir)(c):h?(0,ae.b0)(h):(0,ae.BH)(tt),[c,h,tt]),ht=(0,I.mN)({mode:"onSubmit",defaultValues:mt,shouldFocusError:!0}),{handleSubmit:Xt,watch:St,formState:{isSubmitting:Bt},trigger:kt}=ht;(0,T.useEffect)(()=>{w&&kt()},[w,kt]);const nt=St("type"),vt=(0,P.H2)(nt??S.Z.grafana),yt=St("dataSourceName"),Tt=!!(nt&&((0,P.H2)(nt)||yt)),[qt,on]=(0,T.useState)(""),Lt=(De="")=>{on(De)},sn=async De=>{const{type:$t,evaluateEvery:zt}=De;if(qt!==""){je.error(qt),!c&&vt&&(0,C.Yk)();return}(0,C.nf)({formAction:c?"update":"create",ruleType:$t});const Mt=vt?(0,$.Z9)(De):(0,$.l1)(De),Nt=c?(0,P.I2)(c):(0,P.j_)(De),_t=(0,P.j_)(De);let Kt;if(c){const Ft=(0,re.mw)(Nt,c.rule);Kt=await Ge.execute(Nt,Ft,Mt,_t,zt)}else if(Pt(De),Kt=await Ye.execute(Nt,Mt,zt),vt){const Ft=De.queries.filter(Wt=>!(0,le.f)(Wt.model)),bt=De.queries.filter(Wt=>(0,fe.Oy)(Wt));(0,C.Gn)({simplifiedQueryEditor:De.editorSettings?.simplifiedQueryEditor??!1,simplifiedNotificationEditor:De.editorSettings?.simplifiedNotificationEditor??!1,canBeTransformedToSimpleQuery:(0,fe.Nx)(Ft,bt)})}Ie(Mt,_t,Kt)},dt=De=>{(0,C.IR)({grafana_version:K.$.buildInfo.version,org_id:ee.TP.user.orgId,user_id:ee.TP.user.id,error:Object.keys(De).toString(),formAction:c?"update":"create"}),je.error("There are errors in the form. Please correct them and try again!")},ln=()=>{(0,C.fH)(C.le.cancelSavingAlertRule),(0,C.Rk)({formAction:c?"update":"create"}),!c&&vt&&(0,C.vO)(),V.Ny.getHistory().goBack()};if(!nt)return null;const Ce=P.p.grafana.rule(c?.rule)&&(0,P.hC)(c?.rule);return(0,e.jsxs)(I.Op,{...ht,children:[(0,e.jsx)("form",{onSubmit:De=>De.preventDefault(),className:W.form,children:(0,e.jsxs)("div",{className:W.contentOuter,children:[w&&(0,e.jsx)(u.F,{severity:"warning",title:(0,p.t)("alerting.alertVersionHistory.warning-restore-manually-title","Restoring rule manually"),children:(0,e.jsx)(p.x6,{i18nKey:"alerting.alertVersionHistory.warning-restore-manually",children:"You are manually restoring an old version of this alert rule. Please review the changes carefully before saving the rule definition."})}),Ce&&(0,e.jsx)(q.A,{}),(0,e.jsxs)(pe.B,{direction:"column",gap:3,children:[(0,e.jsx)(Se.H,{}),(0,e.jsx)(O.b,{origin:"alert-rule",shouldShowFeedbackButton:!0,useRouteDetection:!0}),(0,e.jsx)(Ut.N,{editingExistingRule:!!c,onDataChange:Lt,mode:"edit"}),Tt&&(0,e.jsxs)(e.Fragment,{children:[(0,P.H2)(nt)&&(0,e.jsx)(Ne.d,{}),(0,P.BL)(nt)&&(0,e.jsx)(Ae,{}),(0,P.OF)(nt)&&(0,e.jsx)(Et,{}),(0,P.H2)(nt)&&(0,e.jsx)(Le.H$,{existing:!!c,enableProvisionedGroups:!1}),(0,e.jsx)(st.N,{alertUid:H}),!(0,P.vE)(nt)&&(0,e.jsx)(Me.A,{})]}),(0,e.jsxs)(pe.B,{direction:"row",alignItems:"center",children:[(0,e.jsx)(R.$n,{"data-testid":"save-rule",variant:"primary",type:"button",onClick:Xt(De=>sn(De),dt),disabled:Bt,icon:Bt?"spinner":void 0,children:(0,e.jsx)(p.x6,{i18nKey:"alerting.alert-rule-form.action-buttons.save",children:"Save"})}),(0,e.jsx)(R.$n,{variant:"secondary",disabled:Bt,type:"button",onClick:ln,children:(0,e.jsx)(p.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})}),c&&pt(St)&&(0,e.jsx)(R.$n,{variant:"secondary",type:"button",onClick:()=>He(!0),disabled:Bt,children:(0,e.jsx)(p.x6,{i18nKey:"alerting.alert-rule-form.action-buttons.edit-yaml",children:"Edit YAML"})})]})]})]})}),qe&&(0,e.jsxs)(e.Fragment,{children:[vt&&H&&(0,e.jsx)(Pe,{alertUid:H,onClose:()=>He(!1)}),!vt&&(0,e.jsx)(it.G_,{onClose:()=>He(!1)})]})]})};function gt(c){const h=(0,ce._2)(),w=(0,T.useCallback)(U=>{const H=(U.created?.at(0)||U.updated?.at(0))??c;H?V.Ny.replace(Ee.PP.detailsPageLink("grafana",{uid:H,ruleSourceName:"grafana"},void 0,{skipSubPath:!0})):(h.error("Cannot navigate to the new rule details page.","The rule was created but the UID is missing."),(0,C.FF)("Cannot navigate to the new rule details page. The rule was created but the UID is missing."))},[c,h]),W=(0,T.useCallback)((U,H)=>{const{dataSourceName:Ie,namespaceName:qe,groupName:He}=H,Ye=(0,re.P1)(Ie,qe,He,U);V.Ny.replace(Ee.PP.detailsPageLink(Ye.ruleSourceName,Ye,void 0,{skipSubPath:!0}))},[]);return{redirectToDetailsPage:(0,T.useCallback)((U,H,Ie)=>{if(Z(Ie)){w(Ie);return}else if(P.p.dataSource.rule(U)){W(U,H);return}(0,C.FF)("Cannot navigate to the new rule details page. The response is not a GrafanaGroupUpdatedResponse and ruleDefinition is not a Cloud Ruler rule.",{ruleFormType:P.p.dataSource.rule(U)?"datasource":"grafana"})},[w,W])}}const pt=c=>{const[h,w]=c(["type","dataSourceName"]);return(h===S.Z.cloudAlerting||h===S.Z.cloudRecording)&&w!==""};function Pt(c){const{manualRouting:h,editorSettings:w}=c;h?localStorage.setItem($.Q8,"true"):localStorage.setItem($.Q8,"false"),w&&(w.simplifiedQueryEditor?localStorage.setItem($.Os,"true"):localStorage.setItem($.Os,"false"))}const Qt=c=>({form:(0,s.css)({width:"100%",height:"100%",display:"flex",flexDirection:"column"}),contentOuter:(0,s.css)({background:c.colors.background.primary,overflow:"hidden",maxWidth:c.breakpoints.values.xl,flex:1})});var It=t(20962),Gt=t(88721),Ct=t(88547),wt=t(41517),Vt=t(44109),Ot=t(12770),Dt=t(95443),m=t(77256),A=t(2543),b=t(14055);function F(c,h){P.p.grafana.rule(c)&&(c.grafana_alert.title=h),P.p.dataSource.alertingRule(c)&&(c.alert=h),P.p.dataSource.recordingRule(c)&&(c.record=h)}function J(c){const h=(0,A.cloneDeep)(c);return F(h.rule,(0,b.V)((0,P.qz)(h.rule),h.group.rules.map(P.qz))),P.p.grafana.rule(h.rule)&&(h.rule.grafana_alert.uid="",h.rule.grafana_alert.provenance&&(h.group={name:"",rules:h.group.rules})),h}function _({identifier:c,prefill:h,isManualRestore:w=!1,clone:W=!1}){const je=re.VY(c),{loading:U,result:H,error:Ie}=(0,Vt.Ll)({ruleIdentifier:c}),{isEditable:qe,loading:He,error:Ye}=(0,Ot.g)(je,H?.rule);if(Ie||Ye)return(0,e.jsx)(k.d,{navId:"alert-list",pageNav:X(),children:(0,e.jsx)(u.F,{severity:"error",title:(0,p.t)("alerting.existing-rule-editor.title-failed-to-load-rule","Failed to load rule"),children:(0,m.JZ)(Ye??Ie)})});const Ge=U||He;if(Ge)return(0,e.jsx)(k.d,{navId:"alert-list",pageNav:X(),isLoading:!0,children:null});if(!H&&!Ge)return(0,e.jsx)(k.d,{navId:"alert-list",pageNav:X(),children:(0,e.jsx)(y,{title:(0,p.t)("alerting.existing-rule-editor.title-rule-not-found","Rule not found"),children:(0,e.jsx)(p.x6,{i18nKey:"alerting.existing-rule-editor.sorry-this-rule-does-not-exist",children:"Sorry! This rule does not exist."})})});if(qe===!1)return(0,e.jsx)(k.d,{navId:"alert-list",pageNav:X(),children:(0,e.jsx)(y,{title:(0,p.t)("alerting.existing-rule-editor.title-cannot-edit-rule","Cannot edit rule"),children:(0,e.jsx)(p.x6,{i18nKey:"alerting.existing-rule-editor.sorry-permission",children:"Sorry! You do not have permission to edit this rule."})})});if(!H)return null;const tt=H.rule,mt=P.p.any.alertingRule(tt)?tt.annotations?.[Dt.YH.summary]:null,ht=(0,P.YN)(H.group),St=P.p.any.recordingRule(tt)?(0,p.t)("alerting.editor.edit-recording-rule","Edit recording rule"):(0,p.t)("alerting.editor.edit-alert-rule","Edit alert rule");return(0,e.jsx)(k.d,{navId:"alert-list",subTitle:(0,e.jsxs)(pe.B,{direction:"column",children:[mt,ht&&(0,e.jsx)(wt.X,{})]}),pageNav:X({text:St}),children:W?(0,e.jsx)(Rt,{prefill:(0,$.QX)(J(H))}):(0,e.jsx)(Rt,{existing:H,prefill:h,isManualRestore:w})})}const X=c=>({...te,id:"alert-rule-edit",text:"",...c}),te={id:"alert-rule-view"},Xe=()=>{const{identifier:c}=Qe(),h=lt(),w=Ze(),{canCreateGrafanaRules:W,canCreateCloudRules:je,canEditRules:U}=(0,Gt.V)();return!c&&!W&&!je?(0,e.jsx)(y,{title:(0,p.t)("alerting.rule-editor.get-content.title-cannot-create-rules","Cannot create rules"),children:(0,e.jsx)(p.x6,{i18nKey:"alerting.rule-editor.get-content.sorry-allowed-create-rules",children:"Sorry! You are not allowed to create rules."})}):c&&!U(c.ruleSourceName)?(0,e.jsx)(y,{title:(0,p.t)("alerting.rule-editor.get-content.title-cannot-edit-rules","Cannot edit rules"),children:(0,e.jsx)(p.x6,{i18nKey:"alerting.rule-editor.get-content.sorry-allowed-rules",children:"Sorry! You are not allowed to edit rules."})}):c?(0,e.jsx)(_,{identifier:c,isManualRestore:w},JSON.stringify(c)):h?(0,e.jsx)(_,{identifier:h,clone:!0,isManualRestore:w},JSON.stringify(c)):(0,e.jsx)(Ke,{})},ke=["grafana-recording","recording"];function Ke(){const c=Fe(),h=Ze(),{type:w="",identifier:W=""}=Qe(),je=!!W,U=ke.includes(w),H=U?(0,p.t)("alerting.editor.new-recording-rule","New recording rule"):(0,p.t)("alerting.editor.new-alert-rule","New alert rule"),Ie=U?(0,p.t)("alerting.editor.edit-recording-rule","Edit recording rule"):(0,p.t)("alerting.editor.edit-alert-rule","Edit alert rule");return(0,e.jsx)(k.d,{navId:"alert-list",pageNav:{id:"alert-rule-add",text:je?Ie:H},children:(0,e.jsx)(Rt,{prefill:c,isManualRestore:h})})}const Ue=(0,Ct.S)(Xe);function Qe(){const c=(0,f.g)(),{type:h}=c,w=re.uE(c);return{identifier:re.x6(w,!0),type:h}}function lt(){const[c]=(0,It.l)(),h=c.get("copyFrom")??void 0;return re.x6(h)}function Fe(){const{type:c}=Qe(),[h]=(0,It.l)(),w=(0,ae._u)(c);return h.has("defaults")?(0,ae.JG)(h.get("defaults")??"",w):void 0}function Ze(){const[c]=(0,It.l)();return c.has("isManualRestore")}},24296:(We,Y,t)=>{t.d(Y,{z:()=>u});var e=t(96540),f=t(55143),p=t(52161);const{useLazyDiscoverDsFeaturesQuery:s}=f.L;function u(){const[z,R]=(0,e.useState)([]),[y,{isLoading:l}]=s();return(0,e.useEffect)(()=>{(0,p.qi)().forEach(async T=>{const{data:I}=await y({uid:T.uid},!0);I?.rulerConfig&&R(K=>[...K,T])})},[y]),{rulesSourcesWithRuler:z,isLoading:l}}},25197:(We,Y,t)=>{t.d(Y,{A:()=>u});var e=t(74848),f=t(92745),p=t(22787),s=t(8402);function u({isOpen:z,onClose:R,dataSourceName:y,initialLabels:l}){return(0,e.jsx)(p.a,{title:(0,f.t)("alerting.labels-editor-modal.title-edit-labels","Edit labels"),closeOnEscape:!0,isOpen:z,onDismiss:()=>R(),children:(0,e.jsx)(s.C1,{dataSourceName:y,onClose:R,initialLabels:l})})}},28124:(We,Y,t)=>{t.r(Y),t.d(Y,{default:()=>le});var e=t(74848),f=t(96540),p=t(54148),s=t(92745),u=t(36490),z=t(6975),R=t(34999),y=t(44109),l=t(84523),k=t(77256),T=t(94646),I=t(29609),K=t(92367),V=t(88547),pe=t(36826),ce=t(74143);function ee(){const{id:C}=(0,p.g)(),Z=(0,f.useMemo)(()=>T.x6(C,!0),[C]);return Z?(0,e.jsx)(q,{ruleIdentifier:Z}):(0,e.jsx)(R.F,{title:(0,s.t)("alerting.grafana-modify-export.title-invalid-rule-id","Invalid rule ID"),severity:"error",children:(0,e.jsx)(s.x6,{i18nKey:"alerting.grafana-modify-export.body-invalid-rule-id",children:"The rule UID in the page URL is invalid. Please check the URL and try again."})})}function q({ruleIdentifier:C}){const{loading:Z,error:ue,result:O}=(0,y.Ll)({ruleIdentifier:C});return Z?(0,e.jsx)(z._,{text:(0,s.t)("alerting.rule-modify-export.text-loading-the-rule","Loading the rule...")}):ue?(0,e.jsx)(R.F,{title:(0,s.t)("alerting.rule-modify-export.title-cannot-load-modify-export","Cannot load modify export"),severity:"error",children:(0,k.JZ)(ue)}):!O&&!Z?(0,e.jsx)(R.F,{title:(0,s.t)("alerting.rule-modify-export.title-cannot-exist","Cannot load the rule. The rule does not exist"),buttonContent:"Go back to alert list",onRemove:()=>u.Ny.replace((0,K.G)("/alerting/list"))}):O&&!I.p.grafana.rule(O.rule)?(0,e.jsx)(R.F,{title:(0,s.t)("alerting.rule-modify-export.title-grafanamanaged-alert","This rule is not a Grafana-managed alert rule"),buttonContent:"Go back to alert list",onRemove:()=>u.Ny.replace((0,K.G)("/alerting/list"))}):O&&I.p.grafana.rule(O.rule)?(0,e.jsx)(ce.nZ,{ruleForm:(0,l.ir)(O),alertUid:O.rule.grafana_alert.uid}):(0,e.jsx)(R.F,{title:(0,s.t)("alerting.rule-modify-export.title-unknown-error","Unknown error")})}function P(){return(0,e.jsx)(pe.d,{navId:"alert-list",pageNav:{text:(0,s.t)("alerting.grafana-modify-export-page.text.modify-export","Modify export"),subTitle:"Modify the current alert rule and export the rule definition in the format of your choice. Any changes you make will not be saved."},children:(0,e.jsx)(ee,{})})}const le=(0,V.S)(P)},38133:(We,Y,t)=>{t.d(Y,{q:()=>u});var e=t(74848),f=t(96540),p=t(76792),s=t(24296);function u({value:z,disabled:R,...y}){const{rulesSourcesWithRuler:l,isLoading:k}=(0,s.z)(),T=(0,f.useCallback)(I=>l.some(({uid:K})=>K===I.uid),[l]);return(0,e.jsx)(p.sk,{disabled:k||R,noDefault:!0,alerting:!0,filter:T,current:z,...y})}},61293:(We,Y,t)=>{t.d(Y,{x:()=>ee});var e=t(74848),f=t(22803),p=t(96540),s=t(51898),u=t(92745),z=t(22787),R=t(45861),y=t(41654),l=t(72636),k=t(37386),T=t(63527),I=t(63142),K=t(98970),V=t(64762),pe=t(73427),ce=t(11257);const ee=({onCreate:le})=>{const[C,Z]=(0,p.useState)(!1),ue=O=>{le(O),Z(!1)};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(R.$n,{onClick:()=>Z(!0),type:"button",icon:"plus",fill:"outline",variant:"secondary",disabled:!pe.TP.hasPermission(ce.w.FoldersCreate),children:(0,e.jsx)(u.x6,{i18nKey:"alerting.create-new-folder.new-folder",children:"New folder"})}),C&&(0,e.jsx)(q,{onCreate:ue,onClose:()=>Z(!1)})]})};function q({onClose:le,onCreate:C}){const Z=(0,I.of)(P),ue=(0,V._2)(),[O,D]=(0,p.useState)(""),[ae,fe]=(0,p.useState)(!1),[S]=(0,K.Si)(),Ee=async()=>{fe(!0);const{data:$,error:re}=await S({title:O});re?ue.error("Failed to create folder"):$&&(C({title:$.title,uid:$.uid}),ue.success("Folder created")),fe(!1)};return(0,e.jsx)(z.a,{className:Z.modal,isOpen:!0,title:(0,u.t)("alerting.create-new-folder.title-new-folder","New folder"),onDismiss:le,onClickBackdrop:le,children:(0,e.jsxs)(y.B,{direction:"column",gap:2,children:[(0,e.jsx)(k.D,{label:(0,e.jsx)(l.J,{htmlFor:"folder",children:(0,e.jsx)(u.x6,{i18nKey:"alerting.create-new-folder.folder.name",children:"Folder name"})}),children:(0,e.jsx)(T.p,{"data-testid":s.Tp.components.AlertRules.newFolderNameField,autoFocus:!0,id:"folderName",placeholder:(0,u.t)("alerting.create-new-folder.placeholder-enter-a-name","Enter a name"),value:O,onChange:$=>D($.currentTarget.value)})}),(0,e.jsxs)(z.a.ButtonRow,{children:[(0,e.jsx)(R.$n,{variant:"secondary",type:"button",onClick:le,children:(0,e.jsx)(u.x6,{i18nKey:"alerting.create-new-folder.folder.cancel",children:"Cancel"})}),(0,e.jsx)(R.$n,{onClick:Ee,disabled:!O||ae,"data-testid":s.Tp.components.AlertRules.newFolderNameCreateButton,children:(0,e.jsx)(u.x6,{i18nKey:"alerting.create-new-folder.folder.create",children:"Create"})})]})]})})}const P=le=>({modal:(0,f.css)({width:`${le.breakpoints.values.sm}px`})})},63008:(We,Y,t)=>{t.d(Y,{L:()=>ie,g:()=>Be});var e=t(74848),f=t(22803),p=t(96540),s=t(49785),u=t(1604),z=t(46662),R=t(80011),y=t(28105),l=t(92745),k=t(78282),T=t(63142),I=t(41654),K=t(45861),V=t(34999),pe=t(62467),ce=t(81160),ee=t(66847),q=t(1005),P=t(47520),le=t(77154),C=t(22592),Z=t(68143),ue=t(97534);function O(N){return"expr"in N}function D(N){return"grafana_condition"in N}var ae=t(67817),fe=t(52161);function S(N){if(O(N))return Ee(N,N.dataSourceUid,ae.Z.cloudAlerting);if(D(N))return Ee(N,fe.hY,ae.Z.grafana);throw new Error("unsupported preview rule request")}function Ee(N,ye,ge){return(0,P.k)({whileLoading:$(ge),source:(0,Z.AI)().fetch({method:"POST",url:`/api/v1/rule/test/${ye}`,data:N}).pipe((0,ce.T)(({data:M})=>$(ge,{state:y.Gu.Done,series:M.instances.map(le.or)})),(0,ee.W)(M=>(0,pe.of)($(ge,{state:y.Gu.Error,error:(0,ue.u)(M)}))),(0,q.u)())})}function $(N,ye={}){return{ruleType:N,data:{state:y.Gu.Loading,series:[],timeRange:(0,C.E2)(),...ye}}}var re=t(55096),ot=t(29609),we=t(70713),de=t(57866),oe=t(60311),xe=t(739),se=t(36200);function Pe(N){const{preview:ye}=N,ge=(0,T.of)(Se),M={defaults:{},overrides:[{matcher:{id:de.Ct.byName,options:"Info"},properties:[{id:"custom.displayMode",value:xe.ob.JSONView}]}]};if(!ye)return null;const{data:Ae,ruleType:ze}=ye;return Ae.state===y.Gu.Loading?(0,e.jsx)("div",{className:ge.container,children:(0,e.jsx)("span",{children:(0,e.jsx)(l.x6,{i18nKey:"alerting.preview-rule-result.loading-preview",children:"Loading preview..."})})}):Ae.state===y.Gu.Error?(0,e.jsx)("div",{className:ge.container,children:Ae.error?(0,se.CZ)(Ae.error):(0,l.t)("alerting.preview-rule-result.preview-failed","Failed to preview alert rule")}):(0,e.jsxs)("div",{className:ge.container,children:[(0,e.jsx)(l.x6,{i18nKey:"alerting.preview-rule-result.preview-based-on-query-result",children:"Preview based on the result of running the query, for this moment."}),ze===ae.Z.grafana&&(0,e.jsx)(l.x6,{i18nKey:"alerting.preview-rule-result.no-data-error-handling-not-applied",children:"Configuration for `no data` and `error handling` is not applied."}),(0,e.jsx)("div",{className:ge.table,children:(0,e.jsx)(we.Ay,{children:({width:Le,height:Ne})=>(0,e.jsx)("div",{style:{width:`${Le}px`,height:`${Ne}px`},children:(0,e.jsx)(oe.m,{title:"",width:Le,height:Ne,pluginId:"table",data:Ae,fieldConfig:M})})})})]})}function Se(N){return{container:(0,f.css)({margin:`${N.spacing(2)} 0`}),table:(0,f.css)({flex:"1 1 auto",height:"135px",marginTop:N.spacing(2),border:`1px solid ${N.colors.border.medium}`,borderRadius:N.shape.radius.default})}}const Me=["type","dataSourceName","condition","queries","expression"];function ie(){const N=(0,T.of)(Je),[ye,ge]=Be(),{watch:M}=(0,s.xW)(),[Ae,ze,Le]=M(["type","condition","queries"]),{allDataSourcesAvailable:Ne}=(0,re.g)(Le);if(!Ae||(0,ot.s_)(Ae))return null;const st=!!ze&&Ne;return(0,e.jsxs)("div",{className:N.container,children:[(0,e.jsxs)(I.B,{children:[Ne&&(0,e.jsx)(K.$n,{disabled:!st,type:"button",variant:"primary",onClick:ge,children:(0,e.jsx)(l.x6,{i18nKey:"alerting.preview-rule.preview-alerts",children:"Preview alerts"})}),!Ne&&(0,e.jsx)(V.F,{title:(0,l.t)("alerting.preview-rule.title-preview-is-not-available","Preview is not available"),severity:"warning",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.preview-rule.body-preview-is-not-available",children:"Cannot display the query preview. Some of the data sources used in the queries are not available."})})]}),(0,e.jsx)(Pe,{preview:ye})]})}function Be(){const[N,ye]=(0,p.useState)(),{getValues:ge}=(0,s.xW)(),M=(0,u.A)(),Ae=(0,p.useCallback)(()=>{const ze=ge(Me),Le=ve(ze);S(Le).pipe((0,z.v)(Ne=>!ut(Ne),!0)).subscribe(Ne=>{M()&&ye(Ne)})},[ge,M]);return[N,Ae]}function ve(N){const[ye,ge,M,Ae,ze]=N,Le=(0,k.l)().getInstanceSettings(ge);if(!Le)throw new Error(`Cannot find data source settings for ${ge}`);switch(ye){case ae.Z.cloudAlerting:return{dataSourceUid:Le.uid,dataSourceName:ge,expr:ze};case ae.Z.grafana:return{grafana_condition:{condition:M,data:Ae,now:(0,R.M7)(Date.now())}};default:throw new Error(`Alert type ${ye} not supported by preview.`)}}function ut(N){switch(N.data.state){case y.Gu.Done:case y.Gu.Error:return!0;default:return!1}}function Je(N){return{container:(0,f.css)({marginTop:N.spacing(2),maxWidth:`${N.breakpoints.values.xxl}px`})}}},73228:(We,Y,t)=>{t.d(Y,{N:()=>er});var e=t(74848),f=t(22803),p=t(2543),s=t(96540),u=t(49785),z=t(94701),R=t(22592),y=t(51898),l=t(92745),k=t(43173),T=t(78282),I=t(63142),K=t(41654),V=t(66404),pe=t(37386),ce=t(3271),ee=t(45967),q=t(45861),P=t(34999),le=t(71599),C=t(87063),Z=t(94535),ue=t(88559),O=t(44022),D=t(4651),ae=t(24296),fe=t(6194),S=t(67817),Ee=t(52161),$=t(20437),re=t(29609),ot=t(16817),we=t(28105),de=t(62392),oe=t(1906),xe=t(37658),se=t(30703),Pe=t(39659),Se=t(65420),Me=t(24619);function ie({fields:n}){const a=n.filter(x=>!["State","Info"].includes(x.name)),r=n.findIndex(x=>x.name==="State"),o=n.findIndex(x=>x.name==="Info"),i=a.map(x=>n.indexOf(x)),d=n[r]?.values.length??0,g=[];for(let x=0;x<d;x++){const B=i.map(E=>[n[E].name,n[E].values[x]]),L=n[r]?.values?.[x],v=n[o]?.values?.[x];(0,Me.s1)(L)&&g.push({state:L,info:v,labels:Object.fromEntries(B)})}return{instances:g}}function Be({preview:n}){const a=(0,I.of)(ve),r=ie(n);return(0,e.jsxs)("table",{className:a.table,children:[(0,e.jsxs)("caption",{children:[(0,e.jsx)("div",{children:(0,e.jsx)(l.x6,{i18nKey:"alerting.cloud-alert-preview.alerts-preview",children:"Alerts preview"})}),(0,e.jsx)("span",{children:(0,e.jsx)(l.x6,{i18nKey:"alerting.cloud-alert-preview.running-query-preview",children:"Preview based on the result of running the query for this moment."})})]}),(0,e.jsx)("thead",{children:(0,e.jsxs)("tr",{children:[(0,e.jsx)("th",{children:(0,e.jsx)(l.x6,{i18nKey:"alerting.cloud-alert-preview.state",children:"State"})}),(0,e.jsx)("th",{children:(0,e.jsx)(l.x6,{i18nKey:"alerting.cloud-alert-preview.labels",children:"Labels"})}),(0,e.jsx)("th",{children:(0,e.jsx)(l.x6,{i18nKey:"alerting.cloud-alert-preview.info",children:"Info"})})]})}),(0,e.jsx)("tbody",{children:r.instances.map(({state:o,info:i,labels:d},g)=>{const x=(0,Pe.M4)(d);return(0,e.jsxs)("tr",{children:[(0,e.jsx)("td",{children:(0,e.jsx)(Se.C,{state:o})}),(0,e.jsx)("td",{children:(0,e.jsx)(xe.L,{tags:x,className:a.tagList})}),(0,e.jsx)("td",{children:i&&(0,e.jsx)(ee.m,{content:i,children:(0,e.jsx)(se.I,{name:"info-circle"})})})]},g)})})]})}const ve=n=>({table:(0,f.css)({width:"100%",margin:n.spacing(2,0),caption:{captionSide:"top",color:n.colors.text.primary,"& > span":{fontSize:n.typography.bodySmall.fontSize,color:n.colors.text.secondary}},"td, th":{padding:n.spacing(1,1)},"td + td, th + th":{paddingLeft:n.spacing(3)},"thead th":{"&:nth-child(1)":{width:"80px"},"&:nth-child(2)":{width:"auto"},"&:nth-child(3)":{width:"40px"}},"td:nth-child(3)":{textAlign:"center"},"tbody tr:nth-child(2n + 1)":{backgroundColor:n.colors.background.secondary}}),tagList:(0,f.css)({justifyContent:"flex-start"})});var ut=t(63008);const Je=({value:n,onChange:a,dataSourceName:r,showPreviewAlertsButton:o=!0})=>{const i=(0,I.of)(N),{mapToValue:d,mapToQuery:g}=ye(r),x=g({refId:"A",hide:!1},n),{error:B,loading:L,value:v}=(0,ot.A)(()=>(0,T.l)().get(r),[r]),E=(0,s.useCallback)(he=>{a(d(he))},[a,d]),[Re,Ve]=(0,ut.g)(),me=async()=>{Ve()};if(L||v?.name!==r)return null;const Q=(0,T.l)().getInstanceSettings(r);if(B||!v||!v?.components?.QueryEditor||!Q){const he=B?.message||(0,l.t)("alerting.expression-editor.error-no-component","Data source plugin does not export any Query Editor component");return(0,e.jsx)("div",{children:(0,e.jsxs)(l.x6,{i18nKey:"alerting.expression-editor.could-not-load-editor",children:["Could not load query editor due to: ",{errorMessage:he}]})})}const ne=Re?.data.state===we.Gu.Done,ft=v?.components?.QueryEditor,_e=Re?.data?.series?.find(he=>he.name==="evaluation results"),Oe=_e&&_e.fields.some(he=>he.values.length>0);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(de.p,{instanceSettings:Q,children:(0,e.jsx)(ft,{query:x,queries:[x],app:oe.Jk.CloudAlerting,onChange:E,onRunQuery:p.noop,datasource:v})}),o&&(0,e.jsxs)("div",{className:i.preview,children:[(0,e.jsx)(q.$n,{type:"button",onClick:me,disabled:Re?.data.state===we.Gu.Loading,children:(0,e.jsx)(l.x6,{i18nKey:"alerting.expression-editor.preview-alerts",children:"Preview alerts"})}),ne&&!Oe&&(0,e.jsx)(P.F,{title:(0,l.t)("alerting.expression-editor.title-alerts-preview","Alerts preview"),severity:"info",className:i.previewAlert,children:(0,e.jsx)(l.x6,{i18nKey:"alerting.expression-editor.there-firing-alerts-query",children:"There are no firing alerts for your query."})}),Oe&&(0,e.jsx)(Be,{preview:_e})]})]})},N=n=>({preview:(0,f.css)({padding:n.spacing(2,0),maxWidth:`${n.breakpoints.values.xl}px`}),previewAlert:(0,f.css)({margin:n.spacing(1,0)})});function ye(n){return(0,s.useMemo)(()=>{const a=(0,T.l)().getInstanceSettings(n);if(!a)throw new Error(`Datasource ${n} not found`);if(!(0,Ee.cl)(a.type))throw new Error(`${a.type} is not supported as an expression editor`);return{mapToValue:r=>r.expr,mapToQuery:(r,o)=>({...r,expr:o})}},[n])}var ge=t(51993),M=t(55376);const Ae=({condition:n,onSetCondition:a,queries:r,panelData:o,onUpdateRefId:i,onRemoveExpression:d,onUpdateExpressionType:g,onUpdateQueryExpression:x})=>{const B=(0,s.useMemo)(()=>r.reduce((v,E)=>(0,O.f)(E.model)?v.concat(E.model):v,[]),[r]),L=(0,I.of)(ze);return(0,e.jsx)("div",{className:L.wrapper,children:B.map(v=>{const E=o[v.refId],Re=n===v.refId,Ve=E&&Re?(0,M.zy)(E):void 0,Q=(E?(0,M.lb)(E):void 0)||Ve,ne=E?(0,M.yr)(E.series):void 0;return(0,e.jsx)(ge.r4,{isAlertCondition:Re,data:E,error:Q,warning:ne,queries:r,query:v,onSetCondition:a,onRemoveExpression:d,onUpdateRefId:i,onUpdateExpressionType:g,onChangeQuery:x},v.refId)})})},ze=n=>({wrapper:(0,f.css)({display:"flex",gap:n.spacing(2),alignContent:"stretch",flexWrap:"wrap"})});var Le=t(25521),Ne=t(21835),st=t(17548),Et=t(48480),it=t(8073),Ut=t(85348),Rt=t(28998),gt=t(18027),pt=t(63527),Pt=t(74268),Qt=t(96041),It=t(15629),Gt=t(38076),Ct=t(54092),wt=t(46907),Vt=t(92138),Ot=t(36490),Dt=t(22787);function m(n){const{onDismiss:a,path:r,title:o}=n,i=()=>{t.g.open(Vt.I.assureBaseUrl(r),"_blank"),a()},d=()=>Ot.Ny.push(r);return(0,e.jsxs)(Dt.a,{title:o,isOpen:!0,onDismiss:a,children:[(0,e.jsx)(K.B,{direction:"column",gap:1,children:(0,e.jsx)("p",{children:(0,e.jsx)(l.x6,{i18nKey:"explore.confirm-navigation-modal.new-tab",children:"Do you want to proceed in the current tab or open a new tab?"})})}),(0,e.jsxs)(Dt.a.ButtonRow,{children:[(0,e.jsx)(q.$n,{onClick:a,fill:"outline",variant:"secondary",children:(0,e.jsx)(l.x6,{i18nKey:"explore.confirm-navigation-modal.cancel",children:"Cancel"})}),(0,e.jsx)(q.$n,{type:"submit",variant:"secondary",onClick:i,icon:"external-link-alt",children:(0,e.jsx)(l.x6,{i18nKey:"explore.confirm-navigation-modal.open-in-new-tab",children:"Open in new tab"})}),(0,e.jsx)(q.$n,{type:"submit",variant:"primary",onClick:d,icon:"apps",children:(0,e.jsx)(l.x6,{i18nKey:"explore.confirm-navigation-modal.open",children:"Open"})})]})]})}var A=t(7895);function b({extensions:n,onSelect:a}){const{categorised:r,uncategorised:o}=J(n),i=o.length>0&&Object.keys(r).length>0;return(0,e.jsx)(C.W,{children:(0,e.jsxs)(e.Fragment,{children:[Object.keys(r).map(d=>(0,e.jsx)(C.W.Group,{label:d,children:F(r[d],a)},d)),i&&(0,e.jsx)(C.W.Divider,{},"divider"),F(o,a)]})})}function F(n,a){return n.map(r=>(0,e.jsx)(C.W.Item,{ariaLabel:r.title,icon:r?.icon||"plug",label:r.title,onClick:o=>{if(r.path)return a(r);r.onClick?.(o)}},r.id))}function J(n){return(0,s.useMemo)(()=>{const a=[],r={};for(const o of n){if(!o.category){a.push(o);continue}Array.isArray(r[o.category])||(r[o.category]=[]),r[o.category].push(o)}return{uncategorised:a,categorised:r}},[n])}function _(n){const{links:a,setSelectedExtension:r,setIsModalOpen:o,isModalOpen:i}=n;if(a.length===0)return;const d=(0,e.jsx)(b,{extensions:a,onSelect:r});if(a.length===1){const g=(0,p.first)(a);return(0,e.jsx)(A.I,{variant:"canvas",icon:g.icon,onClick:()=>r(g),children:(0,e.jsx)(l.x6,{i18nKey:"explore.toolbar.add-to-queryless-extensions",children:"Go queryless"})})}return(0,e.jsx)(ue.m,{onVisibleChange:o,placement:"bottom-start",overlay:d,children:(0,e.jsx)(A.I,{"aria-label":(0,l.t)("explore.queryless-apps-extensions.aria-label-go-queryless","Go queryless"),variant:"canvas",isOpen:i,children:(0,e.jsx)(l.x6,{i18nKey:"explore.toolbar.add-to-queryless-extensions",children:"Go queryless"})})})}const X=["grafana-pyroscope-app","grafana-lokiexplore-app","grafana-exploretraces-app","grafana-metricsdrilldown-app"],te={prometheus:["grafana-metricsdrilldown-app"]};function Xe({extensionsToShow:n,query:a}){const[r,o]=(0,s.useState)(),[i,d]=(0,s.useState)(!1),g={targets:[a]},{links:x}=(0,wt.U)({extensionPointId:Ct.SM.AlertingRuleQueryEditor,context:g,limitPerPlugin:3}),B=x.filter(L=>{if(!X.includes(L.pluginId))return!1;const v=a.datasource?.type;return v?(te[v.toLowerCase()]||[]).includes(L.pluginId):!1});return(0,e.jsxs)(e.Fragment,{children:[n==="queryless"&&(0,e.jsx)(_,{links:B,setSelectedExtension:L=>{o(L)},setIsModalOpen:d,isModalOpen:i}),!!r&&!!r.path&&(0,e.jsx)(m,{path:r.path,title:r.title,onDismiss:()=>o(void 0)})]})}var ke=t(25229),Ke=t(59243),Ue=t(90929);const Qe=({query:n,queryOptions:a,onChangeTimeRange:r,onChangeQueryOptions:o,index:i})=>{const d=(0,I.of)(lt),[g,x]=(0,s.useState)(!1),B=n.relativeTimeRange?st.relativeToTimeRange(n.relativeTimeRange):void 0,L=(0,e.jsx)("span",{children:", "});return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(Ke.G,{content:(0,e.jsxs)("div",{className:d.queryOptions,children:[r&&(0,e.jsx)(gt.I,{label:(0,l.t)("alerting.query-options.label-time-range","Time Range"),children:(0,e.jsx)(Ue.N,{timeRange:n.relativeTimeRange??(0,R.Cn)(),onChange:v=>r(v,i)})}),(0,e.jsx)(W,{options:a,onChange:v=>o(v,i)}),(0,e.jsx)(je,{options:a,onChange:v=>o(v,i)})]}),closeButton:!0,placement:"bottom-start",children:(0,e.jsxs)("button",{type:"button",className:d.actionLink,onClick:()=>x(!g),children:[(0,e.jsx)(l.x6,{i18nKey:"alerting.query-options.button-options",children:"Options"})," ",g?(0,e.jsx)(se.I,{name:"angle-right"}):(0,e.jsx)(se.I,{name:"angle-down"})]})}),(0,e.jsxs)("div",{className:d.staticValues,children:[(0,e.jsx)("span",{children:(0,ke.KQ)(B?.from).locale("en").fromNow(!0)}),a.maxDataPoints&&(0,e.jsxs)(e.Fragment,{children:[L,(0,e.jsxs)(l.x6,{i18nKey:"alerting.query-options.max-data-points",values:{maxDataPoints:a.maxDataPoints},children:["MD = ","{{maxDataPoints}}"]})]}),a.minInterval&&(0,e.jsxs)(e.Fragment,{children:[L,(0,e.jsxs)(l.x6,{i18nKey:"alerting.query-options.min-interval",values:{minInterval:a.minInterval},children:["Min. Interval = ","{{minInterval}}"]})]})]})]})},lt=n=>{const a=(0,q.my)(n);return{queryOptions:(0,f.css)({"> div":{justifyContent:"space-between"}}),staticValues:(0,f.css)({color:n.colors.text.secondary,marginRight:n.spacing(1)}),actionLink:(0,f.css)(a,{color:n.colors.text.link,cursor:"pointer","&:hover":{textDecoration:"underline"}})}};var Fe=t(89144);const Ze=43200,c="1s",h=({data:n,error:a,dsSettings:r,index:o,onChangeDataSource:i,onChangeQuery:d,onChangeTimeRange:g,onRunQueries:x,onRemoveQuery:B,onDuplicateQuery:L,query:v,queries:E,thresholds:Re,thresholdsType:Ve,onChangeThreshold:me,condition:Q,onSetCondition:ne,onChangeQueryOptions:ft})=>{const _e=(0,I.of)(U),[Oe,he]=(0,s.useState)(),rt=Oe?.getDefaultQuery?Oe.getDefaultQuery(oe.Jk.UnifiedAlerting):{},{getValues:jt}=(0,u.xW)(),ct=k.$.featureToggles.alertingQueryAndExpressionsStepMode??!1?jt("editorSettings.simplifiedQueryEditor")!==!0:!0,$e={...rt,...(0,p.cloneDeep)(v.model)};$e.datasource&&$e.datasource?.uid!==v.datasourceUid&&((0,Pt.fH)("rule query datasource and datasourceUid mismatch",{queryModelDatasourceUid:$e.datasource?.uid||"",queryDatasourceUid:v.datasourceUid,datasourceType:v.model.datasource?.type||"unknown type"}),typeof $e.datasource=="object"&&$e.datasource?$e.datasource.uid=v.datasourceUid:($e.datasource={},$e.datasource.uid=v.datasourceUid,$e.datasource.type=v.model.datasource?.type,$e.datasource.apiVersion=v.model.datasource?.apiVersion));function Ht(){const Te=(0,I.of)(U);return(0,e.jsx)("div",{className:Te.dsTooltip,children:(0,e.jsx)(ee.m,{content:(0,e.jsx)(l.x6,{i18nKey:"alerting.selecting-data-source-tooltip.tooltip-content",children:"Not finding the data source you want? Some data sources are not supported for alerting. Click on the icon for more information."}),children:(0,e.jsx)(se.I,{name:"info-circle",onClick:()=>window.open(" https://grafana.com/docs/grafana/latest/alerting/fundamentals/data-source-alerting/","_blank")})})})}function mn({query:Te,error:et,index:At,isAdvancedMode:Jt=!0}){const at={maxDataPoints:Te.model.maxDataPoints,minInterval:Te.model.intervalMs?(0,It.yl)(Te.model.intervalMs):void 0},en={maxDataPoints:at.maxDataPoints,minInterval:at.minInterval},tn=Q===Te.refId;return(0,e.jsxs)(K.B,{direction:"row",alignItems:"center",gap:1,children:[(0,e.jsx)(Ht,{}),(0,e.jsx)(Xe,{query:Object.assign({},Te.model),extensionsToShow:"queryless"}),(0,e.jsx)(Qe,{onChangeTimeRange:g,query:Te,queryOptions:en,onChangeQueryOptions:ft,index:At}),Jt&&(0,e.jsx)(Gt.a,{onSetCondition:()=>ne(Te.refId),isCondition:tn})]})}const Yt=n.state!==we.Gu.NotStarted,fn=(0,p.cloneDeep)(E.map(Te=>Te.model)),xn=st.relativeToTimeRange(v.relativeTimeRange??(0,R.Cn)());return(0,e.jsxs)(K.B,{direction:"column",gap:.5,children:[(0,e.jsx)("div",{className:_e.wrapper,children:(0,e.jsx)(Qt.c,{hideRefId:!ct,hideActionButtons:!ct,collapsable:!1,dataSource:r,onDataSourceLoaded:he,onChangeDataSource:Te=>i(Te,o),id:v.refId,index:o,data:n,query:$e,onChange:Te=>d(Te,o),onRemoveQuery:B,onAddQuery:()=>L((0,p.cloneDeep)(v)),onRunQuery:x,queries:fn,range:xn,renderHeaderExtras:()=>(0,e.jsx)(mn,{query:v,index:o,error:a,isAdvancedMode:ct}),app:oe.Jk.UnifiedAlerting,hideHideQueryButton:!0},v.refId)}),Yt&&(0,e.jsx)(Fe.j,{data:n,thresholds:Re,thresholdsType:Ve})]})},w=({children:n})=>{const a=(0,I.of)(U);return(0,e.jsx)("div",{className:a.wrapper,children:n})};function W({options:n,onChange:a}){const r=n.maxDataPoints??"",o=i=>{const d=parseInt(i.target.value,10),g=isNaN(d)||d===0?void 0:d;g!==n.maxDataPoints&&a({...n,maxDataPoints:g})};return(0,e.jsx)(gt.I,{labelWidth:24,label:(0,l.t)("alerting.max-data-points-option.label-max-data-points","Max data points"),tooltip:(0,l.t)("alerting.max-data-points-option.tooltip-max-data-points","The maximum data points per series. Used directly by some data sources and used in calculation of auto interval. With streaming data this value is used for the rolling buffer."),children:(0,e.jsx)(pt.p,{type:"number",width:10,placeholder:Ze.toString(),spellCheck:!1,onBlur:o,defaultValue:r})})}function je({options:n,onChange:a}){const r=n.minInterval??"",o=i=>{const d=i.target.value;d!==r&&a({...n,minInterval:d})};return(0,e.jsx)(gt.I,{label:(0,l.t)("alerting.min-interval-option.label-interval","Interval"),labelWidth:24,tooltip:(0,e.jsxs)(l.x6,{i18nKey:"alerting.min-interval-option.tooltip-interval",children:["Interval sent to the data source. Recommended to be set to write frequency, for example ",(0,e.jsx)("code",{children:"1m"})," if your data is written every minute."]}),children:(0,e.jsx)(pt.p,{type:"text",width:10,placeholder:c,spellCheck:!1,onBlur:o,defaultValue:r})})}const U=n=>({wrapper:(0,f.css)({label:"AlertingQueryWrapper",marginBottom:n.spacing(1),border:`1px solid ${n.colors.border.weak}`,borderRadius:n.shape.radius.default,button:{overflow:"visible"}}),dsTooltip:(0,f.css)({display:"flex",alignItems:"center","&:hover":{opacity:.85,cursor:"pointer"}})});class H extends s.PureComponent{constructor(a){super(a),this.onRemoveQuery=r=>{const{queries:o,onQueriesChange:i}=this.props;i(o.filter(d=>d.refId!==r.refId))},this.onChangeTimeRange=(r,o)=>{const{queries:i,onQueriesChange:d}=this.props;d(i.map((g,x)=>x!==o?g:{...g,relativeTimeRange:r}))},this.onChangeQueryOptions=(r,o)=>{const{queries:i,onQueriesChange:d}=this.props;d(i.map((g,x)=>x!==o?g:{...g,model:{...g.model,maxDataPoints:r.maxDataPoints,intervalMs:r.minInterval?st.intervalToMs(r.minInterval):void 0}}))},this.onChangeDataSource=(r,o)=>{const{queries:i,onQueriesChange:d}=this.props,g=i.map((x,B)=>{if(B!==o)return x;const L=this.getDataSourceSettings(x);return r.type===L?.type?Ie(x,r):qe(x,r)});d(g)},this.onChangeQuery=(r,o)=>{const{queries:i,onQueriesChange:d}=this.props;d(i.map((g,x)=>x!==o?g:{...g,refId:r.refId,queryType:g.model.queryType??"",model:{...g.model,...r,datasource:r.datasource}}))},this.onDragEnd=r=>{const{queries:o,onQueriesChange:i}=this.props;if(!r||!r.destination)return;const d=r.source.index,g=r.destination.index;if(d===g)return;const x=Array.from(o),[B]=x.splice(d,1);x.splice(g,0,B),i(x)},this.getDataSourceSettings=r=>(0,T.l)().getInstanceSettings(r.datasourceUid)}render(){const{queries:a,expressions:r,condition:o}=this.props,i=(0,M.an)([...a,...r],o);return(0,e.jsx)(Ne.JY,{onDragEnd:this.onDragEnd,children:(0,e.jsx)(Ne.gL,{droppableId:"alerting-queries",direction:"vertical",children:d=>(0,e.jsx)("div",{ref:d.innerRef,...d.droppableProps,children:(0,e.jsxs)(K.B,{direction:"column",children:[a.map((g,x)=>{const B=this.props.condition===g.refId,L=this.props.data?.[g.refId]??{series:[],state:we.Gu.NotStarted},v=this.getDataSourceSettings(g);let E;return L&&B?E=(0,M.zy)(L):L&&(E=(0,M.lb)(L)),v?(0,e.jsx)(h,{index:x,dsSettings:v,data:L,error:E,query:g,onChangeQuery:this.onChangeQuery,onRemoveQuery:this.onRemoveQuery,queries:[...a,...r],onChangeDataSource:this.onChangeDataSource,onDuplicateQuery:this.props.onDuplicateQuery,onChangeTimeRange:this.onChangeTimeRange,onChangeQueryOptions:this.onChangeQueryOptions,thresholds:i[g.refId]?.config,thresholdsType:i[g.refId]?.mode,onRunQueries:this.props.onRunQueries,condition:this.props.condition,onSetCondition:this.props.onSetCondition},g.refId):(0,e.jsx)(He,{index:x,model:g.model,onUpdateDatasource:()=>{const Re=(0,Rt.tR)().getInstanceSettings(null);Re&&this.onChangeDataSource(Re,x)},onRemoveQuery:()=>{this.onRemoveQuery(g)}},`${g.refId}-${x}`)}),d.placeholder]})})})})}}function Ie(n,a){return{...n,model:{...(0,p.omit)(n.model,"datasource"),datasource:(0,Et.p$)(a)},datasourceUid:a.uid}}function qe(n,a){const o=(0,O.f)(n)?!1:(0,$.mY)(n),i={refId:n.refId,relativeTimeRange:n.relativeTimeRange,queryType:"",datasourceUid:a.uid,model:{refId:n.refId,hide:!1,datasource:(0,Et.p$)(a)}};return o&&!(0,O.f)(n)&&(i.model.instant=o),i}const He=({index:n,onUpdateDatasource:a,onRemoveQuery:r,model:o})=>{const i=o.refId,[d,g]=(0,s.useState)(!1),x=()=>{g(L=>!L)},B=()=>{a()};return(0,e.jsx)(w,{children:(0,e.jsxs)(Ut.u,{title:i,draggable:!0,index:n,id:i,isOpen:!0,collapsable:!1,children:[(0,e.jsxs)(it.Z,{children:[(0,e.jsx)(it.Z.Heading,{children:(0,e.jsx)(l.x6,{i18nKey:"alerting.datasource-not-found.this-datasource-has-been-removed",children:"This datasource has been removed"})}),(0,e.jsx)(it.Z.Description,{children:(0,e.jsx)(l.x6,{i18nKey:"alerting.datasource-not-found.card-description",children:"The datasource for this query was not found, it was either removed or is not installed correctly."})}),(0,e.jsx)(it.Z.Figure,{children:(0,e.jsx)(se.I,{name:"question-circle"})}),(0,e.jsxs)(it.Z.Actions,{children:[(0,e.jsx)(q.$n,{variant:"secondary",onClick:B,children:(0,e.jsx)(l.x6,{i18nKey:"alerting.datasource-not-found.update-datasource",children:"Update datasource"})},"update"),(0,e.jsx)(q.$n,{variant:"destructive",onClick:r,children:(0,e.jsx)(l.x6,{i18nKey:"alerting.datasource-not-found.remove-query",children:"Remove query"})},"remove")]}),(0,e.jsx)(it.Z.SecondaryActions,{children:(0,e.jsx)(q.$n,{onClick:x,icon:d?"angle-up":"angle-down",fill:"text",size:"sm",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.datasource-not-found.show-details",children:"Show details"})},"details")})]}),d&&(0,e.jsx)("div",{children:(0,e.jsx)("pre",{children:(0,e.jsx)("code",{children:JSON.stringify(o,null,2)})})})]})})},Ye=({queries:n,expressions:a,panelData:r,onRunQueries:o,onChangeQueries:i,onDuplicateQuery:d,condition:g,onSetCondition:x})=>{const B=(0,I.of)(Ge);return(0,e.jsx)("div",{className:B.container,children:(0,e.jsx)(H,{data:r,queries:n,expressions:a,onRunQueries:o,onQueriesChange:i,onDuplicateQuery:d,condition:g,onSetCondition:x})})},Ge=n=>({container:(0,f.css)({backgroundColor:n.colors.background.primary,height:"100%"})});var tt=t(75421),mt=t(76874),ht=t(7795);const Xt=({queries:n,onChangeQuery:a,runQueries:r,panelData:o,dataSourceName:i})=>{const[d,g]=(0,s.useState)({series:[],state:we.Gu.NotStarted,timeRange:(0,tt.jG)().timeRange()}),x=(0,I.of)(St);(0,s.useEffect)(()=>{g(o?.[n[0]?.refId])},[o,n]);const{error:B,loading:L,value:v}=(0,ot.A)(()=>(0,T.l)().get(i),[i]),E=(0,s.useCallback)(me=>{if(!(0,$.Bu)(me)||!v)return;const[Q]=n,{uid:ne,type:ft}=v,_e=ft===Ee.ol.Loki,Oe=me.expr,he={...Q,...me,datasourceUid:ne,expr:Oe,model:{expr:Oe,datasource:me.datasource,refId:me.refId,editorMode:me.editorMode,instant:me.instant,range:me.range,queryType:_e?me.queryType||ht.U3.Instant:me.queryType,legendFormat:me.legendFormat}};a([he])},[v,n,a]);if(L||v?.name!==i)return null;const Re=(0,T.l)().getInstanceSettings(i);if(B||!v||!v?.components?.QueryEditor||!Re){const me=B?.message||"Data source plugin does not export any Query Editor component";return(0,e.jsx)("div",{children:(0,e.jsxs)(l.x6,{i18nKey:"alerting.recording-rule-editor.error-no-query-editor",children:["Could not load query editor due to: ",{errorMessage:me}]})})}const Ve=v.components.QueryEditor;return(0,e.jsxs)(e.Fragment,{children:[n.length&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(Ve,{query:n[0],queries:n,app:oe.Jk.UnifiedAlerting,onChange:E,onRunQuery:r,datasource:v}),(d?.errors||[]).map(me=>(0,e.jsx)(mt.x,{error:me},me.message))]}),d&&(0,e.jsx)("div",{className:x.vizWrapper,children:(0,e.jsx)(Fe.j,{data:d})})]})},St=n=>({vizWrapper:(0,f.css)({margin:n.spacing(1,0)})});var Bt=t(58872),kt=t(38133);const nt=({disabled:n,onChangeCloudDatasource:a})=>{const{control:r,formState:{errors:o},setValue:i,watch:d}=(0,u.xW)(),g=(0,I.of)(vt),x=d("type");return(0,e.jsx)("div",{className:g.flexRow,children:(x===S.Z.cloudAlerting||x===S.Z.cloudRecording)&&(0,e.jsx)(pe.D,{className:g.formInput,label:n?(0,l.t)("alerting.cloud-data-source-selector.label-disabled","Data source"):(0,l.t)("alerting.cloud-data-source-selector.label","Select data source"),error:o.dataSourceName?.message,invalid:!!o.dataSourceName?.message,children:(0,e.jsx)(u.xI,{render:({field:{onChange:B,ref:L,...v}})=>(0,e.jsx)(kt.q,{...v,disabled:n,onChange:E=>{i("expression",""),B(E?.name??null),a(E?.uid??null)}}),name:"dataSourceName",control:r,rules:{required:{value:!0,message:(0,l.t)("alerting.cloud-data-source-selector.message.please-select-a-data-source","Please select a data source")}}})})})},vt=n=>({formInput:(0,f.css)({width:"330px","& + &":{marginLeft:n.spacing(3)}}),flexRow:(0,f.css)({display:"flex",flexDirection:"row",justifyContent:"flex-start",alignItems:"flex-end"})});var yt=t(1932),Tt=t(46644),qt=t(97095),on=t(18857),Lt=t(2954),sn=t(81988),dt=t(82779),ln=t(66258),Ce=t(65307),De=t(39796),$t=t(29328),zt=t(42970);const Mt="reducer",Nt=(n,a)=>{const r=(0,zt.vL)(n),o=(0,zt.qQ)(a,r)[0];if(!o)return;const i=n.find(d=>d.refId===o);if(i&&"relativeTimeRange"in i)return i},_t={queries:[]},Kt=(0,Ce.VP)("duplicateQuery"),Ft=(0,Ce.VP)("addNewDataQuery"),bt=(0,Ce.VP)("setDataQueries"),Wt=(0,Ce.VP)("addNewExpression"),yn=(0,Ce.VP)("removeExpression"),jn=(0,Ce.VP)("removeExpressions"),En=(0,Ce.VP)("addExpressions"),Zt=(0,Ce.VP)("updateExpression"),Rn=(0,Ce.VP)("updateExpressionRefId"),Pn=(0,Ce.VP)("rewireExpressions"),In=(0,Ce.VP)("updateExpressionType"),Cn=(0,Ce.VP)("updateExpressionTimeRange"),bn=(0,Ce.VP)("updateMaxDataPoints"),Wn=(0,Ce.VP)("updateMinInterval"),Dn=(0,Ce.VP)("resetToSimpleCondition"),dn=(0,Ce.VP)("optimizeReduceExpression"),cn=(0,Ce.VP)("setRecordingRulesQueries"),Un=(0,Ce.vy)(_t,n=>{n.addCase(Dn,a=>{a.queries=(0,$.qO)()}).addCase(Kt,(a,{payload:r})=>{a.queries=un(a.queries,r)}).addCase(Ft,a=>{const r=(0,Ee.y9)();r&&(a.queries=un(a.queries,{datasourceUid:r.uid,model:{refId:"",datasource:(0,Et.p$)(r)}}))}).addCase(bt,(a,{payload:r})=>{const o=a.queries.filter(i=>(0,O.f)(i.model));a.queries=[...r,...o]}).addCase(cn,(a,{payload:r})=>{const o=r.recordingRuleQueries[0],i={...o,expr:r.expression,model:o?.model};a.queries=[i]}).addCase(bn,(a,r)=>{a.queries=a.queries.map(o=>o.refId===r.payload.refId?{...o,model:{...o.model,maxDataPoints:r.payload.maxDataPoints}}:o)}).addCase(Wn,(a,r)=>{a.queries=a.queries.map(o=>o.refId===r.payload.refId?{...o,model:{...o.model,intervalMs:r.payload.minInterval?st.intervalToMs(r.payload.minInterval):void 0}}:o)}),n.addCase(Wt,(a,{payload:r})=>{a.queries=un(a.queries,{datasourceUid:D.Uj,model:$t.Ex.newQuery({type:r,conditions:[{...dt.P0,query:{params:[]}}],expression:""})})}).addCase(yn,(a,{payload:r})=>{a.queries=a.queries.filter(o=>o.refId!==r)}).addCase(jn,a=>{a.queries=a.queries.filter(r=>!(0,O.f)(r.model))}).addCase(En,(a,{payload:r})=>{a.queries=[...a.queries,...r]}).addCase(Zt,(a,{payload:r})=>{const o=a.queries.find(i=>i.refId===r.refId);if(o&&(o.model=r,r.type===D.Tz.resample&&r.expression)){const i=(0,yt.c2)(a)?.queries??[];let d=(0,R.Cn)();try{const g=Nt(i,r.expression);g?.relativeTimeRange&&(d=g.relativeTimeRange)}catch(g){g instanceof Error?(0,Pt.vV)(g):(0,Pt.vV)(new Error("Error while trying to find data source from expression"))}o.relativeTimeRange=d}}).addCase(Cn,a=>{a.queries.forEach(r=>{if((0,O.f)(r.model)&&r.model.type===D.Tz.resample&&r.model.expression){const o=(0,yt.c2)(a)?.queries??[],i=Nt(o,r.model.expression),d=i?i.relativeTimeRange:(0,R.Cn)();r.relativeTimeRange=d}})}).addCase(Rn,(a,{payload:r})=>{const{newRefId:o,oldRefId:i}=r;if((0,M.xb)(a.queries,o))return;const g=(0,M.I3)(a.queries,i,o);a.queries=g.map(x=>x.refId===i?{...x,refId:o,model:{...x.model,refId:o}}:x)}).addCase(Pn,(a,{payload:r})=>{a.queries=(0,M.I3)(a.queries,r.oldRefId,r.newRefId)}).addCase(dn,(a,{payload:r})=>{const{updatedQueries:o,expressionQueries:i}=r;if(o.length!==1)return;const d=o.at(0),g=d?(0,$.mY)(d):!1,x=i.some(v=>(0,dt.D5)(v.model));if(g&&i.length===2&&x){const v=a.queries.findIndex(E=>(0,O.f)(E.model)&&(0,dt.D5)(E.model)&&E.model.expression===d?.refId);a.queries.splice(v,1),a.queries[1].model.expression=d?.refId}!g&&i.length===1&&(0,dt.sk)(i[0].model)&&(a.queries[1].model.expression=Mt,a.queries.splice(1,0,{datasourceUid:D.Uj,model:$t.Ex.newQuery({type:D.Tz.reduce,reducer:Tt.gy.last,conditions:[{...dt.P0,query:{params:[]}}],expression:d?.refId,refId:Mt}),refId:Mt,queryType:"expression"}))}).addCase(In,(a,r)=>{a.queries=a.queries.map(o=>o.refId===r.payload.refId?{...o,model:{...$t.Ex.newQuery({type:r.payload.type,conditions:[{...dt.P0,query:{params:[]}}],expression:""}),refId:r.payload.refId}}:o)})}),un=(n,a)=>{const r=(0,De.M)(n),o={...a,refId:r,queryType:"",model:{...a.model,hide:!1,refId:r},relativeTimeRange:a.relativeTimeRange??Qn(a.model)};return[...n,o]},Qn=n=>{if(!(0,O.f)(n))return(0,R.Cn)()},Gn=({simpleCondition:n,onChange:a,expressionQueriesList:r,dispatch:o,previewData:i})=>{const d=E=>{a({...n,whenField:E.value??Tt.gy.last}),wn(E.value??Tt.gy.last,r,o)},g=(0,dt.hJ)(n.evaluator.type),x=D.zd.find(E=>E.value===n.evaluator?.type),B=E=>{a({...n,evaluator:{...n.evaluator,type:E.value??Lt.p.IsAbove}}),Vn(E.value??Lt.p.IsAbove,r,o)},L=(E,Re=0)=>{const Ve=E.currentTarget.value,me=parseFloat(Ve)||0;a((0,yt.jM)(n,Q=>{Q.evaluator.params[Re]=me})),$n(me,Re,r,o)},v=(0,I.of)(zn);return(0,e.jsx)("div",{className:v.condition.wrapper,children:(0,e.jsxs)(K.B,{direction:"column",gap:0,width:"100%",children:[(0,e.jsx)("header",{className:v.condition.header,children:(0,e.jsx)(V.E,{variant:"body",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.simpleCondition.alertCondition",children:"Alert condition"})})}),(0,e.jsxs)(qt.C,{className:v.condition.container,children:[n.whenField&&(0,e.jsx)(gt.I,{label:(0,l.t)("alerting.simple-condition-editor.label-when","WHEN"),children:(0,e.jsx)(on.l6,{options:D.Cu,value:D.Cu.find(E=>E.value===n.whenField),onChange:d,width:20})}),(0,e.jsx)(gt.I,{label:n.whenField?(0,l.t)("alerting.simple-condition-editor.label-of-query","OF QUERY"):(0,l.t)("alerting.simple-condition-editor.label-when-query","WHEN QUERY"),children:(0,e.jsxs)(K.B,{direction:"row",gap:1,alignItems:"center",children:[(0,e.jsx)(sn.E,{onChange:B,value:x}),g?(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(pt.p,{type:"number",width:10,defaultValue:n.evaluator.params[0]??"",onBlur:E=>{L(E,0)}},n.evaluator.params[0]),(0,e.jsx)(ln.Y,{}),(0,e.jsx)(pt.p,{type:"number",width:10,defaultValue:n.evaluator.params[1]??"",onBlur:E=>{L(E,1)}},n.evaluator.params[1])]}):(0,e.jsx)(pt.p,{type:"number",width:10,defaultValue:n.evaluator.params[0]??"",onBlur:E=>{L(E,0)}},n.evaluator.params[0])]})})]}),i?.series&&(0,e.jsx)(ge.GX,{series:i?.series,isAlertCondition:!0})]})})};function wn(n,a,r){const o=a.find(d=>d.model.type===D.Tz.reduce),i=o?(0,yt.jM)(o?.model,d=>{d&&d.conditions&&(d.reducer=n,d.conditions[0].reducer.type=(0,dt.H3)(n)??Tt.gy.last)}):void 0;i&&r(Zt(i))}function Vn(n,a,r){const o=a.find(d=>d.model.type===D.Tz.threshold),i=(0,yt.jM)(o,d=>{d&&d.model.conditions&&(d.model.conditions[0].evaluator.type=n)});i&&r(Zt(i.model))}function $n(n,a,r,o){const i=r.find(g=>g.model.type===D.Tz.threshold),d=(0,yt.jM)(i,g=>{g&&g.model.conditions&&(g.model.conditions[0].evaluator.params[a]=n)});d&&o(Zt(d.model))}function gn(n){const a=n.find(x=>x.model.type===D.Tz.reduce),o=n.find(x=>x.model.type===D.Tz.threshold)?.model.conditions??[],i=a?.model.reducer,d=o[0]?.evaluator?.params?[...o[0]?.evaluator?.params]:[0],g=o[0]?.evaluator?.type??Lt.p.IsAbove;return{whenField:i,evaluator:{params:d,type:g}}}const zn=n=>({buttonSelectText:(0,f.css)({color:n.colors.primary.text,fontSize:n.typography.bodySmall.fontSize,textTransform:"uppercase",padding:`0 ${n.spacing(1)}`}),condition:{wrapper:(0,f.css)({display:"flex",border:`solid 1px ${n.colors.border.medium}`,flex:1,height:"fit-content",borderRadius:n.shape.radius.default}),container:(0,f.css)({display:"flex",flexDirection:"row",padding:n.spacing(1),flex:1,width:"100%"}),header:(0,f.css)({background:n.colors.background.secondary,padding:`${n.spacing(.5)} ${n.spacing(1)}`,borderBottom:`solid 1px ${n.colors.border.weak}`,flex:1})}});var Zn=t(77824),Sn=t(73427),Tn=t(11257);const Mn=n=>n.filter(a=>a.datasourceUid!==D.Uj).length===1;function Hn(){const n=Sn.TP.hasPermission(Tn.w.AlertingRuleCreate),a=Sn.TP.hasPermission(Tn.w.AlertingRuleExternalWrite),r=n?S.Z.grafana:S.Z.cloudAlerting,o=[];return n&&o.push(S.Z.grafana),a&&o.push(S.Z.cloudAlerting,S.Z.cloudRecording),{enabledRuleTypes:o,defaultRuleType:r}}const Yn=({queries:n,ruleFormType:a,rulesSourcesWithRuler:r})=>{const o=Hn(),i=Mn(n),d=n[0]?.datasourceUid??"",g=a===S.Z.cloudRecording,x=!g&&i&&r.some(Ve=>Ve.uid===d),B=!g,L=o.enabledRuleTypes.includes(S.Z.grafana),v=o.enabledRuleTypes.includes(S.Z.cloudAlerting),E=a===S.Z.cloudAlerting&&L&&B,Re=a===S.Z.grafana&&x&&v&&x;return E||Re};function An({editingExistingRule:n,rulesSourcesWithRuler:a,queries:r,onClickSwitch:o}){const{getValues:i}=(0,u.xW)(),[d]=i(["type"]),g=Yn({queries:r,ruleFormType:d,rulesSourcesWithRuler:a}),x=[{label:(0,l.t)("alerting.smart-alert-type-detector.grafana-managed","Grafana-managed"),value:S.Z.grafana},{label:(0,l.t)("alerting.smart-alert-type-detector.data-source-managed","Data source-managed"),value:S.Z.cloudAlerting}],B=g?[]:[S.Z.cloudAlerting];return(0,e.jsxs)(K.B,{direction:"column",gap:1,alignItems:"flex-start",children:[(0,e.jsxs)(K.B,{direction:"column",gap:0,children:[(0,e.jsx)(V.E,{variant:"h5",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.smart-alert-type-detector.rule-type",children:"Rule type"})}),(0,e.jsxs)(K.B,{direction:"row",gap:.5,alignItems:"center",children:[(0,e.jsx)(V.E,{variant:"bodySmall",color:"secondary",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.smart-alert-type-detector.select-where-alert-managed",children:"Select where the alert rule will be managed."})}),(0,e.jsx)(Le.G,{contentText:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(V.E,{color:"primary",variant:"h6",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.smart-alert-type-detector.grafanamanaged-alert-rules",children:"Grafana-managed alert rules"})}),(0,e.jsx)("p",{children:(0,e.jsx)(l.x6,{i18nKey:"alerting.smart-alert-type-detector.grafanamanaged-alert-rules-description",children:"Grafana-managed alert rules allow you to create alerts that can act on data from any of our supported data sources, including having multiple data sources in the same rule. You can also add expressions to transform your data and set alert conditions. Using images in alert notifications is also supported."})}),(0,e.jsx)(V.E,{color:"primary",variant:"h6",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.smart-alert-type-detector.data-sourcemanaged-alert-rules",children:"Data source-managed alert rules"})}),(0,e.jsx)("p",{children:(0,e.jsx)(l.x6,{i18nKey:"alerting.smart-alert-type-detector.data-sourcemanaged-alert-rules-description",children:"Data source-managed alert rules can be used for Grafana Mimir or Grafana Loki data sources which have been configured to support rule creation. The use of expressions or multiple queries is not supported."})})]}),externalLink:"https://grafana.com/docs/grafana/latest/alerting/fundamentals/alert-rules/alert-rule-types/",linkText:"Read about alert rule types",title:(0,l.t)("alerting.smart-alert-type-detector.title-alert-rule-types","Alert rule types")})]})]}),(0,e.jsx)(Zn.z,{options:x,disabled:n,disabledOptions:B,value:d,onChange:o,"data-testid":"rule-type-radio-group"}),n&&(0,e.jsx)(V.E,{color:"secondary",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.smart-alert-type-detector.rule-type-cannot-be-changed",children:"The alert rule type cannot be changed for an existing rule."})}),!n&&(0,e.jsx)(e.Fragment,{children:g?(0,e.jsx)(V.E,{color:"secondary",children:d===S.Z.grafana?(0,l.t)("alerting.smart-alert-type-detector.switch-to-data-source-managed","The data source selected in your query supports alert rule management. Switch to data source-managed if you want the alert rule to be managed by the data source instead of Grafana."):(0,l.t)("alerting.smart-alert-type-detector.switch-to-grafana-managed","Switch to Grafana-managed to use expressions, multiple queries, images in notifications and various other features.")}):(0,e.jsx)(V.E,{color:"secondary",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.smart-alert-type-detector.rule-type-grafana-managed",children:"Based on the selected data sources this alert rule will be Grafana-managed."})})})]})}const Jn={[S.Z.cloudRecording]:{sectionTitle:"Define recording rule",helpLabel:"Define your recording rule",helpContent:"Pre-compute frequently needed or computationally expensive expressions and save their result as a new set of time series.",helpLink:"https://grafana.com/docs/grafana/latest/alerting/alerting-rules/create-recording-rules/"},[S.Z.grafanaRecording]:{sectionTitle:"Define recording rule",helpLabel:"Define your recording rule",helpContent:"Pre-compute frequently needed or computationally expensive expressions and save their result as a new set of time series.",helpLink:"https://grafana.com/docs/grafana/latest/alerting/alerting-rules/create-recording-rules/"},[S.Z.grafana]:{sectionTitle:"Define query and alert condition",helpLabel:"Define query and alert condition",helpContent:"An alert rule consists of one or more queries and expressions that select the data you want to measure. Define queries and/or expressions and then choose one of them as the alert rule condition. This is the threshold that an alert rule must meet or exceed in order to fire. For more information on queries and expressions, see Query and transform data.",helpLink:"https://grafana.com/docs/grafana/latest/panels-visualizations/query-transform-data/"},[S.Z.cloudAlerting]:{sectionTitle:"Define query and alert condition",helpLabel:"Define query and alert condition",helpContent:"An alert rule consists of one or more queries and expressions that select the data you want to measure. Define queries and/or expressions and then choose one of them as the alert rule condition. This is the threshold that an alert rule must meet or exceed in order to fire. For more information on queries and expressions, see Query and transform data.",helpLink:"https://grafana.com/docs/grafana/latest/panels-visualizations/query-transform-data/"}};function Xn(n,a,r){return n&&(0,fe.Nx)(a,r)?gn(r):{whenField:Tt.gy.last,evaluator:{params:[0],type:Lt.p.IsAbove}}}function kn(n,a){return n===!1||!a}const qn=(n,a,r,o)=>{const i=kn(n,a),[d,g]=(0,s.useState)(Xn(a,r,o));return(0,s.useEffect)(()=>{a&&!i&&g(gn(o))},[i,o,a]),{simpleCondition:d,setSimpleCondition:g}};var _n=t(54513);const er=({editingExistingRule:n,onDataChange:a,mode:r})=>{const{setValue:o,getValues:i,watch:d,formState:{errors:g},control:x}=(0,u.xW)(),{queryPreviewData:B,runQueries:L,cancelQueries:v,isPreviewLoading:E,clearPreviewData:Re}=(0,_n.Y)(),Ve=k.$.featureToggles.alertingQueryAndExpressionsStepMode??!1,me={queries:i("queries")},[{queries:Q},ne]=(0,s.useReducer)(Un,me),ft=k.$.featureToggles.alertingUIOptimizeReducer??!1,_e=(0,s.useMemo)(()=>Q.filter(j=>!(0,O.f)(j.model)),[Q]),Oe=(0,s.useMemo)(()=>Q.filter(j=>(0,fe.Oy)(j)),[Q]);(0,z.A)(()=>{!n&&ft&&ne(dn({updatedQueries:_e,expressionQueries:Oe}))});const[he,rt,jt,pn]=d(["type","condition","dataSourceName","editorSettings"]),ct=(0,re.Mu)(he),$e=(0,re.OF)(he),Ht=(0,re.BL)(he),[mn,Yt]=(0,s.useState)(!1),fn=pn?.simplifiedQueryEditor,{simpleCondition:xn,setSimpleCondition:Te}=qn(fn,ct,_e,Oe),et=Ve&&ct?pn?.simplifiedQueryEditor:!1;(0,s.useEffect)(()=>{et&&ct&&Te(gn(Oe))},[et,Oe,ct,Te]);const{rulesSourcesWithRuler:At,isLoading:Jt}=(0,ae.z)(),at=(0,s.useCallback)(j=>{if(!Ht)if(et){const G=Oe.at(-1);if(!G)return;const be=G.refId;o("condition",be),L(i("queries"),be)}else L(i("queries"),j||(i("condition")??""))},[Ht,Oe,et,o,L,i]);(0,s.useEffect)(()=>{o("queries",Q,{shouldValidate:!1})},[Q,L,o]);const en=(0,Ee.y9)()===void 0,tn=Q.length===0;(0,s.useEffect)(()=>{if(he&&!(0,re.H2)(he))return;const j=i("condition");if(!j)return;const G=B[j];if(!G)return;const be=(0,M.lb)(G)??(0,M.zy)(G);a(be?.message||"")},[B,i,a,he]);const nn=(0,s.useCallback)(j=>{j&&(at(j),o("condition",j))},[at,o]),ar=(0,s.useCallback)((j,G)=>{(0,M.xb)(Q,G)||(ne(Rn({oldRefId:j,newRefId:G})),rt===j&&o("condition",G))},[rt,Q,o]),xt=rr(),or=(0,s.useCallback)(j=>{const be=i("queries").filter(fe.Oy);o("queries",[...j,...be],{shouldValidate:!1}),xt(j),!n&&ft&&ne(dn({updatedQueries:j,expressionQueries:be})),ne(bt(j)),ne(Cn());const[an,Fn]=(0,M.YG)(Q,j);an&&Fn&&ne(Pn({oldRefId:an,newRefId:Fn}))},[Q,xt,i,o,n,ft]),sr=(0,s.useCallback)(j=>{const G=j[0];if(!(0,$.Bu)(G.model))return;const be=G.model.expr;o("queries",j,{shouldValidate:!1}),xt(j),ne(cn({recordingRuleQueries:j,expression:be})),at()},[at,o,xt]),hn=At.at(0);(0,s.useEffect)(()=>{if(Re(),he===S.Z.cloudRecording){const j=i("expression");if(!hn)return;const be={refId:"A",datasourceUid:n&&(0,T.l)().getInstanceSettings(jt)?.uid||hn.uid,queryType:"",relativeTimeRange:(0,R.Cn)(),expr:j,instant:!0,model:{refId:"A",hide:!1,expr:j}};ne(cn({recordingRuleQueries:[be],expression:j}))}},[he,hn,n,i,jt,Re]);const ir=(0,s.useCallback)(j=>{ne(Kt(j))},[]);(0,s.useEffect)(()=>{if(!(0,M.xb)(Q,rt)){const j=Q.at(-1)?.refId??null;nn(j)}},[rt,Q,nn]);const lr=(0,s.useCallback)(j=>{ne(Wt(j))},[ne]),dr=(0,I.of)(nr),cr=(0,s.useCallback)(j=>{const G=(0,p.cloneDeep)(Q);G[0].datasourceUid=j,o("queries",G,{shouldValidate:!1}),xt(G),ne(bt(G))},[Q,o,xt,ne]),ur=j=>{const G=(0,p.cloneDeep)(Q);if(G[0].model)if((0,$.Bu)(G[0].model))G[0].model.expr=j;else{const be={...(0,p.cloneDeep)(G[0].model),expr:j};G[0].model=be}o("queries",G,{shouldValidate:!1}),xt(G),ne(bt(G)),at()},On=(0,s.useCallback)(()=>ne(jn()),[ne]),Bn=(0,s.useCallback)(j=>ne(En(j)),[ne]),[rn,gr]=(0,s.useState)([]),[vn,pr]=(0,s.useState)(null),Ln=(0,s.useCallback)(()=>{Bn(rn)},[rn,Bn]),Nn=(0,s.useCallback)(()=>{if(i("type")===S.Z.cloudAlerting)o("type",S.Z.grafana),o("dataSourceName",Ee.hY),rn.length>0&&Ln(),vn&&o("condition",vn);else{o("type",S.Z.cloudAlerting);const G=(0,T.l)().getInstanceSettings(Q[0].datasourceUid)?.name;G&&o("dataSourceName",G),xt(Q);const be=Q.filter(an=>an.datasourceUid===D.Uj);gr(be),On(),pr(rt)}},[i,o,rn.length,Ln,vn,xt,Q,On,rt]),{sectionTitle:mr,helpLabel:Kn,helpContent:fr,helpLink:xr}=Jn[he??S.Z.grafana];if(!he)return null;const hr=ct&&Ve?{isAdvancedMode:!et,setAdvancedMode:j=>{if(!i("editorSettings.simplifiedQueryEditor")&&!(0,fe.Nx)(_e,Oe)){Yt(!0);return}o("editorSettings.simplifiedQueryEditor",!j)}}:void 0,vr=Mn(Q)&&!!At.length&&Q.some(j=>At.some(G=>G.uid===j.datasourceUid));return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(Bt.P,{stepNo:2,title:mr,fullWidth:!0,description:(0,e.jsxs)(K.B,{direction:"row",gap:.5,alignItems:"center",children:[(0,e.jsx)(V.E,{variant:"bodySmall",color:"secondary",children:Kn}),(0,e.jsx)(Le.G,{contentText:fr,externalLink:xr,linkText:"Read more on our documentation website",title:Kn})]}),switchMode:hr,children:[(0,re.s_)(he)&&(0,e.jsx)(nt,{onChangeCloudDatasource:cr,disabled:n}),$e&&jt&&(0,e.jsx)(pe.D,{error:g.expression?.message,invalid:!!g.expression?.message,children:(0,e.jsx)(Xt,{dataSourceName:jt,queries:Q,runQueries:()=>at(),onChangeQuery:sr,panelData:B})}),Jt&&(0,e.jsx)(V.E,{children:(0,e.jsx)(l.x6,{i18nKey:"alerting.query-and-expressions-step.loading-data-sources",children:"Loading data sources..."})}),!Jt&&Ht&&jt&&(0,e.jsxs)(K.B,{direction:"column",children:[(0,e.jsx)(pe.D,{error:g.expression?.message,invalid:!!g.expression?.message,children:(0,e.jsx)(u.xI,{name:"expression",render:({field:{ref:j,...G}})=>(0,e.jsx)(Je,{...G,dataSourceName:jt,showPreviewAlertsButton:!$e,onChange:ur}),control:x,rules:{required:{value:!0,message:(0,l.t)("alerting.query-and-expressions-step.message.a-valid-expression-is-required","A valid expression is required")}}})}),r==="edit"&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(ce.c,{}),(0,e.jsx)(An,{editingExistingRule:n,queries:Q,rulesSourcesWithRuler:At,onClickSwitch:Nn})]})]}),!Jt&&(0,re.H2)(he)&&(0,e.jsxs)(K.B,{direction:"column",children:[(0,e.jsx)(Ye,{queries:_e,expressions:Oe,onRunQueries:()=>at(),onChangeQueries:or,onDuplicateQuery:ir,panelData:B,condition:rt,onSetCondition:nn}),!et&&(0,e.jsx)(ee.m,{content:(0,l.t)("alerting.query-and-expressions-step.no-compatible-sources","You appear to have no compatible data sources"),show:en,children:(0,e.jsx)(q.$n,{type:"button",onClick:()=>{ne(Ft())},variant:"secondary","data-testid":y.Tp.components.QueryTab.addQuery,disabled:en,className:dr.addQueryButton,children:(0,e.jsx)(l.x6,{i18nKey:"alerting.query-and-expressions-step.add-query",children:"Add query"})})}),vr&&ct&&!et&&r==="edit"&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(ce.c,{}),(0,e.jsx)(An,{editingExistingRule:n,rulesSourcesWithRuler:At,queries:Q,onClickSwitch:Nn})]}),!et&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(ce.c,{}),(0,e.jsxs)(K.B,{direction:"column",gap:0,children:[(0,e.jsx)(V.E,{element:"h5",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.query-and-expressions-step.expressions",children:"Expressions"})}),(0,e.jsx)(V.E,{variant:"bodySmall",color:"secondary",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.query-and-expressions-step.manipulate-returned-queries-other-operations",children:"Manipulate data returned from queries with math and other operations."})})]}),(0,e.jsx)(Ae,{queries:Q,panelData:B,condition:rt,onSetCondition:nn,onRemoveExpression:j=>{ne(yn(j))},onUpdateRefId:ar,onUpdateExpressionType:(j,G)=>{ne(In({refId:j,type:G}))},onUpdateQueryExpression:j=>{ne(Zt(j))}})]}),(0,e.jsxs)(K.B,{direction:"column",children:[et&&(0,e.jsx)(Gn,{simpleCondition:xn,onChange:Te,expressionQueriesList:Oe,dispatch:ne,previewData:B[rt??""]}),(0,e.jsxs)(K.B,{direction:"row",children:[!et&&k.$.expressionsEnabled&&(0,e.jsx)(tr,{onClickType:lr}),E&&(0,e.jsx)(q.$n,{icon:"spinner",type:"button",variant:"destructive",onClick:v,children:(0,e.jsx)(l.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})}),!E&&(0,e.jsx)(q.$n,{"data-testid":y.Tp.components.AlertRules.previewButton,icon:"sync",type:"button",onClick:()=>at(),disabled:tn,children:et?(0,l.t)("alerting.queryAndExpressionsStep.previewCondition","Preview alert rule condition"):(0,l.t)("alerting.queryAndExpressionsStep.preview","Preview")})]})]}),tn&&(0,e.jsx)(P.F,{title:(0,l.t)("alerting.query-and-expressions-step.title-queries-expressions-configured","No queries or expressions have been configured"),severity:"warning",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.query-and-expressions-step.body-queries-expressions-configured",children:"Create at least one query or expression to be alerted on"})})]})]}),(0,e.jsx)(le.u,{isOpen:mn,title:(0,l.t)("alerting.query-and-expressions-step.title-deactivate-advanced-options","Deactivate advanced options"),body:(0,e.jsxs)("div",{children:[(0,e.jsx)(V.E,{element:"p",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.queryAndExpressionsStep.disableAdvancedOptions.text",children:"The selected queries and expressions cannot be converted to default. If you deactivate advanced options, your query and condition will be reset to default settings."})}),(0,e.jsx)("br",{})]}),confirmText:(0,l.t)("alerting.query-and-expressions-step.confirmText-deactivate","Deactivate"),icon:"exclamation-triangle",onConfirm:()=>{o("editorSettings.simplifiedQueryEditor",!0),Yt(!1),ne(Dn())},onDismiss:()=>Yt(!1)})]})};function tr({onClickType:n}){const a=(0,e.jsx)(C.W,{children:D.uQ.map(r=>(0,e.jsx)(ee.m,{content:r.description??"",placement:"right",children:(0,e.jsx)(Z.D,{onClick:()=>n(r.value??D.Tz.math),label:r.label??""},r.value)},r.value))});return(0,e.jsx)(ue.m,{overlay:a,children:(0,e.jsx)(q.$n,{variant:"secondary","data-testid":"add-expression-button",icon:"angle-down",children:(0,e.jsx)(l.x6,{i18nKey:"alerting.type-selector-button.add-expression",children:"Add expression"})})})}const nr=n=>({addQueryButton:(0,f.css)({width:"fit-content"}),helpInfo:(0,f.css)({display:"flex",flexDirection:"row",alignItems:"center",width:"fit-content",fontWeight:n.typography.fontWeightMedium,marginLeft:n.spacing(1),fontSize:n.typography.size.sm,cursor:"pointer"}),helpInfoText:(0,f.css)({marginLeft:n.spacing(.5),textDecoration:"underline"}),infoLink:(0,f.css)({color:n.colors.text.link})}),rr=()=>{const{setValue:n}=(0,u.xW)();return a=>{const r=a[0];if(!r)return;if(!(0,T.l)().getInstanceSettings(r.datasourceUid))throw new Error("The Data source has not been defined.");if((0,$.Bu)(r.model)){const i=r.model.expr;n("expression",i)}}}},74143:(We,Y,t)=>{t.d(Y,{nZ:()=>S});var e=t(74848),f=t(96540),p=t(49785),s=t(16817),u=t(92745),z=t(6975),R=t(45861),y=t(41654),l=t(64762),k=t(70327),T=t(77295),I=t(44109),K=t(39187),V=t(84523),pe=t(67817),ce=t(52161),ee=t(20437),q=t(29609),P=t(77880),le=t(25149),C=t(78102),Z=t(98395),ue=t(20593),O=t(10321),D=t(77946),ae=t(96091),fe=t(73228);function S({ruleForm:de,alertUid:oe}){const xe=(0,f.useMemo)(()=>{const M=pe.Z.grafana;return{...(0,V.IJ)(),condition:"C",queries:(0,ee.qO)(!1),type:M,evaluateEvery:V.T6}},[]),se=(0,p.mN)({mode:"onSubmit",defaultValues:de??xe,shouldFocusError:!0}),Pe=!!de,Se=(0,l._2)(),{returnTo:Me}=(0,K.h)("/alerting/list"),[ie,Be]=(0,f.useState)(void 0),[ve,ut]=(0,f.useState)(""),Je=()=>{Se.error("There are errors in the form. Please correct them and try again!")},N=(M="")=>{ut(M)},ye=M=>{if(ve!==""){Se.error(ve);return}Be(M)},ge=(0,f.useCallback)(()=>{Be(void 0)},[Be]);return(0,e.jsx)(p.Op,{...se,children:(0,e.jsxs)(y.B,{direction:"column",children:[(0,e.jsx)("form",{onSubmit:M=>M.preventDefault(),children:(0,e.jsx)("div",{children:(0,e.jsxs)(y.B,{direction:"column",gap:3,children:[(0,e.jsx)(Z.H,{}),(0,e.jsx)(fe.N,{editingExistingRule:Pe,onDataChange:N,mode:"draft"}),(0,e.jsx)(D.d,{}),(0,e.jsx)(O.H$,{existing:!!Pe,enableProvisionedGroups:!0}),(0,e.jsx)(ae.N,{alertUid:oe}),(0,e.jsx)(ue.A,{})]})})}),ie&&(0,e.jsx)(we,{exportValues:ie,onClose:ge,uid:oe}),(0,e.jsxs)(y.B,{direction:"row",children:[(0,e.jsx)(R.$n,{onClick:se.handleSubmit(M=>ye(M),Je),children:(0,e.jsx)(u.x6,{i18nKey:"alerting.modify-export-rule-form.action-buttons.export",children:"Export"})},"export-rule"),(0,e.jsx)(R.z9,{href:Me,variant:"secondary",onClick:()=>ye(void 0),children:(0,e.jsx)(u.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})},"cancel")]})]})})}const Ee=(de,oe)=>{const{dsFeatures:xe}=(0,I.O3)(ce.hY),se=xe?.rulerConfig;return(0,s.A)(async()=>se?await(0,T.HO)(se,de,oe):void 0,[se,de,oe])},$=(de,oe,xe)=>{const se=(0,ee.Z9)(de),Pe={...se,grafana_alert:{...se.grafana_alert,uid:xe}};if(oe?.rules){let Se=!1;const Me=oe.rules.map(ie=>q.p.grafana.rule(ie)&&ie.grafana_alert.uid===xe?(Se=!0,Pe):ie);return Se||Me.push(Pe),{...oe,rules:Me}}else return{name:oe?.name??de.group,rules:[Pe]}},re=(de,oe)=>{const xe=Ee(de.folder?.uid??"",de.group);return{payload:(0,f.useMemo)(()=>$(de,xe?.value,oe),[oe,xe,de]),loadingGroup:xe.loading}},ot=({exportFormat:de,exportValues:oe,onClose:xe,uid:se})=>{const[Pe,Se]=k.hK.endpoints.exportModifiedRuleGroup.useMutation(),{loadingGroup:Me,payload:ie}=re(oe,se),Be=oe.folder?.uid??"";if((0,f.useEffect)(()=>{!Me&&ie.name&&Pe({payload:ie,format:de,nameSpaceUID:Be})},[Be,de,ie,Pe,Me]),Se.isLoading)return(0,e.jsx)(z._,{text:(0,u.t)("alerting.grafana-rule-design-export-preview.text-loading","Loading....")});const ve=`modify-export-${ie.name}-${se}-${new Date().getTime()}`;return(0,e.jsx)(P.J,{format:de,textDefinition:Se.data??"",downloadFileName:ve,onClose:xe})},we=(0,f.memo)(({onClose:de,exportValues:oe,uid:xe})=>{const se=!xe,Pe=se?"hcl":"yaml",[Se,Me]=(0,f.useState)(Pe),ie=se?[C.dX]:Object.values(C.sl);return(0,e.jsx)(le.m,{title:(0,u.t)("alerting.grafana-rule-design-exporter.title-export-group","Export Group"),activeTab:Se,onTabChange:Me,onClose:de,formatProviders:ie,children:(0,e.jsx)(ot,{exportFormat:Se,onClose:de,exportValues:oe,uid:xe})})});we.displayName="GrafanaRuleDesignExporter"},77946:(We,Y,t)=>{t.d(Y,{d:()=>le});var e=t(74848),f=t(96540),p=t(49785),s=t(92745),u=t(41654),z=t(66404),R=t(70327),y=t(55143),l=t(52161),k=t(37386),T=t(72636),I=t(32225),K=t(61293);function V(){const{formState:{errors:C},setValue:Z,watch:ue}=(0,p.xW)(),O=(0,f.useCallback)(()=>{Z("group","")},[Z]),D=ue("folder"),ae=fe=>{O(),Z("folder",fe)};return(0,e.jsx)(u.B,{alignItems:"center",children:(0,e.jsx)(k.D,{label:(0,e.jsx)(T.J,{htmlFor:"folder",description:(0,s.t)("alerting.folder-selector.description-select-folder","Select a folder to store your rule in."),children:(0,e.jsx)(s.x6,{i18nKey:"alerting.rule-form.folder.label",children:"Folder"})}),error:C.folder?.message,"data-testid":"folder-picker",children:(0,e.jsxs)(u.B,{direction:"row",alignItems:"center",children:[(0,e.jsx)(p.xI,{render:({field:{ref:fe,...S}})=>(0,e.jsx)("div",{style:{width:420},children:(0,e.jsx)(I.NestedFolderPicker,{permission:"view",showRootFolder:!1,invalid:!!C.folder?.message,...S,value:D?.uid,onChange:(Ee,$)=>{Ee&&$?Z("folder",{title:$,uid:Ee}):Z("folder",void 0),O()}})}),name:"folder",rules:{required:{value:!0,message:(0,s.t)("alerting.folder-selector.message.select-a-folder","Select a folder")}}}),(0,e.jsx)(K.x,{onCreate:ae})]})})})}var pe=t(25521),ce=t(58872),ee=t(25197),q=t(16996);const{usePrefetch:P}=R.hK;function le(){const{setValue:C,getValues:Z}=(0,p.xW)(),[ue,O]=(0,f.useState)(!1),D=P("rulerRules");(0,f.useEffect)(()=>{D({rulerConfig:y.b})},[D]);function ae(S){S&&C("labels",S),O(!1)}function fe(){return(0,e.jsxs)(u.B,{direction:"row",gap:.5,alignItems:"center",children:[(0,e.jsx)(z.E,{variant:"bodySmall",color:"secondary",children:(0,e.jsx)(s.x6,{i18nKey:"alerting.rule-form.folder-and-labels",children:"Organize your alert rule with a folder and set of labels."})}),(0,e.jsx)(pe.G,{contentText:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("p",{children:(0,s.t)("alerting.rule-form.folders.help-info","Folders are used for storing alert rules. You can extend the access provided by a role to alert rules and assign permissions to individual folders.")}),(0,e.jsx)("p",{children:(0,s.t)("alerting.rule-form.labels.help-info","Labels are used to differentiate an alert from all other alerts.You can use them for searching, silencing, and routing notifications.")})]})})]})}return(0,e.jsx)(ce.P,{stepNo:3,title:(0,s.t)("alerting.grafana-folder-and-labels-step.title-add-folder-and-labels","Add folder and labels"),description:(0,e.jsx)(fe,{}),children:(0,e.jsxs)(u.B,{direction:"column","justify-content":"flex-start","align-items":"flex-start",children:[(0,e.jsx)(V,{}),(0,e.jsx)(q.t,{onEditClick:()=>O(!0)}),(0,e.jsx)(ee.A,{isOpen:ue,onClose:ae,dataSourceName:l.hY,initialLabels:Z("labels")})]})})}},87144:(We,Y,t)=>{t.r(Y),t.d(Y,{default:()=>R});var e=t(74848),f=t(92745),p=t(88547),s=t(36826),u=t(74143);function z(){return(0,e.jsx)(s.d,{navId:"alert-list",pageNav:{text:(0,f.t)("alerting.export-new-grafana-rule-page.text.export-new-grafana-rule","Export new Grafana rule"),subTitle:"Export a new rule definition in Terraform(HCL) format. Any changes you make will not be saved."},children:(0,e.jsx)(u.nZ,{})})}const R=(0,p.S)(z)},88721:(We,Y,t)=>{t.d(Y,{V:()=>p});var e=t(96540),f=t(54);function p(){return(0,e.useMemo)(()=>(0,f.Q9)(),[])}},96091:(We,Y,t)=>{t.d(Y,{N:()=>Qt});var e=t(74848),f=t(22803),p=t(96540),s=t(49785),u=t(92745),z=t(43173),R=t(63142),y=t(41654),l=t(66404),k=t(77824),T=t(89640),I=t(84266),K=t(91984),V=t(67817),pe=t(52161),ce=t(29609),ee=t(25521),q=t(58872),P=t(5358),le=t(74475),C=t(29189),Z=t(2543),ue=t(1749),O=t(47987),D=t(37386),ae=t(12594),fe=t(92367);function S({alertManager:m}){const{control:A,watch:b,trigger:F}=(0,s.xW)(),J=`contactPoints.${m}.selectedContactPoint`,_=b(J),{currentData:X,status:te}=ue.P.endpoints.listReceiver.useQuery({fieldSelector:`spec.title=${_}`}),Xe=_&&te===C.RE.fulfilled&&(0,Z.isEmpty)(X?.items);return(0,p.useEffect)(()=>{_&&te===C.RE.fulfilled&&F(J,{shouldFocus:!0})},[_,J,te,F]),(0,e.jsx)(y.B,{direction:"row",alignItems:"center",children:(0,e.jsx)(D.D,{label:(0,u.t)("alerting.contact-point-selector.contact-point-picker-label-contact-point","Contact point"),"data-testid":"contact-point-picker",children:(0,e.jsx)(s.xI,{name:J,render:({field:{onChange:ke},fieldState:{error:Ke}})=>(0,e.jsxs)(e.Fragment,{children:[(0,e.jsxs)(y.B,{children:[(0,e.jsx)(O.u,{isClearable:!1,onChange:Ue=>ke(Ue.spec.title),width:50,value:_}),(0,e.jsx)(Ee,{})]}),Ke&&(0,e.jsx)(ae.P,{children:Ke?.message})]}),rules:{validate:()=>Xe?(0,u.t)("alerting.contactPoints.validation.notFound",'Contact point "{{contactPoint}}" could not be found',{contactPoint:_}):!0,required:{value:!0,message:(0,u.t)("alerting.contact-point-selector.message.contact-point-is-required","Contact point is required.")}},control:A})})})}function Ee(){return(0,e.jsx)(T.Y,{external:!0,href:(0,fe.G)("/alerting/notifications"),"aria-label":(0,u.t)("alerting.link-to-contact-points.aria-label-view-or-create-contact-points","View or create contact points"),children:(0,e.jsx)(u.x6,{i18nKey:"alerting.link-to-contact-points.view-or-create-contact-points",children:"View or create contact points"})})}var $=t(55684),re=t(20443);function ot({alertmanager:m}){const A=(0,R.of)(we),{control:b,formState:{errors:F}}=(0,s.xW)();return(0,e.jsx)(D.D,{label:(0,u.t)("alerting.active-timing-fields.am-active-timing-select-label-active-timings","Active timings"),"data-testid":"am-active-timing-select",description:(0,u.t)("alerting.mute-timing-fields.am-active-timing-select-description-active-timings","Select a time interval to define when to only send notifications for this alert rule"),className:A.muteTimingField,invalid:!!F.contactPoints?.[m]?.activeTimeIntervals,children:(0,e.jsx)(s.xI,{render:({field:{onChange:J,ref:_,...X}})=>(0,e.jsx)($.A,{alertmanager:m,selectProps:{...X,onChange:te=>J((0,re.ie)(te))}}),control:b,name:`contactPoints.${m}.activeTimeIntervals`})})}const we=m=>({muteTimingField:(0,f.css)({marginTop:m.spacing(1)})});function de({alertmanager:m}){const A=(0,R.of)(oe),{control:b,formState:{errors:F}}=(0,s.xW)();return(0,e.jsx)(D.D,{label:(0,u.t)("alerting.mute-timing-fields.am-mute-timing-select-label-mute-timings","Mute timings"),"data-testid":"am-mute-timing-select",description:(0,u.t)("alerting.mute-timing-fields.am-mute-timing-select-description-mute-timings","Select a mute timing to define when not to send notifications for this alert rule"),className:A.muteTimingField,invalid:!!F.contactPoints?.[m]?.muteTimeIntervals,children:(0,e.jsx)(s.xI,{render:({field:{onChange:J,ref:_,...X}})=>(0,e.jsx)($.A,{alertmanager:m,selectProps:{...X,onChange:te=>J((0,re.ie)(te))}}),control:b,name:`contactPoints.${m}.muteTimeIntervals`})})}const oe=m=>({muteTimingField:(0,f.css)({marginTop:m.spacing(1)})});var xe=t(18027),se=t(21285),Pe=t(18857),Se=t(82515),Me=t(65120),ie=t(61474),Be=t(21563),ve=t(92649);function ut({alertManager:m}){const A=(0,R.of)(Me.t),{register:b,formState:{errors:F},getValues:J}=(0,s.xW)();return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(D.D,{label:ve.G.groupWait.label,description:ve.G.groupWait.description,invalid:!!F.contactPoints?.[m]?.groupWaitValue,error:F.contactPoints?.[m]?.groupWaitValue?.message,children:(0,e.jsx)(Be.V,{...b(`contactPoints.${m}.groupWaitValue`,{validate:re.hH}),"aria-label":ve.G.groupWait.ariaLabel,className:A.promDurationInput,placeholder:ie.H.group_wait})}),(0,e.jsx)(D.D,{label:ve.G.groupInterval.label,description:ve.G.groupInterval.description,invalid:!!F.contactPoints?.[m]?.groupIntervalValue,error:F.contactPoints?.[m]?.groupIntervalValue?.message,children:(0,e.jsx)(Be.V,{...b(`contactPoints.${m}.groupIntervalValue`,{validate:re.hH}),"aria-label":ve.G.groupInterval.ariaLabel,className:A.promDurationInput,placeholder:ie.H.group_interval})}),(0,e.jsx)(D.D,{label:ve.G.repeatInterval.label,description:ve.G.repeatInterval.description,invalid:!!F.contactPoints?.[m]?.repeatIntervalValue,error:F.contactPoints?.[m]?.repeatIntervalValue?.message,children:(0,e.jsx)(Be.V,{...b(`contactPoints.${m}.repeatIntervalValue`,{validate:_=>{const X=J(`contactPoints.${m}.repeatIntervalValue`);return(0,re.DY)(_,X)}}),"aria-label":ve.G.repeatInterval.ariaLabel,className:A.promDurationInput,placeholder:ie.H.repeat_interval})})]})}const Je=["grafana_folder","alertname"],N={groupWaitValue:ie.H.group_wait,groupIntervalValue:ie.H.group_interval,repeatIntervalValue:ie.H.repeat_interval},ye="...",ge=({alertManager:m})=>{const A=(0,R.of)(Me.t),{control:b,watch:F,register:J,setValue:_,formState:{errors:X}}=(0,s.xW)(),[te,Xe]=(0,p.useState)((0,re.gY)([])),{groupIntervalValue:ke,groupWaitValue:Ke,repeatIntervalValue:Ue}=N,Qe=F(`contactPoints.${m}.overrideGrouping`),lt=F(`contactPoints.${m}.overrideTimings`),Fe=F(`contactPoints.${m}.groupBy`)?.length??0,Ze=(0,R.of)(M);(0,p.useEffect)(()=>{Qe&&Fe===0&&_(`contactPoints.${m}.groupBy`,Je)},[Qe,_,m,Fe]);const c=(0,e.jsx)("span",{children:", "});return(0,e.jsxs)(y.B,{direction:"column",children:[(0,e.jsxs)(y.B,{direction:"row",gap:1,alignItems:"center",justifyContent:"space-between",children:[(0,e.jsx)(xe.I,{label:(0,u.t)("alerting.routing-settings.label-override-grouping","Override grouping"),transparent:!0,className:Ze.switchElement,children:(0,e.jsx)(se.d,{id:"override-grouping-toggle",...J(`contactPoints.${m}.overrideGrouping`)})}),!Qe&&(0,e.jsx)(l.E,{variant:"body",color:"secondary",children:(0,e.jsxs)(u.x6,{i18nKey:"alerting.routing-settings.grouping",values:{fields:Je.join(", ")},children:["Grouping: ",(0,e.jsx)("strong",{children:"{{fields}}"})]})})]}),Qe&&(0,e.jsx)(D.D,{label:(0,u.t)("alerting.routing-settings.label-group-by","Group by"),description:(0,u.t)("alerting.routing-settings.description-group-by","Combine multiple alerts into a single notification by grouping them by the same label values. If empty, it is inherited from the default notification policy."),...J(`contactPoints.${m}.groupBy`),invalid:!!X.contactPoints?.[m]?.groupBy,className:Ze.optionalContent,children:(0,e.jsx)(s.xI,{rules:{validate:h=>!h||h.length===0?"At least one group by option is required.":h.length===1&&h[0]===ye||Je.every(W=>h.includes(W))?!0:`Group by must include ${Je.join(", ")}`},render:({field:{onChange:h,ref:w,...W},fieldState:{error:je}})=>(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(Pe.KF,{"aria-label":(0,u.t)("alerting.routing-settings.aria-label-group-by","Group by"),...W,allowCustomValue:!0,className:A.input,onCreateOption:U=>{Xe(H=>[...H,(0,re.Mk)(U)]),_(`contactPoints.${m}.groupBy`,[...W.value,U])},onChange:U=>h((0,re.ie)(U)),options:[...re.Yl,...te],components:{MultiValueRemove(U){const{data:H}=U;return H.isFixed?null:(0,Se.p)(U)}}}),je&&(0,e.jsx)(ae.P,{children:je.message})]}),name:`contactPoints.${m}.groupBy`,control:b})}),(0,e.jsxs)(y.B,{direction:"row",gap:1,alignItems:"center",justifyContent:"space-between",children:[(0,e.jsx)(xe.I,{label:(0,u.t)("alerting.routing-settings.label-override-timings","Override timings"),transparent:!0,className:Ze.switchElement,children:(0,e.jsx)(se.d,{id:"override-timings-toggle",...J(`contactPoints.${m}.overrideTimings`)})}),!lt&&(0,e.jsxs)(l.E,{variant:"body",color:"secondary",children:[(0,e.jsxs)(u.x6,{i18nKey:"alerting.routing-settings.group-wait",values:{groupWaitValue:Ke},children:["Group wait: ",(0,e.jsx)("strong",{children:"{{groupWaitValue}}"})]}),c,(0,e.jsxs)(u.x6,{i18nKey:"alerting.routing-settings.group-interval",values:{groupIntervalValue:ke},children:["Group interval: ",(0,e.jsx)("strong",{children:"{{groupIntervalValue}}"})]}),c,(0,e.jsxs)(u.x6,{i18nKey:"alerting.routing-settings.repeat-interval",values:{repeatIntervalValue:Ue},children:["Repeat interval: ",(0,e.jsx)("strong",{children:"{{repeatIntervalValue}}"})]})]})]}),lt&&(0,e.jsx)("div",{className:Ze.optionalContent,children:(0,e.jsx)(ut,{alertManager:m})})]})},M=m=>({switchElement:(0,f.css)({flexFlow:"row-reverse",gap:m.spacing(1),alignItems:"center"}),optionalContent:(0,f.css)({marginLeft:"49px",marginBottom:m.spacing(1)})});function Ae({alertManager:m}){const A=(0,R.of)(ze),b=m.name,{watch:F}=(0,s.xW)(),J=F(`contactPoints.${b}.overrideGrouping`)||F(`contactPoints.${b}.overrideTimings`)||F(`contactPoints.${b}.muteTimeIntervals`)?.length>0;return(0,e.jsxs)(y.B,{direction:"column",children:[(0,e.jsxs)(y.B,{direction:"row",alignItems:"center",children:[(0,e.jsx)("div",{className:A.firstAlertManagerLine}),(0,e.jsxs)("div",{className:A.alertManagerName,children:[(0,e.jsx)(u.x6,{i18nKey:"alerting.rule-form.simple-routing.alertmanager-label",children:"Alertmanager:"}),(0,e.jsx)("img",{src:m.imgUrl,alt:"Alert manager logo",className:A.img}),b]}),(0,e.jsx)("div",{className:A.secondAlertManagerLine})]}),(0,e.jsx)(y.B,{direction:"row",gap:1,alignItems:"center",children:(0,e.jsx)(S,{alertManager:b})}),(0,e.jsx)("div",{className:A.routingSection,children:(0,e.jsx)(le.M,{label:(0,u.t)("alerting.alert-manager-manual-routing.label-muting-grouping-and-timings-optional","Muting, grouping and timings (optional)"),isOpen:J,className:A.collapsableSection,contentClassName:A.collapsableSectionContent,children:(0,e.jsxs)(y.B,{direction:"column",gap:1,children:[(0,e.jsxs)(y.B,{direction:"row",gap:.5,alignItems:"center",children:[(0,e.jsx)(l.E,{variant:"bodySmall",color:"secondary",children:(0,e.jsx)(u.x6,{i18nKey:"alerting.rule-form.simple-routing.optional-settings.description",children:"Configure how notifications for this alert rule are sent."})}),(0,e.jsx)(ee.G,{title:(0,u.t)("alerting.alert-manager-manual-routing.title-muting-grouping-and-timings","Muting, grouping, and timings"),linkText:"Read about notification grouping",externalLink:"https://grafana.com/docs/grafana/latest/alerting/fundamentals/notifications/group-alert-notifications/",contentText:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("p",{children:(0,u.t)("alerting.rule-form.simple-routing.optional-settings.help-info1","Mute timings allows you to temporarily pause notifications for a specific recurring period, such as a regular maintenance window or weekends.")}),(0,u.t)("alerting.rule-form.simple-routing.optional-settings.help-info2","Grouping and timing options combine multiple alerts within a specific period into a single notification, allowing you to customize default options.")]})})]}),(0,e.jsx)(de,{alertmanager:b}),(0,e.jsx)(ot,{alertmanager:b}),(0,e.jsx)(ge,{alertManager:b})]})})})]})}const ze=m=>({firstAlertManagerLine:(0,f.css)({height:1,width:m.spacing(4),backgroundColor:m.colors.secondary.main}),alertManagerName:(0,f.css)({with:"fit-content"}),secondAlertManagerLine:(0,f.css)({height:"1px",width:"100%",flex:1,backgroundColor:m.colors.secondary.main}),img:(0,f.css)({marginLeft:m.spacing(2),width:m.spacing(3),height:m.spacing(3),marginRight:m.spacing(1)}),collapsableSection:(0,f.css)({width:"fit-content",fontSize:m.typography.body.fontSize}),collapsableSectionContent:(0,f.css)({padding:"0"}),routingSection:(0,f.css)({display:"flex",flexDirection:"column",maxWidth:m.breakpoints.values.xl,border:`solid 1px ${m.colors.border.weak}`,borderRadius:m.shape.radius.default,padding:`${m.spacing(1)} ${m.spacing(2)}`,marginTop:m.spacing(2)})});function Le(){const{getValues:m}=(0,s.xW)(),A=m("contactPoints"),J=(0,pe.sq)("notification").availableInternalDataSources.filter(X=>X.hasConfigurationAPI);return(0,p.useMemo)(()=>J.map(X=>{const te=A?A[X.name]:void 0;return{alertManager:X,selectedContactPoint:te?.selectedContactPoint??"",routeSettings:{muteTimeIntervals:te?.muteTimeIntervals??[],activeTimeIntervals:te?.activeTimeIntervals??[],overrideGrouping:te?.overrideGrouping??!1,groupBy:te?.groupBy??[],overrideTimings:te?.overrideTimings??!1,groupWaitValue:te?.groupWaitValue??"",groupIntervalValue:te?.groupIntervalValue??"",repeatIntervalValue:te?.repeatIntervalValue??""}}}),[J,A]).map((X,te)=>(0,e.jsx)(P.b9,{accessType:"notification",alertmanagerSourceName:X.alertManager.name,children:(0,e.jsx)(Ae,{alertManager:X.alertManager})},X.alertManager.name+te))}var Ne=t(25197),st=t(16996),Et=t(45861),it=t(6975),Ut=t(70327);const Rt=(0,p.lazy)(()=>t.e(6865).then(t.bind(t,96865))),gt=({alertQueries:m,customLabels:A,condition:b,folder:F,alertName:J,alertUid:_})=>{const X=!b||!F,te=Ut.hK.endpoints.preview,[Xe,{data:ke=[],isLoading:Ke,isUninitialized:Ue}]=te.useMutation(),Qe=(0,Z.compact)(ke.flatMap(c=>c?.labels)),lt=()=>{!F||!b||Xe({alertQueries:m,condition:b,customLabels:A,folder:F,alertName:J,alertUid:_})},Fe=(0,pe.cy)("notification"),Ze=Fe.length===1;return(0,e.jsxs)(y.B,{direction:"column",children:[(0,e.jsxs)(y.B,{direction:"row",alignItems:"flex-start",justifyContent:"space-between",children:[(0,e.jsxs)(y.B,{direction:"column",gap:1,children:[(0,e.jsx)(l.E,{element:"h5",children:(0,e.jsx)(u.x6,{i18nKey:"alerting.notification-preview.title",children:"Alert instance routing preview"})}),Ke&&Ue&&(0,e.jsx)(l.E,{color:"secondary",variant:"bodySmall",children:(0,e.jsx)(u.x6,{i18nKey:"alerting.common.loading",children:"Loading..."})}),Ue?(0,e.jsx)(l.E,{color:"secondary",variant:"bodySmall",children:(0,e.jsx)(u.x6,{i18nKey:"alerting.notification-preview.uninitialized",children:'When you have your folder selected and your query and labels are configured, click "Preview routing" to see the results here.'})}):(0,e.jsx)(l.E,{color:"secondary",variant:"bodySmall",children:(0,e.jsx)(u.x6,{i18nKey:"alerting.notification-preview.initialized",children:"Based on the labels added, alert instances are routed to the following notification policies. Expand each notification policy below to view more details."})})]}),(0,e.jsx)(Et.$n,{icon:"sync",variant:"secondary",type:"button",onClick:lt,disabled:X,children:(0,e.jsx)(u.x6,{i18nKey:"alerting.notification-preview.preview-routing",children:"Preview routing"})})]}),!Ke&&!Ue&&Qe.length>0&&(0,e.jsx)(p.Suspense,{fallback:(0,e.jsx)(it._,{text:(0,u.t)("alerting.notification-preview.text-loading-preview","Loading preview...")}),children:Fe.map(c=>(0,e.jsx)(Rt,{alertManagerSource:c,potentialInstances:Qe,onlyOneAM:Ze},c.name))})]})};var pt=(m=>(m.NotificationPolicy="notification policy",m.ContactPoint="contact point",m))(pt||{});function Pt(){const{useGetGrafanaAlertingConfigurationStatusQuery:m}=K.m,{currentData:A}=m(void 0);return A?.alertmanagersChoice===I.nA.Internal||A?.alertmanagersChoice===I.nA.All}const Qt=({alertUid:m})=>{const{watch:A,getValues:b,setValue:F}=(0,s.xW)(),J=(0,R.of)(Dt),[_,X]=A(["type","manualRouting"]),[te,Xe]=(0,p.useState)(!1),ke=A("dataSourceName")??pe.hY,Ke=(0,ce.H2)(_),Ue=z.$.featureToggles.alertingNotificationsStepMode??!1,Qe=_===V.Z.grafana,lt=Pt(),Fe=_===V.Z.grafana&&lt;function Ze(W){W&&F("labels",W),Xe(!1)}if((0,ce.pq)(_))return null;const c=Ke?5:4,h=Ke&&Ue?{isAdvancedMode:!X,setAdvancedMode:W=>{F("editorSettings.simplifiedNotificationEditor",!W),F("manualRouting",!W)}}:void 0,w=(0,ce.vE)(_)?"Add labels":Ke?"Configure notifications":"Configure labels and notifications";return(0,e.jsxs)(q.P,{stepNo:c,title:w,description:(0,e.jsx)(y.B,{direction:"row",gap:.5,alignItems:"center",children:(0,ce.vE)(_)?(0,e.jsx)(l.E,{variant:"bodySmall",color:"secondary",children:(0,e.jsx)(u.x6,{i18nKey:"alerting.notifications-step.labels-better-manage-recording-rules",children:"Add labels to help you better manage your recording rules."})}):Fe&&(0,e.jsx)(l.E,{variant:"bodySmall",color:"secondary",children:(0,e.jsx)(u.x6,{i18nKey:"alerting.notifications-step.recipient-notification-fires",children:"Select who should receive a notification when an alert rule fires."})})}),switchMode:h,fullWidth:!0,children:[!Ke&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(st.t,{onEditClick:()=>Xe(!0)}),(0,e.jsx)(Ne.A,{isOpen:te,onClose:Ze,dataSourceName:ke,initialLabels:b("labels")})]}),Fe&&(0,e.jsx)("div",{className:J.configureNotifications,children:(0,e.jsx)(l.E,{element:"h5",children:(0,e.jsx)(u.x6,{i18nKey:"alerting.notifications-step.recipient",children:"Recipient"})})}),Fe&&Ue&&(0,e.jsx)(Gt,{alertUid:m}),Fe&&!Ue&&(0,e.jsx)(It,{alertUid:m}),!Fe&&Qe&&(0,e.jsx)(Ct,{alertUid:m})]})};function It({alertUid:m}){const{watch:A,setValue:b}=(0,s.xW)(),F=(0,R.of)(Dt),[J]=A(["manualRouting"]),_=[{label:(0,u.t)("alerting.manual-and-automatic-routing.routing-options.label.select-contact-point","Select contact point"),value:"contact point"},{label:(0,u.t)("alerting.manual-and-automatic-routing.routing-options.label.use-notification-policy","Use notification policy"),value:"notification policy"}],X=te=>{b("manualRouting",te==="contact point")};return(0,e.jsxs)(y.B,{direction:"column",gap:2,children:[(0,e.jsx)(y.B,{direction:"column",children:(0,e.jsx)(k.z,{"data-testid":J?"routing-options-contact-point":"routing-options-notification-policy",options:_,value:J?"contact point":"notification policy",onChange:X,className:F.routingOptions})}),(0,e.jsx)(Ot,{manualRouting:J}),J?(0,e.jsx)(Le,{}):(0,e.jsx)(Ct,{alertUid:m})]})}function Gt({alertUid:m}){const{watch:A}=(0,s.xW)(),[b]=A(["manualRouting"]);return(0,e.jsxs)(y.B,{direction:"column",gap:2,children:[(0,e.jsx)(Ot,{manualRouting:b}),b?(0,e.jsx)(Le,{}):(0,e.jsx)(Ct,{alertUid:m})]})}function Ct({alertUid:m}){const{watch:A}=(0,s.xW)(),[b,F,J,_,X]=A(["labels","queries","condition","folder","name","manualRouting"]);return(0,e.jsx)(gt,{alertQueries:F,customLabels:b,condition:J,folder:_,alertName:X,alertUid:m})}function wt(){return(0,e.jsx)(ee.G,{contentText:(0,e.jsxs)(y.B,{gap:1,direction:"column",children:[(0,e.jsx)(y.B,{direction:"column",gap:0,children:(0,e.jsx)(u.x6,{i18nKey:"alerting.need-help-info-for-notification-policy.notification-policies",children:"Firing alert instances are routed to notification policies based on matching labels. The default notification policy matches all alert instances."})}),(0,e.jsxs)(y.B,{direction:"column",gap:0,children:[(0,e.jsx)(u.x6,{i18nKey:"alerting.need-help-info-for-notification-policy.custom-labels",children:"Custom labels change the way your notifications are routed. First, add labels to your alert rule and then connect them to your notification policy by adding label matchers."}),(0,e.jsx)(T.Y,{href:"https://grafana.com/docs/grafana/latest/alerting/fundamentals/notifications/notification-policies/",external:!0,children:(0,e.jsx)(u.x6,{i18nKey:"alerting.need-help-info-for-notification-policy.read-more",children:"Read about notification policies."})})]})]}),title:(0,u.t)("alerting.need-help-info-for-notification-policy.title-notification-routing","Notification routing")})}function Vt(){return(0,e.jsx)(ee.G,{contentText:(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(u.x6,{i18nKey:"alerting.need-help-info-for-contactpoint.select-contact-point",children:"Select a contact point to notify all recipients in it."}),(0,e.jsx)("br",{}),(0,e.jsx)(u.x6,{i18nKey:"alerting.need-help-info-for-contactpoint.customize-notifications",children:"Muting, grouping, and timings options allow you to customize how notifications are sent."}),(0,e.jsx)("br",{}),(0,e.jsx)("br",{}),(0,e.jsxs)(u.x6,{i18nKey:"alerting.need-help-info-for-contactpoint.notification-policies",children:["Alternatively, toggle the ",(0,e.jsx)("b",{children:"Advanced options"})," button to route notifications using notification policies for greater flexibility."]})]}),externalLink:"https://grafana.com/docs/grafana/latest/alerting/fundamentals/notifications/",linkText:"Read more about notifications",title:(0,u.t)("alerting.need-help-info-for-contactpoint.title-notify-by-selecting-a-contact-point","Notify by selecting a contact point")})}const Ot=({manualRouting:m})=>(0,e.jsxs)(y.B,{alignItems:"center",children:[(0,e.jsx)(l.E,{variant:"bodySmall",color:"secondary",children:m?(0,u.t)("alerting.routing-option-description.manual","Notifications for firing alerts are routed to a selected contact point."):(0,u.t)("alerting.routing-option-description.matching-labels","Notifications for firing alerts are routed to contact points based on matching labels and the notification policy tree.")}),m?(0,e.jsx)(Vt,{}):(0,e.jsx)(wt,{})]}),Dt=m=>({routingOptions:(0,f.css)({width:"fit-content"}),configureNotifications:(0,f.css)({display:"flex",flexDirection:"column",marginTop:m.spacing(2)})})},98395:(We,Y,t)=>{t.d(Y,{H:()=>pe});var e=t(74848),f=t(49785),p=t(51898),s=t(92745),u=t(66404),z=t(41654),R=t(37386),y=t(63527),l=t(76792),k=t(67817),T=t(52161),I=t(29609),K=t(58872);const V=ce=>({message:(0,I.pq)(ce)?"Recording rule metric must be valid metric name. It may only contain letters, numbers, and colons. It may not contain whitespace.":"Recording rule name must be valid metric name. It may only contain letters, numbers, and colons. It may not contain whitespace.",value:/^[a-zA-Z_:][a-zA-Z0-9_:]*$/}),pe=()=>{const{control:ce,register:ee,watch:q,formState:{errors:P},setValue:le}=(0,f.xW)(),C=q("type");if(!C)return null;const Z=(0,I.vE)(C),ue=(0,I.pq)(C),O=(0,I.OF)(C),D=ue?"recording rule and metric":"recording rule",ae=Z?"recording rule":"alert rule",fe=Z?D:"alert rule";return(0,e.jsx)(K.P,{stepNo:1,title:(0,s.t)("alerting.alert-rule-name-and-metric.title-section","Enter {{entityName}} name",{entityName:fe}),description:(0,e.jsx)(u.E,{variant:"bodySmall",color:"secondary",children:(0,e.jsxs)(s.x6,{i18nKey:"alerting.alert-rule-name-and-metric.description-section",children:["Enter a name to identify your ",{entityName:fe},"."]})}),children:(0,e.jsxs)(z.B,{direction:"column",children:[(0,e.jsx)(R.D,{label:(0,s.t)("alerting.alert-rule-name-and-metric.label-name","Name"),error:P?.name?.message,invalid:!!P.name?.message,children:(0,e.jsx)(y.p,{"data-testid":p.Tp.components.AlertRules.ruleNameField,id:"name",width:38,...ee("name",{required:{value:!0,message:(0,s.t)("alerting.alert-rule-name-and-metric.message.must-enter-a-name","Must enter a name")},pattern:O?V(k.Z.cloudRecording):void 0}),"aria-label":(0,s.t)("alerting.alert-rule-name-and-metric.aria-label-name","name"),placeholder:(0,s.t)("alerting.alert-rule-name-and-metric.placeholder-name","Give your {{namePlaceholder}} a name",{namePlaceholder:ae})})}),ue&&(0,e.jsx)(R.D,{label:(0,s.t)("alerting.alert-rule-name-and-metric.label-metric","Metric"),error:P?.metric?.message,invalid:!!P.metric?.message,children:(0,e.jsx)(y.p,{id:"metric",width:38,...ee("metric",{required:{value:!0,message:(0,s.t)("alerting.alert-rule-name-and-metric.message.must-enter-a-metric-name","Must enter a metric name")},pattern:V(k.Z.grafanaRecording)}),"aria-label":(0,s.t)("alerting.alert-rule-name-and-metric.metric-aria-label-metric","metric"),placeholder:(0,s.t)("alerting.alert-rule-name-and-metric.metric-placeholder-recorded-metric","Give the name of the new recorded metric")})}),ue&&(0,e.jsx)(R.D,{id:"target-data-source","data-testid":"target-data-source",label:(0,s.t)("alerting.recording-rules.label-target-data-source","Target data source"),description:(0,s.t)("alerting.recording-rules.description-target-data-source","The Prometheus data source to store recording rules in"),error:P.targetDatasourceUid?.message,invalid:!!P.targetDatasourceUid?.message,children:(0,e.jsx)(f.xI,{render:({field:{onChange:S,ref:Ee,...$}})=>(0,e.jsx)(l.sk,{...$,current:$.value,noDefault:!0,filter:T.Gb,onChange:re=>{le("targetDatasourceUid",re.uid)}}),name:"targetDatasourceUid",control:ce,rules:{required:{value:!0,message:(0,s.t)("alerting.alert-rule-name-and-metric.message.please-select-a-data-source","Please select a data source")}}})})]})})}}}]);

//# sourceMappingURL=AlertingRuleForm.8dd7a77627770059a3aa.js.map