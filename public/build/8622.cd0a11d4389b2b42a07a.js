"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[8622],{45517:(Ie,le,t)=>{t.d(le,{k:()=>s});var e=t(74848),C=t(22803),c=t(49785),o=t(92745),ce=t(68143),_=t(63142),M=t(34999),U=t(41654),b=t(37386),ee=t(63527),T=t(45861),de=t(64762),me=t(38396),H=t(97507),te=t(28141),J=t(47797),ge=t(74268),Q=t(77788),ue=t(82203),S=t(77256),R=t(36200),V=t(2543),A=t(96540),fe=t(18857),X=t(66404),ne=t(98127),se=t(53226),he=t(48767),ve=t(28365);function ae({defaultValues:n,selectedChannelOptions:i,onResetSecureField:d,onDeleteSubform:N,errors:K,integrationPrefix:h,readOnly:I=!1,customValidators:r={}}){const{watch:y}=(0,c.xW)(),[F,v]=y([`${h}.settings`,`${h}.secureFields`]),O=`${h}.settings.`,L=a=>({required:ie(a,F,v),readOnly:re(a,F,v)});return(0,e.jsx)(e.Fragment,{children:i.map((a,D)=>{const $=`${a.label}-${D}`,Y=F?.[a.showWhen.field];if(a.showWhen.field&&Y!==a.showWhen.is)return null;if(v&&v[a.secureFieldKey??a.propertyName])return(0,e.jsx)(b.D,{label:a.label,description:a.description,htmlFor:`${O}${a.propertyName}`,children:(0,e.jsx)(he.L4,{id:`${O}${a.propertyName}`,onReset:()=>d(a.secureFieldKey??a.propertyName),isConfigured:!0})},$);const w=(a.secure?K?.secureFields:K?.settings)?.[a.secureFieldKey??a.propertyName],z=n?.settings?.[a.propertyName];return(0,e.jsx)(ve.e,{secureFields:v,onResetSecureField:d,onDeleteSubform:N,defaultValue:z,readOnly:I,error:w,pathPrefix:O,option:a,customValidator:r[a.propertyName],getOptionMeta:L},$)})})}const ie=(n,i,d)=>n.required?n.dependsOn?!!i[n.dependsOn]||!!d[n.dependsOn]?!1:"Required":n.required?"Required":!1:!1,re=(n,i,d)=>n.dependsOn?!!i[n.dependsOn]||!!d[n.dependsOn]:!1;var Z=t(83904);function je({defaultValues:n,initialValues:i,pathPrefix:d,integrationIndex:N,onDuplicate:K,onDelete:h,onTest:I,notifiers:r,errors:y,commonSettingsComponent:F,isEditable:v=!0,isTestable:O,customValidators:L={}}){const a=(0,_.of)(Se),{control:D,watch:$,register:Y,trigger:w,formState:z,setValue:P,getValues:ye}=(0,c.xW)(),u=`items.${N}`,m=`${u}.type`,p=`${u}.settings`,G=$(m)??n.type,k=$(`${p}.parse_mode`),{loading:Ce}=(0,ne.$)(l=>l.testReceivers),be=$(`${p}.integration_type`)!==se.U0.NewIntegration;(0,A.useEffect)(()=>{Y(`${u}.__id`),Y(`${u}.secureFields`)},[Y,u]),(0,A.useEffect)(()=>{const l=$((j,{name:f,type:pe})=>{const Fe=f?j[f]:"";i&&f===m&&Fe===i.type&&pe==="change"&&P(p,i.settings),i&&f===`${p}.integration_type`&&Fe===se.U0.ExistingIntegration&&P(`${p}.url`,i.settings.url)});return()=>l.unsubscribe()},[G,i,P,p,m,$]);const x=l=>{const j=ye(`${u}.secureFields`);j[l]&&P(`${u}.secureFields`,{...j,[l]:""})},g=l=>{const j=[];return l?.forEach(f=>{f.secure&&f.secureFieldKey&&j.push(f.secureFieldKey),f.subformOptions&&j.push(...g(f.subformOptions))}),j},E=(l,j)=>{g(j.subformOptions??[]).forEach(Fe=>{x(Fe)});const pe=l.startsWith(`${u}.settings.`)?l.slice(`${u}.settings.`.length):l;P(`${p}.${pe}`,void 0)},Te=(0,A.useMemo)(()=>(0,V.sortBy)(r,({dto:l,meta:j})=>[j?.order??0,l.name]).map(({dto:{name:l,type:j},meta:f})=>({label:(0,e.jsxs)(U.B,{alignItems:"center",gap:1,children:[l,f?.badge]}),value:j,description:f?.description,isDisabled:f?!f.enabled:!1})),[r]),q=async()=>{await w(),Object.keys(z.errors).length===0&&I&&I()},oe=r.find(({dto:{type:l}})=>l===G),Me=G==="telegram"&&!(k==="None"||!k),Re=oe?.dto.options.filter(l=>l.required)??[],Ae=oe?.dto.options.filter(l=>!l.required)??[],De=`contact-point-type-${d}`;return(0,e.jsxs)("div",{className:a.wrapper,"data-testid":"item-container",children:[(0,e.jsxs)("div",{className:a.topRow,children:[(0,e.jsx)("div",{children:(0,e.jsx)(b.D,{label:(0,o.t)("alerting.channel-sub-form.label-integration","Integration"),htmlFor:De,"data-testid":`${d}type`,children:(0,e.jsx)(c.xI,{name:m,control:D,defaultValue:n.type,render:({field:{ref:l,onChange:j,...f}})=>(0,e.jsx)(fe.l6,{disabled:!v,inputId:De,...f,width:37,options:Te,onChange:pe=>j(pe?.value)})})})}),(0,e.jsxs)("div",{className:a.buttons,children:[O&&I&&be&&(0,e.jsx)(T.$n,{disabled:Ce,size:"xs",variant:"secondary",type:"button",onClick:()=>q(),icon:Ce?"spinner":"message",children:(0,e.jsx)(o.x6,{i18nKey:"alerting.channel-sub-form.test",children:"Test"})}),v&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(T.$n,{size:"xs",variant:"secondary",type:"button",onClick:()=>K(),icon:"copy",children:(0,e.jsx)(o.x6,{i18nKey:"alerting.channel-sub-form.duplicate",children:"Duplicate"})}),h&&(0,e.jsx)(T.$n,{"data-testid":`${d}delete-button`,size:"xs",variant:"secondary",type:"button",onClick:()=>h(),icon:"trash-alt",children:(0,e.jsx)(o.x6,{i18nKey:"alerting.channel-sub-form.delete",children:"Delete"})})]})]})]}),oe&&(0,e.jsxs)("div",{className:a.innerContent,children:[Me&&(0,e.jsx)(M.F,{title:(0,o.t)("alerting.contact-points.telegram.parse-mode-warning-title","Telegram messages are limited to 4096 UTF-8 characters."),severity:"warning",children:(0,e.jsxs)(o.x6,{i18nKey:"alerting.contact-points.telegram.parse-mode-warning-body",children:["If you use a ",(0,e.jsx)(X.E,{variant:"code",children:"parse_mode"})," option other than ",(0,e.jsx)(X.E,{variant:"code",children:"None"}),", truncation may result in an invalid message, causing the notification to fail. For longer messages, we recommend using an alternative contact method."]})}),(0,e.jsx)(ae,{defaultValues:n,selectedChannelOptions:Re.length?Re:Ae,errors:y,onResetSecureField:x,onDeleteSubform:E,integrationPrefix:u,readOnly:!v,customValidators:L}),!!(Re.length&&Ae.length)&&(0,e.jsxs)(Z.i,{label:(0,o.t)("alerting.channel-sub-form.label-section","Optional {{name}} settings",{name:oe.dto.name}),children:[oe.dto.info!==""&&(0,e.jsx)(M.F,{title:"",severity:"info",children:oe.dto.info}),(0,e.jsx)(ae,{defaultValues:n,selectedChannelOptions:Ae,onResetSecureField:x,onDeleteSubform:E,errors:y,integrationPrefix:u,readOnly:!v,customValidators:L})]}),(0,e.jsx)(Z.i,{label:(0,o.t)("alerting.channel-sub-form.label-notification-settings","Notification settings"),children:(0,e.jsx)(F,{pathPrefix:d,readOnly:!v})})]})]})}const Se=n=>({buttons:(0,C.css)({"& > * + *":{marginLeft:n.spacing(1)}}),innerContent:(0,C.css)({maxWidth:"536px"}),wrapper:(0,C.css)({margin:n.spacing(2,0),padding:n.spacing(1),border:`solid 1px ${n.colors.border.medium}`,borderRadius:n.shape.radius.default}),topRow:(0,C.css)({display:"flex",flexDirection:"row",justifyContent:"space-between"}),channelSettingsHeader:(0,C.css)({marginTop:n.spacing(2)})});function Oe({pathPrefix:n}){const{register:i}=(0,c.xW)();return(0,A.useEffect)(()=>{i(`${n}.__id`),i(`${n}.__deleted`)},[i,n]),(0,e.jsx)(e.Fragment,{children:null})}function xe(n){if(n)return{...n,items:n.items.map(i=>({...i,settings:{...i.settings,http_config:i.settings?.http_config?Ne(i.settings?.http_config):void 0}}))}}function Ne(n){return $e(n)?n:{...(0,V.omit)(n,"authorization"),bearer_token:n.authorization?.credentials,bearer_token_file:n.authorization?.credentials_file}}function $e(n){return["bearer_token","bearer_token_file"].some(i=>i in n)}function s({initialValues:n,defaultItem:i,notifiers:d,alertManagerSourceName:N,onSubmit:K,onTestChannel:h,commonSettingsComponent:I,isEditable:r,isTestable:y,customValidators:F,showDefaultRouteWarning:v,contactPointId:O,canManagePermissions:L}){const a=(0,de._2)(),D=(0,_.of)(W),$=(0,H.cB)({alertmanager:N}),w=xe(n)??{name:"",items:[{...i,__id:String(Math.random())}]},z=(0,c.mN)({defaultValues:structuredClone(w)});(0,me.o)(x=>x.unifiedAlerting.saveAMConfig=R.jA);const{handleSubmit:P,register:ye,formState:{errors:u,isSubmitting:m},getValues:p}=z,{fields:G,append:k,remove:Ce}=(0,ue.r)({name:"items",formAPI:z,softDelete:!0}),Ke=async x=>{try{await K({...x,items:x.items.filter(g=>!g.__deleted)})}catch(g){if(g instanceof Error||(0,ce.NF)(g)){a.error("Failed to save the contact point",B(g));const E=new Error("Failed to save the contact point");E.cause=g,(0,ge.vV)(E)}throw g}},be=()=>{a.error("There are errors in the form. Please correct them and try again!")};return(0,e.jsxs)(c.Op,{...z,children:[v&&(0,e.jsx)(M.F,{severity:"warning",title:(0,o.t)("alerting.receiver-form.title-attention","Attention"),children:(0,e.jsx)(o.x6,{i18nKey:"alerting.receiver-form.body-attention",children:"Because there is no default policy configured yet, this contact point will automatically be set as default."})}),(0,e.jsxs)("form",{onSubmit:P(Ke,be),className:D.wrapper,children:[(0,e.jsxs)(U.B,{justifyContent:"space-between",alignItems:"center",children:[(0,e.jsxs)("h2",{className:D.heading,children:[!r&&(0,o.t)("alerting.receiver-form.contact-point","Contact point"),r&&n&&(0,o.t)("alerting.receiver-form.contact-point-update","Update contact point"),r&&!n&&(0,o.t)("alerting.receiver-form.contact-point-create","Create contact point")]}),L&&O&&(0,e.jsx)(te.k,{resource:"receivers",resourceId:O,resourceName:n?.name,title:(0,o.t)("alerting.receiver-form.title-manage-contact-point-permissions","Manage contact point permissions")})]}),(0,e.jsx)(b.D,{label:(0,o.t)("alerting.receiver-form.label-name","Name"),invalid:!!u.name,error:u.name&&u.name.message,required:!0,children:(0,e.jsx)(ee.p,{readOnly:!r,id:"name",...ye("name",{required:"Name is required",validate:async x=>{const g=n?.name;return $(x,g)}}),width:39,placeholder:(0,o.t)("alerting.receiver-form.name-placeholder-name","Name")})}),G.map((x,g)=>{const E=`items.${g}.`;if(x.__deleted)return(0,e.jsx)(Oe,{pathPrefix:E},x.__id);const Te=n?.items.find(({__id:q})=>q===x.__id);return(0,e.jsx)(je,{defaultValues:x,initialValues:Te,integrationIndex:g,onDuplicate:()=>{const q=p().items[g];k({...q,__id:String(Math.random())})},onTest:h?()=>{const q=p().items[g];h(q)}:void 0,onDelete:()=>Ce(g),pathPrefix:E,notifiers:d,errors:u?.items?.[g],commonSettingsComponent:I,isEditable:r,isTestable:y,customValidators:F?F[x.type]:void 0},x.__id)}),r&&(0,e.jsx)(T.$n,{type:"button",icon:"plus",variant:"secondary",onClick:()=>k({...i,__id:String(Math.random())}),children:(0,e.jsx)(o.x6,{i18nKey:"alerting.receiver-form.add-contact-point-integration",children:"Add contact point integration"})}),(0,e.jsxs)("div",{className:D.buttons,children:[r&&(0,e.jsxs)(e.Fragment,{children:[m&&(0,e.jsx)(T.$n,{disabled:!0,icon:"spinner",variant:"primary",children:(0,e.jsx)(o.x6,{i18nKey:"alerting.receiver-form.saving",children:"Saving..."})}),!m&&(0,e.jsx)(T.$n,{type:"submit",children:(0,e.jsx)(o.x6,{i18nKey:"alerting.receiver-form.save-contact-point",children:"Save contact point"})})]}),(0,e.jsx)(T.z9,{disabled:m,variant:"secondary","data-testid":"cancel-button",href:(0,S.nL)("/alerting/notifications",N),children:(0,e.jsx)(o.x6,{i18nKey:"alerting.common.cancel",children:"Cancel"})})]})]})]})}const W=n=>({heading:(0,C.css)({margin:n.spacing(2,0,3,0)}),buttons:(0,C.css)({marginTop:n.spacing(4),"& > * + *":{marginLeft:n.spacing(1)}}),wrapper:(0,C.css)({maxWidth:`${n.breakpoints.values.xl}px`})});function B(n){return(0,Q.uz)(n)?n.data.detail:(0,J.q6)(n)}},74572:(Ie,le,t)=>{t.d(le,{B:()=>ue});var e=t(74848),C=t(96540),c=t(92745),o=t(36490),ce=t(34999),_=t(91984),M=t(97507),U=t(51740),b=t(52161),ee=t(22316),T=t(49785),de=t(37386),me=t(32635);const H=({pathPrefix:S,className:R,readOnly:V=!1})=>{const{register:A}=(0,T.xW)();return(0,e.jsx)("div",{className:R,children:(0,e.jsx)(de.D,{disabled:V,children:(0,e.jsx)(me.S,{...A(`${S}sendResolved`),label:(0,c.t)("alerting.cloud-common-channel-settings.label-send-resolved","Send resolved"),disabled:V,description:(0,c.t)("alerting.cloud-common-channel-settings.description-whether-notify-about-resolved-alerts","Whether or not to notify about resolved alerts.")})})})};var te=t(45517);const J=Object.freeze({__id:"",sendResolved:!0,secureSettings:{},settings:{},secureFields:{},type:"email"}),ge=U.r.map(S=>({dto:S})),{useGetAlertmanagerConfigurationQuery:Q}=_.m,ue=({contactPoint:S,alertManagerSourceName:R,readOnly:V=!1,editMode:A})=>{const{isLoading:fe,data:X}=Q(R),ne=(0,b.AL)(R),[se]=(0,M.Kt)({alertmanager:R}),[he]=(0,M.Pm)({alertmanager:R}),[ve]=(0,C.useMemo)(()=>S?(0,ee.Iq)(S,U.r):[void 0,{}],[S]),ae=async re=>{const Z=(0,ee.QX)(re,J);try{A&&S?await he.execute({contactPoint:Z,originalName:S.name}):await se.execute({contactPoint:Z}),o.Ny.push("/alerting/notifications")}catch{}},ie=!V&&!ne;return(0,e.jsxs)(e.Fragment,{children:[!ne&&(0,e.jsx)(ce.F,{title:(0,c.t)("alerting.cloud-receiver-form.title-info","Info"),severity:"info",children:(0,e.jsx)(c.x6,{i18nKey:"alerting.cloud-receiver-form.body-info",children:"Note that empty string values will be replaced with global defaults where appropriate."})}),(0,e.jsx)(te.k,{showDefaultRouteWarning:!fe&&!X?.alertmanager_config.route,isEditable:ie,isTestable:ie,onSubmit:ae,initialValues:ve,notifiers:ge,alertManagerSourceName:R,defaultItem:J,commonSettingsComponent:H})]})}},75887:(Ie,le,t)=>{t.d(le,{a:()=>$e});var e=t(74848),C=t(96540),c=t(92745),o=t(36490),ce=t(6975),_=t(34999),M=t(97507),U=t(66056),b=t(52161),ee=t(56476),T=t(52763),de=t(91984),me=t(11018),H=t(22316),te=t(1972),J=t(6135),ge=t(53226),Q=t(49785),ue=t(37386),S=t(32635);const R=({pathPrefix:s,className:W,readOnly:B=!1})=>{const{register:n}=(0,Q.xW)();return(0,e.jsx)("div",{className:W,children:(0,e.jsx)(ue.D,{children:(0,e.jsx)(S.S,{...n(`${s}disableResolveMessage`),label:(0,c.t)("alerting.grafana-common-channel-settings.label-disable-resolved-message","Disable resolved message"),description:(0,c.t)("alerting.grafana-common-channel-settings.description-disable-resolved-message","Disable the resolve message [OK] that is sent when alerting state returns to false"),disabled:B})})})};var V=t(45517),A=t(22803),fe=t(63142),X=t(22787),ne=t(72636),se=t(77824),he=t(45861),ve=t(95443),ae=t(20593),ie=t(8402),re=(s=>(s.predefined="Predefined",s.custom="Custom",s))(re||{});const Z=Object.values(re).map(s=>({label:s,value:s})),je={annotations:[...ve.kl],labels:[{key:"",value:""}]},Se=({isOpen:s,onDismiss:W,onTest:B})=>{const[n,i]=(0,C.useState)("Predefined"),d=(0,fe.of)(Oe),N=(0,Q.mN)({defaultValues:je,mode:"onBlur"}),K=h=>{if(n==="Custom"){const I={annotations:h.annotations.filter(({key:r,value:y})=>!!r&&!!y).reduce((r,{key:y,value:F})=>({...r,[y]:F}),{}),labels:h.labels.filter(({key:r,value:y})=>!!r&&!!y).reduce((r,{key:y,value:F})=>({...r,[y]:F}),{})};B(I)}else B()};return(0,e.jsxs)(X.a,{onDismiss:W,isOpen:s,title:(0,c.t)("alerting.test-contact-point-modal.title-test-contact-point","Test contact point"),children:[(0,e.jsxs)("div",{className:d.section,children:[(0,e.jsx)(ne.J,{children:(0,e.jsx)(c.x6,{i18nKey:"alerting.test-contact-point-modal.notification-message",children:"Notification message"})}),(0,e.jsx)(se.z,{options:Z,value:n,onChange:h=>i(h)})]}),(0,e.jsx)(Q.Op,{...N,children:(0,e.jsxs)("form",{onSubmit:N.handleSubmit(K),children:[n==="Predefined"&&(0,e.jsx)("div",{className:d.section,children:(0,e.jsxs)(c.x6,{i18nKey:"alerting.test-contact-point-modal.predefined-notification-message",children:["You will send a test notification that uses a predefined alert. If you have defined a custom template or message, for better results switch to ",(0,e.jsx)("strong",{children:"custom"})," notification message, from above."]})}),n==="Custom"&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("div",{className:d.section,children:(0,e.jsx)(c.x6,{i18nKey:"alerting.test-contact-point-modal.custom-notification-message",children:"You will send a test notification that uses the annotations defined below. This is a good option if you use custom templates and messages."})}),(0,e.jsx)("div",{className:d.section,children:(0,e.jsx)(ae.A,{})}),(0,e.jsx)("div",{className:d.section,children:(0,e.jsx)(ie.Ay,{})})]}),(0,e.jsx)(X.a.ButtonRow,{children:(0,e.jsx)(he.$n,{type:"submit",children:(0,e.jsx)(c.x6,{i18nKey:"alerting.test-contact-point-modal.send-test-notification",children:"Send test notification"})})})]})})]})},Oe=s=>({flexRow:(0,A.css)({display:"flex",flexDirection:"row",alignItems:"flex-start",marginBottom:s.spacing(1)}),section:(0,A.css)({marginBottom:s.spacing(2)})}),xe=Object.freeze({__id:"",secureSettings:{},settings:{},secureFields:{},disableResolveMessage:!1,type:"email"}),{useGrafanaNotifiersQuery:Ne}=de.m,$e=({contactPoint:s,readOnly:W=!1,editMode:B})=>{const n=(0,T.wA)(),[i]=(0,M.Kt)({alertmanager:b.hY}),[d]=(0,M.Pm)({alertmanager:b.hY}),{onCallNotifierMeta:N,extendOnCallNotifierFeatures:K,extendOnCallReceivers:h,onCallFormValidators:I,isLoadingOnCallIntegration:r,hasOnCallError:y}=(0,ge.VY)(),{data:F=[],isLoading:v}=Ne(),[O,L]=(0,C.useState)(),[a,D]=(0,C.useMemo)(()=>!s||v||r?[void 0,{}]:(0,H.Xo)(h(s)),[s,v,h,r]),$=async m=>{const p=(0,H.bB)(m,D,xe);try{B?s&&s.id?await d.execute({contactPoint:p,id:s.id,resourceVersion:s?.metadata?.resourceVersion}):s&&await d.execute({contactPoint:p,originalName:s.name}):await i.execute({contactPoint:p}),o.Ny.push("/alerting/notifications")}catch{}},Y=m=>{L(m)},w=m=>{if(O){const p=D[O.__id],G=(0,H.qg)(O,xe,"test",p),k={alertManagerSourceName:b.hY,receivers:[{name:"test",grafana_managed_receiver_configs:[G]}],alert:m};n((0,me.bO)(k))}},z=s?(0,ee.Au)(s):!0,P=!W&&z&&!s?.provisioned,ye=!W;if(v||r)return(0,e.jsx)(ce._,{text:(0,c.t)("alerting.grafana-receiver-form.text-loading-notifiers","Loading notifiers...")});const u=F.map(m=>m.type===J.J4.OnCall?{dto:K(m),meta:N}:{dto:m});return(0,e.jsxs)(e.Fragment,{children:[y&&(0,e.jsx)(_.F,{severity:"error",title:(0,c.t)("alerting.grafana-receiver-form.title-loading-on-call-integration-failed","Loading OnCall integration failed"),children:(0,e.jsx)(c.x6,{i18nKey:"alerting.grafana-receiver-form.body-loading-on-call-integration-failed",children:"Grafana OnCall plugin has been enabled in your Grafana instances but it is not reachable. Please check the plugin configuration"})}),s?.provisioned&&(0,e.jsx)(te.Yi,{resource:te.hk.ContactPoint}),(0,e.jsx)(V.k,{contactPointId:s?.id,isEditable:P,isTestable:ye,onSubmit:$,initialValues:a,onTestChannel:Y,notifiers:u,alertManagerSourceName:b.hY,defaultItem:{...xe},commonSettingsComponent:R,customValidators:{[J.J4.OnCall]:I},canManagePermissions:B&&s&&(0,U.T8)(b.hY,s)}),(0,e.jsx)(Se,{onDismiss:()=>L(void 0),isOpen:!!O,onTest:m=>w(m)})]})}}}]);

//# sourceMappingURL=8622.cd0a11d4389b2b42a07a.js.map