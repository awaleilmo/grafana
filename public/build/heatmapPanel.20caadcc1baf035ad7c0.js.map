{"version":3,"file":"heatmapPanel.20caadcc1baf035ad7c0.js","mappings":"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","sources":["webpack://grafana/./public/app/plugins/panel/heatmap/renderHistogram.tsx","webpack://grafana/./public/app/plugins/panel/heatmap/tooltip/utils.ts","webpack://grafana/./public/app/plugins/panel/heatmap/HeatmapTooltip.tsx","webpack://grafana/./public/app/plugins/panel/heatmap/fields.ts","webpack://grafana/./public/app/plugins/panel/heatmap/palettes.ts","webpack://grafana/./public/app/plugins/panel/heatmap/HeatmapPanel.tsx","webpack://grafana/./public/app/plugins/panel/heatmap/migrations.ts","webpack://grafana/./public/app/plugins/panel/heatmap/suggestions.ts","webpack://grafana/./public/app/plugins/panel/heatmap/module.tsx","webpack://grafana/./public/app/core/components/ColorScale/ColorScale.tsx","webpack://grafana/./packages/grafana-prometheus/src/result_transformer.ts","webpack://grafana/./public/app/features/visualization/data-hover/ExemplarTooltip.tsx"],"sourcesContent":["export function renderHistogram(\n  can: React.RefObject<HTMLCanvasElement>,\n  histCanWidth: number,\n  histCanHeight: number,\n  xVals: number[],\n  countVals: number[],\n  index: number,\n  yBucketCount: number\n) {\n  let histCtx = can.current?.getContext('2d');\n\n  if (histCtx != null) {\n    const barsGap = 1;\n    let fromIdx = index;\n\n    while (xVals[fromIdx - 1] === xVals[index]) {\n      fromIdx--;\n    }\n\n    let toIdx = fromIdx + yBucketCount;\n\n    let maxCount = 0;\n\n    let i = fromIdx;\n    while (i < toIdx) {\n      let c = countVals[i];\n      maxCount = Math.max(maxCount, c);\n      i++;\n    }\n\n    let pHov = new Path2D();\n    let pRest = new Path2D();\n\n    i = fromIdx;\n    let j = 0;\n    while (i < toIdx) {\n      let c = countVals[i];\n\n      if (c > 0) {\n        let pctY = c / maxCount;\n        let pctX = j / yBucketCount;\n\n        let p = i === index ? pHov : pRest;\n\n        const xCoord = histCanWidth * pctX + barsGap;\n        const width = histCanWidth / yBucketCount - barsGap;\n\n        p.rect(xCoord, Math.round(histCanHeight * (1 - pctY)), width, Math.round(histCanHeight * pctY));\n      }\n\n      i++;\n      j++;\n    }\n\n    histCtx.clearRect(0, 0, histCanWidth, histCanHeight);\n\n    histCtx.fillStyle = '#2E3036';\n    histCtx.fill(pRest);\n\n    histCtx.fillStyle = '#5794F2';\n    histCtx.fill(pHov);\n  }\n}\n","import { DataFrame, Field } from '@grafana/data';\n\nimport { HeatmapData } from '../fields';\n\ntype BucketsMinMax = {\n  xBucketMin: number;\n  xBucketMax: number;\n  yBucketMin: string;\n  yBucketMax: string;\n};\n\nexport const getHoverCellColor = (data: HeatmapData, index: number) => {\n  const colorPalette = data.heatmapColors?.palette!;\n  const colorIndex = data.heatmapColors?.values[index];\n\n  let cellColor: string | undefined = undefined;\n\n  if (colorIndex != null) {\n    cellColor = colorPalette[colorIndex];\n  }\n\n  return { cellColor, colorPalette };\n};\n\nconst conversions: Record<string, number> = {\n  year: 1000 * 60 * 60 * 24 * 365,\n  month: 1000 * 60 * 60 * 24 * 30,\n  week: 1000 * 60 * 60 * 24 * 7,\n  day: 1000 * 60 * 60 * 24,\n  h: 1000 * 60 * 60,\n  m: 1000 * 60,\n  s: 1000,\n  ms: 1,\n};\n\nconst noPluralize = new Set(['ms', 's', 'm', 'h']);\n\n// @TODO: display \"~ 1 year/month\"?\nexport const formatMilliseconds = (milliseconds: number) => {\n  let value = 1;\n  let unit = 'ms';\n\n  for (unit in conversions) {\n    if (milliseconds >= conversions[unit]) {\n      value = Math.floor(milliseconds / conversions[unit]);\n      break;\n    }\n  }\n\n  const plural = value !== 1 && !noPluralize.has(unit);\n  const unitString = plural ? unit + 's' : unit;\n\n  return `${value} ${unitString}`;\n};\n\nexport const getFieldFromData = (data: DataFrame, fieldType: string, isSparse: boolean) => {\n  let field: Field | undefined;\n\n  switch (fieldType) {\n    case 'x':\n      field = isSparse\n        ? data?.fields.find(({ name }) => name === 'x' || name === 'xMin' || name === 'xMax')\n        : data?.fields[0];\n      break;\n    case 'y':\n      field = isSparse\n        ? data?.fields.find(({ name }) => name === 'y' || name === 'yMin' || name === 'yMax')\n        : data?.fields[1];\n      break;\n    case 'count':\n      field = isSparse ? data?.fields.find(({ name }) => name === 'count') : data?.fields[2];\n      break;\n  }\n\n  return field;\n};\n\nexport const getSparseCellMinMax = (data: HeatmapData, index: number): BucketsMinMax => {\n  let fields = data.heatmap!.fields;\n\n  let xMax = fields.find((f) => f.name === 'xMax')!;\n  let yMin = fields.find((f) => f.name === 'yMin')!;\n  let yMax = fields.find((f) => f.name === 'yMax')!;\n\n  let interval = xMax.config.interval!;\n\n  return {\n    xBucketMin: xMax.values[index] - interval,\n    xBucketMax: xMax.values[index],\n    yBucketMin: yMin.values[index],\n    yBucketMax: yMax.values[index],\n  };\n};\n","import { ReactElement, useEffect, useRef, useState, ReactNode } from 'react';\nimport * as React from 'react';\nimport uPlot from 'uplot';\n\nimport {\n  ActionModel,\n  DataFrameType,\n  Field,\n  FieldType,\n  formattedValueToString,\n  getFieldDisplayName,\n  InterpolateFunction,\n  LinkModel,\n  PanelData,\n} from '@grafana/data';\nimport { HeatmapCellLayout } from '@grafana/schema';\nimport { TooltipDisplayMode, useTheme2 } from '@grafana/ui';\nimport {\n  VizTooltipContent,\n  VizTooltipFooter,\n  VizTooltipHeader,\n  VizTooltipWrapper,\n  VizTooltipItem,\n  ColorIndicator,\n  ColorPlacement,\n} from '@grafana/ui/internal';\nimport { ColorScale } from 'app/core/components/ColorScale/ColorScale';\nimport { getDashboardSrv } from 'app/features/dashboard/services/DashboardSrv';\nimport { isHeatmapCellsDense, readHeatmapRowsCustomMeta } from 'app/features/transformers/calculateHeatmap/heatmap';\nimport { getDisplayValuesAndLinks } from 'app/features/visualization/data-hover/DataHoverView';\nimport { ExemplarTooltip } from 'app/features/visualization/data-hover/ExemplarTooltip';\n\nimport { getDataLinks, getFieldActions } from '../status-history/utils';\nimport { isTooltipScrollable } from '../timeseries/utils';\n\nimport { HeatmapData } from './fields';\nimport { renderHistogram } from './renderHistogram';\nimport { formatMilliseconds, getFieldFromData, getHoverCellColor, getSparseCellMinMax } from './tooltip/utils';\n\ninterface HeatmapTooltipProps {\n  mode: TooltipDisplayMode;\n  dataIdxs: Array<number | null>;\n  seriesIdx: number | null | undefined;\n  dataRef: React.MutableRefObject<HeatmapData>;\n  showHistogram?: boolean;\n  showColorScale?: boolean;\n  isPinned: boolean;\n  dismiss: () => void;\n  panelData: PanelData;\n  annotate?: () => void;\n  maxHeight?: number;\n  maxWidth?: number;\n  replaceVariables: InterpolateFunction;\n  canExecuteActions?: boolean;\n}\n\nexport const HeatmapTooltip = (props: HeatmapTooltipProps) => {\n  if (props.seriesIdx === 2) {\n    const dispValuesAndLinks = getDisplayValuesAndLinks(props.dataRef.current!.exemplars!, props.dataIdxs[2]!);\n\n    if (dispValuesAndLinks == null) {\n      return null;\n    }\n\n    const { displayValues, links } = dispValuesAndLinks;\n\n    return (\n      <ExemplarTooltip\n        items={displayValues.map((dispVal) => ({\n          label: dispVal.name,\n          value: dispVal.valueString,\n        }))}\n        links={links}\n        maxHeight={props.maxHeight}\n        isPinned={props.isPinned}\n      />\n    );\n  }\n\n  return <HeatmapHoverCell {...props} />;\n};\n\nconst defaultHistogramWidth = 264;\nconst defaultHistogramHeight = 64;\n\nconst HeatmapHoverCell = ({\n  dataIdxs,\n  dataRef,\n  showHistogram,\n  isPinned,\n  showColorScale = false,\n  mode,\n  annotate,\n  maxHeight,\n  maxWidth,\n  replaceVariables,\n  canExecuteActions,\n}: HeatmapTooltipProps) => {\n  const index = dataIdxs[1]!;\n  const data = dataRef.current;\n\n  const [isSparse] = useState(\n    () => data.heatmap?.meta?.type === DataFrameType.HeatmapCells && !isHeatmapCellsDense(data.heatmap)\n  );\n\n  const xField = getFieldFromData(data.heatmap!, 'x', isSparse)!;\n  const yField = getFieldFromData(data.heatmap!, 'y', isSparse)!;\n  const countField = getFieldFromData(data.heatmap!, 'count', isSparse)!;\n\n  const xDisp = (v: number) => {\n    if (xField?.display) {\n      return formattedValueToString(xField.display(v));\n    }\n    if (xField?.type === FieldType.time) {\n      const tooltipTimeFormat = 'YYYY-MM-DD HH:mm:ss';\n      const dashboard = getDashboardSrv().getCurrent();\n      return dashboard?.formatDate(v, tooltipTimeFormat);\n    }\n    return `${v}`;\n  };\n\n  const xVals = xField.values;\n  const yVals = yField.values;\n  const countVals = countField.values;\n\n  // labeled buckets\n  const meta = readHeatmapRowsCustomMeta(data.heatmap);\n  const yDisp = yField?.display ? (v: string) => formattedValueToString(yField.display!(v)) : (v: string) => `${v}`;\n\n  let interval = xField?.config.interval;\n\n  let yBucketMin: string;\n  let yBucketMax: string;\n\n  let xBucketMin: number;\n  let xBucketMax: number;\n\n  let nonNumericOrdinalDisplay: string | undefined = undefined;\n\n  let contentItems: VizTooltipItem[] = [];\n\n  const getYValueIndex = (idx: number) => {\n    return idx % (data.yBucketCount ?? 1);\n  };\n\n  let yValueIdx = getYValueIndex(index);\n  const xValueIdx = Math.floor(index / (data.yBucketCount ?? 1));\n\n  const getData = (idx: number = index) => {\n    if (meta.yOrdinalDisplay) {\n      const yMinIdx = data.yLayout === HeatmapCellLayout.le ? yValueIdx - 1 : yValueIdx;\n      const yMaxIdx = data.yLayout === HeatmapCellLayout.le ? yValueIdx : yValueIdx + 1;\n      yBucketMin = yMinIdx < 0 ? meta.yMinDisplay! : `${meta.yOrdinalDisplay[yMinIdx]}`;\n      yBucketMax = `${meta.yOrdinalDisplay[yMaxIdx]}`;\n\n      // e.g. \"pod-xyz123\"\n      if (!meta.yOrdinalLabel || Number.isNaN(+meta.yOrdinalLabel[0])) {\n        nonNumericOrdinalDisplay = data.yLayout === HeatmapCellLayout.le ? yBucketMax : yBucketMin;\n      }\n    } else {\n      const value = yVals?.[yValueIdx];\n\n      if (data.yLayout === HeatmapCellLayout.le) {\n        yBucketMax = `${value}`;\n\n        if (data.yLog) {\n          let logFn = data.yLog === 2 ? Math.log2 : Math.log10;\n          let exp = logFn(value) - 1 / data.yLogSplit!;\n          yBucketMin = `${data.yLog ** exp}`;\n        } else {\n          yBucketMin = `${value - data.yBucketSize!}`;\n        }\n      } else {\n        yBucketMin = `${value}`;\n\n        if (data.yLog) {\n          let logFn = data.yLog === 2 ? Math.log2 : Math.log10;\n          let exp = logFn(value) + 1 / data.yLogSplit!;\n          yBucketMax = `${data.yLog ** exp}`;\n        } else {\n          yBucketMax = `${value + data.yBucketSize!}`;\n        }\n      }\n    }\n\n    if (data.xLayout === HeatmapCellLayout.le) {\n      xBucketMax = xVals[idx];\n      xBucketMin = xBucketMax - data.xBucketSize!;\n    } else {\n      xBucketMin = xVals[idx];\n      xBucketMax = xBucketMin + data.xBucketSize!;\n    }\n  };\n\n  if (isSparse) {\n    ({ xBucketMin, xBucketMax, yBucketMin, yBucketMax } = getSparseCellMinMax(data!, index));\n  } else {\n    getData();\n  }\n\n  const { cellColor, colorPalette } = getHoverCellColor(data, index);\n\n  const getDisplayData = (fromIdx: number, toIdx: number) => {\n    let vals = [];\n    for (let idx = fromIdx; idx <= toIdx; idx++) {\n      if (!countVals?.[idx]) {\n        continue;\n      }\n\n      const color = getHoverCellColor(data, idx).cellColor;\n      count = getCountValue(idx);\n\n      if (isSparse) {\n        ({ xBucketMin, xBucketMax, yBucketMin, yBucketMax } = getSparseCellMinMax(data!, idx));\n      } else {\n        yValueIdx = getYValueIndex(idx);\n        getData(idx);\n      }\n\n      const { label, value } = getContentLabels()[0];\n\n      vals.push({\n        label,\n        value,\n        color: color ?? '#FFF',\n        isActive: index === idx,\n      });\n    }\n\n    return vals;\n  };\n\n  const getContentLabels = (): VizTooltipItem[] => {\n    const isMulti = mode === TooltipDisplayMode.Multi && !isPinned;\n\n    if (nonNumericOrdinalDisplay) {\n      return isMulti\n        ? [{ label: `Name ${nonNumericOrdinalDisplay}`, value: data.display!(count) }]\n        : [{ label: 'Name', value: nonNumericOrdinalDisplay }];\n    }\n\n    switch (data.yLayout) {\n      case HeatmapCellLayout.unknown:\n        return isMulti\n          ? [{ label: yDisp(yBucketMin), value: data.display!(count) }]\n          : [{ label: '', value: yDisp(yBucketMin) }];\n    }\n\n    return isMulti\n      ? [\n          {\n            label: `Bucket ${yDisp(yBucketMin)}` + '-' + `${yDisp(yBucketMax)}`,\n            value: data.display!(count),\n          },\n        ]\n      : [\n          {\n            label: 'Bucket',\n            value: `${yDisp(yBucketMin)}` + '-' + `${yDisp(yBucketMax)}`,\n          },\n        ];\n  };\n\n  const getCountValue = (idx: number) => {\n    return countVals?.[idx];\n  };\n\n  let count = getCountValue(index);\n\n  if (mode === TooltipDisplayMode.Single || isPinned) {\n    const fromToInt: VizTooltipItem[] = interval ? [{ label: 'Duration', value: formatMilliseconds(interval) }] : [];\n\n    contentItems = [\n      {\n        label: getFieldDisplayName(countField, data.heatmap),\n        value: data.display!(count),\n        color: cellColor ?? '#FFF',\n        colorPlacement: ColorPlacement.trailing,\n        colorIndicator: ColorIndicator.value,\n      },\n      ...getContentLabels(),\n      ...fromToInt,\n    ];\n  }\n\n  if (mode === TooltipDisplayMode.Multi && !isPinned) {\n    let xVal = xField.values[index];\n    let fromIdx = index;\n    let toIdx = index;\n\n    while (xField.values[fromIdx - 1] === xVal) {\n      fromIdx--;\n    }\n\n    while (xField.values[toIdx + 1] === xVal) {\n      toIdx++;\n    }\n\n    const vals: VizTooltipItem[] = getDisplayData(fromIdx, toIdx);\n    vals.forEach((val) => {\n      contentItems.push({\n        label: val.label,\n        value: val.value,\n        color: val.color ?? '#FFF',\n        colorIndicator: ColorIndicator.value,\n        colorPlacement: ColorPlacement.trailing,\n        isActive: val.isActive,\n      });\n    });\n  }\n\n  let footer: ReactNode;\n\n  if (isPinned) {\n    let links: Array<LinkModel<Field>> = [];\n    let actions: Array<ActionModel<Field>> = [];\n\n    const linksField = data.series?.fields[yValueIdx + 1];\n\n    if (linksField != null) {\n      const visible = !Boolean(linksField.config.custom?.hideFrom?.tooltip);\n      const hasLinks = (linksField.config.links?.length ?? 0) > 0;\n\n      if (visible && hasLinks) {\n        links = getDataLinks(linksField, xValueIdx);\n      }\n\n      actions = canExecuteActions ? getFieldActions(data.series!, linksField, replaceVariables, xValueIdx) : [];\n    }\n\n    footer = <VizTooltipFooter dataLinks={links} annotate={annotate} actions={actions} />;\n  }\n\n  let can = useRef<HTMLCanvasElement>(null);\n\n  const theme = useTheme2();\n  const themeSpacing = parseInt(theme.spacing(1), 10);\n\n  let histCssWidth = Math.min(defaultHistogramWidth, maxWidth ? maxWidth - themeSpacing * 2 : defaultHistogramWidth);\n  let histCssHeight = defaultHistogramHeight;\n  let histCanWidth = Math.round(histCssWidth * uPlot.pxRatio);\n  let histCanHeight = Math.round(histCssHeight * uPlot.pxRatio);\n\n  useEffect(\n    () => {\n      if (showHistogram && xVals != null && countVals != null && mode === TooltipDisplayMode.Single) {\n        renderHistogram(can, histCanWidth, histCanHeight, xVals, countVals, index, data.yBucketCount!);\n      }\n    },\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n    [index]\n  );\n\n  const headerItem: VizTooltipItem = {\n    label: '',\n    value: xDisp(xBucketMax!)!,\n  };\n\n  let customContent: ReactElement[] = [];\n\n  if (mode === TooltipDisplayMode.Single) {\n    // Histogram\n    if (showHistogram && !isSparse) {\n      customContent.push(\n        <canvas\n          width={histCanWidth}\n          height={histCanHeight}\n          ref={can}\n          style={{ width: histCssWidth + 'px', height: histCssHeight + 'px' }}\n        />\n      );\n    }\n\n    // Color scale\n    if (colorPalette && showColorScale) {\n      customContent.push(\n        <ColorScale\n          colorPalette={colorPalette}\n          min={data.heatmapColors?.minValue!}\n          max={data.heatmapColors?.maxValue!}\n          display={data.display}\n          hoverValue={count}\n        />\n      );\n    }\n  }\n\n  return (\n    <VizTooltipWrapper>\n      <VizTooltipHeader item={headerItem} isPinned={isPinned} />\n      <VizTooltipContent\n        items={contentItems}\n        isPinned={isPinned}\n        scrollable={isTooltipScrollable({ mode, maxHeight })}\n        maxHeight={maxHeight}\n      >\n        {customContent?.map((content, i) => (\n          <div key={i} style={{ padding: `${theme.spacing(1)} 0` }}>\n            {content}\n          </div>\n        ))}\n      </VizTooltipContent>\n      {footer}\n    </VizTooltipWrapper>\n  );\n};\n","import {\n  cacheFieldDisplayNames,\n  DataFrame,\n  DataFrameType,\n  Field,\n  FieldType,\n  formattedValueToString,\n  getDisplayProcessor,\n  getLinksSupplier,\n  GrafanaTheme2,\n  InterpolateFunction,\n  outerJoinDataFrames,\n  TimeRange,\n  ValueFormatter,\n} from '@grafana/data';\nimport { parseSampleValue, sortSeriesByLabel } from '@grafana/prometheus';\nimport {\n  HeatmapCalculationMode,\n  HeatmapCalculationOptions,\n  HeatmapCellLayout,\n  ScaleDistribution,\n} from '@grafana/schema';\nimport {\n  calculateHeatmapFromData,\n  isHeatmapCellsDense,\n  readHeatmapRowsCustomMeta,\n  rowsToCellsHeatmap,\n} from 'app/features/transformers/calculateHeatmap/heatmap';\n\nimport { CellValues, Options } from './types';\nimport { boundedMinMax, valuesToFills } from './utils';\n\nexport interface HeatmapData {\n  heatmap?: DataFrame; // data we will render\n  heatmapColors?: {\n    // quantized palette\n    palette: string[];\n    // indices into palette\n    values: number[];\n\n    // color scale range\n    minValue: number;\n    maxValue: number;\n  };\n\n  series?: DataFrame; // the joined single frame for nonNumericOrdinalY data links\n\n  exemplars?: DataFrame; // optionally linked exemplars\n  exemplarColor?: string;\n\n  xBucketSize?: number;\n  yBucketSize?: number;\n\n  xBucketCount?: number;\n  yBucketCount?: number;\n\n  xLayout?: HeatmapCellLayout;\n  yLayout?: HeatmapCellLayout;\n\n  xLog?: number;\n  yLog?: number;\n\n  xLogSplit?: number;\n  yLogSplit?: number;\n\n  // Print a heatmap cell value\n  display?: (v: number) => string;\n\n  // Errors\n  warning?: string;\n}\n\ninterface PrepareHeatmapDataOptions {\n  frames: DataFrame[];\n  annotations?: DataFrame[];\n  options: Options;\n  palette: string[];\n  theme: GrafanaTheme2;\n  replaceVariables?: InterpolateFunction;\n  timeRange?: TimeRange;\n}\n\nexport function prepareHeatmapData({\n  frames,\n  annotations,\n  options,\n  palette,\n  theme,\n  replaceVariables = (v) => v,\n  timeRange,\n}: PrepareHeatmapDataOptions): HeatmapData {\n  if (!frames?.length) {\n    return {};\n  }\n\n  cacheFieldDisplayNames(frames);\n\n  const exemplars = annotations?.find((f) => f.name === 'exemplar');\n\n  exemplars?.fields.forEach((field) => {\n    field.getLinks = getLinksSupplier(exemplars, field, field.state?.scopedVars ?? {}, replaceVariables);\n  });\n\n  if (options.calculate) {\n    // if calculate is true, we need to have the default values for the calculation if they don't exist\n    let calculation = getCalculationObjectWithDefaults(options.calculation);\n\n    calculation.xBuckets.value = replaceVariables(calculation.xBuckets.value ?? '');\n    calculation.yBuckets.value = replaceVariables(calculation.yBuckets.value ?? '');\n\n    return getDenseHeatmapData(\n      calculateHeatmapFromData(frames, { ...calculation, timeRange }),\n      exemplars,\n      { ...options, calculation },\n      palette,\n      theme\n    );\n  }\n\n  // Check for known heatmap types\n  let rowsHeatmap: DataFrame | undefined = undefined;\n  for (const frame of frames) {\n    switch (frame.meta?.type) {\n      case DataFrameType.HeatmapCells:\n        return isHeatmapCellsDense(frame)\n          ? getDenseHeatmapData(frame, exemplars, options, palette, theme)\n          : getSparseHeatmapData(frame, exemplars, options, palette, theme);\n\n      case DataFrameType.HeatmapRows:\n        rowsHeatmap = frame; // the default format\n    }\n  }\n\n  // Everything past here assumes a field for each row in the heatmap (buckets)\n  if (rowsHeatmap == null) {\n    if (frames.length > 1) {\n      let allNamesNumeric = frames.every(\n        (frame) => !Number.isNaN(parseSampleValue(frame.fields[1].state?.displayName!))\n      );\n\n      if (allNamesNumeric) {\n        frames.sort(sortSeriesByLabel);\n      }\n\n      rowsHeatmap = outerJoinDataFrames({\n        frames,\n        keepDisplayNames: true,\n      })!;\n    } else {\n      let frame = frames[0];\n      let numberFields = frame.fields.filter((field) => field.type === FieldType.number);\n      let allNamesNumeric = numberFields.every((field) => !Number.isNaN(parseSampleValue(field.state?.displayName!)));\n\n      if (allNamesNumeric) {\n        numberFields.sort((a, b) => parseSampleValue(a.state?.displayName!) - parseSampleValue(b.state?.displayName!));\n\n        rowsHeatmap = {\n          ...frame,\n          fields: [frame.fields.find((f) => f.type === FieldType.time)!, ...numberFields],\n        };\n      } else {\n        rowsHeatmap = frame;\n      }\n    }\n  }\n\n  // config data links\n  rowsHeatmap.fields.forEach((field) => {\n    if ((field.config.links?.length ?? 0) === 0) {\n      return;\n    }\n\n    // this expects that the tooltip is able to identify the field and rowIndex from a dense hovered index\n    field.getLinks = getLinksSupplier(rowsHeatmap!, field, field.state?.scopedVars ?? {}, replaceVariables);\n  });\n\n  return {\n    ...getDenseHeatmapData(\n      rowsToCellsHeatmap({\n        unit: options.yAxis?.unit, // used to format the ordinal lookup values\n        decimals: options.yAxis?.decimals,\n        ...options.rowsFrame,\n        frame: rowsHeatmap,\n      }),\n      exemplars,\n      options,\n      palette,\n      theme\n    ),\n    series: rowsHeatmap,\n  };\n}\n\nconst getCalculationObjectWithDefaults = (calculation?: HeatmapCalculationOptions) => {\n  return {\n    xBuckets: {\n      ...calculation?.xBuckets,\n      mode: calculation?.xBuckets?.mode ?? HeatmapCalculationMode.Size,\n    },\n    yBuckets: {\n      ...calculation?.yBuckets,\n      mode: calculation?.yBuckets?.mode ?? HeatmapCalculationMode.Size,\n      scale: {\n        ...calculation?.yBuckets?.scale,\n        type: calculation?.yBuckets?.scale?.type ?? ScaleDistribution.Linear,\n      },\n    },\n  };\n};\n\nconst getSparseHeatmapData = (\n  frame: DataFrame,\n  exemplars: DataFrame | undefined,\n  options: Options,\n  palette: string[],\n  theme: GrafanaTheme2\n): HeatmapData => {\n  if (frame.meta?.type !== DataFrameType.HeatmapCells || isHeatmapCellsDense(frame)) {\n    return {\n      warning: 'Expected sparse heatmap format',\n      heatmap: frame,\n    };\n  }\n\n  // y axis tick label display\n  updateFieldDisplay(frame.fields[1], options.yAxis, theme);\n\n  const valueField = frame.fields[3];\n\n  // cell value display\n  const disp = updateFieldDisplay(valueField, options.cellValues, theme);\n\n  let [minValue, maxValue] = boundedMinMax(\n    valueField.values,\n    options.color.min,\n    options.color.max,\n    options.filterValues?.le,\n    options.filterValues?.ge\n  );\n\n  return {\n    heatmap: frame,\n    heatmapColors: {\n      palette,\n      values: valuesToFills(valueField.values, palette, minValue, maxValue),\n      minValue,\n      maxValue,\n    },\n    exemplars,\n    display: (v) => formattedValueToString(disp(v)),\n  };\n};\n\nconst getDenseHeatmapData = (\n  frame: DataFrame,\n  exemplars: DataFrame | undefined,\n  options: Options,\n  palette: string[],\n  theme: GrafanaTheme2\n): HeatmapData => {\n  if (frame.meta?.type !== DataFrameType.HeatmapCells) {\n    return {\n      warning: 'Expected heatmap scanlines format',\n      heatmap: frame,\n    };\n  }\n\n  if (frame.fields.length < 2 || frame.length < 2) {\n    return { heatmap: frame };\n  }\n\n  const meta = readHeatmapRowsCustomMeta(frame);\n  let xName: string | undefined = undefined;\n  let yName: string | undefined = undefined;\n  let valueField: Field | undefined = undefined;\n\n  // validate field display properties\n  for (const field of frame.fields) {\n    switch (field.name) {\n      case 'y':\n        yName = field.name;\n\n      case 'yMin':\n      case 'yMax': {\n        if (!yName) {\n          yName = field.name;\n        }\n        if (meta.yOrdinalDisplay == null) {\n          updateFieldDisplay(field, options.yAxis, theme);\n        }\n        break;\n      }\n\n      case 'x':\n      case 'xMin':\n      case 'xMax':\n        xName = field.name;\n        break;\n\n      default: {\n        if (field.type === FieldType.number && !valueField) {\n          valueField = field;\n        }\n      }\n    }\n  }\n\n  if (!yName) {\n    return { warning: 'Missing Y field', heatmap: frame };\n  }\n  if (!yName) {\n    return { warning: 'Missing X field', heatmap: frame };\n  }\n  if (!valueField) {\n    return { warning: 'Missing value field', heatmap: frame };\n  }\n\n  const disp = updateFieldDisplay(valueField, options.cellValues, theme);\n\n  // infer bucket sizes from data (for now)\n  // the 'heatmap-scanlines' dense frame format looks like:\n  // x:      1,1,1,1,2,2,2,2\n  // y:      3,4,5,6,3,4,5,6\n  // count:  0,0,0,7,0,3,0,1\n\n  const xs = frame.fields[0].values;\n  const ys = frame.fields[1].values;\n  const dlen = xs.length;\n\n  // below is literally copy/paste from the pathBuilder code in utils.ts\n  // detect x and y bin qtys by detecting layout repetition in x & y data\n  let yBinQty = dlen - ys.lastIndexOf(ys[0]);\n  let xBinQty = dlen / yBinQty;\n  let yBinIncr = ys[1] - ys[0];\n  let xBinIncr = xs[yBinQty] - xs[0];\n\n  let [minValue, maxValue] = boundedMinMax(\n    valueField.values,\n    options.color.min,\n    options.color.max,\n    options.filterValues?.le,\n    options.filterValues?.ge\n  );\n\n  let calcX = options.calculation?.xBuckets;\n  let calcY = options.calculation?.yBuckets;\n\n  const data: HeatmapData = {\n    heatmap: frame,\n    heatmapColors: {\n      palette,\n      values: valuesToFills(valueField.values, palette, minValue, maxValue),\n      minValue,\n      maxValue,\n    },\n\n    exemplars: exemplars?.length ? exemplars : undefined,\n    xBucketSize: xBinIncr,\n    yBucketSize: yBinIncr,\n    xBucketCount: xBinQty,\n    yBucketCount: yBinQty,\n\n    yLog: calcY?.scale?.log ?? 0,\n    xLog: calcX?.scale?.log ?? 0,\n\n    xLogSplit: calcX?.scale?.log ? +(calcX?.value ?? '1') : 1,\n    yLogSplit: calcY?.scale?.log ? +(calcY?.value ?? '1') : 1,\n\n    // TODO: improve heuristic\n    xLayout:\n      xName === 'xMax' ? HeatmapCellLayout.le : xName === 'xMin' ? HeatmapCellLayout.ge : HeatmapCellLayout.unknown,\n    yLayout:\n      yName === 'yMax' ? HeatmapCellLayout.le : yName === 'yMin' ? HeatmapCellLayout.ge : HeatmapCellLayout.unknown,\n\n    display: (v) => formattedValueToString(disp(v)),\n  };\n\n  return data;\n};\n\nfunction updateFieldDisplay(field: Field, opts: CellValues | undefined, theme: GrafanaTheme2): ValueFormatter {\n  if (opts?.unit?.length || opts?.decimals != null) {\n    const { unit, decimals } = opts;\n    field.display = undefined;\n    field.config = { ...field.config };\n    if (unit?.length) {\n      field.config.unit = unit;\n    }\n    if (decimals != null) {\n      field.config.decimals = decimals;\n    }\n  }\n  if (!field.display) {\n    field.display = getDisplayProcessor({ field, theme });\n  }\n  return field.display;\n}\n","import * as d3 from 'd3';\nimport * as d3ScaleChromatic from 'd3-scale-chromatic';\nimport tinycolor from 'tinycolor2';\n\nimport { GrafanaTheme2 } from '@grafana/data';\n\nimport { HeatmapColorOptions, defaultOptions, HeatmapColorMode, HeatmapColorScale } from './types';\n\n// https://observablehq.com/@d3/color-schemes?collection=@d3/d3-scale-chromatic\n\n// the previous heatmap panel used d3 deps and some code to interpolate to static 9-color palettes. here we just hard-code them for clarity.\n// if the need arises for configurable-sized palettes, we can bring back the deps & variable interpolation (see simplified code at end)\n\n// Schemes from d3-scale-chromatic\n// https://github.com/d3/d3-scale-chromatic\nexport const colorSchemes = [\n  // Diverging\n  { name: 'BrBG', invert: 'always' },\n  { name: 'PiYG', invert: 'always' },\n  { name: 'PRGn', invert: 'always' },\n  { name: 'PuOr', invert: 'always' },\n  { name: 'RdBu', invert: 'always' },\n  { name: 'RdGy', invert: 'always' },\n  { name: 'RdYlBu', invert: 'always' },\n  { name: 'RdYlGn', invert: 'always' },\n  { name: 'Spectral', invert: 'always' },\n\n  // Sequential (Single Hue)\n  { name: 'Blues', invert: 'dark' },\n  { name: 'Greens', invert: 'dark' },\n  { name: 'Greys', invert: 'dark' },\n  { name: 'Oranges', invert: 'dark' },\n  { name: 'Purples', invert: 'dark' },\n  { name: 'Reds', invert: 'dark' },\n\n  // Sequential (Multi-Hue)\n  { name: 'Turbo', invert: 'light' },\n  { name: 'Cividis', invert: 'light' },\n  { name: 'Viridis', invert: 'light' },\n  { name: 'Magma', invert: 'light' },\n  { name: 'Inferno', invert: 'light' },\n  { name: 'Plasma', invert: 'light' },\n  { name: 'Warm', invert: 'light' },\n  { name: 'Cool', invert: 'light' },\n  { name: 'Cubehelix', invert: 'light', name2: 'CubehelixDefault' },\n  { name: 'BuGn', invert: 'dark' },\n  { name: 'BuPu', invert: 'dark' },\n  { name: 'GnBu', invert: 'dark' },\n  { name: 'OrRd', invert: 'dark' },\n  { name: 'PuBuGn', invert: 'dark' },\n  { name: 'PuBu', invert: 'dark' },\n  { name: 'PuRd', invert: 'dark' },\n  { name: 'RdPu', invert: 'dark' },\n  { name: 'YlGnBu', invert: 'dark' },\n  { name: 'YlGn', invert: 'dark' },\n  { name: 'YlOrBr', invert: 'dark' },\n  { name: 'YlOrRd', invert: 'dark' },\n\n  // Cyclical\n  { name: 'Rainbow', invert: 'always' },\n  { name: 'Sinebow', invert: 'always' },\n];\n\ntype Interpolator = (t: number) => string;\n\nconst DEFAULT_SCHEME = colorSchemes.find((scheme) => scheme.name === 'Spectral');\n\nexport function quantizeScheme(opts: HeatmapColorOptions, theme: GrafanaTheme2): string[] {\n  const options = { ...defaultOptions.color, ...opts };\n  const palette = [];\n  const steps = (options.steps ?? 128) - 1;\n\n  if (opts.mode === HeatmapColorMode.Opacity) {\n    const fill = tinycolor(theme.visualization.getColorByName(opts.fill)).toPercentageRgb();\n\n    const scale =\n      options.scale === HeatmapColorScale.Exponential\n        ? d3.scalePow().exponent(options.exponent).domain([0, 1]).range([0, 1])\n        : d3.scaleLinear().domain([0, 1]).range([0, 1]);\n\n    for (let i = 0; i <= steps; i++) {\n      fill.a = scale(i / steps);\n      palette.push(tinycolor(fill).toString('hex8'));\n    }\n  } else {\n    const scheme = colorSchemes.find((scheme) => scheme.name === options.scheme) ?? DEFAULT_SCHEME!;\n    let fnName = 'interpolate' + (scheme.name2 ?? scheme.name);\n    const interpolate: Interpolator = (d3ScaleChromatic as any)[fnName];\n\n    for (let i = 0; i <= steps; i++) {\n      let rgbStr = interpolate(i / steps);\n      let rgb =\n        rgbStr.indexOf('rgb') === 0\n          ? '#' + [...rgbStr.matchAll(/\\d+/g)].map((v) => (+v[0]).toString(16).padStart(2, '0')).join('')\n          : rgbStr;\n      palette.push(rgb);\n    }\n\n    if (\n      scheme.invert === 'always' ||\n      (scheme.invert === 'dark' && theme.isDark) ||\n      (scheme.invert === 'light' && theme.isLight)\n    ) {\n      palette.reverse();\n    }\n\n    if (opts.reverse) {\n      palette.reverse();\n    }\n  }\n\n  return palette;\n}\n","import { css } from '@emotion/css';\nimport { useMemo, useRef, useState } from 'react';\n\nimport { DashboardCursorSync, PanelProps, TimeRange } from '@grafana/data';\nimport { PanelDataErrorView } from '@grafana/runtime';\nimport { ScaleDistributionConfig } from '@grafana/schema';\nimport {\n  ScaleDistribution,\n  TooltipPlugin2,\n  TooltipDisplayMode,\n  UPlotChart,\n  usePanelContext,\n  useStyles2,\n  useTheme2,\n  VizLayout,\n  EventBusPlugin,\n} from '@grafana/ui';\nimport { TimeRange2, TooltipHoverMode } from '@grafana/ui/internal';\nimport { ColorScale } from 'app/core/components/ColorScale/ColorScale';\nimport { readHeatmapRowsCustomMeta } from 'app/features/transformers/calculateHeatmap/heatmap';\n\nimport { AnnotationsPlugin2 } from '../timeseries/plugins/AnnotationsPlugin2';\nimport { OutsideRangePlugin } from '../timeseries/plugins/OutsideRangePlugin';\n\nimport { HeatmapTooltip } from './HeatmapTooltip';\nimport { prepareHeatmapData } from './fields';\nimport { quantizeScheme } from './palettes';\nimport { Options } from './types';\nimport { prepConfig } from './utils';\n\ninterface HeatmapPanelProps extends PanelProps<Options> {}\n\nexport const HeatmapPanel = ({\n  data,\n  id,\n  timeRange,\n  timeZone,\n  width,\n  height,\n  options,\n  fieldConfig,\n  eventBus,\n  onChangeTimeRange,\n  replaceVariables,\n}: HeatmapPanelProps) => {\n  const theme = useTheme2();\n  const styles = useStyles2(getStyles);\n  const { sync, eventsScope, canAddAnnotations, onSelectRange, canExecuteActions } = usePanelContext();\n  const cursorSync = sync?.() ?? DashboardCursorSync.Off;\n\n  const userCanExecuteActions = useMemo(() => canExecuteActions?.() ?? false, [canExecuteActions]);\n\n  // temp range set for adding new annotation set by TooltipPlugin2, consumed by AnnotationPlugin2\n  const [newAnnotationRange, setNewAnnotationRange] = useState<TimeRange2 | null>(null);\n\n  // ugh\n  let timeRangeRef = useRef<TimeRange>(timeRange);\n  timeRangeRef.current = timeRange;\n\n  const palette = useMemo(() => quantizeScheme(options.color, theme), [options.color, theme]);\n\n  const info = useMemo(() => {\n    try {\n      return prepareHeatmapData({\n        frames: data.series,\n        annotations: data.annotations,\n        options,\n        palette,\n        theme,\n        replaceVariables,\n        timeRange,\n      });\n    } catch (ex) {\n      return { warning: `${ex}` };\n    }\n  }, [data.series, data.annotations, options, palette, theme, replaceVariables, timeRange]);\n\n  const facets = useMemo(() => {\n    let exemplarsXFacet: number[] | undefined = []; // \"Time\" field\n    let exemplarsYFacet: Array<number | undefined> = [];\n\n    const meta = readHeatmapRowsCustomMeta(info.heatmap);\n\n    if (info.exemplars?.length) {\n      exemplarsXFacet = info.exemplars?.fields[0].values;\n\n      // render by match on ordinal y label\n      if (meta.yMatchWithLabel) {\n        // ordinal/labeled heatmap-buckets?\n        const hasLabeledY = meta.yOrdinalDisplay != null;\n\n        if (hasLabeledY) {\n          let matchExemplarsBy = info.exemplars?.fields.find((field) => field.name === meta.yMatchWithLabel)!.values;\n          exemplarsYFacet = matchExemplarsBy.map((label) => meta.yOrdinalLabel?.indexOf(label));\n        } else {\n          exemplarsYFacet = info.exemplars?.fields[1].values; // \"Value\" field\n        }\n      }\n      // render by raw value\n      else {\n        exemplarsYFacet = info.exemplars?.fields[1].values; // \"Value\" field\n      }\n    }\n\n    return [null, info.heatmap?.fields.map((f) => f.values), [exemplarsXFacet, exemplarsYFacet]];\n  }, [info.heatmap, info.exemplars]);\n\n  // ugh\n  const dataRef = useRef(info);\n  dataRef.current = info;\n\n  const builder = useMemo(() => {\n    const scaleConfig: ScaleDistributionConfig = dataRef.current?.heatmap?.fields[1].config?.custom?.scaleDistribution;\n\n    return prepConfig({\n      dataRef,\n      theme,\n      timeZone,\n      getTimeRange: () => timeRangeRef.current,\n      cellGap: options.cellGap,\n      hideLE: options.filterValues?.le,\n      hideGE: options.filterValues?.ge,\n      exemplarColor: options.exemplars?.color ?? 'rgba(255,0,255,0.7)',\n      yAxisConfig: options.yAxis,\n      ySizeDivisor: scaleConfig?.type === ScaleDistribution.Log ? +(options.calculation?.yBuckets?.value || 1) : 1,\n      selectionMode: options.selectionMode,\n    });\n\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [options, timeZone, data.structureRev, cursorSync]);\n\n  const renderLegend = () => {\n    if (!info.heatmap || !options.legend.show) {\n      return null;\n    }\n\n    let hoverValue: number | undefined = undefined;\n\n    // let heatmapType = dataRef.current?.heatmap?.meta?.type;\n    // let isSparseHeatmap = heatmapType === DataFrameType.HeatmapCells && !isHeatmapCellsDense(dataRef.current?.heatmap!);\n    // let countFieldIdx = !isSparseHeatmap ? 2 : 3;\n    // const countField = info.heatmap.fields[countFieldIdx];\n\n    // seriesIdx: 1 is heatmap layer; 2 is exemplar layer\n    // if (hover && info.heatmap.fields && hover.seriesIdx === 1) {\n    //   hoverValue = countField.values[hover.dataIdx];\n    // }\n\n    return (\n      <VizLayout.Legend placement=\"bottom\" maxHeight=\"20%\">\n        <div className={styles.colorScaleWrapper}>\n          <ColorScale\n            hoverValue={hoverValue}\n            colorPalette={palette}\n            min={dataRef.current.heatmapColors?.minValue!}\n            max={dataRef.current.heatmapColors?.maxValue!}\n            display={info.display}\n          />\n        </div>\n      </VizLayout.Legend>\n    );\n  };\n\n  if (info.warning || !info.heatmap) {\n    return (\n      <PanelDataErrorView\n        panelId={id}\n        fieldConfig={fieldConfig}\n        data={data}\n        needsNumberField={true}\n        message={info.warning}\n      />\n    );\n  }\n\n  const enableAnnotationCreation = Boolean(canAddAnnotations && canAddAnnotations());\n\n  return (\n    <>\n      <VizLayout width={width} height={height} legend={renderLegend()}>\n        {(vizWidth: number, vizHeight: number) => (\n          <UPlotChart key={builder.uid} config={builder} data={facets as any} width={vizWidth} height={vizHeight}>\n            {cursorSync !== DashboardCursorSync.Off && (\n              <EventBusPlugin config={builder} eventBus={eventBus} frame={info.series ?? info.heatmap} />\n            )}\n            {options.tooltip.mode !== TooltipDisplayMode.None && (\n              <TooltipPlugin2\n                config={builder}\n                hoverMode={\n                  options.tooltip.mode === TooltipDisplayMode.Single ? TooltipHoverMode.xOne : TooltipHoverMode.xAll\n                }\n                queryZoom={onChangeTimeRange}\n                onSelectRange={onSelectRange}\n                syncMode={cursorSync}\n                syncScope={eventsScope}\n                render={(u, dataIdxs, seriesIdx, isPinned, dismiss, timeRange2, viaSync) => {\n                  if (enableAnnotationCreation && timeRange2 != null) {\n                    setNewAnnotationRange(timeRange2);\n                    dismiss();\n                    return;\n                  }\n\n                  const annotate = () => {\n                    let xVal = u.posToVal(u.cursor.left!, 'x');\n\n                    setNewAnnotationRange({ from: xVal, to: xVal });\n                    dismiss();\n                  };\n\n                  return (\n                    <HeatmapTooltip\n                      mode={viaSync ? TooltipDisplayMode.Multi : options.tooltip.mode}\n                      dataIdxs={dataIdxs}\n                      seriesIdx={seriesIdx}\n                      dataRef={dataRef}\n                      isPinned={isPinned}\n                      dismiss={dismiss}\n                      showHistogram={options.tooltip.yHistogram}\n                      showColorScale={options.tooltip.showColorScale}\n                      panelData={data}\n                      annotate={enableAnnotationCreation ? annotate : undefined}\n                      maxHeight={options.tooltip.maxHeight}\n                      maxWidth={options.tooltip.maxWidth}\n                      replaceVariables={replaceVariables}\n                      canExecuteActions={userCanExecuteActions}\n                    />\n                  );\n                }}\n                maxWidth={options.tooltip.maxWidth}\n              />\n            )}\n            <AnnotationsPlugin2\n              annotations={data.annotations ?? []}\n              config={builder}\n              timeZone={timeZone}\n              newRange={newAnnotationRange}\n              setNewRange={setNewAnnotationRange}\n              canvasRegionRendering={false}\n            />\n            <OutsideRangePlugin config={builder} onChangeTimeRange={onChangeTimeRange} />\n          </UPlotChart>\n        )}\n      </VizLayout>\n    </>\n  );\n};\n\nconst getStyles = () => ({\n  colorScaleWrapper: css({\n    marginLeft: '25px',\n    padding: '10px 0',\n    maxWidth: '300px',\n  }),\n});\n","import { FieldConfigSource, PanelModel, PanelTypeChangedHandler } from '@grafana/data';\nimport {\n  AxisPlacement,\n  ScaleDistribution,\n  VisibilityMode,\n  HeatmapCellLayout,\n  HeatmapCalculationMode,\n  HeatmapCalculationOptions,\n} from '@grafana/schema';\nimport { TooltipDisplayMode } from '@grafana/ui';\n\nimport { colorSchemes } from './palettes';\nimport { Options, defaultOptions, HeatmapColorMode } from './types';\n\n/** Called when the version number changes */\nexport const heatmapMigrationHandler = (panel: PanelModel): Partial<Options> => {\n  // Migrating from angular\n  if (Object.keys(panel.options ?? {}).length === 0) {\n    return heatmapChangedHandler(panel, 'heatmap', { angular: panel }, panel.fieldConfig);\n  }\n\n  // multi tooltip mode in 10.3+\n  let showTooltip = panel.options?.tooltip?.show;\n  if (showTooltip !== undefined) {\n    if (showTooltip === true) {\n      panel.options.tooltip.mode = TooltipDisplayMode.Single;\n    } else if (showTooltip === false) {\n      panel.options.tooltip.mode = TooltipDisplayMode.None;\n    }\n\n    // Remove old tooltip option\n    delete panel.options.tooltip?.show;\n  }\n\n  return panel.options;\n};\n\n/**\n * This is called when the panel changes from another panel\n */\nexport const heatmapChangedHandler: PanelTypeChangedHandler = (panel, prevPluginId, prevOptions, prevFieldConfig) => {\n  if (prevPluginId === 'heatmap' && prevOptions.angular) {\n    const { fieldConfig, options } = angularToReactHeatmap({\n      ...prevOptions.angular,\n      fieldConfig: prevFieldConfig,\n    });\n    panel.fieldConfig = fieldConfig; // Mutates the incoming panel\n    return options;\n  }\n  // alpha for 8.5+, then beta at 9.0.1\n  if (prevPluginId === 'heatmap-new') {\n    const { bucketFrame, ...options } = panel.options;\n    if (bucketFrame) {\n      return { ...options, rowsFrame: bucketFrame };\n    }\n    return panel.options;\n  }\n  return {};\n};\n\nexport function angularToReactHeatmap(angular: any): { fieldConfig: FieldConfigSource; options: Options } {\n  const fieldConfig: FieldConfigSource = {\n    defaults: {},\n    overrides: [],\n  };\n\n  const calculate = angular.dataFormat === 'tsbuckets' ? false : true;\n  const calculation: HeatmapCalculationOptions = {\n    ...defaultOptions.calculation,\n  };\n\n  const oldYAxis = { logBase: 1, ...angular.yAxis };\n\n  if (calculate) {\n    if (angular.xBucketSize) {\n      calculation.xBuckets = { mode: HeatmapCalculationMode.Size, value: `${angular.xBucketSize}` };\n    } else if (angular.xBucketNumber) {\n      calculation.xBuckets = { mode: HeatmapCalculationMode.Count, value: `${angular.xBucketNumber}` };\n    }\n\n    if (angular.yBucketSize) {\n      calculation.yBuckets = { mode: HeatmapCalculationMode.Size, value: `${angular.yBucketSize}` };\n    } else if (angular.xBucketNumber) {\n      calculation.yBuckets = { mode: HeatmapCalculationMode.Count, value: `${angular.yBucketNumber}` };\n    }\n\n    if (oldYAxis.logBase > 1) {\n      calculation.yBuckets = {\n        mode: HeatmapCalculationMode.Count,\n        value: +oldYAxis.splitFactor > 0 ? `${oldYAxis.splitFactor}` : undefined,\n        scale: {\n          type: ScaleDistribution.Log,\n          log: oldYAxis.logBase,\n        },\n      };\n    }\n  }\n\n  const cellGap = asNumber(angular.cards?.cardPadding, 2);\n  const options: Options = {\n    calculate,\n    calculation,\n    color: {\n      ...defaultOptions.color,\n      steps: 128, // best match with existing colors\n    },\n    cellGap: cellGap ? cellGap : 1, // default to size 1\n    cellRadius: asNumber(angular.cards?.cardRound), // just to keep it\n    yAxis: {\n      axisPlacement: oldYAxis.show === false ? AxisPlacement.Hidden : AxisPlacement.Left,\n      reverse: Boolean(angular.reverseYBuckets),\n      axisWidth: asNumber(oldYAxis.width),\n      min: oldYAxis.min,\n      max: oldYAxis.max,\n      unit: oldYAxis.format,\n      decimals: oldYAxis.decimals,\n    },\n    cellValues: {\n      decimals: asNumber(angular.tooltipDecimals),\n    },\n    rowsFrame: {\n      layout: getHeatmapCellLayout(angular.yBucketBound),\n    },\n    legend: {\n      show: Boolean(angular.legend?.show),\n    },\n    showValue: VisibilityMode.Never,\n    tooltip: {\n      mode: Boolean(angular.tooltip?.show) ? TooltipDisplayMode.Single : TooltipDisplayMode.None,\n      yHistogram: Boolean(angular.tooltip?.showHistogram),\n    },\n    exemplars: {\n      ...defaultOptions.exemplars,\n    },\n  };\n\n  if (angular.hideZeroBuckets) {\n    options.filterValues = { ...defaultOptions.filterValues }; // min: 1e-9\n  }\n\n  // Migrate color options\n  const color = angular.color ?? {};\n  switch (color?.mode) {\n    case 'spectrum': {\n      options.color.mode = HeatmapColorMode.Scheme;\n\n      const current: string = color.colorScheme;\n      let scheme = colorSchemes.find((v) => v.name === current);\n      if (!scheme) {\n        scheme = colorSchemes.find((v) => current.indexOf(v.name) >= 0);\n      }\n      options.color.scheme = scheme ? scheme.name : defaultOptions.color.scheme;\n      break;\n    }\n    case 'opacity': {\n      options.color.mode = HeatmapColorMode.Opacity;\n      options.color.scale = color.scale;\n      break;\n    }\n  }\n  options.color.fill = color.cardColor;\n  options.color.min = color.min;\n  options.color.max = color.max;\n\n  if (typeof color.min === 'number' && typeof color.max === 'number' && color.min > color.max) {\n    options.color.min = color.max;\n    options.color.max = color.min;\n    options.color.reverse = true;\n  }\n\n  return { fieldConfig, options };\n}\n\nfunction getHeatmapCellLayout(v?: string): HeatmapCellLayout {\n  switch (v) {\n    case 'upper':\n      return HeatmapCellLayout.ge;\n    case 'lower':\n      return HeatmapCellLayout.le;\n    case 'middle':\n      return HeatmapCellLayout.unknown;\n  }\n  return HeatmapCellLayout.auto;\n}\n\nfunction asNumber(v: unknown, defaultValue?: number): number | undefined {\n  if (v == null || v === '') {\n    return defaultValue;\n  }\n  const num = +v;\n  return isNaN(num) ? defaultValue : num;\n}\n","import { VisualizationSuggestionsBuilder } from '@grafana/data';\nimport { config } from '@grafana/runtime';\n\nimport { prepareHeatmapData } from './fields';\nimport { quantizeScheme } from './palettes';\nimport { Options, defaultOptions } from './types';\n\nexport class HeatmapSuggestionsSupplier {\n  getSuggestionsForData(builder: VisualizationSuggestionsBuilder) {\n    const { dataSummary } = builder;\n\n    if (\n      !builder.data?.series ||\n      !dataSummary.hasData ||\n      dataSummary.timeFieldCount < 1 ||\n      dataSummary.numberFieldCount < 2 ||\n      dataSummary.numberFieldCount > 10\n    ) {\n      return;\n    }\n\n    const palette = quantizeScheme(defaultOptions.color, config.theme2);\n    const info = prepareHeatmapData({\n      frames: builder.data.series,\n      options: defaultOptions,\n      palette,\n      theme: config.theme2,\n    });\n    if (!info || info.warning) {\n      return;\n    }\n\n    builder.getListAppender<Options, {}>({\n      name: '',\n      pluginId: 'heatmap',\n      options: {},\n      fieldConfig: {\n        defaults: {\n          custom: {},\n        },\n        overrides: [],\n      },\n    });\n  }\n}\n","import { DataFrame, FieldConfigProperty, FieldType, identityOverrideProcessor, PanelPlugin } from '@grafana/data';\nimport { t } from '@grafana/i18n';\nimport { config } from '@grafana/runtime';\nimport {\n  AxisPlacement,\n  GraphFieldConfig,\n  ScaleDistribution,\n  ScaleDistributionConfig,\n  HeatmapCellLayout,\n} from '@grafana/schema';\nimport { TooltipDisplayMode } from '@grafana/ui';\nimport { addHideFrom, ScaleDistributionEditor } from '@grafana/ui/internal';\nimport { ColorScale } from 'app/core/components/ColorScale/ColorScale';\nimport { addHeatmapCalculationOptions } from 'app/features/transformers/calculateHeatmap/editor/helper';\nimport { readHeatmapRowsCustomMeta } from 'app/features/transformers/calculateHeatmap/heatmap';\n\nimport { HeatmapPanel } from './HeatmapPanel';\nimport { prepareHeatmapData } from './fields';\nimport { heatmapChangedHandler, heatmapMigrationHandler } from './migrations';\nimport { colorSchemes, quantizeScheme } from './palettes';\nimport { HeatmapSuggestionsSupplier } from './suggestions';\nimport { Options, defaultOptions, HeatmapColorMode, HeatmapColorScale } from './types';\n\nexport const plugin = new PanelPlugin<Options, GraphFieldConfig>(HeatmapPanel)\n  .useFieldConfig({\n    disableStandardOptions: Object.values(FieldConfigProperty).filter((v) => v !== FieldConfigProperty.Links),\n    standardOptions: {\n      [FieldConfigProperty.Links]: {\n        settings: {\n          showOneClick: true,\n        },\n      },\n    },\n    useCustomConfig: (builder) => {\n      const category = [t('heatmap.category-heatmap', 'Heatmap')];\n      builder.addCustomEditor<void, ScaleDistributionConfig>({\n        id: 'scaleDistribution',\n        path: 'scaleDistribution',\n        name: t('heatmap.name-y-axis-scale', 'Y axis scale'),\n        category,\n        editor: ScaleDistributionEditor,\n        override: ScaleDistributionEditor,\n        defaultValue: { type: ScaleDistribution.Linear },\n        shouldApply: (f) => f.type === FieldType.number,\n        process: identityOverrideProcessor,\n        hideFromDefaults: true,\n      });\n      addHideFrom(builder); // for tooltip etc\n    },\n  })\n  .setPanelChangeHandler(heatmapChangedHandler)\n  .setMigrationHandler(heatmapMigrationHandler)\n  .setPanelOptions((builder, context) => {\n    const opts = context.options ?? defaultOptions;\n\n    let isOrdinalY = false;\n\n    if (context.data.length > 0) {\n      try {\n        // NOTE: this feels like overkill/expensive just to assert if we have an ordinal y\n        // can probably simplify without doing full dataprep\n        const palette = quantizeScheme(opts.color, config.theme2);\n        const v = prepareHeatmapData({\n          frames: context.data,\n          options: opts,\n          palette,\n          theme: config.theme2,\n        });\n        isOrdinalY = readHeatmapRowsCustomMeta(v.heatmap).yOrdinalDisplay != null;\n      } catch {}\n    }\n\n    let category = [t('heatmap.category-heatmap', 'Heatmap')];\n\n    builder.addRadio({\n      path: 'calculate',\n      name: t('heatmap.name-calculate-from-data', 'Calculate from data'),\n      defaultValue: defaultOptions.calculate,\n      category,\n      settings: {\n        options: [\n          { label: t('heatmap.calculate-from-data-options.label-yes', 'Yes'), value: true },\n          { label: t('heatmap.calculate-from-data-options.label-no', 'No'), value: false },\n        ],\n      },\n    });\n\n    if (opts.calculate) {\n      addHeatmapCalculationOptions('calculation.', builder, opts.calculation, category);\n    }\n\n    category = [t('heatmap.category-y-axis', 'Y Axis')];\n\n    builder\n      .addRadio({\n        path: 'yAxis.axisPlacement',\n        name: t('heatmap.name-placement', 'Placement'),\n        defaultValue: defaultOptions.yAxis.axisPlacement ?? AxisPlacement.Left,\n        category,\n        settings: {\n          options: [\n            { label: t('heatmap.placement-options.label-left', 'Left'), value: AxisPlacement.Left },\n            { label: t('heatmap.placement-options.label-right', 'Right'), value: AxisPlacement.Right },\n            { label: t('heatmap.placement-options.label-hidden', 'Hidden'), value: AxisPlacement.Hidden },\n          ],\n        },\n      })\n      .addUnitPicker({\n        category,\n        path: 'yAxis.unit',\n        name: t('heatmap.name-unit', 'Unit'),\n        defaultValue: undefined,\n        settings: {\n          isClearable: true,\n        },\n      })\n      .addNumberInput({\n        category,\n        path: 'yAxis.decimals',\n        name: t('heatmap.name-decimals', 'Decimals'),\n        settings: {\n          placeholder: t('heatmap.placeholder-decimals', 'Auto'),\n        },\n      });\n\n    if (!isOrdinalY) {\n      // if undefined, then show the min+max\n      builder\n        .addNumberInput({\n          path: 'yAxis.min',\n          name: t('heatmap.name-min-value', 'Min value'),\n          settings: {\n            placeholder: t('heatmap.placeholder-min-value', 'Auto'),\n          },\n          category,\n        })\n        .addTextInput({\n          path: 'yAxis.max',\n          name: t('heatmap.name-max-value', 'Max value'),\n          settings: {\n            placeholder: t('heatmap.placeholder-max-value', 'Auto'),\n          },\n          category,\n        });\n    }\n\n    builder\n      .addNumberInput({\n        path: 'yAxis.axisWidth',\n        name: t('heatmap.name-axis-width', 'Axis width'),\n        defaultValue: defaultOptions.yAxis.axisWidth,\n        settings: {\n          placeholder: t('heatmap.placeholder-axis-width', 'Auto'),\n          min: 5, // smaller should just be hidden\n        },\n        category,\n      })\n      .addTextInput({\n        path: 'yAxis.axisLabel',\n        name: t('heatmap.name-axis-label', 'Axis label'),\n        defaultValue: defaultOptions.yAxis.axisLabel,\n        settings: {\n          placeholder: t('heatmap.placeholder-axis-label', 'Auto'),\n        },\n        category,\n      });\n\n    if (!opts.calculate) {\n      builder.addRadio({\n        path: 'rowsFrame.layout',\n        name: t('heatmap.name-tick-alignment', 'Tick alignment'),\n        defaultValue: defaultOptions.rowsFrame?.layout ?? HeatmapCellLayout.auto,\n        category,\n        settings: {\n          options: [\n            { label: t('heatmap.tick-alignment-options.label-auto', 'Auto'), value: HeatmapCellLayout.auto },\n            { label: t('heatmap.tick-alignment-options.label-top', 'Top (LE)'), value: HeatmapCellLayout.le },\n            { label: t('heatmap.tick-alignment-options.label-middle', 'Middle'), value: HeatmapCellLayout.unknown },\n            { label: t('heatmap.tick-alignment-options.label-bottom', 'Bottom (GE)'), value: HeatmapCellLayout.ge },\n          ],\n        },\n      });\n    }\n    builder.addBooleanSwitch({\n      path: 'yAxis.reverse',\n      name: t('heatmap.name-reverse', 'Reverse'),\n      defaultValue: defaultOptions.yAxis.reverse === true,\n      category,\n    });\n\n    category = [t('heatmap.category-colors', 'Colors')];\n\n    builder.addRadio({\n      path: `color.mode`,\n      name: t('heatmap.name-mode', 'Mode'),\n      defaultValue: defaultOptions.color.mode,\n      category,\n      settings: {\n        options: [\n          { label: t('heatmap.mode-options.label-scheme', 'Scheme'), value: HeatmapColorMode.Scheme },\n          { label: t('heatmap.mode-options.label-opacity', 'Opacity'), value: HeatmapColorMode.Opacity },\n        ],\n      },\n    });\n\n    builder.addColorPicker({\n      path: `color.fill`,\n      name: t('heatmap.name-color', 'Color'),\n      defaultValue: defaultOptions.color.fill,\n      category,\n      showIf: (opts) => opts.color.mode === HeatmapColorMode.Opacity,\n    });\n\n    builder.addRadio({\n      path: `color.scale`,\n      name: t('heatmap.name-scale', 'Scale'),\n      defaultValue: defaultOptions.color.scale,\n      category,\n      settings: {\n        options: [\n          { label: t('heatmap.scale-options.label-exponential', 'Exponential'), value: HeatmapColorScale.Exponential },\n          { label: t('heatmap.scale-options.label-linear', 'Linear'), value: HeatmapColorScale.Linear },\n        ],\n      },\n      showIf: (opts) => opts.color.mode === HeatmapColorMode.Opacity,\n    });\n\n    builder.addSliderInput({\n      path: 'color.exponent',\n      name: t('heatmap.name-exponent', 'Exponent'),\n      defaultValue: defaultOptions.color.exponent,\n      category,\n      settings: {\n        min: 0.1, // 1 for on/off?\n        max: 2,\n        step: 0.1,\n      },\n      showIf: (opts) =>\n        opts.color.mode === HeatmapColorMode.Opacity && opts.color.scale === HeatmapColorScale.Exponential,\n    });\n\n    builder.addSelect({\n      path: `color.scheme`,\n      name: t('heatmap.name-scheme', 'Scheme'),\n      description: '',\n      defaultValue: defaultOptions.color.scheme,\n      category,\n      settings: {\n        options: colorSchemes.map((scheme) => ({\n          value: scheme.name,\n          label: scheme.name,\n          //description: 'Set a geometry field based on the results of other fields',\n        })),\n      },\n      showIf: (opts) => opts.color.mode !== HeatmapColorMode.Opacity,\n    });\n\n    builder\n      .addSliderInput({\n        path: 'color.steps',\n        name: t('heatmap.name-steps', 'Steps'),\n        defaultValue: defaultOptions.color.steps,\n        category,\n        settings: {\n          min: 2,\n          max: 128,\n          step: 1,\n        },\n      })\n      .addBooleanSwitch({\n        path: 'color.reverse',\n        name: t('heatmap.name-reverse', 'Reverse'),\n        defaultValue: defaultOptions.color.reverse,\n        category,\n      })\n      .addCustomEditor({\n        id: '__scale__',\n        path: `__scale__`,\n        name: '',\n        category,\n        editor: () => {\n          const palette = quantizeScheme(opts.color, config.theme2);\n          return (\n            <div>\n              <ColorScale colorPalette={palette} min={1} max={100} />\n            </div>\n          );\n        },\n      });\n\n    builder\n      .addNumberInput({\n        path: 'color.min',\n        name: t('heatmap.name-start-color-from-value', 'Start color scale from value'),\n        defaultValue: defaultOptions.color.min,\n        settings: {\n          placeholder: t('heatmap.placeholder-start-color-from-value', 'Auto (min)'),\n        },\n        category,\n      })\n      .addNumberInput({\n        path: 'color.max',\n        name: t('heatmap.name-end-color-at-value', 'End color scale at value'),\n        defaultValue: defaultOptions.color.max,\n        settings: {\n          placeholder: t('heatmap.placeholder-end-color-at-value', 'Auto (max)'),\n        },\n        category,\n      });\n\n    category = [t('heatmap.category-cell-display', 'Cell display')];\n\n    if (!opts.calculate) {\n      builder.addTextInput({\n        path: 'rowsFrame.value',\n        name: t('heatmap.name-value-name', 'Value name'),\n        defaultValue: defaultOptions.rowsFrame?.value,\n        settings: {\n          placeholder: t('heatmap.placeholder-value-name', 'Value'),\n        },\n        category,\n      });\n    }\n\n    builder\n      .addUnitPicker({\n        category,\n        path: 'cellValues.unit',\n        name: t('heatmap.name-unit', 'Unit'),\n        defaultValue: undefined,\n        settings: {\n          isClearable: true,\n        },\n      })\n      .addNumberInput({\n        category,\n        path: 'cellValues.decimals',\n        name: t('heatmap.name-decimals', 'Decimals'),\n        settings: {\n          placeholder: t('heatmap.placeholder-decimals', 'Auto'),\n        },\n      });\n\n    builder\n      // .addRadio({\n      //   path: 'showValue',\n      //   name: 'Show values',\n      //   defaultValue: defaultOptions.showValue,\n      //   category,\n      //   settings: {\n      //     options: [\n      //       { value: VisibilityMode.Auto, label: 'Auto' },\n      //       { value: VisibilityMode.Always, label: 'Always' },\n      //       { value: VisibilityMode.Never, label: 'Never' },\n      //     ],\n      //   },\n      // })\n      .addSliderInput({\n        name: t('heatmap.name-cell-gap', 'Cell gap'),\n        path: 'cellGap',\n        defaultValue: defaultOptions.cellGap,\n        category,\n        settings: {\n          min: 0,\n          max: 25,\n        },\n      })\n      .addNumberInput({\n        path: 'filterValues.le',\n        name: t('heatmap.name-hide-cells-lt', 'Hide cells with values <='),\n        defaultValue: defaultOptions.filterValues?.le,\n        settings: {\n          placeholder: t('heatmap.placeholder-hide-cells-lt', 'None'),\n        },\n        category,\n      })\n      .addNumberInput({\n        path: 'filterValues.ge',\n        name: t('heatmap.name-hide-cells-gt', 'Hide cells with values >='),\n        defaultValue: defaultOptions.filterValues?.ge,\n        settings: {\n          placeholder: t('heatmap.placeholder-hide-cells-gt', 'None'),\n        },\n        category,\n      });\n    // .addSliderInput({\n    //   name: 'Cell radius',\n    //   path: 'cellRadius',\n    //   defaultValue: defaultOptions.cellRadius,\n    //   category,\n    //   settings: {\n    //     min: 0,\n    //     max: 100,\n    //   },\n    // })\n\n    category = [t('heatmap.category-tooltip', 'Tooltip')];\n\n    builder.addRadio({\n      path: 'tooltip.mode',\n      name: t('heatmap.name-tooltip-mode', 'Tooltip mode'),\n      category,\n      defaultValue: TooltipDisplayMode.Single,\n      settings: {\n        options: [\n          { value: TooltipDisplayMode.Single, label: t('heatmap.tooltip-mode-options.label-single', 'Single') },\n          { value: TooltipDisplayMode.Multi, label: t('heatmap.tooltip-mode-options.label-all', 'All') },\n          { value: TooltipDisplayMode.None, label: t('heatmap.tooltip-mode-options.label-hidden', 'Hidden') },\n        ],\n      },\n    });\n\n    builder.addBooleanSwitch({\n      path: 'tooltip.yHistogram',\n      name: t('heatmap.name-show-histogram', 'Show histogram (Y axis)'),\n      defaultValue: defaultOptions.tooltip.yHistogram,\n      category,\n      showIf: (opts) => opts.tooltip.mode === TooltipDisplayMode.Single,\n    });\n\n    builder.addBooleanSwitch({\n      path: 'tooltip.showColorScale',\n      name: t('heatmap.name-show-color-scale', 'Show color scale'),\n      defaultValue: defaultOptions.tooltip.showColorScale,\n      category,\n      showIf: (opts) => opts.tooltip.mode === TooltipDisplayMode.Single,\n    });\n\n    builder.addNumberInput({\n      path: 'tooltip.maxWidth',\n      name: t('heatmap.name-max-width', 'Max width'),\n      category,\n      settings: {\n        integer: true,\n      },\n      showIf: (opts) => opts.tooltip.mode !== TooltipDisplayMode.None,\n    });\n\n    builder.addNumberInput({\n      path: 'tooltip.maxHeight',\n      name: t('heatmap.name-max-height', 'Max height'),\n      category,\n      defaultValue: undefined,\n      settings: {\n        integer: true,\n      },\n      showIf: (options: Options, data: DataFrame[] | undefined, annotations: DataFrame[] | undefined) =>\n        options.tooltip?.mode === TooltipDisplayMode.Multi ||\n        annotations?.some((df) => df.meta?.custom?.resultType === 'exemplar'),\n    });\n\n    category = [t('heatmap.category-legend', 'Legend')];\n    builder.addBooleanSwitch({\n      path: 'legend.show',\n      name: t('heatmap.name-show-legend', 'Show legend'),\n      defaultValue: defaultOptions.legend.show,\n      category,\n    });\n\n    category = [t('heatmap.category-exemplars', 'Exemplars')];\n    builder.addColorPicker({\n      path: 'exemplars.color',\n      name: t('heatmap.name-color', 'Color'),\n      defaultValue: defaultOptions.exemplars.color,\n      category,\n      showIf: (options: Options, data: DataFrame[] | undefined, annotations: DataFrame[] | undefined) =>\n        annotations?.some((df) => df.meta?.custom?.resultType === 'exemplar'),\n    });\n  })\n  .setSuggestionsSupplier(new HeatmapSuggestionsSupplier())\n  .setDataSupport({ annotations: true });\n","import { css } from '@emotion/css';\nimport { useState, useEffect } from 'react';\nimport * as React from 'react';\n\nimport { GrafanaTheme2 } from '@grafana/data';\nimport { useTheme2 } from '@grafana/ui';\n\ntype Props = {\n  colorPalette: string[];\n  min: number;\n  max: number;\n\n  // Show a value as string -- when not defined, the raw values will not be shown\n  display?: (v: number) => string;\n  hoverValue?: number;\n  useStopsPercentage?: boolean;\n};\n\ntype HoverState = {\n  isShown: boolean;\n  value: number;\n};\n\nconst GRADIENT_STOPS = 10;\n\nexport const ColorScale = ({ colorPalette, min, max, display, hoverValue, useStopsPercentage }: Props) => {\n  const [colors, setColors] = useState<string[]>([]);\n  const [scaleHover, setScaleHover] = useState<HoverState>({ isShown: false, value: 0 });\n  const [percent, setPercent] = useState<number | null>(null); // 0-100 for CSS percentage\n\n  const theme = useTheme2();\n  const styles = getStyles(theme, colors);\n\n  useEffect(() => {\n    setColors(getGradientStops({ colorArray: colorPalette, stops: GRADIENT_STOPS, useStopsPercentage }));\n  }, [colorPalette, useStopsPercentage]);\n\n  const onScaleMouseMove = (event: React.MouseEvent<HTMLDivElement>) => {\n    const divOffset = event.nativeEvent.offsetX;\n    const offsetWidth = event.currentTarget.offsetWidth;\n    const normPercentage = Math.floor((divOffset * 100) / offsetWidth + 1);\n    const scaleValue = Math.floor(((max - min) * normPercentage) / 100 + min);\n\n    setScaleHover({ isShown: true, value: scaleValue });\n    setPercent(normPercentage);\n  };\n\n  const onScaleMouseLeave = () => {\n    setScaleHover({ isShown: false, value: 0 });\n  };\n\n  useEffect(() => {\n    setPercent(hoverValue == null ? null : clampPercent100((hoverValue - min) / (max - min)));\n  }, [hoverValue, min, max]);\n\n  return (\n    <div className={styles.scaleWrapper} onMouseMove={onScaleMouseMove} onMouseLeave={onScaleMouseLeave}>\n      <div className={styles.scaleGradient}>\n        {display && (scaleHover.isShown || hoverValue !== undefined) && (\n          <div className={styles.followerContainer}>\n            <div className={styles.follower} style={{ left: `${percent}%` }} />\n          </div>\n        )}\n      </div>\n      {display && (\n        <div className={styles.followerContainer}>\n          <div className={styles.legendValues}>\n            <span className={styles.disabled}>{display(min)}</span>\n            <span className={styles.disabled}>{display(max)}</span>\n          </div>\n          {percent != null && (scaleHover.isShown || hoverValue !== undefined) && (\n            <span className={styles.hoverValue} style={{ left: `${percent}%` }}>\n              {display(hoverValue ?? scaleHover.value)}\n            </span>\n          )}\n        </div>\n      )}\n    </div>\n  );\n};\n\nconst getGradientStops = ({\n  colorArray,\n  stops,\n  useStopsPercentage = true,\n}: {\n  colorArray: string[];\n  stops: number;\n  useStopsPercentage?: boolean;\n}): string[] => {\n  const colorCount = colorArray.length;\n  if (useStopsPercentage && colorCount <= 20) {\n    const incr = (1 / colorCount) * 100;\n    let per = 0;\n    const stops: string[] = [];\n    for (const color of colorArray) {\n      if (per > 0) {\n        stops.push(`${color} ${per}%`);\n      } else {\n        stops.push(color);\n      }\n      per += incr;\n      stops.push(`${color} ${per}%`);\n    }\n    return stops;\n  }\n\n  const gradientEnd = colorArray[colorCount - 1];\n  const skip = Math.ceil(colorCount / stops);\n  const gradientStops = new Set<string>();\n\n  for (let i = 0; i < colorCount; i += skip) {\n    gradientStops.add(colorArray[i]);\n  }\n\n  gradientStops.add(gradientEnd);\n\n  return [...gradientStops];\n};\n\nfunction clampPercent100(v: number) {\n  if (v > 1) {\n    return 100;\n  }\n  if (v < 0) {\n    return 0;\n  }\n  return v * 100;\n}\n\nconst getStyles = (theme: GrafanaTheme2, colors: string[]) => ({\n  scaleWrapper: css({\n    width: '100%',\n    fontSize: '11px',\n    opacity: 1,\n  }),\n  scaleGradient: css({\n    background: `linear-gradient(90deg, ${colors.join()})`,\n    height: '9px',\n    pointerEvents: 'none',\n    borderRadius: theme.shape.radius.default,\n  }),\n  legendValues: css({\n    display: 'flex',\n    justifyContent: 'space-between',\n    pointerEvents: 'none',\n  }),\n  hoverValue: css({\n    position: 'absolute',\n    marginTop: '-14px',\n    padding: '3px 15px',\n    transform: 'translateX(-50%)',\n  }),\n  followerContainer: css({\n    position: 'relative',\n    pointerEvents: 'none',\n    whiteSpace: 'nowrap',\n  }),\n  follower: css({\n    position: 'absolute',\n    height: '13px',\n    width: '13px',\n    borderRadius: theme.shape.radius.default,\n    transform: 'translateX(-50%) translateY(-50%)',\n    border: `2px solid ${theme.colors.text.primary}`,\n    top: '5px',\n  }),\n  disabled: css({\n    color: theme.colors.text.disabled,\n  }),\n});\n","// Core Grafana history https://github.com/grafana/grafana/blob/v11.0.0-preview/public/app/plugins/datasource/prometheus/result_transformer.ts\nimport { flatten, forOwn, groupBy, partition } from 'lodash';\n\nimport {\n  CoreApp,\n  DataFrame,\n  DataFrameType,\n  DataLink,\n  DataQueryRequest,\n  DataQueryResponse,\n  DataTopic,\n  Field,\n  FieldType,\n  getDisplayProcessor,\n  getFieldDisplayName,\n  Labels,\n  sortDataFrame,\n  TIME_SERIES_TIME_FIELD_NAME,\n  TIME_SERIES_VALUE_FIELD_NAME,\n} from '@grafana/data';\nimport { getDataSourceSrv } from '@grafana/runtime';\n\nimport { ExemplarTraceIdDestination, PromMetric, PromQuery, PromValue } from './types';\n\n// handles case-insensitive Inf, +Inf, -Inf (with optional \"inity\" suffix)\nconst INFINITY_SAMPLE_REGEX = /^[+-]?inf(?:inity)?$/i;\n\nconst isTableResult = (dataFrame: DataFrame, options: DataQueryRequest<PromQuery>): boolean => {\n  // We want to process vector and scalar results in Explore as table\n  if (\n    options.app === CoreApp.Explore &&\n    (dataFrame.meta?.custom?.resultType === 'vector' || dataFrame.meta?.custom?.resultType === 'scalar')\n  ) {\n    return true;\n  }\n\n  // We want to process all dataFrames with target.format === 'table' as table\n  const target = options.targets.find((target) => target.refId === dataFrame.refId);\n  return target?.format === 'table';\n};\n\nconst isCumulativeHeatmapResult = (dataFrame: DataFrame, options: DataQueryRequest<PromQuery>): boolean => {\n  if (dataFrame.meta?.type === DataFrameType.HeatmapCells) {\n    return false;\n  }\n\n  const target = options.targets.find((target) => target.refId === dataFrame.refId);\n  return target?.format === 'heatmap';\n};\n\n// V2 result transformer used to transform query results from queries that were run through prometheus backend\nexport function transformV2(\n  response: DataQueryResponse,\n  request: DataQueryRequest<PromQuery>,\n  options: { exemplarTraceIdDestinations?: ExemplarTraceIdDestination[] }\n) {\n  // migration for dataplane field name issue\n  // update displayNameFromDS in the field config\n  response.data.forEach((f: DataFrame) => {\n    const target = request.targets.find((t) => t.refId === f.refId);\n    // check that the legend is selected as auto\n    if (target && target.legendFormat === '__auto') {\n      f.fields.forEach((field) => {\n        if (field.labels?.__name__ && field.labels?.__name__ === field.name) {\n          const fieldCopy = { ...field, name: TIME_SERIES_VALUE_FIELD_NAME };\n          field.config.displayNameFromDS = getFieldDisplayName(fieldCopy, f, response.data);\n        }\n      });\n    }\n  });\n\n  const [tableFrames, framesWithoutTable] = partition<DataFrame>(response.data, (df) => isTableResult(df, request));\n  const processedTableFrames = transformDFToTable(tableFrames);\n\n  const [exemplarFrames, framesWithoutTableAndExemplars] = partition<DataFrame>(\n    framesWithoutTable,\n    (df) => df.meta?.custom?.resultType === 'exemplar'\n  );\n\n  // EXEMPLAR FRAMES: We enrich exemplar frames with data links and add dataTopic meta info\n  const { exemplarTraceIdDestinations: destinations } = options;\n  const processedExemplarFrames = exemplarFrames.map((dataFrame) => {\n    if (destinations?.length) {\n      for (const exemplarTraceIdDestination of destinations) {\n        const traceIDField = dataFrame.fields.find((field) => field.name === exemplarTraceIdDestination.name);\n        if (traceIDField) {\n          const links = getDataLinks(exemplarTraceIdDestination);\n          traceIDField.config.links = traceIDField.config.links?.length\n            ? [...traceIDField.config.links, ...links]\n            : links;\n        }\n      }\n    }\n\n    return { ...dataFrame, meta: { ...dataFrame.meta, dataTopic: DataTopic.Annotations } };\n  });\n\n  const [heatmapResults, framesWithoutTableHeatmapsAndExemplars] = partition<DataFrame>(\n    framesWithoutTableAndExemplars,\n    (df) => isCumulativeHeatmapResult(df, request)\n  );\n\n  // this works around the fact that we only get back frame.name with le buckets when legendFormat == {{le}}...which is not the default\n  heatmapResults.forEach((df) => {\n    if (df.name == null) {\n      let f = df.fields.find((f) => f.type === FieldType.number);\n\n      if (f) {\n        let le = f.labels?.le;\n\n        if (le) {\n          // this is used for sorting the frames by numeric ascending le labels for de-accum\n          df.name = le;\n          // this is used for renaming the Value fields to le label\n          f.config.displayNameFromDS = le;\n        }\n      }\n    }\n  });\n\n  // Group heatmaps by query\n  const heatmapResultsGroupedByQuery = groupBy<DataFrame>(heatmapResults, (h) => h.refId);\n\n  // Initialize empty array to push grouped histogram frames to\n  let processedHeatmapResultsGroupedByQuery: DataFrame[][] = [];\n\n  // Iterate through every query in this heatmap\n  for (const query in heatmapResultsGroupedByQuery) {\n    // Get reference to dataFrames for heatmap\n    const heatmapResultsGroup = heatmapResultsGroupedByQuery[query];\n\n    // Create a new grouping by iterating through the data frames...\n    const heatmapResultsGroupedByValues = groupBy<DataFrame>(heatmapResultsGroup, (dataFrame) => {\n      // Each data frame has `Time` and `Value` properties, we want to get the values\n      const values = dataFrame.fields.find((field) => field.type === FieldType.number);\n      // Specific functionality for special \"le\" quantile heatmap value, we know if this value exists, that we do not want to calculate the heatmap density across data frames from the same quartile\n      if (values?.labels && HISTOGRAM_QUANTILE_LABEL_NAME in values.labels) {\n        const { le, ...notLE } = values?.labels;\n        return Object.values(notLE).join();\n      }\n\n      // Return a string made from the concatenation of this frame's values to represent a grouping in the query\n      return Object.values(values?.labels ?? []).join();\n    });\n\n    // Then iterate through the resultant object\n    forOwn(heatmapResultsGroupedByValues, (dataFrames, key) => {\n      // Sort frames within each grouping\n      const sortedHeatmap = dataFrames.sort(sortSeriesByLabel);\n      // And push the sorted grouping with the rest\n      processedHeatmapResultsGroupedByQuery.push(mergeHeatmapFrames(transformToHistogramOverTime(sortedHeatmap)));\n    });\n  }\n\n  // Everything else is processed as time_series result and graph preferredVisualisationType\n  const otherFrames = framesWithoutTableHeatmapsAndExemplars.map((dataFrame) => {\n    const df: DataFrame = {\n      ...dataFrame,\n      meta: {\n        ...dataFrame.meta,\n        preferredVisualisationType: 'graph',\n      },\n    };\n    return df;\n  });\n\n  const flattenedProcessedHeatmapFrames = flatten(processedHeatmapResultsGroupedByQuery);\n\n  return {\n    ...response,\n    data: [...otherFrames, ...processedTableFrames, ...flattenedProcessedHeatmapFrames, ...processedExemplarFrames],\n  };\n}\n\nconst HISTOGRAM_QUANTILE_LABEL_NAME = 'le';\n\nexport function transformDFToTable(dfs: DataFrame[]): DataFrame[] {\n  // If no dataFrames or if 1 dataFrames with no values, return original dataFrame\n  if (dfs.length === 0 || (dfs.length === 1 && dfs[0].length === 0)) {\n    return dfs;\n  }\n\n  // Group results by refId and process dataFrames with the same refId as 1 dataFrame\n  const dataFramesByRefId = groupBy(dfs, 'refId');\n  const refIds = Object.keys(dataFramesByRefId);\n\n  const frames = refIds.map((refId) => {\n    // Create timeField, valueField and labelFields\n    const valueText = getValueText(refIds.length, refId);\n    const valueField = getValueField({ data: [], valueName: valueText });\n    const timeField = getTimeField([]);\n    const labelFields: Field[] = [];\n\n    // Fill labelsFields with labels from dataFrames\n    dataFramesByRefId[refId].forEach((df) => {\n      const frameValueField = df.fields[1];\n      const promLabels = frameValueField?.labels ?? {};\n\n      Object.keys(promLabels)\n        .sort()\n        .forEach((label) => {\n          // If we don't have label in labelFields, add it\n          if (!labelFields.some((l) => l.name === label)) {\n            labelFields.push({\n              name: label,\n              config: { filterable: true },\n              type: FieldType.string,\n              values: [],\n            });\n          }\n        });\n    });\n\n    let prevTime = -Infinity;\n    let needsSort = false;\n\n    // Fill valueField, timeField and labelFields with values\n    dataFramesByRefId[refId].forEach((df) => {\n      timeField.config.interval ??= df.fields[0]?.config.interval;\n\n      const timeFields = df.fields[0]?.values ?? [];\n      const dataFields = df.fields[1]?.values ?? [];\n\n      timeFields.forEach((value) => {\n        timeField.values.push(value);\n\n        if (value < prevTime) {\n          needsSort = true;\n        }\n\n        prevTime = value;\n      });\n\n      dataFields.forEach((value) => {\n        valueField.values.push(parseSampleValue(value));\n        const labelsForField = df.fields[1].labels ?? {};\n        labelFields.forEach((field) => field.values.push(getLabelValue(labelsForField, field.name)));\n      });\n    });\n\n    const fields = [timeField, ...labelFields, valueField];\n\n    const frame: DataFrame = {\n      refId,\n      fields,\n      // Prometheus specific UI for instant queries\n      meta: {\n        ...dataFramesByRefId[refId][0].meta,\n        preferredVisualisationType: 'rawPrometheus' as const,\n      },\n      length: timeField.values.length,\n    };\n\n    return needsSort ? sortDataFrame(frame, 0) : frame;\n  });\n\n  return frames;\n}\n\nfunction getValueText(responseLength: number, refId = '') {\n  return responseLength > 1 ? `Value #${refId}` : 'Value';\n}\n\nfunction getDataLinks(options: ExemplarTraceIdDestination): DataLink[] {\n  const dataLinks: DataLink[] = [];\n\n  if (options.datasourceUid) {\n    const dataSourceSrv = getDataSourceSrv();\n    const dsSettings = dataSourceSrv.getInstanceSettings(options.datasourceUid);\n\n    // dsSettings is undefined because of the reasons below:\n    // - permissions issues (probably most likely)\n    // - deleted datasource\n    // - misconfiguration\n    if (dsSettings) {\n      dataLinks.push({\n        title: options.urlDisplayLabel || `Query with ${dsSettings?.name}`,\n        url: '',\n        internal: {\n          query: { query: '${__value.raw}', queryType: 'traceql' },\n          panelsState: {\n            trace: {\n              spanId: '${__data.fields[\"span_id\"]}',\n            },\n          },\n          datasourceUid: options.datasourceUid,\n          datasourceName: dsSettings?.name ?? 'Data source not found',\n        },\n      });\n    }\n  }\n\n  if (options.url) {\n    dataLinks.push({\n      title: options.urlDisplayLabel || `Go to ${options.url}`,\n      url: options.url,\n      targetBlank: true,\n    });\n  }\n  return dataLinks;\n}\n\nfunction getLabelValue(metric: PromMetric, label: string): string | number {\n  if (metric.hasOwnProperty(label)) {\n    return metric[label];\n  }\n  return '';\n}\n\nfunction getTimeField(data: PromValue[], isMs = false): Field<number> {\n  return {\n    name: TIME_SERIES_TIME_FIELD_NAME,\n    type: FieldType.time,\n    config: {},\n    values: data.map((val) => (isMs ? val[0] : val[0] * 1000)),\n  };\n}\n\ntype ValueFieldOptions = {\n  data: PromValue[];\n  valueName?: string;\n  parseValue?: boolean;\n  labels?: Labels;\n  displayNameFromDS?: string;\n};\n\nfunction getValueField({\n  data,\n  valueName = TIME_SERIES_VALUE_FIELD_NAME,\n  parseValue = true,\n  labels,\n  displayNameFromDS,\n}: ValueFieldOptions): Field {\n  return {\n    name: valueName,\n    type: FieldType.number,\n    display: getDisplayProcessor(),\n    config: {\n      displayNameFromDS,\n    },\n    labels,\n    values: data.map((val) => (parseValue ? parseSampleValue(val[1]) : val[1])),\n  };\n}\n\nexport function getOriginalMetricName(labelData: { [key: string]: string }) {\n  const metricName = labelData.__name__ || '';\n  delete labelData.__name__;\n  const labelPart = Object.entries(labelData)\n    .map((label) => `${label[0]}=\"${label[1]}\"`)\n    .join(',');\n  return `${metricName}{${labelPart}}`;\n}\n\nfunction mergeHeatmapFrames(frames: DataFrame[]): DataFrame[] {\n  if (frames.length === 0 || (frames.length === 1 && frames[0].length === 0)) {\n    return [];\n  }\n\n  const timeField = frames[0].fields.find((field) => field.type === FieldType.time)!;\n  const countFields = frames.map((frame) => {\n    let field = frame.fields.find((field) => field.type === FieldType.number)!;\n\n    return {\n      ...field,\n      name: field.config.displayNameFromDS!,\n    };\n  });\n\n  return [\n    {\n      ...frames[0],\n      meta: {\n        ...frames[0].meta,\n        type: DataFrameType.HeatmapRows,\n      },\n      fields: [timeField!, ...countFields],\n    },\n  ];\n}\n\n/** @internal */\nexport function transformToHistogramOverTime(seriesList: DataFrame[]): DataFrame[] {\n  /*      t1 = timestamp1, t2 = timestamp2 etc.\n            t1  t2  t3          t1  t2  t3\n    le10    10  10  0     =>    10  10  0\n    le20    20  10  30    =>    10  0   30\n    le30    30  10  35    =>    10  0   5\n    */\n\n  for (let i = seriesList.length - 1; i > 0; i--) {\n    const topSeries = seriesList[i].fields.find((s) => s.type === FieldType.number);\n    const bottomSeries = seriesList[i - 1].fields.find((s) => s.type === FieldType.number);\n    if (!topSeries || !bottomSeries) {\n      throw new Error('Prometheus heatmap transform error: data should be a time series');\n    }\n\n    for (let j = 0; j < topSeries.values.length; j++) {\n      const bottomPoint = bottomSeries.values[j] || [0];\n      topSeries.values[j] -= bottomPoint;\n\n      if (topSeries.values[j] < 1e-9) {\n        topSeries.values[j] = 0;\n      }\n    }\n  }\n\n  return seriesList;\n}\n\nexport function sortSeriesByLabel(s1: DataFrame, s2: DataFrame): number {\n  let le1, le2;\n\n  try {\n    // the state.displayName conditions are here because we also use this sorting util fn\n    // in panels where isHeatmapResult was false but we still want to sort numerically-named\n    // fields after the full unique displayName is cached in field state\n    le1 = parseSampleValue(s1.fields[1].state?.displayName ?? s1.name ?? s1.fields[1].name);\n    le2 = parseSampleValue(s2.fields[1].state?.displayName ?? s2.name ?? s2.fields[1].name);\n  } catch (err) {\n    // fail if not integer. might happen with bad queries\n    console.error(err);\n    return 0;\n  }\n\n  if (le1 > le2) {\n    return 1;\n  }\n\n  if (le1 < le2) {\n    return -1;\n  }\n\n  return 0;\n}\n\n/** @internal */\nexport function parseSampleValue(value: string): number {\n  if (INFINITY_SAMPLE_REGEX.test(value)) {\n    return value[0] === '-' ? Number.NEGATIVE_INFINITY : Number.POSITIVE_INFINITY;\n  }\n  return parseFloat(value);\n}\n","import { LinkModel } from '@grafana/data';\nimport { t } from '@grafana/i18n';\nimport {\n  VizTooltipContent,\n  VizTooltipFooter,\n  VizTooltipItem,\n  VizTooltipHeader,\n  VizTooltipWrapper,\n} from '@grafana/ui/internal';\n\nexport interface Props {\n  items: VizTooltipItem[];\n  links?: LinkModel[];\n  isPinned: boolean;\n  maxHeight?: number;\n}\n\nexport const ExemplarTooltip = ({ items, links, isPinned, maxHeight }: Props) => {\n  const timeItem = items.find((val) => val.label === 'Time');\n\n  return (\n    <VizTooltipWrapper>\n      <VizTooltipHeader\n        item={{\n          label: t('exemplar-tooltip-header', 'Exemplar'),\n          value: timeItem?.value ?? '',\n        }}\n        isPinned={isPinned}\n      />\n      <VizTooltipContent\n        items={items.filter((item) => item !== timeItem)}\n        isPinned={isPinned}\n        maxHeight={maxHeight}\n        scrollable={maxHeight != null}\n      />\n      <VizTooltipFooter dataLinks={links ?? []} />\n    </VizTooltipWrapper>\n  );\n};\n"],"names":["renderHistogram","can","histCanWidth","histCanHeight","xVals","countVals","index","yBucketCount","histCtx","fromIdx","toIdx","maxCount","i","c","pHov","pRest","j","pctY","pctX","p","xCoord","width","getHoverCellColor","data","colorPalette","colorIndex","cellColor","conversions","noPluralize","formatMilliseconds","milliseconds","value","unit","unitString","getFieldFromData","fieldType","isSparse","field","name","getSparseCellMinMax","fields","xMax","f","yMin","yMax","interval","HeatmapTooltip","props","dispValuesAndLinks","displayValues","links","ExemplarTooltip","dispVal","HeatmapHoverCell","defaultHistogramWidth","defaultHistogramHeight","dataIdxs","dataRef","showHistogram","isPinned","showColorScale","mode","annotate","maxHeight","maxWidth","replaceVariables","canExecuteActions","xField","yField","countField","xDisp","v","yVals","meta","yDisp","yBucketMin","yBucketMax","xBucketMin","xBucketMax","nonNumericOrdinalDisplay","contentItems","getYValueIndex","idx","yValueIdx","xValueIdx","getData","yMinIdx","yMaxIdx","exp","getDisplayData","vals","color","count","getCountValue","label","getContentLabels","isMulti","fromToInt","xVal","val","footer","actions","linksField","visible","hasLinks","VizTooltipFooter","theme","themeSpacing","histCssWidth","histCssHeight","headerItem","customContent","ColorScale","VizTooltipWrapper","VizTooltipHeader","VizTooltipContent","content","prepareHeatmapData","frames","annotations","options","palette","timeRange","exemplars","calculation","getCalculationObjectWithDefaults","getDenseHeatmapData","rowsHeatmap","frame","getSparseHeatmapData","numberFields","a","b","updateFieldDisplay","valueField","disp","minValue","maxValue","xName","yName","xs","ys","dlen","yBinQty","xBinQty","yBinIncr","xBinIncr","calcX","calcY","opts","decimals","colorSchemes","DEFAULT_SCHEME","scheme","quantizeScheme","steps","fill","tinycolor","scale","fnName","interpolate","rgbStr","rgb","HeatmapPanel","id","timeZone","height","fieldConfig","eventBus","onChangeTimeRange","styles","getStyles","sync","eventsScope","canAddAnnotations","onSelectRange","cursorSync","userCanExecuteActions","newAnnotationRange","setNewAnnotationRange","timeRangeRef","info","ex","facets","exemplarsXFacet","exemplarsYFacet","builder","scaleConfig","renderLegend","VizLayout","PanelDataErrorView","enableAnnotationCreation","vizWidth","vizHeight","EventBusPlugin","TooltipPlugin2","u","seriesIdx","dismiss","timeRange2","viaSync","AnnotationsPlugin2","OutsideRangePlugin","heatmapMigrationHandler","panel","heatmapChangedHandler","showTooltip","prevPluginId","prevOptions","prevFieldConfig","angularToReactHeatmap","bucketFrame","angular","calculate","oldYAxis","cellGap","asNumber","getHeatmapCellLayout","current","defaultValue","num","HeatmapSuggestionsSupplier","dataSummary","config","PanelPlugin","category","context","isOrdinalY","df","GRADIENT_STOPS","min","max","display","hoverValue","useStopsPercentage","colors","setColors","scaleHover","setScaleHover","percent","setPercent","getGradientStops","onScaleMouseMove","event","divOffset","offsetWidth","normPercentage","scaleValue","onScaleMouseLeave","clampPercent100","colorArray","stops","colorCount","incr","per","gradientEnd","skip","gradientStops","INFINITY_SAMPLE_REGEX","isTableResult","dataFrame","target","isCumulativeHeatmapResult","transformV2","response","request","t","fieldCopy","tableFrames","framesWithoutTable","processedTableFrames","transformDFToTable","exemplarFrames","framesWithoutTableAndExemplars","destinations","processedExemplarFrames","exemplarTraceIdDestination","traceIDField","getDataLinks","heatmapResults","framesWithoutTableHeatmapsAndExemplars","le","heatmapResultsGroupedByQuery","h","processedHeatmapResultsGroupedByQuery","query","heatmapResultsGroup","heatmapResultsGroupedByValues","values","HISTOGRAM_QUANTILE_LABEL_NAME","notLE","dataFrames","key","sortedHeatmap","sortSeriesByLabel","mergeHeatmapFrames","transformToHistogramOverTime","otherFrames","flattenedProcessedHeatmapFrames","dfs","dataFramesByRefId","refIds","refId","valueText","getValueText","getValueField","timeField","getTimeField","labelFields","promLabels","l","prevTime","needsSort","timeFields","dataFields","parseSampleValue","labelsForField","getLabelValue","responseLength","dataLinks","dsSettings","metric","isMs","valueName","parseValue","labels","displayNameFromDS","getOriginalMetricName","labelData","metricName","labelPart","countFields","seriesList","topSeries","s","bottomSeries","bottomPoint","s1","s2","le1","le2","err","items","timeItem","item"],"sourceRoot":""}