"use strict";(self.webpackChunkgrafana=self.webpackChunkgrafana||[]).push([[6088],{27081:(At,it,s)=>{s.d(it,{v:()=>Z});var d=s(92138),N=s(25229),rt=s(57852),X=s(92745),M=s(36490),lt=s(68143),I=s(43173),Y=s(6890),dt=s(45229),ct=s(64762),q=s(83873),V=s(29043),G=s(60017),B=s(48600),ht=s(22429),P=s(75421),J=s(41644),_=s(84019),ut=s(66198),gt=s(17621);function H(v){return async C=>{const D=await q.IB.getFolderByUid(v);return C((0,gt.jl)(D)),C((0,Y.Vz)((0,ut.R4)(D))),D}}var tt=s(79718),pt=s(4590),U=s(99305),O=s(6262),A=s(15130),ft=s(32380),mt=s(39167),vt=s(93612),et=s(95710),Ct=s(7817),Et=s(83127),W=s(37918);const Q="initDashboard";async function k(v,C,D){try{switch(v.routeName){case O.Z4.Home:{const x=(0,J.sP)("v1").getDashboardFromCache(J.m6);if(x)return x;const h=await q.IB.get("/api/dashboards/home");if((0,O.U)(h)){const z=d.I.stripBaseFromUrl(h.redirectUri);return M.Ny.replace(z),null}return h.meta.canSave=!1,h.meta.canShare=!1,h.meta.canStar=!1,h}case O.Z4.Public:return await B.np.loadDashboard("public",v.urlSlug,v.accessToken);case O.Z4.Normal:{const g=await B.np.loadDashboard(v.urlType,v.urlSlug,v.urlUid);if(g.meta.folderUid)try{await C(H(g.meta.folderUid))}catch(x){console.warn("Error fetching parent folder",g.meta.folderUid,"for dashboard",x)}if(v.fixUrl&&g.meta.url&&!pt._o.state.isPlaying){const x=d.I.stripBaseFromUrl(g.meta.url),h=M.Ny.getLocation().pathname;x!==h&&(M.Ny.replace({...M.Ny.getLocation(),pathname:x}),console.log("not correct url correcting",x,h))}return g}case O.Z4.New:return v.urlFolderUid&&await C(H(v.urlFolderUid)),await(0,_.X)(v.urlFolderUid);default:throw{message:"Unknown route "+v.routeName}}}catch(g){return(0,lt.NF)(g)&&g.cancelled||(C((0,W.ig)({message:(0,X.t)("dashboard.fetch-dashboard.message.failed-to-fetch-dashboard","Failed to fetch dashboard"),error:g})),console.error(g)),null}}const nt=(v,C={})=>(v.forEach(D=>{D.panels?nt(D.panels,C):D.targets&&D.targets.forEach(g=>{g.datasource?.type&&(C[g.datasource.type]?C[g.datasource.type].push(g):C[g.datasource.type]=[g])})}),C);function Z(v){return async(C,D)=>{(0,G.j)(Q),C((0,W.xS)());const g=await k(v,C,D),x=g?.dashboard?.version;if(!g)return;$(g),C((0,W.X1)());let h;try{h=new Ct.G(g.dashboard,g.meta)}catch(m){C((0,W.ig)({message:(0,X.t)("dashboard.init-dashboard.message.failed-create-dashboard-model","Failed create dashboard model"),error:m})),console.error(m);return}const z=D(),F=M.Ny.getSearchObject();F.orgId||M.Ny.partial({orgId:z.user.orgId},!0);const j=(0,P.jG)();(0,ht.UA)().setCurrent(h),j.init(h);const K=(0,U.q4)(v.urlUid??h.uid);if(await C((0,mt._q)(K,h)),(0,ft.nm)({dashboard:h,timeSrv:j}).run({dashboard:h,range:j.timeRange()}),(0,vt.Tk)(D())!==K||D().dashboard.initPhase!==O._g.Services)return;try{h.processRepeats(),F.autofitpanels&&h.autoFitPanels(window.innerHeight,F.kiosk),I.$.publicDashboardAccessToken||v.keybindingSrv.setupDashboardBindings(h)}catch(m){m instanceof Error&&C((0,Y.dx)((0,ct.gi)("Dashboard init failed",m))),console.error(m)}v.routeName!==O.Z4.New?((0,Et.B)(h),tt.t.watch(h.uid)):tt.t.leave(),h.weekStart!==""&&h.weekStart!==void 0?(0,N.$D)(h.weekStart):(0,N.$D)(A.TP.user.weekStart),dt.A.publish(new rt.gc({dashboardId:h.uid,orgId:z.user.orgId,userId:z.user.user?.id,grafanaVersion:I.$.buildInfo.version,queries:nt(h.panels)}));const St=(0,G.z)(Q);(0,et.dM)(h,St?.duration,x),C((0,W.O9)(h))}}function $(v){const C=V.A.getObject(O.us);C&&(C.dashboard.panels&&(v.dashboard.panels=C.dashboard.panels.concat(v.dashboard.panels)),C.dashboard.time&&(v.dashboard.time=C.dashboard.time),V.A.delete(O.us))}},97976:(At,it,s)=>{s.d(it,{L:()=>Ee});var d=s(74848),N=s(96540),rt=s(71468),X=s(87390),M=s(89224),lt=s(94701);function I({children:e,width:t,height:i,onLoad:n,onChange:a}){const o=(0,N.useId)(),[r,l]=(0,N.useState)(!1),[c,u]=(0,N.useState)(!1),f=(0,N.useRef)(null);return(0,lt.A)(()=>{I.addCallback(o,S=>{!r&&S.isIntersecting&&(l(!0),n?.()),u(S.isIntersecting),a?.(S.isIntersecting)});const E=f.current;return E&&I.observer.observe(E),()=>{delete I.callbacks[o],E&&I.observer.unobserve(E),Object.keys(I.callbacks).length===0&&I.observer.disconnect()}}),(0,d.jsx)("div",{id:o,ref:f,style:{width:t,height:i},children:r&&(typeof e=="function"?e({isInView:c}):e)})}const Y={};I.callbacks=Y,I.addCallback=(e,t)=>I.callbacks[e]=t,I.observer=new IntersectionObserver(e=>{for(const t of e)I.callbacks[t.target.id]&&I.callbacks[t.target.id](t)},{rootMargin:"100px"});var dt=s(2543),ct=s(64423),q=s(84229),V=s(1906),G=s(57852),B=s(25229),ht=s(48480),P=s(28105),J=s(22592),_=s(41119),ut=s(75234),gt=s(64400),H=s(67522),tt=s(36303),pt=s(45229),U=s(65642),O=s(1505),A=s(17097),ft=s(28998),mt=s(48421),vt=s(22747),et=s(57866),Ct=s(64394);const Et=(e,t,i)=>{const{overrides:n}=i,a=i.overrides.findIndex(u=>u.matcher.id===et.Ct.byName&&u.matcher.options===e);if(a<0)return{...i,overrides:[...i.overrides,W(e,t)]};const o=Array.from(n),r=o[a],l=r.properties.findIndex(u=>u.id==="color");if(l<0)return o[a]={...r,properties:[...r.properties,Q(t)]},{...i,overrides:o};const c=Array.from(r.properties);return c[l]=Q(t),o[a]={...r,properties:c},{...i,overrides:o}},W=(e,t)=>({matcher:{id:et.Ct.byName,options:e},properties:[Q(t)]}),Q=e=>({id:"color",value:{mode:Ct.Y.Fixed,fixedColor:e}});var k=s(8535),nt=s(87745),Z=s(78767),$=s(32380),v=s(75421),C=s(67458),D=s(2863),g=s(36490),x=s(23289),h=s(26689),z=s(302),F=s(22803),j=s(76190),yt=s(63142),K=s(45967),st=s(30703),St=s(91867),m=s(92745),w=s(87063),Ft=s(88559),Rt=s(7895);function bt({panelLinks:e,onShowPanelLinks:t}){const i=(0,yt.of)(Lt),n=()=>{const a=t();return(0,d.jsx)(w.W,{children:a?.map((o,r)=>(0,d.jsx)(w.W.Item,{label:o.title,url:o.href,target:o.target,onClick:o.onClick},r))})};if(e.length===1){const a=t()[0];return(0,d.jsx)(H.NR.TitleItem,{href:a.href,onClick:a.onClick,target:a.target,title:a.title,children:(0,d.jsx)(st.I,{name:"external-link-alt",size:"md"})})}else return(0,d.jsx)(Ft.m,{overlay:n,children:(0,d.jsx)(Rt.I,{icon:"external-link-alt",iconSize:"md","aria-label":(0,m.t)("dashboard.panel-links.aria-label-panel-links","Panel links"),className:i.menuTrigger})})}const Lt=e=>({menuTrigger:(0,F.css)({height:"100%",background:"inherit",border:"none",borderRadius:`${e.shape.radius.default}`,cursor:"context-menu"})});var Mt=s(46429);function Vt(e){const{alertState:t,data:i,panelId:n,onShowPanelLinks:a,panelLinks:o}=e,r=(0,yt.of)(Ut),l=(0,d.jsx)(K.m,{content:t??"unknown",children:(0,d.jsx)(H.NR.TitleItem,{className:(0,F.cx)({[r.ok]:t===j.O.OK,[r.pending]:t===j.O.Pending||t===j.O.Recovering,[r.alerting]:t===j.O.Alerting}),children:(0,d.jsx)(st.I,{name:t==="alerting"?"heart-break":"heart",size:"md"})})}),c=(0,d.jsx)(d.Fragment,{children:i.request&&i.request.timeInfo&&(0,d.jsx)(K.m,{content:(0,d.jsx)(St.xS,{timeRange:i.request?.range,timeZone:i.request?.timezone}),children:(0,d.jsxs)(H.NR.TitleItem,{className:r.timeshift,children:[(0,d.jsx)(st.I,{name:"clock-nine",size:"md"})," ",i.request?.timeInfo]})})});return(0,d.jsxs)(d.Fragment,{children:[o&&o.length>0&&a&&(0,d.jsx)(bt,{onShowPanelLinks:a,panelLinks:o}),(0,d.jsx)(Mt.Z,{panelId:n,frames:i.series}),c,t&&l]})}const Ut=e=>({ok:(0,F.css)({color:e.colors.success.text,"&:hover":{color:e.colors.emphasize(e.colors.success.text,.03)}}),pending:(0,F.css)({color:e.colors.warning.text,"&:hover":{color:e.colors.emphasize(e.colors.warning.text,.03)}}),alerting:(0,F.css)({color:e.colors.error.text,"&:hover":{color:e.colors.emphasize(e.colors.error.text,.03)}}),timeshift:(0,F.css)({color:e.colors.text.link,gap:e.spacing(.5),whiteSpace:"nowrap","&:hover":{color:e.colors.emphasize(e.colors.text.link,.03)}}),angularNotice:(0,F.css)({color:e.colors.warning.text})});function jt(e){function t(){return e.data.request&&e.data.request.timeInfo?!1:!e.panel.hasTitle()}const i=()=>{const y=(0,D.w)().replace(e.panel.description,e.panel.scopedVars);return(0,C.G)(y)},n=()=>{const y=(0,z.E7)(e.panel);if(!y)return[];const b=y&&y.getLinks(e.panel.replaceVariables);return b.map(at=>({...at,onClick:(...ot)=>{x.c.panelLinkClicked({has_multiple_links:b.length>1}),at.onClick?.(...ot)}}))},a=(y,b)=>{y.stopPropagation(),g.Ny.partial({inspect:e.panel.id,inspectTab:b})},o=y=>{y.stopPropagation(),g.Ny.partial({inspect:e.panel.id,inspectTab:h.q.Error}),x.c.panelStatusMessageClicked()},r=()=>{e.panel.getQueryRunner().cancelQuery(),x.c.panelCancelQueryClicked({data_state:e.data.state})},l=e.plugin.noPadding?"none":"md",c=e.data.alertState?.state,f=(e.panel.links&&e.panel.links.length>0&&n||e.data.series.length>0&&e.data.series.some(y=>(y.meta?.notices?.length??0)>0)||e.data.request&&e.data.request.timeInfo||c)&&(0,d.jsx)(Vt,{alertState:c,data:e.data,panelId:e.panel.id,panelLinks:e.panel.links,onShowPanelLinks:n}),E=e.panel.description?i:void 0,S=!(e.isViewing||e.isEditing)&&(e.isDraggable??!0)?"grid-drag-handle":"",R=e.panel.getDisplayTitle();return{hasOverlayHeader:t,onShowPanelDescription:i,onShowPanelLinks:n,onOpenInspector:a,onOpenErrorInspect:o,onCancelQuery:r,padding:l,description:E,dragClass:S,title:R,titleItems:f}}var Gt=s(27359),Ht=s(60519),Wt=s(18030);function zt(e,t){const i=(0,_.Bt)(e.snapshotData),n=new Wt.F,a={dashboard:t,range:(0,J.E2)()},o=n.canWork(a)?n.getAnnotationsInSnapshot(t,e.id):[],r=[(0,Gt.I)(o)];return{timeRange:(0,A.nk)(e,(0,v.jG)().timeRange()).timeRange,state:P.Gu.Done,series:(0,Ht.we)({data:i,fieldConfig:{defaults:{},overrides:[]},replaceVariables:e.replaceVariables,fieldConfigRegistry:e.plugin.fieldConfigRegistry,theme:U.$W.theme2,timeZone:t.getTimezone()}),structureRev:1,annotations:r}}var Qt=s(51898);function wt({items:e}){const t=i=>i.map(n=>{switch(n.type){case"divider":return(0,d.jsx)(w.W.Divider,{},n.text);case"group":return(0,d.jsx)(w.W.Group,{label:n.text,children:n.subMenu?t(n.subMenu):void 0},n.text);default:return(0,d.jsx)(w.W.Item,{label:n.text,icon:n.iconClassName,childItems:n.subMenu?t(n.subMenu):void 0,url:n.href,onClick:n.onClick,shortcut:n.shortcut,testId:Qt.Tp.components.Panels.Panel.menuItems(n.text)},n.text)}});return(0,d.jsx)(w.W,{children:t(e)})}var Bt=s(54092),Jt=s(60188),kt=s(46907),Zt=s(5556),$t=s(64762),Kt=s(12066),Nt=s(15130),Xt=s(47797),Yt=s(62635),qt=s(20437),_t=s(75515),te=s(3260),ee=s(9931),ne=s(54),se=s(35231);function ae(e,t,i){const n=p=>{p.preventDefault(),g.Ny.partial({viewPanel:t.id})},a=p=>{p.preventDefault(),g.Ny.partial({editPanel:t.id})},o=p=>{p.preventDefault(),(0,A.Mc)(e,t)},r=p=>{p.preventDefault(),(0,A.d7)(e,t)},l=p=>{p.preventDefault(),(0,A.ZY)(t)},c=p=>{g.Ny.partial({inspect:t.id,inspectTab:p})},u=p=>{p.preventDefault(),(0,A.iU)(e,t)},f=p=>{p.preventDefault(),(0,A.KJ)(t)},E=p=>{p.preventDefault(),(0,A.FC)(e,t,!0)},S=p=>{p.preventDefault();const Dt=p.ctrlKey||p.metaKey?xt=>window.open(xt):void 0;k.M_.dispatch((0,se.ow)(t,{timeRange:(0,v.jG)().timeRange(),getExploreUrl:Yt.Xe,openInNewWindow:Dt}))},R=p=>{p.preventDefault(),(0,A.ET)(t)},y=[];t.isEditing||y.push({text:(0,m.t)("panel.header-menu.view","View"),iconClassName:"eye",onClick:n,shortcut:"v"}),e.canEditPanel(t)&&!t.isEditing&&y.push({text:(0,m.t)("panel.header-menu.edit","Edit"),iconClassName:"edit",onClick:a,shortcut:"e"}),y.push({text:(0,m.t)("panel.header-menu.share","Share"),iconClassName:"share-alt",onClick:o,shortcut:"p s"}),Nt.TP.hasAccessToExplore()&&!(t.plugin&&t.plugin.meta.skipDataQuery)&&t.datasource?.uid!==ee.K&&y.push({text:(0,m.t)("panel.header-menu.explore","Explore"),iconClassName:"compass",onClick:S,shortcut:"p x"});const b=[];t.plugin&&!t.plugin.meta.skipDataQuery&&(b.push({text:(0,m.t)("panel.header-menu.inspect-data","Data"),onClick:p=>c(h.q.Data)}),e.meta.canEdit&&b.push({text:(0,m.t)("panel.header-menu.query","Query"),onClick:p=>c(h.q.Query)})),b.push({text:(0,m.t)("panel.header-menu.inspect-json","Panel JSON"),onClick:p=>c(h.q.JSON)}),y.push({type:"submenu",text:(0,m.t)("panel.header-menu.inspect","Inspect"),iconClassName:"info-circle",shortcut:"i",subMenu:b});const at=async()=>{let p;try{p=await(0,qt.mp)(t,e)}catch(xt){const ye=`Error getting rule values from the panel: ${(0,Xt.q6)(xt)}`;(0,k.JD)((0,Kt.dx)((0,$t.gi)(ye)));return}const Dt=Zt.kM.renderUrl("/alerting/new",{defaults:JSON.stringify(p),returnTo:window.location.pathname+window.location.search});g.Ny.push(Dt)},ot=p=>{p.preventDefault(),at()},T=[],Tt=e.canEditPanel(t),Ot=(0,ne.q0)();return t.isViewing||t.isEditing||(Tt?(T.push({text:(0,m.t)("panel.header-menu.duplicate","Duplicate"),onClick:u,shortcut:"p d"}),T.push({text:(0,m.t)("panel.header-menu.copy","Copy"),onClick:f}),(0,_t.X)(t)?T.push({text:(0,m.t)("panel.header-menu.unlink-library-panel","Unlink library panel"),onClick:l}):T.push({text:(0,m.t)("panel.header-menu.create-library-panel","Create library panel"),onClick:r})):Nt.TP.isEditor&&T.push({text:(0,m.t)("panel.header-menu.copy","Copy"),onClick:f})),Ot&&T.push({text:(0,m.t)("panel.header-menu.new-alert-rule","New alert rule"),onClick:ot}),t.options.legend&&T.push({text:t.options.legend.showLegend?(0,m.t)("panel.header-menu.hide-legend","Hide legend"):(0,m.t)("panel.header-menu.show-legend","Show legend"),onClick:R,shortcut:"p l"}),t.isEditing&&(T.length=0,Ot&&T.push({text:(0,m.t)("panel.header-menu.new-alert-rule","New alert rule"),onClick:ot})),Tt&&t.plugin&&!t.plugin.meta.skipDataQuery&&T.push({text:(0,m.t)("panel.header-menu.get-help","Get help"),onClick:p=>c(h.q.Help)}),i.length>0&&!t.isEditing&&y.push({text:(0,m.t)("dashboard.get-panel-menu.text.extensions","Extensions"),iconClassName:"plug",type:"submenu",subMenu:(0,te.N9)(i)}),T.length&&y.push({type:"submenu",text:(0,m.t)("panel.header-menu.more","More..."),iconClassName:"cube",subMenu:T}),e.canEditPanel(t)&&!t.isEditing&&!t.isViewing&&(y.push({type:"divider",text:""}),y.push({text:(0,m.t)("panel.header-menu.remove","Remove"),iconClassName:"trash-alt",onClick:E,shortcut:"p r"})),y}function oe({panel:e,dashboard:t,loadingState:i,children:n}){const[a,o]=(0,N.useState)([]),r=(0,N.useMemo)(()=>ie(e,t),[e,t]),{links:l}=(0,kt.U)({extensionPointId:Bt.SM.DashboardPanelMenu,context:r,limitPerPlugin:3});return(0,N.useEffect)(()=>{o(ae(t,e,l))},[t,e,i,o,l]),n({items:a})}function ie(e,t){return{id:e.id,pluginId:e.type,title:e.title,timeRange:t.time,timeZone:(0,Jt.O)({timeZone:t.timezone}),dashboard:{uid:t.uid,title:t.title,tags:Array.from(t.tags)},targets:e.targets,scopedVars:e.scopedVars,data:e.getQueryRunner().getLastResult()}}function re({style:e,panel:t,dashboard:i,loadingState:n}){return(0,d.jsx)(oe,{panel:t,dashboard:i,loadingState:n,children:({items:a})=>(0,d.jsx)(wt,{style:e,items:a})})}var Pt=s(32631),L=(e=>(e.FIELD_CONFIG_OVERRIDES_CHANGED_EVENT="field config overrides changed",e.NEW_PANEL_OPTION_EVENT="new panel option",e.PANEL_OPTION_CHANGED_EVENT="panel option changed",e.NEW_DEFAULT_FIELD_CONFIG_EVENT="new default field config",e.DEFAULT_FIELD_CONFIG_CHANGED_EVENT="default field config changed",e.NEW_CUSTOM_FIELD_CONFIG_EVENT="new custom field config",e.CUSTOM_FIELD_CONFIG_CHANGED_EVENT="custom field config changed",e.MEASURE_PANEL_LOAD_TIME_EVENT="measure panel load time",e.THRESHOLDS_COUNT_CHANGED_EVENT="thresholds count changed",e.THRESHOLDS_MODE_CHANGED_EVENT="thresholds mode changed",e.MAPPINGS_COUNT_CHANGED_EVENT="mappings count changed",e.LINKS_COUNT_CHANGED_EVENT="links count changed",e.PANEL_ERROR="panel error",e))(L||{});const le="overrides",de="custom",ce=e=>{const t=performance.now();return(0,N.useEffect)(()=>{U.$W.grafanaJavascriptAgent.enabled&&requestAnimationFrame(()=>{setTimeout(()=>{Pt.P.api.pushMeasurement({type:L.MEASURE_PANEL_LOAD_TIME_EVENT,values:{start_loading_time_ms:t,load_time_ms:performance.now()-t}},{context:{panel_type:e.panelType,panel_id:String(e.panelId),panel_title:e.panelTitle}})},0)})},[]),null};var he=s(78013),It=s(4405);class ue{constructor(t,i,n){this.logChanges=(a,o)=>{this.logPanelOptionChanges(a,this.initialPanelOptions),this.logFieldConfigChanges(o,this.initialFieldConfig),this.initialPanelOptions=a,this.initialFieldConfig=o},this.logPanelEvent=(a,o,r,l)=>{if(!U.$W.grafanaJavascriptAgent.enabled)return;const c={key:o,newValue:r,oldValue:l??"",panelTitle:this.panelLogInfo.panelTitle,panelId:this.panelLogInfo.panelId,panelType:this.panelLogInfo.panelType};Pt.P.api.pushEvent(a,c)},this.logPanelOptionChanges=(a,o)=>{if(typeof a!="object"||a===null||typeof o!="object"||o===null)return;const r={...o};for(const[l,c]of Object.entries(a)){const u=typeof c!="string"?JSON.stringify(c):c,f=typeof c!="string"?JSON.stringify(r[l]):String(r[l]);r[l]===void 0?this.logPanelEvent(L.NEW_PANEL_OPTION_EVENT,l,u):f!==u&&this.logPanelEvent(L.PANEL_OPTION_CHANGED_EVENT,l,u,f)}},this.logFieldConfigChanges=(a,o)=>{const r=JSON.stringify(o.overrides),l=JSON.stringify(a.overrides);r!==l&&this.logPanelEvent(L.FIELD_CONFIG_OVERRIDES_CHANGED_EVENT,le,l,r);const c={...o.defaults};for(const[f,E]of Object.entries(a.defaults)){if(f===de)continue;const S=typeof E!="string"?JSON.stringify(E):E,R=typeof E!="string"?JSON.stringify(c[f]):String(c[f]);c[f]===void 0?this.logPanelEvent(L.NEW_DEFAULT_FIELD_CONFIG_EVENT,f,S):R!==S&&this.logPanelEvent(L.DEFAULT_FIELD_CONFIG_CHANGED_EVENT,f,S,R)}if(!a.defaults.custom||c.custom===void 0)return;const u={...c.custom};for(const[f,E]of Object.entries(a.defaults.custom)){if(c.custom===null||u[f]===null)continue;const S=typeof E!="string"?JSON.stringify(E):E,R=typeof E!="string"?JSON.stringify(u[f]):String(u[f]);u[f]===void 0?this.logPanelEvent(L.NEW_CUSTOM_FIELD_CONFIG_EVENT,f,S):R!==S&&this.logPanelEvent(L.CUSTOM_FIELD_CONFIG_CHANGED_EVENT,f,S,R)}},this.initialPanelOptions=t,this.initialFieldConfig=i,this.panelLogInfo=n}}const ge="Error in plugin";class pe extends N.PureComponent{constructor(t){super(t),this.timeSrv=(0,v.jG)(),this.subs=new ct.yU,this.eventFilter={onlyLocal:!0},this.panelOptionsLogger=void 0,this.getSync=()=>this.props.isEditing?q.y.Off:this.props.dashboard.graphTooltip,this.onInstanceStateChange=n=>{this.props.onInstanceStateChange(n),this.setState({context:{...this.state.context,instanceState:n}})},this.onUpdateData=n=>(0,vt.H)(this.props.panel,n),this.onSeriesColorChange=(n,a)=>{this.onFieldConfigChange(Et(n,a,this.props.panel.fieldConfig))},this.onSeriesVisibilityChange=(n,a)=>{this.onFieldConfigChange((0,he.M)(n,a,this.props.panel.fieldConfig,this.state.data.series))},this.onToggleLegendSort=n=>{const a=this.props.panel.options.legend;if(!a)return;let o=a.sortDesc,r=a.sortBy;n!==r&&(o=void 0),o===!1?(r=void 0,o=void 0):(o=!o,r=n),this.onOptionsChange({...this.props.panel.options,legend:{...a,sortBy:r,sortDesc:o}})},this.onRefresh=()=>{const{dashboard:n,panel:a,isInView:o,width:r}=this.props;if(!n.snapshot&&!o){a.refreshWhenInView=!0;return}const l=(0,A.nk)(a,this.timeSrv.timeRange());if(this.wantsQueryExecution){if(r<0)return;a.refreshWhenInView=!1,a.runAllPanelQueries({dashboardUID:n.uid,dashboardTimezone:n.getTimezone(),dashboardTitle:n.title,timeData:l,width:r})}else this.setState({data:{...this.state.data,timeRange:this.timeSrv.timeRange()},renderCounter:this.state.renderCounter+1,liveTime:void 0})},this.onRender=()=>{const n={renderCounter:this.state.renderCounter+1};this.setState(n)},this.onOptionsChange=n=>{this.props.panel.updateOptions(n)},this.onFieldConfigChange=n=>{this.props.panel.updateFieldConfig(n)},this.onPanelError=n=>{U.Ay.featureToggles.panelMonitoring&&this.getPanelContextApp()===V.Jk.PanelEditor&&this.logPanelChangesOnError();const a=n.message||ge;this.state.errorMessage!==a&&this.setState({errorMessage:a})},this.onPanelErrorRecover=()=>{this.setState({errorMessage:void 0})},this.onAnnotationCreate=async n=>{const a=n.from!==n.to,o={dashboardUID:this.props.dashboard.uid,panelId:this.props.panel.id,isRegion:a,time:n.from,timeEnd:a?n.to:0,tags:n.tags,text:n.description};await(0,Z.vJ)(o),(0,$.Dh)().run({dashboard:this.props.dashboard,range:this.timeSrv.timeRange()}),this.state.context.eventBus.publish(new G.We(o))},this.onAnnotationDelete=async n=>{await(0,Z.Xm)({id:n}),(0,$.Dh)().run({dashboard:this.props.dashboard,range:this.timeSrv.timeRange()}),this.state.context.eventBus.publish(new G.We({id:n}))},this.onAnnotationUpdate=async n=>{const a=n.from!==n.to,o={id:n.id,dashboardUID:this.props.dashboard.uid,panelId:this.props.panel.id,isRegion:a,time:n.from,timeEnd:a?n.to:0,tags:n.tags,text:n.description};await(0,Z.rJ)(o),(0,$.Dh)().run({dashboard:this.props.dashboard,range:this.timeSrv.timeRange()}),this.state.context.eventBus.publish(new G.We(o))},this.onChangeTimeRange=n=>{this.timeSrv.setTime({from:(0,B.yT)(n.from),to:(0,B.yT)(n.to)})},this.onAddAdHocFilter=n=>{const{key:a,value:o,operator:r}=n,l=(0,ft.tR)().getInstanceSettings(this.props.panel.datasource),c=l&&(0,ht.p$)(l);c&&(0,k.JD)((0,mt.z_)({datasource:c,key:a,operator:r,value:o}))};const i=t.dashboard.events.newScopedBus(`panel:${t.panel.id}`,this.eventFilter);if(this.debouncedSetPanelAttention=(0,dt.debounce)(this.setPanelAttention.bind(this),100),this.state={isFirstLoad:!0,renderCounter:0,context:{eventsScope:"__global_",eventBus:i,app:this.getPanelContextApp(),sync:this.getSync,onSeriesColorChange:this.onSeriesColorChange,onToggleSeriesVisibility:this.onSeriesVisibilityChange,onAnnotationCreate:this.onAnnotationCreate,onAnnotationUpdate:this.onAnnotationUpdate,onAnnotationDelete:this.onAnnotationDelete,onInstanceStateChange:this.onInstanceStateChange,onToggleLegendSort:this.onToggleLegendSort,canAddAnnotations:t.dashboard.canAddAnnotations.bind(t.dashboard),canEditAnnotations:t.dashboard.canEditAnnotations.bind(t.dashboard),canDeleteAnnotations:t.dashboard.canDeleteAnnotations.bind(t.dashboard),canExecuteActions:t.dashboard.canExecuteActions.bind(t.dashboard),onAddAdHocFilter:this.onAddAdHocFilter,onUpdateData:this.onUpdateData},data:this.getInitialPanelDataState()},U.Ay.featureToggles.panelMonitoring&&this.getPanelContextApp()===V.Jk.PanelEditor){const n={panelId:String(t.panel.id),panelType:t.panel.type,panelTitle:t.panel.title};this.panelOptionsLogger=new ue(t.panel.getOptions(),t.panel.fieldConfig,n)}}getPanelContextApp(){return this.props.isEditing?V.Jk.PanelEditor:this.props.isViewing?V.Jk.PanelViewer:V.Jk.Dashboard}getInitialPanelDataState(){return{state:P.Gu.NotStarted,series:[],timeRange:(0,J.E2)()}}componentDidMount(){const{panel:t,dashboard:i}=this.props;if(this.subs.add(t.events.subscribe(ut._,this.onRefresh)),this.subs.add(t.events.subscribe(nt.XM,this.onRender)),i.panelInitialized(this.props.panel),this.hasPanelSnapshot){this.setState({data:zt(t,i),isFirstLoad:!1});return}this.wantsQueryExecution||this.setState({isFirstLoad:!1}),this.subs.add(t.getQueryRunner().getData({withTransforms:!0,withFieldConfig:!0}).subscribe({next:n=>this.onDataUpdate(n)})),It.a.listen(this)}componentWillUnmount(){this.subs.unsubscribe(),It.a.remove(this)}liveTimeChanged(t){const{data:i}=this.state;if(i.timeRange){const n=t.to.valueOf()-i.timeRange.to.valueOf();if(n<100){console.log("Skip tick render",this.props.panel.title,n);return}}this.setState({liveTime:t})}componentDidUpdate(t){const{isInView:i,width:n,panel:a}=this.props,{context:o}=this.state,r=this.getPanelContextApp();o.app!==r&&this.setState({context:{...o,app:r}}),i!==t.isInView&&i&&a.refreshWhenInView&&this.onRefresh(),n!==t.width&&It.a.updateInterval(this)}onDataUpdate(t){const{dashboard:i,panel:n,plugin:a}=this.props;if(a.meta.skipDataQuery){this.setState({data:this.getInitialPanelDataState()});return}let{isFirstLoad:o}=this.state,r;switch(t.state){case P.Gu.Loading:if(this.state.data.state===P.Gu.Loading)return;break;case P.Gu.Error:const{error:l,errors:c}=t;c?.length?c.length===1?r=c[0].message:r="Multiple errors found. Click for more details":l&&r!==l.message&&(r=l.message);break;case P.Gu.Done:i.snapshot&&(n.snapshotData=t.series.map(u=>(0,_.Kl)(u))),o&&(o=!1);break}this.setState({isFirstLoad:o,errorMessage:r,data:t,liveTime:void 0})}logPanelChangesOnError(){this.panelOptionsLogger.logChanges(this.props.panel.getOptions(),this.props.panel.fieldConfig)}get hasPanelSnapshot(){const{panel:t}=this.props;return t.snapshotData&&t.snapshotData.length}get wantsQueryExecution(){return!(this.props.plugin.meta.skipDataQuery||this.hasPanelSnapshot)}shouldSignalRenderingCompleted(t,i){return t===P.Gu.Done||t===P.Gu.Streaming||t===P.Gu.Error||i.skipDataQuery}skipFirstRender(t){const{isFirstLoad:i}=this.state;return this.wantsQueryExecution&&i&&(t===P.Gu.Loading||t===P.Gu.NotStarted)}renderPanelContent(t,i){const{panel:n,plugin:a,dashboard:o}=this.props,{renderCounter:r,data:l}=this.state,{state:c}=l;if(this.skipFirstRender(c))return null;this.shouldSignalRenderingCompleted(c,a.meta)&&O.E.renderingCompleted();const u=a.panel,f=this.state.liveTime??l.timeRange??this.timeSrv.timeRange(),E=n.getOptions();return this.eventFilter.onlyLocal=o.graphTooltip===0,(0,d.jsx)(d.Fragment,{children:(0,d.jsxs)(gt.XF,{value:this.state.context,children:[(0,d.jsx)(u,{id:n.id,data:l,title:n.title,timeRange:f,timeZone:this.props.dashboard.getTimezone(),options:E,fieldConfig:n.fieldConfig,transparent:n.transparent,width:t,height:i,renderCounter:r,replaceVariables:n.replaceVariables,onOptionsChange:this.onOptionsChange,onFieldConfigChange:this.onFieldConfigChange,onChangeTimeRange:this.onChangeTimeRange,eventBus:o.events}),U.Ay.featureToggles.panelMonitoring&&this.state.errorMessage===void 0&&(0,d.jsx)(ce,{panelType:a.meta.id,panelId:n.id,panelTitle:n.title})]})})}setPanelAttention(){pt.A.publish(new G.Tp({panelId:this.props.panel.id}))}debouncedSetPanelAttention(){}render(){const{dashboard:t,panel:i,width:n,height:a,plugin:o}=this.props,{errorMessage:r,data:l}=this.state,{transparent:c}=i,u=jt({...this.props,data:l}),f=(i.gridPos?.y??0)===0?-16:void 0,E=(0,d.jsx)("div",{"data-testid":"panel-dropdown",children:(0,d.jsx)(re,{panel:i,dashboard:t,loadingState:l.state})});return(0,d.jsx)(H.NR,{width:n,height:a,title:u.title,loadingState:l.state,statusMessage:r,statusMessageOnClick:u.onOpenErrorInspect,description:u.description,titleItems:u.titleItems,menu:this.props.hideMenu?void 0:E,dragClass:u.dragClass,dragClassCancel:"grid-drag-cancel",padding:u.padding,hoverHeaderOffset:f,hoverHeader:u.hasOverlayHeader(),displayMode:c?"transparent":"default",onCancelQuery:u.onCancelQuery,onFocus:()=>this.setPanelAttention(),onMouseEnter:()=>this.setPanelAttention(),onMouseMove:()=>this.debouncedSetPanelAttention(),children:(S,R)=>(0,d.jsx)(d.Fragment,{children:(0,d.jsx)(tt.tH,{dependencies:[l,o,i.getOptions()],onError:this.onPanelError,onRecover:this.onPanelErrorRecover,children:({error:y})=>y?null:this.renderPanelContent(S,R)})})})}}const fe=(e,t)=>{const i=e.panels[t.stateKey];return i?{plugin:i.plugin,instanceState:i.instanceState}:{plugin:void 0}},me={initPanelState:X.Ap,setPanelInstanceState:M.nF},ve=(0,rt.connect)(fe,me);class Ce extends N.PureComponent{constructor(){super(...arguments),this.onInstanceStateChange=t=>{this.props.setPanelInstanceState({key:this.props.stateKey,value:t})},this.onVisibilityChange=t=>{this.props.panel.isInView=t},this.onPanelLoad=()=>{this.props.plugin||this.props.initPanelState(this.props.panel)},this.renderPanel=({isInView:t})=>{const{dashboard:i,panel:n,isViewing:a,isEditing:o,width:r,height:l,plugin:c,timezone:u,hideMenu:f,isDraggable:E=!0}=this.props;return c?(0,d.jsx)(pe,{plugin:c,panel:n,dashboard:i,isViewing:a,isEditing:o,isInView:t,isDraggable:E,width:r,height:l,onInstanceStateChange:this.onInstanceStateChange,timezone:u,hideMenu:f}):null}}static{this.defaultProps={lazy:!0}}componentDidMount(){this.props.panel.isInView=!this.props.lazy,this.props.lazy||this.onPanelLoad()}render(){const{width:t,height:i,lazy:n}=this.props;return n?(0,d.jsx)(I,{width:t,height:i,onChange:this.onVisibilityChange,onLoad:this.onPanelLoad,children:this.renderPanel}):this.renderPanel({isInView:!0})}}const Ee=ve(Ce)}}]);

//# sourceMappingURL=6088.b0518f3a634e41772187.js.map